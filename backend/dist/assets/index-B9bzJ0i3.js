(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))i(l);new MutationObserver(l=>{for(const o of l)if(o.type==="childList")for(const d of o.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&i(d)}).observe(document,{childList:!0,subtree:!0});function s(l){const o={};return l.integrity&&(o.integrity=l.integrity),l.referrerPolicy&&(o.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?o.credentials="include":l.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(l){if(l.ep)return;l.ep=!0;const o=s(l);fetch(l.href,o)}})();function Pi(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Xh={exports:{}},Xo={};/**
 * @license React
 * react-jsx-runtime.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var U0;function PA(){if(U0)return Xo;U0=1;var e=Symbol.for("react.transitional.element"),n=Symbol.for("react.fragment");function s(i,l,o){var d=null;if(o!==void 0&&(d=""+o),l.key!==void 0&&(d=""+l.key),"key"in l){o={};for(var f in l)f!=="key"&&(o[f]=l[f])}else o=l;return l=o.ref,{$$typeof:e,type:i,key:d,ref:l!==void 0?l:null,props:o}}return Xo.Fragment=n,Xo.jsx=s,Xo.jsxs=s,Xo}var q0;function HA(){return q0||(q0=1,Xh.exports=PA()),Xh.exports}var t=HA(),Kh={exports:{}},an={};/**
 * @license React
 * react.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var P0;function VA(){if(P0)return an;P0=1;var e=Symbol.for("react.transitional.element"),n=Symbol.for("react.portal"),s=Symbol.for("react.fragment"),i=Symbol.for("react.strict_mode"),l=Symbol.for("react.profiler"),o=Symbol.for("react.consumer"),d=Symbol.for("react.context"),f=Symbol.for("react.forward_ref"),p=Symbol.for("react.suspense"),h=Symbol.for("react.memo"),y=Symbol.for("react.lazy"),g=Symbol.for("react.activity"),b=Symbol.iterator;function v(I){return I===null||typeof I!="object"?null:(I=b&&I[b]||I["@@iterator"],typeof I=="function"?I:null)}var S={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},N=Object.assign,j={};function E(I,Y,P){this.props=I,this.context=Y,this.refs=j,this.updater=P||S}E.prototype.isReactComponent={},E.prototype.setState=function(I,Y){if(typeof I!="object"&&typeof I!="function"&&I!=null)throw Error("takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,I,Y,"setState")},E.prototype.forceUpdate=function(I){this.updater.enqueueForceUpdate(this,I,"forceUpdate")};function A(){}A.prototype=E.prototype;function M(I,Y,P){this.props=I,this.context=Y,this.refs=j,this.updater=P||S}var _=M.prototype=new A;_.constructor=M,N(_,E.prototype),_.isPureReactComponent=!0;var T=Array.isArray;function k(){}var C={H:null,A:null,T:null,S:null},L=Object.prototype.hasOwnProperty;function z(I,Y,P){var W=P.ref;return{$$typeof:e,type:I,key:Y,ref:W!==void 0?W:null,props:P}}function G(I,Y){return z(I.type,Y,I.props)}function U(I){return typeof I=="object"&&I!==null&&I.$$typeof===e}function X(I){var Y={"=":"=0",":":"=2"};return"$"+I.replace(/[=:]/g,function(P){return Y[P]})}var V=/\/+/g;function R(I,Y){return typeof I=="object"&&I!==null&&I.key!=null?X(""+I.key):Y.toString(36)}function B(I){switch(I.status){case"fulfilled":return I.value;case"rejected":throw I.reason;default:switch(typeof I.status=="string"?I.then(k,k):(I.status="pending",I.then(function(Y){I.status==="pending"&&(I.status="fulfilled",I.value=Y)},function(Y){I.status==="pending"&&(I.status="rejected",I.reason=Y)})),I.status){case"fulfilled":return I.value;case"rejected":throw I.reason}}throw I}function D(I,Y,P,W,le){var K=typeof I;(K==="undefined"||K==="boolean")&&(I=null);var de=!1;if(I===null)de=!0;else switch(K){case"bigint":case"string":case"number":de=!0;break;case"object":switch(I.$$typeof){case e:case n:de=!0;break;case y:return de=I._init,D(de(I._payload),Y,P,W,le)}}if(de)return le=le(I),de=W===""?"."+R(I,0):W,T(le)?(P="",de!=null&&(P=de.replace(V,"$&/")+"/"),D(le,Y,P,"",function(re){return re})):le!=null&&(U(le)&&(le=G(le,P+(le.key==null||I&&I.key===le.key?"":(""+le.key).replace(V,"$&/")+"/")+de)),Y.push(le)),1;de=0;var Q=W===""?".":W+":";if(T(I))for(var he=0;he<I.length;he++)W=I[he],K=Q+R(W,he),de+=D(W,Y,P,K,le);else if(he=v(I),typeof he=="function")for(I=he.call(I),he=0;!(W=I.next()).done;)W=W.value,K=Q+R(W,he++),de+=D(W,Y,P,K,le);else if(K==="object"){if(typeof I.then=="function")return D(B(I),Y,P,W,le);throw Y=String(I),Error("Objects are not valid as a React child (found: "+(Y==="[object Object]"?"object with keys {"+Object.keys(I).join(", ")+"}":Y)+"). If you meant to render a collection of children, use an array instead.")}return de}function O(I,Y,P){if(I==null)return I;var W=[],le=0;return D(I,W,"","",function(K){return Y.call(P,K,le++)}),W}function $(I){if(I._status===-1){var Y=I._result;Y=Y(),Y.then(function(P){(I._status===0||I._status===-1)&&(I._status=1,I._result=P)},function(P){(I._status===0||I._status===-1)&&(I._status=2,I._result=P)}),I._status===-1&&(I._status=0,I._result=Y)}if(I._status===1)return I._result.default;throw I._result}var F=typeof reportError=="function"?reportError:function(I){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var Y=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof I=="object"&&I!==null&&typeof I.message=="string"?String(I.message):String(I),error:I});if(!window.dispatchEvent(Y))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",I);return}console.error(I)},H={map:O,forEach:function(I,Y,P){O(I,function(){Y.apply(this,arguments)},P)},count:function(I){var Y=0;return O(I,function(){Y++}),Y},toArray:function(I){return O(I,function(Y){return Y})||[]},only:function(I){if(!U(I))throw Error("React.Children.only expected to receive a single React element child.");return I}};return an.Activity=g,an.Children=H,an.Component=E,an.Fragment=s,an.Profiler=l,an.PureComponent=M,an.StrictMode=i,an.Suspense=p,an.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=C,an.__COMPILER_RUNTIME={__proto__:null,c:function(I){return C.H.useMemoCache(I)}},an.cache=function(I){return function(){return I.apply(null,arguments)}},an.cacheSignal=function(){return null},an.cloneElement=function(I,Y,P){if(I==null)throw Error("The argument must be a React element, but you passed "+I+".");var W=N({},I.props),le=I.key;if(Y!=null)for(K in Y.key!==void 0&&(le=""+Y.key),Y)!L.call(Y,K)||K==="key"||K==="__self"||K==="__source"||K==="ref"&&Y.ref===void 0||(W[K]=Y[K]);var K=arguments.length-2;if(K===1)W.children=P;else if(1<K){for(var de=Array(K),Q=0;Q<K;Q++)de[Q]=arguments[Q+2];W.children=de}return z(I.type,le,W)},an.createContext=function(I){return I={$$typeof:d,_currentValue:I,_currentValue2:I,_threadCount:0,Provider:null,Consumer:null},I.Provider=I,I.Consumer={$$typeof:o,_context:I},I},an.createElement=function(I,Y,P){var W,le={},K=null;if(Y!=null)for(W in Y.key!==void 0&&(K=""+Y.key),Y)L.call(Y,W)&&W!=="key"&&W!=="__self"&&W!=="__source"&&(le[W]=Y[W]);var de=arguments.length-2;if(de===1)le.children=P;else if(1<de){for(var Q=Array(de),he=0;he<de;he++)Q[he]=arguments[he+2];le.children=Q}if(I&&I.defaultProps)for(W in de=I.defaultProps,de)le[W]===void 0&&(le[W]=de[W]);return z(I,K,le)},an.createRef=function(){return{current:null}},an.forwardRef=function(I){return{$$typeof:f,render:I}},an.isValidElement=U,an.lazy=function(I){return{$$typeof:y,_payload:{_status:-1,_result:I},_init:$}},an.memo=function(I,Y){return{$$typeof:h,type:I,compare:Y===void 0?null:Y}},an.startTransition=function(I){var Y=C.T,P={};C.T=P;try{var W=I(),le=C.S;le!==null&&le(P,W),typeof W=="object"&&W!==null&&typeof W.then=="function"&&W.then(k,F)}catch(K){F(K)}finally{Y!==null&&P.types!==null&&(Y.types=P.types),C.T=Y}},an.unstable_useCacheRefresh=function(){return C.H.useCacheRefresh()},an.use=function(I){return C.H.use(I)},an.useActionState=function(I,Y,P){return C.H.useActionState(I,Y,P)},an.useCallback=function(I,Y){return C.H.useCallback(I,Y)},an.useContext=function(I){return C.H.useContext(I)},an.useDebugValue=function(){},an.useDeferredValue=function(I,Y){return C.H.useDeferredValue(I,Y)},an.useEffect=function(I,Y){return C.H.useEffect(I,Y)},an.useEffectEvent=function(I){return C.H.useEffectEvent(I)},an.useId=function(){return C.H.useId()},an.useImperativeHandle=function(I,Y,P){return C.H.useImperativeHandle(I,Y,P)},an.useInsertionEffect=function(I,Y){return C.H.useInsertionEffect(I,Y)},an.useLayoutEffect=function(I,Y){return C.H.useLayoutEffect(I,Y)},an.useMemo=function(I,Y){return C.H.useMemo(I,Y)},an.useOptimistic=function(I,Y){return C.H.useOptimistic(I,Y)},an.useReducer=function(I,Y,P){return C.H.useReducer(I,Y,P)},an.useRef=function(I){return C.H.useRef(I)},an.useState=function(I){return C.H.useState(I)},an.useSyncExternalStore=function(I,Y,P){return C.H.useSyncExternalStore(I,Y,P)},an.useTransition=function(){return C.H.useTransition()},an.version="19.2.0",an}var H0;function qc(){return H0||(H0=1,Kh.exports=VA()),Kh.exports}var u=qc();const Ze=Pi(u);var Zh={exports:{}},Ko={},Qh={exports:{}},Jh={};/**
 * @license React
 * scheduler.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var V0;function YA(){return V0||(V0=1,(function(e){function n(D,O){var $=D.length;D.push(O);e:for(;0<$;){var F=$-1>>>1,H=D[F];if(0<l(H,O))D[F]=O,D[$]=H,$=F;else break e}}function s(D){return D.length===0?null:D[0]}function i(D){if(D.length===0)return null;var O=D[0],$=D.pop();if($!==O){D[0]=$;e:for(var F=0,H=D.length,I=H>>>1;F<I;){var Y=2*(F+1)-1,P=D[Y],W=Y+1,le=D[W];if(0>l(P,$))W<H&&0>l(le,P)?(D[F]=le,D[W]=$,F=W):(D[F]=P,D[Y]=$,F=Y);else if(W<H&&0>l(le,$))D[F]=le,D[W]=$,F=W;else break e}}return O}function l(D,O){var $=D.sortIndex-O.sortIndex;return $!==0?$:D.id-O.id}if(e.unstable_now=void 0,typeof performance=="object"&&typeof performance.now=="function"){var o=performance;e.unstable_now=function(){return o.now()}}else{var d=Date,f=d.now();e.unstable_now=function(){return d.now()-f}}var p=[],h=[],y=1,g=null,b=3,v=!1,S=!1,N=!1,j=!1,E=typeof setTimeout=="function"?setTimeout:null,A=typeof clearTimeout=="function"?clearTimeout:null,M=typeof setImmediate<"u"?setImmediate:null;function _(D){for(var O=s(h);O!==null;){if(O.callback===null)i(h);else if(O.startTime<=D)i(h),O.sortIndex=O.expirationTime,n(p,O);else break;O=s(h)}}function T(D){if(N=!1,_(D),!S)if(s(p)!==null)S=!0,k||(k=!0,X());else{var O=s(h);O!==null&&B(T,O.startTime-D)}}var k=!1,C=-1,L=5,z=-1;function G(){return j?!0:!(e.unstable_now()-z<L)}function U(){if(j=!1,k){var D=e.unstable_now();z=D;var O=!0;try{e:{S=!1,N&&(N=!1,A(C),C=-1),v=!0;var $=b;try{t:{for(_(D),g=s(p);g!==null&&!(g.expirationTime>D&&G());){var F=g.callback;if(typeof F=="function"){g.callback=null,b=g.priorityLevel;var H=F(g.expirationTime<=D);if(D=e.unstable_now(),typeof H=="function"){g.callback=H,_(D),O=!0;break t}g===s(p)&&i(p),_(D)}else i(p);g=s(p)}if(g!==null)O=!0;else{var I=s(h);I!==null&&B(T,I.startTime-D),O=!1}}break e}finally{g=null,b=$,v=!1}O=void 0}}finally{O?X():k=!1}}}var X;if(typeof M=="function")X=function(){M(U)};else if(typeof MessageChannel<"u"){var V=new MessageChannel,R=V.port2;V.port1.onmessage=U,X=function(){R.postMessage(null)}}else X=function(){E(U,0)};function B(D,O){C=E(function(){D(e.unstable_now())},O)}e.unstable_IdlePriority=5,e.unstable_ImmediatePriority=1,e.unstable_LowPriority=4,e.unstable_NormalPriority=3,e.unstable_Profiling=null,e.unstable_UserBlockingPriority=2,e.unstable_cancelCallback=function(D){D.callback=null},e.unstable_forceFrameRate=function(D){0>D||125<D?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):L=0<D?Math.floor(1e3/D):5},e.unstable_getCurrentPriorityLevel=function(){return b},e.unstable_next=function(D){switch(b){case 1:case 2:case 3:var O=3;break;default:O=b}var $=b;b=O;try{return D()}finally{b=$}},e.unstable_requestPaint=function(){j=!0},e.unstable_runWithPriority=function(D,O){switch(D){case 1:case 2:case 3:case 4:case 5:break;default:D=3}var $=b;b=D;try{return O()}finally{b=$}},e.unstable_scheduleCallback=function(D,O,$){var F=e.unstable_now();switch(typeof $=="object"&&$!==null?($=$.delay,$=typeof $=="number"&&0<$?F+$:F):$=F,D){case 1:var H=-1;break;case 2:H=250;break;case 5:H=1073741823;break;case 4:H=1e4;break;default:H=5e3}return H=$+H,D={id:y++,callback:O,priorityLevel:D,startTime:$,expirationTime:H,sortIndex:-1},$>F?(D.sortIndex=$,n(h,D),s(p)===null&&D===s(h)&&(N?(A(C),C=-1):N=!0,B(T,$-F))):(D.sortIndex=H,n(p,D),S||v||(S=!0,k||(k=!0,X()))),D},e.unstable_shouldYield=G,e.unstable_wrapCallback=function(D){var O=b;return function(){var $=b;b=O;try{return D.apply(this,arguments)}finally{b=$}}}})(Jh)),Jh}var Y0;function GA(){return Y0||(Y0=1,Qh.exports=YA()),Qh.exports}var ep={exports:{}},pa={};/**
 * @license React
 * react-dom.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var G0;function WA(){if(G0)return pa;G0=1;var e=qc();function n(p){var h="https://react.dev/errors/"+p;if(1<arguments.length){h+="?args[]="+encodeURIComponent(arguments[1]);for(var y=2;y<arguments.length;y++)h+="&args[]="+encodeURIComponent(arguments[y])}return"Minified React error #"+p+"; visit "+h+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function s(){}var i={d:{f:s,r:function(){throw Error(n(522))},D:s,C:s,L:s,m:s,X:s,S:s,M:s},p:0,findDOMNode:null},l=Symbol.for("react.portal");function o(p,h,y){var g=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:l,key:g==null?null:""+g,children:p,containerInfo:h,implementation:y}}var d=e.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE;function f(p,h){if(p==="font")return"";if(typeof h=="string")return h==="use-credentials"?h:""}return pa.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE=i,pa.createPortal=function(p,h){var y=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!h||h.nodeType!==1&&h.nodeType!==9&&h.nodeType!==11)throw Error(n(299));return o(p,h,null,y)},pa.flushSync=function(p){var h=d.T,y=i.p;try{if(d.T=null,i.p=2,p)return p()}finally{d.T=h,i.p=y,i.d.f()}},pa.preconnect=function(p,h){typeof p=="string"&&(h?(h=h.crossOrigin,h=typeof h=="string"?h==="use-credentials"?h:"":void 0):h=null,i.d.C(p,h))},pa.prefetchDNS=function(p){typeof p=="string"&&i.d.D(p)},pa.preinit=function(p,h){if(typeof p=="string"&&h&&typeof h.as=="string"){var y=h.as,g=f(y,h.crossOrigin),b=typeof h.integrity=="string"?h.integrity:void 0,v=typeof h.fetchPriority=="string"?h.fetchPriority:void 0;y==="style"?i.d.S(p,typeof h.precedence=="string"?h.precedence:void 0,{crossOrigin:g,integrity:b,fetchPriority:v}):y==="script"&&i.d.X(p,{crossOrigin:g,integrity:b,fetchPriority:v,nonce:typeof h.nonce=="string"?h.nonce:void 0})}},pa.preinitModule=function(p,h){if(typeof p=="string")if(typeof h=="object"&&h!==null){if(h.as==null||h.as==="script"){var y=f(h.as,h.crossOrigin);i.d.M(p,{crossOrigin:y,integrity:typeof h.integrity=="string"?h.integrity:void 0,nonce:typeof h.nonce=="string"?h.nonce:void 0})}}else h==null&&i.d.M(p)},pa.preload=function(p,h){if(typeof p=="string"&&typeof h=="object"&&h!==null&&typeof h.as=="string"){var y=h.as,g=f(y,h.crossOrigin);i.d.L(p,y,{crossOrigin:g,integrity:typeof h.integrity=="string"?h.integrity:void 0,nonce:typeof h.nonce=="string"?h.nonce:void 0,type:typeof h.type=="string"?h.type:void 0,fetchPriority:typeof h.fetchPriority=="string"?h.fetchPriority:void 0,referrerPolicy:typeof h.referrerPolicy=="string"?h.referrerPolicy:void 0,imageSrcSet:typeof h.imageSrcSet=="string"?h.imageSrcSet:void 0,imageSizes:typeof h.imageSizes=="string"?h.imageSizes:void 0,media:typeof h.media=="string"?h.media:void 0})}},pa.preloadModule=function(p,h){if(typeof p=="string")if(h){var y=f(h.as,h.crossOrigin);i.d.m(p,{as:typeof h.as=="string"&&h.as!=="script"?h.as:void 0,crossOrigin:y,integrity:typeof h.integrity=="string"?h.integrity:void 0})}else i.d.m(p)},pa.requestFormReset=function(p){i.d.r(p)},pa.unstable_batchedUpdates=function(p,h){return p(h)},pa.useFormState=function(p,h,y){return d.H.useFormState(p,h,y)},pa.useFormStatus=function(){return d.H.useHostTransitionStatus()},pa.version="19.2.0",pa}var W0;function zN(){if(W0)return ep.exports;W0=1;function e(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(n){console.error(n)}}return e(),ep.exports=WA(),ep.exports}/**
 * @license React
 * react-dom-client.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var X0;function XA(){if(X0)return Ko;X0=1;var e=GA(),n=qc(),s=zN();function i(a){var r="https://react.dev/errors/"+a;if(1<arguments.length){r+="?args[]="+encodeURIComponent(arguments[1]);for(var c=2;c<arguments.length;c++)r+="&args[]="+encodeURIComponent(arguments[c])}return"Minified React error #"+a+"; visit "+r+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}function l(a){return!(!a||a.nodeType!==1&&a.nodeType!==9&&a.nodeType!==11)}function o(a){var r=a,c=a;if(a.alternate)for(;r.return;)r=r.return;else{a=r;do r=a,(r.flags&4098)!==0&&(c=r.return),a=r.return;while(a)}return r.tag===3?c:null}function d(a){if(a.tag===13){var r=a.memoizedState;if(r===null&&(a=a.alternate,a!==null&&(r=a.memoizedState)),r!==null)return r.dehydrated}return null}function f(a){if(a.tag===31){var r=a.memoizedState;if(r===null&&(a=a.alternate,a!==null&&(r=a.memoizedState)),r!==null)return r.dehydrated}return null}function p(a){if(o(a)!==a)throw Error(i(188))}function h(a){var r=a.alternate;if(!r){if(r=o(a),r===null)throw Error(i(188));return r!==a?null:a}for(var c=a,m=r;;){var x=c.return;if(x===null)break;var w=x.alternate;if(w===null){if(m=x.return,m!==null){c=m;continue}break}if(x.child===w.child){for(w=x.child;w;){if(w===c)return p(x),a;if(w===m)return p(x),r;w=w.sibling}throw Error(i(188))}if(c.return!==m.return)c=x,m=w;else{for(var q=!1,ne=x.child;ne;){if(ne===c){q=!0,c=x,m=w;break}if(ne===m){q=!0,m=x,c=w;break}ne=ne.sibling}if(!q){for(ne=w.child;ne;){if(ne===c){q=!0,c=w,m=x;break}if(ne===m){q=!0,m=w,c=x;break}ne=ne.sibling}if(!q)throw Error(i(189))}}if(c.alternate!==m)throw Error(i(190))}if(c.tag!==3)throw Error(i(188));return c.stateNode.current===c?a:r}function y(a){var r=a.tag;if(r===5||r===26||r===27||r===6)return a;for(a=a.child;a!==null;){if(r=y(a),r!==null)return r;a=a.sibling}return null}var g=Object.assign,b=Symbol.for("react.element"),v=Symbol.for("react.transitional.element"),S=Symbol.for("react.portal"),N=Symbol.for("react.fragment"),j=Symbol.for("react.strict_mode"),E=Symbol.for("react.profiler"),A=Symbol.for("react.consumer"),M=Symbol.for("react.context"),_=Symbol.for("react.forward_ref"),T=Symbol.for("react.suspense"),k=Symbol.for("react.suspense_list"),C=Symbol.for("react.memo"),L=Symbol.for("react.lazy"),z=Symbol.for("react.activity"),G=Symbol.for("react.memo_cache_sentinel"),U=Symbol.iterator;function X(a){return a===null||typeof a!="object"?null:(a=U&&a[U]||a["@@iterator"],typeof a=="function"?a:null)}var V=Symbol.for("react.client.reference");function R(a){if(a==null)return null;if(typeof a=="function")return a.$$typeof===V?null:a.displayName||a.name||null;if(typeof a=="string")return a;switch(a){case N:return"Fragment";case E:return"Profiler";case j:return"StrictMode";case T:return"Suspense";case k:return"SuspenseList";case z:return"Activity"}if(typeof a=="object")switch(a.$$typeof){case S:return"Portal";case M:return a.displayName||"Context";case A:return(a._context.displayName||"Context")+".Consumer";case _:var r=a.render;return a=a.displayName,a||(a=r.displayName||r.name||"",a=a!==""?"ForwardRef("+a+")":"ForwardRef"),a;case C:return r=a.displayName||null,r!==null?r:R(a.type)||"Memo";case L:r=a._payload,a=a._init;try{return R(a(r))}catch{}}return null}var B=Array.isArray,D=n.__CLIENT_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,O=s.__DOM_INTERNALS_DO_NOT_USE_OR_WARN_USERS_THEY_CANNOT_UPGRADE,$={pending:!1,data:null,method:null,action:null},F=[],H=-1;function I(a){return{current:a}}function Y(a){0>H||(a.current=F[H],F[H]=null,H--)}function P(a,r){H++,F[H]=a.current,a.current=r}var W=I(null),le=I(null),K=I(null),de=I(null);function Q(a,r){switch(P(K,r),P(le,a),P(W,null),r.nodeType){case 9:case 11:a=(a=r.documentElement)&&(a=a.namespaceURI)?u0(a):0;break;default:if(a=r.tagName,r=r.namespaceURI)r=u0(r),a=d0(r,a);else switch(a){case"svg":a=1;break;case"math":a=2;break;default:a=0}}Y(W),P(W,a)}function he(){Y(W),Y(le),Y(K)}function re(a){a.memoizedState!==null&&P(de,a);var r=W.current,c=d0(r,a.type);r!==c&&(P(le,a),P(W,c))}function Ce(a){le.current===a&&(Y(W),Y(le)),de.current===a&&(Y(de),Vo._currentValue=$)}var Re,ue;function se(a){if(Re===void 0)try{throw Error()}catch(c){var r=c.stack.trim().match(/\n( *(at )?)/);Re=r&&r[1]||"",ue=-1<c.stack.indexOf(`
    at`)?" (<anonymous>)":-1<c.stack.indexOf("@")?"@unknown:0:0":""}return`
`+Re+a+ue}var Le=!1;function be(a,r){if(!a||Le)return"";Le=!0;var c=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{var m={DetermineComponentFrameRoot:function(){try{if(r){var wt=function(){throw Error()};if(Object.defineProperty(wt.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(wt,[])}catch(ut){var at=ut}Reflect.construct(a,[],wt)}else{try{wt.call()}catch(ut){at=ut}a.call(wt.prototype)}}else{try{throw Error()}catch(ut){at=ut}(wt=a())&&typeof wt.catch=="function"&&wt.catch(function(){})}}catch(ut){if(ut&&at&&typeof ut.stack=="string")return[ut.stack,at.stack]}return[null,null]}};m.DetermineComponentFrameRoot.displayName="DetermineComponentFrameRoot";var x=Object.getOwnPropertyDescriptor(m.DetermineComponentFrameRoot,"name");x&&x.configurable&&Object.defineProperty(m.DetermineComponentFrameRoot,"name",{value:"DetermineComponentFrameRoot"});var w=m.DetermineComponentFrameRoot(),q=w[0],ne=w[1];if(q&&ne){var Ae=q.split(`
`),et=ne.split(`
`);for(x=m=0;m<Ae.length&&!Ae[m].includes("DetermineComponentFrameRoot");)m++;for(;x<et.length&&!et[x].includes("DetermineComponentFrameRoot");)x++;if(m===Ae.length||x===et.length)for(m=Ae.length-1,x=et.length-1;1<=m&&0<=x&&Ae[m]!==et[x];)x--;for(;1<=m&&0<=x;m--,x--)if(Ae[m]!==et[x]){if(m!==1||x!==1)do if(m--,x--,0>x||Ae[m]!==et[x]){var yt=`
`+Ae[m].replace(" at new "," at ");return a.displayName&&yt.includes("<anonymous>")&&(yt=yt.replace("<anonymous>",a.displayName)),yt}while(1<=m&&0<=x);break}}}finally{Le=!1,Error.prepareStackTrace=c}return(c=a?a.displayName||a.name:"")?se(c):""}function De(a,r){switch(a.tag){case 26:case 27:case 5:return se(a.type);case 16:return se("Lazy");case 13:return a.child!==r&&r!==null?se("Suspense Fallback"):se("Suspense");case 19:return se("SuspenseList");case 0:case 15:return be(a.type,!1);case 11:return be(a.type.render,!1);case 1:return be(a.type,!0);case 31:return se("Activity");default:return""}}function Me(a){try{var r="",c=null;do r+=De(a,c),c=a,a=a.return;while(a);return r}catch(m){return`
Error generating stack: `+m.message+`
`+m.stack}}var mt=Object.prototype.hasOwnProperty,ht=e.unstable_scheduleCallback,Ct=e.unstable_cancelCallback,At=e.unstable_shouldYield,we=e.unstable_requestPaint,st=e.unstable_now,lt=e.unstable_getCurrentPriorityLevel,Fe=e.unstable_ImmediatePriority,Xe=e.unstable_UserBlockingPriority,dt=e.unstable_NormalPriority,ie=e.unstable_LowPriority,ee=e.unstable_IdlePriority,ce=e.log,fe=e.unstable_setDisableYieldValue,qe=null,Pe=null;function Be(a){if(typeof ce=="function"&&fe(a),Pe&&typeof Pe.setStrictMode=="function")try{Pe.setStrictMode(qe,a)}catch{}}var Te=Math.clz32?Math.clz32:Mt,gt=Math.log,jt=Math.LN2;function Mt(a){return a>>>=0,a===0?32:31-(gt(a)/jt|0)|0}var tt=256,ft=262144,Rt=4194304;function Ft(a){var r=a&42;if(r!==0)return r;switch(a&-a){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:return 64;case 128:return 128;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:return a&261888;case 262144:case 524288:case 1048576:case 2097152:return a&3932160;case 4194304:case 8388608:case 16777216:case 33554432:return a&62914560;case 67108864:return 67108864;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 0;default:return a}}function Zt(a,r,c){var m=a.pendingLanes;if(m===0)return 0;var x=0,w=a.suspendedLanes,q=a.pingedLanes;a=a.warmLanes;var ne=m&134217727;return ne!==0?(m=ne&~w,m!==0?x=Ft(m):(q&=ne,q!==0?x=Ft(q):c||(c=ne&~a,c!==0&&(x=Ft(c))))):(ne=m&~w,ne!==0?x=Ft(ne):q!==0?x=Ft(q):c||(c=m&~a,c!==0&&(x=Ft(c)))),x===0?0:r!==0&&r!==x&&(r&w)===0&&(w=x&-x,c=r&-r,w>=c||w===32&&(c&4194048)!==0)?r:x}function Tt(a,r){return(a.pendingLanes&~(a.suspendedLanes&~a.pingedLanes)&r)===0}function We(a,r){switch(a){case 1:case 2:case 4:case 8:case 64:return r+250;case 16:case 32:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return r+5e3;case 4194304:case 8388608:case 16777216:case 33554432:return-1;case 67108864:case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function it(){var a=Rt;return Rt<<=1,(Rt&62914560)===0&&(Rt=4194304),a}function bt(a){for(var r=[],c=0;31>c;c++)r.push(a);return r}function oe(a,r){a.pendingLanes|=r,r!==268435456&&(a.suspendedLanes=0,a.pingedLanes=0,a.warmLanes=0)}function Ee(a,r,c,m,x,w){var q=a.pendingLanes;a.pendingLanes=c,a.suspendedLanes=0,a.pingedLanes=0,a.warmLanes=0,a.expiredLanes&=c,a.entangledLanes&=c,a.errorRecoveryDisabledLanes&=c,a.shellSuspendCounter=0;var ne=a.entanglements,Ae=a.expirationTimes,et=a.hiddenUpdates;for(c=q&~c;0<c;){var yt=31-Te(c),wt=1<<yt;ne[yt]=0,Ae[yt]=-1;var at=et[yt];if(at!==null)for(et[yt]=null,yt=0;yt<at.length;yt++){var ut=at[yt];ut!==null&&(ut.lane&=-536870913)}c&=~wt}m!==0&&Se(a,m,0),w!==0&&x===0&&a.tag!==0&&(a.suspendedLanes|=w&~(q&~r))}function Se(a,r,c){a.pendingLanes|=r,a.suspendedLanes&=~r;var m=31-Te(r);a.entangledLanes|=r,a.entanglements[m]=a.entanglements[m]|1073741824|c&261930}function Ve(a,r){var c=a.entangledLanes|=r;for(a=a.entanglements;c;){var m=31-Te(c),x=1<<m;x&r|a[m]&r&&(a[m]|=r),c&=~x}}function xe(a,r){var c=r&-r;return c=(c&42)!==0?1:$e(c),(c&(a.suspendedLanes|r))!==0?0:c}function $e(a){switch(a){case 2:a=1;break;case 8:a=4;break;case 32:a=16;break;case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:a=128;break;case 268435456:a=134217728;break;default:a=0}return a}function He(a){return a&=-a,2<a?8<a?(a&134217727)!==0?32:268435456:8:2}function J(){var a=O.p;return a!==0?a:(a=window.event,a===void 0?32:L0(a.type))}function Z(a,r){var c=O.p;try{return O.p=a,r()}finally{O.p=c}}var je=Math.random().toString(36).slice(2),Ne="__reactFiber$"+je,pe="__reactProps$"+je,Ue="__reactContainer$"+je,ae="__reactEvents$"+je,Ke="__reactListeners$"+je,ot="__reactHandles$"+je,St="__reactResources$"+je,me="__reactMarker$"+je;function nt(a){delete a[Ne],delete a[pe],delete a[ae],delete a[Ke],delete a[ot]}function Ge(a){var r=a[Ne];if(r)return r;for(var c=a.parentNode;c;){if(r=c[Ue]||c[Ne]){if(c=r.alternate,r.child!==null||c!==null&&c.child!==null)for(a=b0(a);a!==null;){if(c=a[Ne])return c;a=b0(a)}return r}a=c,c=a.parentNode}return null}function vt(a){if(a=a[Ne]||a[Ue]){var r=a.tag;if(r===5||r===6||r===13||r===31||r===26||r===27||r===3)return a}return null}function ct(a){var r=a.tag;if(r===5||r===26||r===27||r===6)return a.stateNode;throw Error(i(33))}function Nt(a){var r=a[St];return r||(r=a[St]={hoistableStyles:new Map,hoistableScripts:new Map}),r}function Ye(a){a[me]=!0}var Je=new Set,Et={};function te(a,r){ve(a,r),ve(a+"Capture",r)}function ve(a,r){for(Et[a]=r,a=0;a<r.length;a++)Je.add(r[a])}var Ie=RegExp("^[:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD][:A-Z_a-z\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD\\-.0-9\\u00B7\\u0300-\\u036F\\u203F-\\u2040]*$"),rt={},_t={};function Lt(a){return mt.call(_t,a)?!0:mt.call(rt,a)?!1:Ie.test(a)?_t[a]=!0:(rt[a]=!0,!1)}function nn(a,r,c){if(Lt(r))if(c===null)a.removeAttribute(r);else{switch(typeof c){case"undefined":case"function":case"symbol":a.removeAttribute(r);return;case"boolean":var m=r.toLowerCase().slice(0,5);if(m!=="data-"&&m!=="aria-"){a.removeAttribute(r);return}}a.setAttribute(r,""+c)}}function Pt(a,r,c){if(c===null)a.removeAttribute(r);else{switch(typeof c){case"undefined":case"function":case"symbol":case"boolean":a.removeAttribute(r);return}a.setAttribute(r,""+c)}}function zt(a,r,c,m){if(m===null)a.removeAttribute(c);else{switch(typeof m){case"undefined":case"function":case"symbol":case"boolean":a.removeAttribute(c);return}a.setAttributeNS(r,c,""+m)}}function Ut(a){switch(typeof a){case"bigint":case"boolean":case"number":case"string":case"undefined":return a;case"object":return a;default:return""}}function dn(a){var r=a.type;return(a=a.nodeName)&&a.toLowerCase()==="input"&&(r==="checkbox"||r==="radio")}function Un(a,r,c){var m=Object.getOwnPropertyDescriptor(a.constructor.prototype,r);if(!a.hasOwnProperty(r)&&typeof m<"u"&&typeof m.get=="function"&&typeof m.set=="function"){var x=m.get,w=m.set;return Object.defineProperty(a,r,{configurable:!0,get:function(){return x.call(this)},set:function(q){c=""+q,w.call(this,q)}}),Object.defineProperty(a,r,{enumerable:m.enumerable}),{getValue:function(){return c},setValue:function(q){c=""+q},stopTracking:function(){a._valueTracker=null,delete a[r]}}}}function yn(a){if(!a._valueTracker){var r=dn(a)?"checked":"value";a._valueTracker=Un(a,r,""+a[r])}}function ja(a){if(!a)return!1;var r=a._valueTracker;if(!r)return!0;var c=r.getValue(),m="";return a&&(m=dn(a)?a.checked?"true":"false":a.value),a=m,a!==c?(r.setValue(a),!0):!1}function ha(a){if(a=a||(typeof document<"u"?document:void 0),typeof a>"u")return null;try{return a.activeElement||a.body}catch{return a.body}}var Xi=/[\n"\\]/g;function na(a){return a.replace(Xi,function(r){return"\\"+r.charCodeAt(0).toString(16)+" "})}function hs(a,r,c,m,x,w,q,ne){a.name="",q!=null&&typeof q!="function"&&typeof q!="symbol"&&typeof q!="boolean"?a.type=q:a.removeAttribute("type"),r!=null?q==="number"?(r===0&&a.value===""||a.value!=r)&&(a.value=""+Ut(r)):a.value!==""+Ut(r)&&(a.value=""+Ut(r)):q!=="submit"&&q!=="reset"||a.removeAttribute("value"),r!=null?ui(a,q,Ut(r)):c!=null?ui(a,q,Ut(c)):m!=null&&a.removeAttribute("value"),x==null&&w!=null&&(a.defaultChecked=!!w),x!=null&&(a.checked=x&&typeof x!="function"&&typeof x!="symbol"),ne!=null&&typeof ne!="function"&&typeof ne!="symbol"&&typeof ne!="boolean"?a.name=""+Ut(ne):a.removeAttribute("name")}function jr(a,r,c,m,x,w,q,ne){if(w!=null&&typeof w!="function"&&typeof w!="symbol"&&typeof w!="boolean"&&(a.type=w),r!=null||c!=null){if(!(w!=="submit"&&w!=="reset"||r!=null)){yn(a);return}c=c!=null?""+Ut(c):"",r=r!=null?""+Ut(r):c,ne||r===a.value||(a.value=r),a.defaultValue=r}m=m??x,m=typeof m!="function"&&typeof m!="symbol"&&!!m,a.checked=ne?a.checked:!!m,a.defaultChecked=!!m,q!=null&&typeof q!="function"&&typeof q!="symbol"&&typeof q!="boolean"&&(a.name=q),yn(a)}function ui(a,r,c){r==="number"&&ha(a.ownerDocument)===a||a.defaultValue===""+c||(a.defaultValue=""+c)}function ps(a,r,c,m){if(a=a.options,r){r={};for(var x=0;x<c.length;x++)r["$"+c[x]]=!0;for(c=0;c<a.length;c++)x=r.hasOwnProperty("$"+a[c].value),a[c].selected!==x&&(a[c].selected=x),x&&m&&(a[c].defaultSelected=!0)}else{for(c=""+Ut(c),r=null,x=0;x<a.length;x++){if(a[x].value===c){a[x].selected=!0,m&&(a[x].defaultSelected=!0);return}r!==null||a[x].disabled||(r=a[x])}r!==null&&(r.selected=!0)}}function qn(a,r,c){if(r!=null&&(r=""+Ut(r),r!==a.value&&(a.value=r),c==null)){a.defaultValue!==r&&(a.defaultValue=r);return}a.defaultValue=c!=null?""+Ut(c):""}function Xs(a,r,c,m){if(r==null){if(m!=null){if(c!=null)throw Error(i(92));if(B(m)){if(1<m.length)throw Error(i(93));m=m[0]}c=m}c==null&&(c=""),r=c}c=Ut(r),a.defaultValue=c,m=a.textContent,m===c&&m!==""&&m!==null&&(a.value=m),yn(a)}function Ea(a,r){if(r){var c=a.firstChild;if(c&&c===a.lastChild&&c.nodeType===3){c.nodeValue=r;return}}a.textContent=r}var io=new Set("animationIterationCount aspectRatio borderImageOutset borderImageSlice borderImageWidth boxFlex boxFlexGroup boxOrdinalGroup columnCount columns flex flexGrow flexPositive flexShrink flexNegative flexOrder gridArea gridRow gridRowEnd gridRowSpan gridRowStart gridColumn gridColumnEnd gridColumnSpan gridColumnStart fontWeight lineClamp lineHeight opacity order orphans scale tabSize widows zIndex zoom fillOpacity floodOpacity stopOpacity strokeDasharray strokeDashoffset strokeMiterlimit strokeOpacity strokeWidth MozAnimationIterationCount MozBoxFlex MozBoxFlexGroup MozLineClamp msAnimationIterationCount msFlex msZoom msFlexGrow msFlexNegative msFlexOrder msFlexPositive msFlexShrink msGridColumn msGridColumnSpan msGridRow msGridRowSpan WebkitAnimationIterationCount WebkitBoxFlex WebKitBoxFlexGroup WebkitBoxOrdinalGroup WebkitColumnCount WebkitColumns WebkitFlex WebkitFlexGrow WebkitFlexPositive WebkitFlexShrink WebkitLineClamp".split(" "));function Ki(a,r,c){var m=r.indexOf("--")===0;c==null||typeof c=="boolean"||c===""?m?a.setProperty(r,""):r==="float"?a.cssFloat="":a[r]="":m?a.setProperty(r,c):typeof c!="number"||c===0||io.has(r)?r==="float"?a.cssFloat=c:a[r]=(""+c).trim():a[r]=c+"px"}function Zi(a,r,c){if(r!=null&&typeof r!="object")throw Error(i(62));if(a=a.style,c!=null){for(var m in c)!c.hasOwnProperty(m)||r!=null&&r.hasOwnProperty(m)||(m.indexOf("--")===0?a.setProperty(m,""):m==="float"?a.cssFloat="":a[m]="");for(var x in r)m=r[x],r.hasOwnProperty(x)&&c[x]!==m&&Ki(a,x,m)}else for(var w in r)r.hasOwnProperty(w)&&Ki(a,w,r[w])}function di(a){if(a.indexOf("-")===-1)return!1;switch(a){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var lo=new Map([["acceptCharset","accept-charset"],["htmlFor","for"],["httpEquiv","http-equiv"],["crossOrigin","crossorigin"],["accentHeight","accent-height"],["alignmentBaseline","alignment-baseline"],["arabicForm","arabic-form"],["baselineShift","baseline-shift"],["capHeight","cap-height"],["clipPath","clip-path"],["clipRule","clip-rule"],["colorInterpolation","color-interpolation"],["colorInterpolationFilters","color-interpolation-filters"],["colorProfile","color-profile"],["colorRendering","color-rendering"],["dominantBaseline","dominant-baseline"],["enableBackground","enable-background"],["fillOpacity","fill-opacity"],["fillRule","fill-rule"],["floodColor","flood-color"],["floodOpacity","flood-opacity"],["fontFamily","font-family"],["fontSize","font-size"],["fontSizeAdjust","font-size-adjust"],["fontStretch","font-stretch"],["fontStyle","font-style"],["fontVariant","font-variant"],["fontWeight","font-weight"],["glyphName","glyph-name"],["glyphOrientationHorizontal","glyph-orientation-horizontal"],["glyphOrientationVertical","glyph-orientation-vertical"],["horizAdvX","horiz-adv-x"],["horizOriginX","horiz-origin-x"],["imageRendering","image-rendering"],["letterSpacing","letter-spacing"],["lightingColor","lighting-color"],["markerEnd","marker-end"],["markerMid","marker-mid"],["markerStart","marker-start"],["overlinePosition","overline-position"],["overlineThickness","overline-thickness"],["paintOrder","paint-order"],["panose-1","panose-1"],["pointerEvents","pointer-events"],["renderingIntent","rendering-intent"],["shapeRendering","shape-rendering"],["stopColor","stop-color"],["stopOpacity","stop-opacity"],["strikethroughPosition","strikethrough-position"],["strikethroughThickness","strikethrough-thickness"],["strokeDasharray","stroke-dasharray"],["strokeDashoffset","stroke-dashoffset"],["strokeLinecap","stroke-linecap"],["strokeLinejoin","stroke-linejoin"],["strokeMiterlimit","stroke-miterlimit"],["strokeOpacity","stroke-opacity"],["strokeWidth","stroke-width"],["textAnchor","text-anchor"],["textDecoration","text-decoration"],["textRendering","text-rendering"],["transformOrigin","transform-origin"],["underlinePosition","underline-position"],["underlineThickness","underline-thickness"],["unicodeBidi","unicode-bidi"],["unicodeRange","unicode-range"],["unitsPerEm","units-per-em"],["vAlphabetic","v-alphabetic"],["vHanging","v-hanging"],["vIdeographic","v-ideographic"],["vMathematical","v-mathematical"],["vectorEffect","vector-effect"],["vertAdvY","vert-adv-y"],["vertOriginX","vert-origin-x"],["vertOriginY","vert-origin-y"],["wordSpacing","word-spacing"],["writingMode","writing-mode"],["xmlnsXlink","xmlns:xlink"],["xHeight","x-height"]]),oo=/^[\u0000-\u001F ]*j[\r\n\t]*a[\r\n\t]*v[\r\n\t]*a[\r\n\t]*s[\r\n\t]*c[\r\n\t]*r[\r\n\t]*i[\r\n\t]*p[\r\n\t]*t[\r\n\t]*:/i;function ye(a){return oo.test(""+a)?"javascript:throw new Error('React has blocked a javascript: URL as a security precaution.')":a}function Oe(){}var $t=null;function Qt(a){return a=a.target||a.srcElement||window,a.correspondingUseElement&&(a=a.correspondingUseElement),a.nodeType===3?a.parentNode:a}var ge=null,_e=null;function pt(a){var r=vt(a);if(r&&(a=r.stateNode)){var c=a[pe]||null;e:switch(a=r.stateNode,r.type){case"input":if(hs(a,c.value,c.defaultValue,c.defaultValue,c.checked,c.defaultChecked,c.type,c.name),r=c.name,c.type==="radio"&&r!=null){for(c=a;c.parentNode;)c=c.parentNode;for(c=c.querySelectorAll('input[name="'+na(""+r)+'"][type="radio"]'),r=0;r<c.length;r++){var m=c[r];if(m!==a&&m.form===a.form){var x=m[pe]||null;if(!x)throw Error(i(90));hs(m,x.value,x.defaultValue,x.defaultValue,x.checked,x.defaultChecked,x.type,x.name)}}for(r=0;r<c.length;r++)m=c[r],m.form===a.form&&ja(m)}break e;case"textarea":qn(a,c.value,c.defaultValue);break e;case"select":r=c.value,r!=null&&ps(a,!!c.multiple,r,!1)}}}var Dt=!1;function Ht(a,r,c){if(Dt)return a(r,c);Dt=!0;try{var m=a(r);return m}finally{if(Dt=!1,(ge!==null||_e!==null)&&(Ou(),ge&&(r=ge,a=_e,_e=ge=null,pt(r),a)))for(r=0;r<a.length;r++)pt(a[r])}}function tn(a,r){var c=a.stateNode;if(c===null)return null;var m=c[pe]||null;if(m===null)return null;c=m[r];e:switch(r){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(m=!m.disabled)||(a=a.type,m=!(a==="button"||a==="input"||a==="select"||a==="textarea")),a=!m;break e;default:a=!1}if(a)return null;if(c&&typeof c!="function")throw Error(i(231,r,typeof c));return c}var rn=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),en=!1;if(rn)try{var Cn={};Object.defineProperty(Cn,"passive",{get:function(){en=!0}}),window.addEventListener("test",Cn,Cn),window.removeEventListener("test",Cn,Cn)}catch{en=!1}var Pn=null,oa=null,_a=null;function ga(){if(_a)return _a;var a,r=oa,c=r.length,m,x="value"in Pn?Pn.value:Pn.textContent,w=x.length;for(a=0;a<c&&r[a]===x[a];a++);var q=c-a;for(m=1;m<=q&&r[c-m]===x[w-m];m++);return _a=x.slice(a,1<m?1-m:void 0)}function ks(a){var r=a.keyCode;return"charCode"in a?(a=a.charCode,a===0&&r===13&&(a=13)):a=r,a===10&&(a=13),32<=a||a===13?a:0}function $a(){return!0}function fi(){return!1}function Xt(a){function r(c,m,x,w,q){this._reactName=c,this._targetInst=x,this.type=m,this.nativeEvent=w,this.target=q,this.currentTarget=null;for(var ne in a)a.hasOwnProperty(ne)&&(c=a[ne],this[ne]=c?c(w):w[ne]);return this.isDefaultPrevented=(w.defaultPrevented!=null?w.defaultPrevented:w.returnValue===!1)?$a:fi,this.isPropagationStopped=fi,this}return g(r.prototype,{preventDefault:function(){this.defaultPrevented=!0;var c=this.nativeEvent;c&&(c.preventDefault?c.preventDefault():typeof c.returnValue!="unknown"&&(c.returnValue=!1),this.isDefaultPrevented=$a)},stopPropagation:function(){var c=this.nativeEvent;c&&(c.stopPropagation?c.stopPropagation():typeof c.cancelBubble!="unknown"&&(c.cancelBubble=!0),this.isPropagationStopped=$a)},persist:function(){},isPersistent:$a}),r}var Ca={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(a){return a.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},Jc=Xt(Ca),co=g({},Ca,{view:0,detail:0}),U_=Xt(co),Zf,Qf,uo,eu=g({},co,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:em,button:0,buttons:0,relatedTarget:function(a){return a.relatedTarget===void 0?a.fromElement===a.srcElement?a.toElement:a.fromElement:a.relatedTarget},movementX:function(a){return"movementX"in a?a.movementX:(a!==uo&&(uo&&a.type==="mousemove"?(Zf=a.screenX-uo.screenX,Qf=a.screenY-uo.screenY):Qf=Zf=0,uo=a),Zf)},movementY:function(a){return"movementY"in a?a.movementY:Qf}}),mb=Xt(eu),q_=g({},eu,{dataTransfer:0}),P_=Xt(q_),H_=g({},co,{relatedTarget:0}),Jf=Xt(H_),V_=g({},Ca,{animationName:0,elapsedTime:0,pseudoElement:0}),Y_=Xt(V_),G_=g({},Ca,{clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),W_=Xt(G_),X_=g({},Ca,{data:0}),hb=Xt(X_),K_={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},Z_={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},Q_={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function J_(a){var r=this.nativeEvent;return r.getModifierState?r.getModifierState(a):(a=Q_[a])?!!r[a]:!1}function em(){return J_}var eC=g({},co,{key:function(a){if(a.key){var r=K_[a.key]||a.key;if(r!=="Unidentified")return r}return a.type==="keypress"?(a=ks(a),a===13?"Enter":String.fromCharCode(a)):a.type==="keydown"||a.type==="keyup"?Z_[a.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:em,charCode:function(a){return a.type==="keypress"?ks(a):0},keyCode:function(a){return a.type==="keydown"||a.type==="keyup"?a.keyCode:0},which:function(a){return a.type==="keypress"?ks(a):a.type==="keydown"||a.type==="keyup"?a.keyCode:0}}),tC=Xt(eC),nC=g({},eu,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),pb=Xt(nC),aC=g({},co,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:em}),sC=Xt(aC),rC=g({},Ca,{propertyName:0,elapsedTime:0,pseudoElement:0}),iC=Xt(rC),lC=g({},eu,{deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?-a.wheelDelta:0},deltaZ:0,deltaMode:0}),oC=Xt(lC),cC=g({},Ca,{newState:0,oldState:0}),uC=Xt(cC),dC=[9,13,27,32],tm=rn&&"CompositionEvent"in window,fo=null;rn&&"documentMode"in document&&(fo=document.documentMode);var fC=rn&&"TextEvent"in window&&!fo,yb=rn&&(!tm||fo&&8<fo&&11>=fo),gb=" ",bb=!1;function xb(a,r){switch(a){case"keyup":return dC.indexOf(r.keyCode)!==-1;case"keydown":return r.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function vb(a){return a=a.detail,typeof a=="object"&&"data"in a?a.data:null}var Qi=!1;function mC(a,r){switch(a){case"compositionend":return vb(r);case"keypress":return r.which!==32?null:(bb=!0,gb);case"textInput":return a=r.data,a===gb&&bb?null:a;default:return null}}function hC(a,r){if(Qi)return a==="compositionend"||!tm&&xb(a,r)?(a=ga(),_a=oa=Pn=null,Qi=!1,a):null;switch(a){case"paste":return null;case"keypress":if(!(r.ctrlKey||r.altKey||r.metaKey)||r.ctrlKey&&r.altKey){if(r.char&&1<r.char.length)return r.char;if(r.which)return String.fromCharCode(r.which)}return null;case"compositionend":return yb&&r.locale!=="ko"?null:r.data;default:return null}}var pC={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Sb(a){var r=a&&a.nodeName&&a.nodeName.toLowerCase();return r==="input"?!!pC[a.type]:r==="textarea"}function wb(a,r,c,m){ge?_e?_e.push(m):_e=[m]:ge=m,r=Pu(r,"onChange"),0<r.length&&(c=new Jc("onChange","change",null,c,m),a.push({event:c,listeners:r}))}var mo=null,ho=null;function yC(a){s0(a,0)}function tu(a){var r=ct(a);if(ja(r))return a}function Nb(a,r){if(a==="change")return r}var jb=!1;if(rn){var nm;if(rn){var am="oninput"in document;if(!am){var Eb=document.createElement("div");Eb.setAttribute("oninput","return;"),am=typeof Eb.oninput=="function"}nm=am}else nm=!1;jb=nm&&(!document.documentMode||9<document.documentMode)}function _b(){mo&&(mo.detachEvent("onpropertychange",Cb),ho=mo=null)}function Cb(a){if(a.propertyName==="value"&&tu(ho)){var r=[];wb(r,ho,a,Qt(a)),Ht(yC,r)}}function gC(a,r,c){a==="focusin"?(_b(),mo=r,ho=c,mo.attachEvent("onpropertychange",Cb)):a==="focusout"&&_b()}function bC(a){if(a==="selectionchange"||a==="keyup"||a==="keydown")return tu(ho)}function xC(a,r){if(a==="click")return tu(r)}function vC(a,r){if(a==="input"||a==="change")return tu(r)}function SC(a,r){return a===r&&(a!==0||1/a===1/r)||a!==a&&r!==r}var Fa=typeof Object.is=="function"?Object.is:SC;function po(a,r){if(Fa(a,r))return!0;if(typeof a!="object"||a===null||typeof r!="object"||r===null)return!1;var c=Object.keys(a),m=Object.keys(r);if(c.length!==m.length)return!1;for(m=0;m<c.length;m++){var x=c[m];if(!mt.call(r,x)||!Fa(a[x],r[x]))return!1}return!0}function Ab(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function Tb(a,r){var c=Ab(a);a=0;for(var m;c;){if(c.nodeType===3){if(m=a+c.textContent.length,a<=r&&m>=r)return{node:c,offset:r-a};a=m}e:{for(;c;){if(c.nextSibling){c=c.nextSibling;break e}c=c.parentNode}c=void 0}c=Ab(c)}}function Mb(a,r){return a&&r?a===r?!0:a&&a.nodeType===3?!1:r&&r.nodeType===3?Mb(a,r.parentNode):"contains"in a?a.contains(r):a.compareDocumentPosition?!!(a.compareDocumentPosition(r)&16):!1:!1}function kb(a){a=a!=null&&a.ownerDocument!=null&&a.ownerDocument.defaultView!=null?a.ownerDocument.defaultView:window;for(var r=ha(a.document);r instanceof a.HTMLIFrameElement;){try{var c=typeof r.contentWindow.location.href=="string"}catch{c=!1}if(c)a=r.contentWindow;else break;r=ha(a.document)}return r}function sm(a){var r=a&&a.nodeName&&a.nodeName.toLowerCase();return r&&(r==="input"&&(a.type==="text"||a.type==="search"||a.type==="tel"||a.type==="url"||a.type==="password")||r==="textarea"||a.contentEditable==="true")}var wC=rn&&"documentMode"in document&&11>=document.documentMode,Ji=null,rm=null,yo=null,im=!1;function Rb(a,r,c){var m=c.window===c?c.document:c.nodeType===9?c:c.ownerDocument;im||Ji==null||Ji!==ha(m)||(m=Ji,"selectionStart"in m&&sm(m)?m={start:m.selectionStart,end:m.selectionEnd}:(m=(m.ownerDocument&&m.ownerDocument.defaultView||window).getSelection(),m={anchorNode:m.anchorNode,anchorOffset:m.anchorOffset,focusNode:m.focusNode,focusOffset:m.focusOffset}),yo&&po(yo,m)||(yo=m,m=Pu(rm,"onSelect"),0<m.length&&(r=new Jc("onSelect","select",null,r,c),a.push({event:r,listeners:m}),r.target=Ji)))}function mi(a,r){var c={};return c[a.toLowerCase()]=r.toLowerCase(),c["Webkit"+a]="webkit"+r,c["Moz"+a]="moz"+r,c}var el={animationend:mi("Animation","AnimationEnd"),animationiteration:mi("Animation","AnimationIteration"),animationstart:mi("Animation","AnimationStart"),transitionrun:mi("Transition","TransitionRun"),transitionstart:mi("Transition","TransitionStart"),transitioncancel:mi("Transition","TransitionCancel"),transitionend:mi("Transition","TransitionEnd")},lm={},Ib={};rn&&(Ib=document.createElement("div").style,"AnimationEvent"in window||(delete el.animationend.animation,delete el.animationiteration.animation,delete el.animationstart.animation),"TransitionEvent"in window||delete el.transitionend.transition);function hi(a){if(lm[a])return lm[a];if(!el[a])return a;var r=el[a],c;for(c in r)if(r.hasOwnProperty(c)&&c in Ib)return lm[a]=r[c];return a}var Lb=hi("animationend"),Db=hi("animationiteration"),Ob=hi("animationstart"),NC=hi("transitionrun"),jC=hi("transitionstart"),EC=hi("transitioncancel"),$b=hi("transitionend"),Fb=new Map,om="abort auxClick beforeToggle cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");om.push("scrollEnd");function ys(a,r){Fb.set(a,r),te(r,[a])}var nu=typeof reportError=="function"?reportError:function(a){if(typeof window=="object"&&typeof window.ErrorEvent=="function"){var r=new window.ErrorEvent("error",{bubbles:!0,cancelable:!0,message:typeof a=="object"&&a!==null&&typeof a.message=="string"?String(a.message):String(a),error:a});if(!window.dispatchEvent(r))return}else if(typeof process=="object"&&typeof process.emit=="function"){process.emit("uncaughtException",a);return}console.error(a)},Za=[],tl=0,cm=0;function au(){for(var a=tl,r=cm=tl=0;r<a;){var c=Za[r];Za[r++]=null;var m=Za[r];Za[r++]=null;var x=Za[r];Za[r++]=null;var w=Za[r];if(Za[r++]=null,m!==null&&x!==null){var q=m.pending;q===null?x.next=x:(x.next=q.next,q.next=x),m.pending=x}w!==0&&zb(c,x,w)}}function su(a,r,c,m){Za[tl++]=a,Za[tl++]=r,Za[tl++]=c,Za[tl++]=m,cm|=m,a.lanes|=m,a=a.alternate,a!==null&&(a.lanes|=m)}function um(a,r,c,m){return su(a,r,c,m),ru(a)}function pi(a,r){return su(a,null,null,r),ru(a)}function zb(a,r,c){a.lanes|=c;var m=a.alternate;m!==null&&(m.lanes|=c);for(var x=!1,w=a.return;w!==null;)w.childLanes|=c,m=w.alternate,m!==null&&(m.childLanes|=c),w.tag===22&&(a=w.stateNode,a===null||a._visibility&1||(x=!0)),a=w,w=w.return;return a.tag===3?(w=a.stateNode,x&&r!==null&&(x=31-Te(c),a=w.hiddenUpdates,m=a[x],m===null?a[x]=[r]:m.push(r),r.lane=c|536870912),w):null}function ru(a){if(50<Fo)throw Fo=0,xh=null,Error(i(185));for(var r=a.return;r!==null;)a=r,r=a.return;return a.tag===3?a.stateNode:null}var nl={};function _C(a,r,c,m){this.tag=a,this.key=c,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.refCleanup=this.ref=null,this.pendingProps=r,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=m,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function za(a,r,c,m){return new _C(a,r,c,m)}function dm(a){return a=a.prototype,!(!a||!a.isReactComponent)}function Ks(a,r){var c=a.alternate;return c===null?(c=za(a.tag,r,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=r,c.type=a.type,c.flags=0,c.subtreeFlags=0,c.deletions=null),c.flags=a.flags&65011712,c.childLanes=a.childLanes,c.lanes=a.lanes,c.child=a.child,c.memoizedProps=a.memoizedProps,c.memoizedState=a.memoizedState,c.updateQueue=a.updateQueue,r=a.dependencies,c.dependencies=r===null?null:{lanes:r.lanes,firstContext:r.firstContext},c.sibling=a.sibling,c.index=a.index,c.ref=a.ref,c.refCleanup=a.refCleanup,c}function Bb(a,r){a.flags&=65011714;var c=a.alternate;return c===null?(a.childLanes=0,a.lanes=r,a.child=null,a.subtreeFlags=0,a.memoizedProps=null,a.memoizedState=null,a.updateQueue=null,a.dependencies=null,a.stateNode=null):(a.childLanes=c.childLanes,a.lanes=c.lanes,a.child=c.child,a.subtreeFlags=0,a.deletions=null,a.memoizedProps=c.memoizedProps,a.memoizedState=c.memoizedState,a.updateQueue=c.updateQueue,a.type=c.type,r=c.dependencies,a.dependencies=r===null?null:{lanes:r.lanes,firstContext:r.firstContext}),a}function iu(a,r,c,m,x,w){var q=0;if(m=a,typeof a=="function")dm(a)&&(q=1);else if(typeof a=="string")q=kA(a,c,W.current)?26:a==="html"||a==="head"||a==="body"?27:5;else e:switch(a){case z:return a=za(31,c,r,x),a.elementType=z,a.lanes=w,a;case N:return yi(c.children,x,w,r);case j:q=8,x|=24;break;case E:return a=za(12,c,r,x|2),a.elementType=E,a.lanes=w,a;case T:return a=za(13,c,r,x),a.elementType=T,a.lanes=w,a;case k:return a=za(19,c,r,x),a.elementType=k,a.lanes=w,a;default:if(typeof a=="object"&&a!==null)switch(a.$$typeof){case M:q=10;break e;case A:q=9;break e;case _:q=11;break e;case C:q=14;break e;case L:q=16,m=null;break e}q=29,c=Error(i(130,a===null?"null":typeof a,"")),m=null}return r=za(q,c,r,x),r.elementType=a,r.type=m,r.lanes=w,r}function yi(a,r,c,m){return a=za(7,a,m,r),a.lanes=c,a}function fm(a,r,c){return a=za(6,a,null,r),a.lanes=c,a}function Ub(a){var r=za(18,null,null,0);return r.stateNode=a,r}function mm(a,r,c){return r=za(4,a.children!==null?a.children:[],a.key,r),r.lanes=c,r.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation},r}var qb=new WeakMap;function Qa(a,r){if(typeof a=="object"&&a!==null){var c=qb.get(a);return c!==void 0?c:(r={value:a,source:r,stack:Me(r)},qb.set(a,r),r)}return{value:a,source:r,stack:Me(r)}}var al=[],sl=0,lu=null,go=0,Ja=[],es=0,Er=null,Rs=1,Is="";function Zs(a,r){al[sl++]=go,al[sl++]=lu,lu=a,go=r}function Pb(a,r,c){Ja[es++]=Rs,Ja[es++]=Is,Ja[es++]=Er,Er=a;var m=Rs;a=Is;var x=32-Te(m)-1;m&=~(1<<x),c+=1;var w=32-Te(r)+x;if(30<w){var q=x-x%5;w=(m&(1<<q)-1).toString(32),m>>=q,x-=q,Rs=1<<32-Te(r)+x|c<<x|m,Is=w+a}else Rs=1<<w|c<<x|m,Is=a}function hm(a){a.return!==null&&(Zs(a,1),Pb(a,1,0))}function pm(a){for(;a===lu;)lu=al[--sl],al[sl]=null,go=al[--sl],al[sl]=null;for(;a===Er;)Er=Ja[--es],Ja[es]=null,Is=Ja[--es],Ja[es]=null,Rs=Ja[--es],Ja[es]=null}function Hb(a,r){Ja[es++]=Rs,Ja[es++]=Is,Ja[es++]=Er,Rs=r.id,Is=r.overflow,Er=a}var ca=null,On=null,Sn=!1,_r=null,ts=!1,ym=Error(i(519));function Cr(a){var r=Error(i(418,1<arguments.length&&arguments[1]!==void 0&&arguments[1]?"text":"HTML",""));throw bo(Qa(r,a)),ym}function Vb(a){var r=a.stateNode,c=a.type,m=a.memoizedProps;switch(r[Ne]=a,r[pe]=m,c){case"dialog":bn("cancel",r),bn("close",r);break;case"iframe":case"object":case"embed":bn("load",r);break;case"video":case"audio":for(c=0;c<Bo.length;c++)bn(Bo[c],r);break;case"source":bn("error",r);break;case"img":case"image":case"link":bn("error",r),bn("load",r);break;case"details":bn("toggle",r);break;case"input":bn("invalid",r),jr(r,m.value,m.defaultValue,m.checked,m.defaultChecked,m.type,m.name,!0);break;case"select":bn("invalid",r);break;case"textarea":bn("invalid",r),Xs(r,m.value,m.defaultValue,m.children)}c=m.children,typeof c!="string"&&typeof c!="number"&&typeof c!="bigint"||r.textContent===""+c||m.suppressHydrationWarning===!0||o0(r.textContent,c)?(m.popover!=null&&(bn("beforetoggle",r),bn("toggle",r)),m.onScroll!=null&&bn("scroll",r),m.onScrollEnd!=null&&bn("scrollend",r),m.onClick!=null&&(r.onclick=Oe),r=!0):r=!1,r||Cr(a,!0)}function Yb(a){for(ca=a.return;ca;)switch(ca.tag){case 5:case 31:case 13:ts=!1;return;case 27:case 3:ts=!0;return;default:ca=ca.return}}function rl(a){if(a!==ca)return!1;if(!Sn)return Yb(a),Sn=!0,!1;var r=a.tag,c;if((c=r!==3&&r!==27)&&((c=r===5)&&(c=a.type,c=!(c!=="form"&&c!=="button")||Lh(a.type,a.memoizedProps)),c=!c),c&&On&&Cr(a),Yb(a),r===13){if(a=a.memoizedState,a=a!==null?a.dehydrated:null,!a)throw Error(i(317));On=g0(a)}else if(r===31){if(a=a.memoizedState,a=a!==null?a.dehydrated:null,!a)throw Error(i(317));On=g0(a)}else r===27?(r=On,Ur(a.type)?(a=zh,zh=null,On=a):On=r):On=ca?as(a.stateNode.nextSibling):null;return!0}function gi(){On=ca=null,Sn=!1}function gm(){var a=_r;return a!==null&&(ka===null?ka=a:ka.push.apply(ka,a),_r=null),a}function bo(a){_r===null?_r=[a]:_r.push(a)}var bm=I(null),bi=null,Qs=null;function Ar(a,r,c){P(bm,r._currentValue),r._currentValue=c}function Js(a){a._currentValue=bm.current,Y(bm)}function xm(a,r,c){for(;a!==null;){var m=a.alternate;if((a.childLanes&r)!==r?(a.childLanes|=r,m!==null&&(m.childLanes|=r)):m!==null&&(m.childLanes&r)!==r&&(m.childLanes|=r),a===c)break;a=a.return}}function vm(a,r,c,m){var x=a.child;for(x!==null&&(x.return=a);x!==null;){var w=x.dependencies;if(w!==null){var q=x.child;w=w.firstContext;e:for(;w!==null;){var ne=w;w=x;for(var Ae=0;Ae<r.length;Ae++)if(ne.context===r[Ae]){w.lanes|=c,ne=w.alternate,ne!==null&&(ne.lanes|=c),xm(w.return,c,a),m||(q=null);break e}w=ne.next}}else if(x.tag===18){if(q=x.return,q===null)throw Error(i(341));q.lanes|=c,w=q.alternate,w!==null&&(w.lanes|=c),xm(q,c,a),q=null}else q=x.child;if(q!==null)q.return=x;else for(q=x;q!==null;){if(q===a){q=null;break}if(x=q.sibling,x!==null){x.return=q.return,q=x;break}q=q.return}x=q}}function il(a,r,c,m){a=null;for(var x=r,w=!1;x!==null;){if(!w){if((x.flags&524288)!==0)w=!0;else if((x.flags&262144)!==0)break}if(x.tag===10){var q=x.alternate;if(q===null)throw Error(i(387));if(q=q.memoizedProps,q!==null){var ne=x.type;Fa(x.pendingProps.value,q.value)||(a!==null?a.push(ne):a=[ne])}}else if(x===de.current){if(q=x.alternate,q===null)throw Error(i(387));q.memoizedState.memoizedState!==x.memoizedState.memoizedState&&(a!==null?a.push(Vo):a=[Vo])}x=x.return}a!==null&&vm(r,a,c,m),r.flags|=262144}function ou(a){for(a=a.firstContext;a!==null;){if(!Fa(a.context._currentValue,a.memoizedValue))return!0;a=a.next}return!1}function xi(a){bi=a,Qs=null,a=a.dependencies,a!==null&&(a.firstContext=null)}function ua(a){return Gb(bi,a)}function cu(a,r){return bi===null&&xi(a),Gb(a,r)}function Gb(a,r){var c=r._currentValue;if(r={context:r,memoizedValue:c,next:null},Qs===null){if(a===null)throw Error(i(308));Qs=r,a.dependencies={lanes:0,firstContext:r},a.flags|=524288}else Qs=Qs.next=r;return c}var CC=typeof AbortController<"u"?AbortController:function(){var a=[],r=this.signal={aborted:!1,addEventListener:function(c,m){a.push(m)}};this.abort=function(){r.aborted=!0,a.forEach(function(c){return c()})}},AC=e.unstable_scheduleCallback,TC=e.unstable_NormalPriority,Zn={$$typeof:M,Consumer:null,Provider:null,_currentValue:null,_currentValue2:null,_threadCount:0};function Sm(){return{controller:new CC,data:new Map,refCount:0}}function xo(a){a.refCount--,a.refCount===0&&AC(TC,function(){a.controller.abort()})}var vo=null,wm=0,ll=0,ol=null;function MC(a,r){if(vo===null){var c=vo=[];wm=0,ll=Eh(),ol={status:"pending",value:void 0,then:function(m){c.push(m)}}}return wm++,r.then(Wb,Wb),r}function Wb(){if(--wm===0&&vo!==null){ol!==null&&(ol.status="fulfilled");var a=vo;vo=null,ll=0,ol=null;for(var r=0;r<a.length;r++)(0,a[r])()}}function kC(a,r){var c=[],m={status:"pending",value:null,reason:null,then:function(x){c.push(x)}};return a.then(function(){m.status="fulfilled",m.value=r;for(var x=0;x<c.length;x++)(0,c[x])(r)},function(x){for(m.status="rejected",m.reason=x,x=0;x<c.length;x++)(0,c[x])(void 0)}),m}var Xb=D.S;D.S=function(a,r){Rv=st(),typeof r=="object"&&r!==null&&typeof r.then=="function"&&MC(a,r),Xb!==null&&Xb(a,r)};var vi=I(null);function Nm(){var a=vi.current;return a!==null?a:Ln.pooledCache}function uu(a,r){r===null?P(vi,vi.current):P(vi,r.pool)}function Kb(){var a=Nm();return a===null?null:{parent:Zn._currentValue,pool:a}}var cl=Error(i(460)),jm=Error(i(474)),du=Error(i(542)),fu={then:function(){}};function Zb(a){return a=a.status,a==="fulfilled"||a==="rejected"}function Qb(a,r,c){switch(c=a[c],c===void 0?a.push(r):c!==r&&(r.then(Oe,Oe),r=c),r.status){case"fulfilled":return r.value;case"rejected":throw a=r.reason,ex(a),a;default:if(typeof r.status=="string")r.then(Oe,Oe);else{if(a=Ln,a!==null&&100<a.shellSuspendCounter)throw Error(i(482));a=r,a.status="pending",a.then(function(m){if(r.status==="pending"){var x=r;x.status="fulfilled",x.value=m}},function(m){if(r.status==="pending"){var x=r;x.status="rejected",x.reason=m}})}switch(r.status){case"fulfilled":return r.value;case"rejected":throw a=r.reason,ex(a),a}throw wi=r,cl}}function Si(a){try{var r=a._init;return r(a._payload)}catch(c){throw c!==null&&typeof c=="object"&&typeof c.then=="function"?(wi=c,cl):c}}var wi=null;function Jb(){if(wi===null)throw Error(i(459));var a=wi;return wi=null,a}function ex(a){if(a===cl||a===du)throw Error(i(483))}var ul=null,So=0;function mu(a){var r=So;return So+=1,ul===null&&(ul=[]),Qb(ul,a,r)}function wo(a,r){r=r.props.ref,a.ref=r!==void 0?r:null}function hu(a,r){throw r.$$typeof===b?Error(i(525)):(a=Object.prototype.toString.call(r),Error(i(31,a==="[object Object]"?"object with keys {"+Object.keys(r).join(", ")+"}":a)))}function tx(a){function r(ze,ke){if(a){var Qe=ze.deletions;Qe===null?(ze.deletions=[ke],ze.flags|=16):Qe.push(ke)}}function c(ze,ke){if(!a)return null;for(;ke!==null;)r(ze,ke),ke=ke.sibling;return null}function m(ze){for(var ke=new Map;ze!==null;)ze.key!==null?ke.set(ze.key,ze):ke.set(ze.index,ze),ze=ze.sibling;return ke}function x(ze,ke){return ze=Ks(ze,ke),ze.index=0,ze.sibling=null,ze}function w(ze,ke,Qe){return ze.index=Qe,a?(Qe=ze.alternate,Qe!==null?(Qe=Qe.index,Qe<ke?(ze.flags|=67108866,ke):Qe):(ze.flags|=67108866,ke)):(ze.flags|=1048576,ke)}function q(ze){return a&&ze.alternate===null&&(ze.flags|=67108866),ze}function ne(ze,ke,Qe,xt){return ke===null||ke.tag!==6?(ke=fm(Qe,ze.mode,xt),ke.return=ze,ke):(ke=x(ke,Qe),ke.return=ze,ke)}function Ae(ze,ke,Qe,xt){var Kt=Qe.type;return Kt===N?yt(ze,ke,Qe.props.children,xt,Qe.key):ke!==null&&(ke.elementType===Kt||typeof Kt=="object"&&Kt!==null&&Kt.$$typeof===L&&Si(Kt)===ke.type)?(ke=x(ke,Qe.props),wo(ke,Qe),ke.return=ze,ke):(ke=iu(Qe.type,Qe.key,Qe.props,null,ze.mode,xt),wo(ke,Qe),ke.return=ze,ke)}function et(ze,ke,Qe,xt){return ke===null||ke.tag!==4||ke.stateNode.containerInfo!==Qe.containerInfo||ke.stateNode.implementation!==Qe.implementation?(ke=mm(Qe,ze.mode,xt),ke.return=ze,ke):(ke=x(ke,Qe.children||[]),ke.return=ze,ke)}function yt(ze,ke,Qe,xt,Kt){return ke===null||ke.tag!==7?(ke=yi(Qe,ze.mode,xt,Kt),ke.return=ze,ke):(ke=x(ke,Qe),ke.return=ze,ke)}function wt(ze,ke,Qe){if(typeof ke=="string"&&ke!==""||typeof ke=="number"||typeof ke=="bigint")return ke=fm(""+ke,ze.mode,Qe),ke.return=ze,ke;if(typeof ke=="object"&&ke!==null){switch(ke.$$typeof){case v:return Qe=iu(ke.type,ke.key,ke.props,null,ze.mode,Qe),wo(Qe,ke),Qe.return=ze,Qe;case S:return ke=mm(ke,ze.mode,Qe),ke.return=ze,ke;case L:return ke=Si(ke),wt(ze,ke,Qe)}if(B(ke)||X(ke))return ke=yi(ke,ze.mode,Qe,null),ke.return=ze,ke;if(typeof ke.then=="function")return wt(ze,mu(ke),Qe);if(ke.$$typeof===M)return wt(ze,cu(ze,ke),Qe);hu(ze,ke)}return null}function at(ze,ke,Qe,xt){var Kt=ke!==null?ke.key:null;if(typeof Qe=="string"&&Qe!==""||typeof Qe=="number"||typeof Qe=="bigint")return Kt!==null?null:ne(ze,ke,""+Qe,xt);if(typeof Qe=="object"&&Qe!==null){switch(Qe.$$typeof){case v:return Qe.key===Kt?Ae(ze,ke,Qe,xt):null;case S:return Qe.key===Kt?et(ze,ke,Qe,xt):null;case L:return Qe=Si(Qe),at(ze,ke,Qe,xt)}if(B(Qe)||X(Qe))return Kt!==null?null:yt(ze,ke,Qe,xt,null);if(typeof Qe.then=="function")return at(ze,ke,mu(Qe),xt);if(Qe.$$typeof===M)return at(ze,ke,cu(ze,Qe),xt);hu(ze,Qe)}return null}function ut(ze,ke,Qe,xt,Kt){if(typeof xt=="string"&&xt!==""||typeof xt=="number"||typeof xt=="bigint")return ze=ze.get(Qe)||null,ne(ke,ze,""+xt,Kt);if(typeof xt=="object"&&xt!==null){switch(xt.$$typeof){case v:return ze=ze.get(xt.key===null?Qe:xt.key)||null,Ae(ke,ze,xt,Kt);case S:return ze=ze.get(xt.key===null?Qe:xt.key)||null,et(ke,ze,xt,Kt);case L:return xt=Si(xt),ut(ze,ke,Qe,xt,Kt)}if(B(xt)||X(xt))return ze=ze.get(Qe)||null,yt(ke,ze,xt,Kt,null);if(typeof xt.then=="function")return ut(ze,ke,Qe,mu(xt),Kt);if(xt.$$typeof===M)return ut(ze,ke,Qe,cu(ke,xt),Kt);hu(ke,xt)}return null}function qt(ze,ke,Qe,xt){for(var Kt=null,Nn=null,Vt=ke,on=ke=0,vn=null;Vt!==null&&on<Qe.length;on++){Vt.index>on?(vn=Vt,Vt=null):vn=Vt.sibling;var jn=at(ze,Vt,Qe[on],xt);if(jn===null){Vt===null&&(Vt=vn);break}a&&Vt&&jn.alternate===null&&r(ze,Vt),ke=w(jn,ke,on),Nn===null?Kt=jn:Nn.sibling=jn,Nn=jn,Vt=vn}if(on===Qe.length)return c(ze,Vt),Sn&&Zs(ze,on),Kt;if(Vt===null){for(;on<Qe.length;on++)Vt=wt(ze,Qe[on],xt),Vt!==null&&(ke=w(Vt,ke,on),Nn===null?Kt=Vt:Nn.sibling=Vt,Nn=Vt);return Sn&&Zs(ze,on),Kt}for(Vt=m(Vt);on<Qe.length;on++)vn=ut(Vt,ze,on,Qe[on],xt),vn!==null&&(a&&vn.alternate!==null&&Vt.delete(vn.key===null?on:vn.key),ke=w(vn,ke,on),Nn===null?Kt=vn:Nn.sibling=vn,Nn=vn);return a&&Vt.forEach(function(Yr){return r(ze,Yr)}),Sn&&Zs(ze,on),Kt}function Jt(ze,ke,Qe,xt){if(Qe==null)throw Error(i(151));for(var Kt=null,Nn=null,Vt=ke,on=ke=0,vn=null,jn=Qe.next();Vt!==null&&!jn.done;on++,jn=Qe.next()){Vt.index>on?(vn=Vt,Vt=null):vn=Vt.sibling;var Yr=at(ze,Vt,jn.value,xt);if(Yr===null){Vt===null&&(Vt=vn);break}a&&Vt&&Yr.alternate===null&&r(ze,Vt),ke=w(Yr,ke,on),Nn===null?Kt=Yr:Nn.sibling=Yr,Nn=Yr,Vt=vn}if(jn.done)return c(ze,Vt),Sn&&Zs(ze,on),Kt;if(Vt===null){for(;!jn.done;on++,jn=Qe.next())jn=wt(ze,jn.value,xt),jn!==null&&(ke=w(jn,ke,on),Nn===null?Kt=jn:Nn.sibling=jn,Nn=jn);return Sn&&Zs(ze,on),Kt}for(Vt=m(Vt);!jn.done;on++,jn=Qe.next())jn=ut(Vt,ze,on,jn.value,xt),jn!==null&&(a&&jn.alternate!==null&&Vt.delete(jn.key===null?on:jn.key),ke=w(jn,ke,on),Nn===null?Kt=jn:Nn.sibling=jn,Nn=jn);return a&&Vt.forEach(function(qA){return r(ze,qA)}),Sn&&Zs(ze,on),Kt}function In(ze,ke,Qe,xt){if(typeof Qe=="object"&&Qe!==null&&Qe.type===N&&Qe.key===null&&(Qe=Qe.props.children),typeof Qe=="object"&&Qe!==null){switch(Qe.$$typeof){case v:e:{for(var Kt=Qe.key;ke!==null;){if(ke.key===Kt){if(Kt=Qe.type,Kt===N){if(ke.tag===7){c(ze,ke.sibling),xt=x(ke,Qe.props.children),xt.return=ze,ze=xt;break e}}else if(ke.elementType===Kt||typeof Kt=="object"&&Kt!==null&&Kt.$$typeof===L&&Si(Kt)===ke.type){c(ze,ke.sibling),xt=x(ke,Qe.props),wo(xt,Qe),xt.return=ze,ze=xt;break e}c(ze,ke);break}else r(ze,ke);ke=ke.sibling}Qe.type===N?(xt=yi(Qe.props.children,ze.mode,xt,Qe.key),xt.return=ze,ze=xt):(xt=iu(Qe.type,Qe.key,Qe.props,null,ze.mode,xt),wo(xt,Qe),xt.return=ze,ze=xt)}return q(ze);case S:e:{for(Kt=Qe.key;ke!==null;){if(ke.key===Kt)if(ke.tag===4&&ke.stateNode.containerInfo===Qe.containerInfo&&ke.stateNode.implementation===Qe.implementation){c(ze,ke.sibling),xt=x(ke,Qe.children||[]),xt.return=ze,ze=xt;break e}else{c(ze,ke);break}else r(ze,ke);ke=ke.sibling}xt=mm(Qe,ze.mode,xt),xt.return=ze,ze=xt}return q(ze);case L:return Qe=Si(Qe),In(ze,ke,Qe,xt)}if(B(Qe))return qt(ze,ke,Qe,xt);if(X(Qe)){if(Kt=X(Qe),typeof Kt!="function")throw Error(i(150));return Qe=Kt.call(Qe),Jt(ze,ke,Qe,xt)}if(typeof Qe.then=="function")return In(ze,ke,mu(Qe),xt);if(Qe.$$typeof===M)return In(ze,ke,cu(ze,Qe),xt);hu(ze,Qe)}return typeof Qe=="string"&&Qe!==""||typeof Qe=="number"||typeof Qe=="bigint"?(Qe=""+Qe,ke!==null&&ke.tag===6?(c(ze,ke.sibling),xt=x(ke,Qe),xt.return=ze,ze=xt):(c(ze,ke),xt=fm(Qe,ze.mode,xt),xt.return=ze,ze=xt),q(ze)):c(ze,ke)}return function(ze,ke,Qe,xt){try{So=0;var Kt=In(ze,ke,Qe,xt);return ul=null,Kt}catch(Vt){if(Vt===cl||Vt===du)throw Vt;var Nn=za(29,Vt,null,ze.mode);return Nn.lanes=xt,Nn.return=ze,Nn}finally{}}}var Ni=tx(!0),nx=tx(!1),Tr=!1;function Em(a){a.updateQueue={baseState:a.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,lanes:0,hiddenCallbacks:null},callbacks:null}}function _m(a,r){a=a.updateQueue,r.updateQueue===a&&(r.updateQueue={baseState:a.baseState,firstBaseUpdate:a.firstBaseUpdate,lastBaseUpdate:a.lastBaseUpdate,shared:a.shared,callbacks:null})}function Mr(a){return{lane:a,tag:0,payload:null,callback:null,next:null}}function kr(a,r,c){var m=a.updateQueue;if(m===null)return null;if(m=m.shared,(En&2)!==0){var x=m.pending;return x===null?r.next=r:(r.next=x.next,x.next=r),m.pending=r,r=ru(a),zb(a,null,c),r}return su(a,m,r,c),ru(a)}function No(a,r,c){if(r=r.updateQueue,r!==null&&(r=r.shared,(c&4194048)!==0)){var m=r.lanes;m&=a.pendingLanes,c|=m,r.lanes=c,Ve(a,c)}}function Cm(a,r){var c=a.updateQueue,m=a.alternate;if(m!==null&&(m=m.updateQueue,c===m)){var x=null,w=null;if(c=c.firstBaseUpdate,c!==null){do{var q={lane:c.lane,tag:c.tag,payload:c.payload,callback:null,next:null};w===null?x=w=q:w=w.next=q,c=c.next}while(c!==null);w===null?x=w=r:w=w.next=r}else x=w=r;c={baseState:m.baseState,firstBaseUpdate:x,lastBaseUpdate:w,shared:m.shared,callbacks:m.callbacks},a.updateQueue=c;return}a=c.lastBaseUpdate,a===null?c.firstBaseUpdate=r:a.next=r,c.lastBaseUpdate=r}var Am=!1;function jo(){if(Am){var a=ol;if(a!==null)throw a}}function Eo(a,r,c,m){Am=!1;var x=a.updateQueue;Tr=!1;var w=x.firstBaseUpdate,q=x.lastBaseUpdate,ne=x.shared.pending;if(ne!==null){x.shared.pending=null;var Ae=ne,et=Ae.next;Ae.next=null,q===null?w=et:q.next=et,q=Ae;var yt=a.alternate;yt!==null&&(yt=yt.updateQueue,ne=yt.lastBaseUpdate,ne!==q&&(ne===null?yt.firstBaseUpdate=et:ne.next=et,yt.lastBaseUpdate=Ae))}if(w!==null){var wt=x.baseState;q=0,yt=et=Ae=null,ne=w;do{var at=ne.lane&-536870913,ut=at!==ne.lane;if(ut?(xn&at)===at:(m&at)===at){at!==0&&at===ll&&(Am=!0),yt!==null&&(yt=yt.next={lane:0,tag:ne.tag,payload:ne.payload,callback:null,next:null});e:{var qt=a,Jt=ne;at=r;var In=c;switch(Jt.tag){case 1:if(qt=Jt.payload,typeof qt=="function"){wt=qt.call(In,wt,at);break e}wt=qt;break e;case 3:qt.flags=qt.flags&-65537|128;case 0:if(qt=Jt.payload,at=typeof qt=="function"?qt.call(In,wt,at):qt,at==null)break e;wt=g({},wt,at);break e;case 2:Tr=!0}}at=ne.callback,at!==null&&(a.flags|=64,ut&&(a.flags|=8192),ut=x.callbacks,ut===null?x.callbacks=[at]:ut.push(at))}else ut={lane:at,tag:ne.tag,payload:ne.payload,callback:ne.callback,next:null},yt===null?(et=yt=ut,Ae=wt):yt=yt.next=ut,q|=at;if(ne=ne.next,ne===null){if(ne=x.shared.pending,ne===null)break;ut=ne,ne=ut.next,ut.next=null,x.lastBaseUpdate=ut,x.shared.pending=null}}while(!0);yt===null&&(Ae=wt),x.baseState=Ae,x.firstBaseUpdate=et,x.lastBaseUpdate=yt,w===null&&(x.shared.lanes=0),Or|=q,a.lanes=q,a.memoizedState=wt}}function ax(a,r){if(typeof a!="function")throw Error(i(191,a));a.call(r)}function sx(a,r){var c=a.callbacks;if(c!==null)for(a.callbacks=null,a=0;a<c.length;a++)ax(c[a],r)}var dl=I(null),pu=I(0);function rx(a,r){a=or,P(pu,a),P(dl,r),or=a|r.baseLanes}function Tm(){P(pu,or),P(dl,dl.current)}function Mm(){or=pu.current,Y(dl),Y(pu)}var Ba=I(null),ns=null;function Rr(a){var r=a.alternate;P(Xn,Xn.current&1),P(Ba,a),ns===null&&(r===null||dl.current!==null||r.memoizedState!==null)&&(ns=a)}function km(a){P(Xn,Xn.current),P(Ba,a),ns===null&&(ns=a)}function ix(a){a.tag===22?(P(Xn,Xn.current),P(Ba,a),ns===null&&(ns=a)):Ir()}function Ir(){P(Xn,Xn.current),P(Ba,Ba.current)}function Ua(a){Y(Ba),ns===a&&(ns=null),Y(Xn)}var Xn=I(0);function yu(a){for(var r=a;r!==null;){if(r.tag===13){var c=r.memoizedState;if(c!==null&&(c=c.dehydrated,c===null||$h(c)||Fh(c)))return r}else if(r.tag===19&&(r.memoizedProps.revealOrder==="forwards"||r.memoizedProps.revealOrder==="backwards"||r.memoizedProps.revealOrder==="unstable_legacy-backwards"||r.memoizedProps.revealOrder==="together")){if((r.flags&128)!==0)return r}else if(r.child!==null){r.child.return=r,r=r.child;continue}if(r===a)break;for(;r.sibling===null;){if(r.return===null||r.return===a)return null;r=r.return}r.sibling.return=r.return,r=r.sibling}return null}var er=0,ln=null,kn=null,Qn=null,gu=!1,fl=!1,ji=!1,bu=0,_o=0,ml=null,RC=0;function Hn(){throw Error(i(321))}function Rm(a,r){if(r===null)return!1;for(var c=0;c<r.length&&c<a.length;c++)if(!Fa(a[c],r[c]))return!1;return!0}function Im(a,r,c,m,x,w){return er=w,ln=r,r.memoizedState=null,r.updateQueue=null,r.lanes=0,D.H=a===null||a.memoizedState===null?Px:Wm,ji=!1,w=c(m,x),ji=!1,fl&&(w=ox(r,c,m,x)),lx(a),w}function lx(a){D.H=To;var r=kn!==null&&kn.next!==null;if(er=0,Qn=kn=ln=null,gu=!1,_o=0,ml=null,r)throw Error(i(300));a===null||Jn||(a=a.dependencies,a!==null&&ou(a)&&(Jn=!0))}function ox(a,r,c,m){ln=a;var x=0;do{if(fl&&(ml=null),_o=0,fl=!1,25<=x)throw Error(i(301));if(x+=1,Qn=kn=null,a.updateQueue!=null){var w=a.updateQueue;w.lastEffect=null,w.events=null,w.stores=null,w.memoCache!=null&&(w.memoCache.index=0)}D.H=Hx,w=r(c,m)}while(fl);return w}function IC(){var a=D.H,r=a.useState()[0];return r=typeof r.then=="function"?Co(r):r,a=a.useState()[0],(kn!==null?kn.memoizedState:null)!==a&&(ln.flags|=1024),r}function Lm(){var a=bu!==0;return bu=0,a}function Dm(a,r,c){r.updateQueue=a.updateQueue,r.flags&=-2053,a.lanes&=~c}function Om(a){if(gu){for(a=a.memoizedState;a!==null;){var r=a.queue;r!==null&&(r.pending=null),a=a.next}gu=!1}er=0,Qn=kn=ln=null,fl=!1,_o=bu=0,ml=null}function ba(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return Qn===null?ln.memoizedState=Qn=a:Qn=Qn.next=a,Qn}function Kn(){if(kn===null){var a=ln.alternate;a=a!==null?a.memoizedState:null}else a=kn.next;var r=Qn===null?ln.memoizedState:Qn.next;if(r!==null)Qn=r,kn=a;else{if(a===null)throw ln.alternate===null?Error(i(467)):Error(i(310));kn=a,a={memoizedState:kn.memoizedState,baseState:kn.baseState,baseQueue:kn.baseQueue,queue:kn.queue,next:null},Qn===null?ln.memoizedState=Qn=a:Qn=Qn.next=a}return Qn}function xu(){return{lastEffect:null,events:null,stores:null,memoCache:null}}function Co(a){var r=_o;return _o+=1,ml===null&&(ml=[]),a=Qb(ml,a,r),r=ln,(Qn===null?r.memoizedState:Qn.next)===null&&(r=r.alternate,D.H=r===null||r.memoizedState===null?Px:Wm),a}function vu(a){if(a!==null&&typeof a=="object"){if(typeof a.then=="function")return Co(a);if(a.$$typeof===M)return ua(a)}throw Error(i(438,String(a)))}function $m(a){var r=null,c=ln.updateQueue;if(c!==null&&(r=c.memoCache),r==null){var m=ln.alternate;m!==null&&(m=m.updateQueue,m!==null&&(m=m.memoCache,m!=null&&(r={data:m.data.map(function(x){return x.slice()}),index:0})))}if(r==null&&(r={data:[],index:0}),c===null&&(c=xu(),ln.updateQueue=c),c.memoCache=r,c=r.data[r.index],c===void 0)for(c=r.data[r.index]=Array(a),m=0;m<a;m++)c[m]=G;return r.index++,c}function tr(a,r){return typeof r=="function"?r(a):r}function Su(a){var r=Kn();return Fm(r,kn,a)}function Fm(a,r,c){var m=a.queue;if(m===null)throw Error(i(311));m.lastRenderedReducer=c;var x=a.baseQueue,w=m.pending;if(w!==null){if(x!==null){var q=x.next;x.next=w.next,w.next=q}r.baseQueue=x=w,m.pending=null}if(w=a.baseState,x===null)a.memoizedState=w;else{r=x.next;var ne=q=null,Ae=null,et=r,yt=!1;do{var wt=et.lane&-536870913;if(wt!==et.lane?(xn&wt)===wt:(er&wt)===wt){var at=et.revertLane;if(at===0)Ae!==null&&(Ae=Ae.next={lane:0,revertLane:0,gesture:null,action:et.action,hasEagerState:et.hasEagerState,eagerState:et.eagerState,next:null}),wt===ll&&(yt=!0);else if((er&at)===at){et=et.next,at===ll&&(yt=!0);continue}else wt={lane:0,revertLane:et.revertLane,gesture:null,action:et.action,hasEagerState:et.hasEagerState,eagerState:et.eagerState,next:null},Ae===null?(ne=Ae=wt,q=w):Ae=Ae.next=wt,ln.lanes|=at,Or|=at;wt=et.action,ji&&c(w,wt),w=et.hasEagerState?et.eagerState:c(w,wt)}else at={lane:wt,revertLane:et.revertLane,gesture:et.gesture,action:et.action,hasEagerState:et.hasEagerState,eagerState:et.eagerState,next:null},Ae===null?(ne=Ae=at,q=w):Ae=Ae.next=at,ln.lanes|=wt,Or|=wt;et=et.next}while(et!==null&&et!==r);if(Ae===null?q=w:Ae.next=ne,!Fa(w,a.memoizedState)&&(Jn=!0,yt&&(c=ol,c!==null)))throw c;a.memoizedState=w,a.baseState=q,a.baseQueue=Ae,m.lastRenderedState=w}return x===null&&(m.lanes=0),[a.memoizedState,m.dispatch]}function zm(a){var r=Kn(),c=r.queue;if(c===null)throw Error(i(311));c.lastRenderedReducer=a;var m=c.dispatch,x=c.pending,w=r.memoizedState;if(x!==null){c.pending=null;var q=x=x.next;do w=a(w,q.action),q=q.next;while(q!==x);Fa(w,r.memoizedState)||(Jn=!0),r.memoizedState=w,r.baseQueue===null&&(r.baseState=w),c.lastRenderedState=w}return[w,m]}function cx(a,r,c){var m=ln,x=Kn(),w=Sn;if(w){if(c===void 0)throw Error(i(407));c=c()}else c=r();var q=!Fa((kn||x).memoizedState,c);if(q&&(x.memoizedState=c,Jn=!0),x=x.queue,qm(fx.bind(null,m,x,a),[a]),x.getSnapshot!==r||q||Qn!==null&&Qn.memoizedState.tag&1){if(m.flags|=2048,hl(9,{destroy:void 0},dx.bind(null,m,x,c,r),null),Ln===null)throw Error(i(349));w||(er&127)!==0||ux(m,r,c)}return c}function ux(a,r,c){a.flags|=16384,a={getSnapshot:r,value:c},r=ln.updateQueue,r===null?(r=xu(),ln.updateQueue=r,r.stores=[a]):(c=r.stores,c===null?r.stores=[a]:c.push(a))}function dx(a,r,c,m){r.value=c,r.getSnapshot=m,mx(r)&&hx(a)}function fx(a,r,c){return c(function(){mx(r)&&hx(a)})}function mx(a){var r=a.getSnapshot;a=a.value;try{var c=r();return!Fa(a,c)}catch{return!0}}function hx(a){var r=pi(a,2);r!==null&&Ra(r,a,2)}function Bm(a){var r=ba();if(typeof a=="function"){var c=a;if(a=c(),ji){Be(!0);try{c()}finally{Be(!1)}}}return r.memoizedState=r.baseState=a,r.queue={pending:null,lanes:0,dispatch:null,lastRenderedReducer:tr,lastRenderedState:a},r}function px(a,r,c,m){return a.baseState=c,Fm(a,kn,typeof m=="function"?m:tr)}function LC(a,r,c,m,x){if(ju(a))throw Error(i(485));if(a=r.action,a!==null){var w={payload:x,action:a,next:null,isTransition:!0,status:"pending",value:null,reason:null,listeners:[],then:function(q){w.listeners.push(q)}};D.T!==null?c(!0):w.isTransition=!1,m(w),c=r.pending,c===null?(w.next=r.pending=w,yx(r,w)):(w.next=c.next,r.pending=c.next=w)}}function yx(a,r){var c=r.action,m=r.payload,x=a.state;if(r.isTransition){var w=D.T,q={};D.T=q;try{var ne=c(x,m),Ae=D.S;Ae!==null&&Ae(q,ne),gx(a,r,ne)}catch(et){Um(a,r,et)}finally{w!==null&&q.types!==null&&(w.types=q.types),D.T=w}}else try{w=c(x,m),gx(a,r,w)}catch(et){Um(a,r,et)}}function gx(a,r,c){c!==null&&typeof c=="object"&&typeof c.then=="function"?c.then(function(m){bx(a,r,m)},function(m){return Um(a,r,m)}):bx(a,r,c)}function bx(a,r,c){r.status="fulfilled",r.value=c,xx(r),a.state=c,r=a.pending,r!==null&&(c=r.next,c===r?a.pending=null:(c=c.next,r.next=c,yx(a,c)))}function Um(a,r,c){var m=a.pending;if(a.pending=null,m!==null){m=m.next;do r.status="rejected",r.reason=c,xx(r),r=r.next;while(r!==m)}a.action=null}function xx(a){a=a.listeners;for(var r=0;r<a.length;r++)(0,a[r])()}function vx(a,r){return r}function Sx(a,r){if(Sn){var c=Ln.formState;if(c!==null){e:{var m=ln;if(Sn){if(On){t:{for(var x=On,w=ts;x.nodeType!==8;){if(!w){x=null;break t}if(x=as(x.nextSibling),x===null){x=null;break t}}w=x.data,x=w==="F!"||w==="F"?x:null}if(x){On=as(x.nextSibling),m=x.data==="F!";break e}}Cr(m)}m=!1}m&&(r=c[0])}}return c=ba(),c.memoizedState=c.baseState=r,m={pending:null,lanes:0,dispatch:null,lastRenderedReducer:vx,lastRenderedState:r},c.queue=m,c=Bx.bind(null,ln,m),m.dispatch=c,m=Bm(!1),w=Gm.bind(null,ln,!1,m.queue),m=ba(),x={state:r,dispatch:null,action:a,pending:null},m.queue=x,c=LC.bind(null,ln,x,w,c),x.dispatch=c,m.memoizedState=a,[r,c,!1]}function wx(a){var r=Kn();return Nx(r,kn,a)}function Nx(a,r,c){if(r=Fm(a,r,vx)[0],a=Su(tr)[0],typeof r=="object"&&r!==null&&typeof r.then=="function")try{var m=Co(r)}catch(q){throw q===cl?du:q}else m=r;r=Kn();var x=r.queue,w=x.dispatch;return c!==r.memoizedState&&(ln.flags|=2048,hl(9,{destroy:void 0},DC.bind(null,x,c),null)),[m,w,a]}function DC(a,r){a.action=r}function jx(a){var r=Kn(),c=kn;if(c!==null)return Nx(r,c,a);Kn(),r=r.memoizedState,c=Kn();var m=c.queue.dispatch;return c.memoizedState=a,[r,m,!1]}function hl(a,r,c,m){return a={tag:a,create:c,deps:m,inst:r,next:null},r=ln.updateQueue,r===null&&(r=xu(),ln.updateQueue=r),c=r.lastEffect,c===null?r.lastEffect=a.next=a:(m=c.next,c.next=a,a.next=m,r.lastEffect=a),a}function Ex(){return Kn().memoizedState}function wu(a,r,c,m){var x=ba();ln.flags|=a,x.memoizedState=hl(1|r,{destroy:void 0},c,m===void 0?null:m)}function Nu(a,r,c,m){var x=Kn();m=m===void 0?null:m;var w=x.memoizedState.inst;kn!==null&&m!==null&&Rm(m,kn.memoizedState.deps)?x.memoizedState=hl(r,w,c,m):(ln.flags|=a,x.memoizedState=hl(1|r,w,c,m))}function _x(a,r){wu(8390656,8,a,r)}function qm(a,r){Nu(2048,8,a,r)}function OC(a){ln.flags|=4;var r=ln.updateQueue;if(r===null)r=xu(),ln.updateQueue=r,r.events=[a];else{var c=r.events;c===null?r.events=[a]:c.push(a)}}function Cx(a){var r=Kn().memoizedState;return OC({ref:r,nextImpl:a}),function(){if((En&2)!==0)throw Error(i(440));return r.impl.apply(void 0,arguments)}}function Ax(a,r){return Nu(4,2,a,r)}function Tx(a,r){return Nu(4,4,a,r)}function Mx(a,r){if(typeof r=="function"){a=a();var c=r(a);return function(){typeof c=="function"?c():r(null)}}if(r!=null)return a=a(),r.current=a,function(){r.current=null}}function kx(a,r,c){c=c!=null?c.concat([a]):null,Nu(4,4,Mx.bind(null,r,a),c)}function Pm(){}function Rx(a,r){var c=Kn();r=r===void 0?null:r;var m=c.memoizedState;return r!==null&&Rm(r,m[1])?m[0]:(c.memoizedState=[a,r],a)}function Ix(a,r){var c=Kn();r=r===void 0?null:r;var m=c.memoizedState;if(r!==null&&Rm(r,m[1]))return m[0];if(m=a(),ji){Be(!0);try{a()}finally{Be(!1)}}return c.memoizedState=[m,r],m}function Hm(a,r,c){return c===void 0||(er&1073741824)!==0&&(xn&261930)===0?a.memoizedState=r:(a.memoizedState=c,a=Lv(),ln.lanes|=a,Or|=a,c)}function Lx(a,r,c,m){return Fa(c,r)?c:dl.current!==null?(a=Hm(a,c,m),Fa(a,r)||(Jn=!0),a):(er&42)===0||(er&1073741824)!==0&&(xn&261930)===0?(Jn=!0,a.memoizedState=c):(a=Lv(),ln.lanes|=a,Or|=a,r)}function Dx(a,r,c,m,x){var w=O.p;O.p=w!==0&&8>w?w:8;var q=D.T,ne={};D.T=ne,Gm(a,!1,r,c);try{var Ae=x(),et=D.S;if(et!==null&&et(ne,Ae),Ae!==null&&typeof Ae=="object"&&typeof Ae.then=="function"){var yt=kC(Ae,m);Ao(a,r,yt,Ha(a))}else Ao(a,r,m,Ha(a))}catch(wt){Ao(a,r,{then:function(){},status:"rejected",reason:wt},Ha())}finally{O.p=w,q!==null&&ne.types!==null&&(q.types=ne.types),D.T=q}}function $C(){}function Vm(a,r,c,m){if(a.tag!==5)throw Error(i(476));var x=Ox(a).queue;Dx(a,x,r,$,c===null?$C:function(){return $x(a),c(m)})}function Ox(a){var r=a.memoizedState;if(r!==null)return r;r={memoizedState:$,baseState:$,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:tr,lastRenderedState:$},next:null};var c={};return r.next={memoizedState:c,baseState:c,baseQueue:null,queue:{pending:null,lanes:0,dispatch:null,lastRenderedReducer:tr,lastRenderedState:c},next:null},a.memoizedState=r,a=a.alternate,a!==null&&(a.memoizedState=r),r}function $x(a){var r=Ox(a);r.next===null&&(r=a.alternate.memoizedState),Ao(a,r.next.queue,{},Ha())}function Ym(){return ua(Vo)}function Fx(){return Kn().memoizedState}function zx(){return Kn().memoizedState}function FC(a){for(var r=a.return;r!==null;){switch(r.tag){case 24:case 3:var c=Ha();a=Mr(c);var m=kr(r,a,c);m!==null&&(Ra(m,r,c),No(m,r,c)),r={cache:Sm()},a.payload=r;return}r=r.return}}function zC(a,r,c){var m=Ha();c={lane:m,revertLane:0,gesture:null,action:c,hasEagerState:!1,eagerState:null,next:null},ju(a)?Ux(r,c):(c=um(a,r,c,m),c!==null&&(Ra(c,a,m),qx(c,r,m)))}function Bx(a,r,c){var m=Ha();Ao(a,r,c,m)}function Ao(a,r,c,m){var x={lane:m,revertLane:0,gesture:null,action:c,hasEagerState:!1,eagerState:null,next:null};if(ju(a))Ux(r,x);else{var w=a.alternate;if(a.lanes===0&&(w===null||w.lanes===0)&&(w=r.lastRenderedReducer,w!==null))try{var q=r.lastRenderedState,ne=w(q,c);if(x.hasEagerState=!0,x.eagerState=ne,Fa(ne,q))return su(a,r,x,0),Ln===null&&au(),!1}catch{}finally{}if(c=um(a,r,x,m),c!==null)return Ra(c,a,m),qx(c,r,m),!0}return!1}function Gm(a,r,c,m){if(m={lane:2,revertLane:Eh(),gesture:null,action:m,hasEagerState:!1,eagerState:null,next:null},ju(a)){if(r)throw Error(i(479))}else r=um(a,c,m,2),r!==null&&Ra(r,a,2)}function ju(a){var r=a.alternate;return a===ln||r!==null&&r===ln}function Ux(a,r){fl=gu=!0;var c=a.pending;c===null?r.next=r:(r.next=c.next,c.next=r),a.pending=r}function qx(a,r,c){if((c&4194048)!==0){var m=r.lanes;m&=a.pendingLanes,c|=m,r.lanes=c,Ve(a,c)}}var To={readContext:ua,use:vu,useCallback:Hn,useContext:Hn,useEffect:Hn,useImperativeHandle:Hn,useLayoutEffect:Hn,useInsertionEffect:Hn,useMemo:Hn,useReducer:Hn,useRef:Hn,useState:Hn,useDebugValue:Hn,useDeferredValue:Hn,useTransition:Hn,useSyncExternalStore:Hn,useId:Hn,useHostTransitionStatus:Hn,useFormState:Hn,useActionState:Hn,useOptimistic:Hn,useMemoCache:Hn,useCacheRefresh:Hn};To.useEffectEvent=Hn;var Px={readContext:ua,use:vu,useCallback:function(a,r){return ba().memoizedState=[a,r===void 0?null:r],a},useContext:ua,useEffect:_x,useImperativeHandle:function(a,r,c){c=c!=null?c.concat([a]):null,wu(4194308,4,Mx.bind(null,r,a),c)},useLayoutEffect:function(a,r){return wu(4194308,4,a,r)},useInsertionEffect:function(a,r){wu(4,2,a,r)},useMemo:function(a,r){var c=ba();r=r===void 0?null:r;var m=a();if(ji){Be(!0);try{a()}finally{Be(!1)}}return c.memoizedState=[m,r],m},useReducer:function(a,r,c){var m=ba();if(c!==void 0){var x=c(r);if(ji){Be(!0);try{c(r)}finally{Be(!1)}}}else x=r;return m.memoizedState=m.baseState=x,a={pending:null,lanes:0,dispatch:null,lastRenderedReducer:a,lastRenderedState:x},m.queue=a,a=a.dispatch=zC.bind(null,ln,a),[m.memoizedState,a]},useRef:function(a){var r=ba();return a={current:a},r.memoizedState=a},useState:function(a){a=Bm(a);var r=a.queue,c=Bx.bind(null,ln,r);return r.dispatch=c,[a.memoizedState,c]},useDebugValue:Pm,useDeferredValue:function(a,r){var c=ba();return Hm(c,a,r)},useTransition:function(){var a=Bm(!1);return a=Dx.bind(null,ln,a.queue,!0,!1),ba().memoizedState=a,[!1,a]},useSyncExternalStore:function(a,r,c){var m=ln,x=ba();if(Sn){if(c===void 0)throw Error(i(407));c=c()}else{if(c=r(),Ln===null)throw Error(i(349));(xn&127)!==0||ux(m,r,c)}x.memoizedState=c;var w={value:c,getSnapshot:r};return x.queue=w,_x(fx.bind(null,m,w,a),[a]),m.flags|=2048,hl(9,{destroy:void 0},dx.bind(null,m,w,c,r),null),c},useId:function(){var a=ba(),r=Ln.identifierPrefix;if(Sn){var c=Is,m=Rs;c=(m&~(1<<32-Te(m)-1)).toString(32)+c,r="_"+r+"R_"+c,c=bu++,0<c&&(r+="H"+c.toString(32)),r+="_"}else c=RC++,r="_"+r+"r_"+c.toString(32)+"_";return a.memoizedState=r},useHostTransitionStatus:Ym,useFormState:Sx,useActionState:Sx,useOptimistic:function(a){var r=ba();r.memoizedState=r.baseState=a;var c={pending:null,lanes:0,dispatch:null,lastRenderedReducer:null,lastRenderedState:null};return r.queue=c,r=Gm.bind(null,ln,!0,c),c.dispatch=r,[a,r]},useMemoCache:$m,useCacheRefresh:function(){return ba().memoizedState=FC.bind(null,ln)},useEffectEvent:function(a){var r=ba(),c={impl:a};return r.memoizedState=c,function(){if((En&2)!==0)throw Error(i(440));return c.impl.apply(void 0,arguments)}}},Wm={readContext:ua,use:vu,useCallback:Rx,useContext:ua,useEffect:qm,useImperativeHandle:kx,useInsertionEffect:Ax,useLayoutEffect:Tx,useMemo:Ix,useReducer:Su,useRef:Ex,useState:function(){return Su(tr)},useDebugValue:Pm,useDeferredValue:function(a,r){var c=Kn();return Lx(c,kn.memoizedState,a,r)},useTransition:function(){var a=Su(tr)[0],r=Kn().memoizedState;return[typeof a=="boolean"?a:Co(a),r]},useSyncExternalStore:cx,useId:Fx,useHostTransitionStatus:Ym,useFormState:wx,useActionState:wx,useOptimistic:function(a,r){var c=Kn();return px(c,kn,a,r)},useMemoCache:$m,useCacheRefresh:zx};Wm.useEffectEvent=Cx;var Hx={readContext:ua,use:vu,useCallback:Rx,useContext:ua,useEffect:qm,useImperativeHandle:kx,useInsertionEffect:Ax,useLayoutEffect:Tx,useMemo:Ix,useReducer:zm,useRef:Ex,useState:function(){return zm(tr)},useDebugValue:Pm,useDeferredValue:function(a,r){var c=Kn();return kn===null?Hm(c,a,r):Lx(c,kn.memoizedState,a,r)},useTransition:function(){var a=zm(tr)[0],r=Kn().memoizedState;return[typeof a=="boolean"?a:Co(a),r]},useSyncExternalStore:cx,useId:Fx,useHostTransitionStatus:Ym,useFormState:jx,useActionState:jx,useOptimistic:function(a,r){var c=Kn();return kn!==null?px(c,kn,a,r):(c.baseState=a,[a,c.queue.dispatch])},useMemoCache:$m,useCacheRefresh:zx};Hx.useEffectEvent=Cx;function Xm(a,r,c,m){r=a.memoizedState,c=c(m,r),c=c==null?r:g({},r,c),a.memoizedState=c,a.lanes===0&&(a.updateQueue.baseState=c)}var Km={enqueueSetState:function(a,r,c){a=a._reactInternals;var m=Ha(),x=Mr(m);x.payload=r,c!=null&&(x.callback=c),r=kr(a,x,m),r!==null&&(Ra(r,a,m),No(r,a,m))},enqueueReplaceState:function(a,r,c){a=a._reactInternals;var m=Ha(),x=Mr(m);x.tag=1,x.payload=r,c!=null&&(x.callback=c),r=kr(a,x,m),r!==null&&(Ra(r,a,m),No(r,a,m))},enqueueForceUpdate:function(a,r){a=a._reactInternals;var c=Ha(),m=Mr(c);m.tag=2,r!=null&&(m.callback=r),r=kr(a,m,c),r!==null&&(Ra(r,a,c),No(r,a,c))}};function Vx(a,r,c,m,x,w,q){return a=a.stateNode,typeof a.shouldComponentUpdate=="function"?a.shouldComponentUpdate(m,w,q):r.prototype&&r.prototype.isPureReactComponent?!po(c,m)||!po(x,w):!0}function Yx(a,r,c,m){a=r.state,typeof r.componentWillReceiveProps=="function"&&r.componentWillReceiveProps(c,m),typeof r.UNSAFE_componentWillReceiveProps=="function"&&r.UNSAFE_componentWillReceiveProps(c,m),r.state!==a&&Km.enqueueReplaceState(r,r.state,null)}function Ei(a,r){var c=r;if("ref"in r){c={};for(var m in r)m!=="ref"&&(c[m]=r[m])}if(a=a.defaultProps){c===r&&(c=g({},c));for(var x in a)c[x]===void 0&&(c[x]=a[x])}return c}function Gx(a){nu(a)}function Wx(a){console.error(a)}function Xx(a){nu(a)}function Eu(a,r){try{var c=a.onUncaughtError;c(r.value,{componentStack:r.stack})}catch(m){setTimeout(function(){throw m})}}function Kx(a,r,c){try{var m=a.onCaughtError;m(c.value,{componentStack:c.stack,errorBoundary:r.tag===1?r.stateNode:null})}catch(x){setTimeout(function(){throw x})}}function Zm(a,r,c){return c=Mr(c),c.tag=3,c.payload={element:null},c.callback=function(){Eu(a,r)},c}function Zx(a){return a=Mr(a),a.tag=3,a}function Qx(a,r,c,m){var x=c.type.getDerivedStateFromError;if(typeof x=="function"){var w=m.value;a.payload=function(){return x(w)},a.callback=function(){Kx(r,c,m)}}var q=c.stateNode;q!==null&&typeof q.componentDidCatch=="function"&&(a.callback=function(){Kx(r,c,m),typeof x!="function"&&($r===null?$r=new Set([this]):$r.add(this));var ne=m.stack;this.componentDidCatch(m.value,{componentStack:ne!==null?ne:""})})}function BC(a,r,c,m,x){if(c.flags|=32768,m!==null&&typeof m=="object"&&typeof m.then=="function"){if(r=c.alternate,r!==null&&il(r,c,x,!0),c=Ba.current,c!==null){switch(c.tag){case 31:case 13:return ns===null?$u():c.alternate===null&&Vn===0&&(Vn=3),c.flags&=-257,c.flags|=65536,c.lanes=x,m===fu?c.flags|=16384:(r=c.updateQueue,r===null?c.updateQueue=new Set([m]):r.add(m),wh(a,m,x)),!1;case 22:return c.flags|=65536,m===fu?c.flags|=16384:(r=c.updateQueue,r===null?(r={transitions:null,markerInstances:null,retryQueue:new Set([m])},c.updateQueue=r):(c=r.retryQueue,c===null?r.retryQueue=new Set([m]):c.add(m)),wh(a,m,x)),!1}throw Error(i(435,c.tag))}return wh(a,m,x),$u(),!1}if(Sn)return r=Ba.current,r!==null?((r.flags&65536)===0&&(r.flags|=256),r.flags|=65536,r.lanes=x,m!==ym&&(a=Error(i(422),{cause:m}),bo(Qa(a,c)))):(m!==ym&&(r=Error(i(423),{cause:m}),bo(Qa(r,c))),a=a.current.alternate,a.flags|=65536,x&=-x,a.lanes|=x,m=Qa(m,c),x=Zm(a.stateNode,m,x),Cm(a,x),Vn!==4&&(Vn=2)),!1;var w=Error(i(520),{cause:m});if(w=Qa(w,c),$o===null?$o=[w]:$o.push(w),Vn!==4&&(Vn=2),r===null)return!0;m=Qa(m,c),c=r;do{switch(c.tag){case 3:return c.flags|=65536,a=x&-x,c.lanes|=a,a=Zm(c.stateNode,m,a),Cm(c,a),!1;case 1:if(r=c.type,w=c.stateNode,(c.flags&128)===0&&(typeof r.getDerivedStateFromError=="function"||w!==null&&typeof w.componentDidCatch=="function"&&($r===null||!$r.has(w))))return c.flags|=65536,x&=-x,c.lanes|=x,x=Zx(x),Qx(x,a,c,m),Cm(c,x),!1}c=c.return}while(c!==null);return!1}var Qm=Error(i(461)),Jn=!1;function da(a,r,c,m){r.child=a===null?nx(r,null,c,m):Ni(r,a.child,c,m)}function Jx(a,r,c,m,x){c=c.render;var w=r.ref;if("ref"in m){var q={};for(var ne in m)ne!=="ref"&&(q[ne]=m[ne])}else q=m;return xi(r),m=Im(a,r,c,q,w,x),ne=Lm(),a!==null&&!Jn?(Dm(a,r,x),nr(a,r,x)):(Sn&&ne&&hm(r),r.flags|=1,da(a,r,m,x),r.child)}function ev(a,r,c,m,x){if(a===null){var w=c.type;return typeof w=="function"&&!dm(w)&&w.defaultProps===void 0&&c.compare===null?(r.tag=15,r.type=w,tv(a,r,w,m,x)):(a=iu(c.type,null,m,r,r.mode,x),a.ref=r.ref,a.return=r,r.child=a)}if(w=a.child,!ih(a,x)){var q=w.memoizedProps;if(c=c.compare,c=c!==null?c:po,c(q,m)&&a.ref===r.ref)return nr(a,r,x)}return r.flags|=1,a=Ks(w,m),a.ref=r.ref,a.return=r,r.child=a}function tv(a,r,c,m,x){if(a!==null){var w=a.memoizedProps;if(po(w,m)&&a.ref===r.ref)if(Jn=!1,r.pendingProps=m=w,ih(a,x))(a.flags&131072)!==0&&(Jn=!0);else return r.lanes=a.lanes,nr(a,r,x)}return Jm(a,r,c,m,x)}function nv(a,r,c,m){var x=m.children,w=a!==null?a.memoizedState:null;if(a===null&&r.stateNode===null&&(r.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),m.mode==="hidden"){if((r.flags&128)!==0){if(w=w!==null?w.baseLanes|c:c,a!==null){for(m=r.child=a.child,x=0;m!==null;)x=x|m.lanes|m.childLanes,m=m.sibling;m=x&~w}else m=0,r.child=null;return av(a,r,w,c,m)}if((c&536870912)!==0)r.memoizedState={baseLanes:0,cachePool:null},a!==null&&uu(r,w!==null?w.cachePool:null),w!==null?rx(r,w):Tm(),ix(r);else return m=r.lanes=536870912,av(a,r,w!==null?w.baseLanes|c:c,c,m)}else w!==null?(uu(r,w.cachePool),rx(r,w),Ir(),r.memoizedState=null):(a!==null&&uu(r,null),Tm(),Ir());return da(a,r,x,c),r.child}function Mo(a,r){return a!==null&&a.tag===22||r.stateNode!==null||(r.stateNode={_visibility:1,_pendingMarkers:null,_retryCache:null,_transitions:null}),r.sibling}function av(a,r,c,m,x){var w=Nm();return w=w===null?null:{parent:Zn._currentValue,pool:w},r.memoizedState={baseLanes:c,cachePool:w},a!==null&&uu(r,null),Tm(),ix(r),a!==null&&il(a,r,m,!0),r.childLanes=x,null}function _u(a,r){return r=Au({mode:r.mode,children:r.children},a.mode),r.ref=a.ref,a.child=r,r.return=a,r}function sv(a,r,c){return Ni(r,a.child,null,c),a=_u(r,r.pendingProps),a.flags|=2,Ua(r),r.memoizedState=null,a}function UC(a,r,c){var m=r.pendingProps,x=(r.flags&128)!==0;if(r.flags&=-129,a===null){if(Sn){if(m.mode==="hidden")return a=_u(r,m),r.lanes=536870912,Mo(null,a);if(km(r),(a=On)?(a=y0(a,ts),a=a!==null&&a.data==="&"?a:null,a!==null&&(r.memoizedState={dehydrated:a,treeContext:Er!==null?{id:Rs,overflow:Is}:null,retryLane:536870912,hydrationErrors:null},c=Ub(a),c.return=r,r.child=c,ca=r,On=null)):a=null,a===null)throw Cr(r);return r.lanes=536870912,null}return _u(r,m)}var w=a.memoizedState;if(w!==null){var q=w.dehydrated;if(km(r),x)if(r.flags&256)r.flags&=-257,r=sv(a,r,c);else if(r.memoizedState!==null)r.child=a.child,r.flags|=128,r=null;else throw Error(i(558));else if(Jn||il(a,r,c,!1),x=(c&a.childLanes)!==0,Jn||x){if(m=Ln,m!==null&&(q=xe(m,c),q!==0&&q!==w.retryLane))throw w.retryLane=q,pi(a,q),Ra(m,a,q),Qm;$u(),r=sv(a,r,c)}else a=w.treeContext,On=as(q.nextSibling),ca=r,Sn=!0,_r=null,ts=!1,a!==null&&Hb(r,a),r=_u(r,m),r.flags|=4096;return r}return a=Ks(a.child,{mode:m.mode,children:m.children}),a.ref=r.ref,r.child=a,a.return=r,a}function Cu(a,r){var c=r.ref;if(c===null)a!==null&&a.ref!==null&&(r.flags|=4194816);else{if(typeof c!="function"&&typeof c!="object")throw Error(i(284));(a===null||a.ref!==c)&&(r.flags|=4194816)}}function Jm(a,r,c,m,x){return xi(r),c=Im(a,r,c,m,void 0,x),m=Lm(),a!==null&&!Jn?(Dm(a,r,x),nr(a,r,x)):(Sn&&m&&hm(r),r.flags|=1,da(a,r,c,x),r.child)}function rv(a,r,c,m,x,w){return xi(r),r.updateQueue=null,c=ox(r,m,c,x),lx(a),m=Lm(),a!==null&&!Jn?(Dm(a,r,w),nr(a,r,w)):(Sn&&m&&hm(r),r.flags|=1,da(a,r,c,w),r.child)}function iv(a,r,c,m,x){if(xi(r),r.stateNode===null){var w=nl,q=c.contextType;typeof q=="object"&&q!==null&&(w=ua(q)),w=new c(m,w),r.memoizedState=w.state!==null&&w.state!==void 0?w.state:null,w.updater=Km,r.stateNode=w,w._reactInternals=r,w=r.stateNode,w.props=m,w.state=r.memoizedState,w.refs={},Em(r),q=c.contextType,w.context=typeof q=="object"&&q!==null?ua(q):nl,w.state=r.memoizedState,q=c.getDerivedStateFromProps,typeof q=="function"&&(Xm(r,c,q,m),w.state=r.memoizedState),typeof c.getDerivedStateFromProps=="function"||typeof w.getSnapshotBeforeUpdate=="function"||typeof w.UNSAFE_componentWillMount!="function"&&typeof w.componentWillMount!="function"||(q=w.state,typeof w.componentWillMount=="function"&&w.componentWillMount(),typeof w.UNSAFE_componentWillMount=="function"&&w.UNSAFE_componentWillMount(),q!==w.state&&Km.enqueueReplaceState(w,w.state,null),Eo(r,m,w,x),jo(),w.state=r.memoizedState),typeof w.componentDidMount=="function"&&(r.flags|=4194308),m=!0}else if(a===null){w=r.stateNode;var ne=r.memoizedProps,Ae=Ei(c,ne);w.props=Ae;var et=w.context,yt=c.contextType;q=nl,typeof yt=="object"&&yt!==null&&(q=ua(yt));var wt=c.getDerivedStateFromProps;yt=typeof wt=="function"||typeof w.getSnapshotBeforeUpdate=="function",ne=r.pendingProps!==ne,yt||typeof w.UNSAFE_componentWillReceiveProps!="function"&&typeof w.componentWillReceiveProps!="function"||(ne||et!==q)&&Yx(r,w,m,q),Tr=!1;var at=r.memoizedState;w.state=at,Eo(r,m,w,x),jo(),et=r.memoizedState,ne||at!==et||Tr?(typeof wt=="function"&&(Xm(r,c,wt,m),et=r.memoizedState),(Ae=Tr||Vx(r,c,Ae,m,at,et,q))?(yt||typeof w.UNSAFE_componentWillMount!="function"&&typeof w.componentWillMount!="function"||(typeof w.componentWillMount=="function"&&w.componentWillMount(),typeof w.UNSAFE_componentWillMount=="function"&&w.UNSAFE_componentWillMount()),typeof w.componentDidMount=="function"&&(r.flags|=4194308)):(typeof w.componentDidMount=="function"&&(r.flags|=4194308),r.memoizedProps=m,r.memoizedState=et),w.props=m,w.state=et,w.context=q,m=Ae):(typeof w.componentDidMount=="function"&&(r.flags|=4194308),m=!1)}else{w=r.stateNode,_m(a,r),q=r.memoizedProps,yt=Ei(c,q),w.props=yt,wt=r.pendingProps,at=w.context,et=c.contextType,Ae=nl,typeof et=="object"&&et!==null&&(Ae=ua(et)),ne=c.getDerivedStateFromProps,(et=typeof ne=="function"||typeof w.getSnapshotBeforeUpdate=="function")||typeof w.UNSAFE_componentWillReceiveProps!="function"&&typeof w.componentWillReceiveProps!="function"||(q!==wt||at!==Ae)&&Yx(r,w,m,Ae),Tr=!1,at=r.memoizedState,w.state=at,Eo(r,m,w,x),jo();var ut=r.memoizedState;q!==wt||at!==ut||Tr||a!==null&&a.dependencies!==null&&ou(a.dependencies)?(typeof ne=="function"&&(Xm(r,c,ne,m),ut=r.memoizedState),(yt=Tr||Vx(r,c,yt,m,at,ut,Ae)||a!==null&&a.dependencies!==null&&ou(a.dependencies))?(et||typeof w.UNSAFE_componentWillUpdate!="function"&&typeof w.componentWillUpdate!="function"||(typeof w.componentWillUpdate=="function"&&w.componentWillUpdate(m,ut,Ae),typeof w.UNSAFE_componentWillUpdate=="function"&&w.UNSAFE_componentWillUpdate(m,ut,Ae)),typeof w.componentDidUpdate=="function"&&(r.flags|=4),typeof w.getSnapshotBeforeUpdate=="function"&&(r.flags|=1024)):(typeof w.componentDidUpdate!="function"||q===a.memoizedProps&&at===a.memoizedState||(r.flags|=4),typeof w.getSnapshotBeforeUpdate!="function"||q===a.memoizedProps&&at===a.memoizedState||(r.flags|=1024),r.memoizedProps=m,r.memoizedState=ut),w.props=m,w.state=ut,w.context=Ae,m=yt):(typeof w.componentDidUpdate!="function"||q===a.memoizedProps&&at===a.memoizedState||(r.flags|=4),typeof w.getSnapshotBeforeUpdate!="function"||q===a.memoizedProps&&at===a.memoizedState||(r.flags|=1024),m=!1)}return w=m,Cu(a,r),m=(r.flags&128)!==0,w||m?(w=r.stateNode,c=m&&typeof c.getDerivedStateFromError!="function"?null:w.render(),r.flags|=1,a!==null&&m?(r.child=Ni(r,a.child,null,x),r.child=Ni(r,null,c,x)):da(a,r,c,x),r.memoizedState=w.state,a=r.child):a=nr(a,r,x),a}function lv(a,r,c,m){return gi(),r.flags|=256,da(a,r,c,m),r.child}var eh={dehydrated:null,treeContext:null,retryLane:0,hydrationErrors:null};function th(a){return{baseLanes:a,cachePool:Kb()}}function nh(a,r,c){return a=a!==null?a.childLanes&~c:0,r&&(a|=Pa),a}function ov(a,r,c){var m=r.pendingProps,x=!1,w=(r.flags&128)!==0,q;if((q=w)||(q=a!==null&&a.memoizedState===null?!1:(Xn.current&2)!==0),q&&(x=!0,r.flags&=-129),q=(r.flags&32)!==0,r.flags&=-33,a===null){if(Sn){if(x?Rr(r):Ir(),(a=On)?(a=y0(a,ts),a=a!==null&&a.data!=="&"?a:null,a!==null&&(r.memoizedState={dehydrated:a,treeContext:Er!==null?{id:Rs,overflow:Is}:null,retryLane:536870912,hydrationErrors:null},c=Ub(a),c.return=r,r.child=c,ca=r,On=null)):a=null,a===null)throw Cr(r);return Fh(a)?r.lanes=32:r.lanes=536870912,null}var ne=m.children;return m=m.fallback,x?(Ir(),x=r.mode,ne=Au({mode:"hidden",children:ne},x),m=yi(m,x,c,null),ne.return=r,m.return=r,ne.sibling=m,r.child=ne,m=r.child,m.memoizedState=th(c),m.childLanes=nh(a,q,c),r.memoizedState=eh,Mo(null,m)):(Rr(r),ah(r,ne))}var Ae=a.memoizedState;if(Ae!==null&&(ne=Ae.dehydrated,ne!==null)){if(w)r.flags&256?(Rr(r),r.flags&=-257,r=sh(a,r,c)):r.memoizedState!==null?(Ir(),r.child=a.child,r.flags|=128,r=null):(Ir(),ne=m.fallback,x=r.mode,m=Au({mode:"visible",children:m.children},x),ne=yi(ne,x,c,null),ne.flags|=2,m.return=r,ne.return=r,m.sibling=ne,r.child=m,Ni(r,a.child,null,c),m=r.child,m.memoizedState=th(c),m.childLanes=nh(a,q,c),r.memoizedState=eh,r=Mo(null,m));else if(Rr(r),Fh(ne)){if(q=ne.nextSibling&&ne.nextSibling.dataset,q)var et=q.dgst;q=et,m=Error(i(419)),m.stack="",m.digest=q,bo({value:m,source:null,stack:null}),r=sh(a,r,c)}else if(Jn||il(a,r,c,!1),q=(c&a.childLanes)!==0,Jn||q){if(q=Ln,q!==null&&(m=xe(q,c),m!==0&&m!==Ae.retryLane))throw Ae.retryLane=m,pi(a,m),Ra(q,a,m),Qm;$h(ne)||$u(),r=sh(a,r,c)}else $h(ne)?(r.flags|=192,r.child=a.child,r=null):(a=Ae.treeContext,On=as(ne.nextSibling),ca=r,Sn=!0,_r=null,ts=!1,a!==null&&Hb(r,a),r=ah(r,m.children),r.flags|=4096);return r}return x?(Ir(),ne=m.fallback,x=r.mode,Ae=a.child,et=Ae.sibling,m=Ks(Ae,{mode:"hidden",children:m.children}),m.subtreeFlags=Ae.subtreeFlags&65011712,et!==null?ne=Ks(et,ne):(ne=yi(ne,x,c,null),ne.flags|=2),ne.return=r,m.return=r,m.sibling=ne,r.child=m,Mo(null,m),m=r.child,ne=a.child.memoizedState,ne===null?ne=th(c):(x=ne.cachePool,x!==null?(Ae=Zn._currentValue,x=x.parent!==Ae?{parent:Ae,pool:Ae}:x):x=Kb(),ne={baseLanes:ne.baseLanes|c,cachePool:x}),m.memoizedState=ne,m.childLanes=nh(a,q,c),r.memoizedState=eh,Mo(a.child,m)):(Rr(r),c=a.child,a=c.sibling,c=Ks(c,{mode:"visible",children:m.children}),c.return=r,c.sibling=null,a!==null&&(q=r.deletions,q===null?(r.deletions=[a],r.flags|=16):q.push(a)),r.child=c,r.memoizedState=null,c)}function ah(a,r){return r=Au({mode:"visible",children:r},a.mode),r.return=a,a.child=r}function Au(a,r){return a=za(22,a,null,r),a.lanes=0,a}function sh(a,r,c){return Ni(r,a.child,null,c),a=ah(r,r.pendingProps.children),a.flags|=2,r.memoizedState=null,a}function cv(a,r,c){a.lanes|=r;var m=a.alternate;m!==null&&(m.lanes|=r),xm(a.return,r,c)}function rh(a,r,c,m,x,w){var q=a.memoizedState;q===null?a.memoizedState={isBackwards:r,rendering:null,renderingStartTime:0,last:m,tail:c,tailMode:x,treeForkCount:w}:(q.isBackwards=r,q.rendering=null,q.renderingStartTime=0,q.last=m,q.tail=c,q.tailMode=x,q.treeForkCount=w)}function uv(a,r,c){var m=r.pendingProps,x=m.revealOrder,w=m.tail;m=m.children;var q=Xn.current,ne=(q&2)!==0;if(ne?(q=q&1|2,r.flags|=128):q&=1,P(Xn,q),da(a,r,m,c),m=Sn?go:0,!ne&&a!==null&&(a.flags&128)!==0)e:for(a=r.child;a!==null;){if(a.tag===13)a.memoizedState!==null&&cv(a,c,r);else if(a.tag===19)cv(a,c,r);else if(a.child!==null){a.child.return=a,a=a.child;continue}if(a===r)break e;for(;a.sibling===null;){if(a.return===null||a.return===r)break e;a=a.return}a.sibling.return=a.return,a=a.sibling}switch(x){case"forwards":for(c=r.child,x=null;c!==null;)a=c.alternate,a!==null&&yu(a)===null&&(x=c),c=c.sibling;c=x,c===null?(x=r.child,r.child=null):(x=c.sibling,c.sibling=null),rh(r,!1,x,c,w,m);break;case"backwards":case"unstable_legacy-backwards":for(c=null,x=r.child,r.child=null;x!==null;){if(a=x.alternate,a!==null&&yu(a)===null){r.child=x;break}a=x.sibling,x.sibling=c,c=x,x=a}rh(r,!0,c,null,w,m);break;case"together":rh(r,!1,null,null,void 0,m);break;default:r.memoizedState=null}return r.child}function nr(a,r,c){if(a!==null&&(r.dependencies=a.dependencies),Or|=r.lanes,(c&r.childLanes)===0)if(a!==null){if(il(a,r,c,!1),(c&r.childLanes)===0)return null}else return null;if(a!==null&&r.child!==a.child)throw Error(i(153));if(r.child!==null){for(a=r.child,c=Ks(a,a.pendingProps),r.child=c,c.return=r;a.sibling!==null;)a=a.sibling,c=c.sibling=Ks(a,a.pendingProps),c.return=r;c.sibling=null}return r.child}function ih(a,r){return(a.lanes&r)!==0?!0:(a=a.dependencies,!!(a!==null&&ou(a)))}function qC(a,r,c){switch(r.tag){case 3:Q(r,r.stateNode.containerInfo),Ar(r,Zn,a.memoizedState.cache),gi();break;case 27:case 5:re(r);break;case 4:Q(r,r.stateNode.containerInfo);break;case 10:Ar(r,r.type,r.memoizedProps.value);break;case 31:if(r.memoizedState!==null)return r.flags|=128,km(r),null;break;case 13:var m=r.memoizedState;if(m!==null)return m.dehydrated!==null?(Rr(r),r.flags|=128,null):(c&r.child.childLanes)!==0?ov(a,r,c):(Rr(r),a=nr(a,r,c),a!==null?a.sibling:null);Rr(r);break;case 19:var x=(a.flags&128)!==0;if(m=(c&r.childLanes)!==0,m||(il(a,r,c,!1),m=(c&r.childLanes)!==0),x){if(m)return uv(a,r,c);r.flags|=128}if(x=r.memoizedState,x!==null&&(x.rendering=null,x.tail=null,x.lastEffect=null),P(Xn,Xn.current),m)break;return null;case 22:return r.lanes=0,nv(a,r,c,r.pendingProps);case 24:Ar(r,Zn,a.memoizedState.cache)}return nr(a,r,c)}function dv(a,r,c){if(a!==null)if(a.memoizedProps!==r.pendingProps)Jn=!0;else{if(!ih(a,c)&&(r.flags&128)===0)return Jn=!1,qC(a,r,c);Jn=(a.flags&131072)!==0}else Jn=!1,Sn&&(r.flags&1048576)!==0&&Pb(r,go,r.index);switch(r.lanes=0,r.tag){case 16:e:{var m=r.pendingProps;if(a=Si(r.elementType),r.type=a,typeof a=="function")dm(a)?(m=Ei(a,m),r.tag=1,r=iv(null,r,a,m,c)):(r.tag=0,r=Jm(null,r,a,m,c));else{if(a!=null){var x=a.$$typeof;if(x===_){r.tag=11,r=Jx(null,r,a,m,c);break e}else if(x===C){r.tag=14,r=ev(null,r,a,m,c);break e}}throw r=R(a)||a,Error(i(306,r,""))}}return r;case 0:return Jm(a,r,r.type,r.pendingProps,c);case 1:return m=r.type,x=Ei(m,r.pendingProps),iv(a,r,m,x,c);case 3:e:{if(Q(r,r.stateNode.containerInfo),a===null)throw Error(i(387));m=r.pendingProps;var w=r.memoizedState;x=w.element,_m(a,r),Eo(r,m,null,c);var q=r.memoizedState;if(m=q.cache,Ar(r,Zn,m),m!==w.cache&&vm(r,[Zn],c,!0),jo(),m=q.element,w.isDehydrated)if(w={element:m,isDehydrated:!1,cache:q.cache},r.updateQueue.baseState=w,r.memoizedState=w,r.flags&256){r=lv(a,r,m,c);break e}else if(m!==x){x=Qa(Error(i(424)),r),bo(x),r=lv(a,r,m,c);break e}else{switch(a=r.stateNode.containerInfo,a.nodeType){case 9:a=a.body;break;default:a=a.nodeName==="HTML"?a.ownerDocument.body:a}for(On=as(a.firstChild),ca=r,Sn=!0,_r=null,ts=!0,c=nx(r,null,m,c),r.child=c;c;)c.flags=c.flags&-3|4096,c=c.sibling}else{if(gi(),m===x){r=nr(a,r,c);break e}da(a,r,m,c)}r=r.child}return r;case 26:return Cu(a,r),a===null?(c=w0(r.type,null,r.pendingProps,null))?r.memoizedState=c:Sn||(c=r.type,a=r.pendingProps,m=Hu(K.current).createElement(c),m[Ne]=r,m[pe]=a,fa(m,c,a),Ye(m),r.stateNode=m):r.memoizedState=w0(r.type,a.memoizedProps,r.pendingProps,a.memoizedState),null;case 27:return re(r),a===null&&Sn&&(m=r.stateNode=x0(r.type,r.pendingProps,K.current),ca=r,ts=!0,x=On,Ur(r.type)?(zh=x,On=as(m.firstChild)):On=x),da(a,r,r.pendingProps.children,c),Cu(a,r),a===null&&(r.flags|=4194304),r.child;case 5:return a===null&&Sn&&((x=m=On)&&(m=bA(m,r.type,r.pendingProps,ts),m!==null?(r.stateNode=m,ca=r,On=as(m.firstChild),ts=!1,x=!0):x=!1),x||Cr(r)),re(r),x=r.type,w=r.pendingProps,q=a!==null?a.memoizedProps:null,m=w.children,Lh(x,w)?m=null:q!==null&&Lh(x,q)&&(r.flags|=32),r.memoizedState!==null&&(x=Im(a,r,IC,null,null,c),Vo._currentValue=x),Cu(a,r),da(a,r,m,c),r.child;case 6:return a===null&&Sn&&((a=c=On)&&(c=xA(c,r.pendingProps,ts),c!==null?(r.stateNode=c,ca=r,On=null,a=!0):a=!1),a||Cr(r)),null;case 13:return ov(a,r,c);case 4:return Q(r,r.stateNode.containerInfo),m=r.pendingProps,a===null?r.child=Ni(r,null,m,c):da(a,r,m,c),r.child;case 11:return Jx(a,r,r.type,r.pendingProps,c);case 7:return da(a,r,r.pendingProps,c),r.child;case 8:return da(a,r,r.pendingProps.children,c),r.child;case 12:return da(a,r,r.pendingProps.children,c),r.child;case 10:return m=r.pendingProps,Ar(r,r.type,m.value),da(a,r,m.children,c),r.child;case 9:return x=r.type._context,m=r.pendingProps.children,xi(r),x=ua(x),m=m(x),r.flags|=1,da(a,r,m,c),r.child;case 14:return ev(a,r,r.type,r.pendingProps,c);case 15:return tv(a,r,r.type,r.pendingProps,c);case 19:return uv(a,r,c);case 31:return UC(a,r,c);case 22:return nv(a,r,c,r.pendingProps);case 24:return xi(r),m=ua(Zn),a===null?(x=Nm(),x===null&&(x=Ln,w=Sm(),x.pooledCache=w,w.refCount++,w!==null&&(x.pooledCacheLanes|=c),x=w),r.memoizedState={parent:m,cache:x},Em(r),Ar(r,Zn,x)):((a.lanes&c)!==0&&(_m(a,r),Eo(r,null,null,c),jo()),x=a.memoizedState,w=r.memoizedState,x.parent!==m?(x={parent:m,cache:m},r.memoizedState=x,r.lanes===0&&(r.memoizedState=r.updateQueue.baseState=x),Ar(r,Zn,m)):(m=w.cache,Ar(r,Zn,m),m!==x.cache&&vm(r,[Zn],c,!0))),da(a,r,r.pendingProps.children,c),r.child;case 29:throw r.pendingProps}throw Error(i(156,r.tag))}function ar(a){a.flags|=4}function lh(a,r,c,m,x){if((r=(a.mode&32)!==0)&&(r=!1),r){if(a.flags|=16777216,(x&335544128)===x)if(a.stateNode.complete)a.flags|=8192;else if(Fv())a.flags|=8192;else throw wi=fu,jm}else a.flags&=-16777217}function fv(a,r){if(r.type!=="stylesheet"||(r.state.loading&4)!==0)a.flags&=-16777217;else if(a.flags|=16777216,!C0(r))if(Fv())a.flags|=8192;else throw wi=fu,jm}function Tu(a,r){r!==null&&(a.flags|=4),a.flags&16384&&(r=a.tag!==22?it():536870912,a.lanes|=r,bl|=r)}function ko(a,r){if(!Sn)switch(a.tailMode){case"hidden":r=a.tail;for(var c=null;r!==null;)r.alternate!==null&&(c=r),r=r.sibling;c===null?a.tail=null:c.sibling=null;break;case"collapsed":c=a.tail;for(var m=null;c!==null;)c.alternate!==null&&(m=c),c=c.sibling;m===null?r||a.tail===null?a.tail=null:a.tail.sibling=null:m.sibling=null}}function $n(a){var r=a.alternate!==null&&a.alternate.child===a.child,c=0,m=0;if(r)for(var x=a.child;x!==null;)c|=x.lanes|x.childLanes,m|=x.subtreeFlags&65011712,m|=x.flags&65011712,x.return=a,x=x.sibling;else for(x=a.child;x!==null;)c|=x.lanes|x.childLanes,m|=x.subtreeFlags,m|=x.flags,x.return=a,x=x.sibling;return a.subtreeFlags|=m,a.childLanes=c,r}function PC(a,r,c){var m=r.pendingProps;switch(pm(r),r.tag){case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return $n(r),null;case 1:return $n(r),null;case 3:return c=r.stateNode,m=null,a!==null&&(m=a.memoizedState.cache),r.memoizedState.cache!==m&&(r.flags|=2048),Js(Zn),he(),c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),(a===null||a.child===null)&&(rl(r)?ar(r):a===null||a.memoizedState.isDehydrated&&(r.flags&256)===0||(r.flags|=1024,gm())),$n(r),null;case 26:var x=r.type,w=r.memoizedState;return a===null?(ar(r),w!==null?($n(r),fv(r,w)):($n(r),lh(r,x,null,m,c))):w?w!==a.memoizedState?(ar(r),$n(r),fv(r,w)):($n(r),r.flags&=-16777217):(a=a.memoizedProps,a!==m&&ar(r),$n(r),lh(r,x,a,m,c)),null;case 27:if(Ce(r),c=K.current,x=r.type,a!==null&&r.stateNode!=null)a.memoizedProps!==m&&ar(r);else{if(!m){if(r.stateNode===null)throw Error(i(166));return $n(r),null}a=W.current,rl(r)?Vb(r):(a=x0(x,m,c),r.stateNode=a,ar(r))}return $n(r),null;case 5:if(Ce(r),x=r.type,a!==null&&r.stateNode!=null)a.memoizedProps!==m&&ar(r);else{if(!m){if(r.stateNode===null)throw Error(i(166));return $n(r),null}if(w=W.current,rl(r))Vb(r);else{var q=Hu(K.current);switch(w){case 1:w=q.createElementNS("http://www.w3.org/2000/svg",x);break;case 2:w=q.createElementNS("http://www.w3.org/1998/Math/MathML",x);break;default:switch(x){case"svg":w=q.createElementNS("http://www.w3.org/2000/svg",x);break;case"math":w=q.createElementNS("http://www.w3.org/1998/Math/MathML",x);break;case"script":w=q.createElement("div"),w.innerHTML="<script><\/script>",w=w.removeChild(w.firstChild);break;case"select":w=typeof m.is=="string"?q.createElement("select",{is:m.is}):q.createElement("select"),m.multiple?w.multiple=!0:m.size&&(w.size=m.size);break;default:w=typeof m.is=="string"?q.createElement(x,{is:m.is}):q.createElement(x)}}w[Ne]=r,w[pe]=m;e:for(q=r.child;q!==null;){if(q.tag===5||q.tag===6)w.appendChild(q.stateNode);else if(q.tag!==4&&q.tag!==27&&q.child!==null){q.child.return=q,q=q.child;continue}if(q===r)break e;for(;q.sibling===null;){if(q.return===null||q.return===r)break e;q=q.return}q.sibling.return=q.return,q=q.sibling}r.stateNode=w;e:switch(fa(w,x,m),x){case"button":case"input":case"select":case"textarea":m=!!m.autoFocus;break e;case"img":m=!0;break e;default:m=!1}m&&ar(r)}}return $n(r),lh(r,r.type,a===null?null:a.memoizedProps,r.pendingProps,c),null;case 6:if(a&&r.stateNode!=null)a.memoizedProps!==m&&ar(r);else{if(typeof m!="string"&&r.stateNode===null)throw Error(i(166));if(a=K.current,rl(r)){if(a=r.stateNode,c=r.memoizedProps,m=null,x=ca,x!==null)switch(x.tag){case 27:case 5:m=x.memoizedProps}a[Ne]=r,a=!!(a.nodeValue===c||m!==null&&m.suppressHydrationWarning===!0||o0(a.nodeValue,c)),a||Cr(r,!0)}else a=Hu(a).createTextNode(m),a[Ne]=r,r.stateNode=a}return $n(r),null;case 31:if(c=r.memoizedState,a===null||a.memoizedState!==null){if(m=rl(r),c!==null){if(a===null){if(!m)throw Error(i(318));if(a=r.memoizedState,a=a!==null?a.dehydrated:null,!a)throw Error(i(557));a[Ne]=r}else gi(),(r.flags&128)===0&&(r.memoizedState=null),r.flags|=4;$n(r),a=!1}else c=gm(),a!==null&&a.memoizedState!==null&&(a.memoizedState.hydrationErrors=c),a=!0;if(!a)return r.flags&256?(Ua(r),r):(Ua(r),null);if((r.flags&128)!==0)throw Error(i(558))}return $n(r),null;case 13:if(m=r.memoizedState,a===null||a.memoizedState!==null&&a.memoizedState.dehydrated!==null){if(x=rl(r),m!==null&&m.dehydrated!==null){if(a===null){if(!x)throw Error(i(318));if(x=r.memoizedState,x=x!==null?x.dehydrated:null,!x)throw Error(i(317));x[Ne]=r}else gi(),(r.flags&128)===0&&(r.memoizedState=null),r.flags|=4;$n(r),x=!1}else x=gm(),a!==null&&a.memoizedState!==null&&(a.memoizedState.hydrationErrors=x),x=!0;if(!x)return r.flags&256?(Ua(r),r):(Ua(r),null)}return Ua(r),(r.flags&128)!==0?(r.lanes=c,r):(c=m!==null,a=a!==null&&a.memoizedState!==null,c&&(m=r.child,x=null,m.alternate!==null&&m.alternate.memoizedState!==null&&m.alternate.memoizedState.cachePool!==null&&(x=m.alternate.memoizedState.cachePool.pool),w=null,m.memoizedState!==null&&m.memoizedState.cachePool!==null&&(w=m.memoizedState.cachePool.pool),w!==x&&(m.flags|=2048)),c!==a&&c&&(r.child.flags|=8192),Tu(r,r.updateQueue),$n(r),null);case 4:return he(),a===null&&Th(r.stateNode.containerInfo),$n(r),null;case 10:return Js(r.type),$n(r),null;case 19:if(Y(Xn),m=r.memoizedState,m===null)return $n(r),null;if(x=(r.flags&128)!==0,w=m.rendering,w===null)if(x)ko(m,!1);else{if(Vn!==0||a!==null&&(a.flags&128)!==0)for(a=r.child;a!==null;){if(w=yu(a),w!==null){for(r.flags|=128,ko(m,!1),a=w.updateQueue,r.updateQueue=a,Tu(r,a),r.subtreeFlags=0,a=c,c=r.child;c!==null;)Bb(c,a),c=c.sibling;return P(Xn,Xn.current&1|2),Sn&&Zs(r,m.treeForkCount),r.child}a=a.sibling}m.tail!==null&&st()>Lu&&(r.flags|=128,x=!0,ko(m,!1),r.lanes=4194304)}else{if(!x)if(a=yu(w),a!==null){if(r.flags|=128,x=!0,a=a.updateQueue,r.updateQueue=a,Tu(r,a),ko(m,!0),m.tail===null&&m.tailMode==="hidden"&&!w.alternate&&!Sn)return $n(r),null}else 2*st()-m.renderingStartTime>Lu&&c!==536870912&&(r.flags|=128,x=!0,ko(m,!1),r.lanes=4194304);m.isBackwards?(w.sibling=r.child,r.child=w):(a=m.last,a!==null?a.sibling=w:r.child=w,m.last=w)}return m.tail!==null?(a=m.tail,m.rendering=a,m.tail=a.sibling,m.renderingStartTime=st(),a.sibling=null,c=Xn.current,P(Xn,x?c&1|2:c&1),Sn&&Zs(r,m.treeForkCount),a):($n(r),null);case 22:case 23:return Ua(r),Mm(),m=r.memoizedState!==null,a!==null?a.memoizedState!==null!==m&&(r.flags|=8192):m&&(r.flags|=8192),m?(c&536870912)!==0&&(r.flags&128)===0&&($n(r),r.subtreeFlags&6&&(r.flags|=8192)):$n(r),c=r.updateQueue,c!==null&&Tu(r,c.retryQueue),c=null,a!==null&&a.memoizedState!==null&&a.memoizedState.cachePool!==null&&(c=a.memoizedState.cachePool.pool),m=null,r.memoizedState!==null&&r.memoizedState.cachePool!==null&&(m=r.memoizedState.cachePool.pool),m!==c&&(r.flags|=2048),a!==null&&Y(vi),null;case 24:return c=null,a!==null&&(c=a.memoizedState.cache),r.memoizedState.cache!==c&&(r.flags|=2048),Js(Zn),$n(r),null;case 25:return null;case 30:return null}throw Error(i(156,r.tag))}function HC(a,r){switch(pm(r),r.tag){case 1:return a=r.flags,a&65536?(r.flags=a&-65537|128,r):null;case 3:return Js(Zn),he(),a=r.flags,(a&65536)!==0&&(a&128)===0?(r.flags=a&-65537|128,r):null;case 26:case 27:case 5:return Ce(r),null;case 31:if(r.memoizedState!==null){if(Ua(r),r.alternate===null)throw Error(i(340));gi()}return a=r.flags,a&65536?(r.flags=a&-65537|128,r):null;case 13:if(Ua(r),a=r.memoizedState,a!==null&&a.dehydrated!==null){if(r.alternate===null)throw Error(i(340));gi()}return a=r.flags,a&65536?(r.flags=a&-65537|128,r):null;case 19:return Y(Xn),null;case 4:return he(),null;case 10:return Js(r.type),null;case 22:case 23:return Ua(r),Mm(),a!==null&&Y(vi),a=r.flags,a&65536?(r.flags=a&-65537|128,r):null;case 24:return Js(Zn),null;case 25:return null;default:return null}}function mv(a,r){switch(pm(r),r.tag){case 3:Js(Zn),he();break;case 26:case 27:case 5:Ce(r);break;case 4:he();break;case 31:r.memoizedState!==null&&Ua(r);break;case 13:Ua(r);break;case 19:Y(Xn);break;case 10:Js(r.type);break;case 22:case 23:Ua(r),Mm(),a!==null&&Y(vi);break;case 24:Js(Zn)}}function Ro(a,r){try{var c=r.updateQueue,m=c!==null?c.lastEffect:null;if(m!==null){var x=m.next;c=x;do{if((c.tag&a)===a){m=void 0;var w=c.create,q=c.inst;m=w(),q.destroy=m}c=c.next}while(c!==x)}}catch(ne){Tn(r,r.return,ne)}}function Lr(a,r,c){try{var m=r.updateQueue,x=m!==null?m.lastEffect:null;if(x!==null){var w=x.next;m=w;do{if((m.tag&a)===a){var q=m.inst,ne=q.destroy;if(ne!==void 0){q.destroy=void 0,x=r;var Ae=c,et=ne;try{et()}catch(yt){Tn(x,Ae,yt)}}}m=m.next}while(m!==w)}}catch(yt){Tn(r,r.return,yt)}}function hv(a){var r=a.updateQueue;if(r!==null){var c=a.stateNode;try{sx(r,c)}catch(m){Tn(a,a.return,m)}}}function pv(a,r,c){c.props=Ei(a.type,a.memoizedProps),c.state=a.memoizedState;try{c.componentWillUnmount()}catch(m){Tn(a,r,m)}}function Io(a,r){try{var c=a.ref;if(c!==null){switch(a.tag){case 26:case 27:case 5:var m=a.stateNode;break;case 30:m=a.stateNode;break;default:m=a.stateNode}typeof c=="function"?a.refCleanup=c(m):c.current=m}}catch(x){Tn(a,r,x)}}function Ls(a,r){var c=a.ref,m=a.refCleanup;if(c!==null)if(typeof m=="function")try{m()}catch(x){Tn(a,r,x)}finally{a.refCleanup=null,a=a.alternate,a!=null&&(a.refCleanup=null)}else if(typeof c=="function")try{c(null)}catch(x){Tn(a,r,x)}else c.current=null}function yv(a){var r=a.type,c=a.memoizedProps,m=a.stateNode;try{e:switch(r){case"button":case"input":case"select":case"textarea":c.autoFocus&&m.focus();break e;case"img":c.src?m.src=c.src:c.srcSet&&(m.srcset=c.srcSet)}}catch(x){Tn(a,a.return,x)}}function oh(a,r,c){try{var m=a.stateNode;fA(m,a.type,c,r),m[pe]=r}catch(x){Tn(a,a.return,x)}}function gv(a){return a.tag===5||a.tag===3||a.tag===26||a.tag===27&&Ur(a.type)||a.tag===4}function ch(a){e:for(;;){for(;a.sibling===null;){if(a.return===null||gv(a.return))return null;a=a.return}for(a.sibling.return=a.return,a=a.sibling;a.tag!==5&&a.tag!==6&&a.tag!==18;){if(a.tag===27&&Ur(a.type)||a.flags&2||a.child===null||a.tag===4)continue e;a.child.return=a,a=a.child}if(!(a.flags&2))return a.stateNode}}function uh(a,r,c){var m=a.tag;if(m===5||m===6)a=a.stateNode,r?(c.nodeType===9?c.body:c.nodeName==="HTML"?c.ownerDocument.body:c).insertBefore(a,r):(r=c.nodeType===9?c.body:c.nodeName==="HTML"?c.ownerDocument.body:c,r.appendChild(a),c=c._reactRootContainer,c!=null||r.onclick!==null||(r.onclick=Oe));else if(m!==4&&(m===27&&Ur(a.type)&&(c=a.stateNode,r=null),a=a.child,a!==null))for(uh(a,r,c),a=a.sibling;a!==null;)uh(a,r,c),a=a.sibling}function Mu(a,r,c){var m=a.tag;if(m===5||m===6)a=a.stateNode,r?c.insertBefore(a,r):c.appendChild(a);else if(m!==4&&(m===27&&Ur(a.type)&&(c=a.stateNode),a=a.child,a!==null))for(Mu(a,r,c),a=a.sibling;a!==null;)Mu(a,r,c),a=a.sibling}function bv(a){var r=a.stateNode,c=a.memoizedProps;try{for(var m=a.type,x=r.attributes;x.length;)r.removeAttributeNode(x[0]);fa(r,m,c),r[Ne]=a,r[pe]=c}catch(w){Tn(a,a.return,w)}}var sr=!1,ea=!1,dh=!1,xv=typeof WeakSet=="function"?WeakSet:Set,ia=null;function VC(a,r){if(a=a.containerInfo,Rh=Zu,a=kb(a),sm(a)){if("selectionStart"in a)var c={start:a.selectionStart,end:a.selectionEnd};else e:{c=(c=a.ownerDocument)&&c.defaultView||window;var m=c.getSelection&&c.getSelection();if(m&&m.rangeCount!==0){c=m.anchorNode;var x=m.anchorOffset,w=m.focusNode;m=m.focusOffset;try{c.nodeType,w.nodeType}catch{c=null;break e}var q=0,ne=-1,Ae=-1,et=0,yt=0,wt=a,at=null;t:for(;;){for(var ut;wt!==c||x!==0&&wt.nodeType!==3||(ne=q+x),wt!==w||m!==0&&wt.nodeType!==3||(Ae=q+m),wt.nodeType===3&&(q+=wt.nodeValue.length),(ut=wt.firstChild)!==null;)at=wt,wt=ut;for(;;){if(wt===a)break t;if(at===c&&++et===x&&(ne=q),at===w&&++yt===m&&(Ae=q),(ut=wt.nextSibling)!==null)break;wt=at,at=wt.parentNode}wt=ut}c=ne===-1||Ae===-1?null:{start:ne,end:Ae}}else c=null}c=c||{start:0,end:0}}else c=null;for(Ih={focusedElem:a,selectionRange:c},Zu=!1,ia=r;ia!==null;)if(r=ia,a=r.child,(r.subtreeFlags&1028)!==0&&a!==null)a.return=r,ia=a;else for(;ia!==null;){switch(r=ia,w=r.alternate,a=r.flags,r.tag){case 0:if((a&4)!==0&&(a=r.updateQueue,a=a!==null?a.events:null,a!==null))for(c=0;c<a.length;c++)x=a[c],x.ref.impl=x.nextImpl;break;case 11:case 15:break;case 1:if((a&1024)!==0&&w!==null){a=void 0,c=r,x=w.memoizedProps,w=w.memoizedState,m=c.stateNode;try{var qt=Ei(c.type,x);a=m.getSnapshotBeforeUpdate(qt,w),m.__reactInternalSnapshotBeforeUpdate=a}catch(Jt){Tn(c,c.return,Jt)}}break;case 3:if((a&1024)!==0){if(a=r.stateNode.containerInfo,c=a.nodeType,c===9)Oh(a);else if(c===1)switch(a.nodeName){case"HEAD":case"HTML":case"BODY":Oh(a);break;default:a.textContent=""}}break;case 5:case 26:case 27:case 6:case 4:case 17:break;default:if((a&1024)!==0)throw Error(i(163))}if(a=r.sibling,a!==null){a.return=r.return,ia=a;break}ia=r.return}}function vv(a,r,c){var m=c.flags;switch(c.tag){case 0:case 11:case 15:ir(a,c),m&4&&Ro(5,c);break;case 1:if(ir(a,c),m&4)if(a=c.stateNode,r===null)try{a.componentDidMount()}catch(q){Tn(c,c.return,q)}else{var x=Ei(c.type,r.memoizedProps);r=r.memoizedState;try{a.componentDidUpdate(x,r,a.__reactInternalSnapshotBeforeUpdate)}catch(q){Tn(c,c.return,q)}}m&64&&hv(c),m&512&&Io(c,c.return);break;case 3:if(ir(a,c),m&64&&(a=c.updateQueue,a!==null)){if(r=null,c.child!==null)switch(c.child.tag){case 27:case 5:r=c.child.stateNode;break;case 1:r=c.child.stateNode}try{sx(a,r)}catch(q){Tn(c,c.return,q)}}break;case 27:r===null&&m&4&&bv(c);case 26:case 5:ir(a,c),r===null&&m&4&&yv(c),m&512&&Io(c,c.return);break;case 12:ir(a,c);break;case 31:ir(a,c),m&4&&Nv(a,c);break;case 13:ir(a,c),m&4&&jv(a,c),m&64&&(a=c.memoizedState,a!==null&&(a=a.dehydrated,a!==null&&(c=eA.bind(null,c),vA(a,c))));break;case 22:if(m=c.memoizedState!==null||sr,!m){r=r!==null&&r.memoizedState!==null||ea,x=sr;var w=ea;sr=m,(ea=r)&&!w?lr(a,c,(c.subtreeFlags&8772)!==0):ir(a,c),sr=x,ea=w}break;case 30:break;default:ir(a,c)}}function Sv(a){var r=a.alternate;r!==null&&(a.alternate=null,Sv(r)),a.child=null,a.deletions=null,a.sibling=null,a.tag===5&&(r=a.stateNode,r!==null&&nt(r)),a.stateNode=null,a.return=null,a.dependencies=null,a.memoizedProps=null,a.memoizedState=null,a.pendingProps=null,a.stateNode=null,a.updateQueue=null}var Fn=null,Aa=!1;function rr(a,r,c){for(c=c.child;c!==null;)wv(a,r,c),c=c.sibling}function wv(a,r,c){if(Pe&&typeof Pe.onCommitFiberUnmount=="function")try{Pe.onCommitFiberUnmount(qe,c)}catch{}switch(c.tag){case 26:ea||Ls(c,r),rr(a,r,c),c.memoizedState?c.memoizedState.count--:c.stateNode&&(c=c.stateNode,c.parentNode.removeChild(c));break;case 27:ea||Ls(c,r);var m=Fn,x=Aa;Ur(c.type)&&(Fn=c.stateNode,Aa=!1),rr(a,r,c),qo(c.stateNode),Fn=m,Aa=x;break;case 5:ea||Ls(c,r);case 6:if(m=Fn,x=Aa,Fn=null,rr(a,r,c),Fn=m,Aa=x,Fn!==null)if(Aa)try{(Fn.nodeType===9?Fn.body:Fn.nodeName==="HTML"?Fn.ownerDocument.body:Fn).removeChild(c.stateNode)}catch(w){Tn(c,r,w)}else try{Fn.removeChild(c.stateNode)}catch(w){Tn(c,r,w)}break;case 18:Fn!==null&&(Aa?(a=Fn,h0(a.nodeType===9?a.body:a.nodeName==="HTML"?a.ownerDocument.body:a,c.stateNode),_l(a)):h0(Fn,c.stateNode));break;case 4:m=Fn,x=Aa,Fn=c.stateNode.containerInfo,Aa=!0,rr(a,r,c),Fn=m,Aa=x;break;case 0:case 11:case 14:case 15:Lr(2,c,r),ea||Lr(4,c,r),rr(a,r,c);break;case 1:ea||(Ls(c,r),m=c.stateNode,typeof m.componentWillUnmount=="function"&&pv(c,r,m)),rr(a,r,c);break;case 21:rr(a,r,c);break;case 22:ea=(m=ea)||c.memoizedState!==null,rr(a,r,c),ea=m;break;default:rr(a,r,c)}}function Nv(a,r){if(r.memoizedState===null&&(a=r.alternate,a!==null&&(a=a.memoizedState,a!==null))){a=a.dehydrated;try{_l(a)}catch(c){Tn(r,r.return,c)}}}function jv(a,r){if(r.memoizedState===null&&(a=r.alternate,a!==null&&(a=a.memoizedState,a!==null&&(a=a.dehydrated,a!==null))))try{_l(a)}catch(c){Tn(r,r.return,c)}}function YC(a){switch(a.tag){case 31:case 13:case 19:var r=a.stateNode;return r===null&&(r=a.stateNode=new xv),r;case 22:return a=a.stateNode,r=a._retryCache,r===null&&(r=a._retryCache=new xv),r;default:throw Error(i(435,a.tag))}}function ku(a,r){var c=YC(a);r.forEach(function(m){if(!c.has(m)){c.add(m);var x=tA.bind(null,a,m);m.then(x,x)}})}function Ta(a,r){var c=r.deletions;if(c!==null)for(var m=0;m<c.length;m++){var x=c[m],w=a,q=r,ne=q;e:for(;ne!==null;){switch(ne.tag){case 27:if(Ur(ne.type)){Fn=ne.stateNode,Aa=!1;break e}break;case 5:Fn=ne.stateNode,Aa=!1;break e;case 3:case 4:Fn=ne.stateNode.containerInfo,Aa=!0;break e}ne=ne.return}if(Fn===null)throw Error(i(160));wv(w,q,x),Fn=null,Aa=!1,w=x.alternate,w!==null&&(w.return=null),x.return=null}if(r.subtreeFlags&13886)for(r=r.child;r!==null;)Ev(r,a),r=r.sibling}var gs=null;function Ev(a,r){var c=a.alternate,m=a.flags;switch(a.tag){case 0:case 11:case 14:case 15:Ta(r,a),Ma(a),m&4&&(Lr(3,a,a.return),Ro(3,a),Lr(5,a,a.return));break;case 1:Ta(r,a),Ma(a),m&512&&(ea||c===null||Ls(c,c.return)),m&64&&sr&&(a=a.updateQueue,a!==null&&(m=a.callbacks,m!==null&&(c=a.shared.hiddenCallbacks,a.shared.hiddenCallbacks=c===null?m:c.concat(m))));break;case 26:var x=gs;if(Ta(r,a),Ma(a),m&512&&(ea||c===null||Ls(c,c.return)),m&4){var w=c!==null?c.memoizedState:null;if(m=a.memoizedState,c===null)if(m===null)if(a.stateNode===null){e:{m=a.type,c=a.memoizedProps,x=x.ownerDocument||x;t:switch(m){case"title":w=x.getElementsByTagName("title")[0],(!w||w[me]||w[Ne]||w.namespaceURI==="http://www.w3.org/2000/svg"||w.hasAttribute("itemprop"))&&(w=x.createElement(m),x.head.insertBefore(w,x.querySelector("head > title"))),fa(w,m,c),w[Ne]=a,Ye(w),m=w;break e;case"link":var q=E0("link","href",x).get(m+(c.href||""));if(q){for(var ne=0;ne<q.length;ne++)if(w=q[ne],w.getAttribute("href")===(c.href==null||c.href===""?null:c.href)&&w.getAttribute("rel")===(c.rel==null?null:c.rel)&&w.getAttribute("title")===(c.title==null?null:c.title)&&w.getAttribute("crossorigin")===(c.crossOrigin==null?null:c.crossOrigin)){q.splice(ne,1);break t}}w=x.createElement(m),fa(w,m,c),x.head.appendChild(w);break;case"meta":if(q=E0("meta","content",x).get(m+(c.content||""))){for(ne=0;ne<q.length;ne++)if(w=q[ne],w.getAttribute("content")===(c.content==null?null:""+c.content)&&w.getAttribute("name")===(c.name==null?null:c.name)&&w.getAttribute("property")===(c.property==null?null:c.property)&&w.getAttribute("http-equiv")===(c.httpEquiv==null?null:c.httpEquiv)&&w.getAttribute("charset")===(c.charSet==null?null:c.charSet)){q.splice(ne,1);break t}}w=x.createElement(m),fa(w,m,c),x.head.appendChild(w);break;default:throw Error(i(468,m))}w[Ne]=a,Ye(w),m=w}a.stateNode=m}else _0(x,a.type,a.stateNode);else a.stateNode=j0(x,m,a.memoizedProps);else w!==m?(w===null?c.stateNode!==null&&(c=c.stateNode,c.parentNode.removeChild(c)):w.count--,m===null?_0(x,a.type,a.stateNode):j0(x,m,a.memoizedProps)):m===null&&a.stateNode!==null&&oh(a,a.memoizedProps,c.memoizedProps)}break;case 27:Ta(r,a),Ma(a),m&512&&(ea||c===null||Ls(c,c.return)),c!==null&&m&4&&oh(a,a.memoizedProps,c.memoizedProps);break;case 5:if(Ta(r,a),Ma(a),m&512&&(ea||c===null||Ls(c,c.return)),a.flags&32){x=a.stateNode;try{Ea(x,"")}catch(qt){Tn(a,a.return,qt)}}m&4&&a.stateNode!=null&&(x=a.memoizedProps,oh(a,x,c!==null?c.memoizedProps:x)),m&1024&&(dh=!0);break;case 6:if(Ta(r,a),Ma(a),m&4){if(a.stateNode===null)throw Error(i(162));m=a.memoizedProps,c=a.stateNode;try{c.nodeValue=m}catch(qt){Tn(a,a.return,qt)}}break;case 3:if(Gu=null,x=gs,gs=Vu(r.containerInfo),Ta(r,a),gs=x,Ma(a),m&4&&c!==null&&c.memoizedState.isDehydrated)try{_l(r.containerInfo)}catch(qt){Tn(a,a.return,qt)}dh&&(dh=!1,_v(a));break;case 4:m=gs,gs=Vu(a.stateNode.containerInfo),Ta(r,a),Ma(a),gs=m;break;case 12:Ta(r,a),Ma(a);break;case 31:Ta(r,a),Ma(a),m&4&&(m=a.updateQueue,m!==null&&(a.updateQueue=null,ku(a,m)));break;case 13:Ta(r,a),Ma(a),a.child.flags&8192&&a.memoizedState!==null!=(c!==null&&c.memoizedState!==null)&&(Iu=st()),m&4&&(m=a.updateQueue,m!==null&&(a.updateQueue=null,ku(a,m)));break;case 22:x=a.memoizedState!==null;var Ae=c!==null&&c.memoizedState!==null,et=sr,yt=ea;if(sr=et||x,ea=yt||Ae,Ta(r,a),ea=yt,sr=et,Ma(a),m&8192)e:for(r=a.stateNode,r._visibility=x?r._visibility&-2:r._visibility|1,x&&(c===null||Ae||sr||ea||_i(a)),c=null,r=a;;){if(r.tag===5||r.tag===26){if(c===null){Ae=c=r;try{if(w=Ae.stateNode,x)q=w.style,typeof q.setProperty=="function"?q.setProperty("display","none","important"):q.display="none";else{ne=Ae.stateNode;var wt=Ae.memoizedProps.style,at=wt!=null&&wt.hasOwnProperty("display")?wt.display:null;ne.style.display=at==null||typeof at=="boolean"?"":(""+at).trim()}}catch(qt){Tn(Ae,Ae.return,qt)}}}else if(r.tag===6){if(c===null){Ae=r;try{Ae.stateNode.nodeValue=x?"":Ae.memoizedProps}catch(qt){Tn(Ae,Ae.return,qt)}}}else if(r.tag===18){if(c===null){Ae=r;try{var ut=Ae.stateNode;x?p0(ut,!0):p0(Ae.stateNode,!1)}catch(qt){Tn(Ae,Ae.return,qt)}}}else if((r.tag!==22&&r.tag!==23||r.memoizedState===null||r===a)&&r.child!==null){r.child.return=r,r=r.child;continue}if(r===a)break e;for(;r.sibling===null;){if(r.return===null||r.return===a)break e;c===r&&(c=null),r=r.return}c===r&&(c=null),r.sibling.return=r.return,r=r.sibling}m&4&&(m=a.updateQueue,m!==null&&(c=m.retryQueue,c!==null&&(m.retryQueue=null,ku(a,c))));break;case 19:Ta(r,a),Ma(a),m&4&&(m=a.updateQueue,m!==null&&(a.updateQueue=null,ku(a,m)));break;case 30:break;case 21:break;default:Ta(r,a),Ma(a)}}function Ma(a){var r=a.flags;if(r&2){try{for(var c,m=a.return;m!==null;){if(gv(m)){c=m;break}m=m.return}if(c==null)throw Error(i(160));switch(c.tag){case 27:var x=c.stateNode,w=ch(a);Mu(a,w,x);break;case 5:var q=c.stateNode;c.flags&32&&(Ea(q,""),c.flags&=-33);var ne=ch(a);Mu(a,ne,q);break;case 3:case 4:var Ae=c.stateNode.containerInfo,et=ch(a);uh(a,et,Ae);break;default:throw Error(i(161))}}catch(yt){Tn(a,a.return,yt)}a.flags&=-3}r&4096&&(a.flags&=-4097)}function _v(a){if(a.subtreeFlags&1024)for(a=a.child;a!==null;){var r=a;_v(r),r.tag===5&&r.flags&1024&&r.stateNode.reset(),a=a.sibling}}function ir(a,r){if(r.subtreeFlags&8772)for(r=r.child;r!==null;)vv(a,r.alternate,r),r=r.sibling}function _i(a){for(a=a.child;a!==null;){var r=a;switch(r.tag){case 0:case 11:case 14:case 15:Lr(4,r,r.return),_i(r);break;case 1:Ls(r,r.return);var c=r.stateNode;typeof c.componentWillUnmount=="function"&&pv(r,r.return,c),_i(r);break;case 27:qo(r.stateNode);case 26:case 5:Ls(r,r.return),_i(r);break;case 22:r.memoizedState===null&&_i(r);break;case 30:_i(r);break;default:_i(r)}a=a.sibling}}function lr(a,r,c){for(c=c&&(r.subtreeFlags&8772)!==0,r=r.child;r!==null;){var m=r.alternate,x=a,w=r,q=w.flags;switch(w.tag){case 0:case 11:case 15:lr(x,w,c),Ro(4,w);break;case 1:if(lr(x,w,c),m=w,x=m.stateNode,typeof x.componentDidMount=="function")try{x.componentDidMount()}catch(et){Tn(m,m.return,et)}if(m=w,x=m.updateQueue,x!==null){var ne=m.stateNode;try{var Ae=x.shared.hiddenCallbacks;if(Ae!==null)for(x.shared.hiddenCallbacks=null,x=0;x<Ae.length;x++)ax(Ae[x],ne)}catch(et){Tn(m,m.return,et)}}c&&q&64&&hv(w),Io(w,w.return);break;case 27:bv(w);case 26:case 5:lr(x,w,c),c&&m===null&&q&4&&yv(w),Io(w,w.return);break;case 12:lr(x,w,c);break;case 31:lr(x,w,c),c&&q&4&&Nv(x,w);break;case 13:lr(x,w,c),c&&q&4&&jv(x,w);break;case 22:w.memoizedState===null&&lr(x,w,c),Io(w,w.return);break;case 30:break;default:lr(x,w,c)}r=r.sibling}}function fh(a,r){var c=null;a!==null&&a.memoizedState!==null&&a.memoizedState.cachePool!==null&&(c=a.memoizedState.cachePool.pool),a=null,r.memoizedState!==null&&r.memoizedState.cachePool!==null&&(a=r.memoizedState.cachePool.pool),a!==c&&(a!=null&&a.refCount++,c!=null&&xo(c))}function mh(a,r){a=null,r.alternate!==null&&(a=r.alternate.memoizedState.cache),r=r.memoizedState.cache,r!==a&&(r.refCount++,a!=null&&xo(a))}function bs(a,r,c,m){if(r.subtreeFlags&10256)for(r=r.child;r!==null;)Cv(a,r,c,m),r=r.sibling}function Cv(a,r,c,m){var x=r.flags;switch(r.tag){case 0:case 11:case 15:bs(a,r,c,m),x&2048&&Ro(9,r);break;case 1:bs(a,r,c,m);break;case 3:bs(a,r,c,m),x&2048&&(a=null,r.alternate!==null&&(a=r.alternate.memoizedState.cache),r=r.memoizedState.cache,r!==a&&(r.refCount++,a!=null&&xo(a)));break;case 12:if(x&2048){bs(a,r,c,m),a=r.stateNode;try{var w=r.memoizedProps,q=w.id,ne=w.onPostCommit;typeof ne=="function"&&ne(q,r.alternate===null?"mount":"update",a.passiveEffectDuration,-0)}catch(Ae){Tn(r,r.return,Ae)}}else bs(a,r,c,m);break;case 31:bs(a,r,c,m);break;case 13:bs(a,r,c,m);break;case 23:break;case 22:w=r.stateNode,q=r.alternate,r.memoizedState!==null?w._visibility&2?bs(a,r,c,m):Lo(a,r):w._visibility&2?bs(a,r,c,m):(w._visibility|=2,pl(a,r,c,m,(r.subtreeFlags&10256)!==0||!1)),x&2048&&fh(q,r);break;case 24:bs(a,r,c,m),x&2048&&mh(r.alternate,r);break;default:bs(a,r,c,m)}}function pl(a,r,c,m,x){for(x=x&&((r.subtreeFlags&10256)!==0||!1),r=r.child;r!==null;){var w=a,q=r,ne=c,Ae=m,et=q.flags;switch(q.tag){case 0:case 11:case 15:pl(w,q,ne,Ae,x),Ro(8,q);break;case 23:break;case 22:var yt=q.stateNode;q.memoizedState!==null?yt._visibility&2?pl(w,q,ne,Ae,x):Lo(w,q):(yt._visibility|=2,pl(w,q,ne,Ae,x)),x&&et&2048&&fh(q.alternate,q);break;case 24:pl(w,q,ne,Ae,x),x&&et&2048&&mh(q.alternate,q);break;default:pl(w,q,ne,Ae,x)}r=r.sibling}}function Lo(a,r){if(r.subtreeFlags&10256)for(r=r.child;r!==null;){var c=a,m=r,x=m.flags;switch(m.tag){case 22:Lo(c,m),x&2048&&fh(m.alternate,m);break;case 24:Lo(c,m),x&2048&&mh(m.alternate,m);break;default:Lo(c,m)}r=r.sibling}}var Do=8192;function yl(a,r,c){if(a.subtreeFlags&Do)for(a=a.child;a!==null;)Av(a,r,c),a=a.sibling}function Av(a,r,c){switch(a.tag){case 26:yl(a,r,c),a.flags&Do&&a.memoizedState!==null&&RA(c,gs,a.memoizedState,a.memoizedProps);break;case 5:yl(a,r,c);break;case 3:case 4:var m=gs;gs=Vu(a.stateNode.containerInfo),yl(a,r,c),gs=m;break;case 22:a.memoizedState===null&&(m=a.alternate,m!==null&&m.memoizedState!==null?(m=Do,Do=16777216,yl(a,r,c),Do=m):yl(a,r,c));break;default:yl(a,r,c)}}function Tv(a){var r=a.alternate;if(r!==null&&(a=r.child,a!==null)){r.child=null;do r=a.sibling,a.sibling=null,a=r;while(a!==null)}}function Oo(a){var r=a.deletions;if((a.flags&16)!==0){if(r!==null)for(var c=0;c<r.length;c++){var m=r[c];ia=m,kv(m,a)}Tv(a)}if(a.subtreeFlags&10256)for(a=a.child;a!==null;)Mv(a),a=a.sibling}function Mv(a){switch(a.tag){case 0:case 11:case 15:Oo(a),a.flags&2048&&Lr(9,a,a.return);break;case 3:Oo(a);break;case 12:Oo(a);break;case 22:var r=a.stateNode;a.memoizedState!==null&&r._visibility&2&&(a.return===null||a.return.tag!==13)?(r._visibility&=-3,Ru(a)):Oo(a);break;default:Oo(a)}}function Ru(a){var r=a.deletions;if((a.flags&16)!==0){if(r!==null)for(var c=0;c<r.length;c++){var m=r[c];ia=m,kv(m,a)}Tv(a)}for(a=a.child;a!==null;){switch(r=a,r.tag){case 0:case 11:case 15:Lr(8,r,r.return),Ru(r);break;case 22:c=r.stateNode,c._visibility&2&&(c._visibility&=-3,Ru(r));break;default:Ru(r)}a=a.sibling}}function kv(a,r){for(;ia!==null;){var c=ia;switch(c.tag){case 0:case 11:case 15:Lr(8,c,r);break;case 23:case 22:if(c.memoizedState!==null&&c.memoizedState.cachePool!==null){var m=c.memoizedState.cachePool.pool;m!=null&&m.refCount++}break;case 24:xo(c.memoizedState.cache)}if(m=c.child,m!==null)m.return=c,ia=m;else e:for(c=a;ia!==null;){m=ia;var x=m.sibling,w=m.return;if(Sv(m),m===c){ia=null;break e}if(x!==null){x.return=w,ia=x;break e}ia=w}}}var GC={getCacheForType:function(a){var r=ua(Zn),c=r.data.get(a);return c===void 0&&(c=a(),r.data.set(a,c)),c},cacheSignal:function(){return ua(Zn).controller.signal}},WC=typeof WeakMap=="function"?WeakMap:Map,En=0,Ln=null,gn=null,xn=0,An=0,qa=null,Dr=!1,gl=!1,hh=!1,or=0,Vn=0,Or=0,Ci=0,ph=0,Pa=0,bl=0,$o=null,ka=null,yh=!1,Iu=0,Rv=0,Lu=1/0,Du=null,$r=null,aa=0,Fr=null,xl=null,cr=0,gh=0,bh=null,Iv=null,Fo=0,xh=null;function Ha(){return(En&2)!==0&&xn!==0?xn&-xn:D.T!==null?Eh():J()}function Lv(){if(Pa===0)if((xn&536870912)===0||Sn){var a=ft;ft<<=1,(ft&3932160)===0&&(ft=262144),Pa=a}else Pa=536870912;return a=Ba.current,a!==null&&(a.flags|=32),Pa}function Ra(a,r,c){(a===Ln&&(An===2||An===9)||a.cancelPendingCommit!==null)&&(vl(a,0),zr(a,xn,Pa,!1)),oe(a,c),((En&2)===0||a!==Ln)&&(a===Ln&&((En&2)===0&&(Ci|=c),Vn===4&&zr(a,xn,Pa,!1)),Ds(a))}function Dv(a,r,c){if((En&6)!==0)throw Error(i(327));var m=!c&&(r&127)===0&&(r&a.expiredLanes)===0||Tt(a,r),x=m?ZC(a,r):Sh(a,r,!0),w=m;do{if(x===0){gl&&!m&&zr(a,r,0,!1);break}else{if(c=a.current.alternate,w&&!XC(c)){x=Sh(a,r,!1),w=!1;continue}if(x===2){if(w=r,a.errorRecoveryDisabledLanes&w)var q=0;else q=a.pendingLanes&-536870913,q=q!==0?q:q&536870912?536870912:0;if(q!==0){r=q;e:{var ne=a;x=$o;var Ae=ne.current.memoizedState.isDehydrated;if(Ae&&(vl(ne,q).flags|=256),q=Sh(ne,q,!1),q!==2){if(hh&&!Ae){ne.errorRecoveryDisabledLanes|=w,Ci|=w,x=4;break e}w=ka,ka=x,w!==null&&(ka===null?ka=w:ka.push.apply(ka,w))}x=q}if(w=!1,x!==2)continue}}if(x===1){vl(a,0),zr(a,r,0,!0);break}e:{switch(m=a,w=x,w){case 0:case 1:throw Error(i(345));case 4:if((r&4194048)!==r)break;case 6:zr(m,r,Pa,!Dr);break e;case 2:ka=null;break;case 3:case 5:break;default:throw Error(i(329))}if((r&62914560)===r&&(x=Iu+300-st(),10<x)){if(zr(m,r,Pa,!Dr),Zt(m,0,!0)!==0)break e;cr=r,m.timeoutHandle=f0(Ov.bind(null,m,c,ka,Du,yh,r,Pa,Ci,bl,Dr,w,"Throttled",-0,0),x);break e}Ov(m,c,ka,Du,yh,r,Pa,Ci,bl,Dr,w,null,-0,0)}}break}while(!0);Ds(a)}function Ov(a,r,c,m,x,w,q,ne,Ae,et,yt,wt,at,ut){if(a.timeoutHandle=-1,wt=r.subtreeFlags,wt&8192||(wt&16785408)===16785408){wt={stylesheets:null,count:0,imgCount:0,imgBytes:0,suspenseyImages:[],waitingForImages:!0,waitingForViewTransition:!1,unsuspend:Oe},Av(r,w,wt);var qt=(w&62914560)===w?Iu-st():(w&4194048)===w?Rv-st():0;if(qt=IA(wt,qt),qt!==null){cr=w,a.cancelPendingCommit=qt(Hv.bind(null,a,r,w,c,m,x,q,ne,Ae,yt,wt,null,at,ut)),zr(a,w,q,!et);return}}Hv(a,r,w,c,m,x,q,ne,Ae)}function XC(a){for(var r=a;;){var c=r.tag;if((c===0||c===11||c===15)&&r.flags&16384&&(c=r.updateQueue,c!==null&&(c=c.stores,c!==null)))for(var m=0;m<c.length;m++){var x=c[m],w=x.getSnapshot;x=x.value;try{if(!Fa(w(),x))return!1}catch{return!1}}if(c=r.child,r.subtreeFlags&16384&&c!==null)c.return=r,r=c;else{if(r===a)break;for(;r.sibling===null;){if(r.return===null||r.return===a)return!0;r=r.return}r.sibling.return=r.return,r=r.sibling}}return!0}function zr(a,r,c,m){r&=~ph,r&=~Ci,a.suspendedLanes|=r,a.pingedLanes&=~r,m&&(a.warmLanes|=r),m=a.expirationTimes;for(var x=r;0<x;){var w=31-Te(x),q=1<<w;m[w]=-1,x&=~q}c!==0&&Se(a,c,r)}function Ou(){return(En&6)===0?(zo(0),!1):!0}function vh(){if(gn!==null){if(An===0)var a=gn.return;else a=gn,Qs=bi=null,Om(a),ul=null,So=0,a=gn;for(;a!==null;)mv(a.alternate,a),a=a.return;gn=null}}function vl(a,r){var c=a.timeoutHandle;c!==-1&&(a.timeoutHandle=-1,pA(c)),c=a.cancelPendingCommit,c!==null&&(a.cancelPendingCommit=null,c()),cr=0,vh(),Ln=a,gn=c=Ks(a.current,null),xn=r,An=0,qa=null,Dr=!1,gl=Tt(a,r),hh=!1,bl=Pa=ph=Ci=Or=Vn=0,ka=$o=null,yh=!1,(r&8)!==0&&(r|=r&32);var m=a.entangledLanes;if(m!==0)for(a=a.entanglements,m&=r;0<m;){var x=31-Te(m),w=1<<x;r|=a[x],m&=~w}return or=r,au(),c}function $v(a,r){ln=null,D.H=To,r===cl||r===du?(r=Jb(),An=3):r===jm?(r=Jb(),An=4):An=r===Qm?8:r!==null&&typeof r=="object"&&typeof r.then=="function"?6:1,qa=r,gn===null&&(Vn=1,Eu(a,Qa(r,a.current)))}function Fv(){var a=Ba.current;return a===null?!0:(xn&4194048)===xn?ns===null:(xn&62914560)===xn||(xn&536870912)!==0?a===ns:!1}function zv(){var a=D.H;return D.H=To,a===null?To:a}function Bv(){var a=D.A;return D.A=GC,a}function $u(){Vn=4,Dr||(xn&4194048)!==xn&&Ba.current!==null||(gl=!0),(Or&134217727)===0&&(Ci&134217727)===0||Ln===null||zr(Ln,xn,Pa,!1)}function Sh(a,r,c){var m=En;En|=2;var x=zv(),w=Bv();(Ln!==a||xn!==r)&&(Du=null,vl(a,r)),r=!1;var q=Vn;e:do try{if(An!==0&&gn!==null){var ne=gn,Ae=qa;switch(An){case 8:vh(),q=6;break e;case 3:case 2:case 9:case 6:Ba.current===null&&(r=!0);var et=An;if(An=0,qa=null,Sl(a,ne,Ae,et),c&&gl){q=0;break e}break;default:et=An,An=0,qa=null,Sl(a,ne,Ae,et)}}KC(),q=Vn;break}catch(yt){$v(a,yt)}while(!0);return r&&a.shellSuspendCounter++,Qs=bi=null,En=m,D.H=x,D.A=w,gn===null&&(Ln=null,xn=0,au()),q}function KC(){for(;gn!==null;)Uv(gn)}function ZC(a,r){var c=En;En|=2;var m=zv(),x=Bv();Ln!==a||xn!==r?(Du=null,Lu=st()+500,vl(a,r)):gl=Tt(a,r);e:do try{if(An!==0&&gn!==null){r=gn;var w=qa;t:switch(An){case 1:An=0,qa=null,Sl(a,r,w,1);break;case 2:case 9:if(Zb(w)){An=0,qa=null,qv(r);break}r=function(){An!==2&&An!==9||Ln!==a||(An=7),Ds(a)},w.then(r,r);break e;case 3:An=7;break e;case 4:An=5;break e;case 7:Zb(w)?(An=0,qa=null,qv(r)):(An=0,qa=null,Sl(a,r,w,7));break;case 5:var q=null;switch(gn.tag){case 26:q=gn.memoizedState;case 5:case 27:var ne=gn;if(q?C0(q):ne.stateNode.complete){An=0,qa=null;var Ae=ne.sibling;if(Ae!==null)gn=Ae;else{var et=ne.return;et!==null?(gn=et,Fu(et)):gn=null}break t}}An=0,qa=null,Sl(a,r,w,5);break;case 6:An=0,qa=null,Sl(a,r,w,6);break;case 8:vh(),Vn=6;break e;default:throw Error(i(462))}}QC();break}catch(yt){$v(a,yt)}while(!0);return Qs=bi=null,D.H=m,D.A=x,En=c,gn!==null?0:(Ln=null,xn=0,au(),Vn)}function QC(){for(;gn!==null&&!At();)Uv(gn)}function Uv(a){var r=dv(a.alternate,a,or);a.memoizedProps=a.pendingProps,r===null?Fu(a):gn=r}function qv(a){var r=a,c=r.alternate;switch(r.tag){case 15:case 0:r=rv(c,r,r.pendingProps,r.type,void 0,xn);break;case 11:r=rv(c,r,r.pendingProps,r.type.render,r.ref,xn);break;case 5:Om(r);default:mv(c,r),r=gn=Bb(r,or),r=dv(c,r,or)}a.memoizedProps=a.pendingProps,r===null?Fu(a):gn=r}function Sl(a,r,c,m){Qs=bi=null,Om(r),ul=null,So=0;var x=r.return;try{if(BC(a,x,r,c,xn)){Vn=1,Eu(a,Qa(c,a.current)),gn=null;return}}catch(w){if(x!==null)throw gn=x,w;Vn=1,Eu(a,Qa(c,a.current)),gn=null;return}r.flags&32768?(Sn||m===1?a=!0:gl||(xn&536870912)!==0?a=!1:(Dr=a=!0,(m===2||m===9||m===3||m===6)&&(m=Ba.current,m!==null&&m.tag===13&&(m.flags|=16384))),Pv(r,a)):Fu(r)}function Fu(a){var r=a;do{if((r.flags&32768)!==0){Pv(r,Dr);return}a=r.return;var c=PC(r.alternate,r,or);if(c!==null){gn=c;return}if(r=r.sibling,r!==null){gn=r;return}gn=r=a}while(r!==null);Vn===0&&(Vn=5)}function Pv(a,r){do{var c=HC(a.alternate,a);if(c!==null){c.flags&=32767,gn=c;return}if(c=a.return,c!==null&&(c.flags|=32768,c.subtreeFlags=0,c.deletions=null),!r&&(a=a.sibling,a!==null)){gn=a;return}gn=a=c}while(a!==null);Vn=6,gn=null}function Hv(a,r,c,m,x,w,q,ne,Ae){a.cancelPendingCommit=null;do zu();while(aa!==0);if((En&6)!==0)throw Error(i(327));if(r!==null){if(r===a.current)throw Error(i(177));if(w=r.lanes|r.childLanes,w|=cm,Ee(a,c,w,q,ne,Ae),a===Ln&&(gn=Ln=null,xn=0),xl=r,Fr=a,cr=c,gh=w,bh=x,Iv=m,(r.subtreeFlags&10256)!==0||(r.flags&10256)!==0?(a.callbackNode=null,a.callbackPriority=0,nA(dt,function(){return Xv(),null})):(a.callbackNode=null,a.callbackPriority=0),m=(r.flags&13878)!==0,(r.subtreeFlags&13878)!==0||m){m=D.T,D.T=null,x=O.p,O.p=2,q=En,En|=4;try{VC(a,r,c)}finally{En=q,O.p=x,D.T=m}}aa=1,Vv(),Yv(),Gv()}}function Vv(){if(aa===1){aa=0;var a=Fr,r=xl,c=(r.flags&13878)!==0;if((r.subtreeFlags&13878)!==0||c){c=D.T,D.T=null;var m=O.p;O.p=2;var x=En;En|=4;try{Ev(r,a);var w=Ih,q=kb(a.containerInfo),ne=w.focusedElem,Ae=w.selectionRange;if(q!==ne&&ne&&ne.ownerDocument&&Mb(ne.ownerDocument.documentElement,ne)){if(Ae!==null&&sm(ne)){var et=Ae.start,yt=Ae.end;if(yt===void 0&&(yt=et),"selectionStart"in ne)ne.selectionStart=et,ne.selectionEnd=Math.min(yt,ne.value.length);else{var wt=ne.ownerDocument||document,at=wt&&wt.defaultView||window;if(at.getSelection){var ut=at.getSelection(),qt=ne.textContent.length,Jt=Math.min(Ae.start,qt),In=Ae.end===void 0?Jt:Math.min(Ae.end,qt);!ut.extend&&Jt>In&&(q=In,In=Jt,Jt=q);var ze=Tb(ne,Jt),ke=Tb(ne,In);if(ze&&ke&&(ut.rangeCount!==1||ut.anchorNode!==ze.node||ut.anchorOffset!==ze.offset||ut.focusNode!==ke.node||ut.focusOffset!==ke.offset)){var Qe=wt.createRange();Qe.setStart(ze.node,ze.offset),ut.removeAllRanges(),Jt>In?(ut.addRange(Qe),ut.extend(ke.node,ke.offset)):(Qe.setEnd(ke.node,ke.offset),ut.addRange(Qe))}}}}for(wt=[],ut=ne;ut=ut.parentNode;)ut.nodeType===1&&wt.push({element:ut,left:ut.scrollLeft,top:ut.scrollTop});for(typeof ne.focus=="function"&&ne.focus(),ne=0;ne<wt.length;ne++){var xt=wt[ne];xt.element.scrollLeft=xt.left,xt.element.scrollTop=xt.top}}Zu=!!Rh,Ih=Rh=null}finally{En=x,O.p=m,D.T=c}}a.current=r,aa=2}}function Yv(){if(aa===2){aa=0;var a=Fr,r=xl,c=(r.flags&8772)!==0;if((r.subtreeFlags&8772)!==0||c){c=D.T,D.T=null;var m=O.p;O.p=2;var x=En;En|=4;try{vv(a,r.alternate,r)}finally{En=x,O.p=m,D.T=c}}aa=3}}function Gv(){if(aa===4||aa===3){aa=0,we();var a=Fr,r=xl,c=cr,m=Iv;(r.subtreeFlags&10256)!==0||(r.flags&10256)!==0?aa=5:(aa=0,xl=Fr=null,Wv(a,a.pendingLanes));var x=a.pendingLanes;if(x===0&&($r=null),He(c),r=r.stateNode,Pe&&typeof Pe.onCommitFiberRoot=="function")try{Pe.onCommitFiberRoot(qe,r,void 0,(r.current.flags&128)===128)}catch{}if(m!==null){r=D.T,x=O.p,O.p=2,D.T=null;try{for(var w=a.onRecoverableError,q=0;q<m.length;q++){var ne=m[q];w(ne.value,{componentStack:ne.stack})}}finally{D.T=r,O.p=x}}(cr&3)!==0&&zu(),Ds(a),x=a.pendingLanes,(c&261930)!==0&&(x&42)!==0?a===xh?Fo++:(Fo=0,xh=a):Fo=0,zo(0)}}function Wv(a,r){(a.pooledCacheLanes&=r)===0&&(r=a.pooledCache,r!=null&&(a.pooledCache=null,xo(r)))}function zu(){return Vv(),Yv(),Gv(),Xv()}function Xv(){if(aa!==5)return!1;var a=Fr,r=gh;gh=0;var c=He(cr),m=D.T,x=O.p;try{O.p=32>c?32:c,D.T=null,c=bh,bh=null;var w=Fr,q=cr;if(aa=0,xl=Fr=null,cr=0,(En&6)!==0)throw Error(i(331));var ne=En;if(En|=4,Mv(w.current),Cv(w,w.current,q,c),En=ne,zo(0,!1),Pe&&typeof Pe.onPostCommitFiberRoot=="function")try{Pe.onPostCommitFiberRoot(qe,w)}catch{}return!0}finally{O.p=x,D.T=m,Wv(a,r)}}function Kv(a,r,c){r=Qa(c,r),r=Zm(a.stateNode,r,2),a=kr(a,r,2),a!==null&&(oe(a,2),Ds(a))}function Tn(a,r,c){if(a.tag===3)Kv(a,a,c);else for(;r!==null;){if(r.tag===3){Kv(r,a,c);break}else if(r.tag===1){var m=r.stateNode;if(typeof r.type.getDerivedStateFromError=="function"||typeof m.componentDidCatch=="function"&&($r===null||!$r.has(m))){a=Qa(c,a),c=Zx(2),m=kr(r,c,2),m!==null&&(Qx(c,m,r,a),oe(m,2),Ds(m));break}}r=r.return}}function wh(a,r,c){var m=a.pingCache;if(m===null){m=a.pingCache=new WC;var x=new Set;m.set(r,x)}else x=m.get(r),x===void 0&&(x=new Set,m.set(r,x));x.has(c)||(hh=!0,x.add(c),a=JC.bind(null,a,r,c),r.then(a,a))}function JC(a,r,c){var m=a.pingCache;m!==null&&m.delete(r),a.pingedLanes|=a.suspendedLanes&c,a.warmLanes&=~c,Ln===a&&(xn&c)===c&&(Vn===4||Vn===3&&(xn&62914560)===xn&&300>st()-Iu?(En&2)===0&&vl(a,0):ph|=c,bl===xn&&(bl=0)),Ds(a)}function Zv(a,r){r===0&&(r=it()),a=pi(a,r),a!==null&&(oe(a,r),Ds(a))}function eA(a){var r=a.memoizedState,c=0;r!==null&&(c=r.retryLane),Zv(a,c)}function tA(a,r){var c=0;switch(a.tag){case 31:case 13:var m=a.stateNode,x=a.memoizedState;x!==null&&(c=x.retryLane);break;case 19:m=a.stateNode;break;case 22:m=a.stateNode._retryCache;break;default:throw Error(i(314))}m!==null&&m.delete(r),Zv(a,c)}function nA(a,r){return ht(a,r)}var Bu=null,wl=null,Nh=!1,Uu=!1,jh=!1,Br=0;function Ds(a){a!==wl&&a.next===null&&(wl===null?Bu=wl=a:wl=wl.next=a),Uu=!0,Nh||(Nh=!0,sA())}function zo(a,r){if(!jh&&Uu){jh=!0;do for(var c=!1,m=Bu;m!==null;){if(a!==0){var x=m.pendingLanes;if(x===0)var w=0;else{var q=m.suspendedLanes,ne=m.pingedLanes;w=(1<<31-Te(42|a)+1)-1,w&=x&~(q&~ne),w=w&201326741?w&201326741|1:w?w|2:0}w!==0&&(c=!0,t0(m,w))}else w=xn,w=Zt(m,m===Ln?w:0,m.cancelPendingCommit!==null||m.timeoutHandle!==-1),(w&3)===0||Tt(m,w)||(c=!0,t0(m,w));m=m.next}while(c);jh=!1}}function aA(){Qv()}function Qv(){Uu=Nh=!1;var a=0;Br!==0&&hA()&&(a=Br);for(var r=st(),c=null,m=Bu;m!==null;){var x=m.next,w=Jv(m,r);w===0?(m.next=null,c===null?Bu=x:c.next=x,x===null&&(wl=c)):(c=m,(a!==0||(w&3)!==0)&&(Uu=!0)),m=x}aa!==0&&aa!==5||zo(a),Br!==0&&(Br=0)}function Jv(a,r){for(var c=a.suspendedLanes,m=a.pingedLanes,x=a.expirationTimes,w=a.pendingLanes&-62914561;0<w;){var q=31-Te(w),ne=1<<q,Ae=x[q];Ae===-1?((ne&c)===0||(ne&m)!==0)&&(x[q]=We(ne,r)):Ae<=r&&(a.expiredLanes|=ne),w&=~ne}if(r=Ln,c=xn,c=Zt(a,a===r?c:0,a.cancelPendingCommit!==null||a.timeoutHandle!==-1),m=a.callbackNode,c===0||a===r&&(An===2||An===9)||a.cancelPendingCommit!==null)return m!==null&&m!==null&&Ct(m),a.callbackNode=null,a.callbackPriority=0;if((c&3)===0||Tt(a,c)){if(r=c&-c,r===a.callbackPriority)return r;switch(m!==null&&Ct(m),He(c)){case 2:case 8:c=Xe;break;case 32:c=dt;break;case 268435456:c=ee;break;default:c=dt}return m=e0.bind(null,a),c=ht(c,m),a.callbackPriority=r,a.callbackNode=c,r}return m!==null&&m!==null&&Ct(m),a.callbackPriority=2,a.callbackNode=null,2}function e0(a,r){if(aa!==0&&aa!==5)return a.callbackNode=null,a.callbackPriority=0,null;var c=a.callbackNode;if(zu()&&a.callbackNode!==c)return null;var m=xn;return m=Zt(a,a===Ln?m:0,a.cancelPendingCommit!==null||a.timeoutHandle!==-1),m===0?null:(Dv(a,m,r),Jv(a,st()),a.callbackNode!=null&&a.callbackNode===c?e0.bind(null,a):null)}function t0(a,r){if(zu())return null;Dv(a,r,!0)}function sA(){yA(function(){(En&6)!==0?ht(Fe,aA):Qv()})}function Eh(){if(Br===0){var a=ll;a===0&&(a=tt,tt<<=1,(tt&261888)===0&&(tt=256)),Br=a}return Br}function n0(a){return a==null||typeof a=="symbol"||typeof a=="boolean"?null:typeof a=="function"?a:ye(""+a)}function a0(a,r){var c=r.ownerDocument.createElement("input");return c.name=r.name,c.value=r.value,a.id&&c.setAttribute("form",a.id),r.parentNode.insertBefore(c,r),a=new FormData(a),c.parentNode.removeChild(c),a}function rA(a,r,c,m,x){if(r==="submit"&&c&&c.stateNode===x){var w=n0((x[pe]||null).action),q=m.submitter;q&&(r=(r=q[pe]||null)?n0(r.formAction):q.getAttribute("formAction"),r!==null&&(w=r,q=null));var ne=new Jc("action","action",null,m,x);a.push({event:ne,listeners:[{instance:null,listener:function(){if(m.defaultPrevented){if(Br!==0){var Ae=q?a0(x,q):new FormData(x);Vm(c,{pending:!0,data:Ae,method:x.method,action:w},null,Ae)}}else typeof w=="function"&&(ne.preventDefault(),Ae=q?a0(x,q):new FormData(x),Vm(c,{pending:!0,data:Ae,method:x.method,action:w},w,Ae))},currentTarget:x}]})}}for(var _h=0;_h<om.length;_h++){var Ch=om[_h],iA=Ch.toLowerCase(),lA=Ch[0].toUpperCase()+Ch.slice(1);ys(iA,"on"+lA)}ys(Lb,"onAnimationEnd"),ys(Db,"onAnimationIteration"),ys(Ob,"onAnimationStart"),ys("dblclick","onDoubleClick"),ys("focusin","onFocus"),ys("focusout","onBlur"),ys(NC,"onTransitionRun"),ys(jC,"onTransitionStart"),ys(EC,"onTransitionCancel"),ys($b,"onTransitionEnd"),ve("onMouseEnter",["mouseout","mouseover"]),ve("onMouseLeave",["mouseout","mouseover"]),ve("onPointerEnter",["pointerout","pointerover"]),ve("onPointerLeave",["pointerout","pointerover"]),te("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),te("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),te("onBeforeInput",["compositionend","keypress","textInput","paste"]),te("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),te("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),te("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Bo="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),oA=new Set("beforetoggle cancel close invalid load scroll scrollend toggle".split(" ").concat(Bo));function s0(a,r){r=(r&4)!==0;for(var c=0;c<a.length;c++){var m=a[c],x=m.event;m=m.listeners;e:{var w=void 0;if(r)for(var q=m.length-1;0<=q;q--){var ne=m[q],Ae=ne.instance,et=ne.currentTarget;if(ne=ne.listener,Ae!==w&&x.isPropagationStopped())break e;w=ne,x.currentTarget=et;try{w(x)}catch(yt){nu(yt)}x.currentTarget=null,w=Ae}else for(q=0;q<m.length;q++){if(ne=m[q],Ae=ne.instance,et=ne.currentTarget,ne=ne.listener,Ae!==w&&x.isPropagationStopped())break e;w=ne,x.currentTarget=et;try{w(x)}catch(yt){nu(yt)}x.currentTarget=null,w=Ae}}}}function bn(a,r){var c=r[ae];c===void 0&&(c=r[ae]=new Set);var m=a+"__bubble";c.has(m)||(r0(r,a,2,!1),c.add(m))}function Ah(a,r,c){var m=0;r&&(m|=4),r0(c,a,m,r)}var qu="_reactListening"+Math.random().toString(36).slice(2);function Th(a){if(!a[qu]){a[qu]=!0,Je.forEach(function(c){c!=="selectionchange"&&(oA.has(c)||Ah(c,!1,a),Ah(c,!0,a))});var r=a.nodeType===9?a:a.ownerDocument;r===null||r[qu]||(r[qu]=!0,Ah("selectionchange",!1,r))}}function r0(a,r,c,m){switch(L0(r)){case 2:var x=OA;break;case 8:x=$A;break;default:x=Hh}c=x.bind(null,r,c,a),x=void 0,!en||r!=="touchstart"&&r!=="touchmove"&&r!=="wheel"||(x=!0),m?x!==void 0?a.addEventListener(r,c,{capture:!0,passive:x}):a.addEventListener(r,c,!0):x!==void 0?a.addEventListener(r,c,{passive:x}):a.addEventListener(r,c,!1)}function Mh(a,r,c,m,x){var w=m;if((r&1)===0&&(r&2)===0&&m!==null)e:for(;;){if(m===null)return;var q=m.tag;if(q===3||q===4){var ne=m.stateNode.containerInfo;if(ne===x)break;if(q===4)for(q=m.return;q!==null;){var Ae=q.tag;if((Ae===3||Ae===4)&&q.stateNode.containerInfo===x)return;q=q.return}for(;ne!==null;){if(q=Ge(ne),q===null)return;if(Ae=q.tag,Ae===5||Ae===6||Ae===26||Ae===27){m=w=q;continue e}ne=ne.parentNode}}m=m.return}Ht(function(){var et=w,yt=Qt(c),wt=[];e:{var at=Fb.get(a);if(at!==void 0){var ut=Jc,qt=a;switch(a){case"keypress":if(ks(c)===0)break e;case"keydown":case"keyup":ut=tC;break;case"focusin":qt="focus",ut=Jf;break;case"focusout":qt="blur",ut=Jf;break;case"beforeblur":case"afterblur":ut=Jf;break;case"click":if(c.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":ut=mb;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":ut=P_;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":ut=sC;break;case Lb:case Db:case Ob:ut=Y_;break;case $b:ut=iC;break;case"scroll":case"scrollend":ut=U_;break;case"wheel":ut=oC;break;case"copy":case"cut":case"paste":ut=W_;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":ut=pb;break;case"toggle":case"beforetoggle":ut=uC}var Jt=(r&4)!==0,In=!Jt&&(a==="scroll"||a==="scrollend"),ze=Jt?at!==null?at+"Capture":null:at;Jt=[];for(var ke=et,Qe;ke!==null;){var xt=ke;if(Qe=xt.stateNode,xt=xt.tag,xt!==5&&xt!==26&&xt!==27||Qe===null||ze===null||(xt=tn(ke,ze),xt!=null&&Jt.push(Uo(ke,xt,Qe))),In)break;ke=ke.return}0<Jt.length&&(at=new ut(at,qt,null,c,yt),wt.push({event:at,listeners:Jt}))}}if((r&7)===0){e:{if(at=a==="mouseover"||a==="pointerover",ut=a==="mouseout"||a==="pointerout",at&&c!==$t&&(qt=c.relatedTarget||c.fromElement)&&(Ge(qt)||qt[Ue]))break e;if((ut||at)&&(at=yt.window===yt?yt:(at=yt.ownerDocument)?at.defaultView||at.parentWindow:window,ut?(qt=c.relatedTarget||c.toElement,ut=et,qt=qt?Ge(qt):null,qt!==null&&(In=o(qt),Jt=qt.tag,qt!==In||Jt!==5&&Jt!==27&&Jt!==6)&&(qt=null)):(ut=null,qt=et),ut!==qt)){if(Jt=mb,xt="onMouseLeave",ze="onMouseEnter",ke="mouse",(a==="pointerout"||a==="pointerover")&&(Jt=pb,xt="onPointerLeave",ze="onPointerEnter",ke="pointer"),In=ut==null?at:ct(ut),Qe=qt==null?at:ct(qt),at=new Jt(xt,ke+"leave",ut,c,yt),at.target=In,at.relatedTarget=Qe,xt=null,Ge(yt)===et&&(Jt=new Jt(ze,ke+"enter",qt,c,yt),Jt.target=Qe,Jt.relatedTarget=In,xt=Jt),In=xt,ut&&qt)t:{for(Jt=cA,ze=ut,ke=qt,Qe=0,xt=ze;xt;xt=Jt(xt))Qe++;xt=0;for(var Kt=ke;Kt;Kt=Jt(Kt))xt++;for(;0<Qe-xt;)ze=Jt(ze),Qe--;for(;0<xt-Qe;)ke=Jt(ke),xt--;for(;Qe--;){if(ze===ke||ke!==null&&ze===ke.alternate){Jt=ze;break t}ze=Jt(ze),ke=Jt(ke)}Jt=null}else Jt=null;ut!==null&&i0(wt,at,ut,Jt,!1),qt!==null&&In!==null&&i0(wt,In,qt,Jt,!0)}}e:{if(at=et?ct(et):window,ut=at.nodeName&&at.nodeName.toLowerCase(),ut==="select"||ut==="input"&&at.type==="file")var Nn=Nb;else if(Sb(at))if(jb)Nn=vC;else{Nn=bC;var Vt=gC}else ut=at.nodeName,!ut||ut.toLowerCase()!=="input"||at.type!=="checkbox"&&at.type!=="radio"?et&&di(et.elementType)&&(Nn=Nb):Nn=xC;if(Nn&&(Nn=Nn(a,et))){wb(wt,Nn,c,yt);break e}Vt&&Vt(a,at,et),a==="focusout"&&et&&at.type==="number"&&et.memoizedProps.value!=null&&ui(at,"number",at.value)}switch(Vt=et?ct(et):window,a){case"focusin":(Sb(Vt)||Vt.contentEditable==="true")&&(Ji=Vt,rm=et,yo=null);break;case"focusout":yo=rm=Ji=null;break;case"mousedown":im=!0;break;case"contextmenu":case"mouseup":case"dragend":im=!1,Rb(wt,c,yt);break;case"selectionchange":if(wC)break;case"keydown":case"keyup":Rb(wt,c,yt)}var on;if(tm)e:{switch(a){case"compositionstart":var vn="onCompositionStart";break e;case"compositionend":vn="onCompositionEnd";break e;case"compositionupdate":vn="onCompositionUpdate";break e}vn=void 0}else Qi?xb(a,c)&&(vn="onCompositionEnd"):a==="keydown"&&c.keyCode===229&&(vn="onCompositionStart");vn&&(yb&&c.locale!=="ko"&&(Qi||vn!=="onCompositionStart"?vn==="onCompositionEnd"&&Qi&&(on=ga()):(Pn=yt,oa="value"in Pn?Pn.value:Pn.textContent,Qi=!0)),Vt=Pu(et,vn),0<Vt.length&&(vn=new hb(vn,a,null,c,yt),wt.push({event:vn,listeners:Vt}),on?vn.data=on:(on=vb(c),on!==null&&(vn.data=on)))),(on=fC?mC(a,c):hC(a,c))&&(vn=Pu(et,"onBeforeInput"),0<vn.length&&(Vt=new hb("onBeforeInput","beforeinput",null,c,yt),wt.push({event:Vt,listeners:vn}),Vt.data=on)),rA(wt,a,et,c,yt)}s0(wt,r)})}function Uo(a,r,c){return{instance:a,listener:r,currentTarget:c}}function Pu(a,r){for(var c=r+"Capture",m=[];a!==null;){var x=a,w=x.stateNode;if(x=x.tag,x!==5&&x!==26&&x!==27||w===null||(x=tn(a,c),x!=null&&m.unshift(Uo(a,x,w)),x=tn(a,r),x!=null&&m.push(Uo(a,x,w))),a.tag===3)return m;a=a.return}return[]}function cA(a){if(a===null)return null;do a=a.return;while(a&&a.tag!==5&&a.tag!==27);return a||null}function i0(a,r,c,m,x){for(var w=r._reactName,q=[];c!==null&&c!==m;){var ne=c,Ae=ne.alternate,et=ne.stateNode;if(ne=ne.tag,Ae!==null&&Ae===m)break;ne!==5&&ne!==26&&ne!==27||et===null||(Ae=et,x?(et=tn(c,w),et!=null&&q.unshift(Uo(c,et,Ae))):x||(et=tn(c,w),et!=null&&q.push(Uo(c,et,Ae)))),c=c.return}q.length!==0&&a.push({event:r,listeners:q})}var uA=/\r\n?/g,dA=/\u0000|\uFFFD/g;function l0(a){return(typeof a=="string"?a:""+a).replace(uA,`
`).replace(dA,"")}function o0(a,r){return r=l0(r),l0(a)===r}function Rn(a,r,c,m,x,w){switch(c){case"children":typeof m=="string"?r==="body"||r==="textarea"&&m===""||Ea(a,m):(typeof m=="number"||typeof m=="bigint")&&r!=="body"&&Ea(a,""+m);break;case"className":Pt(a,"class",m);break;case"tabIndex":Pt(a,"tabindex",m);break;case"dir":case"role":case"viewBox":case"width":case"height":Pt(a,c,m);break;case"style":Zi(a,m,w);break;case"data":if(r!=="object"){Pt(a,"data",m);break}case"src":case"href":if(m===""&&(r!=="a"||c!=="href")){a.removeAttribute(c);break}if(m==null||typeof m=="function"||typeof m=="symbol"||typeof m=="boolean"){a.removeAttribute(c);break}m=ye(""+m),a.setAttribute(c,m);break;case"action":case"formAction":if(typeof m=="function"){a.setAttribute(c,"javascript:throw new Error('A React form was unexpectedly submitted. If you called form.submit() manually, consider using form.requestSubmit() instead. If you\\'re trying to use event.stopPropagation() in a submit event handler, consider also calling event.preventDefault().')");break}else typeof w=="function"&&(c==="formAction"?(r!=="input"&&Rn(a,r,"name",x.name,x,null),Rn(a,r,"formEncType",x.formEncType,x,null),Rn(a,r,"formMethod",x.formMethod,x,null),Rn(a,r,"formTarget",x.formTarget,x,null)):(Rn(a,r,"encType",x.encType,x,null),Rn(a,r,"method",x.method,x,null),Rn(a,r,"target",x.target,x,null)));if(m==null||typeof m=="symbol"||typeof m=="boolean"){a.removeAttribute(c);break}m=ye(""+m),a.setAttribute(c,m);break;case"onClick":m!=null&&(a.onclick=Oe);break;case"onScroll":m!=null&&bn("scroll",a);break;case"onScrollEnd":m!=null&&bn("scrollend",a);break;case"dangerouslySetInnerHTML":if(m!=null){if(typeof m!="object"||!("__html"in m))throw Error(i(61));if(c=m.__html,c!=null){if(x.children!=null)throw Error(i(60));a.innerHTML=c}}break;case"multiple":a.multiple=m&&typeof m!="function"&&typeof m!="symbol";break;case"muted":a.muted=m&&typeof m!="function"&&typeof m!="symbol";break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"defaultValue":case"defaultChecked":case"innerHTML":case"ref":break;case"autoFocus":break;case"xlinkHref":if(m==null||typeof m=="function"||typeof m=="boolean"||typeof m=="symbol"){a.removeAttribute("xlink:href");break}c=ye(""+m),a.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",c);break;case"contentEditable":case"spellCheck":case"draggable":case"value":case"autoReverse":case"externalResourcesRequired":case"focusable":case"preserveAlpha":m!=null&&typeof m!="function"&&typeof m!="symbol"?a.setAttribute(c,""+m):a.removeAttribute(c);break;case"inert":case"allowFullScreen":case"async":case"autoPlay":case"controls":case"default":case"defer":case"disabled":case"disablePictureInPicture":case"disableRemotePlayback":case"formNoValidate":case"hidden":case"loop":case"noModule":case"noValidate":case"open":case"playsInline":case"readOnly":case"required":case"reversed":case"scoped":case"seamless":case"itemScope":m&&typeof m!="function"&&typeof m!="symbol"?a.setAttribute(c,""):a.removeAttribute(c);break;case"capture":case"download":m===!0?a.setAttribute(c,""):m!==!1&&m!=null&&typeof m!="function"&&typeof m!="symbol"?a.setAttribute(c,m):a.removeAttribute(c);break;case"cols":case"rows":case"size":case"span":m!=null&&typeof m!="function"&&typeof m!="symbol"&&!isNaN(m)&&1<=m?a.setAttribute(c,m):a.removeAttribute(c);break;case"rowSpan":case"start":m==null||typeof m=="function"||typeof m=="symbol"||isNaN(m)?a.removeAttribute(c):a.setAttribute(c,m);break;case"popover":bn("beforetoggle",a),bn("toggle",a),nn(a,"popover",m);break;case"xlinkActuate":zt(a,"http://www.w3.org/1999/xlink","xlink:actuate",m);break;case"xlinkArcrole":zt(a,"http://www.w3.org/1999/xlink","xlink:arcrole",m);break;case"xlinkRole":zt(a,"http://www.w3.org/1999/xlink","xlink:role",m);break;case"xlinkShow":zt(a,"http://www.w3.org/1999/xlink","xlink:show",m);break;case"xlinkTitle":zt(a,"http://www.w3.org/1999/xlink","xlink:title",m);break;case"xlinkType":zt(a,"http://www.w3.org/1999/xlink","xlink:type",m);break;case"xmlBase":zt(a,"http://www.w3.org/XML/1998/namespace","xml:base",m);break;case"xmlLang":zt(a,"http://www.w3.org/XML/1998/namespace","xml:lang",m);break;case"xmlSpace":zt(a,"http://www.w3.org/XML/1998/namespace","xml:space",m);break;case"is":nn(a,"is",m);break;case"innerText":case"textContent":break;default:(!(2<c.length)||c[0]!=="o"&&c[0]!=="O"||c[1]!=="n"&&c[1]!=="N")&&(c=lo.get(c)||c,nn(a,c,m))}}function kh(a,r,c,m,x,w){switch(c){case"style":Zi(a,m,w);break;case"dangerouslySetInnerHTML":if(m!=null){if(typeof m!="object"||!("__html"in m))throw Error(i(61));if(c=m.__html,c!=null){if(x.children!=null)throw Error(i(60));a.innerHTML=c}}break;case"children":typeof m=="string"?Ea(a,m):(typeof m=="number"||typeof m=="bigint")&&Ea(a,""+m);break;case"onScroll":m!=null&&bn("scroll",a);break;case"onScrollEnd":m!=null&&bn("scrollend",a);break;case"onClick":m!=null&&(a.onclick=Oe);break;case"suppressContentEditableWarning":case"suppressHydrationWarning":case"innerHTML":case"ref":break;case"innerText":case"textContent":break;default:if(!Et.hasOwnProperty(c))e:{if(c[0]==="o"&&c[1]==="n"&&(x=c.endsWith("Capture"),r=c.slice(2,x?c.length-7:void 0),w=a[pe]||null,w=w!=null?w[c]:null,typeof w=="function"&&a.removeEventListener(r,w,x),typeof m=="function")){typeof w!="function"&&w!==null&&(c in a?a[c]=null:a.hasAttribute(c)&&a.removeAttribute(c)),a.addEventListener(r,m,x);break e}c in a?a[c]=m:m===!0?a.setAttribute(c,""):nn(a,c,m)}}}function fa(a,r,c){switch(r){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"img":bn("error",a),bn("load",a);var m=!1,x=!1,w;for(w in c)if(c.hasOwnProperty(w)){var q=c[w];if(q!=null)switch(w){case"src":m=!0;break;case"srcSet":x=!0;break;case"children":case"dangerouslySetInnerHTML":throw Error(i(137,r));default:Rn(a,r,w,q,c,null)}}x&&Rn(a,r,"srcSet",c.srcSet,c,null),m&&Rn(a,r,"src",c.src,c,null);return;case"input":bn("invalid",a);var ne=w=q=x=null,Ae=null,et=null;for(m in c)if(c.hasOwnProperty(m)){var yt=c[m];if(yt!=null)switch(m){case"name":x=yt;break;case"type":q=yt;break;case"checked":Ae=yt;break;case"defaultChecked":et=yt;break;case"value":w=yt;break;case"defaultValue":ne=yt;break;case"children":case"dangerouslySetInnerHTML":if(yt!=null)throw Error(i(137,r));break;default:Rn(a,r,m,yt,c,null)}}jr(a,w,ne,Ae,et,q,x,!1);return;case"select":bn("invalid",a),m=q=w=null;for(x in c)if(c.hasOwnProperty(x)&&(ne=c[x],ne!=null))switch(x){case"value":w=ne;break;case"defaultValue":q=ne;break;case"multiple":m=ne;default:Rn(a,r,x,ne,c,null)}r=w,c=q,a.multiple=!!m,r!=null?ps(a,!!m,r,!1):c!=null&&ps(a,!!m,c,!0);return;case"textarea":bn("invalid",a),w=x=m=null;for(q in c)if(c.hasOwnProperty(q)&&(ne=c[q],ne!=null))switch(q){case"value":m=ne;break;case"defaultValue":x=ne;break;case"children":w=ne;break;case"dangerouslySetInnerHTML":if(ne!=null)throw Error(i(91));break;default:Rn(a,r,q,ne,c,null)}Xs(a,m,x,w);return;case"option":for(Ae in c)if(c.hasOwnProperty(Ae)&&(m=c[Ae],m!=null))switch(Ae){case"selected":a.selected=m&&typeof m!="function"&&typeof m!="symbol";break;default:Rn(a,r,Ae,m,c,null)}return;case"dialog":bn("beforetoggle",a),bn("toggle",a),bn("cancel",a),bn("close",a);break;case"iframe":case"object":bn("load",a);break;case"video":case"audio":for(m=0;m<Bo.length;m++)bn(Bo[m],a);break;case"image":bn("error",a),bn("load",a);break;case"details":bn("toggle",a);break;case"embed":case"source":case"link":bn("error",a),bn("load",a);case"area":case"base":case"br":case"col":case"hr":case"keygen":case"meta":case"param":case"track":case"wbr":case"menuitem":for(et in c)if(c.hasOwnProperty(et)&&(m=c[et],m!=null))switch(et){case"children":case"dangerouslySetInnerHTML":throw Error(i(137,r));default:Rn(a,r,et,m,c,null)}return;default:if(di(r)){for(yt in c)c.hasOwnProperty(yt)&&(m=c[yt],m!==void 0&&kh(a,r,yt,m,c,void 0));return}}for(ne in c)c.hasOwnProperty(ne)&&(m=c[ne],m!=null&&Rn(a,r,ne,m,c,null))}function fA(a,r,c,m){switch(r){case"div":case"span":case"svg":case"path":case"a":case"g":case"p":case"li":break;case"input":var x=null,w=null,q=null,ne=null,Ae=null,et=null,yt=null;for(ut in c){var wt=c[ut];if(c.hasOwnProperty(ut)&&wt!=null)switch(ut){case"checked":break;case"value":break;case"defaultValue":Ae=wt;default:m.hasOwnProperty(ut)||Rn(a,r,ut,null,m,wt)}}for(var at in m){var ut=m[at];if(wt=c[at],m.hasOwnProperty(at)&&(ut!=null||wt!=null))switch(at){case"type":w=ut;break;case"name":x=ut;break;case"checked":et=ut;break;case"defaultChecked":yt=ut;break;case"value":q=ut;break;case"defaultValue":ne=ut;break;case"children":case"dangerouslySetInnerHTML":if(ut!=null)throw Error(i(137,r));break;default:ut!==wt&&Rn(a,r,at,ut,m,wt)}}hs(a,q,ne,Ae,et,yt,w,x);return;case"select":ut=q=ne=at=null;for(w in c)if(Ae=c[w],c.hasOwnProperty(w)&&Ae!=null)switch(w){case"value":break;case"multiple":ut=Ae;default:m.hasOwnProperty(w)||Rn(a,r,w,null,m,Ae)}for(x in m)if(w=m[x],Ae=c[x],m.hasOwnProperty(x)&&(w!=null||Ae!=null))switch(x){case"value":at=w;break;case"defaultValue":ne=w;break;case"multiple":q=w;default:w!==Ae&&Rn(a,r,x,w,m,Ae)}r=ne,c=q,m=ut,at!=null?ps(a,!!c,at,!1):!!m!=!!c&&(r!=null?ps(a,!!c,r,!0):ps(a,!!c,c?[]:"",!1));return;case"textarea":ut=at=null;for(ne in c)if(x=c[ne],c.hasOwnProperty(ne)&&x!=null&&!m.hasOwnProperty(ne))switch(ne){case"value":break;case"children":break;default:Rn(a,r,ne,null,m,x)}for(q in m)if(x=m[q],w=c[q],m.hasOwnProperty(q)&&(x!=null||w!=null))switch(q){case"value":at=x;break;case"defaultValue":ut=x;break;case"children":break;case"dangerouslySetInnerHTML":if(x!=null)throw Error(i(91));break;default:x!==w&&Rn(a,r,q,x,m,w)}qn(a,at,ut);return;case"option":for(var qt in c)if(at=c[qt],c.hasOwnProperty(qt)&&at!=null&&!m.hasOwnProperty(qt))switch(qt){case"selected":a.selected=!1;break;default:Rn(a,r,qt,null,m,at)}for(Ae in m)if(at=m[Ae],ut=c[Ae],m.hasOwnProperty(Ae)&&at!==ut&&(at!=null||ut!=null))switch(Ae){case"selected":a.selected=at&&typeof at!="function"&&typeof at!="symbol";break;default:Rn(a,r,Ae,at,m,ut)}return;case"img":case"link":case"area":case"base":case"br":case"col":case"embed":case"hr":case"keygen":case"meta":case"param":case"source":case"track":case"wbr":case"menuitem":for(var Jt in c)at=c[Jt],c.hasOwnProperty(Jt)&&at!=null&&!m.hasOwnProperty(Jt)&&Rn(a,r,Jt,null,m,at);for(et in m)if(at=m[et],ut=c[et],m.hasOwnProperty(et)&&at!==ut&&(at!=null||ut!=null))switch(et){case"children":case"dangerouslySetInnerHTML":if(at!=null)throw Error(i(137,r));break;default:Rn(a,r,et,at,m,ut)}return;default:if(di(r)){for(var In in c)at=c[In],c.hasOwnProperty(In)&&at!==void 0&&!m.hasOwnProperty(In)&&kh(a,r,In,void 0,m,at);for(yt in m)at=m[yt],ut=c[yt],!m.hasOwnProperty(yt)||at===ut||at===void 0&&ut===void 0||kh(a,r,yt,at,m,ut);return}}for(var ze in c)at=c[ze],c.hasOwnProperty(ze)&&at!=null&&!m.hasOwnProperty(ze)&&Rn(a,r,ze,null,m,at);for(wt in m)at=m[wt],ut=c[wt],!m.hasOwnProperty(wt)||at===ut||at==null&&ut==null||Rn(a,r,wt,at,m,ut)}function c0(a){switch(a){case"css":case"script":case"font":case"img":case"image":case"input":case"link":return!0;default:return!1}}function mA(){if(typeof performance.getEntriesByType=="function"){for(var a=0,r=0,c=performance.getEntriesByType("resource"),m=0;m<c.length;m++){var x=c[m],w=x.transferSize,q=x.initiatorType,ne=x.duration;if(w&&ne&&c0(q)){for(q=0,ne=x.responseEnd,m+=1;m<c.length;m++){var Ae=c[m],et=Ae.startTime;if(et>ne)break;var yt=Ae.transferSize,wt=Ae.initiatorType;yt&&c0(wt)&&(Ae=Ae.responseEnd,q+=yt*(Ae<ne?1:(ne-et)/(Ae-et)))}if(--m,r+=8*(w+q)/(x.duration/1e3),a++,10<a)break}}if(0<a)return r/a/1e6}return navigator.connection&&(a=navigator.connection.downlink,typeof a=="number")?a:5}var Rh=null,Ih=null;function Hu(a){return a.nodeType===9?a:a.ownerDocument}function u0(a){switch(a){case"http://www.w3.org/2000/svg":return 1;case"http://www.w3.org/1998/Math/MathML":return 2;default:return 0}}function d0(a,r){if(a===0)switch(r){case"svg":return 1;case"math":return 2;default:return 0}return a===1&&r==="foreignObject"?0:a}function Lh(a,r){return a==="textarea"||a==="noscript"||typeof r.children=="string"||typeof r.children=="number"||typeof r.children=="bigint"||typeof r.dangerouslySetInnerHTML=="object"&&r.dangerouslySetInnerHTML!==null&&r.dangerouslySetInnerHTML.__html!=null}var Dh=null;function hA(){var a=window.event;return a&&a.type==="popstate"?a===Dh?!1:(Dh=a,!0):(Dh=null,!1)}var f0=typeof setTimeout=="function"?setTimeout:void 0,pA=typeof clearTimeout=="function"?clearTimeout:void 0,m0=typeof Promise=="function"?Promise:void 0,yA=typeof queueMicrotask=="function"?queueMicrotask:typeof m0<"u"?function(a){return m0.resolve(null).then(a).catch(gA)}:f0;function gA(a){setTimeout(function(){throw a})}function Ur(a){return a==="head"}function h0(a,r){var c=r,m=0;do{var x=c.nextSibling;if(a.removeChild(c),x&&x.nodeType===8)if(c=x.data,c==="/$"||c==="/&"){if(m===0){a.removeChild(x),_l(r);return}m--}else if(c==="$"||c==="$?"||c==="$~"||c==="$!"||c==="&")m++;else if(c==="html")qo(a.ownerDocument.documentElement);else if(c==="head"){c=a.ownerDocument.head,qo(c);for(var w=c.firstChild;w;){var q=w.nextSibling,ne=w.nodeName;w[me]||ne==="SCRIPT"||ne==="STYLE"||ne==="LINK"&&w.rel.toLowerCase()==="stylesheet"||c.removeChild(w),w=q}}else c==="body"&&qo(a.ownerDocument.body);c=x}while(c);_l(r)}function p0(a,r){var c=a;a=0;do{var m=c.nextSibling;if(c.nodeType===1?r?(c._stashedDisplay=c.style.display,c.style.display="none"):(c.style.display=c._stashedDisplay||"",c.getAttribute("style")===""&&c.removeAttribute("style")):c.nodeType===3&&(r?(c._stashedText=c.nodeValue,c.nodeValue=""):c.nodeValue=c._stashedText||""),m&&m.nodeType===8)if(c=m.data,c==="/$"){if(a===0)break;a--}else c!=="$"&&c!=="$?"&&c!=="$~"&&c!=="$!"||a++;c=m}while(c)}function Oh(a){var r=a.firstChild;for(r&&r.nodeType===10&&(r=r.nextSibling);r;){var c=r;switch(r=r.nextSibling,c.nodeName){case"HTML":case"HEAD":case"BODY":Oh(c),nt(c);continue;case"SCRIPT":case"STYLE":continue;case"LINK":if(c.rel.toLowerCase()==="stylesheet")continue}a.removeChild(c)}}function bA(a,r,c,m){for(;a.nodeType===1;){var x=c;if(a.nodeName.toLowerCase()!==r.toLowerCase()){if(!m&&(a.nodeName!=="INPUT"||a.type!=="hidden"))break}else if(m){if(!a[me])switch(r){case"meta":if(!a.hasAttribute("itemprop"))break;return a;case"link":if(w=a.getAttribute("rel"),w==="stylesheet"&&a.hasAttribute("data-precedence"))break;if(w!==x.rel||a.getAttribute("href")!==(x.href==null||x.href===""?null:x.href)||a.getAttribute("crossorigin")!==(x.crossOrigin==null?null:x.crossOrigin)||a.getAttribute("title")!==(x.title==null?null:x.title))break;return a;case"style":if(a.hasAttribute("data-precedence"))break;return a;case"script":if(w=a.getAttribute("src"),(w!==(x.src==null?null:x.src)||a.getAttribute("type")!==(x.type==null?null:x.type)||a.getAttribute("crossorigin")!==(x.crossOrigin==null?null:x.crossOrigin))&&w&&a.hasAttribute("async")&&!a.hasAttribute("itemprop"))break;return a;default:return a}}else if(r==="input"&&a.type==="hidden"){var w=x.name==null?null:""+x.name;if(x.type==="hidden"&&a.getAttribute("name")===w)return a}else return a;if(a=as(a.nextSibling),a===null)break}return null}function xA(a,r,c){if(r==="")return null;for(;a.nodeType!==3;)if((a.nodeType!==1||a.nodeName!=="INPUT"||a.type!=="hidden")&&!c||(a=as(a.nextSibling),a===null))return null;return a}function y0(a,r){for(;a.nodeType!==8;)if((a.nodeType!==1||a.nodeName!=="INPUT"||a.type!=="hidden")&&!r||(a=as(a.nextSibling),a===null))return null;return a}function $h(a){return a.data==="$?"||a.data==="$~"}function Fh(a){return a.data==="$!"||a.data==="$?"&&a.ownerDocument.readyState!=="loading"}function vA(a,r){var c=a.ownerDocument;if(a.data==="$~")a._reactRetry=r;else if(a.data!=="$?"||c.readyState!=="loading")r();else{var m=function(){r(),c.removeEventListener("DOMContentLoaded",m)};c.addEventListener("DOMContentLoaded",m),a._reactRetry=m}}function as(a){for(;a!=null;a=a.nextSibling){var r=a.nodeType;if(r===1||r===3)break;if(r===8){if(r=a.data,r==="$"||r==="$!"||r==="$?"||r==="$~"||r==="&"||r==="F!"||r==="F")break;if(r==="/$"||r==="/&")return null}}return a}var zh=null;function g0(a){a=a.nextSibling;for(var r=0;a;){if(a.nodeType===8){var c=a.data;if(c==="/$"||c==="/&"){if(r===0)return as(a.nextSibling);r--}else c!=="$"&&c!=="$!"&&c!=="$?"&&c!=="$~"&&c!=="&"||r++}a=a.nextSibling}return null}function b0(a){a=a.previousSibling;for(var r=0;a;){if(a.nodeType===8){var c=a.data;if(c==="$"||c==="$!"||c==="$?"||c==="$~"||c==="&"){if(r===0)return a;r--}else c!=="/$"&&c!=="/&"||r++}a=a.previousSibling}return null}function x0(a,r,c){switch(r=Hu(c),a){case"html":if(a=r.documentElement,!a)throw Error(i(452));return a;case"head":if(a=r.head,!a)throw Error(i(453));return a;case"body":if(a=r.body,!a)throw Error(i(454));return a;default:throw Error(i(451))}}function qo(a){for(var r=a.attributes;r.length;)a.removeAttributeNode(r[0]);nt(a)}var ss=new Map,v0=new Set;function Vu(a){return typeof a.getRootNode=="function"?a.getRootNode():a.nodeType===9?a:a.ownerDocument}var ur=O.d;O.d={f:SA,r:wA,D:NA,C:jA,L:EA,m:_A,X:AA,S:CA,M:TA};function SA(){var a=ur.f(),r=Ou();return a||r}function wA(a){var r=vt(a);r!==null&&r.tag===5&&r.type==="form"?$x(r):ur.r(a)}var Nl=typeof document>"u"?null:document;function S0(a,r,c){var m=Nl;if(m&&typeof r=="string"&&r){var x=na(r);x='link[rel="'+a+'"][href="'+x+'"]',typeof c=="string"&&(x+='[crossorigin="'+c+'"]'),v0.has(x)||(v0.add(x),a={rel:a,crossOrigin:c,href:r},m.querySelector(x)===null&&(r=m.createElement("link"),fa(r,"link",a),Ye(r),m.head.appendChild(r)))}}function NA(a){ur.D(a),S0("dns-prefetch",a,null)}function jA(a,r){ur.C(a,r),S0("preconnect",a,r)}function EA(a,r,c){ur.L(a,r,c);var m=Nl;if(m&&a&&r){var x='link[rel="preload"][as="'+na(r)+'"]';r==="image"&&c&&c.imageSrcSet?(x+='[imagesrcset="'+na(c.imageSrcSet)+'"]',typeof c.imageSizes=="string"&&(x+='[imagesizes="'+na(c.imageSizes)+'"]')):x+='[href="'+na(a)+'"]';var w=x;switch(r){case"style":w=jl(a);break;case"script":w=El(a)}ss.has(w)||(a=g({rel:"preload",href:r==="image"&&c&&c.imageSrcSet?void 0:a,as:r},c),ss.set(w,a),m.querySelector(x)!==null||r==="style"&&m.querySelector(Po(w))||r==="script"&&m.querySelector(Ho(w))||(r=m.createElement("link"),fa(r,"link",a),Ye(r),m.head.appendChild(r)))}}function _A(a,r){ur.m(a,r);var c=Nl;if(c&&a){var m=r&&typeof r.as=="string"?r.as:"script",x='link[rel="modulepreload"][as="'+na(m)+'"][href="'+na(a)+'"]',w=x;switch(m){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":w=El(a)}if(!ss.has(w)&&(a=g({rel:"modulepreload",href:a},r),ss.set(w,a),c.querySelector(x)===null)){switch(m){case"audioworklet":case"paintworklet":case"serviceworker":case"sharedworker":case"worker":case"script":if(c.querySelector(Ho(w)))return}m=c.createElement("link"),fa(m,"link",a),Ye(m),c.head.appendChild(m)}}}function CA(a,r,c){ur.S(a,r,c);var m=Nl;if(m&&a){var x=Nt(m).hoistableStyles,w=jl(a);r=r||"default";var q=x.get(w);if(!q){var ne={loading:0,preload:null};if(q=m.querySelector(Po(w)))ne.loading=5;else{a=g({rel:"stylesheet",href:a,"data-precedence":r},c),(c=ss.get(w))&&Bh(a,c);var Ae=q=m.createElement("link");Ye(Ae),fa(Ae,"link",a),Ae._p=new Promise(function(et,yt){Ae.onload=et,Ae.onerror=yt}),Ae.addEventListener("load",function(){ne.loading|=1}),Ae.addEventListener("error",function(){ne.loading|=2}),ne.loading|=4,Yu(q,r,m)}q={type:"stylesheet",instance:q,count:1,state:ne},x.set(w,q)}}}function AA(a,r){ur.X(a,r);var c=Nl;if(c&&a){var m=Nt(c).hoistableScripts,x=El(a),w=m.get(x);w||(w=c.querySelector(Ho(x)),w||(a=g({src:a,async:!0},r),(r=ss.get(x))&&Uh(a,r),w=c.createElement("script"),Ye(w),fa(w,"link",a),c.head.appendChild(w)),w={type:"script",instance:w,count:1,state:null},m.set(x,w))}}function TA(a,r){ur.M(a,r);var c=Nl;if(c&&a){var m=Nt(c).hoistableScripts,x=El(a),w=m.get(x);w||(w=c.querySelector(Ho(x)),w||(a=g({src:a,async:!0,type:"module"},r),(r=ss.get(x))&&Uh(a,r),w=c.createElement("script"),Ye(w),fa(w,"link",a),c.head.appendChild(w)),w={type:"script",instance:w,count:1,state:null},m.set(x,w))}}function w0(a,r,c,m){var x=(x=K.current)?Vu(x):null;if(!x)throw Error(i(446));switch(a){case"meta":case"title":return null;case"style":return typeof c.precedence=="string"&&typeof c.href=="string"?(r=jl(c.href),c=Nt(x).hoistableStyles,m=c.get(r),m||(m={type:"style",instance:null,count:0,state:null},c.set(r,m)),m):{type:"void",instance:null,count:0,state:null};case"link":if(c.rel==="stylesheet"&&typeof c.href=="string"&&typeof c.precedence=="string"){a=jl(c.href);var w=Nt(x).hoistableStyles,q=w.get(a);if(q||(x=x.ownerDocument||x,q={type:"stylesheet",instance:null,count:0,state:{loading:0,preload:null}},w.set(a,q),(w=x.querySelector(Po(a)))&&!w._p&&(q.instance=w,q.state.loading=5),ss.has(a)||(c={rel:"preload",as:"style",href:c.href,crossOrigin:c.crossOrigin,integrity:c.integrity,media:c.media,hrefLang:c.hrefLang,referrerPolicy:c.referrerPolicy},ss.set(a,c),w||MA(x,a,c,q.state))),r&&m===null)throw Error(i(528,""));return q}if(r&&m!==null)throw Error(i(529,""));return null;case"script":return r=c.async,c=c.src,typeof c=="string"&&r&&typeof r!="function"&&typeof r!="symbol"?(r=El(c),c=Nt(x).hoistableScripts,m=c.get(r),m||(m={type:"script",instance:null,count:0,state:null},c.set(r,m)),m):{type:"void",instance:null,count:0,state:null};default:throw Error(i(444,a))}}function jl(a){return'href="'+na(a)+'"'}function Po(a){return'link[rel="stylesheet"]['+a+"]"}function N0(a){return g({},a,{"data-precedence":a.precedence,precedence:null})}function MA(a,r,c,m){a.querySelector('link[rel="preload"][as="style"]['+r+"]")?m.loading=1:(r=a.createElement("link"),m.preload=r,r.addEventListener("load",function(){return m.loading|=1}),r.addEventListener("error",function(){return m.loading|=2}),fa(r,"link",c),Ye(r),a.head.appendChild(r))}function El(a){return'[src="'+na(a)+'"]'}function Ho(a){return"script[async]"+a}function j0(a,r,c){if(r.count++,r.instance===null)switch(r.type){case"style":var m=a.querySelector('style[data-href~="'+na(c.href)+'"]');if(m)return r.instance=m,Ye(m),m;var x=g({},c,{"data-href":c.href,"data-precedence":c.precedence,href:null,precedence:null});return m=(a.ownerDocument||a).createElement("style"),Ye(m),fa(m,"style",x),Yu(m,c.precedence,a),r.instance=m;case"stylesheet":x=jl(c.href);var w=a.querySelector(Po(x));if(w)return r.state.loading|=4,r.instance=w,Ye(w),w;m=N0(c),(x=ss.get(x))&&Bh(m,x),w=(a.ownerDocument||a).createElement("link"),Ye(w);var q=w;return q._p=new Promise(function(ne,Ae){q.onload=ne,q.onerror=Ae}),fa(w,"link",m),r.state.loading|=4,Yu(w,c.precedence,a),r.instance=w;case"script":return w=El(c.src),(x=a.querySelector(Ho(w)))?(r.instance=x,Ye(x),x):(m=c,(x=ss.get(w))&&(m=g({},c),Uh(m,x)),a=a.ownerDocument||a,x=a.createElement("script"),Ye(x),fa(x,"link",m),a.head.appendChild(x),r.instance=x);case"void":return null;default:throw Error(i(443,r.type))}else r.type==="stylesheet"&&(r.state.loading&4)===0&&(m=r.instance,r.state.loading|=4,Yu(m,c.precedence,a));return r.instance}function Yu(a,r,c){for(var m=c.querySelectorAll('link[rel="stylesheet"][data-precedence],style[data-precedence]'),x=m.length?m[m.length-1]:null,w=x,q=0;q<m.length;q++){var ne=m[q];if(ne.dataset.precedence===r)w=ne;else if(w!==x)break}w?w.parentNode.insertBefore(a,w.nextSibling):(r=c.nodeType===9?c.head:c,r.insertBefore(a,r.firstChild))}function Bh(a,r){a.crossOrigin==null&&(a.crossOrigin=r.crossOrigin),a.referrerPolicy==null&&(a.referrerPolicy=r.referrerPolicy),a.title==null&&(a.title=r.title)}function Uh(a,r){a.crossOrigin==null&&(a.crossOrigin=r.crossOrigin),a.referrerPolicy==null&&(a.referrerPolicy=r.referrerPolicy),a.integrity==null&&(a.integrity=r.integrity)}var Gu=null;function E0(a,r,c){if(Gu===null){var m=new Map,x=Gu=new Map;x.set(c,m)}else x=Gu,m=x.get(c),m||(m=new Map,x.set(c,m));if(m.has(a))return m;for(m.set(a,null),c=c.getElementsByTagName(a),x=0;x<c.length;x++){var w=c[x];if(!(w[me]||w[Ne]||a==="link"&&w.getAttribute("rel")==="stylesheet")&&w.namespaceURI!=="http://www.w3.org/2000/svg"){var q=w.getAttribute(r)||"";q=a+q;var ne=m.get(q);ne?ne.push(w):m.set(q,[w])}}return m}function _0(a,r,c){a=a.ownerDocument||a,a.head.insertBefore(c,r==="title"?a.querySelector("head > title"):null)}function kA(a,r,c){if(c===1||r.itemProp!=null)return!1;switch(a){case"meta":case"title":return!0;case"style":if(typeof r.precedence!="string"||typeof r.href!="string"||r.href==="")break;return!0;case"link":if(typeof r.rel!="string"||typeof r.href!="string"||r.href===""||r.onLoad||r.onError)break;switch(r.rel){case"stylesheet":return a=r.disabled,typeof r.precedence=="string"&&a==null;default:return!0}case"script":if(r.async&&typeof r.async!="function"&&typeof r.async!="symbol"&&!r.onLoad&&!r.onError&&r.src&&typeof r.src=="string")return!0}return!1}function C0(a){return!(a.type==="stylesheet"&&(a.state.loading&3)===0)}function RA(a,r,c,m){if(c.type==="stylesheet"&&(typeof m.media!="string"||matchMedia(m.media).matches!==!1)&&(c.state.loading&4)===0){if(c.instance===null){var x=jl(m.href),w=r.querySelector(Po(x));if(w){r=w._p,r!==null&&typeof r=="object"&&typeof r.then=="function"&&(a.count++,a=Wu.bind(a),r.then(a,a)),c.state.loading|=4,c.instance=w,Ye(w);return}w=r.ownerDocument||r,m=N0(m),(x=ss.get(x))&&Bh(m,x),w=w.createElement("link"),Ye(w);var q=w;q._p=new Promise(function(ne,Ae){q.onload=ne,q.onerror=Ae}),fa(w,"link",m),c.instance=w}a.stylesheets===null&&(a.stylesheets=new Map),a.stylesheets.set(c,r),(r=c.state.preload)&&(c.state.loading&3)===0&&(a.count++,c=Wu.bind(a),r.addEventListener("load",c),r.addEventListener("error",c))}}var qh=0;function IA(a,r){return a.stylesheets&&a.count===0&&Ku(a,a.stylesheets),0<a.count||0<a.imgCount?function(c){var m=setTimeout(function(){if(a.stylesheets&&Ku(a,a.stylesheets),a.unsuspend){var w=a.unsuspend;a.unsuspend=null,w()}},6e4+r);0<a.imgBytes&&qh===0&&(qh=62500*mA());var x=setTimeout(function(){if(a.waitingForImages=!1,a.count===0&&(a.stylesheets&&Ku(a,a.stylesheets),a.unsuspend)){var w=a.unsuspend;a.unsuspend=null,w()}},(a.imgBytes>qh?50:800)+r);return a.unsuspend=c,function(){a.unsuspend=null,clearTimeout(m),clearTimeout(x)}}:null}function Wu(){if(this.count--,this.count===0&&(this.imgCount===0||!this.waitingForImages)){if(this.stylesheets)Ku(this,this.stylesheets);else if(this.unsuspend){var a=this.unsuspend;this.unsuspend=null,a()}}}var Xu=null;function Ku(a,r){a.stylesheets=null,a.unsuspend!==null&&(a.count++,Xu=new Map,r.forEach(LA,a),Xu=null,Wu.call(a))}function LA(a,r){if(!(r.state.loading&4)){var c=Xu.get(a);if(c)var m=c.get(null);else{c=new Map,Xu.set(a,c);for(var x=a.querySelectorAll("link[data-precedence],style[data-precedence]"),w=0;w<x.length;w++){var q=x[w];(q.nodeName==="LINK"||q.getAttribute("media")!=="not all")&&(c.set(q.dataset.precedence,q),m=q)}m&&c.set(null,m)}x=r.instance,q=x.getAttribute("data-precedence"),w=c.get(q)||m,w===m&&c.set(null,x),c.set(q,x),this.count++,m=Wu.bind(this),x.addEventListener("load",m),x.addEventListener("error",m),w?w.parentNode.insertBefore(x,w.nextSibling):(a=a.nodeType===9?a.head:a,a.insertBefore(x,a.firstChild)),r.state.loading|=4}}var Vo={$$typeof:M,Provider:null,Consumer:null,_currentValue:$,_currentValue2:$,_threadCount:0};function DA(a,r,c,m,x,w,q,ne,Ae){this.tag=1,this.containerInfo=a,this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.next=this.pendingContext=this.context=this.cancelPendingCommit=null,this.callbackPriority=0,this.expirationTimes=bt(-1),this.entangledLanes=this.shellSuspendCounter=this.errorRecoveryDisabledLanes=this.expiredLanes=this.warmLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=bt(0),this.hiddenUpdates=bt(null),this.identifierPrefix=m,this.onUncaughtError=x,this.onCaughtError=w,this.onRecoverableError=q,this.pooledCache=null,this.pooledCacheLanes=0,this.formState=Ae,this.incompleteTransitions=new Map}function A0(a,r,c,m,x,w,q,ne,Ae,et,yt,wt){return a=new DA(a,r,c,q,Ae,et,yt,wt,ne),r=1,w===!0&&(r|=24),w=za(3,null,null,r),a.current=w,w.stateNode=a,r=Sm(),r.refCount++,a.pooledCache=r,r.refCount++,w.memoizedState={element:m,isDehydrated:c,cache:r},Em(w),a}function T0(a){return a?(a=nl,a):nl}function M0(a,r,c,m,x,w){x=T0(x),m.context===null?m.context=x:m.pendingContext=x,m=Mr(r),m.payload={element:c},w=w===void 0?null:w,w!==null&&(m.callback=w),c=kr(a,m,r),c!==null&&(Ra(c,a,r),No(c,a,r))}function k0(a,r){if(a=a.memoizedState,a!==null&&a.dehydrated!==null){var c=a.retryLane;a.retryLane=c!==0&&c<r?c:r}}function Ph(a,r){k0(a,r),(a=a.alternate)&&k0(a,r)}function R0(a){if(a.tag===13||a.tag===31){var r=pi(a,67108864);r!==null&&Ra(r,a,67108864),Ph(a,67108864)}}function I0(a){if(a.tag===13||a.tag===31){var r=Ha();r=$e(r);var c=pi(a,r);c!==null&&Ra(c,a,r),Ph(a,r)}}var Zu=!0;function OA(a,r,c,m){var x=D.T;D.T=null;var w=O.p;try{O.p=2,Hh(a,r,c,m)}finally{O.p=w,D.T=x}}function $A(a,r,c,m){var x=D.T;D.T=null;var w=O.p;try{O.p=8,Hh(a,r,c,m)}finally{O.p=w,D.T=x}}function Hh(a,r,c,m){if(Zu){var x=Vh(m);if(x===null)Mh(a,r,m,Qu,c),D0(a,m);else if(zA(x,a,r,c,m))m.stopPropagation();else if(D0(a,m),r&4&&-1<FA.indexOf(a)){for(;x!==null;){var w=vt(x);if(w!==null)switch(w.tag){case 3:if(w=w.stateNode,w.current.memoizedState.isDehydrated){var q=Ft(w.pendingLanes);if(q!==0){var ne=w;for(ne.pendingLanes|=2,ne.entangledLanes|=2;q;){var Ae=1<<31-Te(q);ne.entanglements[1]|=Ae,q&=~Ae}Ds(w),(En&6)===0&&(Lu=st()+500,zo(0))}}break;case 31:case 13:ne=pi(w,2),ne!==null&&Ra(ne,w,2),Ou(),Ph(w,2)}if(w=Vh(m),w===null&&Mh(a,r,m,Qu,c),w===x)break;x=w}x!==null&&m.stopPropagation()}else Mh(a,r,m,null,c)}}function Vh(a){return a=Qt(a),Yh(a)}var Qu=null;function Yh(a){if(Qu=null,a=Ge(a),a!==null){var r=o(a);if(r===null)a=null;else{var c=r.tag;if(c===13){if(a=d(r),a!==null)return a;a=null}else if(c===31){if(a=f(r),a!==null)return a;a=null}else if(c===3){if(r.stateNode.current.memoizedState.isDehydrated)return r.tag===3?r.stateNode.containerInfo:null;a=null}else r!==a&&(a=null)}}return Qu=a,null}function L0(a){switch(a){case"beforetoggle":case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"toggle":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 2;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 8;case"message":switch(lt()){case Fe:return 2;case Xe:return 8;case dt:case ie:return 32;case ee:return 268435456;default:return 32}default:return 32}}var Gh=!1,qr=null,Pr=null,Hr=null,Yo=new Map,Go=new Map,Vr=[],FA="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset".split(" ");function D0(a,r){switch(a){case"focusin":case"focusout":qr=null;break;case"dragenter":case"dragleave":Pr=null;break;case"mouseover":case"mouseout":Hr=null;break;case"pointerover":case"pointerout":Yo.delete(r.pointerId);break;case"gotpointercapture":case"lostpointercapture":Go.delete(r.pointerId)}}function Wo(a,r,c,m,x,w){return a===null||a.nativeEvent!==w?(a={blockedOn:r,domEventName:c,eventSystemFlags:m,nativeEvent:w,targetContainers:[x]},r!==null&&(r=vt(r),r!==null&&R0(r)),a):(a.eventSystemFlags|=m,r=a.targetContainers,x!==null&&r.indexOf(x)===-1&&r.push(x),a)}function zA(a,r,c,m,x){switch(r){case"focusin":return qr=Wo(qr,a,r,c,m,x),!0;case"dragenter":return Pr=Wo(Pr,a,r,c,m,x),!0;case"mouseover":return Hr=Wo(Hr,a,r,c,m,x),!0;case"pointerover":var w=x.pointerId;return Yo.set(w,Wo(Yo.get(w)||null,a,r,c,m,x)),!0;case"gotpointercapture":return w=x.pointerId,Go.set(w,Wo(Go.get(w)||null,a,r,c,m,x)),!0}return!1}function O0(a){var r=Ge(a.target);if(r!==null){var c=o(r);if(c!==null){if(r=c.tag,r===13){if(r=d(c),r!==null){a.blockedOn=r,Z(a.priority,function(){I0(c)});return}}else if(r===31){if(r=f(c),r!==null){a.blockedOn=r,Z(a.priority,function(){I0(c)});return}}else if(r===3&&c.stateNode.current.memoizedState.isDehydrated){a.blockedOn=c.tag===3?c.stateNode.containerInfo:null;return}}}a.blockedOn=null}function Ju(a){if(a.blockedOn!==null)return!1;for(var r=a.targetContainers;0<r.length;){var c=Vh(a.nativeEvent);if(c===null){c=a.nativeEvent;var m=new c.constructor(c.type,c);$t=m,c.target.dispatchEvent(m),$t=null}else return r=vt(c),r!==null&&R0(r),a.blockedOn=c,!1;r.shift()}return!0}function $0(a,r,c){Ju(a)&&c.delete(r)}function BA(){Gh=!1,qr!==null&&Ju(qr)&&(qr=null),Pr!==null&&Ju(Pr)&&(Pr=null),Hr!==null&&Ju(Hr)&&(Hr=null),Yo.forEach($0),Go.forEach($0)}function ed(a,r){a.blockedOn===r&&(a.blockedOn=null,Gh||(Gh=!0,e.unstable_scheduleCallback(e.unstable_NormalPriority,BA)))}var td=null;function F0(a){td!==a&&(td=a,e.unstable_scheduleCallback(e.unstable_NormalPriority,function(){td===a&&(td=null);for(var r=0;r<a.length;r+=3){var c=a[r],m=a[r+1],x=a[r+2];if(typeof m!="function"){if(Yh(m||c)===null)continue;break}var w=vt(c);w!==null&&(a.splice(r,3),r-=3,Vm(w,{pending:!0,data:x,method:c.method,action:m},m,x))}}))}function _l(a){function r(Ae){return ed(Ae,a)}qr!==null&&ed(qr,a),Pr!==null&&ed(Pr,a),Hr!==null&&ed(Hr,a),Yo.forEach(r),Go.forEach(r);for(var c=0;c<Vr.length;c++){var m=Vr[c];m.blockedOn===a&&(m.blockedOn=null)}for(;0<Vr.length&&(c=Vr[0],c.blockedOn===null);)O0(c),c.blockedOn===null&&Vr.shift();if(c=(a.ownerDocument||a).$$reactFormReplay,c!=null)for(m=0;m<c.length;m+=3){var x=c[m],w=c[m+1],q=x[pe]||null;if(typeof w=="function")q||F0(c);else if(q){var ne=null;if(w&&w.hasAttribute("formAction")){if(x=w,q=w[pe]||null)ne=q.formAction;else if(Yh(x)!==null)continue}else ne=q.action;typeof ne=="function"?c[m+1]=ne:(c.splice(m,3),m-=3),F0(c)}}}function z0(){function a(w){w.canIntercept&&w.info==="react-transition"&&w.intercept({handler:function(){return new Promise(function(q){return x=q})},focusReset:"manual",scroll:"manual"})}function r(){x!==null&&(x(),x=null),m||setTimeout(c,20)}function c(){if(!m&&!navigation.transition){var w=navigation.currentEntry;w&&w.url!=null&&navigation.navigate(w.url,{state:w.getState(),info:"react-transition",history:"replace"})}}if(typeof navigation=="object"){var m=!1,x=null;return navigation.addEventListener("navigate",a),navigation.addEventListener("navigatesuccess",r),navigation.addEventListener("navigateerror",r),setTimeout(c,100),function(){m=!0,navigation.removeEventListener("navigate",a),navigation.removeEventListener("navigatesuccess",r),navigation.removeEventListener("navigateerror",r),x!==null&&(x(),x=null)}}}function Wh(a){this._internalRoot=a}nd.prototype.render=Wh.prototype.render=function(a){var r=this._internalRoot;if(r===null)throw Error(i(409));var c=r.current,m=Ha();M0(c,m,a,r,null,null)},nd.prototype.unmount=Wh.prototype.unmount=function(){var a=this._internalRoot;if(a!==null){this._internalRoot=null;var r=a.containerInfo;M0(a.current,2,null,a,null,null),Ou(),r[Ue]=null}};function nd(a){this._internalRoot=a}nd.prototype.unstable_scheduleHydration=function(a){if(a){var r=J();a={blockedOn:null,target:a,priority:r};for(var c=0;c<Vr.length&&r!==0&&r<Vr[c].priority;c++);Vr.splice(c,0,a),c===0&&O0(a)}};var B0=n.version;if(B0!=="19.2.0")throw Error(i(527,B0,"19.2.0"));O.findDOMNode=function(a){var r=a._reactInternals;if(r===void 0)throw typeof a.render=="function"?Error(i(188)):(a=Object.keys(a).join(","),Error(i(268,a)));return a=h(r),a=a!==null?y(a):null,a=a===null?null:a.stateNode,a};var UA={bundleType:0,version:"19.2.0",rendererPackageName:"react-dom",currentDispatcherRef:D,reconcilerVersion:"19.2.0"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var ad=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!ad.isDisabled&&ad.supportsFiber)try{qe=ad.inject(UA),Pe=ad}catch{}}return Ko.createRoot=function(a,r){if(!l(a))throw Error(i(299));var c=!1,m="",x=Gx,w=Wx,q=Xx;return r!=null&&(r.unstable_strictMode===!0&&(c=!0),r.identifierPrefix!==void 0&&(m=r.identifierPrefix),r.onUncaughtError!==void 0&&(x=r.onUncaughtError),r.onCaughtError!==void 0&&(w=r.onCaughtError),r.onRecoverableError!==void 0&&(q=r.onRecoverableError)),r=A0(a,1,!1,null,null,c,m,null,x,w,q,z0),a[Ue]=r.current,Th(a),new Wh(r)},Ko.hydrateRoot=function(a,r,c){if(!l(a))throw Error(i(299));var m=!1,x="",w=Gx,q=Wx,ne=Xx,Ae=null;return c!=null&&(c.unstable_strictMode===!0&&(m=!0),c.identifierPrefix!==void 0&&(x=c.identifierPrefix),c.onUncaughtError!==void 0&&(w=c.onUncaughtError),c.onCaughtError!==void 0&&(q=c.onCaughtError),c.onRecoverableError!==void 0&&(ne=c.onRecoverableError),c.formState!==void 0&&(Ae=c.formState)),r=A0(a,1,!0,r,c??null,m,x,Ae,w,q,ne,z0),r.context=T0(null),c=r.current,m=Ha(),m=$e(m),x=Mr(m),x.callback=null,kr(c,x,m),c=m,r.current.lanes=c,oe(r,c),Ds(r),a[Ue]=r.current,Th(a),new nd(r)},Ko.version="19.2.0",Ko}var K0;function KA(){if(K0)return Zh.exports;K0=1;function e(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(n){console.error(n)}}return e(),Zh.exports=XA(),Zh.exports}var ZA=KA();/**
 * react-router v7.9.3
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */var BN=e=>{throw TypeError(e)},QA=(e,n,s)=>n.has(e)||BN("Cannot "+s),tp=(e,n,s)=>(QA(e,n,"read from private field"),s?s.call(e):n.get(e)),JA=(e,n,s)=>n.has(e)?BN("Cannot add the same private member more than once"):n instanceof WeakSet?n.add(e):n.set(e,s),Z0="popstate";function e2(e={}){function n(i,l){let{pathname:o,search:d,hash:f}=i.location;return _c("",{pathname:o,search:d,hash:f},l.state&&l.state.usr||null,l.state&&l.state.key||"default")}function s(i,l){return typeof l=="string"?l:si(l)}return n2(n,s,null,e)}function cn(e,n){if(e===!1||e===null||typeof e>"u")throw new Error(n)}function Gn(e,n){if(!e){typeof console<"u"&&console.warn(n);try{throw new Error(n)}catch{}}}function t2(){return Math.random().toString(36).substring(2,10)}function Q0(e,n){return{usr:e.state,key:e.key,idx:n}}function _c(e,n,s=null,i){return{pathname:typeof e=="string"?e:e.pathname,search:"",hash:"",...typeof n=="string"?oi(n):n,state:s,key:n&&n.key||i||t2()}}function si({pathname:e="/",search:n="",hash:s=""}){return n&&n!=="?"&&(e+=n.charAt(0)==="?"?n:"?"+n),s&&s!=="#"&&(e+=s.charAt(0)==="#"?s:"#"+s),e}function oi(e){let n={};if(e){let s=e.indexOf("#");s>=0&&(n.hash=e.substring(s),e=e.substring(0,s));let i=e.indexOf("?");i>=0&&(n.search=e.substring(i),e=e.substring(0,i)),e&&(n.pathname=e)}return n}function n2(e,n,s,i={}){let{window:l=document.defaultView,v5Compat:o=!1}=i,d=l.history,f="POP",p=null,h=y();h==null&&(h=0,d.replaceState({...d.state,idx:h},""));function y(){return(d.state||{idx:null}).idx}function g(){f="POP";let j=y(),E=j==null?null:j-h;h=j,p&&p({action:f,location:N.location,delta:E})}function b(j,E){f="PUSH";let A=_c(N.location,j,E);h=y()+1;let M=Q0(A,h),_=N.createHref(A);try{d.pushState(M,"",_)}catch(T){if(T instanceof DOMException&&T.name==="DataCloneError")throw T;l.location.assign(_)}o&&p&&p({action:f,location:N.location,delta:1})}function v(j,E){f="REPLACE";let A=_c(N.location,j,E);h=y();let M=Q0(A,h),_=N.createHref(A);d.replaceState(M,"",_),o&&p&&p({action:f,location:N.location,delta:0})}function S(j){return UN(j)}let N={get action(){return f},get location(){return e(l,d)},listen(j){if(p)throw new Error("A history only accepts one active listener");return l.addEventListener(Z0,g),p=j,()=>{l.removeEventListener(Z0,g),p=null}},createHref(j){return n(l,j)},createURL:S,encodeLocation(j){let E=S(j);return{pathname:E.pathname,search:E.search,hash:E.hash}},push:b,replace:v,go(j){return d.go(j)}};return N}function UN(e,n=!1){let s="http://localhost";typeof window<"u"&&(s=window.location.origin!=="null"?window.location.origin:window.location.href),cn(s,"No window.location.(origin|href) available to create URL");let i=typeof e=="string"?e:si(e);return i=i.replace(/ $/,"%20"),!n&&i.startsWith("//")&&(i=s+i),new URL(i,s)}var yc,J0=class{constructor(e){if(JA(this,yc,new Map),e)for(let[n,s]of e)this.set(n,s)}get(e){if(tp(this,yc).has(e))return tp(this,yc).get(e);if(e.defaultValue!==void 0)return e.defaultValue;throw new Error("No value found for context")}set(e,n){tp(this,yc).set(e,n)}};yc=new WeakMap;var a2=new Set(["lazy","caseSensitive","path","id","index","children"]);function s2(e){return a2.has(e)}var r2=new Set(["lazy","caseSensitive","path","id","index","middleware","children"]);function i2(e){return r2.has(e)}function l2(e){return e.index===!0}function Cc(e,n,s=[],i={},l=!1){return e.map((o,d)=>{let f=[...s,String(d)],p=typeof o.id=="string"?o.id:f.join("-");if(cn(o.index!==!0||!o.children,"Cannot specify children on an index route"),cn(l||!i[p],`Found a route id collision on id "${p}".  Route id's must be globally unique within Data Router usages`),l2(o)){let h={...o,...n(o),id:p};return i[p]=h,h}else{let h={...o,...n(o),id:p,children:void 0};return i[p]=h,o.children&&(h.children=Cc(o.children,n,f,i,l)),h}})}function Jr(e,n,s="/"){return Ld(e,n,s,!1)}function Ld(e,n,s,i){let l=typeof n=="string"?oi(n):n,o=Oa(l.pathname||"/",s);if(o==null)return null;let d=qN(e);c2(d);let f=null;for(let p=0;f==null&&p<d.length;++p){let h=v2(o);f=b2(d[p],h,i)}return f}function o2(e,n){let{route:s,pathname:i,params:l}=e;return{id:s.id,pathname:i,params:l,data:n[s.id],loaderData:n[s.id],handle:s.handle}}function qN(e,n=[],s=[],i="",l=!1){let o=(d,f,p=l,h)=>{let y={relativePath:h===void 0?d.path||"":h,caseSensitive:d.caseSensitive===!0,childrenIndex:f,route:d};if(y.relativePath.startsWith("/")){if(!y.relativePath.startsWith(i)&&p)return;cn(y.relativePath.startsWith(i),`Absolute route path "${y.relativePath}" nested under path "${i}" is not valid. An absolute child route path must start with the combined path of all its parent routes.`),y.relativePath=y.relativePath.slice(i.length)}let g=Us([i,y.relativePath]),b=s.concat(y);d.children&&d.children.length>0&&(cn(d.index!==!0,`Index routes must not have child routes. Please remove all child routes from route path "${g}".`),qN(d.children,n,b,g,p)),!(d.path==null&&!d.index)&&n.push({path:g,score:y2(g,d.index),routesMeta:b})};return e.forEach((d,f)=>{if(d.path===""||!d.path?.includes("?"))o(d,f);else for(let p of PN(d.path))o(d,f,!0,p)}),n}function PN(e){let n=e.split("/");if(n.length===0)return[];let[s,...i]=n,l=s.endsWith("?"),o=s.replace(/\?$/,"");if(i.length===0)return l?[o,""]:[o];let d=PN(i.join("/")),f=[];return f.push(...d.map(p=>p===""?o:[o,p].join("/"))),l&&f.push(...d),f.map(p=>e.startsWith("/")&&p===""?"/":p)}function c2(e){e.sort((n,s)=>n.score!==s.score?s.score-n.score:g2(n.routesMeta.map(i=>i.childrenIndex),s.routesMeta.map(i=>i.childrenIndex)))}var u2=/^:[\w-]+$/,d2=3,f2=2,m2=1,h2=10,p2=-2,eS=e=>e==="*";function y2(e,n){let s=e.split("/"),i=s.length;return s.some(eS)&&(i+=p2),n&&(i+=f2),s.filter(l=>!eS(l)).reduce((l,o)=>l+(u2.test(o)?d2:o===""?m2:h2),i)}function g2(e,n){return e.length===n.length&&e.slice(0,-1).every((i,l)=>i===n[l])?e[e.length-1]-n[n.length-1]:0}function b2(e,n,s=!1){let{routesMeta:i}=e,l={},o="/",d=[];for(let f=0;f<i.length;++f){let p=i[f],h=f===i.length-1,y=o==="/"?n:n.slice(o.length)||"/",g=Xd({path:p.relativePath,caseSensitive:p.caseSensitive,end:h},y),b=p.route;if(!g&&h&&s&&!i[i.length-1].route.index&&(g=Xd({path:p.relativePath,caseSensitive:p.caseSensitive,end:!1},y)),!g)return null;Object.assign(l,g.params),d.push({params:l,pathname:Us([o,g.pathname]),pathnameBase:j2(Us([o,g.pathnameBase])),route:b}),g.pathnameBase!=="/"&&(o=Us([o,g.pathnameBase]))}return d}function Xd(e,n){typeof e=="string"&&(e={path:e,caseSensitive:!1,end:!0});let[s,i]=x2(e.path,e.caseSensitive,e.end),l=n.match(s);if(!l)return null;let o=l[0],d=o.replace(/(.)\/+$/,"$1"),f=l.slice(1);return{params:i.reduce((h,{paramName:y,isOptional:g},b)=>{if(y==="*"){let S=f[b]||"";d=o.slice(0,o.length-S.length).replace(/(.)\/+$/,"$1")}const v=f[b];return g&&!v?h[y]=void 0:h[y]=(v||"").replace(/%2F/g,"/"),h},{}),pathname:o,pathnameBase:d,pattern:e}}function x2(e,n=!1,s=!0){Gn(e==="*"||!e.endsWith("*")||e.endsWith("/*"),`Route path "${e}" will be treated as if it were "${e.replace(/\*$/,"/*")}" because the \`*\` character must always follow a \`/\` in the pattern. To get rid of this warning, please change the route path to "${e.replace(/\*$/,"/*")}".`);let i=[],l="^"+e.replace(/\/*\*?$/,"").replace(/^\/*/,"/").replace(/[\\.*+^${}|()[\]]/g,"\\$&").replace(/\/:([\w-]+)(\?)?/g,(d,f,p)=>(i.push({paramName:f,isOptional:p!=null}),p?"/?([^\\/]+)?":"/([^\\/]+)")).replace(/\/([\w-]+)\?(\/|$)/g,"(/$1)?$2");return e.endsWith("*")?(i.push({paramName:"*"}),l+=e==="*"||e==="/*"?"(.*)$":"(?:\\/(.+)|\\/*)$"):s?l+="\\/*$":e!==""&&e!=="/"&&(l+="(?:(?=\\/|$))"),[new RegExp(l,n?void 0:"i"),i]}function v2(e){try{return e.split("/").map(n=>decodeURIComponent(n).replace(/\//g,"%2F")).join("/")}catch(n){return Gn(!1,`The URL path "${e}" could not be decoded because it is a malformed URL segment. This is probably due to a bad percent encoding (${n}).`),e}}function Oa(e,n){if(n==="/")return e;if(!e.toLowerCase().startsWith(n.toLowerCase()))return null;let s=n.endsWith("/")?n.length-1:n.length,i=e.charAt(s);return i&&i!=="/"?null:e.slice(s)||"/"}function S2({basename:e,pathname:n}){return n==="/"?e:Us([e,n])}function w2(e,n="/"){let{pathname:s,search:i="",hash:l=""}=typeof e=="string"?oi(e):e;return{pathname:s?s.startsWith("/")?s:N2(s,n):n,search:E2(i),hash:_2(l)}}function N2(e,n){let s=n.replace(/\/+$/,"").split("/");return e.split("/").forEach(l=>{l===".."?s.length>1&&s.pop():l!=="."&&s.push(l)}),s.length>1?s.join("/"):"/"}function np(e,n,s,i){return`Cannot include a '${e}' character in a manually specified \`to.${n}\` field [${JSON.stringify(i)}].  Please separate it out to the \`to.${s}\` field. Alternatively you may provide the full path as a string in <Link to="..."> and the router will parse it for you.`}function HN(e){return e.filter((n,s)=>s===0||n.route.path&&n.route.path.length>0)}function xf(e){let n=HN(e);return n.map((s,i)=>i===n.length-1?s.pathname:s.pathnameBase)}function vf(e,n,s,i=!1){let l;typeof e=="string"?l=oi(e):(l={...e},cn(!l.pathname||!l.pathname.includes("?"),np("?","pathname","search",l)),cn(!l.pathname||!l.pathname.includes("#"),np("#","pathname","hash",l)),cn(!l.search||!l.search.includes("#"),np("#","search","hash",l)));let o=e===""||l.pathname==="",d=o?"/":l.pathname,f;if(d==null)f=s;else{let g=n.length-1;if(!i&&d.startsWith("..")){let b=d.split("/");for(;b[0]==="..";)b.shift(),g-=1;l.pathname=b.join("/")}f=g>=0?n[g]:"/"}let p=w2(l,f),h=d&&d!=="/"&&d.endsWith("/"),y=(o||d===".")&&s.endsWith("/");return!p.pathname.endsWith("/")&&(h||y)&&(p.pathname+="/"),p}var Us=e=>e.join("/").replace(/\/\/+/g,"/"),j2=e=>e.replace(/\/+$/,"").replace(/^\/*/,"/"),E2=e=>!e||e==="?"?"":e.startsWith("?")?e:"?"+e,_2=e=>!e||e==="#"?"":e.startsWith("#")?e:"#"+e,Kd=class{constructor(e,n,s,i=!1){this.status=e,this.statusText=n||"",this.internal=i,s instanceof Error?(this.data=s.toString(),this.error=s):this.data=s}};function Ac(e){return e!=null&&typeof e.status=="number"&&typeof e.statusText=="string"&&typeof e.internal=="boolean"&&"data"in e}var VN=["POST","PUT","PATCH","DELETE"],C2=new Set(VN),A2=["GET",...VN],T2=new Set(A2),M2=new Set([301,302,303,307,308]),k2=new Set([307,308]),ap={state:"idle",location:void 0,formMethod:void 0,formAction:void 0,formEncType:void 0,formData:void 0,json:void 0,text:void 0},R2={state:"idle",data:void 0,formMethod:void 0,formAction:void 0,formEncType:void 0,formData:void 0,json:void 0,text:void 0},ki={state:"unblocked",proceed:void 0,reset:void 0,location:void 0},I2=/^(?:[a-z][a-z0-9+.-]*:|\/\/)/i,ag=e=>I2.test(e),L2=e=>({hasErrorBoundary:!!e.hasErrorBoundary}),YN="remix-router-transitions",GN=Symbol("ResetLoaderData");function D2(e){const n=e.window?e.window:typeof window<"u"?window:void 0,s=typeof n<"u"&&typeof n.document<"u"&&typeof n.document.createElement<"u";cn(e.routes.length>0,"You must provide a non-empty routes array to createRouter");let i=e.hydrationRouteProperties||[],l=e.mapRouteProperties||L2,o={},d=Cc(e.routes,l,void 0,o),f,p=e.basename||"/";p.startsWith("/")||(p=`/${p}`);let h=e.dataStrategy||B2,y={...e.future},g=null,b=new Set,v=null,S=null,N=null,j=e.hydrationData!=null,E=Jr(d,e.history.location,p),A=!1,M=null,_;if(E==null&&!e.patchRoutesOnNavigation){let oe=is(404,{pathname:e.history.location.pathname}),{matches:Ee,route:Se}=sd(d);_=!0,E=Ee,M={[Se.id]:oe}}else if(E&&!e.hydrationData&&Tt(E,d,e.history.location.pathname).active&&(E=null),E)if(E.some(oe=>oe.route.lazy))_=!1;else if(!E.some(oe=>sg(oe.route)))_=!0;else{let oe=e.hydrationData?e.hydrationData.loaderData:null,Ee=e.hydrationData?e.hydrationData.errors:null;if(Ee){let Se=E.findIndex(Ve=>Ee[Ve.route.id]!==void 0);_=E.slice(0,Se+1).every(Ve=>!dy(Ve.route,oe,Ee))}else _=E.every(Se=>!dy(Se.route,oe,Ee))}else{_=!1,E=[];let oe=Tt(null,d,e.history.location.pathname);oe.active&&oe.matches&&(A=!0,E=oe.matches)}let T,k={historyAction:e.history.action,location:e.history.location,matches:E,initialized:_,navigation:ap,restoreScrollPosition:e.hydrationData!=null?!1:null,preventScrollReset:!1,revalidation:"idle",loaderData:e.hydrationData&&e.hydrationData.loaderData||{},actionData:e.hydrationData&&e.hydrationData.actionData||null,errors:e.hydrationData&&e.hydrationData.errors||M,fetchers:new Map,blockers:new Map},C="POP",L=!1,z,G=!1,U=new Map,X=null,V=!1,R=!1,B=new Set,D=new Map,O=0,$=-1,F=new Map,H=new Set,I=new Map,Y=new Map,P=new Set,W=new Map,le,K=null;function de(){if(g=e.history.listen(({action:oe,location:Ee,delta:Se})=>{if(le){le(),le=void 0;return}Gn(W.size===0||Se!=null,"You are trying to use a blocker on a POP navigation to a location that was not created by @remix-run/router. This will fail silently in production. This can happen if you are navigating outside the router via `window.history.pushState`/`window.location.hash` instead of using router navigation APIs.  This can also happen if you are using createHashRouter and the user manually changes the URL.");let Ve=Mt({currentLocation:k.location,nextLocation:Ee,historyAction:oe});if(Ve&&Se!=null){let xe=new Promise($e=>{le=$e});e.history.go(Se*-1),jt(Ve,{state:"blocked",location:Ee,proceed(){jt(Ve,{state:"proceeding",proceed:void 0,reset:void 0,location:Ee}),xe.then(()=>e.history.go(Se))},reset(){let $e=new Map(k.blockers);$e.set(Ve,ki),re({blockers:$e})}});return}return se(oe,Ee)}),s){tT(n,U);let oe=()=>nT(n,U);n.addEventListener("pagehide",oe),X=()=>n.removeEventListener("pagehide",oe)}return k.initialized||se("POP",k.location,{initialHydration:!0}),T}function Q(){g&&g(),X&&X(),b.clear(),z&&z.abort(),k.fetchers.forEach((oe,Ee)=>ee(Ee)),k.blockers.forEach((oe,Ee)=>gt(Ee))}function he(oe){return b.add(oe),()=>b.delete(oe)}function re(oe,Ee={}){oe.matches&&(oe.matches=oe.matches.map(xe=>{let $e=o[xe.route.id],He=xe.route;return He.element!==$e.element||He.errorElement!==$e.errorElement||He.hydrateFallbackElement!==$e.hydrateFallbackElement?{...xe,route:$e}:xe})),k={...k,...oe};let Se=[],Ve=[];k.fetchers.forEach((xe,$e)=>{xe.state==="idle"&&(P.has($e)?Se.push($e):Ve.push($e))}),P.forEach(xe=>{!k.fetchers.has(xe)&&!D.has(xe)&&Se.push(xe)}),[...b].forEach(xe=>xe(k,{deletedFetchers:Se,viewTransitionOpts:Ee.viewTransitionOpts,flushSync:Ee.flushSync===!0})),Se.forEach(xe=>ee(xe)),Ve.forEach(xe=>k.fetchers.delete(xe))}function Ce(oe,Ee,{flushSync:Se}={}){let Ve=k.actionData!=null&&k.navigation.formMethod!=null&&Ia(k.navigation.formMethod)&&k.navigation.state==="loading"&&oe.state?._isRedirect!==!0,xe;Ee.actionData?Object.keys(Ee.actionData).length>0?xe=Ee.actionData:xe=null:Ve?xe=k.actionData:xe=null;let $e=Ee.loaderData?uS(k.loaderData,Ee.loaderData,Ee.matches||[],Ee.errors):k.loaderData,He=k.blockers;He.size>0&&(He=new Map(He),He.forEach((Ne,pe)=>He.set(pe,ki)));let J=V?!1:Zt(oe,Ee.matches||k.matches),Z=L===!0||k.navigation.formMethod!=null&&Ia(k.navigation.formMethod)&&oe.state?._isRedirect!==!0;f&&(d=f,f=void 0),V||C==="POP"||(C==="PUSH"?e.history.push(oe,oe.state):C==="REPLACE"&&e.history.replace(oe,oe.state));let je;if(C==="POP"){let Ne=U.get(k.location.pathname);Ne&&Ne.has(oe.pathname)?je={currentLocation:k.location,nextLocation:oe}:U.has(oe.pathname)&&(je={currentLocation:oe,nextLocation:k.location})}else if(G){let Ne=U.get(k.location.pathname);Ne?Ne.add(oe.pathname):(Ne=new Set([oe.pathname]),U.set(k.location.pathname,Ne)),je={currentLocation:k.location,nextLocation:oe}}re({...Ee,actionData:xe,loaderData:$e,historyAction:C,location:oe,initialized:!0,navigation:ap,revalidation:"idle",restoreScrollPosition:J,preventScrollReset:Z,blockers:He},{viewTransitionOpts:je,flushSync:Se===!0}),C="POP",L=!1,G=!1,V=!1,R=!1,K?.resolve(),K=null}async function Re(oe,Ee){if(typeof oe=="number"){e.history.go(oe);return}let Se=uy(k.location,k.matches,p,oe,Ee?.fromRouteId,Ee?.relative),{path:Ve,submission:xe,error:$e}=tS(!1,Se,Ee),He=k.location,J=_c(k.location,Ve,Ee&&Ee.state);J={...J,...e.history.encodeLocation(J)};let Z=Ee&&Ee.replace!=null?Ee.replace:void 0,je="PUSH";Z===!0?je="REPLACE":Z===!1||xe!=null&&Ia(xe.formMethod)&&xe.formAction===k.location.pathname+k.location.search&&(je="REPLACE");let Ne=Ee&&"preventScrollReset"in Ee?Ee.preventScrollReset===!0:void 0,pe=(Ee&&Ee.flushSync)===!0,Ue=Mt({currentLocation:He,nextLocation:J,historyAction:je});if(Ue){jt(Ue,{state:"blocked",location:J,proceed(){jt(Ue,{state:"proceeding",proceed:void 0,reset:void 0,location:J}),Re(oe,Ee)},reset(){let ae=new Map(k.blockers);ae.set(Ue,ki),re({blockers:ae})}});return}await se(je,J,{submission:xe,pendingError:$e,preventScrollReset:Ne,replace:Ee&&Ee.replace,enableViewTransition:Ee&&Ee.viewTransition,flushSync:pe})}function ue(){K||(K=aT()),lt(),re({revalidation:"loading"});let oe=K.promise;return k.navigation.state==="submitting"?oe:k.navigation.state==="idle"?(se(k.historyAction,k.location,{startUninterruptedRevalidation:!0}),oe):(se(C||k.historyAction,k.navigation.location,{overrideNavigation:k.navigation,enableViewTransition:G===!0}),oe)}async function se(oe,Ee,Se){z&&z.abort(),z=null,C=oe,V=(Se&&Se.startUninterruptedRevalidation)===!0,Ft(k.location,k.matches),L=(Se&&Se.preventScrollReset)===!0,G=(Se&&Se.enableViewTransition)===!0;let Ve=f||d,xe=Se&&Se.overrideNavigation,$e=Se?.initialHydration&&k.matches&&k.matches.length>0&&!A?k.matches:Jr(Ve,Ee,p),He=(Se&&Se.flushSync)===!0;if($e&&k.initialized&&!R&&W2(k.location,Ee)&&!(Se&&Se.submission&&Ia(Se.submission.formMethod))){Ce(Ee,{matches:$e},{flushSync:He});return}let J=Tt($e,Ve,Ee.pathname);if(J.active&&J.matches&&($e=J.matches),!$e){let{error:ot,notFoundMatches:St,route:me}=tt(Ee.pathname);Ce(Ee,{matches:St,loaderData:{},errors:{[me.id]:ot}},{flushSync:He});return}z=new AbortController;let Z=Dl(e.history,Ee,z.signal,Se&&Se.submission),je=e.getContext?await e.getContext():new J0,Ne;if(Se&&Se.pendingError)Ne=[ei($e).route.id,{type:"error",error:Se.pendingError}];else if(Se&&Se.submission&&Ia(Se.submission.formMethod)){let ot=await Le(Z,Ee,Se.submission,$e,je,J.active,Se&&Se.initialHydration===!0,{replace:Se.replace,flushSync:He});if(ot.shortCircuited)return;if(ot.pendingActionResult){let[St,me]=ot.pendingActionResult;if(Va(me)&&Ac(me.error)&&me.error.status===404){z=null,Ce(Ee,{matches:ot.matches,loaderData:{},errors:{[St]:me.error}});return}}$e=ot.matches||$e,Ne=ot.pendingActionResult,xe=sp(Ee,Se.submission),He=!1,J.active=!1,Z=Dl(e.history,Z.url,Z.signal)}let{shortCircuited:pe,matches:Ue,loaderData:ae,errors:Ke}=await be(Z,Ee,$e,je,J.active,xe,Se&&Se.submission,Se&&Se.fetcherSubmission,Se&&Se.replace,Se&&Se.initialHydration===!0,He,Ne);pe||(z=null,Ce(Ee,{matches:Ue||$e,...dS(Ne),loaderData:ae,errors:Ke}))}async function Le(oe,Ee,Se,Ve,xe,$e,He,J={}){lt();let Z=J2(Ee,Se);if(re({navigation:Z},{flushSync:J.flushSync===!0}),$e){let pe=await We(Ve,Ee.pathname,oe.signal);if(pe.type==="aborted")return{shortCircuited:!0};if(pe.type==="error"){if(pe.partialMatches.length===0){let{matches:ae,route:Ke}=sd(d);return{matches:ae,pendingActionResult:[Ke.id,{type:"error",error:pe.error}]}}let Ue=ei(pe.partialMatches).route.id;return{matches:pe.partialMatches,pendingActionResult:[Ue,{type:"error",error:pe.error}]}}else if(pe.matches)Ve=pe.matches;else{let{notFoundMatches:Ue,error:ae,route:Ke}=tt(Ee.pathname);return{matches:Ue,pendingActionResult:[Ke.id,{type:"error",error:ae}]}}}let je,Ne=Dd(Ve,Ee);if(!Ne.route.action&&!Ne.route.lazy)je={type:"error",error:is(405,{method:oe.method,pathname:Ee.pathname,routeId:Ne.route.id})};else{let pe=Fl(l,o,oe,Ve,Ne,He?[]:i,xe),Ue=await we(oe,pe,xe,null);if(je=Ue[Ne.route.id],!je){for(let ae of Ve)if(Ue[ae.route.id]){je=Ue[ae.route.id];break}}if(oe.signal.aborted)return{shortCircuited:!0}}if(Ii(je)){let pe;return J&&J.replace!=null?pe=J.replace:pe=lS(je.response.headers.get("Location"),new URL(oe.url),p)===k.location.pathname+k.location.search,await At(oe,je,!0,{submission:Se,replace:pe}),{shortCircuited:!0}}if(Va(je)){let pe=ei(Ve,Ne.route.id);return(J&&J.replace)!==!0&&(C="PUSH"),{matches:Ve,pendingActionResult:[pe.route.id,je,Ne.route.id]}}return{matches:Ve,pendingActionResult:[Ne.route.id,je]}}async function be(oe,Ee,Se,Ve,xe,$e,He,J,Z,je,Ne,pe){let Ue=$e||sp(Ee,He),ae=He||J||mS(Ue),Ke=!V&&!je;if(xe){if(Ke){let Ie=De(pe);re({navigation:Ue,...Ie!==void 0?{actionData:Ie}:{}},{flushSync:Ne})}let ve=await We(Se,Ee.pathname,oe.signal);if(ve.type==="aborted")return{shortCircuited:!0};if(ve.type==="error"){if(ve.partialMatches.length===0){let{matches:rt,route:_t}=sd(d);return{matches:rt,loaderData:{},errors:{[_t.id]:ve.error}}}let Ie=ei(ve.partialMatches).route.id;return{matches:ve.partialMatches,loaderData:{},errors:{[Ie]:ve.error}}}else if(ve.matches)Se=ve.matches;else{let{error:Ie,notFoundMatches:rt,route:_t}=tt(Ee.pathname);return{matches:rt,loaderData:{},errors:{[_t.id]:Ie}}}}let ot=f||d,{dsMatches:St,revalidatingFetchers:me}=nS(oe,Ve,l,o,e.history,k,Se,ae,Ee,je?[]:i,je===!0,R,B,P,I,H,ot,p,e.patchRoutesOnNavigation!=null,pe);if($=++O,!e.dataStrategy&&!St.some(ve=>ve.shouldLoad)&&!St.some(ve=>ve.route.middleware&&ve.route.middleware.length>0)&&me.length===0){let ve=Pe();return Ce(Ee,{matches:Se,loaderData:{},errors:pe&&Va(pe[1])?{[pe[0]]:pe[1].error}:null,...dS(pe),...ve?{fetchers:new Map(k.fetchers)}:{}},{flushSync:Ne}),{shortCircuited:!0}}if(Ke){let ve={};if(!xe){ve.navigation=Ue;let Ie=De(pe);Ie!==void 0&&(ve.actionData=Ie)}me.length>0&&(ve.fetchers=Me(me)),re(ve,{flushSync:Ne})}me.forEach(ve=>{fe(ve.key),ve.controller&&D.set(ve.key,ve.controller)});let nt=()=>me.forEach(ve=>fe(ve.key));z&&z.signal.addEventListener("abort",nt);let{loaderResults:Ge,fetcherResults:vt}=await st(St,me,oe,Ve);if(oe.signal.aborted)return{shortCircuited:!0};z&&z.signal.removeEventListener("abort",nt),me.forEach(ve=>D.delete(ve.key));let ct=rd(Ge);if(ct)return await At(oe,ct.result,!0,{replace:Z}),{shortCircuited:!0};if(ct=rd(vt),ct)return H.add(ct.key),await At(oe,ct.result,!0,{replace:Z}),{shortCircuited:!0};let{loaderData:Nt,errors:Ye}=cS(k,Se,Ge,pe,me,vt);je&&k.errors&&(Ye={...k.errors,...Ye});let Je=Pe(),Et=Be($),te=Je||Et||me.length>0;return{matches:Se,loaderData:Nt,errors:Ye,...te?{fetchers:new Map(k.fetchers)}:{}}}function De(oe){if(oe&&!Va(oe[1]))return{[oe[0]]:oe[1].data};if(k.actionData)return Object.keys(k.actionData).length===0?null:k.actionData}function Me(oe){return oe.forEach(Ee=>{let Se=k.fetchers.get(Ee.key),Ve=Zo(void 0,Se?Se.data:void 0);k.fetchers.set(Ee.key,Ve)}),new Map(k.fetchers)}async function mt(oe,Ee,Se,Ve){fe(oe);let xe=(Ve&&Ve.flushSync)===!0,$e=f||d,He=uy(k.location,k.matches,p,Se,Ee,Ve?.relative),J=Jr($e,He,p),Z=Tt(J,$e,He);if(Z.active&&Z.matches&&(J=Z.matches),!J){Xe(oe,Ee,is(404,{pathname:He}),{flushSync:xe});return}let{path:je,submission:Ne,error:pe}=tS(!0,He,Ve);if(pe){Xe(oe,Ee,pe,{flushSync:xe});return}let Ue=e.getContext?await e.getContext():new J0,ae=(Ve&&Ve.preventScrollReset)===!0;if(Ne&&Ia(Ne.formMethod)){await ht(oe,Ee,je,J,Ue,Z.active,xe,ae,Ne);return}I.set(oe,{routeId:Ee,path:je}),await Ct(oe,Ee,je,J,Ue,Z.active,xe,ae,Ne)}async function ht(oe,Ee,Se,Ve,xe,$e,He,J,Z){lt(),I.delete(oe);let je=k.fetchers.get(oe);Fe(oe,eT(Z,je),{flushSync:He});let Ne=new AbortController,pe=Dl(e.history,Se,Ne.signal,Z);if($e){let Lt=await We(Ve,new URL(pe.url).pathname,pe.signal,oe);if(Lt.type==="aborted")return;if(Lt.type==="error"){Xe(oe,Ee,Lt.error,{flushSync:He});return}else if(Lt.matches)Ve=Lt.matches;else{Xe(oe,Ee,is(404,{pathname:Se}),{flushSync:He});return}}let Ue=Dd(Ve,Se);if(!Ue.route.action&&!Ue.route.lazy){let Lt=is(405,{method:Z.formMethod,pathname:Se,routeId:Ee});Xe(oe,Ee,Lt,{flushSync:He});return}D.set(oe,Ne);let ae=O,Ke=Fl(l,o,pe,Ve,Ue,i,xe),St=(await we(pe,Ke,xe,oe))[Ue.route.id];if(pe.signal.aborted){D.get(oe)===Ne&&D.delete(oe);return}if(P.has(oe)){if(Ii(St)||Va(St)){Fe(oe,hr(void 0));return}}else{if(Ii(St))if(D.delete(oe),$>ae){Fe(oe,hr(void 0));return}else return H.add(oe),Fe(oe,Zo(Z)),At(pe,St,!1,{fetcherSubmission:Z,preventScrollReset:J});if(Va(St)){Xe(oe,Ee,St.error);return}}let me=k.navigation.location||k.location,nt=Dl(e.history,me,Ne.signal),Ge=f||d,vt=k.navigation.state!=="idle"?Jr(Ge,k.navigation.location,p):k.matches;cn(vt,"Didn't find any matches after fetcher action");let ct=++O;F.set(oe,ct);let Nt=Zo(Z,St.data);k.fetchers.set(oe,Nt);let{dsMatches:Ye,revalidatingFetchers:Je}=nS(nt,xe,l,o,e.history,k,vt,Z,me,i,!1,R,B,P,I,H,Ge,p,e.patchRoutesOnNavigation!=null,[Ue.route.id,St]);Je.filter(Lt=>Lt.key!==oe).forEach(Lt=>{let nn=Lt.key,Pt=k.fetchers.get(nn),zt=Zo(void 0,Pt?Pt.data:void 0);k.fetchers.set(nn,zt),fe(nn),Lt.controller&&D.set(nn,Lt.controller)}),re({fetchers:new Map(k.fetchers)});let Et=()=>Je.forEach(Lt=>fe(Lt.key));Ne.signal.addEventListener("abort",Et);let{loaderResults:te,fetcherResults:ve}=await st(Ye,Je,nt,xe);if(Ne.signal.aborted)return;if(Ne.signal.removeEventListener("abort",Et),F.delete(oe),D.delete(oe),Je.forEach(Lt=>D.delete(Lt.key)),k.fetchers.has(oe)){let Lt=hr(St.data);k.fetchers.set(oe,Lt)}let Ie=rd(te);if(Ie)return At(nt,Ie.result,!1,{preventScrollReset:J});if(Ie=rd(ve),Ie)return H.add(Ie.key),At(nt,Ie.result,!1,{preventScrollReset:J});let{loaderData:rt,errors:_t}=cS(k,vt,te,void 0,Je,ve);Be(ct),k.navigation.state==="loading"&&ct>$?(cn(C,"Expected pending action"),z&&z.abort(),Ce(k.navigation.location,{matches:vt,loaderData:rt,errors:_t,fetchers:new Map(k.fetchers)})):(re({errors:_t,loaderData:uS(k.loaderData,rt,vt,_t),fetchers:new Map(k.fetchers)}),R=!1)}async function Ct(oe,Ee,Se,Ve,xe,$e,He,J,Z){let je=k.fetchers.get(oe);Fe(oe,Zo(Z,je?je.data:void 0),{flushSync:He});let Ne=new AbortController,pe=Dl(e.history,Se,Ne.signal);if($e){let me=await We(Ve,new URL(pe.url).pathname,pe.signal,oe);if(me.type==="aborted")return;if(me.type==="error"){Xe(oe,Ee,me.error,{flushSync:He});return}else if(me.matches)Ve=me.matches;else{Xe(oe,Ee,is(404,{pathname:Se}),{flushSync:He});return}}let Ue=Dd(Ve,Se);D.set(oe,Ne);let ae=O,Ke=Fl(l,o,pe,Ve,Ue,i,xe),St=(await we(pe,Ke,xe,oe))[Ue.route.id];if(D.get(oe)===Ne&&D.delete(oe),!pe.signal.aborted){if(P.has(oe)){Fe(oe,hr(void 0));return}if(Ii(St))if($>ae){Fe(oe,hr(void 0));return}else{H.add(oe),await At(pe,St,!1,{preventScrollReset:J});return}if(Va(St)){Xe(oe,Ee,St.error);return}Fe(oe,hr(St.data))}}async function At(oe,Ee,Se,{submission:Ve,fetcherSubmission:xe,preventScrollReset:$e,replace:He}={}){Ee.response.headers.has("X-Remix-Revalidate")&&(R=!0);let J=Ee.response.headers.get("Location");cn(J,"Expected a Location header on the redirect Response"),J=lS(J,new URL(oe.url),p);let Z=_c(k.location,J,{_isRedirect:!0});if(s){let Ke=!1;if(Ee.response.headers.has("X-Remix-Reload-Document"))Ke=!0;else if(ag(J)){const ot=UN(J,!0);Ke=ot.origin!==n.location.origin||Oa(ot.pathname,p)==null}if(Ke){He?n.location.replace(J):n.location.assign(J);return}}z=null;let je=He===!0||Ee.response.headers.has("X-Remix-Replace")?"REPLACE":"PUSH",{formMethod:Ne,formAction:pe,formEncType:Ue}=k.navigation;!Ve&&!xe&&Ne&&pe&&Ue&&(Ve=mS(k.navigation));let ae=Ve||xe;if(k2.has(Ee.response.status)&&ae&&Ia(ae.formMethod))await se(je,Z,{submission:{...ae,formAction:J},preventScrollReset:$e||L,enableViewTransition:Se?G:void 0});else{let Ke=sp(Z,Ve);await se(je,Z,{overrideNavigation:Ke,fetcherSubmission:xe,preventScrollReset:$e||L,enableViewTransition:Se?G:void 0})}}async function we(oe,Ee,Se,Ve){let xe,$e={};try{xe=await q2(h,oe,Ee,Ve,Se,!1)}catch(He){return Ee.filter(J=>J.shouldLoad).forEach(J=>{$e[J.route.id]={type:"error",error:He}}),$e}if(oe.signal.aborted)return $e;for(let[He,J]of Object.entries(xe))if(Z2(J)){let Z=J.result;$e[He]={type:"redirect",response:Y2(Z,oe,He,Ee,p)}}else $e[He]=await V2(J);return $e}async function st(oe,Ee,Se,Ve){let xe=we(Se,oe,Ve,null),$e=Promise.all(Ee.map(async Z=>{if(Z.matches&&Z.match&&Z.request&&Z.controller){let Ne=(await we(Z.request,Z.matches,Ve,Z.key))[Z.match.route.id];return{[Z.key]:Ne}}else return Promise.resolve({[Z.key]:{type:"error",error:is(404,{pathname:Z.path})}})})),He=await xe,J=(await $e).reduce((Z,je)=>Object.assign(Z,je),{});return{loaderResults:He,fetcherResults:J}}function lt(){R=!0,I.forEach((oe,Ee)=>{D.has(Ee)&&B.add(Ee),fe(Ee)})}function Fe(oe,Ee,Se={}){k.fetchers.set(oe,Ee),re({fetchers:new Map(k.fetchers)},{flushSync:(Se&&Se.flushSync)===!0})}function Xe(oe,Ee,Se,Ve={}){let xe=ei(k.matches,Ee);ee(oe),re({errors:{[xe.route.id]:Se},fetchers:new Map(k.fetchers)},{flushSync:(Ve&&Ve.flushSync)===!0})}function dt(oe){return Y.set(oe,(Y.get(oe)||0)+1),P.has(oe)&&P.delete(oe),k.fetchers.get(oe)||R2}function ie(oe,Ee){fe(oe,Ee?.reason),Fe(oe,hr(null))}function ee(oe){let Ee=k.fetchers.get(oe);D.has(oe)&&!(Ee&&Ee.state==="loading"&&F.has(oe))&&fe(oe),I.delete(oe),F.delete(oe),H.delete(oe),P.delete(oe),B.delete(oe),k.fetchers.delete(oe)}function ce(oe){let Ee=(Y.get(oe)||0)-1;Ee<=0?(Y.delete(oe),P.add(oe)):Y.set(oe,Ee),re({fetchers:new Map(k.fetchers)})}function fe(oe,Ee){let Se=D.get(oe);Se&&(Se.abort(Ee),D.delete(oe))}function qe(oe){for(let Ee of oe){let Se=dt(Ee),Ve=hr(Se.data);k.fetchers.set(Ee,Ve)}}function Pe(){let oe=[],Ee=!1;for(let Se of H){let Ve=k.fetchers.get(Se);cn(Ve,`Expected fetcher: ${Se}`),Ve.state==="loading"&&(H.delete(Se),oe.push(Se),Ee=!0)}return qe(oe),Ee}function Be(oe){let Ee=[];for(let[Se,Ve]of F)if(Ve<oe){let xe=k.fetchers.get(Se);cn(xe,`Expected fetcher: ${Se}`),xe.state==="loading"&&(fe(Se),F.delete(Se),Ee.push(Se))}return qe(Ee),Ee.length>0}function Te(oe,Ee){let Se=k.blockers.get(oe)||ki;return W.get(oe)!==Ee&&W.set(oe,Ee),Se}function gt(oe){k.blockers.delete(oe),W.delete(oe)}function jt(oe,Ee){let Se=k.blockers.get(oe)||ki;cn(Se.state==="unblocked"&&Ee.state==="blocked"||Se.state==="blocked"&&Ee.state==="blocked"||Se.state==="blocked"&&Ee.state==="proceeding"||Se.state==="blocked"&&Ee.state==="unblocked"||Se.state==="proceeding"&&Ee.state==="unblocked",`Invalid blocker state transition: ${Se.state} -> ${Ee.state}`);let Ve=new Map(k.blockers);Ve.set(oe,Ee),re({blockers:Ve})}function Mt({currentLocation:oe,nextLocation:Ee,historyAction:Se}){if(W.size===0)return;W.size>1&&Gn(!1,"A router only supports one blocker at a time");let Ve=Array.from(W.entries()),[xe,$e]=Ve[Ve.length-1],He=k.blockers.get(xe);if(!(He&&He.state==="proceeding")&&$e({currentLocation:oe,nextLocation:Ee,historyAction:Se}))return xe}function tt(oe){let Ee=is(404,{pathname:oe}),Se=f||d,{matches:Ve,route:xe}=sd(Se);return{notFoundMatches:Ve,route:xe,error:Ee}}function ft(oe,Ee,Se){if(v=oe,N=Ee,S=Se||null,!j&&k.navigation===ap){j=!0;let Ve=Zt(k.location,k.matches);Ve!=null&&re({restoreScrollPosition:Ve})}return()=>{v=null,N=null,S=null}}function Rt(oe,Ee){return S&&S(oe,Ee.map(Ve=>o2(Ve,k.loaderData)))||oe.key}function Ft(oe,Ee){if(v&&N){let Se=Rt(oe,Ee);v[Se]=N()}}function Zt(oe,Ee){if(v){let Se=Rt(oe,Ee),Ve=v[Se];if(typeof Ve=="number")return Ve}return null}function Tt(oe,Ee,Se){if(e.patchRoutesOnNavigation)if(oe){if(Object.keys(oe[0].params).length>0)return{active:!0,matches:Ld(Ee,Se,p,!0)}}else return{active:!0,matches:Ld(Ee,Se,p,!0)||[]};return{active:!1,matches:null}}async function We(oe,Ee,Se,Ve){if(!e.patchRoutesOnNavigation)return{type:"success",matches:oe};let xe=oe;for(;;){let $e=f==null,He=f||d,J=o;try{await e.patchRoutesOnNavigation({signal:Se,path:Ee,matches:xe,fetcherKey:Ve,patch:(Ne,pe)=>{Se.aborted||aS(Ne,pe,He,J,l,!1)}})}catch(Ne){return{type:"error",error:Ne,partialMatches:xe}}finally{$e&&!Se.aborted&&(d=[...d])}if(Se.aborted)return{type:"aborted"};let Z=Jr(He,Ee,p);if(Z)return{type:"success",matches:Z};let je=Ld(He,Ee,p,!0);if(!je||xe.length===je.length&&xe.every((Ne,pe)=>Ne.route.id===je[pe].route.id))return{type:"success",matches:null};xe=je}}function it(oe){o={},f=Cc(oe,l,void 0,o)}function bt(oe,Ee,Se=!1){let Ve=f==null;aS(oe,Ee,f||d,o,l,Se),Ve&&(d=[...d],re({}))}return T={get basename(){return p},get future(){return y},get state(){return k},get routes(){return d},get window(){return n},initialize:de,subscribe:he,enableScrollRestoration:ft,navigate:Re,fetch:mt,revalidate:ue,createHref:oe=>e.history.createHref(oe),encodeLocation:oe=>e.history.encodeLocation(oe),getFetcher:dt,resetFetcher:ie,deleteFetcher:ce,dispose:Q,getBlocker:Te,deleteBlocker:gt,patchRoutes:bt,_internalFetchControllers:D,_internalSetRoutes:it,_internalSetStateDoNotUseOrYouWillBreakYourApp(oe){re(oe)}},T}function O2(e){return e!=null&&("formData"in e&&e.formData!=null||"body"in e&&e.body!==void 0)}function uy(e,n,s,i,l,o){let d,f;if(l){d=[];for(let h of n)if(d.push(h),h.route.id===l){f=h;break}}else d=n,f=n[n.length-1];let p=vf(i||".",xf(d),Oa(e.pathname,s)||e.pathname,o==="path");if(i==null&&(p.search=e.search,p.hash=e.hash),(i==null||i===""||i===".")&&f){let h=rg(p.search);if(f.route.index&&!h)p.search=p.search?p.search.replace(/^\?/,"?index&"):"?index";else if(!f.route.index&&h){let y=new URLSearchParams(p.search),g=y.getAll("index");y.delete("index"),g.filter(v=>v).forEach(v=>y.append("index",v));let b=y.toString();p.search=b?`?${b}`:""}}return s!=="/"&&(p.pathname=S2({basename:s,pathname:p.pathname})),si(p)}function tS(e,n,s){if(!s||!O2(s))return{path:n};if(s.formMethod&&!Q2(s.formMethod))return{path:n,error:is(405,{method:s.formMethod})};let i=()=>({path:n,error:is(400,{type:"invalid-body"})}),o=(s.formMethod||"get").toUpperCase(),d=JN(n);if(s.body!==void 0){if(s.formEncType==="text/plain"){if(!Ia(o))return i();let g=typeof s.body=="string"?s.body:s.body instanceof FormData||s.body instanceof URLSearchParams?Array.from(s.body.entries()).reduce((b,[v,S])=>`${b}${v}=${S}
`,""):String(s.body);return{path:n,submission:{formMethod:o,formAction:d,formEncType:s.formEncType,formData:void 0,json:void 0,text:g}}}else if(s.formEncType==="application/json"){if(!Ia(o))return i();try{let g=typeof s.body=="string"?JSON.parse(s.body):s.body;return{path:n,submission:{formMethod:o,formAction:d,formEncType:s.formEncType,formData:void 0,json:g,text:void 0}}}catch{return i()}}}cn(typeof FormData=="function","FormData is not available in this environment");let f,p;if(s.formData)f=my(s.formData),p=s.formData;else if(s.body instanceof FormData)f=my(s.body),p=s.body;else if(s.body instanceof URLSearchParams)f=s.body,p=oS(f);else if(s.body==null)f=new URLSearchParams,p=new FormData;else try{f=new URLSearchParams(s.body),p=oS(f)}catch{return i()}let h={formMethod:o,formAction:d,formEncType:s&&s.formEncType||"application/x-www-form-urlencoded",formData:p,json:void 0,text:void 0};if(Ia(h.formMethod))return{path:n,submission:h};let y=oi(n);return e&&y.search&&rg(y.search)&&f.append("index",""),y.search=`?${f}`,{path:si(y),submission:h}}function nS(e,n,s,i,l,o,d,f,p,h,y,g,b,v,S,N,j,E,A,M){let _=M?Va(M[1])?M[1].error:M[1].data:void 0,T=l.createURL(o.location),k=l.createURL(p),C;if(y&&o.errors){let V=Object.keys(o.errors)[0];C=d.findIndex(R=>R.route.id===V)}else if(M&&Va(M[1])){let V=M[0];C=d.findIndex(R=>R.route.id===V)-1}let L=M?M[1].statusCode:void 0,z=L&&L>=400,G={currentUrl:T,currentParams:o.matches[0]?.params||{},nextUrl:k,nextParams:d[0].params,...f,actionResult:_,actionStatus:L},U=d.map((V,R)=>{let{route:B}=V,D=null;if(C!=null&&R>C?D=!1:B.lazy?D=!0:sg(B)?y?D=dy(B,o.loaderData,o.errors):$2(o.loaderData,o.matches[R],V)&&(D=!0):D=!1,D!==null)return fy(s,i,e,V,h,n,D);let O=z?!1:g||T.pathname+T.search===k.pathname+k.search||T.search!==k.search||F2(o.matches[R],V),$={...G,defaultShouldRevalidate:O},F=Zd(V,$);return fy(s,i,e,V,h,n,F,$)}),X=[];return S.forEach((V,R)=>{if(y||!d.some(Y=>Y.route.id===V.routeId)||v.has(R))return;let B=o.fetchers.get(R),D=B&&B.state!=="idle"&&B.data===void 0,O=Jr(j,V.path,E);if(!O){if(A&&D)return;X.push({key:R,routeId:V.routeId,path:V.path,matches:null,match:null,request:null,controller:null});return}if(N.has(R))return;let $=Dd(O,V.path),F=new AbortController,H=Dl(l,V.path,F.signal),I=null;if(b.has(R))b.delete(R),I=Fl(s,i,H,O,$,h,n);else if(D)g&&(I=Fl(s,i,H,O,$,h,n));else{let Y={...G,defaultShouldRevalidate:z?!1:g};Zd($,Y)&&(I=Fl(s,i,H,O,$,h,n,Y))}I&&X.push({key:R,routeId:V.routeId,path:V.path,matches:I,match:$,request:H,controller:F})}),{dsMatches:U,revalidatingFetchers:X}}function sg(e){return e.loader!=null||e.middleware!=null&&e.middleware.length>0}function dy(e,n,s){if(e.lazy)return!0;if(!sg(e))return!1;let i=n!=null&&e.id in n,l=s!=null&&s[e.id]!==void 0;return!i&&l?!1:typeof e.loader=="function"&&e.loader.hydrate===!0?!0:!i&&!l}function $2(e,n,s){let i=!n||s.route.id!==n.route.id,l=!e.hasOwnProperty(s.route.id);return i||l}function F2(e,n){let s=e.route.path;return e.pathname!==n.pathname||s!=null&&s.endsWith("*")&&e.params["*"]!==n.params["*"]}function Zd(e,n){if(e.route.shouldRevalidate){let s=e.route.shouldRevalidate(n);if(typeof s=="boolean")return s}return n.defaultShouldRevalidate}function aS(e,n,s,i,l,o){let d;if(e){let h=i[e];cn(h,`No route found to patch children into: routeId = ${e}`),h.children||(h.children=[]),d=h.children}else d=s;let f=[],p=[];if(n.forEach(h=>{let y=d.find(g=>WN(h,g));y?p.push({existingRoute:y,newRoute:h}):f.push(h)}),f.length>0){let h=Cc(f,l,[e||"_","patch",String(d?.length||"0")],i);d.push(...h)}if(o&&p.length>0)for(let h=0;h<p.length;h++){let{existingRoute:y,newRoute:g}=p[h],b=y,[v]=Cc([g],l,[],{},!0);Object.assign(b,{element:v.element?v.element:b.element,errorElement:v.errorElement?v.errorElement:b.errorElement,hydrateFallbackElement:v.hydrateFallbackElement?v.hydrateFallbackElement:b.hydrateFallbackElement})}}function WN(e,n){return"id"in e&&"id"in n&&e.id===n.id?!0:e.index===n.index&&e.path===n.path&&e.caseSensitive===n.caseSensitive?(!e.children||e.children.length===0)&&(!n.children||n.children.length===0)?!0:e.children.every((s,i)=>n.children?.some(l=>WN(s,l))):!1}var sS=new WeakMap,XN=({key:e,route:n,manifest:s,mapRouteProperties:i})=>{let l=s[n.id];if(cn(l,"No route found in manifest"),!l.lazy||typeof l.lazy!="object")return;let o=l.lazy[e];if(!o)return;let d=sS.get(l);d||(d={},sS.set(l,d));let f=d[e];if(f)return f;let p=(async()=>{let h=s2(e),g=l[e]!==void 0&&e!=="hasErrorBoundary";if(h)Gn(!h,"Route property "+e+" is not a supported lazy route property. This property will be ignored."),d[e]=Promise.resolve();else if(g)Gn(!1,`Route "${l.id}" has a static property "${e}" defined. The lazy property will be ignored.`);else{let b=await o();b!=null&&(Object.assign(l,{[e]:b}),Object.assign(l,i(l)))}typeof l.lazy=="object"&&(l.lazy[e]=void 0,Object.values(l.lazy).every(b=>b===void 0)&&(l.lazy=void 0))})();return d[e]=p,p},rS=new WeakMap;function z2(e,n,s,i,l){let o=s[e.id];if(cn(o,"No route found in manifest"),!e.lazy)return{lazyRoutePromise:void 0,lazyHandlerPromise:void 0};if(typeof e.lazy=="function"){let y=rS.get(o);if(y)return{lazyRoutePromise:y,lazyHandlerPromise:y};let g=(async()=>{cn(typeof e.lazy=="function","No lazy route function found");let b=await e.lazy(),v={};for(let S in b){let N=b[S];if(N===void 0)continue;let j=i2(S),A=o[S]!==void 0&&S!=="hasErrorBoundary";j?Gn(!j,"Route property "+S+" is not a supported property to be returned from a lazy route function. This property will be ignored."):A?Gn(!A,`Route "${o.id}" has a static property "${S}" defined but its lazy function is also returning a value for this property. The lazy route property "${S}" will be ignored.`):v[S]=N}Object.assign(o,v),Object.assign(o,{...i(o),lazy:void 0})})();return rS.set(o,g),g.catch(()=>{}),{lazyRoutePromise:g,lazyHandlerPromise:g}}let d=Object.keys(e.lazy),f=[],p;for(let y of d){if(l&&l.includes(y))continue;let g=XN({key:y,route:e,manifest:s,mapRouteProperties:i});g&&(f.push(g),y===n&&(p=g))}let h=f.length>0?Promise.all(f).then(()=>{}):void 0;return h?.catch(()=>{}),p?.catch(()=>{}),{lazyRoutePromise:h,lazyHandlerPromise:p}}async function iS(e){let n=e.matches.filter(l=>l.shouldLoad),s={};return(await Promise.all(n.map(l=>l.resolve()))).forEach((l,o)=>{s[n[o].route.id]=l}),s}async function B2(e){return e.matches.some(n=>n.route.middleware)?KN(e,()=>iS(e)):iS(e)}function KN(e,n){return U2(e,n,i=>i,X2,s);function s(i,l,o){if(o)return Promise.resolve(Object.assign(o.value,{[l]:{type:"error",result:i}}));{let{matches:d}=e,f=Math.min(Math.max(d.findIndex(h=>h.route.id===l),0),Math.max(d.findIndex(h=>h.unstable_shouldCallHandler()),0)),p=ei(d,d[f].route.id).route.id;return Promise.resolve({[p]:{type:"error",result:i}})}}}async function U2(e,n,s,i,l){let{matches:o,request:d,params:f,context:p}=e,h=o.flatMap(g=>g.route.middleware?g.route.middleware.map(b=>[g.route.id,b]):[]);return await ZN({request:d,params:f,context:p},h,n,s,i,l)}async function ZN(e,n,s,i,l,o,d=0){let{request:f}=e;if(f.signal.aborted)throw f.signal.reason??new Error(`Request aborted: ${f.method} ${f.url}`);let p=n[d];if(!p)return await s();let[h,y]=p,g,b=async()=>{if(g)throw new Error("You may only call `next()` once per middleware");try{return g={value:await ZN(e,n,s,i,l,o,d+1)},g.value}catch(v){return g={value:await o(v,h,g)},g.value}};try{let v=await y(e,b),S=v!=null?i(v):void 0;return l(S)?S:g?S??g.value:(g={value:await b()},g.value)}catch(v){return await o(v,h,g)}}function QN(e,n,s,i,l){let o=XN({key:"middleware",route:i.route,manifest:n,mapRouteProperties:e}),d=z2(i.route,Ia(s.method)?"action":"loader",n,e,l);return{middleware:o,route:d.lazyRoutePromise,handler:d.lazyHandlerPromise}}function fy(e,n,s,i,l,o,d,f=null){let p=!1,h=QN(e,n,s,i,l);return{...i,_lazyPromises:h,shouldLoad:d,unstable_shouldRevalidateArgs:f,unstable_shouldCallHandler(y){return p=!0,f?typeof y=="boolean"?Zd(i,{...f,defaultShouldRevalidate:y}):Zd(i,f):d},resolve(y){let{lazy:g,loader:b,middleware:v}=i.route,S=p||d||y&&!Ia(s.method)&&(g||b),N=v&&v.length>0&&!b&&!g;return S&&!N?P2({request:s,match:i,lazyHandlerPromise:h?.handler,lazyRoutePromise:h?.route,handlerOverride:y,scopedContext:o}):Promise.resolve({type:"data",result:void 0})}}}function Fl(e,n,s,i,l,o,d,f=null){return i.map(p=>p.route.id!==l.route.id?{...p,shouldLoad:!1,unstable_shouldRevalidateArgs:f,unstable_shouldCallHandler:()=>!1,_lazyPromises:QN(e,n,s,p,o),resolve:()=>Promise.resolve({type:"data",result:void 0})}:fy(e,n,s,p,o,d,!0,f))}async function q2(e,n,s,i,l,o){s.some(h=>h._lazyPromises?.middleware)&&await Promise.all(s.map(h=>h._lazyPromises?.middleware));let d={request:n,params:s[0].params,context:l,matches:s},p=await e({...d,fetcherKey:i,runClientMiddleware:h=>{let y=d;return KN(y,()=>h({...y,fetcherKey:i,runClientMiddleware:()=>{throw new Error("Cannot call `runClientMiddleware()` from within an `runClientMiddleware` handler")}}))}});try{await Promise.all(s.flatMap(h=>[h._lazyPromises?.handler,h._lazyPromises?.route]))}catch{}return p}async function P2({request:e,match:n,lazyHandlerPromise:s,lazyRoutePromise:i,handlerOverride:l,scopedContext:o}){let d,f,p=Ia(e.method),h=p?"action":"loader",y=g=>{let b,v=new Promise((j,E)=>b=E);f=()=>b(),e.signal.addEventListener("abort",f);let S=j=>typeof g!="function"?Promise.reject(new Error(`You cannot call the handler for a route which defines a boolean "${h}" [routeId: ${n.route.id}]`)):g({request:e,params:n.params,context:o},...j!==void 0?[j]:[]),N=(async()=>{try{return{type:"data",result:await(l?l(E=>S(E)):S())}}catch(j){return{type:"error",result:j}}})();return Promise.race([N,v])};try{let g=p?n.route.action:n.route.loader;if(s||i)if(g){let b,[v]=await Promise.all([y(g).catch(S=>{b=S}),s,i]);if(b!==void 0)throw b;d=v}else{await s;let b=p?n.route.action:n.route.loader;if(b)[d]=await Promise.all([y(b),i]);else if(h==="action"){let v=new URL(e.url),S=v.pathname+v.search;throw is(405,{method:e.method,pathname:S,routeId:n.route.id})}else return{type:"data",result:void 0}}else if(g)d=await y(g);else{let b=new URL(e.url),v=b.pathname+b.search;throw is(404,{pathname:v})}}catch(g){return{type:"error",result:g}}finally{f&&e.signal.removeEventListener("abort",f)}return d}async function H2(e){let n=e.headers.get("Content-Type");return n&&/\bapplication\/json\b/.test(n)?e.body==null?null:e.json():e.text()}async function V2(e){let{result:n,type:s}=e;if(ej(n)){let i;try{i=await H2(n)}catch(l){return{type:"error",error:l}}return s==="error"?{type:"error",error:new Kd(n.status,n.statusText,i),statusCode:n.status,headers:n.headers}:{type:"data",data:i,statusCode:n.status,headers:n.headers}}return s==="error"?fS(n)?n.data instanceof Error?{type:"error",error:n.data,statusCode:n.init?.status,headers:n.init?.headers?new Headers(n.init.headers):void 0}:{type:"error",error:new Kd(n.init?.status||500,void 0,n.data),statusCode:Ac(n)?n.status:void 0,headers:n.init?.headers?new Headers(n.init.headers):void 0}:{type:"error",error:n,statusCode:Ac(n)?n.status:void 0}:fS(n)?{type:"data",data:n.data,statusCode:n.init?.status,headers:n.init?.headers?new Headers(n.init.headers):void 0}:{type:"data",data:n}}function Y2(e,n,s,i,l){let o=e.headers.get("Location");if(cn(o,"Redirects returned/thrown from loaders/actions must have a Location header"),!ag(o)){let d=i.slice(0,i.findIndex(f=>f.route.id===s)+1);o=uy(new URL(n.url),d,l,o),e.headers.set("Location",o)}return e}function lS(e,n,s){if(ag(e)){let i=e,l=i.startsWith("//")?new URL(n.protocol+i):new URL(i),o=Oa(l.pathname,s)!=null;if(l.origin===n.origin&&o)return l.pathname+l.search+l.hash}return e}function Dl(e,n,s,i){let l=e.createURL(JN(n)).toString(),o={signal:s};if(i&&Ia(i.formMethod)){let{formMethod:d,formEncType:f}=i;o.method=d.toUpperCase(),f==="application/json"?(o.headers=new Headers({"Content-Type":f}),o.body=JSON.stringify(i.json)):f==="text/plain"?o.body=i.text:f==="application/x-www-form-urlencoded"&&i.formData?o.body=my(i.formData):o.body=i.formData}return new Request(l,o)}function my(e){let n=new URLSearchParams;for(let[s,i]of e.entries())n.append(s,typeof i=="string"?i:i.name);return n}function oS(e){let n=new FormData;for(let[s,i]of e.entries())n.append(s,i);return n}function G2(e,n,s,i=!1,l=!1){let o={},d=null,f,p=!1,h={},y=s&&Va(s[1])?s[1].error:void 0;return e.forEach(g=>{if(!(g.route.id in n))return;let b=g.route.id,v=n[b];if(cn(!Ii(v),"Cannot handle redirect results in processLoaderData"),Va(v)){let S=v.error;if(y!==void 0&&(S=y,y=void 0),d=d||{},l)d[b]=S;else{let N=ei(e,b);d[N.route.id]==null&&(d[N.route.id]=S)}i||(o[b]=GN),p||(p=!0,f=Ac(v.error)?v.error.status:500),v.headers&&(h[b]=v.headers)}else o[b]=v.data,v.statusCode&&v.statusCode!==200&&!p&&(f=v.statusCode),v.headers&&(h[b]=v.headers)}),y!==void 0&&s&&(d={[s[0]]:y},s[2]&&(o[s[2]]=void 0)),{loaderData:o,errors:d,statusCode:f||200,loaderHeaders:h}}function cS(e,n,s,i,l,o){let{loaderData:d,errors:f}=G2(n,s,i);return l.filter(p=>!p.matches||p.matches.some(h=>h.shouldLoad)).forEach(p=>{let{key:h,match:y,controller:g}=p;if(g&&g.signal.aborted)return;let b=o[h];if(cn(b,"Did not find corresponding fetcher result"),Va(b)){let v=ei(e.matches,y?.route.id);f&&f[v.route.id]||(f={...f,[v.route.id]:b.error}),e.fetchers.delete(h)}else if(Ii(b))cn(!1,"Unhandled fetcher revalidation redirect");else{let v=hr(b.data);e.fetchers.set(h,v)}}),{loaderData:d,errors:f}}function uS(e,n,s,i){let l=Object.entries(n).filter(([,o])=>o!==GN).reduce((o,[d,f])=>(o[d]=f,o),{});for(let o of s){let d=o.route.id;if(!n.hasOwnProperty(d)&&e.hasOwnProperty(d)&&o.route.loader&&(l[d]=e[d]),i&&i.hasOwnProperty(d))break}return l}function dS(e){return e?Va(e[1])?{actionData:{}}:{actionData:{[e[0]]:e[1].data}}:{}}function ei(e,n){return(n?e.slice(0,e.findIndex(i=>i.route.id===n)+1):[...e]).reverse().find(i=>i.route.hasErrorBoundary===!0)||e[0]}function sd(e){let n=e.length===1?e[0]:e.find(s=>s.index||!s.path||s.path==="/")||{id:"__shim-error-route__"};return{matches:[{params:{},pathname:"",pathnameBase:"",route:n}],route:n}}function is(e,{pathname:n,routeId:s,method:i,type:l,message:o}={}){let d="Unknown Server Error",f="Unknown @remix-run/router error";return e===400?(d="Bad Request",i&&n&&s?f=`You made a ${i} request to "${n}" but did not provide a \`loader\` for route "${s}", so there is no way to handle the request.`:l==="invalid-body"&&(f="Unable to encode submission body")):e===403?(d="Forbidden",f=`Route "${s}" does not match URL "${n}"`):e===404?(d="Not Found",f=`No route matches URL "${n}"`):e===405&&(d="Method Not Allowed",i&&n&&s?f=`You made a ${i.toUpperCase()} request to "${n}" but did not provide an \`action\` for route "${s}", so there is no way to handle the request.`:i&&(f=`Invalid request method "${i.toUpperCase()}"`)),new Kd(e||500,d,new Error(f),!0)}function rd(e){let n=Object.entries(e);for(let s=n.length-1;s>=0;s--){let[i,l]=n[s];if(Ii(l))return{key:i,result:l}}}function JN(e){let n=typeof e=="string"?oi(e):e;return si({...n,hash:""})}function W2(e,n){return e.pathname!==n.pathname||e.search!==n.search?!1:e.hash===""?n.hash!=="":e.hash===n.hash?!0:n.hash!==""}function X2(e){return e!=null&&typeof e=="object"&&Object.entries(e).every(([n,s])=>typeof n=="string"&&K2(s))}function K2(e){return e!=null&&typeof e=="object"&&"type"in e&&"result"in e&&(e.type==="data"||e.type==="error")}function Z2(e){return ej(e.result)&&M2.has(e.result.status)}function Va(e){return e.type==="error"}function Ii(e){return(e&&e.type)==="redirect"}function fS(e){return typeof e=="object"&&e!=null&&"type"in e&&"data"in e&&"init"in e&&e.type==="DataWithResponseInit"}function ej(e){return e!=null&&typeof e.status=="number"&&typeof e.statusText=="string"&&typeof e.headers=="object"&&typeof e.body<"u"}function Q2(e){return T2.has(e.toUpperCase())}function Ia(e){return C2.has(e.toUpperCase())}function rg(e){return new URLSearchParams(e).getAll("index").some(n=>n==="")}function Dd(e,n){let s=typeof n=="string"?oi(n).search:n.search;if(e[e.length-1].route.index&&rg(s||""))return e[e.length-1];let i=HN(e);return i[i.length-1]}function mS(e){let{formMethod:n,formAction:s,formEncType:i,text:l,formData:o,json:d}=e;if(!(!n||!s||!i)){if(l!=null)return{formMethod:n,formAction:s,formEncType:i,formData:void 0,json:void 0,text:l};if(o!=null)return{formMethod:n,formAction:s,formEncType:i,formData:o,json:void 0,text:void 0};if(d!==void 0)return{formMethod:n,formAction:s,formEncType:i,formData:void 0,json:d,text:void 0}}}function sp(e,n){return n?{state:"loading",location:e,formMethod:n.formMethod,formAction:n.formAction,formEncType:n.formEncType,formData:n.formData,json:n.json,text:n.text}:{state:"loading",location:e,formMethod:void 0,formAction:void 0,formEncType:void 0,formData:void 0,json:void 0,text:void 0}}function J2(e,n){return{state:"submitting",location:e,formMethod:n.formMethod,formAction:n.formAction,formEncType:n.formEncType,formData:n.formData,json:n.json,text:n.text}}function Zo(e,n){return e?{state:"loading",formMethod:e.formMethod,formAction:e.formAction,formEncType:e.formEncType,formData:e.formData,json:e.json,text:e.text,data:n}:{state:"loading",formMethod:void 0,formAction:void 0,formEncType:void 0,formData:void 0,json:void 0,text:void 0,data:n}}function eT(e,n){return{state:"submitting",formMethod:e.formMethod,formAction:e.formAction,formEncType:e.formEncType,formData:e.formData,json:e.json,text:e.text,data:n?n.data:void 0}}function hr(e){return{state:"idle",formMethod:void 0,formAction:void 0,formEncType:void 0,formData:void 0,json:void 0,text:void 0,data:e}}function tT(e,n){try{let s=e.sessionStorage.getItem(YN);if(s){let i=JSON.parse(s);for(let[l,o]of Object.entries(i||{}))o&&Array.isArray(o)&&n.set(l,new Set(o||[]))}}catch{}}function nT(e,n){if(n.size>0){let s={};for(let[i,l]of n)s[i]=[...l];try{e.sessionStorage.setItem(YN,JSON.stringify(s))}catch(i){Gn(!1,`Failed to save applied view transitions in sessionStorage (${i}).`)}}}function aT(){let e,n,s=new Promise((i,l)=>{e=async o=>{i(o);try{await s}catch{}},n=async o=>{l(o);try{await s}catch{}}});return{promise:s,resolve:e,reject:n}}var Hi=u.createContext(null);Hi.displayName="DataRouter";var Pc=u.createContext(null);Pc.displayName="DataRouterState";u.createContext(!1);var ig=u.createContext({isTransitioning:!1});ig.displayName="ViewTransition";var tj=u.createContext(new Map);tj.displayName="Fetchers";var sT=u.createContext(null);sT.displayName="Await";var Ts=u.createContext(null);Ts.displayName="Navigation";var Sf=u.createContext(null);Sf.displayName="Location";var ms=u.createContext({outlet:null,matches:[],isDataRoute:!1});ms.displayName="Route";var lg=u.createContext(null);lg.displayName="RouteError";function rT(e,{relative:n}={}){cn(Zl(),"useHref() may be used only in the context of a <Router> component.");let{basename:s,navigator:i}=u.useContext(Ts),{hash:l,pathname:o,search:d}=Hc(e,{relative:n}),f=o;return s!=="/"&&(f=o==="/"?s:Us([s,o])),i.createHref({pathname:f,search:d,hash:l})}function Zl(){return u.useContext(Sf)!=null}function Xa(){return cn(Zl(),"useLocation() may be used only in the context of a <Router> component."),u.useContext(Sf).location}var nj="You should call navigate() in a React.useEffect(), not when your component is first rendered.";function aj(e){u.useContext(Ts).static||u.useLayoutEffect(e)}function _n(){let{isDataRoute:e}=u.useContext(ms);return e?xT():iT()}function iT(){cn(Zl(),"useNavigate() may be used only in the context of a <Router> component.");let e=u.useContext(Hi),{basename:n,navigator:s}=u.useContext(Ts),{matches:i}=u.useContext(ms),{pathname:l}=Xa(),o=JSON.stringify(xf(i)),d=u.useRef(!1);return aj(()=>{d.current=!0}),u.useCallback((p,h={})=>{if(Gn(d.current,nj),!d.current)return;if(typeof p=="number"){s.go(p);return}let y=vf(p,JSON.parse(o),l,h.relative==="path");e==null&&n!=="/"&&(y.pathname=y.pathname==="/"?n:Us([n,y.pathname])),(h.replace?s.replace:s.push)(y,h.state,h)},[n,s,o,l,e])}var lT=u.createContext(null);function oT(e){let n=u.useContext(ms).outlet;return u.useMemo(()=>n&&u.createElement(lT.Provider,{value:e},n),[n,e])}function Ka(){let{matches:e}=u.useContext(ms),n=e[e.length-1];return n?n.params:{}}function Hc(e,{relative:n}={}){let{matches:s}=u.useContext(ms),{pathname:i}=Xa(),l=JSON.stringify(xf(s));return u.useMemo(()=>vf(e,JSON.parse(l),i,n==="path"),[e,l,i,n])}function cT(e,n,s,i,l){cn(Zl(),"useRoutes() may be used only in the context of a <Router> component.");let{navigator:o}=u.useContext(Ts),{matches:d}=u.useContext(ms),f=d[d.length-1],p=f?f.params:{},h=f?f.pathname:"/",y=f?f.pathnameBase:"/",g=f&&f.route;{let A=g&&g.path||"";lj(h,!g||A.endsWith("*")||A.endsWith("*?"),`You rendered descendant <Routes> (or called \`useRoutes()\`) at "${h}" (under <Route path="${A}">) but the parent route path has no trailing "*". This means if you navigate deeper, the parent won't match anymore and therefore the child routes will never render.

Please change the parent <Route path="${A}"> to <Route path="${A==="/"?"*":`${A}/*`}">.`)}let b=Xa(),v;v=b;let S=v.pathname||"/",N=S;if(y!=="/"){let A=y.replace(/^\//,"").split("/");N="/"+S.replace(/^\//,"").split("/").slice(A.length).join("/")}let j=Jr(e,{pathname:N});return Gn(g||j!=null,`No routes matched location "${v.pathname}${v.search}${v.hash}" `),Gn(j==null||j[j.length-1].route.element!==void 0||j[j.length-1].route.Component!==void 0||j[j.length-1].route.lazy!==void 0,`Matched leaf route at location "${v.pathname}${v.search}${v.hash}" does not have an element or Component. This means it will render an <Outlet /> with a null value by default resulting in an "empty" page.`),hT(j&&j.map(A=>Object.assign({},A,{params:Object.assign({},p,A.params),pathname:Us([y,o.encodeLocation?o.encodeLocation(A.pathname.replace(/\?/g,"%3F").replace(/#/g,"%23")).pathname:A.pathname]),pathnameBase:A.pathnameBase==="/"?y:Us([y,o.encodeLocation?o.encodeLocation(A.pathnameBase.replace(/\?/g,"%3F").replace(/#/g,"%23")).pathname:A.pathnameBase])})),d,s,i,l)}function uT(){let e=gT(),n=Ac(e)?`${e.status} ${e.statusText}`:e instanceof Error?e.message:JSON.stringify(e),s=e instanceof Error?e.stack:null,i="rgba(200,200,200, 0.5)",l={padding:"0.5rem",backgroundColor:i},o={padding:"2px 4px",backgroundColor:i},d=null;return console.error("Error handled by React Router default ErrorBoundary:",e),d=u.createElement(u.Fragment,null,u.createElement("p",null," Hey developer "),u.createElement("p",null,"You can provide a way better UX than this when your app throws errors by providing your own ",u.createElement("code",{style:o},"ErrorBoundary")," or"," ",u.createElement("code",{style:o},"errorElement")," prop on your route.")),u.createElement(u.Fragment,null,u.createElement("h2",null,"Unexpected Application Error!"),u.createElement("h3",{style:{fontStyle:"italic"}},n),s?u.createElement("pre",{style:l},s):null,d)}var dT=u.createElement(uT,null),fT=class extends u.Component{constructor(e){super(e),this.state={location:e.location,revalidation:e.revalidation,error:e.error}}static getDerivedStateFromError(e){return{error:e}}static getDerivedStateFromProps(e,n){return n.location!==e.location||n.revalidation!=="idle"&&e.revalidation==="idle"?{error:e.error,location:e.location,revalidation:e.revalidation}:{error:e.error!==void 0?e.error:n.error,location:n.location,revalidation:e.revalidation||n.revalidation}}componentDidCatch(e,n){this.props.unstable_onError?this.props.unstable_onError(e,n):console.error("React Router caught the following error during render",e)}render(){return this.state.error!==void 0?u.createElement(ms.Provider,{value:this.props.routeContext},u.createElement(lg.Provider,{value:this.state.error,children:this.props.component})):this.props.children}};function mT({routeContext:e,match:n,children:s}){let i=u.useContext(Hi);return i&&i.static&&i.staticContext&&(n.route.errorElement||n.route.ErrorBoundary)&&(i.staticContext._deepestRenderedBoundaryId=n.route.id),u.createElement(ms.Provider,{value:e},s)}function hT(e,n=[],s=null,i=null,l=null){if(e==null){if(!s)return null;if(s.errors)e=s.matches;else if(n.length===0&&!s.initialized&&s.matches.length>0)e=s.matches;else return null}let o=e,d=s?.errors;if(d!=null){let h=o.findIndex(y=>y.route.id&&d?.[y.route.id]!==void 0);cn(h>=0,`Could not find a matching route for errors on route IDs: ${Object.keys(d).join(",")}`),o=o.slice(0,Math.min(o.length,h+1))}let f=!1,p=-1;if(s)for(let h=0;h<o.length;h++){let y=o[h];if((y.route.HydrateFallback||y.route.hydrateFallbackElement)&&(p=h),y.route.id){let{loaderData:g,errors:b}=s,v=y.route.loader&&!g.hasOwnProperty(y.route.id)&&(!b||b[y.route.id]===void 0);if(y.route.lazy||v){f=!0,p>=0?o=o.slice(0,p+1):o=[o[0]];break}}}return o.reduceRight((h,y,g)=>{let b,v=!1,S=null,N=null;s&&(b=d&&y.route.id?d[y.route.id]:void 0,S=y.route.errorElement||dT,f&&(p<0&&g===0?(lj("route-fallback",!1,"No `HydrateFallback` element provided to render during initial hydration"),v=!0,N=null):p===g&&(v=!0,N=y.route.hydrateFallbackElement||null)));let j=n.concat(o.slice(0,g+1)),E=()=>{let A;return b?A=S:v?A=N:y.route.Component?A=u.createElement(y.route.Component,null):y.route.element?A=y.route.element:A=h,u.createElement(mT,{match:y,routeContext:{outlet:h,matches:j,isDataRoute:s!=null},children:A})};return s&&(y.route.ErrorBoundary||y.route.errorElement||g===0)?u.createElement(fT,{location:s.location,revalidation:s.revalidation,component:S,error:b,children:E(),routeContext:{outlet:null,matches:j,isDataRoute:!0},unstable_onError:i}):E()},null)}function og(e){return`${e} must be used within a data router.  See https://reactrouter.com/en/main/routers/picking-a-router.`}function sj(e){let n=u.useContext(Hi);return cn(n,og(e)),n}function rj(e){let n=u.useContext(Pc);return cn(n,og(e)),n}function pT(e){let n=u.useContext(ms);return cn(n,og(e)),n}function cg(e){let n=pT(e),s=n.matches[n.matches.length-1];return cn(s.route.id,`${e} can only be used on routes that contain a unique "id"`),s.route.id}function yT(){return cg("useRouteId")}function gT(){let e=u.useContext(lg),n=rj("useRouteError"),s=cg("useRouteError");return e!==void 0?e:n.errors?.[s]}var bT=0;function ij(e){let{router:n,basename:s}=sj("useBlocker"),i=rj("useBlocker"),[l,o]=u.useState(""),d=u.useCallback(f=>{if(typeof e!="function")return!!e;if(s==="/")return e(f);let{currentLocation:p,nextLocation:h,historyAction:y}=f;return e({currentLocation:{...p,pathname:Oa(p.pathname,s)||p.pathname},nextLocation:{...h,pathname:Oa(h.pathname,s)||h.pathname},historyAction:y})},[s,e]);return u.useEffect(()=>{let f=String(++bT);return o(f),()=>n.deleteBlocker(f)},[n]),u.useEffect(()=>{l!==""&&n.getBlocker(l,d)},[n,l,d]),l&&i.blockers.has(l)?i.blockers.get(l):ki}function xT(){let{router:e}=sj("useNavigate"),n=cg("useNavigate"),s=u.useRef(!1);return aj(()=>{s.current=!0}),u.useCallback(async(l,o={})=>{Gn(s.current,nj),s.current&&(typeof l=="number"?e.navigate(l):await e.navigate(l,{fromRouteId:n,...o}))},[e,n])}var hS={};function lj(e,n,s){!n&&!hS[e]&&(hS[e]=!0,Gn(!1,s))}var pS={};function yS(e,n){!e&&!pS[n]&&(pS[n]=!0,console.warn(n))}function vT(e){let n={hasErrorBoundary:e.hasErrorBoundary||e.ErrorBoundary!=null||e.errorElement!=null};return e.Component&&(e.element&&Gn(!1,"You should not include both `Component` and `element` on your route - `Component` will be used."),Object.assign(n,{element:u.createElement(e.Component),Component:void 0})),e.HydrateFallback&&(e.hydrateFallbackElement&&Gn(!1,"You should not include both `HydrateFallback` and `hydrateFallbackElement` on your route - `HydrateFallback` will be used."),Object.assign(n,{hydrateFallbackElement:u.createElement(e.HydrateFallback),HydrateFallback:void 0})),e.ErrorBoundary&&(e.errorElement&&Gn(!1,"You should not include both `ErrorBoundary` and `errorElement` on your route - `ErrorBoundary` will be used."),Object.assign(n,{errorElement:u.createElement(e.ErrorBoundary),ErrorBoundary:void 0})),n}var ST=["HydrateFallback","hydrateFallbackElement"],wT=class{constructor(){this.status="pending",this.promise=new Promise((e,n)=>{this.resolve=s=>{this.status==="pending"&&(this.status="resolved",e(s))},this.reject=s=>{this.status==="pending"&&(this.status="rejected",n(s))}})}};function NT({router:e,flushSync:n,unstable_onError:s}){let[i,l]=u.useState(e.state),[o,d]=u.useState(),[f,p]=u.useState({isTransitioning:!1}),[h,y]=u.useState(),[g,b]=u.useState(),[v,S]=u.useState(),N=u.useRef(new Map),j=u.useCallback(T=>{l(k=>(T.errors&&s&&Object.entries(T.errors).forEach(([C,L])=>{k.errors?.[C]!==L&&s(L)}),T))},[s]),E=u.useCallback((T,{deletedFetchers:k,flushSync:C,viewTransitionOpts:L})=>{T.fetchers.forEach((G,U)=>{G.data!==void 0&&N.current.set(U,G.data)}),k.forEach(G=>N.current.delete(G)),yS(C===!1||n!=null,'You provided the `flushSync` option to a router update, but you are not using the `<RouterProvider>` from `react-router/dom` so `ReactDOM.flushSync()` is unavailable.  Please update your app to `import { RouterProvider } from "react-router/dom"` and ensure you have `react-dom` installed as a dependency to use the `flushSync` option.');let z=e.window!=null&&e.window.document!=null&&typeof e.window.document.startViewTransition=="function";if(yS(L==null||z,"You provided the `viewTransition` option to a router update, but you do not appear to be running in a DOM environment as `window.startViewTransition` is not available."),!L||!z){n&&C?n(()=>j(T)):u.startTransition(()=>j(T));return}if(n&&C){n(()=>{g&&(h&&h.resolve(),g.skipTransition()),p({isTransitioning:!0,flushSync:!0,currentLocation:L.currentLocation,nextLocation:L.nextLocation})});let G=e.window.document.startViewTransition(()=>{n(()=>j(T))});G.finished.finally(()=>{n(()=>{y(void 0),b(void 0),d(void 0),p({isTransitioning:!1})})}),n(()=>b(G));return}g?(h&&h.resolve(),g.skipTransition(),S({state:T,currentLocation:L.currentLocation,nextLocation:L.nextLocation})):(d(T),p({isTransitioning:!0,flushSync:!1,currentLocation:L.currentLocation,nextLocation:L.nextLocation}))},[e.window,n,g,h,j]);u.useLayoutEffect(()=>e.subscribe(E),[e,E]),u.useEffect(()=>{f.isTransitioning&&!f.flushSync&&y(new wT)},[f]),u.useEffect(()=>{if(h&&o&&e.window){let T=o,k=h.promise,C=e.window.document.startViewTransition(async()=>{u.startTransition(()=>j(T)),await k});C.finished.finally(()=>{y(void 0),b(void 0),d(void 0),p({isTransitioning:!1})}),b(C)}},[o,h,e.window,j]),u.useEffect(()=>{h&&o&&i.location.key===o.location.key&&h.resolve()},[h,g,i.location,o]),u.useEffect(()=>{!f.isTransitioning&&v&&(d(v.state),p({isTransitioning:!0,flushSync:!1,currentLocation:v.currentLocation,nextLocation:v.nextLocation}),S(void 0))},[f.isTransitioning,v]);let A=u.useMemo(()=>({createHref:e.createHref,encodeLocation:e.encodeLocation,go:T=>e.navigate(T),push:(T,k,C)=>e.navigate(T,{state:k,preventScrollReset:C?.preventScrollReset}),replace:(T,k,C)=>e.navigate(T,{replace:!0,state:k,preventScrollReset:C?.preventScrollReset})}),[e]),M=e.basename||"/",_=u.useMemo(()=>({router:e,navigator:A,static:!1,basename:M,unstable_onError:s}),[e,A,M,s]);return u.createElement(u.Fragment,null,u.createElement(Hi.Provider,{value:_},u.createElement(Pc.Provider,{value:i},u.createElement(tj.Provider,{value:N.current},u.createElement(ig.Provider,{value:f},u.createElement(CT,{basename:M,location:i.location,navigationType:i.historyAction,navigator:A},u.createElement(jT,{routes:e.routes,future:e.future,state:i,unstable_onError:s})))))),null)}var jT=u.memo(ET);function ET({routes:e,future:n,state:s,unstable_onError:i}){return cT(e,void 0,s,i,n)}function gc({to:e,replace:n,state:s,relative:i}){cn(Zl(),"<Navigate> may be used only in the context of a <Router> component.");let{static:l}=u.useContext(Ts);Gn(!l,"<Navigate> must not be used on the initial render in a <StaticRouter>. This is a no-op, but you should modify your code so the <Navigate> is only ever rendered in response to some user interaction or state change.");let{matches:o}=u.useContext(ms),{pathname:d}=Xa(),f=_n(),p=vf(e,xf(o),d,i==="path"),h=JSON.stringify(p);return u.useEffect(()=>{f(JSON.parse(h),{replace:n,state:s,relative:i})},[f,h,i,n,s]),null}function _T(e){return oT(e.context)}function Wt(e){cn(!1,"A <Route> is only ever to be used as the child of <Routes> element, never rendered directly. Please wrap your <Route> in a <Routes>.")}function CT({basename:e="/",children:n=null,location:s,navigationType:i="POP",navigator:l,static:o=!1}){cn(!Zl(),"You cannot render a <Router> inside another <Router>. You should never have more than one in your app.");let d=e.replace(/^\/*/,"/"),f=u.useMemo(()=>({basename:d,navigator:l,static:o,future:{}}),[d,l,o]);typeof s=="string"&&(s=oi(s));let{pathname:p="/",search:h="",hash:y="",state:g=null,key:b="default"}=s,v=u.useMemo(()=>{let S=Oa(p,d);return S==null?null:{location:{pathname:S,search:h,hash:y,state:g,key:b},navigationType:i}},[d,p,h,y,g,b,i]);return Gn(v!=null,`<Router basename="${d}"> is not able to match the URL "${p}${h}${y}" because it does not start with the basename, so the <Router> won't render anything.`),v==null?null:u.createElement(Ts.Provider,{value:f},u.createElement(Sf.Provider,{children:n,value:v}))}function hy(e,n=[]){let s=[];return u.Children.forEach(e,(i,l)=>{if(!u.isValidElement(i))return;let o=[...n,l];if(i.type===u.Fragment){s.push.apply(s,hy(i.props.children,o));return}cn(i.type===Wt,`[${typeof i.type=="string"?i.type:i.type.name}] is not a <Route> component. All component children of <Routes> must be a <Route> or <React.Fragment>`),cn(!i.props.index||!i.props.children,"An index route cannot have child routes.");let d={id:i.props.id||o.join("-"),caseSensitive:i.props.caseSensitive,element:i.props.element,Component:i.props.Component,index:i.props.index,path:i.props.path,middleware:i.props.middleware,loader:i.props.loader,action:i.props.action,hydrateFallbackElement:i.props.hydrateFallbackElement,HydrateFallback:i.props.HydrateFallback,errorElement:i.props.errorElement,ErrorBoundary:i.props.ErrorBoundary,hasErrorBoundary:i.props.hasErrorBoundary===!0||i.props.ErrorBoundary!=null||i.props.errorElement!=null,shouldRevalidate:i.props.shouldRevalidate,handle:i.props.handle,lazy:i.props.lazy};i.props.children&&(d.children=hy(i.props.children,o)),s.push(d)}),s}var AT=hy,Od="get",$d="application/x-www-form-urlencoded";function wf(e){return e!=null&&typeof e.tagName=="string"}function TT(e){return wf(e)&&e.tagName.toLowerCase()==="button"}function MT(e){return wf(e)&&e.tagName.toLowerCase()==="form"}function kT(e){return wf(e)&&e.tagName.toLowerCase()==="input"}function RT(e){return!!(e.metaKey||e.altKey||e.ctrlKey||e.shiftKey)}function IT(e,n){return e.button===0&&(!n||n==="_self")&&!RT(e)}function py(e=""){return new URLSearchParams(typeof e=="string"||Array.isArray(e)||e instanceof URLSearchParams?e:Object.keys(e).reduce((n,s)=>{let i=e[s];return n.concat(Array.isArray(i)?i.map(l=>[s,l]):[[s,i]])},[]))}function LT(e,n){let s=py(e);return n&&n.forEach((i,l)=>{s.has(l)||n.getAll(l).forEach(o=>{s.append(l,o)})}),s}var id=null;function DT(){if(id===null)try{new FormData(document.createElement("form"),0),id=!1}catch{id=!0}return id}var OT=new Set(["application/x-www-form-urlencoded","multipart/form-data","text/plain"]);function rp(e){return e!=null&&!OT.has(e)?(Gn(!1,`"${e}" is not a valid \`encType\` for \`<Form>\`/\`<fetcher.Form>\` and will default to "${$d}"`),null):e}function $T(e,n){let s,i,l,o,d;if(MT(e)){let f=e.getAttribute("action");i=f?Oa(f,n):null,s=e.getAttribute("method")||Od,l=rp(e.getAttribute("enctype"))||$d,o=new FormData(e)}else if(TT(e)||kT(e)&&(e.type==="submit"||e.type==="image")){let f=e.form;if(f==null)throw new Error('Cannot submit a <button> or <input type="submit"> without a <form>');let p=e.getAttribute("formaction")||f.getAttribute("action");if(i=p?Oa(p,n):null,s=e.getAttribute("formmethod")||f.getAttribute("method")||Od,l=rp(e.getAttribute("formenctype"))||rp(f.getAttribute("enctype"))||$d,o=new FormData(f,e),!DT()){let{name:h,type:y,value:g}=e;if(y==="image"){let b=h?`${h}.`:"";o.append(`${b}x`,"0"),o.append(`${b}y`,"0")}else h&&o.append(h,g)}}else{if(wf(e))throw new Error('Cannot submit element that is not <form>, <button>, or <input type="submit|image">');s=Od,i=null,l=$d,d=e}return o&&l==="text/plain"&&(d=o,o=void 0),{action:i,method:s.toLowerCase(),encType:l,formData:o,body:d}}Object.getOwnPropertyNames(Object.prototype).sort().join("\0");function ug(e,n){if(e===!1||e===null||typeof e>"u")throw new Error(n)}function FT(e,n,s){let i=typeof e=="string"?new URL(e,typeof window>"u"?"server://singlefetch/":window.location.origin):e;return i.pathname==="/"?i.pathname=`_root.${s}`:n&&Oa(i.pathname,n)==="/"?i.pathname=`${n.replace(/\/$/,"")}/_root.${s}`:i.pathname=`${i.pathname.replace(/\/$/,"")}.${s}`,i}async function zT(e,n){if(e.id in n)return n[e.id];try{let s=await import(e.module);return n[e.id]=s,s}catch(s){return console.error(`Error loading route module \`${e.module}\`, reloading page...`),console.error(s),window.__reactRouterContext&&window.__reactRouterContext.isSpaMode,window.location.reload(),new Promise(()=>{})}}function BT(e){return e==null?!1:e.href==null?e.rel==="preload"&&typeof e.imageSrcSet=="string"&&typeof e.imageSizes=="string":typeof e.rel=="string"&&typeof e.href=="string"}async function UT(e,n,s){let i=await Promise.all(e.map(async l=>{let o=n.routes[l.route.id];if(o){let d=await zT(o,s);return d.links?d.links():[]}return[]}));return VT(i.flat(1).filter(BT).filter(l=>l.rel==="stylesheet"||l.rel==="preload").map(l=>l.rel==="stylesheet"?{...l,rel:"prefetch",as:"style"}:{...l,rel:"prefetch"}))}function gS(e,n,s,i,l,o){let d=(p,h)=>s[h]?p.route.id!==s[h].route.id:!0,f=(p,h)=>s[h].pathname!==p.pathname||s[h].route.path?.endsWith("*")&&s[h].params["*"]!==p.params["*"];return o==="assets"?n.filter((p,h)=>d(p,h)||f(p,h)):o==="data"?n.filter((p,h)=>{let y=i.routes[p.route.id];if(!y||!y.hasLoader)return!1;if(d(p,h)||f(p,h))return!0;if(p.route.shouldRevalidate){let g=p.route.shouldRevalidate({currentUrl:new URL(l.pathname+l.search+l.hash,window.origin),currentParams:s[0]?.params||{},nextUrl:new URL(e,window.origin),nextParams:p.params,defaultShouldRevalidate:!0});if(typeof g=="boolean")return g}return!0}):[]}function qT(e,n,{includeHydrateFallback:s}={}){return PT(e.map(i=>{let l=n.routes[i.route.id];if(!l)return[];let o=[l.module];return l.clientActionModule&&(o=o.concat(l.clientActionModule)),l.clientLoaderModule&&(o=o.concat(l.clientLoaderModule)),s&&l.hydrateFallbackModule&&(o=o.concat(l.hydrateFallbackModule)),l.imports&&(o=o.concat(l.imports)),o}).flat(1))}function PT(e){return[...new Set(e)]}function HT(e){let n={},s=Object.keys(e).sort();for(let i of s)n[i]=e[i];return n}function VT(e,n){let s=new Set;return new Set(n),e.reduce((i,l)=>{let o=JSON.stringify(HT(l));return s.has(o)||(s.add(o),i.push({key:o,link:l})),i},[])}function oj(){let e=u.useContext(Hi);return ug(e,"You must render this element inside a <DataRouterContext.Provider> element"),e}function YT(){let e=u.useContext(Pc);return ug(e,"You must render this element inside a <DataRouterStateContext.Provider> element"),e}var dg=u.createContext(void 0);dg.displayName="FrameworkContext";function cj(){let e=u.useContext(dg);return ug(e,"You must render this element inside a <HydratedRouter> element"),e}function GT(e,n){let s=u.useContext(dg),[i,l]=u.useState(!1),[o,d]=u.useState(!1),{onFocus:f,onBlur:p,onMouseEnter:h,onMouseLeave:y,onTouchStart:g}=n,b=u.useRef(null);u.useEffect(()=>{if(e==="render"&&d(!0),e==="viewport"){let N=E=>{E.forEach(A=>{d(A.isIntersecting)})},j=new IntersectionObserver(N,{threshold:.5});return b.current&&j.observe(b.current),()=>{j.disconnect()}}},[e]),u.useEffect(()=>{if(i){let N=setTimeout(()=>{d(!0)},100);return()=>{clearTimeout(N)}}},[i]);let v=()=>{l(!0)},S=()=>{l(!1),d(!1)};return s?e!=="intent"?[o,b,{}]:[o,b,{onFocus:Qo(f,v),onBlur:Qo(p,S),onMouseEnter:Qo(h,v),onMouseLeave:Qo(y,S),onTouchStart:Qo(g,v)}]:[!1,b,{}]}function Qo(e,n){return s=>{e&&e(s),s.defaultPrevented||n(s)}}function WT({page:e,...n}){let{router:s}=oj(),i=u.useMemo(()=>Jr(s.routes,e,s.basename),[s.routes,e,s.basename]);return i?u.createElement(KT,{page:e,matches:i,...n}):null}function XT(e){let{manifest:n,routeModules:s}=cj(),[i,l]=u.useState([]);return u.useEffect(()=>{let o=!1;return UT(e,n,s).then(d=>{o||l(d)}),()=>{o=!0}},[e,n,s]),i}function KT({page:e,matches:n,...s}){let i=Xa(),{manifest:l,routeModules:o}=cj(),{basename:d}=oj(),{loaderData:f,matches:p}=YT(),h=u.useMemo(()=>gS(e,n,p,l,i,"data"),[e,n,p,l,i]),y=u.useMemo(()=>gS(e,n,p,l,i,"assets"),[e,n,p,l,i]),g=u.useMemo(()=>{if(e===i.pathname+i.search+i.hash)return[];let S=new Set,N=!1;if(n.forEach(E=>{let A=l.routes[E.route.id];!A||!A.hasLoader||(!h.some(M=>M.route.id===E.route.id)&&E.route.id in f&&o[E.route.id]?.shouldRevalidate||A.hasClientLoader?N=!0:S.add(E.route.id))}),S.size===0)return[];let j=FT(e,d,"data");return N&&S.size>0&&j.searchParams.set("_routes",n.filter(E=>S.has(E.route.id)).map(E=>E.route.id).join(",")),[j.pathname+j.search]},[d,f,i,l,h,n,e,o]),b=u.useMemo(()=>qT(y,l),[y,l]),v=XT(y);return u.createElement(u.Fragment,null,g.map(S=>u.createElement("link",{key:S,rel:"prefetch",as:"fetch",href:S,...s})),b.map(S=>u.createElement("link",{key:S,rel:"modulepreload",href:S,...s})),v.map(({key:S,link:N})=>u.createElement("link",{key:S,nonce:s.nonce,...N})))}function ZT(...e){return n=>{e.forEach(s=>{typeof s=="function"?s(n):s!=null&&(s.current=n)})}}var uj=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u";try{uj&&(window.__reactRouterVersion="7.9.3")}catch{}function QT(e,n){return D2({basename:n?.basename,getContext:n?.getContext,future:n?.future,history:e2({window:n?.window}),hydrationData:JT(),routes:e,mapRouteProperties:vT,hydrationRouteProperties:ST,dataStrategy:n?.dataStrategy,patchRoutesOnNavigation:n?.patchRoutesOnNavigation,window:n?.window}).initialize()}function JT(){let e=window?.__staticRouterHydrationData;return e&&e.errors&&(e={...e,errors:eM(e.errors)}),e}function eM(e){if(!e)return null;let n=Object.entries(e),s={};for(let[i,l]of n)if(l&&l.__type==="RouteErrorResponse")s[i]=new Kd(l.status,l.statusText,l.data,l.internal===!0);else if(l&&l.__type==="Error"){if(l.__subType){let o=window[l.__subType];if(typeof o=="function")try{let d=new o(l.message);d.stack="",s[i]=d}catch{}}if(s[i]==null){let o=new Error(l.message);o.stack="",s[i]=o}}else s[i]=l;return s}var dj=/^(?:[a-z][a-z0-9+.-]*:|\/\/)/i,Yt=u.forwardRef(function({onClick:n,discover:s="render",prefetch:i="none",relative:l,reloadDocument:o,replace:d,state:f,target:p,to:h,preventScrollReset:y,viewTransition:g,...b},v){let{basename:S}=u.useContext(Ts),N=typeof h=="string"&&dj.test(h),j,E=!1;if(typeof h=="string"&&N&&(j=h,uj))try{let z=new URL(window.location.href),G=h.startsWith("//")?new URL(z.protocol+h):new URL(h),U=Oa(G.pathname,S);G.origin===z.origin&&U!=null?h=U+G.search+G.hash:E=!0}catch{Gn(!1,`<Link to="${h}"> contains an invalid URL which will probably break when clicked - please update to a valid URL path.`)}let A=rT(h,{relative:l}),[M,_,T]=GT(i,b),k=sM(h,{replace:d,state:f,target:p,preventScrollReset:y,relative:l,viewTransition:g});function C(z){n&&n(z),z.defaultPrevented||k(z)}let L=u.createElement("a",{...b,...T,href:j||A,onClick:E||o?n:C,ref:ZT(v,_),target:p,"data-discover":!N&&s==="render"?"true":void 0});return M&&!N?u.createElement(u.Fragment,null,L,u.createElement(WT,{page:A})):L});Yt.displayName="Link";var tM=u.forwardRef(function({"aria-current":n="page",caseSensitive:s=!1,className:i="",end:l=!1,style:o,to:d,viewTransition:f,children:p,...h},y){let g=Hc(d,{relative:h.relative}),b=Xa(),v=u.useContext(Pc),{navigator:S,basename:N}=u.useContext(Ts),j=v!=null&&uM(g)&&f===!0,E=S.encodeLocation?S.encodeLocation(g).pathname:g.pathname,A=b.pathname,M=v&&v.navigation&&v.navigation.location?v.navigation.location.pathname:null;s||(A=A.toLowerCase(),M=M?M.toLowerCase():null,E=E.toLowerCase()),M&&N&&(M=Oa(M,N)||M);const _=E!=="/"&&E.endsWith("/")?E.length-1:E.length;let T=A===E||!l&&A.startsWith(E)&&A.charAt(_)==="/",k=M!=null&&(M===E||!l&&M.startsWith(E)&&M.charAt(E.length)==="/"),C={isActive:T,isPending:k,isTransitioning:j},L=T?n:void 0,z;typeof i=="function"?z=i(C):z=[i,T?"active":null,k?"pending":null,j?"transitioning":null].filter(Boolean).join(" ");let G=typeof o=="function"?o(C):o;return u.createElement(Yt,{...h,"aria-current":L,className:z,ref:y,style:G,to:d,viewTransition:f},typeof p=="function"?p(C):p)});tM.displayName="NavLink";var nM=u.forwardRef(({discover:e="render",fetcherKey:n,navigate:s,reloadDocument:i,replace:l,state:o,method:d=Od,action:f,onSubmit:p,relative:h,preventScrollReset:y,viewTransition:g,...b},v)=>{let S=lM(),N=oM(f,{relative:h}),j=d.toLowerCase()==="get"?"get":"post",E=typeof f=="string"&&dj.test(f),A=M=>{if(p&&p(M),M.defaultPrevented)return;M.preventDefault();let _=M.nativeEvent.submitter,T=_?.getAttribute("formmethod")||d;S(_||M.currentTarget,{fetcherKey:n,method:T,navigate:s,replace:l,state:o,relative:h,preventScrollReset:y,viewTransition:g})};return u.createElement("form",{ref:v,method:j,action:N,onSubmit:i?p:A,...b,"data-discover":!E&&e==="render"?"true":void 0})});nM.displayName="Form";function aM(e){return`${e} must be used within a data router.  See https://reactrouter.com/en/main/routers/picking-a-router.`}function fj(e){let n=u.useContext(Hi);return cn(n,aM(e)),n}function sM(e,{target:n,replace:s,state:i,preventScrollReset:l,relative:o,viewTransition:d}={}){let f=_n(),p=Xa(),h=Hc(e,{relative:o});return u.useCallback(y=>{if(IT(y,n)){y.preventDefault();let g=s!==void 0?s:si(p)===si(h);f(e,{replace:g,state:i,preventScrollReset:l,relative:o,viewTransition:d})}},[p,f,h,s,i,n,e,l,o,d])}function mj(e){Gn(typeof URLSearchParams<"u","You cannot use the `useSearchParams` hook in a browser that does not support the URLSearchParams API. If you need to support Internet Explorer 11, we recommend you load a polyfill such as https://github.com/ungap/url-search-params.");let n=u.useRef(py(e)),s=u.useRef(!1),i=Xa(),l=u.useMemo(()=>LT(i.search,s.current?null:n.current),[i.search]),o=_n(),d=u.useCallback((f,p)=>{const h=py(typeof f=="function"?f(new URLSearchParams(l)):f);s.current=!0,o("?"+h,p)},[o,l]);return[l,d]}var rM=0,iM=()=>`__${String(++rM)}__`;function lM(){let{router:e}=fj("useSubmit"),{basename:n}=u.useContext(Ts),s=yT();return u.useCallback(async(i,l={})=>{let{action:o,method:d,encType:f,formData:p,body:h}=$T(i,n);if(l.navigate===!1){let y=l.fetcherKey||iM();await e.fetch(y,s,l.action||o,{preventScrollReset:l.preventScrollReset,formData:p,body:h,formMethod:l.method||d,formEncType:l.encType||f,flushSync:l.flushSync})}else await e.navigate(l.action||o,{preventScrollReset:l.preventScrollReset,formData:p,body:h,formMethod:l.method||d,formEncType:l.encType||f,replace:l.replace,state:l.state,fromRouteId:s,flushSync:l.flushSync,viewTransition:l.viewTransition})},[e,n,s])}function oM(e,{relative:n}={}){let{basename:s}=u.useContext(Ts),i=u.useContext(ms);cn(i,"useFormAction must be used inside a RouteContext");let[l]=i.matches.slice(-1),o={...Hc(e||".",{relative:n})},d=Xa();if(e==null){o.search=d.search;let f=new URLSearchParams(o.search),p=f.getAll("index");if(p.some(y=>y==="")){f.delete("index"),p.filter(g=>g).forEach(g=>f.append("index",g));let y=f.toString();o.search=y?`?${y}`:""}}return(!e||e===".")&&l.route.index&&(o.search=o.search?o.search.replace(/^\?/,"?index&"):"?index"),s!=="/"&&(o.pathname=o.pathname==="/"?s:Us([s,o.pathname])),si(o)}function hj(e,n){let{capture:s}=n||{};u.useEffect(()=>{let i=s!=null?{capture:s}:void 0;return window.addEventListener("beforeunload",e,i),()=>{window.removeEventListener("beforeunload",e,i)}},[e,s])}function cM({when:e,message:n}){let s=ij(e);u.useEffect(()=>{s.state==="blocked"&&(window.confirm(n)?setTimeout(s.proceed,0):s.reset())},[s,n]),u.useEffect(()=>{s.state==="blocked"&&!e&&s.reset()},[s,e])}function uM(e,{relative:n}={}){let s=u.useContext(ig);cn(s!=null,"`useViewTransitionState` must be used within `react-router-dom`'s `RouterProvider`.  Did you accidentally import `RouterProvider` from `react-router`?");let{basename:i}=fj("useViewTransitionState"),l=Hc(e,{relative:n});if(!s.isTransitioning)return!1;let o=Oa(s.currentLocation.pathname,i)||s.currentLocation.pathname,d=Oa(s.nextLocation.pathname,i)||s.nextLocation.pathname;return Xd(l.pathname,d)!=null||Xd(l.pathname,o)!=null}var Ql=zN();const pj=Pi(Ql);function dM(e){return u.createElement(NT,{flushSync:Ql.flushSync,...e})}/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fM=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),mM=e=>e.replace(/^([A-Z])|[\s-_]+(\w)/g,(n,s,i)=>i?i.toUpperCase():s.toLowerCase()),bS=e=>{const n=mM(e);return n.charAt(0).toUpperCase()+n.slice(1)},yj=(...e)=>e.filter((n,s,i)=>!!n&&n.trim()!==""&&i.indexOf(n)===s).join(" ").trim(),hM=e=>{for(const n in e)if(n.startsWith("aria-")||n==="role"||n==="title")return!0};/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var pM={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const yM=u.forwardRef(({color:e="currentColor",size:n=24,strokeWidth:s=2,absoluteStrokeWidth:i,className:l="",children:o,iconNode:d,...f},p)=>u.createElement("svg",{ref:p,...pM,width:n,height:n,stroke:e,strokeWidth:i?Number(s)*24/Number(n):s,className:yj("lucide",l),...!o&&!hM(f)&&{"aria-hidden":"true"},...f},[...d.map(([h,y])=>u.createElement(h,y)),...Array.isArray(o)?o:[o]]));/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bt=(e,n)=>{const s=u.forwardRef(({className:i,...l},o)=>u.createElement(yM,{ref:o,iconNode:n,className:yj(`lucide-${fM(bS(e))}`,`lucide-${e}`,i),...l}));return s.displayName=bS(e),s};/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gM=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],xS=Bt("arrow-down",gM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bM=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],Tc=Bt("arrow-left",bM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xM=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]],gj=Bt("arrow-right",xM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vM=[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]],yy=Bt("arrow-up",vM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const SM=[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M22 8c0-2.3-.8-4.3-2-6",key:"5bb3ad"}],["path",{d:"M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326",key:"11g9vi"}],["path",{d:"M4 2C2.8 3.7 2 5.7 2 8",key:"tap9e0"}]],Nf=Bt("bell-ring",SM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wM=[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326",key:"11g9vi"}]],Pl=Bt("bell",wM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const NM=[["path",{d:"M12 20v-9",key:"1qisl0"}],["path",{d:"M14 7a4 4 0 0 1 4 4v3a6 6 0 0 1-12 0v-3a4 4 0 0 1 4-4z",key:"uouzyp"}],["path",{d:"M14.12 3.88 16 2",key:"qol33r"}],["path",{d:"M21 21a4 4 0 0 0-3.81-4",key:"1b0z45"}],["path",{d:"M21 5a4 4 0 0 1-3.55 3.97",key:"5cxbf6"}],["path",{d:"M22 13h-4",key:"1jl80f"}],["path",{d:"M3 21a4 4 0 0 1 3.81-4",key:"1fjd4g"}],["path",{d:"M3 5a4 4 0 0 0 3.55 3.97",key:"1d7oge"}],["path",{d:"M6 13H2",key:"82j7cp"}],["path",{d:"m8 2 1.88 1.88",key:"fmnt4t"}],["path",{d:"M9 7.13V6a3 3 0 1 1 6 0v1.13",key:"1vgav8"}]],fg=Bt("bug",NM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jM=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]],vS=Bt("calendar-days",jM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const EM=[["path",{d:"M18 6 7 17l-5-5",key:"116fxf"}],["path",{d:"m22 10-7.5 7.5L13 16",key:"ke71qq"}]],_M=Bt("check-check",EM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const CM=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],bj=Bt("check",CM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const AM=[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]],Ss=Bt("chevron-down",AM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const TM=[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]],xr=Bt("chevron-right",TM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const MM=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]],ta=Bt("circle-alert",MM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kM=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],jf=Bt("circle-check",kM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const RM=[["path",{d:"M9 9.003a1 1 0 0 1 1.517-.859l4.997 2.997a1 1 0 0 1 0 1.718l-4.997 2.997A1 1 0 0 1 9 14.996z",key:"kmsa83"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],IM=Bt("circle-play",RM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const LM=[["path",{d:"M12 6v6l4 2",key:"mmk7yg"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]],mg=Bt("clock",LM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const DM=[["path",{d:"M12 13v8",key:"1l5pq0"}],["path",{d:"M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242",key:"1pljnt"}],["path",{d:"m8 17 4-4 4 4",key:"1quai1"}]],SS=Bt("cloud-upload",DM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const OM=[["path",{d:"M11.562 3.266a.5.5 0 0 1 .876 0L15.39 8.87a1 1 0 0 0 1.516.294L21.183 5.5a.5.5 0 0 1 .798.519l-2.834 10.246a1 1 0 0 1-.956.734H5.81a1 1 0 0 1-.957-.734L2.02 6.02a.5.5 0 0 1 .798-.519l4.276 3.664a1 1 0 0 0 1.516-.294z",key:"1vdc57"}],["path",{d:"M5 21h14",key:"11awu3"}]],$M=Bt("crown",OM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const FM=[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]],wS=Bt("database",FM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zM=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],BM=Bt("download",zM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const UM=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]],NS=Bt("external-link",UM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qM=[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],xj=Bt("eye",qM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const PM=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"m9 15 2 2 4-4",key:"1grp1n"}]],HM=Bt("file-check",PM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const VM=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]],gy=Bt("file-text",VM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const YM=[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]],Ef=Bt("funnel",YM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const GM=[["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}],["circle",{cx:"9",cy:"5",r:"1",key:"hp0tcf"}],["circle",{cx:"9",cy:"19",r:"1",key:"fkjjf6"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"15",cy:"5",r:"1",key:"19l28e"}],["circle",{cx:"15",cy:"19",r:"1",key:"f4zoj3"}]],WM=Bt("grip-vertical",GM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const XM=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]],vj=Bt("history",XM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const KM=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],ZM=Bt("image",KM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const QM=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],Jl=Bt("info",QM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const JM=[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z",key:"zw3jo"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12",key:"1wduqc"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17",key:"kqbvx6"}]],Sj=Bt("layers",JM);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ek=[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]],jS=Bt("link-2",ek);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tk=[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]],nk=Bt("link",tk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ak=[["path",{d:"M13 5h8",key:"a7qcls"}],["path",{d:"M13 12h8",key:"h98zly"}],["path",{d:"M13 19h8",key:"c3s6r1"}],["path",{d:"m3 17 2 2 4-4",key:"1jhpwq"}],["path",{d:"m3 7 2 2 4-4",key:"1obspn"}]],wj=Bt("list-checks",ak);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const sk=[["path",{d:"M3 5h.01",key:"18ugdj"}],["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M3 19h.01",key:"noohij"}],["path",{d:"M8 5h13",key:"1pao27"}],["path",{d:"M8 12h13",key:"1za7za"}],["path",{d:"M8 19h13",key:"m83p4d"}]],Qd=Bt("list",sk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rk=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],mn=Bt("loader-circle",rk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ik=[["path",{d:"m16 17 5-5-5-5",key:"1bji2h"}],["path",{d:"M21 12H9",key:"dn1m92"}],["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}]],lk=Bt("log-out",ik);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ok=[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]],ck=Bt("lock",ok);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const uk=[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]],Jd=Bt("map-pin",uk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const dk=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"m21 3-7 7",key:"1l2asr"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M9 21H3v-6",key:"wtvkvv"}]],fk=Bt("maximize-2",dk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const mk=[["path",{d:"M4 5h16",key:"1tepv9"}],["path",{d:"M4 12h16",key:"1lakjw"}],["path",{d:"M4 19h16",key:"1djgab"}]],hk=Bt("menu",mk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pk=[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]],yk=Bt("message-square",pk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const gk=[["path",{d:"M5 12h14",key:"1ays0h"}]],hg=Bt("minus",gk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const bk=[["path",{d:"M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401",key:"kfwtm"}]],xk=Bt("moon",bk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const vk=[["rect",{x:"16",y:"16",width:"6",height:"6",rx:"1",key:"4q2zg0"}],["rect",{x:"2",y:"16",width:"6",height:"6",rx:"1",key:"8cvhb9"}],["rect",{x:"9",y:"2",width:"6",height:"6",rx:"1",key:"1egb70"}],["path",{d:"M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3",key:"1jsf9p"}],["path",{d:"M12 12V8",key:"2874zd"}]],Sk=Bt("network",vk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const wk=[["path",{d:"M13.4 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7.4",key:"re6nr2"}],["path",{d:"M2 6h4",key:"aawbzj"}],["path",{d:"M2 10h4",key:"l0bgd4"}],["path",{d:"M2 14h4",key:"1gsvsf"}],["path",{d:"M2 18h4",key:"1bu2t1"}],["path",{d:"M21.378 5.626a1 1 0 1 0-3.004-3.004l-5.01 5.012a2 2 0 0 0-.506.854l-.837 2.87a.5.5 0 0 0 .62.62l2.87-.837a2 2 0 0 0 .854-.506z",key:"pqwjuv"}]],by=Bt("notebook-pen",wk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Nk=[["path",{d:"M13 21h8",key:"1jsn5i"}],["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],jk=Bt("pen-line",Nk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ek=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],Nj=Bt("pen",Ek);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _k=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]],Ga=Bt("pencil",_k);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ck=[["path",{d:"M12 17v5",key:"bb1du9"}],["path",{d:"M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z",key:"1nkz8b"}]],Ak=Bt("pin",Ck);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tk=[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]],Wn=Bt("plus",Tk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Mk=[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]],Vi=Bt("rotate-ccw",Mk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kk=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]],ES=Bt("save",kk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rk=[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]],Hl=Bt("search",Rk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ik=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],Lk=Bt("send",Ik);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Dk=[["path",{d:"M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915",key:"1i5ecw"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],jj=Bt("settings",Dk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ok=[["path",{d:"M8.3 10a.7.7 0 0 1-.626-1.079L11.4 3a.7.7 0 0 1 1.198-.043L16.3 8.9a.7.7 0 0 1-.572 1.1Z",key:"1bo67w"}],["rect",{x:"3",y:"14",width:"7",height:"7",rx:"1",key:"1bkyp8"}],["circle",{cx:"17.5",cy:"17.5",r:"3.5",key:"w3z12y"}]],$k=Bt("shapes",Ok);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fk=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Ej=Bt("shield-check",Fk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zk=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"M9 12h6",key:"1c52cq"}],["path",{d:"M12 9v6",key:"199k2o"}]],Bk=Bt("shield-plus",zk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Uk=[["path",{d:"M10 5H3",key:"1qgfaw"}],["path",{d:"M12 19H3",key:"yhmn1j"}],["path",{d:"M14 3v4",key:"1sua03"}],["path",{d:"M16 17v4",key:"1q0r14"}],["path",{d:"M21 12h-9",key:"1o4lsq"}],["path",{d:"M21 19h-5",key:"1rlt1p"}],["path",{d:"M21 5h-7",key:"1oszz2"}],["path",{d:"M8 10v4",key:"tgpxqk"}],["path",{d:"M8 12H3",key:"a7s4jb"}]],qk=Bt("sliders-horizontal",Uk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pk=[["path",{d:"M11.017 2.814a1 1 0 0 1 1.966 0l1.051 5.558a2 2 0 0 0 1.594 1.594l5.558 1.051a1 1 0 0 1 0 1.966l-5.558 1.051a2 2 0 0 0-1.594 1.594l-1.051 5.558a1 1 0 0 1-1.966 0l-1.051-5.558a2 2 0 0 0-1.594-1.594l-5.558-1.051a1 1 0 0 1 0-1.966l5.558-1.051a2 2 0 0 0 1.594-1.594z",key:"1s2grr"}],["path",{d:"M20 2v4",key:"1rf3ol"}],["path",{d:"M22 4h-4",key:"gwowj6"}],["circle",{cx:"4",cy:"20",r:"2",key:"6kqj1y"}]],Yi=Bt("sparkles",Pk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hk=[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]],Vk=Bt("sun",Hk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yk=[["polyline",{points:"14.5 17.5 3 6 3 3 6 3 17.5 14.5",key:"1hfsw2"}],["line",{x1:"13",x2:"19",y1:"19",y2:"13",key:"1vrmhu"}],["line",{x1:"16",x2:"20",y1:"16",y2:"20",key:"1bron3"}],["line",{x1:"19",x2:"21",y1:"21",y2:"19",key:"13pww6"}],["polyline",{points:"14.5 6.5 18 3 21 3 21 6 17.5 9.5",key:"hbey2j"}],["line",{x1:"5",x2:"9",y1:"14",y2:"18",key:"1hf58s"}],["line",{x1:"7",x2:"4",y1:"17",y2:"20",key:"pidxm4"}],["line",{x1:"3",x2:"5",y1:"19",y2:"21",key:"1pehsh"}]],Gk=Bt("swords",Yk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wk=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"12",r:"6",key:"1vlfrh"}],["circle",{cx:"12",cy:"12",r:"2",key:"1c9p78"}]],pg=Bt("target",Wk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xk=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],zn=Bt("trash-2",Xk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kk=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],La=Bt("triangle-alert",Kk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zk=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],Qk=Bt("upload",Zk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jk=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["path",{d:"M16 3.128a4 4 0 0 1 0 7.744",key:"16gr8j"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],_j=Bt("users",Jk);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const eR=[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]],tR=Bt("user",eR);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nR=[["rect",{width:"8",height:"8",x:"3",y:"3",rx:"2",key:"by2w9f"}],["path",{d:"M7 11v4a2 2 0 0 0 2 2h4",key:"xkn7yn"}],["rect",{width:"8",height:"8",x:"13",y:"13",rx:"2",key:"1cgmvn"}]],aR=Bt("workflow",nR);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const sR=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],Bn=Bt("x",sR),sn="http://ttrdb.eu-west-2.elasticbeanstalk.com/api".replace(/\/$/,"")||"http://localhost:3000/api",rR=Object.freeze(Object.defineProperty({__proto__:null,API_BASE:sn},Symbol.toStringTag,{value:"Module"})),Cj=u.createContext(null);function iR({children:e}){const[n,s]=u.useState(null),[i,l]=u.useState(null),[o,d]=u.useState(!1);u.useEffect(()=>{try{const h=localStorage.getItem("gamedb_session");if(h){const y=JSON.parse(h);y?.user&&y?.token?(s(y.user),l(y.token)):(console.warn(" Incomplete session found, clearing..."),localStorage.removeItem("gamedb_session"))}}catch(h){console.warn(" Invalid stored session, clearing...",h),localStorage.removeItem("gamedb_session")}finally{d(!0)}},[]),u.useEffect(()=>{o&&(i&&n?localStorage.setItem("gamedb_session",JSON.stringify({user:n,token:i})):localStorage.removeItem("gamedb_session"))},[i,n,o]);const f=async(h,y)=>{try{const b=await(await fetch(`${sn}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:h,password:y})})).json();if(console.log(" Raw login response:",b),!b.success||!b.token)throw new Error(b.message||"Invalid credentials");return s(b.user),l(b.token),localStorage.setItem("gamedb_session",JSON.stringify({user:b.user,token:b.token})),console.log(" Login successful:",b.user),!0}catch(g){return console.error(" Login error:",g.message),alert(`Login failed: ${g.message}`),!1}},p=()=>{s(null),l(null),localStorage.removeItem("gamedb_session")};return o?t.jsx(Cj.Provider,{value:{user:n,token:i,sessionReady:o,login:f,logout:p},children:e}):t.jsx("div",{className:"loading-screen",children:"Loading session..."})}function un(){return u.useContext(Cj)}function Vs(){try{return JSON.parse(localStorage.getItem("gamedb_session"))?.token||null}catch{return null}}async function lR(e=5,n=200){for(let s=0;s<e;s++){const i=Vs();if(i)return i;await new Promise(l=>setTimeout(l,n))}return null}async function Ys(){const e=await lR();if(!e)throw new Error("Missing or invalid token");return{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}async function Gs(e,n="request"){if(e.status===401)throw console.warn(` Unauthorized during ${n}, clearing session`),localStorage.removeItem("gamedb_session"),window.location.reload(),new Error("Session expired or unauthorized");if(!e.ok){const s=await e.text();throw new Error(`Failed to ${n}: ${e.status} ${s}`)}return e.json()}async function Vc(e={}){const n=await Ys(),s=new URLSearchParams;Object.entries(e).forEach(([d,f])=>{f!=null&&f!==""&&s.set(d,f)});const i=s.toString(),l=i?`${sn}/campaigns?${i}`:`${sn}/campaigns`,o=await fetch(l,{headers:n});return Gs(o,"fetch campaigns")}async function oR(e){const n=await Ys(),s=await fetch(`${sn}/campaigns`,{method:"POST",headers:n,body:JSON.stringify(e)});return Gs(s,"create campaign")}async function cR(e,n){const s=await Ys(),i=await fetch(`${sn}/campaigns/${e}`,{method:"PUT",headers:s,body:JSON.stringify(n)});return Gs(i,"update campaign")}async function uR(e){const n=await Ys(),s=await fetch(`${sn}/campaigns/${e}`,{method:"DELETE",headers:n});return Gs(s,"delete campaign")}async function dR(e,n={}){if(!e)throw new Error("campaignId is required to fetch notes");const s=await Ys(),i=new URLSearchParams;Object.entries(n).forEach(([f,p])=>{if(!(p==null||p==="")){if(Array.isArray(p)){p.map(h=>h==null?"":String(h)).filter(h=>h.trim()!=="").forEach(h=>{i.append(`${f}[]`,h)});return}i.set(f,p)}});const l=i.toString(),o=`${sn}/campaigns/${e}/entity-notes${l?`?${l}`:""}`,d=await fetch(o,{headers:s});return Gs(d,"fetch campaign entity notes")}async function fR(e,n={}){if(!e)throw new Error("campaignId is required to fetch notes");const s=await Ys(),i=new URLSearchParams;Object.entries(n).forEach(([f,p])=>{if(!(p==null||p==="")){if(Array.isArray(p)){p.map(h=>h==null?"":String(h)).filter(h=>h.trim()!=="").forEach(h=>{i.append(`${f}[]`,h)});return}i.set(f,p)}});const l=i.toString(),o=`${sn}/campaigns/${e}/location-notes${l?`?${l}`:""}`,d=await fetch(o,{headers:s});return Gs(d,"fetch campaign location notes")}async function mR(e){if(!e)throw new Error("campaignId is required to fetch session notes");const n=await Ys(),s=`${sn}/campaigns/${e}/session-notes`,i=await fetch(s,{headers:n});return Gs(i,"fetch campaign session notes")}async function hR(e,n={}){if(!e)throw new Error("campaignId is required to create a session note");const s=await Ys(),i=await fetch(`${sn}/campaigns/${e}/session-notes`,{method:"POST",headers:s,body:JSON.stringify(n)});return Gs(i,"create session note")}async function pR(e,n,s={}){if(!e)throw new Error("campaignId is required to update a session note");if(!n)throw new Error("noteId is required to update a session note");const i=await Ys(),l=await fetch(`${sn}/campaigns/${e}/session-notes/${n}`,{method:"PUT",headers:i,body:JSON.stringify(s)});return Gs(l,"update session note")}async function yR(e,n){if(!e)throw new Error("campaignId is required to delete a session note");if(!n)throw new Error("noteId is required to delete a session note");const s=await Ys(),i=await fetch(`${sn}/campaigns/${e}/session-notes/${n}`,{method:"DELETE",headers:s});return Gs(i,"delete session note")}async function gR(e=5,n=200){for(let s=0;s<e;s++){const i=Vs();if(i)return i;await new Promise(l=>setTimeout(l,n))}return null}async function _f(){const e=await gR();if(!e)throw new Error("Missing or invalid token");return{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}async function Cf(e,n="request"){if(e.status===401)throw console.warn(` Unauthorized during ${n}, clearing session`),localStorage.removeItem("gamedb_session"),window.location.reload(),new Error("Session expired or unauthorized");if(!e.ok){const s=await e.text();throw new Error(`Failed to ${n}: ${e.status} ${s}`)}return e.json()}async function eo(){const e=await _f(),n=await fetch(`${sn}/worlds`,{headers:e});return Cf(n,"fetch worlds")}async function bR(e){const n=await _f(),s=await fetch(`${sn}/worlds`,{method:"POST",headers:n,body:JSON.stringify(e)});return Cf(s,"create world")}async function xR(e,n){const s=await _f(),i=await fetch(`${sn}/worlds/${e}`,{method:"PUT",headers:s,body:JSON.stringify(n)});return Cf(i,"update world")}async function vR(e){const n=await _f(),s=await fetch(`${sn}/worlds/${e}`,{method:"DELETE",headers:n});return Cf(s,"delete world")}const Aj=u.createContext(null),Fd="gamedb_campaign_context",SR=new Set(["dm","player"]),Jo=(e,n)=>{if(typeof window>"u")return;const s=e?String(e):"",i=s?"":n?String(n):"";try{s?localStorage.setItem(Fd,JSON.stringify({type:"campaign",id:s})):i?localStorage.setItem(Fd,JSON.stringify({type:"world",id:i})):localStorage.removeItem(Fd)}catch(l){console.warn(" Unable to persist campaign context",l)}},wR=e=>{if(!e||typeof e!="string")return{type:"",id:""};try{const n=JSON.parse(e);if(n&&typeof n=="object"){const s=n.type==="world"?"world":"campaign",i=n.id?String(n.id):"";if(i)return{type:s,id:i}}}catch{if(e.trim())return{type:"campaign",id:e.trim()}}return e.trim()?{type:"campaign",id:e.trim()}:{type:"",id:""}},NR=(e,n)=>Array.isArray(e)?n?n.role==="system_admin"?e:e.filter(s=>Array.isArray(s?.members)&&s.members.some(i=>i?.user_id===n.id&&SR.has(i?.role))):[]:[];function jR({children:e}){const{user:n,sessionReady:s}=un(),[i,l]=u.useState([]),[o,d]=u.useState(!1),[f,p]=u.useState(""),[h,y]=u.useState(""),[g,b]=u.useState([]),[v,S]=u.useState(!1),[N,j]=u.useState(""),[E,A]=u.useState(""),[M,_]=u.useState(""),[T,k]=u.useState(!1);u.useEffect(()=>{if(s)try{const F=localStorage.getItem(Fd);if(!F){y(""),A("");return}const{type:H,id:I}=wR(F);H==="world"?(A(I),y("")):H==="campaign"?(y(I),A("")):(y(""),A(""))}catch(F){console.warn(" Unable to restore campaign context",F),y(""),A("")}finally{k(!0)}},[s]),u.useEffect(()=>{!s||!T||Jo(h,E)},[h,E,s,T]);const C=u.useCallback(async()=>{if(!s||!n)return l([]),p(""),[];d(!0),p("");try{const F=await Vc(),H=Array.isArray(F?.data)?F.data:Array.isArray(F)?F:[],I=NR(H,n);return l(I),y(Y=>Y&&I.some(W=>String(W.id)===String(Y))?Y:""),I}catch(F){return console.error(" Failed to load campaigns",F),p(F.message||"Failed to load campaigns"),l([]),[]}finally{d(!1)}},[s,n]),L=u.useCallback(async()=>{if(!s||!n)return b([]),j(""),[];S(!0),j("");try{const F=await eo(),H=Array.isArray(F?.data)?F.data:Array.isArray(F)?F:[];return b(H),A(I=>I&&H.some(P=>String(P.id)===String(I))?I:""),H}catch(F){return console.error(" Failed to load worlds",F),j(F.message||"Failed to load worlds"),b([]),[]}finally{S(!1)}},[s,n]);u.useEffect(()=>{if(!(!s||!T)){if(!n){l([]),y(""),p(""),d(!1),b([]),A(""),j(""),S(!1);return}C(),L()}},[s,T,n,C,L]);const z=u.useCallback(F=>{const H=F==null?"":String(F);y(H),H?(A(""),_(""),Jo(H,"")):Jo("","")},[]),G=u.useCallback(F=>{const H=F==null?"":String(F);A(H),H?(y(""),_(""),Jo("",H)):Jo("","")},[]);u.useEffect(()=>{_("")},[h]);const U=u.useCallback(F=>{const H=F==null?"":String(F);_(H)},[]),X=u.useMemo(()=>h&&i.find(F=>String(F.id)===String(h))||null,[i,h]),V=u.useMemo(()=>E&&g.find(F=>String(F.id)===String(E))||null,[g,E]),R=u.useMemo(()=>h?"campaign":E?"world":"",[h,E]),B=u.useMemo(()=>R==="world"&&V?V:X?.world?X.world:V,[R,V,X]),D=u.useMemo(()=>B?.id?String(B.id):"",[B]),O=u.useMemo(()=>`${R||"none"}:${h||E||""||"none"}:${D||"none"}:${M||"none"}`,[h,E,R,D,M]),$=u.useMemo(()=>({campaigns:i,selectedCampaign:X,selectedCampaignId:h,setSelectedCampaignId:z,worlds:g,worldLoading:v,worldError:N,selectedWorld:V,selectedWorldId:E,setSelectedWorldId:G,viewAsCharacterId:M,setViewAsCharacterId:U,selectedContextType:R,activeWorld:B,activeWorldId:D,contextKey:O,loading:o,error:f,refreshCampaigns:C,refreshWorlds:L}),[i,X,h,z,g,v,N,V,E,G,M,U,R,B,D,O,o,f,C,L]);return t.jsx(Aj.Provider,{value:$,children:e})}function wn(){const e=u.useContext(Aj);if(!e)throw new Error("useCampaignContext must be used within a CampaignProvider");return e}const Tj=u.createContext(null),ER=()=>{if(typeof window>"u")return"light";const e=window.localStorage.getItem("theme");return e==="light"||e==="dark"?e:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"};function _R({children:e}){const[n,s]=u.useState(ER);u.useEffect(()=>{typeof document>"u"||(document.body.classList.remove("theme-light","theme-dark"),document.body.classList.add(n==="dark"?"theme-dark":"theme-light"),document.documentElement.setAttribute("data-theme",n),window.localStorage.setItem("theme",n))},[n]),u.useEffect(()=>{if(typeof window>"u")return;const l=window.matchMedia("(prefers-color-scheme: dark)"),o=d=>{s(d.matches?"dark":"light")};if(!window.localStorage.getItem("theme"))return l.addEventListener("change",o),()=>l.removeEventListener("change",o)},[]);const i=u.useMemo(()=>({theme:n,setTheme:s,toggleTheme:()=>s(l=>l==="dark"?"light":"dark")}),[n]);return t.jsx(Tj.Provider,{value:i,children:e})}function CR(){const e=u.useContext(Tj);if(!e)throw new Error("useTheme must be used within a ThemeProvider");return e}const AR=768;function to(e=AR){const[n,s]=u.useState(()=>typeof window>"u"?!1:window.matchMedia(`(max-width: ${e}px)`).matches);return u.useEffect(()=>{if(typeof window>"u")return;const i=window.matchMedia(`(max-width: ${e}px)`),l=o=>{s(o.matches)};return s(i.matches),typeof i.addEventListener=="function"?(i.addEventListener("change",l),()=>i.removeEventListener("change",l)):(i.addListener(l),()=>i.removeListener(l))},[e]),n}async function TR(e=5,n=200){for(let s=0;s<e;s++){const i=Vs();if(i)return i;await new Promise(l=>setTimeout(l,n))}return null}async function Af(){const e=await TR();if(!e)throw new Error("Missing or invalid token");return{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}async function Tf(e,n="request"){if(e.status===401)throw console.warn(` Unauthorized during ${n}, clearing session`),localStorage.removeItem("gamedb_session"),window.location.reload(),new Error("Session expired or unauthorized");if(!e.ok){const s=await e.text();throw new Error(`Failed to ${n}: ${e.status} ${s}`)}return e.json()}async function Cs(e={}){const n=await Af(),s=new URLSearchParams;Object.entries(e).forEach(([d,f])=>{f!=null&&f!==""&&s.set(d,f)});const i=s.toString(),l=i?`${sn}/characters?${i}`:`${sn}/characters`,o=await fetch(l,{headers:n});return Tf(o,"fetch characters")}async function MR(e){const n=await Af(),s=await fetch(`${sn}/characters`,{method:"POST",headers:n,body:JSON.stringify(e)});return Tf(s,"create character")}async function kR(e,n){const s=await Af(),i=await fetch(`${sn}/characters/${e}`,{method:"PUT",headers:s,body:JSON.stringify(n)});return Tf(i,"update character")}async function RR(e){const n=await Af(),s=await fetch(`${sn}/characters/${e}`,{method:"DELETE",headers:n});return Tf(s,"delete character")}const _S="drawer-panel-open",IR=300,ip={sm:"360px",md:"420px",lg:"560px"},LR=["a[href]","area[href]","input:not([disabled])","select:not([disabled])","textarea:not([disabled])","button:not([disabled])",'[tabindex]:not([tabindex="-1"])'],DR=()=>{const e=document.createElement("div");return e.className="drawer-portal-container",e},OR=(e,n)=>e?typeof e=="number"?`${e}px`:String(e):n&&ip[n]?ip[n]:ip.md;function Ps({isOpen:e,onClose:n,title:s,description:i,children:l,footer:o,footerActions:d,width:f,size:p="md",labelledBy:h,closeLabel:y="Close panel",className:g="",mobileFull:b=!0}){const v=u.useRef(null),S=u.useRef(null),N=u.useRef(null),j=u.useRef(null),[E,A]=u.useState(e),[M,_]=u.useState(!1),T=u.useMemo(()=>h||`drawer-${Math.random().toString(36).slice(2)}`,[h]),k=i?`${T}-description`:void 0,C=OR(f,p);if(u.useEffect(()=>(v.current||(v.current=DR(),document.body.appendChild(v.current)),()=>{v.current&&v.current.parentNode&&v.current.parentNode.removeChild(v.current),v.current=null}),[]),u.useEffect(()=>e?(j.current&&(clearTimeout(j.current),j.current=null),A(!0),_(!1),()=>{}):E?(_(!0),j.current=setTimeout(()=>{A(!1),_(!1),j.current=null},IR),()=>{j.current&&(clearTimeout(j.current),j.current=null)}):()=>{},[e,E]),u.useEffect(()=>{if(!e)return;N.current=document.activeElement instanceof HTMLElement?document.activeElement:null,document.body.classList.add(_S);const U=()=>S.current?Array.from(S.current.querySelectorAll(LR.join(","))).filter(D=>D instanceof HTMLElement&&D.offsetParent!==null):[],X=()=>{const O=U()[0];O?O.focus({preventScroll:!0}):S.current&&S.current.focus({preventScroll:!0})},V=D=>{if(D.key==="Escape"){D.preventDefault(),n?.();return}if(D.key!=="Tab")return;const O=U();if(O.length===0){D.preventDefault(),S.current?.focus({preventScroll:!0});return}const $=O[0],F=O[O.length-1],H=document.activeElement;if(D.shiftKey){(H===$||!S.current?.contains(H))&&(D.preventDefault(),F.focus({preventScroll:!0}));return}H===F&&(D.preventDefault(),$.focus({preventScroll:!0}))},R=D=>{S.current?.contains(D.target)||X()},B=setTimeout(()=>{if(!S.current)return;const D=S.current.querySelector("[data-autofocus]");if(D instanceof HTMLElement){D.focus({preventScroll:!0});return}X()},20);return document.addEventListener("keydown",V),document.addEventListener("focusin",R),()=>{clearTimeout(B),document.removeEventListener("keydown",V),document.removeEventListener("focusin",R),document.body.classList.remove(_S),N.current instanceof HTMLElement&&N.current.focus({preventScroll:!0})}},[e,n]),!E||!v.current)return null;const L=["drawer-panel-wrapper",e?"drawer-panel-wrapper--open":"",M?"drawer-panel-wrapper--closing":""].filter(Boolean).join(" "),z=["drawer-panel",p?`drawer-panel--${p}`:"",b?"drawer-panel--mobile-full":"",g].filter(Boolean).join(" "),G=d??o;return Ql.createPortal(t.jsxs("div",{className:L,role:"presentation",children:[t.jsx("div",{className:"drawer-panel-overlay",onClick:n,role:"presentation"}),t.jsxs("aside",{ref:S,className:z,role:"dialog","aria-modal":"true","aria-labelledby":T,"aria-describedby":k,tabIndex:-1,style:{"--drawer-panel-width":C},children:[t.jsxs("div",{className:"drawer-panel-header",children:[t.jsxs("div",{className:"drawer-panel-heading",children:[t.jsx("h2",{id:T,children:s}),i?t.jsx("p",{id:k,className:"drawer-panel-description",children:i}):null]}),t.jsx("button",{type:"button",className:"icon-btn",onClick:n,"aria-label":y,children:""})]}),t.jsx("div",{className:"drawer-panel-body",children:l}),G?t.jsx("div",{className:"drawer-panel-footer",children:G}):null]})]}),v.current)}const Mf="app_history",Mj=100,xy="history:updated",kj=()=>typeof window<"u"?window:null,kf=()=>!!kj()?.localStorage,Rj=e=>{const n=kj();if(n)try{n.dispatchEvent(new CustomEvent(xy,{detail:Array.isArray(e)?e:[]}))}catch(s){console.warn(" Failed to broadcast history change",s)}},vy=e=>{if(!e)return null;const n=new Date(e);return Number.isNaN(n.getTime())?null:n},yg=e=>{if(!e||e.id===void 0||e.id===null||!e.type)return null;const n=vy(e.viewedAt)||new Date,s=e.worldId??e.world_id??e.worldID??e.world?.id??e.world?.world_id??null,i=e.worldName??e.world_name??e.world?.name??null;return{id:String(e.id),type:String(e.type),title:e.title?String(e.title):"Untitled record",viewedAt:n.toISOString(),...s?{worldId:String(s)}:{},...i?{worldName:String(i)}:{}}},$R=e=>e.slice().sort((n,s)=>{const i=vy(n?.viewedAt),l=vy(s?.viewedAt),o=i?i.getTime():0;return(l?l.getTime():0)-o}),Sy=()=>{if(!kf())return[];try{const e=window.localStorage.getItem(Mf);if(!e)return[];const n=JSON.parse(e);if(!Array.isArray(n))return[];const s=n.map(yg).filter(Boolean);return $R(s)}catch(e){return console.warn(" Failed to parse stored history",e),[]}},FR=e=>{if(!kf())return[];if(!Array.isArray(e))return[];const n=e.map(yg).filter(Boolean).slice(0,Mj);return window.localStorage.setItem(Mf,JSON.stringify(n)),Rj(n),n},zR=e=>{if(!kf())return[];const n=yg(e);if(!n)return Sy();const s=Sy().filter(l=>!(l.id===n.id&&l.type===n.type)),i=[n,...s].slice(0,Mj);return FR(i),i},BR=()=>{kf()&&(window.localStorage.removeItem(Mf),Rj([]))},lp=()=>typeof window>"u"?[]:Sy();function Ij(e=null){const[n,s]=u.useState(()=>lp()),i=u.useCallback(()=>{const f=lp();return s(f),f},[]),l=u.useCallback(f=>{if(!f)return lp();const p=zR(f);return s(p),p},[]),o=u.useCallback(()=>{BR(),s([])},[]);u.useEffect(()=>{i()},[i]);const d=u.useMemo(()=>{if(!e)return null;const{id:f,type:p,title:h,viewedAt:y}=e;if(f==null||!p)return null;const g={id:f,type:p,title:h,viewedAt:y},b=e.worldId??e.world_id??e.world?.id??e.world?.world_id??null,v=e.worldName??e.world_name??e.world?.name??null;return b!=null&&(g.worldId=b),v&&(g.worldName=v),g},[e]);return u.useEffect(()=>{d&&l(d)},[d,l]),u.useEffect(()=>{if(typeof window>"u")return;const f=h=>{h.key&&h.key!==Mf||i()},p=()=>{i()};return window.addEventListener("storage",f),window.addEventListener(xy,p),()=>{window.removeEventListener("storage",f),window.removeEventListener(xy,p)}},[i]),{history:n,addEntry:l,refreshHistory:i,clearHistory:o}}const Lj=3600*1e3,UR=24*Lj,qR=e=>{if(!e)return null;const n=new Date(e);return Number.isNaN(n.getTime())?null:n},wy=(e,n)=>e.getFullYear()===n.getFullYear()&&e.getMonth()===n.getMonth()&&e.getDate()===n.getDate(),PR=(e,n)=>{if(!e)return"older";const s=n.getTime()-e.getTime();if(s<Lj)return"lastHour";if(wy(e,n))return"today";const i=new Date(n);return i.setDate(n.getDate()-1),wy(e,i)?"yesterday":s<7*UR?"lastSevenDays":"older"},HR=[{key:"lastHour",label:"Last hour"},{key:"today",label:"Today"},{key:"yesterday",label:"Yesterday"},{key:"lastSevenDays",label:"Last seven days"},{key:"older",label:"Older"}],VR=(e,n)=>{if(!e)return"";if(wy(e,n)){const l=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0");return`${l}.${o}`}const s=String(e.getDate()).padStart(2,"0"),i=e.toLocaleString(void 0,{month:"short"});return`${s} ${i}`},YR=e=>{if(!e)return"record";const n=String(e);return n.includes(":")?n.split(":").pop().replace(/[-_]+/g," "):n.replace(/_/g," ")},GR=e=>!e?.type||!e?.id?null:String(e.type).toLowerCase().startsWith("entity")?`/entities/${e.id}`:null;function WR({isOpen:e,onClose:n}){const{history:s,clearHistory:i}=Ij(),{campaigns:l,worlds:o,loading:d,worldLoading:f,selectedContextType:p,activeWorldId:h}=wn(),y=new Date,g=u.useMemo(()=>!d&&!f,[d,f]),b=u.useMemo(()=>{const A=new Set,M=_=>{if(!_&&_!==0)return;const T=String(_);T&&A.add(T)};return Array.isArray(o)&&o.forEach(_=>{M(_?.id??_?.world_id)}),Array.isArray(l)&&l.forEach(_=>{M(_?.world?.id??_?.world_id)}),A},[l,o]),v=u.useMemo(()=>!p||!h?"":String(h),[p,h]),S=u.useMemo(()=>!Array.isArray(s)||s.length===0?[]:!g||!b.size?s:s.filter(A=>{if(!A)return!1;if(!String(A.type||"").toLowerCase().startsWith("entity"))return!0;const _=A.worldId??A.world_id??A.world?.id??A.world?.world_id??null;return v&&(!_||String(_)!==v)?!1:_?b.has(String(_)):!0}),[s,b,g,v]),N=g&&Array.isArray(s)&&s.length>0&&S.length<s.length,j=u.useMemo(()=>{if(!Array.isArray(S)||S.length===0)return[];const A=new Date,M=HR.map(T=>({...T,items:[]})),_=new Map(M.map(T=>[T.key,T]));return S.forEach(T=>{const k=qR(T?.viewedAt),C=PR(k,A),L=_.get(C);L&&L.items.push({...T,parsedDate:k})}),M.filter(T=>T.items.length>0)},[S]),E=()=>{i()};return t.jsx(Ps,{isOpen:e,onClose:n,title:"History",description:"Recently viewed records",size:"sm",children:t.jsxs("div",{className:"history-tab",children:[t.jsxs("div",{className:"history-tab-header",children:[t.jsxs("div",{className:"history-tab-title",children:[t.jsx(mg,{size:18}),t.jsx("span",{children:"Recently viewed"})]}),t.jsxs("button",{type:"button",className:"history-clear-btn",onClick:E,disabled:!s.length,children:[t.jsx(zn,{size:14}),"Clear"]})]}),!S.length&&t.jsx("p",{className:"history-empty",children:N?"You do not currently have access to any records in your recent history.":"No records viewed yet. Start exploring to build a history."}),j.map(A=>t.jsxs("section",{className:"history-group",children:[t.jsx("h3",{className:"history-group-title",children:A.label}),t.jsx("ul",{className:"history-entry-list",children:A.items.map(M=>{const _=GR(M),T=t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"history-entry-title",children:M.title||"Untitled record"}),t.jsxs("div",{className:"history-entry-meta",children:[t.jsx("span",{className:"history-entry-type",children:YR(M.type)}),t.jsx("time",{className:"history-entry-time",children:VR(M.parsedDate,y)})]})]});return t.jsx("li",{children:_?t.jsx(Yt,{to:_,className:"history-entry history-entry-link",onClick:n,children:T}):t.jsx("div",{className:"history-entry",children:T})},`${M.type}-${M.id}`)})})]},A.key))]})})}const XR="gamedb_campaign_context",KR="X-Campaign-Context-Id",ZR=e=>{if(!e||typeof e!="string")return null;try{const s=JSON.parse(e);if(s&&typeof s=="object"){const i=s.type==="world"?"world":"campaign",l=s.id?String(s.id):"";return l?{type:i,id:l}:null}}catch{const s=e.trim();if(s)return{type:"campaign",id:s}}const n=e.trim();return n?{type:"campaign",id:n}:null};async function ec(e,n,s,i={}){const{headers:l,includeCampaignContext:o=!0,...d}=i||{},f=typeof FormData<"u"&&s instanceof FormData,p={...f?{}:{"Content-Type":"application/json"},...l},h=Vs();if(h&&(p.Authorization=`Bearer ${h}`),o)try{const N=localStorage.getItem(XR);if(N){const j=ZR(N);j?.type==="campaign"&&j.id&&(p[KR]=j.id)}}catch(N){console.warn(" Unable to include campaign context header",N)}const y=(()=>{if(s!==void 0)return f?s:JSON.stringify(s)})(),g=await fetch(`${sn}${n}`,{method:e,headers:p,body:y,...d}),v=(g.headers.get("content-type")||"").includes("application/json"),S=v?await g.json():await g.text();if(!g.ok){g.status===401&&(localStorage.removeItem("gamedb_session"),setTimeout(()=>{window.location.pathname!=="/login"&&(window.location.href="/login")},150));const N=v&&S?.message||(typeof S=="string"?S:"Request failed"),j=new Error(N);throw j.status=g.status,j}return S}const kt={get:(e,n)=>ec("GET",e,void 0,n),post:(e,n,s)=>ec("POST",e,n,s),put:(e,n,s)=>ec("PUT",e,n,s),patch:(e,n,s)=>ec("PATCH",e,n,s),delete:(e,n)=>ec("DELETE",e,void 0,n)},Dj=(e={})=>{const n=new URLSearchParams;Object.entries(e).forEach(([l,o])=>{o!=null&&o!==""&&n.set(l,o)});const s=n.toString(),i=s?`/notifications?${s}`:"/notifications";return kt.get(i)},QR=e=>kt.patch(`/notifications/${e}/read`),JR=(e={})=>{const n=new URLSearchParams;Object.entries(e).forEach(([l,o])=>{o!=null&&o!==""&&n.set(l,o)});const s=n.toString(),i=s?`/notifications/read-all?${s}`:"/notifications/read-all";return kt.patch(i)},eI=(e={})=>{const n=new URLSearchParams;Object.entries(e).forEach(([l,o])=>{o!=null&&o!==""&&n.set(l,o)});const s=n.toString(),i=s?`/notifications/unread-count?${s}`:"/notifications/unread-count";return kt.get(i)},Oj=u.createContext(null),op=3e4,tI=12e4;function nI({children:e}){const{user:n,sessionReady:s}=un(),[i,l]=u.useState([]),[o,d]=u.useState(0),[f,p]=u.useState(!1),[h,y]=u.useState(""),g=u.useRef(null),b=u.useRef(null),v=u.useRef(!0);u.useEffect(()=>{const _=()=>{v.current=!document.hidden,!document.hidden&&b.current&&Date.now()-b.current>op&&(S(),N())};return document.addEventListener("visibilitychange",_),()=>{document.removeEventListener("visibilitychange",_)}},[]);const S=u.useCallback(async()=>{if(!n?.id||!s){l([]),p(!1);return}p(!0),y("");try{const _=await Dj({limit:50}),T=Array.isArray(_?.data)?_.data:[];l(T),b.current=Date.now()}catch(_){console.error(" Failed to load notifications",_),y(_.message||"Failed to load notifications")}finally{p(!1)}},[n?.id,s]),N=u.useCallback(async()=>{if(!n?.id||!s){d(0);return}try{const T=(await eI())?.count??0;d(T)}catch(_){console.error(" Failed to load unread count",_)}},[n?.id,s]),j=u.useCallback(()=>{S(),N()},[S,N]),E=u.useCallback(async _=>{if(_)try{await QR(_),l(T=>T.map(k=>k.id===_?{...k,read:!0,readAt:new Date().toISOString()}:k)),d(T=>Math.max(0,T-1))}catch(T){throw console.error(" Failed to mark notification read",T),T}},[]),A=u.useCallback(async(_={})=>{try{await JR(_),l(T=>T.map(k=>({...k,read:!0,readAt:new Date().toISOString()}))),d(0)}catch(T){throw console.error(" Failed to mark all notifications read",T),T}},[]);u.useEffect(()=>{if(!n?.id||!s){g.current&&(clearInterval(g.current),g.current=null),l([]),d(0);return}S(),N();const _=()=>{g.current&&clearInterval(g.current);const k=v.current?op:tI;g.current=setInterval(()=>{v.current?(N(),(!b.current||Date.now()-b.current>op*2)&&S()):N()},k)};_();const T=()=>{v.current=!document.hidden,_()};return document.addEventListener("visibilitychange",T),()=>{g.current&&(clearInterval(g.current),g.current=null),document.removeEventListener("visibilitychange",T)}},[n?.id,s,S,N]);const M=u.useMemo(()=>({notifications:i,unreadCount:o,loading:f,error:h,refresh:j,markRead:E,markAllRead:A}),[i,o,f,h,j,E,A]);return t.jsx(Oj.Provider,{value:M,children:e})}function aI(){const e=u.useContext(Oj);if(!e)throw new Error("useNotifications must be used within NotificationProvider");return e}function $j(){return aI()}function Fj({open:e,campaignName:n,onSwitch:s,onCancel:i}){return e?t.jsx("div",{className:"unsaved-dialog-backdrop",role:"dialog","aria-modal":"true",children:t.jsxs("div",{className:"unsaved-dialog",role:"document",children:[t.jsxs("div",{className:"unsaved-dialog-header",children:[t.jsxs("div",{children:[t.jsx("p",{className:"unsaved-dialog-label",children:"Campaign context"}),t.jsx("h2",{children:"Switch campaign context?"})]}),t.jsx("button",{type:"button",className:"icon-btn","aria-label":"Close dialog",onClick:i,children:t.jsx(Bn,{size:18})})]}),t.jsxs("div",{className:"unsaved-dialog-body",children:[t.jsxs("p",{children:["This notification is for the campaign ",t.jsx("strong",{children:n||"another campaign"}),". You're currently viewing a different campaign context."]}),t.jsx("p",{className:"unsaved-dialog-help",children:"Would you like to switch to the correct campaign context to view this notification?"})]}),t.jsxs("div",{className:"unsaved-dialog-actions",children:[t.jsx("button",{type:"button",className:"btn submit",onClick:s,children:"Switch campaign context"}),t.jsx("button",{type:"button",className:"btn cancel",onClick:i,children:"Cancel"})]})]})}):null}const sI=e=>{if(!e)return"";const n=new Date(e);if(Number.isNaN(n.getTime()))return"";const i=new Date-n,l=Math.floor(i/6e4),o=Math.floor(i/36e5),d=Math.floor(i/864e5);return l<1?"Just now":l<60?`${l}m ago`:o<24?`${o}h ago`:d<7?`${d}d ago`:n.toLocaleDateString(void 0,{month:"short",day:"numeric"})},rI=e=>{const{type:n,metadata:s={}}=e;switch(n){case"entity_comment":return`${s.author_name||"Someone"} commented on ${s.entity_name||"an entity"}`;case"entity_mention_entity_note":return`${s.author_name||"Someone"} mentioned ${s.related_entity_name||"an entity"} in a note`;case"entity_mention_session_note":return`${s.author_name||"Someone"} mentioned ${s.related_entity_name||"an entity"} in a session note`;case"session_note_added":return`${s.author_name||"Someone"} created a session note${s.campaign_name?` for ${s.campaign_name}`:""}`;case"session_note_updated":return`${s.author_name||"Someone"} updated a session note${s.campaign_name?` for ${s.campaign_name}`:""}`;case"request_note_added":return`${s.author_name||"Someone"} added a note to "${s.request_title||"a feature/bug"}"`;case"request_status_changed":return`Status changed for "${s.request_title||"a feature/bug"}"`;case"request_assigned":return`You were assigned to "${s.request_title||"a feature/bug"}"`;default:return"New notification"}};function iI(){const{notifications:e,unreadCount:n,loading:s,markRead:i}=$j(),{selectedCampaignId:l,setSelectedCampaignId:o}=wn(),d=_n(),[f,p]=u.useState(!1),h=u.useRef(null),[y,g]=u.useState({open:!1,notification:null});u.useEffect(()=>{const A=M=>{h.current&&!h.current.contains(M.target)&&p(!1)};if(f)return document.addEventListener("mousedown",A),()=>{document.removeEventListener("mousedown",A)}},[f]);const b=e.filter(A=>!A.read).slice(0,5),v=A=>{if(p(!1),A.actionUrl)d(A.actionUrl);else{const{type:M,metadata:_={}}=A;if(M==="entity_comment"||M==="entity_mention_entity_note"){const T=_.entity_id||_.related_entity_id,k=A.campaignId||A.campaign?.id||l;T&&d(`/entities/${T}${k?`?campaignId=${k}`:""}#notes`)}else if(M==="session_note_added"||M==="session_note_updated"||M==="entity_mention_session_note"){const T=A.campaignId||A.campaign?.id||_.target_id||l;d(`/notes/session${T?`?campaignId=${T}`:""}`)}else if(M==="request_note_added"||M==="request_status_changed"||M==="request_assigned"){const T=_.request_id||_.requestId;d(T?`/requests/${T}`:"/requests")}else d("/notifications")}},S=async A=>{if(!A.read)try{await i(A.id)}catch(T){console.error("Failed to mark notification read",T)}const M=A.campaignId||A.campaign?.id||"";if(M&&M!==(l||"")){g({open:!0,notification:A});return}v(A)},N=()=>{const{notification:A}=y;if(!A)return;const M=A.campaignId||A.campaign?.id||"";M&&o(M),g({open:!1,notification:null}),setTimeout(()=>{v(A)},100)},j=()=>{g({open:!1,notification:null})},E=b.length>0;return t.jsxs("div",{className:"notification-widget",ref:h,children:[t.jsxs("button",{type:"button",className:"notification-widget-button",onClick:()=>p(!f),title:"Notifications",children:[n>0?t.jsx(Nf,{size:20}):t.jsx(Pl,{size:20}),n>0&&t.jsx("span",{className:"notification-widget-badge",children:n>99?"99+":n})]}),f&&t.jsxs("div",{className:"notification-widget-dropdown",children:[t.jsxs("div",{className:"notification-widget-header",children:[t.jsx("h3",{children:"Notifications"}),n>0&&t.jsxs("span",{className:"notification-widget-count",children:[n," unread"]})]}),s?t.jsx("div",{className:"notification-widget-loading",children:"Loading..."}):E?t.jsx("div",{className:"notification-widget-list",children:b.map(A=>t.jsxs("div",{className:`notification-widget-item ${A.read?"read":"unread"}`,onClick:()=>S(A),children:[t.jsxs("div",{className:"notification-widget-item-content",children:[t.jsx("p",{className:"notification-widget-item-message",children:rI(A)}),t.jsx("span",{className:"notification-widget-item-time",children:sI(A.createdAt)})]}),!A.read&&t.jsx("div",{className:"notification-widget-item-dot"})]},A.id))}):t.jsx("div",{className:"notification-widget-empty",children:"No new notifications"}),t.jsx("div",{className:"notification-widget-footer",children:t.jsxs(Yt,{to:"/notifications",className:"notification-widget-view-all",onClick:()=>p(!1),children:["View all notifications ",t.jsx(xr,{size:14})]})})]}),t.jsx(Fj,{open:y.open,campaignName:y.notification?.campaign?.name||"",onSwitch:N,onCancel:j})]})}const lI=(e={})=>{const n=new URLSearchParams,s=e.viewAsCharacterId??e.characterId??e.character_id??e.viewAs;if(s!=null){const i=String(s).trim();i&&n.set("viewAsCharacterId",i)}return n.toString()},Mc=(e,n={})=>{if(!e)return Promise.reject(new Error("worldId is required to load entities"));const s=new URLSearchParams,i=lI(n);i&&s.set("viewAsCharacterId",new URLSearchParams(i).get("viewAsCharacterId")),n.importance!==void 0&&n.importance!==null&&(Array.isArray(n.importance)?n.importance:[n.importance]).forEach(f=>{f!=null&&s.append("importance[]",f)});const l=s.toString(),o=l?`?${l}`:"";return kt.get(`/worlds/${e}/entities${o}`)},oI=()=>kt.get("/entities/unassigned"),Hs=e=>kt.get(`/entities/${e}`),zj=({worldId:e,query:n,typeIds:s=[],limit:i=20,offset:l=0})=>{if(!e)return Promise.reject(new Error("worldId is required"));const o=new URLSearchParams;o.set("worldId",e),n&&o.set("q",n),(Array.isArray(s)?s:[s]).map(p=>p==null?"":String(p).trim()).filter(Boolean).forEach(p=>{o.append("typeIds[]",p)}),i!=null&&o.set("limit",i),l!=null&&o.set("offset",l);const f=o.toString();return kt.get(`/entities/search${f?`?${f}`:""}`)},cI=({query:e,campaignId:n,worldId:s,limit:i=20,offset:l=0})=>{const o=new URLSearchParams;e&&o.set("q",e),n&&o.set("campaignId",n),s&&o.set("worldId",s),i!=null&&o.set("limit",i),l!=null&&o.set("offset",l);const d=o.toString();return kt.get(`/entities/global-search${d?`?${d}`:""}`)},gg=e=>kt.post("/entities",e),bg=(e,n)=>kt.patch(`/entities/${e}`,n),uI=(e,n)=>kt.patch(`/entities/${e}/importance`,{importance:n}),dI=e=>kt.delete(`/entities/${e}`),Bj=(e,n)=>{if(!e)return Promise.reject(new Error("entityId is required"));if(!n)return Promise.reject(new Error("file is required"));const s=new FormData;return s.append("file",n),kt.post(`/entities/${e}/image`,s)},Uj=e=>e?kt.delete(`/entities/${e}/image`):Promise.reject(new Error("entityId is required")),fI=(e,n)=>kt.post(`/entities/${e}/secrets`,n),mI=(e,n,s)=>kt.patch(`/entities/${e}/secrets/${n}`,s),hI=(e,n={})=>{const s=new URLSearchParams,i=n.campaignId??n.campaign_id;i&&s.set("campaignId",i);const l=s.toString();return kt.get(`/entities/${e}/notes${l?`?${l}`:""}`)},pI=(e,n={})=>{const s=new URLSearchParams,i=n.campaignId??n.campaign_id;i&&s.set("campaignId",i);const l=s.toString();return kt.get(`/entities/${e}/mentions/entity-notes${l?`?${l}`:""}`)},yI=(e,n={})=>{const s=new URLSearchParams,i=n.campaignId??n.campaign_id;i&&s.set("campaignId",i);const l=s.toString();return kt.get(`/entities/${e}/mentions/session-notes${l?`?${l}`:""}`)},gI=(e,n)=>kt.post(`/entities/${e}/notes`,n),qj=(e,n,s)=>kt.patch(`/entities/${e}/notes/${n}`,s),Pj=(e,n,s={})=>{const i=new URLSearchParams,l=s.campaignId??s.campaign_id;l&&i.set("campaignId",l);const o=i.toString();return kt.delete(`/entities/${e}/notes/${n}${o?`?${o}`:""}`)},bI=async(e,n=1)=>{const s=new URLSearchParams;if(n!=null){const o=Number(n);!Number.isNaN(o)&&o>0&&s.set("depth",String(o))}const i=s.toString(),l=await kt.get(`/entities/${e}/graph${i?`?${i}`:""}`,{credentials:"include"});if(!l?.success)throw new Error(l?.message||"Failed to load graph");return l.data},xI=300,vI=(e,n)=>{const[s,i]=u.useState(e);return u.useEffect(()=>{const l=setTimeout(()=>i(e),n);return()=>clearTimeout(l)},[e,n]),s},ld=e=>({name:"Name",description:"Description",notes:"Notes",mentions:"Mentions",relationships:"Relationships",title:"Title",content:"Content"})[e]||e;function CS({isMobile:e,onClose:n}){const s=_n(),{selectedCampaignId:i,activeWorldId:l}=wn(),[o,d]=u.useState(""),f=!!(i||l),[p,h]=u.useState({entities:[],sessionNotes:[]}),[y,g]=u.useState(!1),[b,v]=u.useState(""),[S,N]=u.useState(-1),[j,E]=u.useState(!1),A=vI(o,xI),M=u.useRef(null),_=u.useRef(null),T=u.useRef(0),k=u.useMemo(()=>{const B=[];return p.entities.forEach(D=>{B.push({type:"entity",data:D})}),p.sessionNotes.forEach(D=>{B.push({type:"sessionNote",data:D})}),B},[p]),C=k.length>0,L=j&&(o.trim().length>0||C),z=u.useCallback(async B=>{if(!B.trim()){h({entities:[],sessionNotes:[]}),g(!1);return}if(!f){v("Please select a campaign or world context to search"),h({entities:[],sessionNotes:[]}),g(!1);return}const D=++T.current;g(!0),v("");try{const O=await cI({query:B,campaignId:i,worldId:l,limit:20,offset:0});if(D!==T.current)return;const $=O?.data||{entities:[],sessionNotes:[]};h({entities:Array.isArray($.entities)?$.entities:[],sessionNotes:Array.isArray($.sessionNotes)?$.sessionNotes:[]})}catch(O){if(D!==T.current)return;v(O.message||"Failed to search"),h({entities:[],sessionNotes:[]})}finally{D===T.current&&g(!1)}},[l,i,f]);u.useEffect(()=>{A.trim().length>0?z(A):(h({entities:[],sessionNotes:[]}),g(!1))},[A,z]),u.useEffect(()=>{j&&_.current&&!e&&_.current.focus()},[j,e]),u.useEffect(()=>{const B=D=>{M.current&&!M.current.contains(D.target)&&(e||E(!1))};if(j)return document.addEventListener("mousedown",B),()=>document.removeEventListener("mousedown",B)},[j,e]),u.useEffect(()=>{const B=D=>{if(L)if(D.key==="ArrowDown")D.preventDefault(),N(O=>O<k.length-1?O+1:O);else if(D.key==="ArrowUp")D.preventDefault(),N(O=>O>0?O-1:-1);else if(D.key==="Enter"&&S>=0){D.preventDefault();const O=k[S];O&&X(O)}else D.key==="Escape"&&(D.preventDefault(),E(!1),d(""),e&&n&&n())};if(L)return document.addEventListener("keydown",B),()=>document.removeEventListener("keydown",B)},[L,S,k,e,n]);const G=B=>{d(B.target.value),N(-1),j||E(!0)},U=()=>{E(!0)},X=B=>{B.type==="entity"?s(`/entities/${B.data.id}`):B.type==="sessionNote"&&s(`/campaigns/${i}/session-notes`),E(!1),d(""),e&&n&&n()},V=()=>{d(""),h({entities:[],sessionNotes:[]}),N(-1),e&&n&&n()},R=B=>{if(!B)return"";try{return new Date(B).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch{return B}};return e?t.jsxs("div",{className:"global-search-mobile",children:[t.jsx("div",{className:"global-search-mobile-overlay",onClick:n}),t.jsxs("div",{className:"global-search-mobile-content",children:[t.jsxs("div",{className:`global-search-input-wrapper ${f?"":"disabled"}`,children:[t.jsx(Hl,{size:20,className:"global-search-icon"}),t.jsx("input",{ref:_,type:"text",className:"global-search-input",placeholder:f?"Search entities and session notes...":"Select a campaign or world to search",value:o,onChange:G,onFocus:U,disabled:!f,autoFocus:!0}),o&&t.jsx("button",{type:"button",className:"global-search-clear",onClick:V,"aria-label":"Clear search",children:t.jsx(Bn,{size:16})})]}),L&&t.jsxs("div",{className:"global-search-results",children:[y&&t.jsx("div",{className:"global-search-loading",children:t.jsx("span",{children:"Searching..."})}),!y&&b&&t.jsx("div",{className:"global-search-error",children:t.jsx("span",{children:b})}),!y&&!b&&!C&&o.trim().length>0&&t.jsx("div",{className:"global-search-empty",children:t.jsx("span",{children:"No results found"})}),!y&&!b&&C&&t.jsx("div",{className:"global-search-results-list",children:k.map((B,D)=>t.jsx("button",{type:"button",className:`global-search-result-item ${D===S?"selected":""}`,onClick:()=>X(B),children:B.type==="entity"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"global-search-result-header",children:[t.jsx("span",{className:"global-search-result-name",children:B.data.name}),B.data.typeName&&t.jsx("span",{className:"global-search-result-type",children:B.data.typeName})]}),t.jsx("div",{className:"global-search-result-meta",children:t.jsxs("span",{className:"global-search-match-type",children:["Matched in ",ld(B.data.matchType)]})})]}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"global-search-result-header",children:[t.jsx("span",{className:"global-search-result-name",children:B.data.session_title||"Session Note"}),t.jsx("span",{className:"global-search-result-type",children:"Session Note"})]}),t.jsx("div",{className:"global-search-result-meta",children:t.jsxs("span",{className:"global-search-match-type",children:[R(B.data.session_date),"  Matched in"," ",ld(B.data.matchType)]})})]})},`${B.type}-${B.data.id}`))})]})]})]}):t.jsxs("div",{className:"global-search",ref:M,children:[t.jsxs("div",{className:`global-search-input-wrapper ${f?"":"disabled"}`,children:[t.jsx(Hl,{size:18,className:"global-search-icon"}),t.jsx("input",{ref:_,type:"text",className:"global-search-input",placeholder:f?"Search entities and session notes...":"Select a campaign or world to search",value:o,onChange:G,onFocus:U,disabled:!f}),o&&t.jsx("button",{type:"button",className:"global-search-clear",onClick:V,"aria-label":"Clear search",children:t.jsx(Bn,{size:16})})]}),L&&t.jsxs("div",{className:"global-search-dropdown",children:[y&&t.jsx("div",{className:"global-search-loading",children:t.jsx("span",{children:"Searching..."})}),!y&&b&&t.jsx("div",{className:"global-search-error",children:t.jsx("span",{children:b})}),!y&&!b&&!C&&o.trim().length>0&&t.jsx("div",{className:"global-search-empty",children:t.jsx("span",{children:"No results found"})}),!y&&!b&&C&&t.jsx("div",{className:"global-search-results-list",children:k.map((B,D)=>t.jsx("button",{type:"button",className:`global-search-result-item ${D===S?"selected":""}`,onClick:()=>X(B),children:B.type==="entity"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"global-search-result-header",children:[t.jsx("span",{className:"global-search-result-name",children:B.data.name}),B.data.typeName&&t.jsx("span",{className:"global-search-result-type",children:B.data.typeName})]}),t.jsx("div",{className:"global-search-result-meta",children:t.jsxs("span",{className:"global-search-match-type",children:["Matched in ",ld(B.data.matchType)]})})]}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"global-search-result-header",children:[t.jsx("span",{className:"global-search-result-name",children:B.data.session_title||"Session Note"}),t.jsx("span",{className:"global-search-result-type",children:"Session Note"})]}),t.jsx("div",{className:"global-search-result-meta",children:t.jsxs("span",{className:"global-search-match-type",children:[R(B.data.session_date),"  Matched in"," ",ld(B.data.matchType)]})})]})},`${B.type}-${B.data.id}`))})]})]})}function SI({onMenuToggle:e}){const[n,s]=u.useState(!1),i=u.useRef(null),{user:l,logout:o}=un(),{theme:d,toggleTheme:f}=CR(),{campaigns:p,selectedCampaignId:h,setSelectedCampaignId:y,selectedCampaign:g,loading:b,error:v,worlds:S,selectedWorld:N,selectedWorldId:j,setSelectedWorldId:E,worldLoading:A,worldError:M,viewAsCharacterId:_,setViewAsCharacterId:T}=wn();u.useEffect(()=>{const be=De=>{i.current&&!i.current.contains(De.target)&&s(!1)};return document.addEventListener("mousedown",be),()=>document.removeEventListener("mousedown",be)},[]);const k=be=>{y(be.target.value)},C=be=>{E(be.target.value)},L=to(),[z,G]=u.useState([]),[U,X]=u.useState(!1),[V,R]=u.useState(""),[B,D]=u.useState(!1),[O,$]=u.useState(!1),[F,H]=u.useState(!1),I=u.useMemo(()=>!g||!l?"":g.members?.find(De=>De?.user_id===l.id)?.role||"",[g,l]),Y=u.useMemo(()=>{if(!g?.world)return"";const be=g.world;return be.created_by||be.creator?.id||be.owner_id||be.owner?.id||""},[g]),P=u.useMemo(()=>!h||!l?!1:l.role==="system_admin"||I==="dm"?!0:Y?String(Y)===String(l.id):!1,[I,h,Y,l]);u.useEffect(()=>{P||T("")},[P,T]),u.useEffect(()=>{let be=!1;if(!P||!h){G([]),X(!1),R("");return}return(async()=>{X(!0),R("");try{const Me=await Cs({scope:"others",campaign_id:h}),mt=Array.isArray(Me?.data)?Me.data:Array.isArray(Me)?Me:[];if(be)return;const ht=mt.map(Ct=>{if(!Ct?.id)return null;const At=Ct.name||"Unnamed character",we=Ct.player?.username||Ct.player?.email||Ct.player?.name||"";return{id:String(Ct.id),label:we?`${At} (${we})`:At}}).filter(Boolean).sort((Ct,At)=>Ct.label.localeCompare(At.label,void 0,{sensitivity:"base"}));G(ht)}catch(Me){be||(console.error(" Failed to load characters for view-as context",Me),G([]),R(Me.message||"Unable to load characters"),T(""))}finally{be||X(!1)}})(),()=>{be=!0}},[P,h,T]);const W=u.useMemo(()=>{if(U)return"Loading characters";if(V)return V;if(!_)return"Viewing entities as yourself (DM/owner)";const be=z.find(De=>De.id===_);return be?`Viewing as ${be.label}`:"Viewing as selected character"},[_,z,V,U]),le=u.useMemo(()=>b?"Loading campaigns":v?"Unable to load campaigns":p.length?g?`${g.name}${g.world?.name?`  ${g.world.name}`:""}`:"Select a campaign":"No eligible campaigns",[p,v,b,g]),K=u.useMemo(()=>g?.world?g.world.name?`Campaign world  ${g.world.name}`:"Campaign world selected":A?"Loading worlds":M?"Unable to load worlds":S.length?N?N.name?`World  ${N.name}`:"Selected world":"Select a world":"No accessible worlds",[g,N,A,M,S.length]),de=u.useMemo(()=>{const be=new Set,De=[];if(S.forEach(Me=>{if(!Me?.id)return;const mt=String(Me.id);be.has(mt)||(De.push({id:mt,name:Me.name||`World #${mt}`}),be.add(mt))}),g?.world?.id){const Me=String(g.world.id);be.has(Me)||De.unshift({id:Me,name:g.world.name||"Campaign world"})}return De},[S,g]);u.useEffect(()=>{L||D(!1)},[L]);const Q=be=>{if(!l)return"";const De=be?.members?.find(Me=>Me.user_id===l.id);return De?De.role==="dm"?"DM":De.role==="player"?"Player":De.role||"":l.role==="system_admin"?"System Admin":""},he=()=>D(!1),re=t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"campaign-selector",title:le,children:[t.jsx("label",{htmlFor:"campaign-context-select",children:"Campaign"}),t.jsxs("select",{id:"campaign-context-select",value:h,onChange:k,disabled:b||!p.length&&!h,children:[t.jsx("option",{value:"",children:b?"Loading campaigns":v?"Unable to load campaigns":p.length?"Select a campaign":"No campaigns available"}),p.map(be=>{const De=Q(be),Me=[De?`as ${De}`:null,be.world?.name?`World: ${be.world.name}`:null].filter(Boolean).join("  "),mt=Me?`${be.name} (${Me})`:be.name;return t.jsx("option",{value:be.id,children:mt},be.id)})]})]}),t.jsxs("div",{className:"campaign-selector",title:K,children:[t.jsx("label",{htmlFor:"world-context-select",children:"World"}),t.jsxs("select",{id:"world-context-select",value:j,onChange:C,disabled:A,children:[t.jsx("option",{value:"",children:g?.world?g.world.name?`Using ${g.world.name}`:"Using campaign world":A?"Loading worlds":M?"Unable to load worlds":S.length?"Select a world":"No worlds available"}),de.map(be=>t.jsx("option",{value:be.id,children:be.name},be.id))]})]}),P&&t.jsxs("div",{className:"campaign-selector",title:W,children:[t.jsx("label",{htmlFor:"character-context-select",children:"View as"}),t.jsxs("select",{id:"character-context-select",value:_,onChange:be=>T(be.target.value),disabled:U||!!V,children:[t.jsx("option",{value:"",children:U?"Loading characters":V||"Entire campaign context"}),z.map(be=>t.jsx("option",{value:be.id,children:be.label},be.id))]})]})]}),Ce=t.jsx("button",{type:"button",className:`menu-btn ${L?"menu-btn-icon":"menu-btn-text"}`,onClick:e,"aria-label":L?"Toggle navigation menu":void 0,children:L?t.jsx(hk,{size:20}):"Menu"}),Re=t.jsx("button",{type:"button",className:`history-btn ${L?"history-btn-icon":"history-btn-text"}`,title:"View recently viewed records","aria-label":L?"Open history":void 0,onClick:()=>$(!0),children:L?t.jsx(mg,{size:20}):"History"}),ue=t.jsx("button",{type:"button",className:`context-btn ${L?"context-btn-icon":"context-btn-text"}`,onClick:()=>D(!0),"aria-label":L?"Change context":void 0,title:L?"Change context":void 0,disabled:!L,children:L?t.jsx(Sj,{size:20}):"Context"}),se=!!(h||j),Le=t.jsx("button",{type:"button",className:`search-btn ${L?"search-btn-icon":"search-btn-text"} ${se?"":"disabled"}`,onClick:()=>se&&H(!0),"aria-label":L?"Open search":void 0,title:L?se?"Open search":"Select a campaign or world to search":void 0,disabled:!se,children:L?t.jsx(Hl,{size:20}):"Search"});return t.jsxs("header",{className:"app-header",children:[t.jsx("div",{className:"header-start",children:L?t.jsxs(t.Fragment,{children:[t.jsx("h1",{className:"title",children:t.jsx(Yt,{to:"/",className:"title-link",children:"GameDB"})}),Ce,ue,Le,Re]}):t.jsxs(t.Fragment,{children:[t.jsx("h1",{className:"title",children:t.jsx(Yt,{to:"/",className:"title-link",children:"GameDB"})}),Ce,Re]})}),!L&&t.jsxs("div",{className:"header-center",children:[re,(h||j)&&t.jsx(CS,{isMobile:!1})]}),t.jsx("div",{className:"header-end",children:t.jsx(iI,{})}),t.jsxs("div",{className:"user-menu",ref:i,children:[t.jsx("button",{className:"user-icon",onClick:()=>s(!n),title:"User Menu",children:t.jsx(tR,{size:20})}),n&&t.jsxs("div",{className:"user-dropdown",children:[t.jsxs("div",{className:"user-info",children:[t.jsx("strong",{children:l?.username||"User"}),t.jsx("br",{}),t.jsx("small",{children:l?.role||""})]}),t.jsxs("button",{className:"dropdown-action",onClick:f,children:[d==="dark"?t.jsx(Vk,{size:16}):t.jsx(xk,{size:16}),d==="dark"?"Light mode":"Dark mode"]}),t.jsxs(Yt,{to:"/security",className:"dropdown-action",onClick:()=>s(!1),children:[t.jsx(ck,{size:16}),"Security"]}),t.jsxs("button",{className:"dropdown-action logout",onClick:o,children:[t.jsx(lk,{size:16}),"Logout"]})]})]}),L&&B&&t.jsxs("div",{className:"mobile-context-overlay",role:"dialog","aria-modal":"true",children:[t.jsx("button",{className:"mobile-context-overlay-close",onClick:he,"aria-label":"Close context picker"}),t.jsxs("div",{className:"mobile-context-panel",children:[t.jsxs("div",{className:"mobile-context-header",children:[t.jsx("h2",{children:"Choose context"}),t.jsx("button",{type:"button",onClick:he,"aria-label":"Close context picker",children:t.jsx(Bn,{size:20})})]}),t.jsx("div",{className:"mobile-context-body",children:re})]})]}),t.jsx(WR,{isOpen:O,onClose:()=>$(!1)}),L&&F&&t.jsx(CS,{isMobile:!0,onClose:()=>H(!1)})]})}const wI=e=>e==null?"":String(e).trim(),wr=e=>{let n={};typeof e=="string"?n={worldId:e}:e&&typeof e=="object"&&!Array.isArray(e)&&(n={...e});const s=new URLSearchParams,i=wI(n.worldId??n.world_id);if(!i)return Promise.reject(new Error("worldId is required to list entity types"));s.set("worldId",i);const l=s.toString(),o=l?`?${l}`:"";return kt.get(`/entity-types${o}`)},NI=e=>kt.post("/entity-types",e),jI=e=>kt.get(`/entity-types/${e}`),EI=(e,n)=>kt.patch(`/entity-types/${e}`,n),_I=e=>kt.delete(`/entity-types/${e}`),Rf=(e,n="perform this action")=>e==null||e===""?Promise.reject(new Error(`Entity type id is required to ${n}`)):null,If=e=>{const n=Rf(e,"load entity type field order");return n||kt.get(`/entity-types/${e}/field-order`)},CI=(e,n)=>{const s=Rf(e,"update entity type field order");return s||kt.put(`/entity-types/${e}/field-order`,n)},Lf=e=>{const n=Rf(e,"load entity type field rules");return n||kt.get(`/entity-types/${e}/field-rules`)},AI=(e,n)=>{const s=Rf(e,"create entity type field rule");return s||kt.post(`/entity-types/${e}/field-rules`,n)},Hj=(e,n="perform this action")=>e==null||e===""?Promise.reject(new Error(`Field rule id is required to ${n}`)):null,cp=(e,n)=>{const s=Hj(e,"update this field rule");return s||kt.patch(`/entity-type-field-rules/${e}`,n)},TI=e=>{const n=Hj(e,"delete this field rule");return n||kt.delete(`/entity-type-field-rules/${e}`)},Vj=(e,n={})=>{if(!e)return Promise.reject(new Error("worldId is required to load entity type usage"));const s=new URLSearchParams,i=n.viewAsCharacterId??n.characterId??n.character_id??n.viewAs;if(i!=null){const d=String(i).trim();d&&s.set("viewAsCharacterId",d)}const l=s.toString(),o=l?`?${l}`:"";return kt.get(`/worlds/${e}/entity-types${o}`)},MI=e=>kt.get(`/entity-types/${e}/list-columns`),kI=(e,n)=>kt.patch(`/entity-types/${e}/list-columns`,n);async function RI(e=5,n=200){for(let s=0;s<e;s++){const i=Vs();if(i)return i;await new Promise(l=>setTimeout(l,n))}return null}async function Yc(){const e=await RI();if(!e)throw new Error("Missing or invalid token");return{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}async function Gc(e,n="request"){if(e.status===401)throw console.warn(` Unauthorized during ${n}, clearing session`),localStorage.removeItem("gamedb_session"),window.location.reload(),new Error("Session expired or unauthorized");if(!e.ok){const s=await e.text();throw new Error(`Failed to ${n}: ${e.status} ${s}`)}return e.json()}async function Nr(e={}){const n=await Yc(),s=new URLSearchParams;e.worldId&&s.append("worldId",e.worldId),e.includeFields&&s.append("includeFields",e.includeFields);const i=s.toString(),l=`${sn}/location-types${i?`?${i}`:""}`,o=await fetch(l,{headers:n});return Gc(o,"fetch location types")}async function II(e){const n=await Yc(),s=await fetch(`${sn}/location-types/${e}`,{headers:n});return Gc(s,"fetch location type")}async function LI(e){const n=await Yc(),s=await fetch(`${sn}/location-types`,{method:"POST",headers:n,body:JSON.stringify(e)});return Gc(s,"create location type")}async function DI(e,n){const s=await Yc(),i=await fetch(`${sn}/location-types/${e}`,{method:"PATCH",headers:s,body:JSON.stringify(n)});return Gc(i,"update location type")}async function OI(e){const n=await Yc(),s=await fetch(`${sn}/location-types/${e}`,{method:"DELETE",headers:n});return Gc(s,"delete location type")}async function $I(e,n={}){if(!e)return Promise.reject(new Error("worldId is required to load location type usage"));const s=new URLSearchParams,i=n.viewAsCharacterId??n.characterId??n.character_id??n.viewAs;if(i!=null){const d=String(i).trim();d&&s.set("viewAsCharacterId",d)}const l=s.toString(),o=l?`?${l}`:"";return kt.get(`/worlds/${e}/location-types${o}`)}function FI({open:e,pinned:n,allowPinning:s=!0,onPinToggle:i,onClose:l}){const o=Xa(),{user:d}=un(),{selectedCampaign:f,selectedCampaignId:p,activeWorld:h,activeWorldId:y,viewAsCharacterId:g,contextKey:b}=wn(),[v,S]=u.useState(!1),[N,j]=u.useState(!1),[E,A]=u.useState(!1),[M,_]=u.useState(!1),[T,k]=u.useState(!1),[C,L]=u.useState(!1),[z,G]=u.useState([]),[U,X]=u.useState(!1),[V,R]=u.useState(""),[B,D]=u.useState([]),[O,$]=u.useState(!1),[F,H]=u.useState(""),[I,Y]=u.useState(!0);u.useEffect(()=>{G([]),R(""),D([]),H("")},[b]);const W=u.useMemo(()=>new URLSearchParams(o.search),[o.search]).get("entityType")??"",le=o.pathname==="/entities"||o.pathname.startsWith("/entities/"),K=y||"",de=d?.role==="system_admin",Q=!!y,he=u.useMemo(()=>!f||!d?"":f.members?.find(st=>st?.user_id===d.id)?.role??"",[f,d]),re=u.useMemo(()=>{if(!h||!d?.id)return!1;const we=h.created_by??h.creator?.id??h.owner_id??h.owner?.id??"";return we?String(we)===String(d.id):!1},[h,d?.id]),Ce=!!(Q&&(de||he==="dm"||re)),Re=!!(Q&&(de||re)),ue=!!(Q&&(de||re)),se=!!(Q&&(de||re)),Le=!!(Q&&re),be=u.useMemo(()=>!f||!Array.isArray(f.members)||!d?.id?!1:f.members.some(we=>we?.user_id===d.id&&we?.role==="player"),[f,d]),De=u.useMemo(()=>!f||!Array.isArray(f.members)||!d?.id?!1:f.members.some(we=>we?.user_id===d.id&&we?.role==="dm"),[f,d]),Me=!!(Q&&(Ce||Re||ue||se||Le)),mt=u.useMemo(()=>p?de?!0:De||be:!1,[de,De,be,p]);u.useEffect(()=>{let we=!1;if(!K){G([]),R(""),X(!1);return}return(async()=>{X(!0),R("");try{const lt=await Vj(K,{viewAsCharacterId:g}),Fe=Array.isArray(lt?.data)?lt.data:Array.isArray(lt)?lt:[];we||G(Fe)}catch(lt){we||(console.error(" Failed to load entity types for world",lt),G([]),R("Unable to load entity types"))}finally{we||X(!1)}})(),()=>{we=!0}},[K,b,g]),u.useEffect(()=>{let we=!1;if(!K){D([]),H(""),$(!1);return}return(async()=>{$(!0),H("");try{const lt=await $I(K,{viewAsCharacterId:g}),Fe=Array.isArray(lt?.data)?lt.data:Array.isArray(lt)?lt:[];we||D(Fe)}catch(lt){we||(console.error(" Failed to load location types for world",lt),D([]),H("Unable to load location types"))}finally{we||$(!1)}})(),()=>{we=!0}},[K,b,g]);const ht=u.useCallback(we=>we==="/"?o.pathname==="/":o.pathname===we||o.pathname.startsWith(`${we}/`),[o.pathname]),Ct=u.useCallback(we=>{Q||(we.preventDefault(),alert("Please select a campaign or world context before viewing entities."))},[Q]),At=u.useCallback(we=>{if(n||we.defaultPrevented)return;const st=we.target,lt=st instanceof Element?st:st?.parentElement;if(!lt||typeof lt.closest!="function")return;const Fe=lt.closest("a");Fe&&we.currentTarget.contains(Fe)&&l()},[n,l]);return t.jsxs("aside",{className:`sidebar ${e?"open":"closed"}`,children:[t.jsxs("div",{className:"sidebar-header",children:[t.jsx("span",{children:"Navigation"}),s&&t.jsx("button",{type:"button",className:`pin-btn ${n?"pinned":""}`,title:n?"Unpin menu":"Pin menu","aria-pressed":n,onClick:i,children:t.jsx(Ak,{size:16,className:"pin-icon"})})]}),t.jsxs("nav",{className:"nav-links",onClick:n?void 0:At,children:[t.jsx(Yt,{to:"/",className:ht("/")?"active":"",children:"Home"}),t.jsx(Yt,{to:"/worlds",className:ht("/worlds")?"active":"",children:"Worlds"}),Me&&t.jsxs("div",{className:`nav-group ${E?"collapsed":""}`,children:[t.jsxs("button",{type:"button",className:"nav-heading-btn",onClick:()=>A(we=>!we),"aria-expanded":!E,"aria-controls":"world-admin-nav",children:[t.jsx("span",{className:"nav-heading",children:"World Admin"}),t.jsx(Ss,{size:14,className:`nav-heading-icon ${E?"collapsed":""}`})]}),t.jsxs("div",{id:"world-admin-nav",className:"nav-sub-links",children:[Ce&&t.jsxs(Yt,{to:"/entities",className:`nav-entity-link ${le&&!W?"active":""}`,onClick:Ct,children:[t.jsx(wS,{size:16,className:"nav-icon"}),t.jsx("span",{children:"All Entities"})]}),Re&&t.jsxs(Yt,{to:"/location-types",className:`nav-entity-link ${ht("/location-types")?"active":""}`,children:[t.jsx(Jd,{size:16,className:"nav-icon"}),t.jsx("span",{children:"Location Admin"})]}),Ce&&t.jsxs(Yt,{to:"/entity-relationships",className:`nav-entity-link ${ht("/entity-relationships")?"active":""}`,children:[t.jsx(jS,{size:16,className:"nav-icon"}),t.jsx("span",{children:"All Relationships"})]}),Re&&t.jsxs(Yt,{to:"/entity-types",className:`nav-entity-link ${ht("/entity-types")?"active":""}`,children:[t.jsx($k,{size:16,className:"nav-icon"}),t.jsx("span",{children:"Entity Types"})]}),ue&&t.jsxs(Yt,{to:"/entities/bulk-upload",className:`nav-entity-link ${ht("/entities/bulk-upload")?"active":""}`,children:[t.jsx(wS,{size:16,className:"nav-icon"}),t.jsx("span",{children:"Bulk Entity Upload"})]}),se&&t.jsxs(Yt,{to:"/relationship-types",className:`nav-entity-link ${ht("/relationship-types")?"active":""}`,children:[t.jsx(jS,{size:16,className:"nav-icon"}),t.jsx("span",{children:"Relationship Types"})]}),Le&&K&&t.jsxs(Yt,{to:`/worlds/${K}/access/bulk`,className:`nav-entity-link ${ht(`/worlds/${K}/access/bulk`)?"active":""}`,children:[t.jsx(Ej,{size:16,className:"nav-icon"}),t.jsx("span",{children:"Bulk Access Editor"})]}),Le&&K&&t.jsxs(Yt,{to:`/worlds/${K}/collections`,className:`nav-entity-link ${ht(`/worlds/${K}/collections`)?"active":""}`,children:[t.jsx(Sj,{size:16,className:"nav-icon"}),t.jsx("span",{children:"Collections"})]}),Le&&K&&t.jsxs(Yt,{to:`/worlds/${K}/access/audit`,className:`nav-entity-link ${ht(`/worlds/${K}/access/audit`)?"active":""}`,children:[t.jsx(vj,{size:16,className:"nav-icon"}),t.jsx("span",{children:"Access Audit Log"})]}),re&&!Q&&t.jsx("span",{className:"nav-helper",children:"Select a world you own to use the bulk access tools"})]})]}),t.jsxs("div",{className:`nav-group ${v?"collapsed":""}`,children:[t.jsxs("button",{type:"button",className:"nav-heading-btn",onClick:()=>S(we=>!we),"aria-expanded":!v,"aria-controls":"campaigns-nav",children:[t.jsx("span",{className:"nav-heading",children:"Campaigns"}),t.jsx(Ss,{size:14,className:`nav-heading-icon ${v?"collapsed":""}`})]}),t.jsxs("div",{id:"campaigns-nav",className:"nav-sub-links",children:[t.jsx(Yt,{to:"/campaigns/my",className:ht("/campaigns/my")?"active":"",children:"My Campaigns"}),t.jsx(Yt,{to:"/campaigns/all",className:ht("/campaigns/all")?"active":"",children:"All"})]})]}),t.jsxs("div",{className:`nav-group ${M?"collapsed":""}`,children:[t.jsxs("button",{type:"button",className:"nav-heading-btn",onClick:()=>_(we=>!we),"aria-expanded":!M,"aria-controls":"entities-nav",children:[t.jsx("span",{className:"nav-heading",children:"Entities"}),t.jsx(Ss,{size:14,className:`nav-heading-icon ${M?"collapsed":""}`})]}),t.jsxs("div",{id:"entities-nav",className:"nav-sub-links",children:[U&&t.jsx("span",{className:"nav-helper",children:"Loading entity types"}),!U&&V&&t.jsx("span",{className:"nav-helper error",children:V}),!U&&!V&&z.length===0&&t.jsx("span",{className:"nav-helper",children:Q?"No entities in this world yet":"Select a campaign or world context to see entity types"}),z.map(we=>t.jsxs(Yt,{to:`/entities?entityType=${we.id}`,className:`nav-entity-type ${le&&W===we.id?"active":""}`,children:[t.jsx("span",{className:"nav-entity-label",children:we.name}),t.jsx("span",{className:"nav-entity-count",children:we.entityCount})]},we.id))]})]}),Q&&t.jsxs("div",{className:`nav-group ${T?"collapsed":""}`,children:[t.jsxs("button",{type:"button",className:"nav-heading-btn",onClick:()=>k(we=>!we),"aria-expanded":!T,"aria-controls":"locations-nav",children:[t.jsx("span",{className:"nav-heading",children:"Locations"}),t.jsx(Ss,{size:14,className:`nav-heading-icon ${T?"collapsed":""}`})]}),t.jsxs("div",{id:"locations-nav",className:"nav-sub-links",children:[t.jsxs(Yt,{to:"/locations",className:`nav-entity-link ${ht("/locations")?"active":""}`,children:[t.jsx(Jd,{size:16,className:"nav-icon"}),t.jsx("span",{children:"All Locations"})]}),O&&t.jsx("span",{className:"nav-helper",children:"Loading location types"}),!O&&F&&t.jsx("span",{className:"nav-helper error",children:F}),!O&&!F&&B.filter(we=>we.focus===!0).map(we=>t.jsxs(Yt,{to:`/locations?locationType=${we.id}`,className:`nav-entity-type ${o.pathname==="/locations"&&new URLSearchParams(o.search).get("locationType")===we.id?"active":""}`,children:[t.jsx("span",{className:"nav-entity-label",children:we.name}),t.jsx("span",{className:"nav-entity-count",children:we.locationCount||0})]},we.id)),!O&&!F&&B.filter(we=>we.focus!==!0).length>0&&t.jsxs("div",{className:`nav-group ${I?"collapsed":""}`,children:[t.jsxs("button",{type:"button",className:"nav-heading-btn",onClick:()=>Y(we=>!we),"aria-expanded":!I,"aria-controls":"other-locations-nav",children:[t.jsx("span",{className:"nav-heading",children:"Other Types"}),t.jsx(Ss,{size:14,className:`nav-heading-icon ${I?"collapsed":""}`})]}),t.jsx("div",{id:"other-locations-nav",className:"nav-sub-links",children:B.filter(we=>we.focus!==!0).map(we=>t.jsxs(Yt,{to:`/locations?locationType=${we.id}`,className:`nav-entity-type ${o.pathname==="/locations"&&new URLSearchParams(o.search).get("locationType")===we.id?"active":""}`,children:[t.jsx("span",{className:"nav-entity-label",children:we.name}),t.jsx("span",{className:"nav-entity-count",children:we.locationCount||0})]},we.id))})]})]})]}),t.jsxs("div",{className:`nav-group ${C?"collapsed":""}`,children:[t.jsxs("button",{type:"button",className:"nav-heading-btn",onClick:()=>L(we=>!we),"aria-expanded":!C,"aria-controls":"notes-nav",children:[t.jsx("span",{className:"nav-heading",children:"Notes"}),t.jsx(Ss,{size:14,className:`nav-heading-icon ${C?"collapsed":""}`})]}),t.jsxs("div",{id:"notes-nav",className:"nav-sub-links",children:[!p&&t.jsx("span",{className:"nav-helper",children:"Select a campaign to view notes"}),p&&!mt&&t.jsx("span",{className:"nav-helper",children:"Notes are available to campaign members"}),mt&&t.jsxs(t.Fragment,{children:[t.jsxs(Yt,{to:"/notes/session",className:ht("/notes/session")?"active":"",children:[t.jsx(by,{size:16,className:"nav-icon"}),t.jsx("span",{children:"Session Notes"})]}),t.jsxs(Yt,{to:"/notes/entities",className:ht("/notes/entities")?"active":"",children:[t.jsx(gy,{size:16,className:"nav-icon"}),t.jsx("span",{children:"Entity Notes"})]})]})]})]}),t.jsxs("div",{className:`nav-group ${N?"collapsed":""}`,children:[t.jsxs("button",{type:"button",className:"nav-heading-btn",onClick:()=>j(we=>!we),"aria-expanded":!N,"aria-controls":"characters-nav",children:[t.jsx("span",{className:"nav-heading",children:"Characters"}),t.jsx(Ss,{size:14,className:`nav-heading-icon ${N?"collapsed":""}`})]}),t.jsxs("div",{id:"characters-nav",className:"nav-sub-links",children:[t.jsx(Yt,{to:"/characters/my",className:ht("/characters/my")?"active":"",children:"My Characters"}),p&&be&&t.jsx(Yt,{to:"/characters/companions",className:ht("/characters/companions")?"active":"",children:"My Companions"}),p&&De&&t.jsx(Yt,{to:"/characters/others",className:ht("/characters/others")?"active":"",children:"All Characters"}),d?.role==="system_admin"&&t.jsx(Yt,{to:"/characters/all",className:ht("/characters/all")?"active admin-link":"admin-link",children:"All Characters"})]})]}),t.jsxs(Yt,{to:"/requests",className:ht("/requests")?"active":"",children:[t.jsx(gy,{size:16,className:"nav-icon"}),t.jsx("span",{children:"Feature/Bugs"})]}),d?.role==="system_admin"&&t.jsx(Yt,{to:"/users",className:o.pathname==="/users"?"active admin-link":"admin-link",title:"User Management (Admin Only)",children:"Users"})]})]})}function zI(){const e=()=>typeof window>"u"?!1:window.matchMedia("(max-width: 768px)").matches,[n,s]=u.useState(e),[i,l]=u.useState(()=>!e()),[o,d]=u.useState(!1),f=Xa(),p=u.useRef(i),h=u.useRef(!0);u.useEffect(()=>{if(typeof window>"u")return;const N=window.matchMedia("(max-width: 768px)"),j=E=>{s(E.matches)};return s(N.matches),typeof N.addEventListener=="function"?(N.addEventListener("change",j),()=>N.removeEventListener("change",j)):(N.addListener(j),()=>N.removeListener(j))},[]),u.useEffect(()=>{if(n)l(!1),d(!1);else{const N=h.current;l(N),d(j=>N?!1:j)}},[n]);const y=u.useCallback(()=>{d(N=>!N)},[]),g=u.useCallback(()=>{n||l(N=>{const j=!N;return h.current=j,d(!j),j})},[n]);u.useEffect(()=>{p.current=i},[i]),u.useEffect(()=>{if(i||!o)return;const N=j=>{const E=j.target;(E instanceof Element?E:E&&"parentElement"in E?E.parentElement:null)?.closest?.(".sidebar")||d(!1)};return document.addEventListener("mousedown",N),()=>{document.removeEventListener("mousedown",N)}},[i,o]),u.useEffect(()=>{p.current||d(!1)},[f.pathname,f.search]);const b=(f.pathname||"").match(/^\/entities\/([^/]+)\/?$/),v=!!(b&&b[1]!=="bulk-upload"),S=["content",i?"pinned":"",v?"content--entity-detail":""].filter(Boolean).join(" ");return t.jsxs("div",{className:"app-shell",children:[t.jsx(SI,{onMenuToggle:y}),t.jsxs("div",{className:"app-body",children:[t.jsx(FI,{open:o||i,pinned:i,allowPinning:!n,onPinToggle:g,onClose:()=>d(!1)}),!i&&o&&t.jsx("button",{type:"button",className:"sidebar-overlay","aria-label":"Close navigation menu",onClick:()=>d(!1)}),t.jsxs("main",{className:S,children:[t.jsx(_T,{})," "]})]})]})}const od={dm:1,player:2,other:3},BI=(e,n)=>!e||!Array.isArray(e.members)||!n?null:e.members.find(s=>s?.user_id===n)??null;function UI(){const{user:e}=un(),{campaigns:n,loading:s,error:i,selectedCampaignId:l,setSelectedCampaignId:o,selectedCampaign:d,refreshCampaigns:f}=wn(),p=e?.username||"Adventurer",[h,y]=u.useState([]),[g,b]=u.useState([]),[v,S]=u.useState(!1),[N,j]=u.useState(!1),[E,A]=u.useState(""),[M,_]=u.useState(""),T=u.useMemo(()=>Array.isArray(n)?[...n].map(U=>({campaign:U,membership:BI(U,e?.id)})).sort((U,X)=>{const V=od[U.membership?.role]??od.other,R=od[X.membership?.role]??od.other;return V!==R?V-R:U.campaign.name.localeCompare(X.campaign.name)}):[],[n,e?.id]),k=U=>{U&&o(String(U))};u.useEffect(()=>{let U=!1;if(y([]),b([]),A(""),_(""),!l||!e?.id)return S(!1),j(!1),()=>{U=!0};const X=R=>(Array.isArray(R?.data)?R.data:Array.isArray(R)?R:[]).map(D=>{const O=Number(D?.level);return{id:D?.id,name:D?.name||"Unnamed character",className:D?.class||"",level:Number.isNaN(O)?null:O,isActive:D?.is_active??!0,playerName:D?.player?.username||""}});return(async()=>{S(!0),j(!1);try{const R=await Cs({scope:"my",campaign_id:l});if(U)return;const B=X(R);if(y(B),A(""),S(!1),B.length>0){j(!0);try{const D=await Cs({scope:"companions",campaign_id:l});if(U)return;const O=X(D);b(O),_("")}catch(D){if(U)return;console.error(" Failed to load companions for home widgets",D),b([]),_(D.message||"Failed to load companions")}finally{U||j(!1)}}else b([]),_(""),j(!1)}catch(R){if(U)return;console.error(" Failed to load characters for home widgets",R),y([]),b([]),A(R.message||"Failed to load characters"),_(""),S(!1),j(!1)}})(),()=>{U=!0}},[l,e?.id]);const C=()=>s?t.jsxs("div",{className:"home-empty-state",children:[t.jsx(mn,{className:"spin",size:24}),t.jsx("p",{children:"Loading your campaigns"})]}):i?t.jsxs("div",{className:"home-empty-state error",children:[t.jsx("p",{children:i}),t.jsx("button",{type:"button",className:"home-refresh",onClick:f,children:"Try again"})]}):T.length?t.jsx("div",{className:"campaign-grid",children:T.map(({campaign:U,membership:X})=>{const V=String(U.id),R=l===V,B=X?.role??"guest",D=B==="dm"?"Dungeon Master":B==="player"?"Player":"Observer";return t.jsxs("button",{type:"button",className:`campaign-card ${B} ${R?"active":""}`,onClick:()=>k(V),"aria-pressed":R,children:[t.jsxs("header",{children:[t.jsxs("span",{className:"campaign-role","aria-label":`Role: ${D}`,children:[B==="dm"?t.jsx($M,{size:18}):t.jsx(Gk,{size:18}),D]}),R&&t.jsx("span",{className:"campaign-pill",children:"Active"})]}),t.jsxs("div",{className:"campaign-body",children:[t.jsx("h3",{children:U.name}),U.world?.name&&t.jsxs("p",{className:"campaign-world",children:["World  ",U.world.name]})]}),t.jsx("footer",{children:t.jsx("span",{children:"Set campaign context"})})]},V)})}):t.jsxs("div",{className:"home-empty-state",children:[t.jsx(Yi,{size:24}),t.jsx("p",{children:"No campaigns yet. Join one to get started!"})]}),L=()=>v?t.jsxs("div",{className:"home-widget-empty",children:[t.jsx(mn,{className:"spin",size:20}),t.jsx("p",{children:"Loading your characters"})]}):E?t.jsx("div",{className:"home-widget-error",children:t.jsx("p",{children:E})}):h.length?t.jsx("div",{className:"home-card-grid",children:h.map(U=>t.jsxs("article",{className:"home-card",children:[t.jsxs("header",{children:[t.jsx("h3",{children:U.name}),t.jsx("span",{className:`home-card-status ${U.isActive?"active":"inactive"}`,children:U.isActive?"Active":"Inactive"})]}),t.jsxs("div",{className:"home-card-meta",children:[U.className&&t.jsx("span",{children:U.className}),U.level!==null&&t.jsxs("span",{children:["Level ",U.level]})]})]},U.id))}):t.jsx("div",{className:"home-widget-empty",children:t.jsx("p",{children:"No characters in this campaign yet."})}),z=()=>N?t.jsxs("div",{className:"home-widget-empty",children:[t.jsx(mn,{className:"spin",size:20}),t.jsx("p",{children:"Loading companions"})]}):M?t.jsx("div",{className:"home-widget-error",children:t.jsx("p",{children:M})}):g.length?t.jsx("div",{className:"home-card-grid",children:g.map(U=>t.jsxs("article",{className:"home-card",children:[t.jsxs("header",{children:[t.jsx("h3",{children:U.name}),t.jsx("span",{className:`home-card-status ${U.isActive?"active":"inactive"}`,children:U.isActive?"Active":"Inactive"})]}),t.jsxs("div",{className:"home-card-meta",children:[U.className&&t.jsx("span",{children:U.className}),U.level!==null&&t.jsxs("span",{children:["Level ",U.level]})]}),U.playerName&&t.jsxs("p",{className:"home-card-player",children:["Played by ",U.playerName]})]},U.id))}):t.jsx("div",{className:"home-widget-empty",children:t.jsx("p",{children:"No companions discovered in this campaign yet."})}),G=!!d&&h.length>0&&!E;return t.jsxs("div",{className:"home-page",children:[t.jsxs("section",{className:"home-hero",children:[t.jsxs("div",{className:"home-hero-text",children:[t.jsx("p",{className:"home-eyebrow",children:"Your Tabletop Worldbuilding Database"}),t.jsxs("h1",{children:["Welcome, ",p,"."]}),t.jsx("p",{className:"home-description",children:"Select a campaign to explore and build the world."})]}),d&&t.jsxs("div",{className:"home-active-campaign",children:[t.jsx("span",{className:"home-active-label",children:"Currently focused"}),t.jsx("h2",{children:d.name}),d.world?.name&&t.jsx("p",{children:d.world.name})]})]}),t.jsxs("section",{className:"home-section",children:[t.jsxs("div",{className:"home-section-header",children:[t.jsxs("div",{children:[t.jsx("h2",{children:"Your campaigns"}),t.jsx("p",{children:"Choose a tile below to update the active campaign context."})]}),t.jsx("button",{type:"button",className:"home-refresh",onClick:f,disabled:s,children:"Refresh"})]}),C()]}),G&&t.jsxs(t.Fragment,{children:[t.jsxs("section",{className:"home-section",children:[t.jsxs("div",{className:"home-section-header",children:[t.jsxs("div",{children:[t.jsx("h2",{children:"My Characters"}),t.jsxs("p",{children:["Quick access to your heroes in ",d.name,"."]})]}),t.jsx(Yt,{to:"/characters/my",className:"home-link",children:"Manage"})]}),L()]}),t.jsxs("section",{className:"home-section",children:[t.jsxs("div",{className:"home-section-header",children:[t.jsxs("div",{children:[t.jsx("h2",{children:"My Companions"}),t.jsxs("p",{children:["Meet the fellow adventurers journeying in ",d.name,"."]})]}),t.jsx(Yt,{to:"/characters/companions",className:"home-link",children:"View list"})]}),z()]})]})]})}function qI({columns:e,visibleCols:n,onChange:s,onClose:i}){const l=u.useRef(null);u.useEffect(()=>{const f=p=>{l.current&&!l.current.contains(p.target)&&i()};return document.addEventListener("mousedown",f),()=>document.removeEventListener("mousedown",f)},[i]);const o=f=>{s(n.includes(f)?n.filter(p=>p!==f):[...n,f])},d=()=>{s(e.map(f=>f.key)),i()};return t.jsxs("div",{className:"column-picker",ref:l,children:[t.jsx("div",{className:"column-picker-list",children:e.map(f=>t.jsxs("label",{className:"column-option",children:[t.jsx("input",{type:"checkbox",checked:n.includes(f.key),onChange:()=>o(f.key)}),f.label]},f.key))}),t.jsx("button",{className:"reset-btn",onClick:d,children:"Reset Columns"})]})}function xg({value:e,onChange:n,placeholder:s="Search...",ariaLabel:i}){return t.jsx("input",{className:"search-input compact",type:"text",placeholder:s,"aria-label":i||s,value:e,onChange:l=>n(l.target.value)})}const PI={text:"string",string:"string",varchar:"string",number:"number",integer:"number",float:"number",decimal:"number",numeric:"number",boolean:"boolean",bool:"boolean",checkbox:"boolean",date:"date",datetime:"date",timestamp:"date"},AS={string:[{value:"contains",label:"contains"},{value:"not_contains",label:"doesn't contain"},{value:"equals",label:"is exactly"},{value:"not_equals",label:"is not"},{value:"starts_with",label:"starts with"},{value:"ends_with",label:"ends with"}],number:[{value:"equals",label:"is"},{value:"not_equals",label:"is not"},{value:"greater_than",label:"is greater than"},{value:"less_than",label:"is less than"},{value:"greater_or_equal",label:"is on or above"},{value:"less_or_equal",label:"is on or below"}],boolean:[{value:"is_true",label:"is true"},{value:"is_false",label:"is false"}],date:[{value:"on",label:"is on"},{value:"before",label:"is before"},{value:"after",label:"is after"},{value:"on_or_before",label:"is on or before"},{value:"on_or_after",label:"is on or after"}]},Li={logic:"AND",conditions:[]},no=e=>{if(!e)return"string";const n=String(e).toLowerCase();return PI[n]||"string"},Ny=e=>{const n=no(e);return AS[n]||AS.string},Yj=(e,n="string")=>{if(e==null||e==="")return"Unassigned";const s=no(n);if(Array.isArray(e))return e.length?e.map(i=>Yj(i,n)).join(", "):"Unassigned";if(s==="date"){const i=e instanceof Date?e:new Date(e);return Number.isNaN(i.getTime())?String(e):i.toLocaleDateString()}return s==="boolean"?e?"True":"False":String(e)},ef=e=>{if(e==null||e==="")return null;const n=Number(e);return Number.isNaN(n)?null:n},tf=e=>{if(e==null||e==="")return null;const n=e instanceof Date?e:new Date(e);return Number.isNaN(n.getTime())?null:n},jy=e=>{if(e==null||e==="")return null;if(typeof e=="string"){const n=e.trim();return n.length>0?n:null}if(typeof e=="object"&&!Array.isArray(e)){const n=e.id??e.value??e.key??e.slug??e.uuid??null;return n!=null?String(n).trim():null}if(Array.isArray(e)){for(const n of e){const s=jy(n);if(s)return s}return null}return null},Gj=e=>{if(e==null)return"";if(typeof e=="string")return e.toLowerCase();if(typeof e=="number")return String(e);if(typeof e=="boolean")return e?"true":"false";if(e instanceof Date)return e.toISOString().toLowerCase();if(Array.isArray(e))return e.map(n=>Gj(n)).filter(Boolean).join(" ");if(typeof e=="object")try{return JSON.stringify(e).toLowerCase()}catch{return""}return String(e).toLowerCase()},HI=e=>{const n=e.trim().toLowerCase();return n?s=>Gj(s).includes(n):()=>!0},VI=(e,n)=>e.localeCompare(n,void 0,{sensitivity:"base"}),YI=(e,n,s="string")=>{const i=no(s),l=e==null||e==="",o=n==null||n==="";if(l&&o)return 0;if(l)return 1;if(o)return-1;if(i==="number"){const d=ef(e),f=ef(n);return d===null&&f===null?0:d===null?1:f===null?-1:d-f}if(i==="date"){const d=tf(e),f=tf(n);return!d&&!f?0:d?f?d.getTime()-f.getTime():-1:1}if(i==="boolean"){const d=!!e;return d===!!n?0:d?-1:1}return VI(String(e),String(n))},GI=(e,n,s="string")=>{const{operator:i,value:l}=n,o=no(s),d=s&&String(s).toLowerCase()==="reference",f=p=>{if(d){const v=jy(p),S=jy(l)||String(l??"").trim(),N=v?String(v).toLowerCase():"",j=S?String(S).toLowerCase():"";switch(i){case"equals":return N===j&&N.length>0;case"not_equals":return N!==j||N.length===0;case"contains":return N.includes(j);case"not_contains":return!N.includes(j)}}if(o==="number"){const v=ef(p),S=ef(l);if(v===null&&S===null)return i==="equals";if(v===null||S===null)return!1;switch(i){case"equals":return v===S;case"not_equals":return v!==S;case"greater_than":return v>S;case"less_than":return v<S;case"greater_or_equal":return v>=S;case"less_or_equal":return v<=S;default:return!1}}if(o==="date"){const v=tf(p),S=tf(l);if(!v||!S)return!1;switch(i){case"on":return v.getFullYear()===S.getFullYear()&&v.getMonth()===S.getMonth()&&v.getDate()===S.getDate();case"before":return v.getTime()<S.getTime();case"after":return v.getTime()>S.getTime();case"on_or_before":return v.getTime()<=S.getTime();case"on_or_after":return v.getTime()>=S.getTime();default:return!1}}if(o==="boolean"){const v=!!p;return i==="is_true"?v===!0:i==="is_false"?v===!1:i==="equals"?v===(String(l).toLowerCase()==="true"):i==="not_equals"?v!==(String(l).toLowerCase()==="true"):!1}const h=String(p??""),y=String(l??""),g=h.toLowerCase(),b=y.toLowerCase();switch(i){case"contains":return g.includes(b);case"not_contains":return!g.includes(b);case"equals":return g===b;case"not_equals":return g!==b;case"starts_with":return g.startsWith(b);case"ends_with":return g.endsWith(b);default:return!1}};return Array.isArray(e)?e.length===0?f(""):i==="not_contains"?e.every(p=>!f(p)):e.some(p=>f(p)):f(e)},Wj=e=>{if(!e||typeof e!="object")return!1;const{conditions:n}=e;return Array.isArray(n)?n.some(s=>s.field&&s.operator):!1},zd=(e="",n="string")=>({id:`condition-${Math.random().toString(36).slice(2)}`,field:e,operator:Ny(n)[0]?.value||"equals",value:""}),TS=(e,n)=>{if(!e||!n||typeof n!="string")return;const s=n.split(".");let i=e;for(const l of s){if(i==null)return;i=i[l]}return i},tc=e=>Array.isArray(e)?e:[],WI=(e=[])=>e.map(n=>({...n,dataType:no(n.dataType||n.type)})),XI={};function Xj(e,n=XI){const s=u.useMemo(()=>WI(n.columns||[]),[n.columns]),i=u.useMemo(()=>new Map(s.map(O=>[O.key,O])),[s]),l=u.useCallback((O,$)=>{const F=i.get($)||{};return typeof F.accessor=="function"?F.accessor(O):F.path?TS(O,F.path):TS(O,$)??O?.[$]},[i]),[o,d]=u.useState(""),[f,p]=u.useState({key:"",direction:"asc"}),[h,y]=u.useState(""),[g,b]=u.useState(Li),[v,S]=u.useState(new Set),N=u.useCallback(()=>{S(new Set)},[]),j=u.useCallback(O=>{O&&p($=>{if($.key===O){const F=$.direction==="asc"?"desc":"asc";return{key:O,direction:F}}return{key:O,direction:"asc"}})},[]),E=u.useCallback(O=>{y($=>{const F=$===O?"":O;return F!==$&&N(),F})},[N]),A=u.useMemo(()=>HI(o),[o]),M=u.useMemo(()=>s.filter(O=>O.searchable!==!1),[s]),_=u.useMemo(()=>{if(!o)return tc(e);const O=A;return tc(e).filter($=>M.some(F=>{const H=l($,F.key);return O(H)}))},[e,A,l,M,o]),T=u.useMemo(()=>g||Li,[g]),k=u.useMemo(()=>tc(T.conditions),[T]),C=(T.logic||"AND").toUpperCase()==="OR"?"OR":"AND",L=Wj(T),z=u.useMemo(()=>L?_.filter(O=>{const $=k.map(F=>{const H=i.get(F.field);if(!H||!F.operator)return!1;const I=l(O,F.field);return GI(I,F,H.dataType)});return C==="OR"?$.some(Boolean):$.every(Boolean)}):_,[_,k,i,l,C,L]),G=u.useMemo(()=>{const O=tc(z);if(!f.key)return O;const $=i.get(f.key);if(!$)return O;const F=[...O];return F.sort((H,I)=>{const Y=l(H,f.key),P=l(I,f.key),W=YI(Y,P,$.dataType);return f.direction==="asc"?W:-W}),F},[z,f,i,l]),U=u.useMemo(()=>{if(!h)return[];const O=i.get(h);if(!O)return[];const $=[],F=new Map;return G.forEach(H=>{const I=l(H,h),Y=Yj(I,O.dataType),P=`${h}:${Y}`;F.has(P)||(F.set(P,$.length),$.push({id:P,value:I,label:Y,items:[]}));const W=F.get(P);$[W].items.push(H)}),$},[G,h,i,l]),X=u.useCallback(O=>{O&&S($=>{const F=new Set($);return F.has(O)?F.delete(O):F.add(O),F})},[]),V=u.useCallback(O=>O?v.has(O):!1,[v]),R=u.useCallback(()=>{b(Li)},[]),B=u.useCallback(O=>{if(!O||typeof O!="object"){b(Li);return}const $=(O.logic||"AND").toUpperCase()==="OR"?"OR":"AND",F=tc(O.conditions).map(H=>{const I=i.get(H.field);return I?{...H,field:I.key,operator:H.operator||zd(I.key,I.dataType).operator,value:H.value??""}:null});b({logic:$,conditions:F.filter(Boolean)})},[i]);return{searchTerm:o,setSearchTerm:d,sortState:f,toggleSort:j,groupBy:h,setGroupBy:E,filters:T,setFilters:B,clearFilters:R,filterActive:L,data:G,groups:U,visibleData:h?U:G,getValue:l,toggleGroupCollapse:X,isGroupCollapsed:V,columns:s}}const Kj=e=>{if(!e||typeof e!="object")return e;const n=e.imageData!==void 0?e.imageData:e.image_data!==void 0?e.image_data:null,s=e.imageMimeType!==void 0?e.imageMimeType:e.image_mime_type!==void 0?e.image_mime_type:null;return e.imageData===n&&e.imageMimeType===s?e:{...e,imageData:n,imageMimeType:s}},Ya=e=>{if(!e||typeof e!="object")return null;const n=e.data&&typeof e.data=="object"&&"id"in e.data?e.data:e.entity&&typeof e.entity=="object"&&"id"in e.entity?e.entity:"id"in e?e:null;return n?Kj(n):null},ao=e=>{if(!e||typeof e!="object")return"";const n=e.imageData??e.image_data,s=e.imageMimeType??e.image_mime_type;return!n||!s?"":`data:${s};base64,${n}`},KI=Object.freeze([]);function kc({worldId:e,label:n,value:s,onChange:i,allowedTypeIds:l=[],disabled:o=!1,placeholder:d="Search entities",staticOptions:f,minSearchLength:p=2,onResolved:h,required:y=!1}){const[g,b]=u.useState(""),[v,S]=u.useState([]),[N,j]=u.useState(!1),[E,A]=u.useState(!1),[M,_]=u.useState(null),[T,k]=u.useState(""),C=u.useRef(null),L=u.useRef(null),z=u.useRef(h),G=u.useMemo(()=>[...l],[JSON.stringify(l)]),U=Array.isArray(f)?f:KI,X=u.useMemo(()=>Array.isArray(U)?U.map((H,I)=>{if(H==null)return null;if(typeof H=="object"){const P=H.value??H.id??H.key??H.slug??`static-${I}`;if(P==null)return null;const W=H.label??H.name??H.title??H.display??H.displayName??P;return{id:String(P),name:String(W),entity_type:H.entity_type||H.entityType||null,typeName:H.typeName||null,_static:!0}}const Y=String(H);return{id:Y,name:Y,_static:!0}}).filter(Boolean):[],[U]),V=H=>{if(!H)return"";const I=H.entity_type?.name||H.entityType?.name||H.typeName||H.type?.name||"";return I?`${H.name} (${I})`:H.name};u.useEffect(()=>{o&&A(!1)},[o]),u.useEffect(()=>()=>{L.current&&clearTimeout(L.current)},[]),u.useEffect(()=>{if(!s){_(null),b("");return}if(typeof s=="object"&&s.id){const P=V(s);(!M||M.id!==s.id)&&(_(s),b(P));return}if(typeof s!="string")return;const H=s;if(M?.id===H)return;const I=X.find(P=>String(P.id)===String(H));if(I){_(I),b(V(I));return}let Y=!1;return(async()=>{try{const P=await Hs(H);if(Y)return;const W=Ya(P);if(W?.id){_(W),b(V(W));return}}catch(P){Y||console.warn("Entity lookup failed",P)}Y||(_({id:H,name:H}),b(H))})(),()=>{Y=!0}},[s,X,M?.id]),u.useEffect(()=>{g.trim().length===0&&S([])},[G]),u.useEffect(()=>{if(!g.trim()||M||o)return;const H=g.trim();if(H.length<p){S([]);return}return L.current&&clearTimeout(L.current),L.current=setTimeout(()=>{if(!e){S([]),j(!1);return}(async()=>{try{j(!0),k("");const I={worldId:e,query:H,limit:20};G&&G.length>0&&(I.typeIds=G);const Y=await zj(I),P=Array.isArray(Y?.data)?Y.data:Y,W=Array.isArray(P)?G&&G.length>0?P.filter(le=>{const K=le.typeId||le.entity_type_id||le.entityType?.id||"";return K&&G.includes(String(K))}):P:[];S(W)}catch(I){console.error("Entity search failed",I),S([]),k(I.message||"Failed to search entities.")}finally{j(!1)}})()},400),()=>{L.current&&clearTimeout(L.current)}},[g,e,M,G,o,p]),u.useEffect(()=>{const H=I=>{C.current&&!C.current.contains(I.target)&&A(!1)};return document.addEventListener("mousedown",H),()=>document.removeEventListener("mousedown",H)},[]),u.useEffect(()=>{z.current=h},[h]),u.useEffect(()=>{z.current?.(M||null)},[M]);const R=u.useMemo(()=>{if(!X.length)return[];if(!g.trim())return X;const H=g.trim().toLowerCase();return X.filter(I=>V(I).toLowerCase().includes(H))},[X,g]),B=u.useMemo(()=>{const H=new Map,I=[];return R.forEach(Y=>{const P=Y?.id;if(P==null)return;const W=String(P);H.has(W)||(H.set(W,!0),I.push(Y))}),v.forEach(Y=>{const P=Y?.id;if(P==null)return;const W=String(P);H.has(W)||(H.set(W,!0),I.push(Y))}),I},[R,v]),D=H=>{H&&(_(H),b(V(H)),A(!1),S([]),k(""),i?.(H))},O=()=>{_(null),b(""),S([]),k(""),A(!1),i?.(null)},$=E&&B.length>0,F=E&&!N&&!B.length&&g.trim().length>=p&&!M;return t.jsxs("div",{className:"entity-search-select",ref:C,children:[n&&t.jsx("label",{children:n}),t.jsxs("div",{className:"entity-search-wrapper",children:[t.jsx("input",{type:"text",value:g,required:y,onChange:H=>{const I=H.target.value;b(I),_(null),o||A(!0)},onFocus:()=>{o||A(!0)},disabled:o,placeholder:d,className:"entity-search-input"}),M&&!o&&t.jsx("button",{type:"button",className:"clear-btn",onClick:O,title:"Clear selection","aria-label":"Clear selection",children:""})]}),N&&t.jsx("div",{className:"small text-muted",children:"Searching"}),T&&t.jsx("div",{className:"small text-warning",children:T}),$&&t.jsx("ul",{className:"entity-results",children:B.map(H=>t.jsx("li",{onMouseDown:I=>I.preventDefault(),onClick:()=>D(H),className:M?.id===H.id?"selected":"",children:V(H)},H.id))}),F&&t.jsx("div",{className:"small text-muted",style:{marginTop:"0.25rem"},children:"No matches found."})]})}const MS=e=>Array.isArray(e)?e:[],ZI=e=>{const n=e?.options?.choices;return!Array.isArray(n)||n.length===0?[]:n.map((s,i)=>{if(s==null)return null;if(typeof s=="object"){const o=s.value??s.id??s.key??s.slug??`choice-${i}`,d=s.label??s.name??s.title??s.display??o;return o==null?null:{value:String(o),label:String(d??o)}}const l=String(s);return{value:l,label:l}}).filter(Boolean)};function Zj({open:e,onClose:n,fields:s=[],value:i=Li,worldId:l,onApply:o}){const d=Array.isArray(s)?s:[],f=d[0]?.key||"",[p,h]=u.useState(i.logic||"AND"),[y,g]=u.useState(()=>{const k=MS(i.conditions);return k.length>0?k.map(C=>({...C})):[zd(f,d[0]?.dataType)]}),[b,v]=u.useState(new Map);u.useEffect(()=>{if(!e)return;h(i.logic||"AND");const k=MS(i.conditions);k.length>0?g(k.map(C=>({...C}))):g([zd(f,d[0]?.dataType)])},[e,i,f,d]);const S=()=>{const k=y[0]?.field||f,C=d.find(L=>L.key===k);g(L=>[...L,zd(k,C?.dataType)])},N=(k,C)=>{g(L=>{const z=[...L],G=d.find(U=>U.key===C);return z[k]={...z[k],field:C,operator:Ny(G?.dataType)[0]?.value||"equals",value:""},z})},j=(k,C)=>{g(L=>{const z=[...L];return z[k]={...z[k],operator:C},z})},E=(k,C)=>{g(L=>{const z=[...L];return z[k]={...z[k],value:C},z})},A=k=>{g(C=>{if(C.length===1)return C;const L=[...C];return L.splice(k,1),L})},M=()=>{const k=y.map(C=>({...C})).filter(C=>C.field&&C.operator);if(k.length===0){o?.(Li);return}o?.({logic:p,conditions:k})},_=u.useMemo(()=>(Array.isArray(s)?s:[]).map(C=>({...C,originalDataType:C.dataType||C.type||"string",dataType:no(C.dataType||C.type)})),[s]),T=u.useCallback((k,C)=>{if(!k){v(G=>{const U=new Map(G),X=y[C];return X?.value&&U.delete(String(X.value)),U});return}const L=String(k.id),z=k.name||`Entity ${L}`;v(G=>{const U=new Map(G);return U.set(L,z),U})},[y]);return e?t.jsx("div",{className:"condition-modal-backdrop",role:"dialog","aria-modal":"true",children:t.jsxs("div",{className:"condition-modal",children:[t.jsxs("div",{className:"condition-modal-header",children:[t.jsx("h2",{children:"Filters"}),t.jsx("button",{type:"button",className:"icon-btn",onClick:n,"aria-label":"Close filters",children:t.jsx(Bn,{size:18})})]}),t.jsxs("div",{className:"condition-logic",children:[t.jsx("span",{children:"Match records where"}),t.jsxs("div",{className:"logic-toggle",role:"group","aria-label":"Filter logic",children:[t.jsx("button",{type:"button",className:`logic-btn${p==="AND"?" is-active":""}`,onClick:()=>h("AND"),children:"All conditions (AND)"}),t.jsx("button",{type:"button",className:`logic-btn${p==="OR"?" is-active":""}`,onClick:()=>h("OR"),children:"Any condition (OR)"})]})]}),t.jsx("div",{className:"condition-list",children:Array.isArray(y)&&y.map((k,C)=>{const L=_.find(V=>V.key===k.field)||_[0]||{dataType:"string",key:""},z=Ny(L.dataType),G=Array.isArray(z)?z:[],U=k.operator||G[0]?.value||"equals",X=!["is_true","is_false"].includes(U);return t.jsxs("div",{className:"condition-row",children:[t.jsx("select",{className:"condition-field",value:k.field||L.key,onChange:V=>N(C,V.target.value),children:_.map(V=>t.jsx("option",{value:V.key,children:V.label},V.key))}),t.jsx("select",{className:"condition-operator",value:U,onChange:V=>j(C,V.target.value),children:G.map(V=>t.jsx("option",{value:V.value,children:V.label},V.value))}),X?(()=>{const V=L.originalDataType||L.dataType,R=V==="boolean"||V==="bool",B=V==="enum",D=L.referenceTypeId||L.reference_type_id||L.referenceType?.id||null,O=(V==="reference"||L.dataType==="reference")&&D,$=(U==="equals"||U==="not_equals")&&(R||B||O);if($&&R)return t.jsxs("select",{className:"condition-value",value:k.value??"",onChange:F=>E(C,F.target.value),children:[t.jsx("option",{value:"",children:"Select..."}),t.jsx("option",{value:"true",children:"True"}),t.jsx("option",{value:"false",children:"False"})]});if($&&B){const F=ZI(L),H=Array.isArray(F)?F:[];return H.length===0?t.jsx("input",{className:"condition-value",type:"text",value:k.value??"",onChange:I=>E(C,I.target.value),placeholder:"Value"}):t.jsxs("select",{className:"condition-value",value:k.value??"",onChange:I=>E(C,I.target.value),children:[t.jsx("option",{value:"",children:"Select..."}),H.map(I=>t.jsx("option",{value:I.value,children:I.label},I.value))]})}if($&&O){const F=L.referenceTypeId||L.reference_type_id||L.referenceType?.id||null,H=F?String(F).trim():null,I=L.referenceTypeName||L.reference_type_name||L.referenceType?.name||"entities",Y=k.value,P=H&&H.length>0?[H]:[],W=Y||null;return t.jsx("div",{className:"condition-value-reference",children:t.jsx(kc,{worldId:l,value:W,allowedTypeIds:P,placeholder:`Search ${I.toLowerCase()}...`,disabled:!l||!H,onChange:le=>{if(!le)E(C,""),T(null,C);else{const K=String(le.id);E(C,K),T(le,C)}},onResolved:le=>T(le,C),minSearchLength:2})})}return t.jsx("input",{className:"condition-value",type:L.dataType==="number"?"number":L.dataType==="date"?"date":"text",value:k.value??"",onChange:F=>E(C,F.target.value),placeholder:"Value"})})():t.jsx("span",{className:"condition-value placeholder",children:"No value"}),t.jsx("button",{type:"button",className:"icon-btn",onClick:()=>A(C),disabled:y.length===1,"aria-label":"Remove condition",children:t.jsx(zn,{size:16})})]},k.id||`${k.field}-${C}`)})}),t.jsxs("div",{className:"condition-actions",children:[t.jsxs("button",{type:"button",className:"btn secondary",onClick:S,children:[t.jsx(Wn,{size:16})," Add condition"]}),t.jsxs("div",{className:"condition-action-right",children:[Wj(i)&&t.jsx("button",{type:"button",className:"btn ghost",onClick:()=>o?.(Li),children:"Clear filters"}),t.jsx("button",{type:"button",className:"btn submit",onClick:M,children:"Apply filters"})]})]})]})}):null}function Df({data:e,columns:n,title:s,extraActions:i,onRowClick:l}){const[o,d]=u.useState(n.map(T=>T.key)),[f,p]=u.useState(!1),[h,y]=u.useState(!1),[g,b]=u.useState({open:!1,column:null,x:0,y:0}),v=u.useMemo(()=>n.map(T=>({...T,dataType:T.dataType||T.type||"string"})),[n]),S=Xj(e,{columns:v}),N=v.filter(T=>o.includes(T.key));u.useEffect(()=>{d(T=>{const k=v.map(L=>L.key),C=T.filter(L=>k.includes(L));return k.forEach(L=>{C.includes(L)||C.push(L)}),C.length===T.length&&C.every((L,z)=>L===T[z])?T:C})},[v]);const j=T=>{S.toggleSort(T.key)},E=(T,k)=>{T.preventDefault(),b({open:!0,column:k,x:T.clientX,y:T.clientY})};u.useEffect(()=>{if(!g.open)return;const T=()=>b({open:!1,column:null,x:0,y:0});return window.addEventListener("click",T),window.addEventListener("contextmenu",T),()=>{window.removeEventListener("click",T),window.removeEventListener("contextmenu",T)}},[g.open]);const A=T=>{S.setGroupBy(T.key),b({open:!1,column:null,x:0,y:0})},M=(T,k)=>{if(typeof k.render=="function")return k.render(T,S.getValue(T,k.key));const C=T[k.key];return C!==void 0?C:S.getValue(T,k.key)},_=S.groupBy?S.groups.some(T=>T.items.length>0):S.data.length>0;return t.jsxs("div",{className:"list-viewer",children:[t.jsxs("div",{className:"list-viewer-header",children:[t.jsx("h2",{children:s}),t.jsxs("div",{className:"list-controls",children:[i&&t.jsx("div",{className:"extra-actions",children:i}),t.jsx(xg,{value:S.searchTerm,onChange:S.setSearchTerm,placeholder:`Search ${s.toLowerCase()}...`}),t.jsxs("button",{type:"button",className:`btn secondary compact${S.filterActive?" is-active":""}`,onClick:()=>y(!0),children:[t.jsx(Ef,{size:16})," Filters"]}),t.jsxs("div",{className:"column-picker-wrapper",children:[t.jsx("button",{className:"icon-btn",title:"Column settings",onClick:()=>p(T=>!T),children:t.jsx(jj,{size:18})}),f&&t.jsx("div",{className:"column-picker-popover",children:t.jsx(qI,{columns:v,visibleCols:o,onChange:d,onClose:()=>p(!1)})})]})]})]}),_?t.jsx("div",{className:"list-viewer-table-wrapper",children:t.jsxs("table",{children:[t.jsx("thead",{children:t.jsx("tr",{children:N.map(T=>{const k=S.sortState.key===T.key,C=S.sortState.direction,L=S.groupBy===T.key;return t.jsx("th",{onClick:()=>j(T),onContextMenu:z=>E(z,T),className:"sortable-header",role:"button",tabIndex:0,children:t.jsxs("span",{className:"header-label",children:[T.label,k&&t.jsx("span",{className:"sort-indicator",children:C==="asc"?"":""}),L&&t.jsx("span",{className:"group-indicator",children:"Grouped"})]})},T.key)})})}),t.jsx("tbody",{children:S.groupBy?S.groups.map(T=>t.jsxs(u.Fragment,{children:[t.jsx("tr",{className:"group-header-row",children:t.jsxs("td",{colSpan:N.length,children:[t.jsx("button",{type:"button",className:"group-toggle",onClick:()=>S.toggleGroupCollapse(T.id),children:S.isGroupCollapsed(T.id)?t.jsx(xr,{size:14}):t.jsx(Ss,{size:14})}),t.jsxs("span",{className:"group-label",children:[T.label," ",t.jsxs("span",{className:"group-count",children:["(",T.items.length,")"]})]})]})}),!S.isGroupCollapsed(T.id)&&T.items.map(k=>t.jsx("tr",{onClick:()=>l&&l(k),className:l?"clickable-row":"",children:N.map(C=>t.jsx("td",{"data-column":C.label||C.key,children:M(k,C)},C.key))},k.id))]},T.id)):S.data.map(T=>t.jsx("tr",{onClick:()=>l&&l(T),className:l?"clickable-row":"",children:N.map(k=>t.jsx("td",{"data-column":k.label||k.key,children:M(T,k)},k.key))},T.id))})]})}):t.jsx("div",{className:"empty-state",children:t.jsx("p",{children:"No results found."})}),g.open&&g.column&&t.jsxs("div",{className:"column-context-menu",style:{top:g.y,left:g.x},role:"menu",children:[t.jsx("button",{type:"button",onClick:()=>A(g.column),children:S.groupBy===g.column.key?"Remove grouping":`Group by ${g.column.label}`}),S.groupBy&&S.groupBy!==g.column.key&&t.jsx("button",{type:"button",onClick:()=>A({key:""}),children:"Clear grouping"})]}),t.jsx(Zj,{open:h,onClose:()=>y(!1),fields:v.map(T=>({key:T.key,label:T.label,dataType:T.dataType})),value:S.filters,onApply:T=>{S.setFilters(T),y(!1)}})]})}const QI="modulepreload",JI=function(e){return"/"+e},kS={},ci=function(n,s,i){let l=Promise.resolve();if(s&&s.length>0){let p=function(h){return Promise.all(h.map(y=>Promise.resolve(y).then(g=>({status:"fulfilled",value:g}),g=>({status:"rejected",reason:g}))))};document.getElementsByTagName("link");const d=document.querySelector("meta[property=csp-nonce]"),f=d?.nonce||d?.getAttribute("nonce");l=p(s.map(h=>{if(h=JI(h),h in kS)return;kS[h]=!0;const y=h.endsWith(".css"),g=y?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${h}"]${g}`))return;const b=document.createElement("link");if(b.rel=y?"stylesheet":QI,y||(b.as="script"),b.crossOrigin="",b.href=h,f&&b.setAttribute("nonce",f),document.head.appendChild(b),y)return new Promise((v,S)=>{b.addEventListener("load",v),b.addEventListener("error",()=>S(new Error(`Unable to preload CSS for ${h}`)))})}))}function o(d){const f=new Event("vite:preloadError",{cancelable:!0});if(f.payload=d,window.dispatchEvent(f),!f.defaultPrevented)throw d}return l.then(d=>{for(const f of d||[])f.status==="rejected"&&o(f.reason);return n().catch(o)})};function Qj(e){if(!e&&e!==0)return null;if(typeof e=="object"&&e!==null){const s=e.value??e.id??e.key??e.slug??null;if(s==null)return null;const i=e.label??e.name??e.title??e.username??e.email??String(s);return{value:String(s),label:String(i),raw:e}}const n=String(e);return{value:n,label:n,raw:e}}function zs({selected:e=[],options:n=[],onChange:s,placeholder:i="Search and select...",disabled:l=!1,noOptionsMessage:o="No options available.",loading:d=!1,inputId:f}){const[p,h]=u.useState(""),[y,g]=u.useState(!1),b=u.useRef(null),v=u.useMemo(()=>{const C=n.map(z=>Qj(z)).filter(Boolean),L=new Set;return C.filter(z=>{const G=z.value;return L.has(G)?!1:(L.add(G),!0)})},[n]),S=u.useMemo(()=>{const C=new Set;return e.forEach(L=>{L!=null&&C.add(String(L))}),C},[e]),N=u.useMemo(()=>{const C=new Map(v.map(L=>[L.value,L]));return Array.from(S).map(L=>{const z=C.get(L);return z||{value:L,label:L}})},[v,S]),j=u.useMemo(()=>v.filter(C=>!S.has(C.value)),[v,S]),E=u.useMemo(()=>{if(!p)return j;const C=p.toLowerCase();return j.filter(L=>L.label.toLowerCase().includes(C))},[j,p]);u.useEffect(()=>{if(!y)return;const C=L=>{b.current&&(b.current.contains(L.target)||g(!1))};return document.addEventListener("mousedown",C),()=>document.removeEventListener("mousedown",C)},[y]);const A=C=>{if(l)return;const L=[],z=new Set;C.forEach(G=>{if(G==null)return;const U=String(G);z.has(U)||(z.add(U),L.push(U))}),s?.(L)},M=C=>{if(!C)return;const L=[...S,C.value];A(L),h(""),g(!1)},_=C=>{const L=String(C),z=Array.from(S).filter(G=>G!==L);A(z)},T=y&&!l,k=()=>d?"Loading options...":j.length===0?S.size>0?"All options selected.":o:"No matches found.";return t.jsxs("div",{className:`list-collector ${l?"disabled":""}`,ref:b,children:[t.jsxs("div",{className:"list-collector-input-wrapper",children:[t.jsx("input",{id:f,type:"text",className:"list-collector-input",value:p,placeholder:i,disabled:l,onFocus:()=>!l&&g(!0),onChange:C=>{h(C.target.value),y||g(!0)},onKeyDown:C=>{C.key==="Enter"&&E.length>0&&(C.preventDefault(),M(E[0])),C.key==="Escape"&&(g(!1),C.currentTarget.blur())}}),t.jsx("span",{className:"list-collector-icon","aria-hidden":"true",children:""})]}),T&&t.jsx("div",{className:"list-collector-dropdown",children:E.length>0?t.jsx("ul",{children:E.map(C=>t.jsx("li",{children:t.jsx("button",{type:"button",onMouseDown:L=>L.preventDefault(),onClick:()=>M(C),className:"list-collector-option",children:C.label})},C.value))}):t.jsx("div",{className:"list-collector-empty",children:k()})}),N.length>0&&t.jsx("div",{className:"list-collector-pills",children:N.map(C=>t.jsxs("span",{className:"list-collector-pill",children:[t.jsx("span",{className:"pill-label",children:C.label}),!l&&t.jsx("button",{type:"button",className:"pill-remove",onClick:()=>_(C.value),"aria-label":`Remove ${C.label}`,children:""})]},C.value))})]})}async function eL(e=5,n=200){for(let s=0;s<e;s++){const i=Vs();if(i)return i;await new Promise(l=>setTimeout(l,n))}return null}async function Gi(){const e=await eL();if(!e)throw new Error("Missing or invalid token");return{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}async function Wi(e,n="request"){if(e.status===401)throw console.warn(` Unauthorized during ${n}, clearing session`),localStorage.removeItem("gamedb_session"),window.location.reload(),new Error("Session expired or unauthorized");if(!e.ok){const s=await e.text();throw new Error(`Failed to ${n}: ${e.status} ${s}`)}return e.json()}async function ri(e={}){const n=new URLSearchParams;e.worldId&&n.append("worldId",e.worldId),e.parentId!==void 0&&e.parentId!==null&&n.append("parentId",e.parentId),e.locationTypeId&&n.append("locationTypeId",e.locationTypeId),e.includeEntities&&n.append("includeEntities",e.includeEntities),e.all&&n.append("all",e.all);const s=n.toString(),i=`/locations${s?`?${s}`:""}`;return kt.get(i)}async function tL(e={}){const n=new URLSearchParams;if(e.worldId&&n.append("worldId",e.worldId),e.query&&n.append("q",e.query),e.limit&&n.append("limit",e.limit),e.offset&&n.append("offset",e.offset),e.locationTypeIds){const l=Array.isArray(e.locationTypeIds)?e.locationTypeIds.join(","):e.locationTypeIds;n.append("locationTypeIds",l)}const s=n.toString(),i=`/locations/search${s?`?${s}`:""}`;return kt.get(i)}async function ni(e){return kt.get(`/locations/${e}`)}async function vg(e){const n=await Gi(),s=await fetch(`${sn}/locations/${e}/path`,{headers:n});return Wi(s,"fetch location path")}async function Sg(e){const n=await Gi(),s=await fetch(`${sn}/locations/${e}/entities`,{headers:n});return Wi(s,"fetch location entities")}async function wg(e){return kt.post("/locations",e)}async function Vl(e,n){return kt.patch(`/locations/${e}`,n)}async function Ng(e){const n=await Gi(),s=await fetch(`${sn}/locations/${e}`,{method:"DELETE",headers:n});return Wi(s,"delete location")}async function Jj(e,n){const s=await Gi(),i=await fetch(`${sn}/locations/${e}/entities`,{method:"POST",headers:s,body:JSON.stringify({entity_id:n})});return Wi(i,"add entity to location")}async function e1(e,n){const s=await Gi(),i=await fetch(`${sn}/locations/${e}/entities/${n}`,{method:"DELETE",headers:s});return Wi(i,"remove entity from location")}async function t1(e,n){const s=await Gi(),i=await fetch(`${sn}/locations/${e}/children`,{method:"POST",headers:s,body:JSON.stringify({child_location_id:n})});return Wi(i,"add child location")}async function n1(e,n){const s=await Gi(),i=await fetch(`${sn}/locations/${e}/children/${n}`,{method:"DELETE",headers:s});return Wi(i,"remove child location")}async function a1(e,n){return kt.put(`/locations/${e}/importance`,{importance:n})}const s1=(e,n={})=>{const s=new URLSearchParams,i=n.campaignId??n.campaign_id;i&&s.set("campaignId",i);const l=s.toString();return kt.get(`/locations/${e}/notes${l?`?${l}`:""}`)},r1=(e,n={})=>{const s=new URLSearchParams,i=n.campaignId??n.campaign_id;i&&s.set("campaignId",i);const l=s.toString();return kt.get(`/locations/${e}/mention-notes${l?`?${l}`:""}`)},i1=(e,n={})=>{const s=new URLSearchParams,i=n.campaignId??n.campaign_id;i&&s.set("campaignId",i);const l=s.toString();return kt.get(`/locations/${e}/mentions/session-notes${l?`?${l}`:""}`)},l1=(e,n)=>kt.post(`/locations/${e}/notes`,n),jg=(e,n,s)=>kt.put(`/locations/${e}/notes/${n}`,s),Eg=(e,n,s={})=>{const i=new URLSearchParams,l=s.campaignId??s.campaign_id;l&&i.set("campaignId",l);const o=i.toString();return kt.delete(`/locations/${e}/notes/${n}${o?`?${o}`:""}`)},o1=Object.freeze(Object.defineProperty({__proto__:null,addChildLocation:t1,addEntityToLocation:Jj,createLocation:wg,createLocationNote:l1,deleteLocation:Ng,deleteLocationNote:Eg,fetchLocationById:ni,fetchLocationEntities:Sg,fetchLocationMentionNotes:r1,fetchLocationMentionSessionNotes:i1,fetchLocationNotes:s1,fetchLocationPath:vg,fetchLocations:ri,removeChildLocation:n1,removeEntityFromLocation:e1,searchLocations:tL,updateLocation:Vl,updateLocationImportance:a1,updateLocationNote:jg},Symbol.toStringTag,{value:"Module"})),nL=Object.freeze([]),dr=e=>e?e.name||e.label||e.title||e.display||e.displayName||e.text||String(e.id||""):"";function c1({worldId:e,label:n,value:s,onChange:i,allowedTypeIds:l,disabled:o=!1,placeholder:d="Search locations",staticOptions:f,minSearchLength:p=0,onResolved:h,required:y=!1}){const[g,b]=u.useState(""),[v,S]=u.useState([]),[N,j]=u.useState(!1),[E,A]=u.useState(!1),[M,_]=u.useState(null),[T,k]=u.useState(""),[C,L]=u.useState([]),z=u.useRef(null);u.useRef(null);const G=u.useRef(h),U=l!==void 0,X=u.useMemo(()=>Array.isArray(l)?[...l]:[],[JSON.stringify(l)]),V=Array.isArray(f)?f:nL,R=u.useMemo(()=>Array.isArray(V)?V.map(W=>{if(!W)return null;if(typeof W=="object"){const le=W.id??W.value??W.key??W.slug??null,K=dr(W);return le==null?null:{id:String(le),name:K||String(le)}}return null}).filter(Boolean):[],[V]);u.useEffect(()=>{if(!e||o){L([]);return}let W=!1;return(async()=>{try{const le=await ri({worldId:e,all:"true"});if(W)return;const K=Array.isArray(le?.data)?le.data:le,de=Array.isArray(K)?K:[];L(de)}catch{W||L([])}})(),()=>{W=!0}},[e,o,JSON.stringify(X)]);const B=u.useMemo(()=>{if(U){if(X.length===0)return[];const W=new Set(X.map(K=>String(K)));return C.filter(K=>{const de=K.location_type_id||K.locationTypeId||K.locationType?.id||"",Q=String(de);return W.has(Q)})}return C},[C,X,U]),D=u.useMemo(()=>{if(!g.trim()||g.length<p)return B;const W=g.toLowerCase().trim();return B.filter(le=>dr(le).toLowerCase().includes(W))},[B,g,p]);u.useEffect(()=>{if(!s){_(null),b(""),G.current?.(null);return}if(typeof s=="object"&&s.id){const Q=dr(s);(!M||M.id!==s.id)&&(_(s),b(Q),G.current?.(s));return}if(typeof s!="string")return;const W=s;if(M?.id===W)return;const le=R.find(Q=>String(Q.id)===String(W));if(le){_(le),b(dr(le)),G.current?.(le);return}const K=C.find(Q=>String(Q.id)===String(W));if(K){_(K),b(dr(K)),G.current?.(K);return}let de=!1;return(async()=>{try{const Q=await ni(W);if(de)return;const he=Q?.data||Q;if(he?.id){_(he),b(dr(he)),G.current?.(he);return}}catch{}de||(_({id:W,name:W}),b(W))})(),()=>{de=!0}},[s,R,M?.id,C]),u.useEffect(()=>{G.current=h},[h]),u.useEffect(()=>{E&&S(D)},[E,D]);const O=u.useMemo(()=>{if(!R.length)return[];if(!g.trim()||g.length<p)return R;const W=g.trim().toLowerCase();return R.filter(le=>dr(le).toLowerCase().includes(W))},[R,g,p]),$=u.useMemo(()=>{const W=new Map,le=[];return O.forEach(K=>{const de=K?.id;if(de==null)return;const Q=String(de);W.has(Q)||(W.set(Q,!0),le.push(K))}),v.forEach(K=>{const de=K?.id;if(de==null)return;const Q=String(de);W.has(Q)||(W.set(Q,!0),le.push(K))}),le},[O,v]),F=W=>{W&&(_(W),b(dr(W)),A(!1),S([]),k(""),i?.(W))},H=()=>{_(null),b(""),S([]),k(""),A(!1),i?.(null)},I=E&&$.length>0,Y=E&&!N&&!$.length&&g.trim().length>=p&&!M&&e,P=o||!e;return t.jsxs("div",{className:"entity-search-select",ref:z,children:[n&&t.jsx("label",{children:n}),t.jsxs("div",{className:"entity-search-wrapper",children:[t.jsx("input",{type:"text",value:g,required:y,onChange:W=>{const le=W.target.value;b(le),_(null),o||A(!0)},onFocus:()=>{o||A(!0)},disabled:P,placeholder:d,className:"entity-search-input"}),M&&!o&&t.jsx("button",{type:"button",className:"clear-btn",onClick:W=>{W.stopPropagation(),H()},title:"Clear selection","aria-label":"Clear selection",children:""})]}),T&&t.jsx("div",{className:"small text-warning",role:"alert",children:T}),I&&t.jsx("ul",{className:"entity-results",role:"listbox",children:$.map(W=>{const le=W?.id??W?.value??"",K=dr(W),de=M?.id===le;return t.jsxs("li",{role:"option","aria-selected":de,className:de?"selected":"",onMouseDown:Q=>{Q.preventDefault()},onClick:()=>F(W),children:[K,W.locationType&&t.jsxs("span",{className:"entity-search-result-meta",children:[" ","(",W.locationType.name,")"]})]},le)})}),Y&&t.jsx("div",{className:"small text-muted",style:{marginTop:"0.25rem"},children:"No locations found"}),N&&E&&t.jsx("div",{className:"small text-muted",children:"Loading locations"})]})}const aL=e=>e===null?"null":e===void 0?"undefined":Array.isArray(e)?"array":e instanceof Date?"date":typeof e,Of=(e,n,s={})=>{const i=(o,d,f,p="<<anonymous>>")=>{const h=d[f];return h==null?(o&&console.warn(`[PropTypes] Prop "${f}" is marked as required in "${p}", but its value is ${String(h)}.`),null):e(h,d,f,p)?(s.afterValidate&&s.afterValidate(h,d,f,p),null):(console.warn(`[PropTypes] Invalid prop "${f}" supplied to "${p}". Expected ${n}, but received ${aL(h)}.`),null)},l=i.bind(null,!1);return l.isRequired=i.bind(null,!0),l._validate=o=>o==null||e(o),l._expectedDescription=n,l},cd=e=>Of(n=>typeof n===e,e),sL=()=>Of(e=>e!==null&&typeof e=="object"&&!Array.isArray(e)&&!(e instanceof Date),"object"),rL=e=>{const n=o=>Array.isArray(o)?!e||typeof e!="function"?!0:o.every(d=>e._validate?e._validate(d):!0):!1,s=(o,d,f,p)=>{Array.isArray(o)&&(!e||typeof e!="function"||o.forEach((h,y)=>{try{e({[`${f}[${y}]`]:h},`${f}[${y}]`,p)}catch{}}))},i=`an array of ${e?._expectedDescription??"the specified type"}`,l=Of(n,i,{afterValidate:s});return l._validate=o=>o==null?!0:Array.isArray(o)?o.every(d=>e&&e._validate?e._validate(d):!0):!1,l},iL=e=>{const n=Array.isArray(e)?e.filter(Boolean):[],s=o=>n.some(d=>d&&typeof d._validate=="function"?d._validate(o):!0),i=n.map(o=>o?._expectedDescription).filter(Boolean),l=i.length>0?i.join(", "):"one of the specified types";return Of(s,l)},It={string:cd("string"),number:cd("number"),bool:cd("boolean"),func:cd("function"),object:sL(),arrayOf:e=>rL(e),oneOfType:e=>iL(e)},ii=e=>e?Array.isArray(e)?e:Array.isArray(e.data)?e.data:[]:[],Ey=e=>{if(e==null)return null;if(typeof e=="string"){const n=e.trim();return n?n.toLowerCase():null}if(typeof e=="number")return String(e);if(typeof e=="object"){if(Array.isArray(e)){for(const n of e){const s=Ey(n);if(s)return s}return null}return Ey(e.fieldKey??e.field_key??e.key??e.name??e.id)??null}return null},Mn=(e,n)=>{const s=Ey(n);s&&e.add(s)},lL=e=>{if(!e||typeof e!="object")return[];const n=new Set;return Mn(n,e.id),Mn(n,e.field_id),Mn(n,e.entity_type_field_id),Mn(n,e.fieldId),Mn(n,e.name),Mn(n,e.key),Mn(n,e.field),Mn(n,e.metadataField),Mn(n,e.metadata_field),e?.sourceField&&Mn(n,e.sourceField),e?.source_field&&Mn(n,e.source_field),Array.from(n)},oL=e=>Array.isArray(e)?e.map((n,s)=>{if(!n||typeof n!="object")return null;const i=new Set;if(Mn(i,n.fieldKey),Mn(i,n.field_key),Mn(i,n.field),Mn(i,n.fieldName),Mn(i,n.field_name),Mn(i,n.fieldId),Mn(i,n.field_id),Mn(i,n.target),Mn(i,n.targetField),Mn(i,n.target_field),Mn(i,n.metadataField),Mn(i,n.metadata_field),Mn(i,n.entity_type_field_id),Mn(i,n.name),Mn(i,n.key),n.field&&typeof n.field=="object"&&(Mn(i,n.field.id),Mn(i,n.field.name),Mn(i,n.field.key)),!i.size)return null;const l=(y,g=0)=>{if(y==null||y==="")return g;const b=Number(y);return Number.isFinite(b)?b:g},o=l(n.sectionOrder??n.section_order??n.sectionIndex??n.section_index,0),d=l(n.column??n.columnOrder??n.column_index??n.columnIndex,0),f=l(n.fieldOrder??n.field_order??n.order??n.order_index??n.position??n.sortOrder??n.sort_order,s),p=l(n.priority??n.weight??n.rank,s),h=o*1e6+d*1e4+f*100+p;return{identifiers:Array.from(i),rank:h,sectionOrder:o,columnOrder:d,fieldPosition:f,priority:p}}).filter(Boolean):[],_g=(e=[],n=[])=>{if(!Array.isArray(e)||e.length===0)return[];const s=oL(n),i=new Map;s.length>0&&s.forEach(d=>{d.identifiers.forEach(f=>{i.has(f)||i.set(f,d.rank)})});const l=(d,f)=>{if(d==null||d==="")return f;const p=Number(d);return Number.isFinite(p)?p:f},o=e.map((d,f)=>{const p=lL(d);let h=Number.POSITIVE_INFINITY;p.forEach(g=>{if(!g)return;const b=i.get(g);b!==void 0&&b<h&&(h=b)});const y=l(d?.sortOrder??d?.sort_order,f);return{field:d,rank:h,fallbackSort:y,index:f}});return o.sort((d,f)=>{const p=Number.isFinite(d.rank),h=Number.isFinite(f.rank);return p&&h&&d.rank!==f.rank?d.rank-f.rank:p&&!h?-1:!p&&h?1:d.fallbackSort!==f.fallbackSort?d.fallbackSort-f.fallbackSort:d.index-f.index}),o.map(d=>d.field)},Cg=e=>!!e&&typeof e=="object"&&!Array.isArray(e),cL=e=>Array.isArray(e)?e:e==null?[]:[e],As=e=>e==null?null:typeof e=="string"?e.trim()||null:typeof e=="number"?String(e):Cg(e)?As(e.field??e.fieldKey??e.field_name??e.source??e.sourceField??e.source_field??e.key??e.name??e.target??e.targetField??e.target_field??e.metadataField??e.metadata_field??e.id)??null:null,uL=e=>{if(!e||typeof e!="object")return null;const n=l=>l==null?null:String(l).trim()||null,s=n(e.key??e.name??e.field);if(s&&s.startsWith("metadata."))return s;const i=n(e.metadataField??e.metadata_field)||(s&&!s.includes(".")?s:null)||n(e.name);return i?i.startsWith("metadata.")?i:`metadata.${i}`:s},dL=(e=[])=>{const n=new Map,s=(i,l)=>{if(!i||!l)return;const o=As(i),d=As(l);!o||!d||(n.set(o,d),n.set(o.toLowerCase(),d))};return e.forEach(i=>{if(!i||typeof i!="object")return;const l=uL(i);if(!l)return;s(l,l),[i.id,i.field_id,i.fieldId,i.entity_type_field_id,i.field,i.name,i.key,i.metadataField,i.metadata_field,i.fieldKey,i.field_key,i.target,i.targetField,i.target_field,i.source,i.sourceField,i.source_field].forEach(d=>s(d,l))}),n},fL={eq:"equals","=":"equals","==":"equals","===":"equals",equals:"equals",equal:"equals",match:"equals",matches:"equals",ne:"not_equals","!=":"not_equals","!==":"not_equals",not:"not_equals",notequals:"not_equals",not_equals:"not_equals",different:"not_equals",contains:"contains",includes:"contains",has:"contains",not_contains:"not_contains",excludes:"not_contains",notincludes:"not_contains",in:"in",any:"in",within:"in",not_in:"not_in",none:"not_in",outside:"not_in",gt:"gt",greater:"gt",greater_than:"gt",gte:"gte",ge:"gte",greater_or_equal:"gte",lt:"lt",less:"lt",less_than:"lt",lte:"lte",le:"lte",less_or_equal:"lte",is_set:"is_set",isset:"is_set",set:"is_set",exists:"is_set",present:"is_set",is_not_set:"is_not_set",notset:"is_not_set",missing:"is_not_set",empty:"is_empty",is_empty:"is_empty",not_empty:"is_not_empty",filled:"is_not_empty",truthy:"truthy",falsy:"falsy"},mL=e=>{if(e==null)return"equals";const n=String(e).trim().toLowerCase();return fL[n]??"equals"},hL={all:"all",every:"all",and:"all",any:"any",some:"any",or:"any",either:"any",none:"none",not:"none"},pL=e=>{if(e==null)return"all";const n=String(e).trim().toLowerCase();return hL[n]??"all"},yL={show:"show",display:"show",reveal:"show",visible:"show",enable:"show",hide:"hide",remove:"hide",conceal:"hide",hidden:"hide",disable:"hide",require:"require",required:"require",mandatory:"require",optional:"optional",option:"optional",allow:"optional"},gL=e=>{if(e==null)return null;const n=String(e).trim().toLowerCase();return yL[n]??null},RS=(e,n=0)=>{if(!e)return null;if(!Cg(e)){if(typeof e=="string"){const[d,...f]=e.split("="),p=As(d);if(!p)return null;const h=f.join("=").trim();return{field:p,operator:"equals",values:h?[h]:[]}}return null}const s=As(e.field??e.fieldKey??e.field_name??e.source??e.sourceField??e.source_field??e.input??e.left??e.property??e.key??e.name);if(!s)return null;const i=mL(e.operator??e.comparator??e.condition??e.type),l=e.values??e.value??e.match??e.compareTo??e.matchValue??e.expected,o=cL(l).filter(d=>d!==void 0);return{field:s,operator:i,values:o,id:e.id??`condition-${n}`}},bL=e=>{const n=["conditions","criteria","when","rules","predicates","matchers"];for(const i of n)if(Array.isArray(e?.[i]))return e[i].map((l,o)=>RS(l,o)).filter(Boolean);const s=RS(e,0);return s?[s]:[]},up=(e,n=0)=>{if(!e||!Cg(e)&&typeof e!="string")return null;if(typeof e=="string"){const l=As(e);return l?{target:l,action:"show",id:`action-${n}`}:null}const s=As(e.target??e.targetField??e.target_field??e.field??e.fieldKey??e.field_name??e.path??e.name??e.key??e.metadataField??e.metadata_field),i=gL(e.action??e.type??e.behavior??e.behaviour??e.effect??e.command);return!s||!i?null:{target:s,action:i,id:e.id??`action-${n}`}},xL=e=>{const n=["actions","effects","apply","then","responses"];for(const i of n)if(Array.isArray(e?.[i]))return e[i].map((l,o)=>up(l,o)).filter(Boolean);if(Array.isArray(e?.targets)&&e.targets.length>0)return e.targets.map((i,l)=>up({target:i,action:e.action??e.effect??e.behavior??e.behaviour},l)).filter(Boolean);const s=e.target??e.targetField??e.target_field??e.actionTarget??e.fieldTarget??e.metadataField??e.metadata_field;return s&&(e.action||e.effect||e.behavior||e.behaviour)?[up({target:s,action:e.action??e.effect??e.behavior??e.behaviour})].filter(Boolean):[]},_y=e=>{if(e==null)return"";if(typeof e=="number"&&Number.isFinite(e))return String(e);if(typeof e=="boolean")return e?"true":"false";if(e instanceof Date)return String(e.getTime());if(typeof e=="string")return e.trim().toLowerCase();if(Array.isArray(e))return e.map(n=>_y(n));if(typeof e=="object")try{return JSON.stringify(e)}catch{return String(e)}return String(e)},vs=(e,n)=>{if(Array.isArray(e))return e.some(d=>vs(d,n));if(Array.isArray(n))return n.some(d=>vs(e,d));const s=Number(e),i=Number(n);if(!Number.isNaN(s)&&!Number.isNaN(i))return s===i;const l=_y(e),o=_y(n);return l===o},Cl=e=>e==null?!1:typeof e=="string"?e.trim().length>0:Array.isArray(e)?e.length>0:e instanceof Date?!0:typeof e=="object"?Object.keys(e).length>0:!0,vL=(e,n)=>{if(n==null)return;let s=n;if(typeof s!="string"){const l=As(s);if(!l)return;s=l}if(!s)return;const i=s.replace(/\[(.*?)\]/g,(l,o)=>`.${o.replace(/^['"]|['"]$/g,"")}`).split(".").map(l=>l.trim()).filter(l=>l.length>0);if(i.length)return i.reduce((l,o)=>{if(l!=null)return o==="*"?l:l[o]},e)},dp=(e,n)=>{if(!e)return!1;const{field:s,operator:i,values:l=[]}=e,o=vL(n,s);switch(i){case"equals":return l.length?l.some(d=>vs(o,d)):!1;case"not_equals":return l.length?l.every(d=>!vs(o,d)):Cl(o);case"contains":return Array.isArray(o)?o.some(d=>l.some(f=>vs(d,f))):typeof o=="string"?l.some(d=>d==null?!1:o.toLowerCase().includes(String(d).toLowerCase())):!1;case"not_contains":return Array.isArray(o)?o.every(d=>l.every(f=>!vs(d,f))):typeof o=="string"?l.every(d=>d==null?!0:!o.toLowerCase().includes(String(d).toLowerCase())):!0;case"in":return l.length?Array.isArray(o)?o.some(d=>l.some(f=>vs(d,f))):l.some(d=>vs(o,d)):!1;case"not_in":return l.length?Array.isArray(o)?o.every(d=>l.every(f=>!vs(d,f))):l.every(d=>!vs(o,d)):!0;case"gt":case"gte":case"lt":case"lte":{const d=Number(o);if(Number.isNaN(d))return!1;const f=l.find(h=>h!=null),p=Number(f);return Number.isNaN(p)?!1:i==="gt"?d>p:i==="gte"?d>=p:i==="lt"?d<p:d<=p}case"is_set":return Cl(o);case"is_not_set":return!Cl(o);case"is_empty":return!Cl(o);case"is_not_empty":return Cl(o);case"truthy":return!!o;case"falsy":return!o;default:return l.length?l.some(d=>vs(o,d)):Cl(o)}},SL=(e,n)=>{const s=Array.isArray(e?.conditions)?e.conditions:[];if(s.length===0)return!0;switch(e?.matchMode){case"any":return s.some(i=>dp(i,n));case"none":return!s.some(i=>dp(i,n));case"all":default:return s.every(i=>dp(i,n))}},Ag=(e=[],n=[])=>{if(!Array.isArray(e))return[];const s=dL(n),i=o=>{const d=As(o);if(!d)return typeof o=="string"?o:null;if(s.size>0){const f=s.get(d)||s.get(d.toLowerCase());if(f)return f}return d},l=e.map((o,d)=>{if(!o||typeof o!="object"||o.disabled||o.enabled===!1)return null;const f=Array.isArray(o.conditions)&&Array.isArray(o.actions)&&o.conditions.every(S=>S?.field&&S?.operator)&&o.actions.every(S=>S?.target&&S?.action),p=f?o.conditions.map(S=>({...S})):bL(o),h=f?o.actions.map(S=>({...S})):xL(o);if(!p.length||!h.length)return null;const y=p.map(S=>{const N=i(S?.field);return N?{...S,field:N}:null}).filter(Boolean),g=h.map(S=>{const N=i(S?.target);return N?{...S,target:N}:null}).filter(Boolean);if(!y.length||!g.length)return null;const b=o.priority??o.order??o.sort??o.rank??d,v=Number.isFinite(Number(b))?Number(b):d;return{id:o.id??`field-rule-${d}`,name:o.name??o.label??"",matchMode:pL(o.matchMode??o.match_mode??o.matchType??o.logic??o.condition),conditions:y,actions:g,priority:v}}).filter(Boolean);return l.sort((o,d)=>o.priority-d.priority),l},Tg=(e,n={})=>{const s=Array.isArray(e)?e:[],i=n&&typeof n=="object"?n:{},l={},o=new Set;return s.forEach(d=>{!d||!SL(d,i)||d.actions.forEach(p=>{if(!p?.target||!p?.action)return;const h=p.target,y=As(h)?.toLowerCase()??null;l[h]=p.action,y&&l[y]===void 0&&(l[y]=p.action),p.action==="show"?(o.add(h),y&&o.add(y)):p.action==="hide"&&(o.delete(h),y&&o.delete(y))})}),{actionsByField:l,showRuleTargets:o}},Rc=(e,n,s=new Set,i=!0)=>{if(!e)return!1;const l=typeof n=="string"?n.toLowerCase():"",o=As(e)?.toLowerCase()??null;return s instanceof Set&&(s.has(e)||(o?s.has(o):!1))||l==="show"?!1:l==="hide"||l==="hidden"||i===!1},Mg=e=>{if(!e)return"";const n=new Date(e);return Number.isNaN(n.getTime())?typeof e=="string"?e:String(e):n.toLocaleString()},wL=e=>{const n=e?.value;if(n==null)return"";switch(e?.dataType){case"boolean":return!!n;case"number":{const s=Number(n);return Number.isNaN(s)?n:s}case"enum":return typeof n=="object"&&n!==null?n.value??n.id??n.key??n.slug??n.name??"":n;case"date":return Mg(n);case"entity_reference":case"location_reference":case"reference":if(typeof n=="object"&&n!==null){const s=n.label??n.name??n.title??n.display??n.displayName??n.text??n.value??n.id;if(s==null)try{return JSON.stringify(n,null,2)}catch(i){return console.warn(" Failed to serialise reference metadata field",i),String(n)}return String(s)}return n;case"text":if(typeof n=="object")try{return JSON.stringify(n,null,2)}catch(s){return console.warn(" Failed to serialise text metadata field",s),String(n)}return n;default:if(typeof n=="object")try{return JSON.stringify(n,null,2)}catch(s){return console.warn(" Failed to serialise metadata field",s),String(n)}return n}},NL=e=>{const n=e?.value;return n==null?e?.dataType==="boolean"?!1:"":e?.dataType==="boolean"?!!n:(e?.dataType==="reference"||e?.dataType==="entity_reference"||e?.dataType==="location_reference")&&typeof n=="object"&&n!==null?n.value??n.id??n.key??n.slug??n.uuid??"":n},kg=(e=[])=>!Array.isArray(e)||e.length===0?{}:e.reduce((n,s)=>(s?.name&&(n[s.name]=wL(s)),n),{}),u1=(e=[])=>!Array.isArray(e)||e.length===0?{}:e.reduce((n,s)=>(s?.name&&(n[s.name]=NL(s)),n),{}),d1=(e=[])=>!Array.isArray(e)||e.length===0?{}:e.reduce((n,s)=>{if(!s?.name)return n;const i=s.dataType||s.data_type;if(i!=="reference"&&i!=="entity_reference"&&i!=="location_reference")return n;const l=(()=>{if(s.displayValue)return s.displayValue;if(s.display)return s.display;if(s.selectedLabel)return s.selectedLabel;const o=s.value;return o&&typeof o=="object"?o.displayValue??o.label??o.name??o.title??o.display??o.displayName??o.text??o.value??o.id??null:null})();return l==null||(n[s.name]=String(l)),n},{}),Rg=e=>{if(e==null||e==="")return null;if(typeof e=="string"){const n=e.trim();return n.length>0?n:null}if(typeof e=="number"||typeof e=="bigint")return String(e);if(typeof e=="object"&&!Array.isArray(e)){const n=e.id??e.value??e.entity_id??e.entityId??e.key??e.slug??e.uuid??null;if(n!=null){const s=String(n).trim();return s.length>0?s:null}return null}if(Array.isArray(e)){for(const n of e){const s=Rg(n);if(s)return s}return null}return null},Ig=e=>{if(e==null)return null;if(typeof e=="object"&&!Array.isArray(e)){const n=e.displayValue??e.display??e.label??e.name??e.title??e.displayName??e.text??null;if(n!=null){const s=String(n).trim();return s.length>0?s:null}return null}if(Array.isArray(e)){for(const n of e){const s=Ig(n);if(s)return s}return null}return null},IS=450,fp="preparing-open",f1=e=>{if(e==null)return"";if(Array.isArray(e)){const n=e.map(s=>s==null?null:typeof s=="object"?s.label||s.name||s.title||s.value||s.id||null:String(s)).filter(Boolean);return n.length>0?n.join(", "):""}if(typeof e=="object")try{return JSON.stringify(e,null,2)}catch(n){return console.warn(" Failed to serialise metadata value",n),String(e)}return typeof e=="boolean"?e?"Yes":"No":e===""?"":String(e)},LS=e=>{if(!e||typeof e!="object")return null;const n=e.displayValue??e.label??e.name??e.title??e.display??e.displayName??e.text??e.value??e.id;return n==null?null:String(n)},jL=e=>{if(!e)return"";const{dataType:n,value:s}=e;if(s==null)return n==="boolean"?"No":"";switch(n){case"boolean":return s?"Yes":"No";case"number":{const i=Number(s);return Number.isNaN(i)?String(s):String(i)}case"enum":return typeof s=="object"&&s!==null?s.label||s.name||s.title||s.value||s.id||"":String(s);case"entity_reference":case"location_reference":case"reference":{if(Array.isArray(s)){const i=s.map(o=>o==null?null:typeof o=="object"?LS(o)||null:String(o)).filter(Boolean);if(i.length>0)return i.join(", ");const l=e.displayValue||e.display||e.selectedLabel||e.referenceName||e.referenceLabel;return l?String(l):""}if(typeof s=="object"&&s!==null){const i=LS(s);if(i)return i;try{return JSON.stringify(s,null,2)}catch(l){return console.warn(" Failed to serialise reference metadata value",l),String(s)}}if(s==="")return"";if(e.displayValue||e.display||e.selectedLabel){const i=e.displayValue||e.display||e.selectedLabel;return i?String(i):""}return String(s)}case"date":return Mg(s);case"text":default:return f1(s)}},EL=(e,n)=>{if(!e)return[];const s=Array.isArray(e.fields)?e.fields:[];if(s.length>0)return _g(s,n).filter(o=>o?.name||o?.label).map((o,d)=>{const f=o.name||o.label||`field-${d}`,p=o.label||o.name||`Field ${d+1}`,h=o?.name?`metadata.${o.name}`:o?.key||f,y=o.visibleByDefault!==void 0?!!o.visibleByDefault:o.visible_by_default!==void 0?!!o.visible_by_default:!0;return{key:f,label:p,value:jL(o),fieldKey:h,visibleByDefault:y}});const i=e.metadata&&typeof e.metadata=="object"&&e.metadata||e.meta&&typeof e.meta=="object"&&e.meta||null;return i?Object.entries(i).map(([l,o])=>({key:l,label:l,value:f1(o),fieldKey:l&&`metadata.${l}`,visibleByDefault:!0})):[]},_L=e=>{if(!e)return{};if(Array.isArray(e.fields)&&e.fields.length>0)return kg(e.fields);const n=e.metadata&&typeof e.metadata=="object"&&e.metadata||e.meta&&typeof e.meta=="object"&&e.meta||null;return n?{...n}:{}};function Lg({entity:e,entityId:n,onClose:s,isLoading:i=!1,error:l="",fallbackName:o="",fieldOrder:d=[],fieldRules:f=[]}){const p=_n(),[h,y]=u.useState(()=>n?{entity:e,entityId:n,isLoading:i,error:l,fallbackName:o}:null),[g,b]=u.useState(n?"open":"closed"),v=u.useRef(null),S=u.useRef(null);u.useEffect(()=>()=>{S.current&&(clearTimeout(S.current),S.current=null)},[]),u.useEffect(()=>{if(n&&v.current?.entityId===n&&(v.current={entity:e,entityId:n,isLoading:i,error:l,fallbackName:o}),n){if(!h){y({entity:e,entityId:n,isLoading:i,error:l,fallbackName:o}),b(fp);return}if(h.entityId===n){y(I=>!I||I.entity===e&&I.isLoading===i&&I.error===l&&I.fallbackName===(o||I.fallbackName||"")?I:{...I,entity:e,isLoading:i,error:l,fallbackName:o||I.fallbackName||""}),g==="closing"&&S.current?(clearTimeout(S.current),S.current=null,v.current=null,b("opening")):g==="closed"&&b(fp);return}v.current={entity:e,entityId:n,isLoading:i,error:l,fallbackName:o},g!=="closing"&&b("closing"),S.current||(S.current=setTimeout(()=>{y(v.current),v.current=null,b("opening"),S.current=null},IS));return}h&&(g!=="closing"&&b("closing"),S.current||(v.current=null,S.current=setTimeout(()=>{y(null),b("closed"),S.current=null},IS)))},[e,n,i,l,o,h,g]),u.useEffect(()=>{if(g!==fp)return;const I=requestAnimationFrame(()=>{b("opening")});return()=>cancelAnimationFrame(I)},[g]),u.useEffect(()=>{if(g!=="opening")return;const I=requestAnimationFrame(()=>{b("open")});return()=>cancelAnimationFrame(I)},[g]);const N=!!h,j=g==="closing",E=h?.entity,A=h?.entityId,M=h?.isLoading??!1,_=h?.error??"",T=h?.fallbackName,k=E?.fields,C=u.useMemo(()=>Ag(f,k),[f,k]),L=u.useMemo(()=>_L(E),[E]),z=u.useMemo(()=>({metadata:L}),[L]),G=u.useMemo(()=>Tg(C,z),[C,z]),U=u.useMemo(()=>EL(E,d),[E,d]),X=u.useMemo(()=>{if(!U.length)return[];const I=G?.actionsByField??{},Y=G?.showRuleTargets??new Set;return U.filter(P=>{if(!P?.fieldKey)return!0;const W=I[P.fieldKey],le=P.visibleByDefault!==void 0?!!P.visibleByDefault:P.visible_by_default!==void 0?!!P.visible_by_default:!0;return!Rc(P.fieldKey,W,Y,le)})},[U,G]),V=X.length>0,R=E?.name||T||(M?"Loading entity":"Unknown entity"),B=E?.type?.name||E?.typeName||"Entity",D=u.useMemo(()=>ao(E),[E]);if(!N)return null;const $=["entity-info-drawer-wrapper",g==="open"?"entity-info-drawer-wrapper--open":"",g==="opening"?"entity-info-drawer-wrapper--opening":"",j?"entity-info-drawer-wrapper--closing":""].filter(Boolean).join(" "),F=()=>{A&&p(`/entities/${A}`)},H=!!A&&!M&&!_;return t.jsxs("div",{className:$,role:"presentation",children:[t.jsx("div",{className:"entity-info-drawer__overlay",onClick:s,role:"presentation"}),t.jsxs("aside",{className:"entity-info-drawer",role:"complementary","aria-label":"Entity details",children:[t.jsxs("header",{className:"entity-info-drawer__header",children:[t.jsxs("div",{className:"entity-info-drawer__header-top",children:[t.jsx("p",{className:"entity-info-drawer__type",title:B,children:B}),t.jsxs("div",{className:"entity-info-drawer__actions",children:[t.jsx("button",{type:"button",className:"entity-info-drawer__link",onClick:F,disabled:!H,children:"Go to Record"}),t.jsx("button",{type:"button",className:"entity-info-drawer__close",onClick:s,"aria-label":"Close entity details",children:""})]})]}),t.jsx("h2",{className:"entity-info-drawer__title",title:R,children:R})]}),D&&!M&&!_?t.jsx("div",{className:"entity-info-drawer__image",children:t.jsx("img",{src:D,alt:`Portrait of ${R}`,loading:"lazy"})}):null,E?.summary&&!M&&!_&&t.jsx("p",{className:"entity-info-drawer__summary",children:E.summary}),!E?.summary&&E?.description&&!M&&!_&&t.jsx("p",{className:"entity-info-drawer__summary",children:E.description}),M&&t.jsx("p",{className:"entity-info-drawer__status","aria-live":"polite",children:"Loading entity information"}),!!_&&!M&&t.jsx("p",{className:"entity-info-drawer__status entity-info-drawer__status--error","aria-live":"assertive",children:_}),!M&&!_&&V&&t.jsx("dl",{className:"entity-info-drawer__metadata",children:X.map(I=>t.jsxs("div",{className:"entity-info-drawer__metadata-item",children:[t.jsx("dt",{children:I.label}),t.jsx("dd",{children:I.value})]},I.key))}),!M&&!_&&!V&&t.jsx("p",{className:"entity-info-drawer__status",children:"No additional metadata available."})]})]})}Lg.propTypes={entityId:It.string,onClose:It.func.isRequired,isLoading:It.bool,error:It.string,fallbackName:It.string,fieldOrder:It.arrayOf(It.object),fieldRules:It.arrayOf(It.object)};function Na({entityId:e,entityName:n="entity",className:s=""}){const[i,l]=u.useState(!1),[o,d]=u.useState(!1),[f,p]=u.useState(null),[h,y]=u.useState(""),[g,b]=u.useState([]),[v,S]=u.useState([]),N=u.useRef(null),j=u.useMemo(()=>e==null?null:String(e),[e]);u.useEffect(()=>(N.current||(N.current=document.createElement("div"),document.body.appendChild(N.current)),()=>{N.current&&N.current.parentNode&&(N.current.parentNode.removeChild(N.current),N.current=null)}),[]);const E=u.useCallback(()=>{l(!1),y(""),p(null),d(!1)},[]),A=T=>{if(T.preventDefault(),T.stopPropagation(),e==null)return;const k=typeof n=="string"?n.trim():"";j&&k&&p(C=>C&&C.id===j?C.name||!k?C:{...C,name:k}:{id:j,name:k}),l(!0)};u.useEffect(()=>{if(!j)return;const T=typeof n=="string"?n.trim():"";T&&p(k=>!k||k.id!==j||k.name===T||k.name&&k.name!==T?k:{...k,name:T})},[j,n]),u.useEffect(()=>{if(!i||!j)return;let T=!1;return(async()=>{d(!0),y("");try{const C=await Hs(j);if(T)return;const L=Ya(C);if(!L){p(null),y("Entity not found");return}p(L)}catch(C){if(T)return;console.error(" Failed to load entity preview",C),p(null),y(C.message||"Failed to load entity information")}finally{T||d(!1)}})(),()=>{T=!0}},[i,j]);const M=u.useMemo(()=>f&&(f.entity_type_id||f.entityType?.id||f.entity_type?.id)||null,[f]);u.useEffect(()=>{if(!M){b([]),S([]);return}if(!i)return;let T=!1;return(async()=>{try{const[C,L]=await Promise.all([If(M).catch(z=>(console.error(" Failed to load preview field order",z),null)),Lf(M).catch(z=>(console.error(" Failed to load preview field rules",z),null))]);if(T)return;b(ii(C)),S(ii(L))}catch(C){if(T)return;console.error(" Failed to load preview field layout",C),b([]),S([])}})(),()=>{T=!0}},[i,M]),u.useEffect(()=>{if(!i)return;const T=k=>{k.key==="Escape"&&(k.preventDefault(),E())};return window.addEventListener("keydown",T),()=>{window.removeEventListener("keydown",T)}},[i,E]);const _=i&&N.current?t.jsx(Lg,{entityId:j,entity:f,isLoading:o,error:h,fallbackName:n,onClose:E,fieldOrder:g,fieldRules:v}):null;return t.jsxs(t.Fragment,{children:[t.jsx("button",{type:"button",className:`entity-info-trigger ${s}`.trim(),onClick:A,"aria-label":`View details for ${n}`,children:t.jsx(Jl,{size:16,"aria-hidden":"true"})}),N.current&&Ql.createPortal(_,N.current)]})}Na.propTypes={entityId:It.oneOfType([It.string,It.number]).isRequired,entityName:It.string,className:It.string};async function $f(e){return kt.get(`/location-types/${e}/fields`)}async function CL(e,n){return kt.post(`/location-types/${e}/fields`,n)}async function AL(e,n){return kt.patch(`/location-type-fields/${e}`,n)}async function TL(e){return kt.delete(`/location-type-fields/${e}`)}const DS=450,mp="preparing-open",m1=e=>{if(e==null)return"";if(Array.isArray(e)){const n=e.map(s=>s==null?null:typeof s=="object"?s.label||s.name||s.title||s.value||s.id||null:String(s)).filter(Boolean);return n.length>0?n.join(", "):""}if(typeof e=="object")try{return JSON.stringify(e,null,2)}catch(n){return console.warn(" Failed to serialise metadata value",n),String(e)}return typeof e=="boolean"?e?"Yes":"No":e===""?"":String(e)},OS=e=>{if(!e||typeof e!="object")return null;const n=e.displayValue??e.label??e.name??e.title??e.display??e.displayName??e.text??e.value??e.id;return n==null?null:String(n)},ML=e=>{if(!e)return"";const{dataType:n,data_type:s,value:i}=e,l=n||s;if(i==null)return l==="boolean"?"No":"";switch(l){case"boolean":return i?"Yes":"No";case"number":{const o=Number(i);return Number.isNaN(o)?String(i):String(o)}case"enum":return typeof i=="object"&&i!==null?i.label||i.name||i.title||i.value||i.id||"":String(i);case"entity_reference":case"location_reference":case"reference":{if(Array.isArray(i)){const o=i.map(f=>f==null?null:typeof f=="object"?OS(f)||null:String(f)).filter(Boolean);if(o.length>0)return o.join(", ");const d=e.displayValue||e.display||e.selectedLabel||e.referenceName||e.referenceLabel;return d?String(d):""}if(typeof i=="object"&&i!==null){const o=OS(i);if(o)return o;try{return JSON.stringify(i,null,2)}catch(d){return console.warn(" Failed to serialise reference metadata value",d),String(i)}}if(i==="")return"";if(e.displayValue||e.display||e.selectedLabel){const o=e.displayValue||e.display||e.selectedLabel;return o?String(o):""}return String(i)}case"date":return Mg(i);case"text":default:return m1(i)}},kL=(e,n=[])=>{if(!e)return[];if(Array.isArray(n)&&n.length>0)return n.filter(i=>i?.name||i?.label).map((i,l)=>{const o=i.name||i.label||`field-${l}`,d=i.label||i.name||`Field ${l+1}`,f=e.metadata?.[i.name],p={...i,value:f};return{key:o,label:d,value:ML(p),fieldKey:i?.name?`metadata.${i.name}`:o,visibleByDefault:i.visible_by_default!==void 0?!!i.visible_by_default:!0}});const s=e.metadata&&typeof e.metadata=="object"&&e.metadata||e.meta&&typeof e.meta=="object"&&e.meta||null;return s?Object.entries(s).map(([i,l])=>({key:i,label:i,value:m1(l),fieldKey:i&&`metadata.${i}`,visibleByDefault:!0})):[]};function Dg({location:e,locationId:n,onClose:s,isLoading:i=!1,error:l="",fallbackName:o="",locationFields:d=[]}){const f=_n(),[p,h]=u.useState(()=>n?{location:e,locationId:n,isLoading:i,error:l,fallbackName:o}:null),[y,g]=u.useState(n?"open":"closed"),b=u.useRef(null),v=u.useRef(null);u.useEffect(()=>()=>{v.current&&(clearTimeout(v.current),v.current=null)},[]),u.useEffect(()=>{if(n&&b.current?.locationId===n&&(b.current={location:e,locationId:n,isLoading:i,error:l,fallbackName:o}),n){if(!p){h({location:e,locationId:n,isLoading:i,error:l,fallbackName:o}),g(mp);return}if(p.locationId===n){h(V=>!V||V.location===e&&V.isLoading===i&&V.error===l&&V.fallbackName===(o||V.fallbackName||"")?V:{...V,location:e,isLoading:i,error:l,fallbackName:o||V.fallbackName||""}),y==="closing"&&v.current?(clearTimeout(v.current),v.current=null,b.current=null,g("opening")):y==="closed"&&g(mp);return}b.current={location:e,locationId:n,isLoading:i,error:l,fallbackName:o},y!=="closing"&&g("closing"),v.current||(v.current=setTimeout(()=>{h(b.current),b.current=null,g("opening"),v.current=null},DS));return}p&&(y!=="closing"&&g("closing"),v.current||(b.current=null,v.current=setTimeout(()=>{h(null),g("closed"),v.current=null},DS)))},[e,n,i,l,o,p,y]),u.useEffect(()=>{if(y!==mp)return;const V=requestAnimationFrame(()=>{g("opening")});return()=>cancelAnimationFrame(V)},[y]),u.useEffect(()=>{if(y!=="opening")return;const V=requestAnimationFrame(()=>{g("open")});return()=>cancelAnimationFrame(V)},[y]);const S=!!p,N=y==="closing",j=p?.location,E=p?.locationId,A=p?.isLoading??!1,M=p?.error??"",_=p?.fallbackName,T=u.useMemo(()=>kL(j,d),[j,d]),k=T.length>0,C=j?.name||_||(A?"Loading location":"Unknown location"),L=j?.locationType?.name||j?.locationTypeName||"Location";if(!S)return null;const G=["location-info-drawer-wrapper",y==="open"?"location-info-drawer-wrapper--open":"",y==="opening"?"location-info-drawer-wrapper--opening":"",N?"location-info-drawer-wrapper--closing":""].filter(Boolean).join(" "),U=()=>{E&&f(`/locations/${E}`)},X=!!E&&!A&&!M;return t.jsxs("div",{className:G,role:"presentation",children:[t.jsx("div",{className:"location-info-drawer__overlay",onClick:s,role:"presentation"}),t.jsxs("aside",{className:"location-info-drawer",role:"complementary","aria-label":"Location details",children:[t.jsxs("header",{className:"location-info-drawer__header",children:[t.jsxs("div",{className:"location-info-drawer__header-top",children:[t.jsx("p",{className:"location-info-drawer__type",title:L,children:L}),t.jsxs("div",{className:"location-info-drawer__actions",children:[t.jsx("button",{type:"button",className:"location-info-drawer__link",onClick:U,disabled:!X,children:"Go to Record"}),t.jsx("button",{type:"button",className:"location-info-drawer__close",onClick:s,"aria-label":"Close location details",children:""})]})]}),t.jsx("h2",{className:"location-info-drawer__title",title:C,children:C})]}),j?.description&&!A&&!M&&t.jsx("p",{className:"location-info-drawer__summary",children:j.description}),j?.parent&&!A&&!M&&t.jsxs("div",{className:"location-info-drawer__parent",children:[t.jsx("span",{className:"location-info-drawer__parent-label",children:"Parent:"}),t.jsx("span",{className:"location-info-drawer__parent-name",children:j.parent.name})]}),A&&t.jsx("p",{className:"location-info-drawer__status","aria-live":"polite",children:"Loading location information"}),!!M&&!A&&t.jsx("p",{className:"location-info-drawer__status location-info-drawer__status--error","aria-live":"assertive",children:M}),!A&&!M&&k&&t.jsx("dl",{className:"location-info-drawer__metadata",children:T.map(V=>t.jsxs("div",{className:"location-info-drawer__metadata-item",children:[t.jsx("dt",{children:V.label}),t.jsx("dd",{children:V.value})]},V.key))}),!A&&!M&&!k&&t.jsx("p",{className:"location-info-drawer__status",children:"No additional metadata available."})]})]})}Dg.propTypes={locationId:It.string,onClose:It.func.isRequired,isLoading:It.bool,error:It.string,fallbackName:It.string,locationFields:It.arrayOf(It.object)};function fs({locationId:e,locationName:n="location",className:s=""}){const[i,l]=u.useState(!1),[o,d]=u.useState(!1),[f,p]=u.useState(null),[h,y]=u.useState(""),[g,b]=u.useState([]),v=u.useRef(null),S=u.useMemo(()=>e==null?null:String(e),[e]);u.useEffect(()=>(v.current||(v.current=document.createElement("div"),document.body.appendChild(v.current)),()=>{v.current&&v.current.parentNode&&(v.current.parentNode.removeChild(v.current),v.current=null)}),[]);const N=u.useCallback(()=>{l(!1),y(""),p(null),d(!1)},[]),j=M=>{if(M.preventDefault(),M.stopPropagation(),e==null)return;const _=typeof n=="string"?n.trim():"";S&&_&&p(T=>T&&T.id===S?T.name||!_?T:{...T,name:_}:{id:S,name:_}),l(!0)};u.useEffect(()=>{if(!S)return;const M=typeof n=="string"?n.trim():"";M&&p(_=>!_||_.id!==S||_.name===M||_.name&&_.name!==M?_:{..._,name:M})},[S,n]),u.useEffect(()=>{if(!i||!S)return;let M=!1;return(async()=>{d(!0),y("");try{const T=await ni(S);if(M)return;const k=T?.data||T;if(!k){p(null),y("Location not found");return}p(k)}catch(T){if(M)return;console.error(" Failed to load location preview",T),p(null),y(T.message||"Failed to load location information")}finally{M||d(!1)}})(),()=>{M=!0}},[i,S]);const E=u.useMemo(()=>f&&(f.location_type_id||f.locationType?.id||f.location_type?.id)||null,[f]);u.useEffect(()=>{if(!E){b([]);return}if(!i)return;let M=!1;return(async()=>{try{const T=await $f(E).catch(C=>(console.error(" Failed to load preview location fields",C),null));if(M)return;const k=Array.isArray(T?.data)?T.data:Array.isArray(T)?T:[];b(k)}catch(T){if(M)return;console.error(" Failed to load preview location fields",T),b([])}})(),()=>{M=!0}},[i,E]),u.useEffect(()=>{if(!i)return;const M=_=>{_.key==="Escape"&&(_.preventDefault(),N())};return window.addEventListener("keydown",M),()=>{window.removeEventListener("keydown",M)}},[i,N]);const A=i&&v.current?t.jsx(Dg,{locationId:S,location:f,isLoading:o,error:h,fallbackName:n,locationFields:g,onClose:N}):null;return t.jsxs(t.Fragment,{children:[t.jsx("button",{type:"button",className:`location-info-trigger ${s}`.trim(),onClick:j,"aria-label":`View details for ${n}`,children:t.jsx(Jl,{size:16,"aria-hidden":"true"})}),v.current&&Ql.createPortal(A,v.current)]})}fs.propTypes={locationId:It.oneOfType([It.string,It.number]).isRequired,locationName:It.string,className:It.string};function Wc({field:e,data:n,onChange:s,mode:i="edit"}){const l=e.key||e.name||e.field||"",[o,d]=u.useState([]),[f,p]=u.useState(!e.optionsSource),[h,y]=u.useState(()=>JSON.stringify(e.optionsCriteria??null)),[g,b]=u.useState(()=>({selectedLabel:e?.selectedLabel?String(e.selectedLabel):"",selectedValue:null})),v=i==="view";async function S(P=5,W=200){for(let le=0;le<P;le++){const K=Vs();if(K)return K;await new Promise(de=>setTimeout(de,W))}return null}const N=u.useCallback(P=>{if(P==null)return"null";try{return JSON.stringify(P)}catch(W){return console.warn(" Unable to serialise options criteria",W),String(P)}},[]);u.useEffect(()=>{const P=N(e.optionsCriteria??null);y(W=>W===P?W:P)},[e.optionsCriteria,N]),u.useEffect(()=>{let P=!0;return(async()=>{if(!e.optionsSource){P&&(d([]),p(!0));return}const{API_BASE:le}=await ci(async()=>{const{API_BASE:ue}=await Promise.resolve().then(()=>rR);return{API_BASE:ue}},[]);let K=null;const de=new URLSearchParams;let Q=null;const he=ue=>{if(ue==null)return null;if(typeof ue=="string"){const se=new URLSearchParams(ue);return se.get("world_id")||se.get("worldId")}if(Array.isArray(ue)){for(const se of ue)if(Array.isArray(se)&&se.length>=2){const[Le,be]=se;if(Le==="world_id"||Le==="worldId")return be}else if(se&&typeof se=="object"){const Le=he(se);if(Le)return Le}return null}return typeof ue=="object"&&(ue.world_id||ue.worldId)||null},re=ue=>{if(ue==null)return null;if(typeof ue=="string"){const se=new URLSearchParams(ue);se.delete("world_id"),se.delete("worldId");const Le=se.toString();return Le||null}if(Array.isArray(ue)){const se=ue.map(Le=>{if(Array.isArray(Le)&&Le.length>=2){const[be,De]=Le;return be==="world_id"||be==="worldId"?null:[be,De]}if(Le&&typeof Le=="object"){const be=re(Le);return be||null}return Le}).filter(Le=>Le==null?!1:Array.isArray(Le)?!0:typeof Le=="object"?Object.keys(Le).length>0:!0);return se.length>0?se:null}if(typeof ue=="object"){const se={...ue};return delete se.world_id,delete se.worldId,Object.keys(se).length>0?se:null}return ue};switch(e.optionsSource){case"worlds":K="/worlds";break;case"campaigns":K="/campaigns";break;case"entities":{const ue=he(e.optionsCriteria),se=e.worldId||e.world_id||n?.world_id||n?.worldId||null,Le=ue||se;if(!Le){console.warn(" Unable to resolve world id for entity options"),K=null;break}K=`/worlds/${Le}/entities`,Q=re(e.optionsCriteria);break}case"users":K="/users";break;case"players":{K="/users";const ue=e.roles||"player,user";de.set("roles",ue);break}default:K=null}if(!K){P&&(d([]),p(!0));return}const Re=(()=>{try{let ue;if(K.startsWith("http"))ue=new URL(K);else{const be=le.replace(/\/$/,""),De=K.startsWith("/")?K:`/${K}`;ue=new URL(`${be}${De}`)}de.forEach((be,De)=>{be!=null&&ue.searchParams.append(De,be)});const se=Q??e.optionsCriteria,Le=be=>{if(!(!be&&be!==0)){if(typeof be=="string"){new URLSearchParams(be).forEach((Me,mt)=>{ue.searchParams.append(mt,Me)});return}if(Array.isArray(be)){be.forEach(De=>{if(Array.isArray(De)&&De.length>=2){const[Me,mt]=De;if(mt==null)return;Array.isArray(mt)?mt.forEach(ht=>{ht!=null&&ue.searchParams.append(Me,ht)}):ue.searchParams.append(Me,mt);return}typeof De=="object"&&De!==null&&Le(De)});return}typeof be=="object"&&Object.entries(be).forEach(([De,Me])=>{Me!=null&&(Array.isArray(Me)?Me.forEach(mt=>{mt!=null&&ue.searchParams.append(De,mt)}):ue.searchParams.append(De,Me))})}};return Le(se),ue}catch(ue){return console.error(" Failed to construct options endpoint URL",ue),null}})();if(!Re){P&&(d([]),p(!0));return}P&&p(!1);try{const ue=await S();if(!ue){console.warn(" No auth token available when loading options"),P&&p(!0);return}const se=await fetch(Re,{headers:{"Content-Type":"application/json",Authorization:`Bearer ${ue}`}}),Le=se.headers.get("content-type");if(!Le||!Le.includes("application/json")){const ht=await se.text();console.error(` ${e.optionsSource} returned non-JSON response:`,{status:se.status,statusText:se.statusText,contentType:Le,url:Re.toString(),preview:ht.substring(0,200)}),P&&p(!0);return}const be=await se.json();if(!se.ok){console.warn(` ${e.optionsSource} fetch failed`,be),P&&p(!0);return}e.optionsSource==="worlds"&&console.log(" Worlds response:",be);const De=ht=>{if(!ht||typeof ht!="object")return null;const Ct=e.optionValueKey||"id",At=e.optionLabelKey||"name",we=ht?.[Ct]??ht?.id??null;if(!we)return null;let st=ht?.[At];if(!st){const lt=["name","title","username"];for(const Fe of lt)if(ht?.[Fe]){st=ht[Fe];break}}return st||(st=String(we)),{value:we,label:st}},mt=(Array.isArray(be?.data)?be.data:Array.isArray(be)?be:[]).map(De).filter(Boolean);P&&(d(mt),p(!0),mt.length===0&&console.warn(` ${e.optionsSource} returned no data`,be))}catch(ue){console.error(` Failed to load ${e.optionsSource}:`,ue),P&&p(!0)}})(),()=>{P=!1}},[e.optionsSource,e.optionLabelKey,e.optionValueKey,h,e.roles,e.worldId,e.world_id,n?.world_id,n?.worldId]),u.useEffect(()=>{e?.selectedLabel&&b(P=>P.selectedLabel===String(e.selectedLabel)?P:{...P,selectedLabel:String(e.selectedLabel)})},[e?.selectedLabel]);const j=e.label||l,E=(e.type||"text").toLowerCase(),A=(e.dataType||e.data_type||E).toLowerCase(),M=e.referenceTypeId??e.reference_type_id??e.referenceType?.id??null,_=e.referenceTypeName??e.reference_type_name??e.referenceType?.name??"",T=l.includes(".")?l.split(".").reduce((P,W)=>P?P[W]:void 0,n):n?.[l],k=["checkbox","boolean"].includes(E)?!!T:E==="multiselect"?Array.isArray(T)?T.map(P=>{if(P==null)return null;if(typeof P=="object"){const W=e.optionValueKey||"id",le=P?.[W]??P?.id??P?.value??P?.key??null;return le==null?null:String(le)}return String(P)}).filter(P=>P!=null):typeof T=="string"&&T.length>0?T.split(",").map(P=>P.trim()).filter(Boolean):[]:T??"",C=e.readonly||e.disabled,L=v||C,z=P=>P==null||P===""?"":Array.isArray(P)?P.length>0?P.join(", "):"":typeof P=="boolean"?P?"Yes":"No":String(P),G=z(k),U=P=>s?.(l,P.target.value),X=P=>s?.(l,P.target.checked),V=u.useCallback((P,W)=>{if(!(!W||typeof W!="string")&&!(!P||typeof P!="object"))return W.includes(".")?W.split(".").filter(le=>le.length>0).reduce((le,K)=>{if(le!=null&&typeof le=="object")return le[K]},P):P?.[W]},[]),R=u.useCallback(()=>{const P=[e.worldId,e.world_id,n?.worldId,n?.world_id];e.world&&typeof e.world=="object"&&P.push(e.world.id,e.world.world_id),n?.world&&typeof n.world=="object"&&P.push(n.world.id,n.world.world_id),n?.metadata&&typeof n.metadata=="object"&&P.push(n.metadata.worldId,n.metadata.world_id);for(const W of P){if(W==null)continue;const le=String(W).trim();if(le)return le}return""},[e.worldId,e.world_id,e.world,n?.worldId,n?.world_id,n?.world,n?.metadata]),B=E==="reference"||E==="entity_reference"||E==="location_reference"||A==="entity_reference"||A==="location_reference"||A==="reference",D=A==="location_reference"||E==="location_reference",O=l==="location_id"||l==="location"?k!=null&&k!==""?k:n?.location_id||n?.location?.id||n?.location||"":null,$=B&&k!==void 0&&k!==null&&k!==""?String(k):D&&O&&O!==""?String(O):"",F=u.useMemo(()=>{if(!B)return[];const P=e.options?.choices;return Array.isArray(P)?P.map((W,le)=>{if(W==null)return null;if(typeof W=="object"){const de=W.value??W.id??W.key??W.slug??`choice-${le}`;if(de==null)return null;const Q=W.label??W.name??W.title??W.display??W.displayName??de;return{value:String(de),label:String(Q)}}const K=String(W);return{value:K,label:K}}).filter(Boolean):[]},[E,e.options?.choices]);if(u.useEffect(()=>{E==="reference"&&($||b(P=>!P.selectedLabel&&!P.selectedValue?P:{...P,selectedLabel:"",selectedValue:null}))},[E,$]),u.useEffect(()=>{if(E!=="reference"||!$)return;const P=F.find(le=>le.value===$),W=(()=>{if(typeof e.value=="object"&&e.value!==null){const le=e.value.label??e.value.name??e.value.title??e.value.display??e.value.displayName??e.value.text??e.value.value??e.value.id??null;if(le!=null){const K=String(le).trim();if(K)return K}}return P?.label?String(P.label):""})();if(!W){b(le=>le.selectedValue===$?le:{...le,selectedValue:$});return}b(le=>le.selectedValue===$&&le.selectedLabel===W?le:{...le,selectedLabel:W,selectedValue:$})},[E,$,e.value,F]),!l)return console.warn(" Field without key/name skipped:",e),null;const H=P=>{const W=[];return e.helpText&&W.push(t.jsx("p",{className:"help-text",children:e.helpText},"help")),P&&W.push(t.jsx("p",{className:"help-text warning",children:e.noOptionsMessage||"No options available."},"empty")),W};if(B){const P=R(),W=typeof _=="string"&&_.trim()?_.trim():D?"locations":"entities",le=F.length>0,K=!!(P&&(M||D)),de=!K&&!le;if(L){const ue=e.displayKey&&V(n,e.displayKey)?V(n,e.displayKey):null,se=D?$||n?.location_id||n?.parent_id||n?.location?.id||n?.parent?.id||l==="location"&&n?.location||l==="parent"&&n?.parent||l==="parent_id"&&n?.parent_id||n?.location||n?.parent||"":null,Le=D&&(n?.locationName||n?.parentName||n?.location?.name||n?.parent?.name)||null;let be=ue??(Le&&Le!==""?Le:null)??g.selectedLabel??F.find(mt=>mt.value===$)?.label??"";!be&&$&&!D&&(be=$);const De=D?se&&se!==""&&se!==""?se:null:Rg(T||e.value||$),Me=D?Le&&Le!==""?Le:be&&be!==""?be:null:Ig(T||e.value)||be||$;return t.jsxs("div",{className:`form-group ${L?"readonly":""}`,children:[t.jsx("label",{children:j}),t.jsxs("div",{style:{position:"relative",display:"inline-block",width:"100%"},children:[t.jsx("input",{type:"text",value:z(be),disabled:!0,className:"readonly-control",style:{paddingRight:De?"2.5rem":"0.8rem",width:"100%"}}),De&&t.jsx("div",{style:{position:"absolute",right:"0.5rem",top:"50%",transform:"translateY(-50%)",zIndex:1},children:D?t.jsx(fs,{locationId:De,locationName:Me,className:"location-info-trigger--field-button"}):t.jsx(Na,{entityId:De,entityName:Me,className:"entity-info-trigger--field-button"})})]}),H(!1)]})}const Q=ue=>{if(!ue){s?.(l,""),b(De=>({...De,selectedLabel:"",selectedValue:null}));return}const se=ue.id??ue.value??ue.key??ue.slug??ue.uuid??null;if(se==null){s?.(l,"");return}const Le=String(se),be=ue.name??ue.label??ue.title??ue.display??ue.displayName??"";s?.(l,Le),b(De=>({...De,selectedLabel:be||De.selectedLabel||Le,selectedValue:Le}))},he=ue=>{if(!ue){b(De=>({...De,selectedLabel:"",selectedValue:null}));return}const se=ue.id??ue.value??ue.key??ue.slug??ue.uuid??null;if(se==null)return;const Le=String(se),be=ue.name??ue.label??ue.title??ue.display??ue.displayName??"";b(De=>De.selectedValue===Le&&De.selectedLabel===be?De:{...De,selectedLabel:be||De.selectedLabel||Le,selectedValue:Le})},re=$&&g.selectedLabel?{id:$,name:g.selectedLabel}:$,Ce=D?c1:kc,Re=e.allowedTypeIds&&Array.isArray(e.allowedTypeIds)&&e.allowedTypeIds.length>0?e.allowedTypeIds:M?[M]:[];return t.jsxs("div",{className:"form-group",children:[t.jsx("label",{children:j}),t.jsx(Ce,{worldId:P,value:re,allowedTypeIds:Re,disabled:de,placeholder:`Search ${W.toLowerCase()}...`,staticOptions:F,onChange:Q,onResolved:he,required:!!e.required,minSearchLength:D&&Re.length===0?0:void 0}),!M&&!D&&t.jsx("p",{className:"help-text warning",children:"Reference type configuration is missing."}),!P&&K&&t.jsxs("p",{className:"help-text warning",children:["Select a world to search for ",D?"locations":"entities","."]}),H(!1)]})}if(["select","dropdown"].includes(E)){const P=[...e.options||[],...o],W=k??"",le=f&&e.optionsSource&&P.length===0;if(L){const K=P.find(he=>he?typeof he=="object"?String(he.value)===String(W):String(he)===String(W):!1),de=e.displayKey&&V(n,e.displayKey)?V(n,e.displayKey):null,Q=z(de||(K?typeof K=="object"?K.label??K.value:K:W));return t.jsxs("div",{className:`form-group ${L?"readonly":""}`,children:[t.jsx("label",{children:j}),t.jsx("input",{type:"text",value:Q,disabled:!0,className:"readonly-control"}),H(!1)]})}return t.jsxs("div",{className:"form-group",children:[t.jsx("label",{children:j}),t.jsx("div",{className:"select-wrapper",children:t.jsxs("select",{value:W,onChange:U,disabled:le,children:[t.jsx("option",{value:"",children:"Select..."}),P.map((K,de)=>{const Q=typeof K=="object"?K.value:K,he=typeof K=="object"?K.label:K;return t.jsx("option",{value:Q,children:he},Q||de)})]})}),H(le)]})}if(E==="multiselect"){const P=[...Array.isArray(e.selectedOptions)?e.selectedOptions:[],...Array.isArray(e.prefillOptions)?e.prefillOptions:[]],W=[...e.options||[],...o,...P].map((he,re)=>{const Ce=Qj(he);if(Ce)return Ce;if(typeof he=="object"&&he!==null){const ue=he.value??he.id??he.key??he.slug??`opt-${re}`,se=he.label??he.name??he.title??he.username??he.email??ue;return ue==null?null:{value:String(ue),label:String(se)}}if(he==null)return null;const Re=String(he);return{value:Re,label:Re}}).filter(Boolean),le=new Map,K=W.filter(he=>{const re=String(he.value);return le.has(re)?!1:(le.set(re,he),!0)}),de=Array.isArray(k)?k.map(he=>String(he)).filter(Boolean):[],Q=f&&e.optionsSource&&K.length===0;if(L){const he=de.map(re=>{const Ce=le.get(String(re));return Ce?Ce.label??Ce.value??String(re):String(re)}).filter(Boolean);return t.jsxs("div",{className:`form-group ${L?"readonly":""}`,children:[t.jsx("label",{children:j}),t.jsx("textarea",{className:"textarea-field",value:he.length?he.join(`
`):"",readOnly:!0}),H(!1)]})}return t.jsxs("div",{className:"form-group",children:[t.jsx("label",{children:j}),t.jsx(zs,{selected:de,options:K,onChange:he=>s?.(l,he),placeholder:e.placeholder||"Search and select...",noOptionsMessage:e.noOptionsMessage||"No options available.",loading:!f&&!!e.optionsSource}),H(Q)]})}if(["textarea","multiline"].includes(E))return t.jsxs("div",{className:`form-group ${L?"readonly":""}`,children:[t.jsx("label",{children:j}),t.jsx("textarea",{className:"textarea-field",rows:e.rows||4,value:L?G:k,onChange:U,disabled:L}),H(!1)]});if(["checkbox","boolean"].includes(E))return t.jsxs("div",{className:"form-group checkbox",children:[t.jsxs("label",{children:[t.jsx("input",{type:"checkbox",checked:!!k,onChange:X,disabled:L}),j]}),H(!1)]});if(E==="readonly"){const P=k?.username||k?.name||k||"-";return t.jsxs("div",{className:"form-group readonly",children:[t.jsx("label",{children:j}),t.jsx("div",{className:"readonly-value",children:P}),H(!1)]})}const I=(L?"text":e.inputType)||"text",Y=(()=>{if(k==null)return"";if(new Set(["number","date","datetime-local","month","time","week","range"]).has(I)&&typeof k=="string"){const W=k.trim();if(!W||W==="")return""}return k})();return L?t.jsxs("div",{className:"form-group readonly",children:[t.jsx("label",{children:j}),t.jsx("div",{className:"readonly-value",children:G}),H(!1)]}):t.jsxs("div",{className:"form-group",children:[t.jsx("label",{children:j}),t.jsx("input",{type:I,value:Y,onChange:U,placeholder:e.placeholder||"",className:L?"readonly-control":void 0}),H(!1)]})}const h1="You have unsaved changes. Select Cancel to stay here and save, or OK to leave without saving.";function RL(e,n=h1,s){const i=u.useCallback(({currentLocation:l,nextLocation:o})=>!e||s?.current?!1:!(l.pathname===o.pathname&&l.search===o.search&&l.hash===o.hash),[e,s]);cM({when:i,message:n}),hj(u.useCallback(l=>{!e||s?.current||(l.preventDefault(),l.returnValue="")},[e,s]),{capture:!0})}function IL({schema:e,initialData:n={},onSubmit:s,onCancel:i,onDelete:l,hideActions:o=!1,enableUnsavedPrompt:d=!0,onStateChange:f,fieldRules:p},h){const[y,g]=u.useState(()=>n?{...n}:{}),[b,v]=u.useState(()=>JSON.stringify(n??{})),[S,N]=u.useState(""),[j,E]=u.useState("success"),[A,M]=u.useState(!1),[_,T]=u.useState(()=>({actionsByField:{},showRuleTargets:new Set})),k=u.useMemo(()=>{if(!e)return[];const Y=Array.isArray(e.fields)?e.fields.filter(W=>W&&typeof W=="object"):[],P=Array.isArray(e.sections)?e.sections.flatMap(W=>Array.isArray(W?.fields)?W.fields:[]).filter(W=>W&&typeof W=="object"):[];return Y.length===0&&P.length===0?[]:[...P,...Y]},[e]),C=u.useMemo(()=>{const Y=Array.isArray(p)?p:[];return Ag(Y,k)},[p,k]);u.useEffect(()=>{const Y=n?{...n}:{};g(Y),v(JSON.stringify(n??{})),N(""),E("success")},[n]),u.useEffect(()=>{if(!C.length){T({actionsByField:{},showRuleTargets:new Set});return}const Y=Tg(C,y);T(Y)},[C,y]);const L=u.useMemo(()=>Array.isArray(e?.sections)&&e.sections.length>0?e.sections:Array.isArray(e?.fields)?[{title:e.title,columns:e.columns||1,fields:e.fields}]:[],[e]),z=(Y,P,W)=>{if(!P||P.length===0)return Y;const le={...Y||{}};let K=le;for(let de=0;de<P.length;de+=1){const Q=P[de];if(de===P.length-1)K[Q]=W;else{const re=K[Q],Ce=re&&typeof re=="object"&&!Array.isArray(re)?{...re}:{};K[Q]=Ce,K=Ce}}return le},G=(Y,P)=>{if(!(!P||typeof P!="string")&&!(!Y||typeof Y!="object"))return P.includes(".")?P.split(".").filter(W=>W.length>0).reduce((W,le)=>{if(W!=null&&typeof W=="object")return W[le]},Y):Y?.[P]},U=(Y,P)=>{!Y||typeof Y!="string"||g(W=>{if(!Y.includes("."))return{...W||{},[Y]:P};const le=Y.split(".").filter(K=>K.length>0);return le.length===0?{...W||{}}:z(W,le,P)})},X=u.useMemo(()=>JSON.stringify(y??{}),[y]),V=u.useMemo(()=>X!==b,[X,b]),R=u.useRef(!1);u.useEffect(()=>{V||(R.current=!1)},[V]),u.useEffect(()=>{V&&S&&(N(""),E("success"))},[V,S]),u.useEffect(()=>{typeof f=="function"&&f({isDirty:V,isSubmitting:A})},[V,A,f]),RL(d&&V,void 0,R);const D=u.useCallback(()=>{if(!L.length)return!0;const Y=[];return L.forEach(P=>{(Array.isArray(P.fields)?P.fields:[]).forEach(le=>{const K=le?.key||le?.name||le?.field;if(!K)return;const de=_.actionsByField[K],Q=le?.visibleByDefault!==void 0?!!le.visibleByDefault:le?.visible_by_default!==void 0?!!le.visible_by_default:!0;if(Rc(K,de,_.showRuleTargets,Q)||!(!!le?.required||de==="require"))return;const re=G(y,K);(Array.isArray(re)?re.length>0:re!=null&&re!=="")||Y.push(le.label||le.name||K)})}),Y.length>0?(E("error"),N(`Please complete required fields: ${Y.join(", ")}`),!1):!0},[L,y,_]),O=u.useCallback(async()=>{if(!s)return!0;if(!D())return!1;const Y=JSON.stringify(y??{});M(!0),E("success"),N(""),R.current=!0;try{const P=await s(y);if(P===!1)return R.current=!1,!1;const W=P&&typeof P=="object"&&!Array.isArray(P)?P:{};v(Y);const le=typeof P=="string"?P:W.message||e?.saveSuccessMessage||"";if(le){const K=W.status==="error"?"error":"success";E(K),N(le)}return R.current=!1,W}catch(P){return console.error("Failed to submit form:",P),E("error"),N(P.message||"Failed to save changes."),R.current=!1,!1}finally{M(!1)}},[y,s,e,D]),$=async Y=>{Y.preventDefault(),await O()},F=()=>{i&&(!V||window.confirm(h1))&&(v(X),R.current=!0,i())},H=async()=>{if(l)try{await l(y)&&(v(X),R.current=!0)}catch(Y){console.error("Failed to delete record:",Y)}},I=u.useCallback((Y=n)=>{const P=Y?{...Y}:{};g(P),v(JSON.stringify(Y??{})),N(""),E("success"),R.current=!1},[n]);return u.useImperativeHandle(h,()=>({submit:O,reset:I,isDirty:()=>V,isSubmitting:()=>A}),[O,I,V,A]),t.jsxs("form",{className:"record-form",onSubmit:$,children:[t.jsx("h2",{className:"form-title",children:e?.title||"Record"}),L.map((Y,P)=>t.jsxs("div",{className:"form-section",children:[Y.title?t.jsx("h3",{children:Y.title}):null,t.jsx("div",{className:`form-grid cols-${Y.columns||1} ${(Y.columns||1)>1?"grid grid-cols-1 sm:grid-cols-2 gap-4":""}`,children:(Y.fields||[]).map((W,le)=>{if(!W||typeof W!="object")return console.warn(" Skipping invalid field in schema:",W),null;const K=W.key||W.name||W.field||`field-${le}`,de=_.actionsByField[K],Q=W.visibleByDefault!==void 0?!!W.visibleByDefault:W.visible_by_default!==void 0?!!W.visible_by_default:!0;if(Rc(K,de,_.showRuleTargets,Q))return null;const he={...W};de==="disable"&&(he.disabled=!0),de==="require"&&(he.required=!0);const re=W.span||W.colSpan||null,Ce=t.jsx(Wc,{field:he,data:y,onChange:U,mode:"edit"},`${K}-${le}`);return re&&Number.isFinite(re)&&re>1?t.jsx("div",{style:{gridColumn:`span ${re}`},children:Ce},`${K}-${le}-wrapper`):Ce})})]},P)),S?t.jsx("div",{className:`form-feedback ${j}`,role:j==="error"?"alert":"status",children:S}):null,o?null:t.jsxs("div",{className:"form-actions sticky-actions",role:"toolbar",children:[t.jsx("div",{className:"left-actions",children:l?t.jsx("button",{type:"button",className:"btn delete",onClick:H,disabled:A,children:e?.deleteLabel||"Delete"}):null}),t.jsxs("div",{className:"right-actions",children:[t.jsx("button",{type:"button",className:"btn cancel",onClick:F,disabled:A,children:e?.cancelLabel||"Cancel"}),t.jsx("button",{type:"submit",className:"btn submit",disabled:A,children:e?.saveLabel||"Save"})]})]})]})}const us=u.forwardRef(IL),LL="Create New World",DL=[{title:"General",columns:2,fields:[{key:"name",label:"Name",type:"text"},{key:"system",label:"System",type:"text"}]},{title:"Entity Creation",columns:1,fields:[{key:"entity_creation_scope",label:"Who can create entities?",type:"select",options:[{value:"owner_dm",label:"World Owner & DMs"},{value:"all_players",label:"All Players (campaign scoped)"}],helpText:"When set to All Players, campaign members can only create entities scoped to their campaign."}]},{title:"Description",columns:1,fields:[{key:"description",label:"Description",type:"textarea"}]}],OL={title:LL,sections:DL},zi={OWNER_DMS:"owner_dm",ALL_PLAYERS:"all_players"},hp=[{value:zi.OWNER_DMS,label:"World Owner / DMs"},{value:zi.ALL_PLAYERS,label:"All Players (campaign scoped)"}],p1=e=>{if(!e)return hp[0].label;const n=String(e).trim().toLowerCase(),s=hp.find(i=>i.value===n);return s?s.label:hp[0].label};function $L(){const e=_n(),{token:n,sessionReady:s}=un(),[i,l]=u.useState([]),[o,d]=u.useState(!1),[f,p]=u.useState(null),[h,y]=u.useState(!1),g=u.useCallback(async()=>{if(n){d(!0),p(null);try{const j=await eo();l(j?.data||j||[])}catch(j){console.error(" Failed to load worlds:",j),p(j.message)}finally{d(!1)}}},[n]);u.useEffect(()=>{s&&n&&g()},[s,n,g]);const b=[{key:"name",label:"Name"},{key:"system",label:"System"},{key:"status",label:"Status"},{key:"entity_creation_scope",label:"Entity Creation",render:j=>p1(j.entity_creation_scope)},{key:"description",label:"Description"},{key:"createdAt",label:"Created"}],v=()=>y(!0),S=()=>y(!1),N=async j=>{try{return(await bR(j)).success?(await g(),y(!1),!0):!1}catch(E){return alert(`Failed to create world: ${E.message}`),!1}};return s?n?o?t.jsx("p",{children:"Loading worlds..."}):f?t.jsxs("p",{className:"error",children:["Error: ",f]}):h?t.jsx(us,{schema:OL,initialData:{entity_creation_scope:zi.OWNER_DMS},onSubmit:N,onCancel:S,showUpdateAction:!1}):t.jsx(Df,{data:i,columns:b,title:"Worlds",extraActions:t.jsx("button",{type:"button",className:"btn submit",onClick:v,children:"+ New"}),onRowClick:j=>e(`/worlds/${j.id}`)}):t.jsx("p",{children:"Authenticating..."}):t.jsx("p",{children:"Restoring session..."})}function y1({schema:e,data:n={},onClose:s,closeLabel:i="Back",infoMessage:l}){const o=u.useMemo(()=>Array.isArray(e?.sections)&&e.sections.length>0?e.sections:Array.isArray(e?.fields)?[{title:e.title,columns:e.columns||1,fields:e.fields}]:[],[e]);return t.jsxs("div",{className:"record-form record-view",children:[t.jsx("h2",{className:"form-title",children:e?.title||"Details"}),o.map((d,f)=>t.jsxs("div",{className:"form-section",children:[d.title?t.jsx("h3",{children:d.title}):null,t.jsx("div",{className:`form-grid cols-${d.columns||1}`,children:(d.fields||[]).map((p,h)=>!p||typeof p!="object"?(console.warn(" Skipping invalid field in schema:",p),null):t.jsx(Wc,{field:p,data:n,mode:"view"},`${p.key||p.name||p.field||"field"}-${h}`))})]},f)),l?t.jsx("p",{className:"record-info",children:l}):null,s?t.jsxs("div",{className:"form-actions sticky-actions view-actions",role:"toolbar",children:[t.jsx("div",{className:"left-actions","aria-hidden":"true"}),t.jsx("div",{className:"right-actions",children:t.jsx("button",{type:"button",className:"btn cancel",onClick:s,children:i})})]}):null]})}const FL="Edit World",zL=[{title:"General",columns:2,fields:[{key:"name",label:"Name",type:"text"},{key:"system",label:"System",type:"text"},{key:"status",label:"Status",type:"select",options:[{value:"active",label:"Active"},{value:"archived",label:"Archived"}]}]},{title:"Entity Creation",columns:1,fields:[{key:"entity_creation_scope",label:"Who can create entities?",type:"select",options:[{value:"owner_dm",label:"World Owner & DMs"},{value:"all_players",label:"All Players (campaign scoped)"}],helpText:"When set to All Players, campaign members can only create entities scoped to their campaign."}]},{title:"Description",columns:1,fields:[{key:"description",label:"Description",type:"textarea"}]},{title:"Metadata",columns:2,fields:[{key:"created_by",label:"Created By",type:"readonly"},{key:"createdAt",label:"Created Date",type:"readonly"},{key:"updatedAt",label:"Updated Date",type:"readonly"}]}],BL={title:FL,sections:zL},UL="World Details",qL=[{title:"General",columns:2,fields:[{name:"name",label:"Name",type:"text"},{name:"system",label:"System",type:"text"},{name:"statusLabel",label:"Status",type:"text"},{name:"entityCreationScopeLabel",label:"Entity Creation",type:"text"}]},{title:"Description",columns:1,fields:[{name:"description",label:"Description",type:"textarea"}]},{title:"Metadata",columns:2,fields:[{name:"ownerName",label:"Created By",type:"text"},{name:"createdAt",label:"Created",type:"text"},{name:"updatedAt",label:"Updated",type:"text"}]}],PL={title:UL,sections:qL},os=e=>{if(!e)return"";const n=e instanceof Date?e:new Date(e);if(Number.isNaN(n.getTime()))return typeof e=="string"?e:"";const s=String(n.getDate()).padStart(2,"0"),i=String(n.getMonth()+1).padStart(2,"0"),l=n.getFullYear(),o=String(n.getHours()).padStart(2,"0"),d=String(n.getMinutes()).padStart(2,"0");return`${s}/${i}/${l} ${o}:${d}`};function HL(){const{id:e}=Ka(),n=_n(),{user:s,token:i,sessionReady:l}=un(),[o,d]=u.useState(null),[f,p]=u.useState(!0),[h,y]=u.useState(null),g=u.useCallback(async()=>{try{const E=await eo(),A=(E?.data||E||[]).find(M=>M.id===e);d(A),A||y("World not found")}catch(E){console.error(" Failed to load world:",E),y(E.message)}finally{p(!1)}},[e]);u.useEffect(()=>{l&&i&&g()},[l,i,g]);const b=async(E,A={})=>{const{stayOnPage:M=!1}=A;try{const _={name:E?.name,description:E?.description,system:E?.system,status:E?.status,entity_creation_scope:E?.entity_creation_scope},T=await xR(e,_);if(T.success){const k=T.data||{...o,..._};return d(k),M?{message:"World updated successfully."}:(n("/worlds"),!0)}return!1}catch(_){return alert(`Failed to update world: ${_.message}`),!1}},v=async()=>{if(!confirm("Delete this world?"))return!1;try{return(await vR(e)).success?(n("/worlds"),!0):!1}catch(E){return alert(`Failed to delete world: ${E.message}`),!1}},S=u.useMemo(()=>!o||!s?!1:s.role==="system_admin"?!0:o.created_by===s.id,[s,o]),N=u.useMemo(()=>o?{...o,created_by:o.creator||o.created_by}:null,[o]),j=u.useMemo(()=>{if(!o)return null;const E=o.status||"",A=E.length>0?E.charAt(0).toUpperCase()+E.slice(1):"",M=p1(o.entity_creation_scope),_=o.creator?.username||o.creator?.name||o.created_by||"";return{name:o.name||"",system:o.system||"",statusLabel:A,entityCreationScopeLabel:M,description:o.description||"",ownerName:_,createdAt:os(o.createdAt),updatedAt:os(o.updatedAt)}},[o]);return l?i?f?t.jsx("p",{children:"Loading world..."}):h?t.jsxs("p",{className:"error",children:["Error: ",h]}):o?S?t.jsx(us,{schema:BL,initialData:N||o,onSubmit:b,onDelete:v,onCancel:()=>n("/worlds")}):t.jsx(y1,{schema:PL,data:j||{},onClose:()=>n("/worlds"),closeLabel:"Back to worlds",infoMessage:"You can view this world but only the creator or a system admin can make changes."}):t.jsx("p",{children:"World not found"}):t.jsx("p",{children:"Authenticating..."}):t.jsx("p",{children:"Restoring session..."})}async function VL(e=5,n=200){for(let s=0;s<e;s++){const i=Vs();if(i)return i;await new Promise(l=>setTimeout(l,n))}return null}async function Og(){const e=await VL();if(!e)throw new Error("Missing or invalid token");return{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}async function $g(e,n="request"){if(e.status===401)throw new Error("Unauthorized");if(!e.ok){const s=await e.text();throw new Error(`Failed to ${n}: ${e.status} ${s}`)}return e.json()}async function YL(e){if(!e)throw new Error("campaignId is required");const n=await Og(),s=new URL(`${sn}/user-campaign-roles`);s.searchParams.set("campaign_id",e);const i=await fetch(s.toString(),{headers:n});return $g(i,"load campaign members")}async function GL(e,n){const s=await Og(),i=await fetch(`${sn}/user-campaign-roles/${e}`,{method:"PUT",headers:s,body:JSON.stringify(n)});return $g(i,"update campaign assignment")}async function WL(e){const n=await Og(),s=await fetch(`${sn}/user-campaign-roles/${e}`,{method:"DELETE",headers:n});return $g(s,"remove user from campaign")}const XL=[{label:"Dungeon Master",value:"dm"},{label:"Player",value:"player"},{label:"Observer",value:"observer"}];function KL({campaignId:e,canManage:n,onMembersChanged:s}){const[i,l]=u.useState([]),[o,d]=u.useState(!0),[f,p]=u.useState(null),h=u.useCallback(async()=>{if(e){p(null),d(!0);try{const v=(await YL(e))?.data||[];l(v)}catch(b){p(b.message)}finally{d(!1)}}},[e]);u.useEffect(()=>{h()},[h]);const y=async(b,v)=>{p(null);try{const N=(await GL(b,{role:v}))?.data;N&&l(j=>{const E=j.map(A=>A.id===N.id?N:A);return typeof s=="function"&&s(E),E})}catch(S){p(S.message)}},g=async b=>{if(confirm("Remove this user from the campaign?")){p(null);try{await WL(b),l(v=>{const S=v.filter(N=>N.id!==b);return typeof s=="function"&&s(S),S})}catch(v){p(v.message)}}};return e?t.jsx(t.Fragment,{children:t.jsxs("div",{className:"panel",children:[t.jsx("div",{className:"panel-header",children:t.jsx("h3",{children:"Campaign Members"})}),f&&t.jsx("p",{className:"error",children:f}),o?t.jsx("p",{children:"Loading members"}):i.length===0?t.jsx("p",{children:"No users associated with this campaign yet."}):t.jsxs("table",{className:"compact-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"User"}),t.jsx("th",{children:"Role"}),t.jsx("th",{children:"Added"}),n?t.jsx("th",{children:"Actions"}):null]})}),t.jsx("tbody",{children:i.map(b=>t.jsxs("tr",{children:[t.jsx("td",{children:b.user?.username||b.user?.email||b.user_id}),t.jsx("td",{children:n?t.jsx("select",{value:b.role,onChange:v=>y(b.id,v.target.value),children:XL.map(v=>t.jsx("option",{value:v.value,children:v.label},v.value))}):b.role}),t.jsx("td",{children:b.createdAt?new Date(b.createdAt).toLocaleString():""}),n?t.jsx("td",{children:t.jsx("button",{type:"button",className:"btn danger",onClick:()=>g(b.id),children:"Remove"})}):null]},b.id))})]}),n?t.jsx("p",{className:"help-text",children:"Manage who can participate through the Players list. Update roles here to promote Dungeon Masters or set observers."}):null]})}):null}const ZL="New Campaign",QL=[{name:"world_id",label:"World",type:"select",optionsSource:"worlds",optionsCriteria:{owned_only:!0},required:!0},{name:"name",label:"Name",type:"text",required:!0,placeholder:"Enter campaign name"},{name:"description",label:"Description",type:"textarea",placeholder:"Brief description of the campaign world"},{name:"status",label:"Status",type:"select",options:[{label:"Draft",value:"draft"},{label:"Active",value:"active"},{label:"Completed",value:"completed"},{label:"Archived",value:"archived"}],default:"draft"}],JL="Create Campaign",eD={title:ZL,fields:QL,submitLabel:JL},tD="Edit Campaign",nD=[{name:"world_id",label:"World",type:"select",optionsSource:"worlds",required:!0,readonly:!0},{name:"name",label:"Name",type:"text",required:!0},{name:"description",label:"Description",type:"textarea"},{name:"status",label:"Status",type:"select",options:[{label:"Draft",value:"draft"},{label:"Active",value:"active"},{label:"Completed",value:"completed"},{label:"Archived",value:"archived"}]},{name:"player_ids",label:"Players",type:"multiselect",optionsSource:"players",optionLabelKey:"username",optionValueKey:"id",helpText:"Players selected here can create characters in this campaign.",noOptionsMessage:"No eligible players are currently available."}],aD="Save Changes",sD="Delete Campaign",$S={title:tD,fields:nD,submitLabel:aD,deleteLabel:sD},rD="Campaign Details",iD=[{title:"Overview",columns:2,fields:[{name:"name",label:"Name",type:"text"},{name:"statusLabel",label:"Status",type:"text"},{name:"worldName",label:"World",type:"text"},{name:"ownerName",label:"Owner",type:"text"}]},{title:"Description",columns:1,fields:[{name:"description",label:"Description",type:"textarea"}]},{title:"Metadata",columns:2,fields:[{name:"createdAt",label:"Created",type:"text"},{name:"updatedAt",label:"Updated",type:"text"}]}],lD={title:rD,sections:iD};function ud({scope:e="all"}){const n=_n(),{id:s}=Ka(),{user:i,token:l,sessionReady:o}=un(),[d,f]=u.useState([]),[p,h]=u.useState(!1),[y,g]=u.useState("list"),[b,v]=u.useState(null),[S,N]=u.useState(null),[j,E]=u.useState("details"),A=u.useMemo(()=>`/campaigns/${e}`,[e]),M=u.useCallback(Q=>{if(!Q)return Q;const he=Array.isArray(Q.members)?Q.members.filter(re=>re.role==="player"):[];return{...Q,ownerName:Q.owner?.username||"",worldName:Q.world?.name||"",player_ids:he.map(re=>re.user_id)}},[]),_=u.useCallback(async()=>{if(l){h(!0),N(null);try{const Q=await Vc(),re=(Q?.data||Q||[]).map(Ce=>M(Ce));f(re)}catch(Q){N(Q.message)}finally{h(!1)}}},[l,M]);u.useEffect(()=>{o&&l&&_()},[o,l,_]),u.useEffect(()=>{g("list"),v(null),E("details")},[e]),u.useEffect(()=>{if(!s){y!=="new"&&g("list"),v(null);return}const Q=d.find(re=>String(re.id)===s);if(!Q){p||n(A,{replace:!0});return}const he=!!i&&(i.role==="system_admin"||Q.created_by===i.id);v(Q),g(he?"edit":"view")},[s,d,n,A,p,y,i]),u.useEffect(()=>{E("details")},[b?.id]);const T=u.useMemo(()=>[{key:"name",label:"Name"},{key:"worldName",label:"World"},{key:"ownerName",label:"Owner"},{key:"status",label:"Status"},{key:"description",label:"Description"},{key:"createdAt",label:"Created"}],[]),k=Q=>!Q||!i?!1:i.role==="system_admin"||Q.created_by===i.id,C=u.useMemo(()=>{if(i?.role!=="system_admin")return $S;const Q=JSON.parse(JSON.stringify($S)),he={name:"created_by",label:"Owner",type:"select",optionsSource:"users",optionLabelKey:"username",optionValueKey:"id"};if(Array.isArray(Q.fields)){const re=Q.fields.findIndex(Ce=>Ce?.name==="created_by");if(re>=0)Q.fields[re]={...Q.fields[re],...he};else{const Ce=Math.min(2,Q.fields.length);Q.fields.splice(Ce,0,he)}}return Q},[i]),L=()=>{n(A),g("new"),v(null)},z=()=>{g("list"),v(null),n(A)},G=async Q=>{try{return(await oR(Q)).success?(await _(),n(A),g("list"),v(null),!0):!1}catch(he){return alert(`Failed to create campaign: ${he.message}`),!1}},U=async(Q,he={})=>{const{stayOnPage:re=!1}=he;if(!k(b))return alert("You do not have permission to update this campaign."),!1;const Ce={...Q};Object.prototype.hasOwnProperty.call(Q,"player_ids")&&(Array.isArray(Q.player_ids)?Ce.player_ids=Q.player_ids.filter(Re=>Re!=null&&Re!==""):typeof Q.player_ids=="string"&&Q.player_ids!==""?Ce.player_ids=[Q.player_ids]:Ce.player_ids=[]);try{const Re=await cR(b.id,Ce);if(Re.success){const ue=M(Re.data);return f(se=>se.map(Le=>Le.id===ue.id?ue:Le)),v(se=>!se||se.id!==ue.id?se:ue),re?{message:"Campaign updated successfully."}:(g("list"),v(null),n(A),!0)}return!1}catch(Re){return alert(`Failed to update campaign: ${Re.message}`),!1}},X=u.useCallback((Q,he)=>{const re=Ce=>{if(!Array.isArray(Ce))return{members:[],playerIds:[]};const Re=Ce.filter(ue=>ue.role==="player");return{members:Ce,playerIds:Re.map(ue=>ue.user_id)}};f(Ce=>Ce.map(Re=>{if(Re.id!==Q)return Re;const{members:ue,playerIds:se}=re(he);return{...Re,members:ue,player_ids:se}})),v(Ce=>{if(!Ce||Ce.id!==Q)return Ce;const{members:Re,playerIds:ue}=re(he);return{...Ce,members:Re,player_ids:ue}})},[]),V=async Q=>{const he=Q||b,re=he?.id;if(!re)return!1;if(!k(he))return alert("You do not have permission to delete this campaign."),!1;if(!confirm("Delete this campaign?"))return!1;try{return(await uR(re)).success?(await _(),g("list"),v(null),n(A),!0):!1}catch(Ce){return alert(Ce.message),!1}},R=()=>{g("list"),v(null),n(A)},B=u.useMemo(()=>{if(!b)return null;const Q=b.created_by??b.owner?.id??"",he=Array.isArray(b.members)?b.members.filter(re=>re.role==="player"):[];return{...b,created_by:Q,player_ids:he.map(re=>re.user_id)}},[b]),D=u.useMemo(()=>{const Q=JSON.parse(JSON.stringify(C));return Array.isArray(Q.fields)?Q.fields=Q.fields.filter(he=>he?.name!=="player_ids"):Array.isArray(Q.sections)&&(Q.sections=Q.sections.map(he=>({...he,fields:(he.fields||[]).filter(re=>re?.name!=="player_ids")})).filter(he=>he.fields&&he.fields.length>0)),Q.title="Campaign Details",Q},[C]),O=u.useMemo(()=>{if(!b||!Array.isArray(b.members))return[];const Q=new Set;return b.members.map(he=>{const re=he?.user_id??he?.user?.id;if(!re)return null;const Ce=String(re);if(Q.has(Ce))return null;Q.add(Ce);const Re=he?.user?.username||he?.user?.displayName||he?.user?.display_name||he?.user?.name||he?.user?.email||he?.display_name||Ce;return{value:Ce,label:Re}}).filter(Boolean)},[b]),$=u.useMemo(()=>{const Q={title:"Campaign Membership",fields:[]},he=Ce=>{if(!Ce)return null;if(Array.isArray(Ce.fields)){for(const Re of Ce.fields)if(Re?.name==="player_ids")return Re}return null};let re=null;if(Array.isArray(C.fields))re=he(C);else if(Array.isArray(C.sections)){for(const Ce of C.sections)if(re=he(Ce),re)break}if(re){const Ce=JSON.parse(JSON.stringify(re));O.length>0&&(Ce.selectedOptions=O),Q.fields=[Ce]}return Q},[C,O]),F=u.useMemo(()=>B?{player_ids:B.player_ids??[]}:null,[B]),H=u.useMemo(()=>{if(!b)return null;const Q=b.status||"",he=Q?Q.charAt(0).toUpperCase()+Q.slice(1):"";return{...b,statusLabel:he,createdAt:os(b.createdAt),updatedAt:os(b.updatedAt)}},[b]),I=u.useMemo(()=>e==="my"?i?.id?d.filter(Q=>Q.created_by===i.id):[]:d,[d,e,i]),Y=e==="my"?"My Campaigns":"All Campaigns",P=e==="my"?"Back to my campaigns":"Back to all campaigns",W=u.useMemo(()=>!b||!Array.isArray(b.members)||!i?.id?!1:b.members.some(Q=>Q?.user_id===i.id&&Q?.role==="dm"),[b,i]),le=b?`/campaigns/${b.id}/access/bulk`:"",de=e!=="my"&&!!(b&&W)&&le?t.jsxs("div",{className:"campaign-access-cta",children:[t.jsxs("div",{children:[t.jsx("p",{className:"campaign-access-eyebrow",children:"Campaign Tools"}),t.jsxs("h3",{children:["Manage entity access for ",b.name]}),t.jsx("p",{className:"campaign-access-copy",children:"The Campaign Access Editor keeps changes scoped to this campaigns members."})]}),t.jsx("div",{className:"campaign-access-actions",children:t.jsx(Yt,{to:le,className:"btn outline",children:"Open Access Editor"})})]}):null;return o?l?p?t.jsx("p",{children:"Loading campaigns..."}):S?t.jsxs("p",{className:"error",children:["Error: ",S]}):y==="new"?t.jsx(us,{schema:eD,initialData:{},onSubmit:G,onCancel:z,showUpdateAction:!1}):y==="edit"&&b&&B?t.jsxs("div",{className:"campaign-editor",children:[de,t.jsxs("div",{className:"campaign-tabs",role:"tablist","aria-label":"Campaign editor tabs",children:[t.jsx("button",{type:"button",role:"tab","aria-selected":j==="details",className:`campaign-tab${j==="details"?" is-active":""}`,onClick:()=>E("details"),children:"Details"}),t.jsx("button",{type:"button",role:"tab","aria-selected":j==="membership",className:`campaign-tab${j==="membership"?" is-active":""}`,onClick:()=>E("membership"),children:"Membership"})]}),t.jsx("div",{className:"campaign-tab-panel",role:"tabpanel",children:j==="details"?t.jsx(us,{schema:D,initialData:B,onSubmit:U,onDelete:V,onCancel:z}):t.jsxs("div",{className:"campaign-membership",children:[t.jsx(us,{schema:$,initialData:F,onSubmit:U,onCancel:z}),t.jsx(KL,{campaignId:b.id,canManage:k(b),onMembersChanged:Q=>X(b.id,Q)})]})})]}):y==="view"&&b?t.jsxs("div",{className:"campaign-view-wrapper",children:[de,t.jsx(y1,{schema:lD,data:H||{},onClose:R,closeLabel:P,infoMessage:"You can view this campaign but only the owner or a system admin can make changes."})]}):t.jsx(Df,{data:I,columns:T,title:Y,extraActions:t.jsx("button",{type:"button",className:"btn submit",onClick:L,children:"+ New"}),onRowClick:Q=>{v(Q),g(k(Q)?"edit":"view"),n(`${A}/${Q.id}`)}}):t.jsx("p",{children:"Authenticating..."}):t.jsx("p",{children:"Restoring session..."})}const oD="New Character",cD=[{title:"Associations",columns:2,fields:[{key:"campaign_id",label:"Campaign",type:"select",optionsSource:"campaigns",required:!0,noOptionsMessage:"You do not have any campaigns available for character creation.",helpText:"Only campaigns you own or have been added to as a player are listed here."},{key:"user_id",label:"Player",type:"select",optionsSource:"users",optionLabelKey:"username",required:!0}]},{title:"Character Details",columns:2,fields:[{key:"name",label:"Name",type:"text",placeholder:"Character name",required:!0},{key:"level",label:"Level",type:"text",inputType:"number",placeholder:"1"},{key:"class",label:"Class",type:"text",placeholder:"Fighter, Wizard..."},{key:"race",label:"Race",type:"text",placeholder:"Elf, Human..."},{key:"alignment",label:"Alignment",type:"text",placeholder:"Neutral Good"},{key:"is_active",label:"Active Character",type:"checkbox"}]},{title:"Notes",columns:1,fields:[{key:"notes",label:"Notes",type:"textarea",rows:6,placeholder:"Backstory, hooks, etc."}]}],uD={title:oD,sections:cD},dD="Edit Character",fD=[{title:"Associations",columns:2,fields:[{key:"campaign_id",label:"Campaign",type:"select",optionsSource:"campaigns",required:!0},{key:"user_id",label:"Player",type:"select",optionsSource:"users",optionLabelKey:"username",required:!0}]},{title:"Character Details",columns:2,fields:[{key:"name",label:"Name",type:"text",required:!0},{key:"level",label:"Level",type:"text",inputType:"number"},{key:"class",label:"Class",type:"text"},{key:"race",label:"Race",type:"text"},{key:"alignment",label:"Alignment",type:"text"},{key:"is_active",label:"Active Character",type:"checkbox"}]},{title:"Notes",columns:1,fields:[{key:"notes",label:"Notes",type:"textarea",rows:6}]}],mD={title:dD,sections:fD},nc=(e={})=>({id:e.id,name:e.name||"",race:e.race||"",class:e.class||"",level:e.level??1,alignment:e.alignment||"",notes:e.notes||"",is_active:e.is_active??!0,campaign_id:e.campaign_id||"",user_id:e.user_id||""}),FS=(e={})=>{const n=Number(e.level);return{name:e.name,race:e.race||null,class:e.class||null,level:Number.isNaN(n)?1:n,alignment:e.alignment||null,notes:e.notes||null,is_active:!!e.is_active,campaign_id:e.campaign_id||null,user_id:e.user_id||null}};function Gr({scope:e="my"}){const n=_n(),{id:s}=Ka(),{token:i,sessionReady:l,user:o}=un(),{selectedCampaign:d,selectedCampaignId:f,setSelectedCampaignId:p}=wn(),[h,y]=u.useState([]),[g,b]=u.useState(!1),[v,S]=u.useState(null),[N,j]=u.useState("list"),[E,A]=u.useState(null),[M,_]=u.useState(null),[T,k]=u.useState(""),C=u.useMemo(()=>`/characters/${e}`,[e]),L=u.useMemo(()=>!d||!Array.isArray(d.members)||!o?.id?!1:d.members.some(I=>I?.user_id===o.id&&I?.role==="player"),[d,o]),z=u.useMemo(()=>!d||!Array.isArray(d.members)||!o?.id?!1:d.members.some(I=>I?.user_id===o.id&&I?.role==="dm"),[d,o]),G=u.useMemo(()=>{switch(e){case"my":return"My Characters";case"others":return d?.name?`All Characters  ${d.name}`:"All Characters";case"all":return"All Characters";case"companions":return d?.name?`My Companions  ${d.name}`:"My Companions";default:return"Characters"}},[e,d]),U=e==="my"||o?.role==="system_admin";u.useEffect(()=>{e==="all"&&o&&o.role!=="system_admin"&&n("/characters/my",{replace:!0})},[e,o,n]),u.useEffect(()=>{j("list"),A(null),_(null),k("")},[e]),u.useEffect(()=>{if(!s){N!=="new"&&j("list"),A(null),_(null);return}const I=h.find(P=>String(P.id)===s);if(!I){g||n(C,{replace:!0});return}if(!(I.isOwned||o?.role==="system_admin")){n(C,{replace:!0});return}A(I.formValues||nc(I)),_(I.id),j("edit")},[s,h,o,n,C,g,N]);const X=u.useCallback(async()=>{if(i&&!(e==="all"&&o&&o.role!=="system_admin")){if(S(null),e==="companions"){if(!f){y([]),k("Select a campaign to view your companions. Use Go to Campaign from My Characters to set one."),b(!1);return}if(!L){y([]),k("You must be a player in the selected campaign to view companions."),b(!1);return}}if(e==="others"){if(!f){y([]),k("Select a campaign to view all characters. Use Go to Campaign from My Characters to set one."),b(!1);return}if(!z){y([]),k("You must be a DM in the selected campaign to view all characters."),b(!1);return}}k(""),b(!0);try{const I={scope:e};(e==="companions"||e==="others"||e==="my"&&f)&&(I.campaign_id=f);const Y=await Cs(I),P=(Y?.data||Y||[]).map(W=>({...W,playerName:W.player?.username||"",campaignName:W.campaign?.name||"",status:W.is_active?"Active":"Inactive",formValues:nc(W),isOwned:W.user_id===o?.id}));y(P)}catch(I){console.error(" Failed to load characters:",I),S(I.message)}finally{b(!1)}}},[i,e,o,f,L,z]);u.useEffect(()=>{l&&i&&X()},[l,i,X]);const V=e==="my"&&!f,R=u.useMemo(()=>[{key:"name",label:"Name"},{key:"class",label:"Class"},{key:"level",label:"Level"},{key:"race",label:"Race"},{key:"alignment",label:"Alignment"},{key:"playerName",label:"Player"},{key:"campaignName",label:"Campaign"},{key:"status",label:"Status"}],[]),B=u.useMemo(()=>V?[...R,{key:"campaignAction",label:"Actions",render:I=>I.campaign_id?t.jsx("button",{type:"button",className:"btn secondary compact",onClick:Y=>{Y.stopPropagation(),p(String(I.campaign_id))},children:"Go to Campaign"}):"No campaign"}]:R,[R,V,p]),D=()=>{U&&(n(C),j("new"),A(null),_(null))},O=()=>{j("list"),A(null),_(null),n(C)},$=async I=>{try{return await MR(FS(I)),j("list"),A(null),n(C),await X(),!0}catch(Y){return alert(`Error creating character: ${Y.message}`),!1}},F=async(I,Y={})=>{const{stayOnPage:P=!1}=Y;if(!M)return!1;try{const W=await kR(M,FS(I)),le=W?.data||W||{id:M};if(await X(),P){const K=nc(le&&typeof le=="object"?le:{...I,id:M});return A(K),{message:"Character updated successfully."}}return j("list"),A(null),_(null),n(C),!0}catch(W){return alert(`Error updating character: ${W.message}`),!1}},H=async()=>{if(!M||!confirm("Delete this character?"))return!1;try{return await RR(M),j("list"),A(null),_(null),n(C),await X(),!0}catch(I){return alert(`Error deleting character: ${I.message}`),!1}};return l?i?g?t.jsx("p",{children:"Loading characters..."}):v?t.jsx("p",{className:"error",children:v}):N==="new"?t.jsx(us,{schema:uD,initialData:{level:1,is_active:!0,user_id:o?.role==="system_admin"?"":o?.id||""},onSubmit:$,onCancel:O,showUpdateAction:!1}):N==="edit"?t.jsx(us,{schema:mD,initialData:E||{},onSubmit:F,onCancel:O,onDelete:H}):N==="list"&&T?t.jsx("div",{className:"empty-state",children:t.jsx("p",{children:T})}):t.jsx(Df,{data:h,columns:B,title:G,extraActions:U?t.jsx("button",{type:"button",className:"btn submit",onClick:D,children:"+ New"}):null,onRowClick:I=>{(I.isOwned||o?.role==="system_admin")&&(n(`${C}/${I.id}`),A(I.formValues||nc(I)),_(I.id),j("edit"))}}):t.jsx("p",{children:"Authenticating..."}):t.jsx("p",{children:"Restoring session..."})}function Ff(){const e=Vs();if(!e)throw new Error("Missing or invalid token");return{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}async function zf(e,n="request"){if(e.status===401)throw new Error("Unauthorized");if(!e.ok){const s=await e.text();throw new Error(`Failed to ${n}: ${s}`)}return e.json()}async function Fg(){const e=await fetch(`${sn}/users`,{headers:Ff()});return zf(e,"fetch users")}async function hD(e){const n=await fetch(`${sn}/users`,{method:"POST",headers:Ff(),body:JSON.stringify(e)});return zf(n,"create user")}async function pD(e,n){const s=await fetch(`${sn}/users/${e}`,{method:"PUT",headers:Ff(),body:JSON.stringify(n)});return zf(s,"update user")}async function yD(e){const n=await fetch(`${sn}/users/${e}`,{method:"DELETE",headers:Ff()});return zf(n,"delete user")}const gD="Create New User",bD=[{title:"Account Details",columns:2,fields:[{key:"username",label:"Username",type:"text",placeholder:"Enter username"},{key:"email",label:"Email",type:"text",inputType:"email",placeholder:"user@example.com"},{key:"password",label:"Password",type:"text",inputType:"password",placeholder:"Choose a secure password"},{key:"role",label:"Role",type:"select",options:[{value:"user",label:"User"},{value:"system_admin",label:"System Admin"}],default:"user"}]}],xD={title:gD,sections:bD},vD="Edit User",SD=[{title:"Account Details",columns:2,fields:[{key:"username",label:"Username",type:"text"},{key:"email",label:"Email",type:"text",inputType:"email"},{key:"role",label:"Role",type:"select",options:[{value:"user",label:"User"},{value:"system_admin",label:"System Admin"}]},{key:"password",label:"New Password",type:"text",inputType:"password",placeholder:"Leave blank to keep current password"}]}],wD={title:vD,sections:SD};function ND(){const{user:e,token:n,sessionReady:s}=un(),[i,l]=u.useState([]),[o,d]=u.useState(!1),[f,p]=u.useState(null),[h,y]=u.useState("list"),[g,b]=u.useState(null),v=u.useCallback(async()=>{if(!(!n||e?.role!=="system_admin")){d(!0),p(null);try{const _=await Fg();l(_?.data||_||[])}catch(_){console.error(" Failed to load users:",_),p(_.message)}finally{d(!1)}}},[n,e?.role]);u.useEffect(()=>{s&&n&&e?.role==="system_admin"&&v()},[s,n,e?.role,v]);const S=[{key:"username",label:"Username"},{key:"email",label:"Email"},{key:"role",label:"Role"},{key:"createdAt",label:"Created"}],N=()=>{b(null),y("new")},j=()=>{y("list"),b(null)},E=async _=>{try{const T={username:_.username,email:_.email,password:_.password,role:_.role||"user"};return await hD(T),y("list"),b(null),await v(),!0}catch(T){return alert(`Error creating user: ${T.message}`),!1}},A=async(_,T={})=>{const{stayOnPage:k=!1}=T;if(!g?.id)return!1;try{const C={username:_.username,email:_.email,role:_.role};_.password&&(C.password=_.password);const z=(await pD(g.id,C))?.data||{...g,...C};return await v(),k?(b(z),{message:"User updated successfully."}):(y("list"),b(null),!0)}catch(C){return alert(`Error updating user: ${C.message}`),!1}},M=async()=>{if(!g?.id||!confirm(`Delete user "${g.username}"?`))return!1;try{return await yD(g.id),y("list"),b(null),await v(),!0}catch(_){return alert(`Error deleting user: ${_.message}`),!1}};return s?n?!e||e.role!=="system_admin"?t.jsx("p",{className:"error",children:"Access denied. Admins only."}):o?t.jsx("p",{children:"Loading users..."}):f?t.jsxs("p",{className:"error",children:["Error: ",f]}):h==="new"?t.jsx(us,{schema:xD,initialData:{},onSubmit:E,onCancel:j,showUpdateAction:!1}):h==="edit"?t.jsx(us,{schema:wD,initialData:g||{},onSubmit:A,onCancel:j,onDelete:M}):t.jsx(Df,{data:i,columns:S,title:"Users",extraActions:t.jsx("button",{type:"button",className:"btn submit",onClick:N,children:"+ New"}),onRowClick:_=>{b(_),y("edit")}}):t.jsx("p",{children:"Authenticating..."}):t.jsx("p",{children:"Restoring session..."})}function jD(){const{login:e}=un(),n=_n(),[s,i]=u.useState(""),[l,o]=u.useState(""),[d,f]=u.useState(""),[p,h]=u.useState(!1),y=async g=>{g.preventDefault(),f(""),h(!0);try{await e(s,l)?n("/"):f("Invalid username or password")}catch{f("Login failed. Please try again.")}finally{h(!1)}};return t.jsx("div",{className:"login-page",children:t.jsxs("div",{className:"login-card",children:[t.jsx("h1",{className:"login-title",children:"GameDB"}),t.jsx("p",{className:"login-subtitle",children:"Sign in to your account"}),t.jsxs("form",{onSubmit:y,children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{children:"Username"}),t.jsx("input",{type:"text",value:s,onChange:g=>i(g.target.value),placeholder:"Enter username",required:!0})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{children:"Password"}),t.jsx("input",{type:"password",value:l,onChange:g=>o(g.target.value),placeholder:"Enter password",required:!0})]}),d&&t.jsx("p",{className:"error-msg",children:d}),t.jsx("button",{type:"submit",disabled:p,children:p?"Signing in...":"Sign In"})]})]})})}const ED=e=>kt.get(`/entity-relationships?worldId=${e}`),_D=e=>kt.get(`/entity-relationships/${e}`),g1=e=>kt.get(`/entity-relationships/entity/${e}`),b1=e=>kt.post("/entity-relationships",e),CD=(e,n)=>kt.patch(`/entity-relationships/${e}`,n),AD=e=>kt.delete(`/entity-relationships/${e}`),x1=e=>kt.get(`/entity-types/${e}/fields`),TD=(e,n)=>kt.post(`/entity-types/${e}/fields`,n),MD=(e,n)=>kt.patch(`/entity-type-fields/${e}`,n),kD=e=>kt.delete(`/entity-type-fields/${e}`),RD=[{value:"global",label:"Global"},{value:"selective",label:"Selective"},{value:"hidden",label:"Hidden"}],ID=[{value:"global",label:"Global"},{value:"selective",label:"Selective"},{value:"hidden",label:"Hidden"},{value:"owner_only",label:"Owner only"}],Ai=(e,n)=>`${e}-${n}`;function zg({canEdit:e,accessSettings:n,accessOptions:s,accessOptionsLoading:i,accessSaving:l,onSettingChange:o,idPrefix:d="entity-access"}){const f=!e||l,p=Ai(d,"read-mode"),h=Ai(d,"read-campaigns"),y=Ai(d,"read-users"),g=Ai(d,"read-characters"),b=Ai(d,"write-mode"),v=Ai(d,"write-campaigns"),S=Ai(d,"write-users");return t.jsxs("div",{className:"entity-access-columns",children:[t.jsxs("div",{className:"entity-access-column",children:[t.jsx("h3",{children:"Read access"}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:p,children:"Visibility"}),t.jsx("select",{id:p,value:n.readMode,onChange:N=>o("readMode",N.target.value),disabled:f,children:RD.map(N=>t.jsx("option",{value:N.value,children:N.label},N.value))})]}),n.readMode==="selective"&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:h,children:"Campaigns"}),t.jsx(zs,{inputId:h,selected:n.readCampaigns,options:s.campaigns||[],onChange:N=>o("readCampaigns",N),placeholder:"Select campaigns...",noOptionsMessage:i?"Loading campaigns...":"No campaigns available for this world.",loading:i,disabled:f}),t.jsx("p",{className:"help-text",children:"Members of selected campaigns can view this entity."})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:y,children:"Users"}),t.jsx(zs,{inputId:y,selected:n.readUsers,options:s.users||[],onChange:N=>o("readUsers",N),placeholder:"Select users...",noOptionsMessage:i?"Loading users...":"No eligible users found for this world.",loading:i,disabled:f}),t.jsx("p",{className:"help-text",children:"Choose players who have characters in this world."})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:g,children:"Characters"}),t.jsx(zs,{inputId:g,selected:n.readCharacters,options:s.characters||[],onChange:N=>o("readCharacters",N),placeholder:"Select characters...",noOptionsMessage:i?"Loading characters...":"No characters available for this world.",loading:i,disabled:f}),t.jsx("p",{className:"help-text",children:"Grant visibility to specific characters regardless of campaign."})]})]})]}),t.jsxs("div",{className:"entity-access-column",children:[t.jsx("h3",{children:"Write access"}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:b,children:"Write"}),t.jsx("select",{id:b,value:n.writeMode,onChange:N=>o("writeMode",N.target.value),disabled:f,children:ID.map(N=>t.jsx("option",{value:N.value,children:N.label},N.value))})]}),n.writeMode==="selective"&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:v,children:"Campaigns"}),t.jsx(zs,{inputId:v,selected:n.writeCampaigns,options:s.campaigns||[],onChange:N=>o("writeCampaigns",N),placeholder:"Select campaigns...",noOptionsMessage:i?"Loading campaigns...":"No campaigns available for this world.",loading:i,disabled:f}),t.jsx("p",{className:"help-text",children:"Dungeon Masters of these campaigns can edit this entity."})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:S,children:"Users"}),t.jsx(zs,{inputId:S,selected:n.writeUsers,options:s.users||[],onChange:N=>o("writeUsers",N),placeholder:"Select users...",noOptionsMessage:i?"Loading users...":"No eligible users found for this world.",loading:i,disabled:f}),t.jsx("p",{className:"help-text",children:"Grant edit access to specific players with characters here."})]})]})]})]})}const dd=e=>!e||typeof e!="string"?"":e.trim(),zS=e=>Array.isArray(e?.data)?e.data:Array.isArray(e)?e:[];async function Bg(e){if(!e)return{campaigns:[],users:[],characters:[]};const[n,s]=await Promise.all([Vc({world_id:e}),Cs({world_id:e})]),l=zS(n).map(p=>({value:String(p.id),label:p.name||"Untitled campaign"})),o=zS(s),d=new Map,f=new Map;return o.forEach(p=>{const h=p?.user_id||p?.player?.id;if(!h)return;const y=String(h);if(d.has(y))return;const g=p?.player||{},b=dd(g.username),v=dd(g.email);let S=b||v||`User ${y.slice(0,8)}`;b&&v&&b!==v&&(S=`${b} (${v})`),d.set(y,{value:y,label:S});const N=p?.id||p?.character_id;if(!N)return;const j=dd(p.name)||"Unnamed character",E=dd(p?.campaign?.name||p?.campaign_name||""),A=E?`${j}  ${E}`:j;f.set(String(N),{value:String(N),label:A})}),{campaigns:l,users:Array.from(d.values()),characters:Array.from(f.values())}}const pp=(e,n,s)=>Number.isNaN(e)?n:Math.min(Math.max(e,n),s),LD=220,DD=3;function v1({src:e,size:n=LD,onCropChange:s,className:i="",zoomLabel:l="Zoom"}){const[o,d]=u.useState({width:0,height:0}),[f,p]=u.useState(1),[h,y]=u.useState({x:0,y:0}),[g,b]=u.useState(!1),v=u.useRef({x:0,y:0}),S=u.useRef(null),N=u.useRef(null);u.useEffect(()=>{if(!e){d({width:0,height:0});return}let U=!1;const X=new Image;return X.onload=()=>{U||d({width:X.naturalWidth,height:X.naturalHeight})},X.onerror=()=>{U||d({width:0,height:0})},X.src=e,()=>{U=!0}},[e]);const j=u.useMemo(()=>{if(!o.width||!o.height)return 1;const U=n/o.width,X=n/o.height;return Math.max(U,X)},[o,n]);u.useEffect(()=>{if(!o.width||!o.height)return;p(j);const U=o.width*j,X=o.height*j;y({x:(n-U)/2,y:(n-X)/2})},[o,j,n]);const E=u.useCallback((U,X=f)=>{if(!o.width||!o.height)return U;const V=o.width*X,R=o.height*X,B=Math.min(0,n-V),D=Math.max(0,n-V),O=Math.min(0,n-R),$=Math.max(0,n-R);return{x:pp(U.x,B,D),y:pp(U.y,O,$)}},[o,f,n]),A=U=>{if(!e)return;U.preventDefault(),N.current?.setPointerCapture?.(U.pointerId),S.current=U.pointerId,v.current={x:U.clientX,y:U.clientY},b(!0)},M=U=>{if(!g)return;U.preventDefault();const X=U.clientX-v.current.x,V=U.clientY-v.current.y;v.current={x:U.clientX,y:U.clientY},y(R=>E({x:R.x+X,y:R.y+V}))},_=u.useCallback(()=>{const U=N.current;S.current!==null&&(U?.releasePointerCapture?.(S.current),S.current=null),b(!1)},[]),T=j*DD,k=Math.max(j/50,.01),C=T-j>.001,L=U=>{const X=pp(Number(U.target.value),j,T);p(X),y(V=>E(V,X))};u.useEffect(()=>{typeof s=="function"&&(!o.width||!o.height||!e||s({offset:h,scale:f,containerSize:n,naturalWidth:o.width,naturalHeight:o.height}))},[h,f,n,o,s,e]),u.useEffect(()=>{const U=N.current;if(!U)return;const X=()=>_(),V=()=>_();return U.addEventListener("pointerup",X),U.addEventListener("pointerleave",V),U.addEventListener("pointercancel",V),()=>{U.removeEventListener("pointerup",X),U.removeEventListener("pointerleave",V),U.removeEventListener("pointercancel",V)}},[_]);const z=o.width*f,G=o.height*f;return t.jsxs("div",{className:`image-cropper ${i}`.trim(),children:[t.jsxs("div",{className:`image-cropper__frame${g?" is-dragging":""}`,ref:N,style:{width:n,height:n},onPointerDown:A,onPointerMove:M,role:"presentation",children:[e?t.jsx("img",{src:e,alt:"Selected artwork preview",draggable:!1,style:{width:z,height:G,transform:`translate(${h.x}px, ${h.y}px)`}}):t.jsx("div",{className:"image-cropper__empty",children:"Unable to preview image"}),t.jsx("div",{className:"image-cropper__outline","aria-hidden":"true"}),t.jsx("div",{className:"image-cropper__instructions","aria-hidden":"true",children:"Drag to reposition"})]}),C?t.jsxs("label",{className:"image-cropper__zoom",children:[t.jsx("span",{children:l}),t.jsx("input",{type:"range",min:j,max:T,step:k,value:f,onChange:L})]}):t.jsx("p",{className:"image-cropper__zoom image-cropper__zoom--disabled",children:"Zoom unavailable for this image"})]})}const S1=async(e,n,s={})=>{if(!e||!n)return e;const{offset:i,scale:l,containerSize:o,naturalWidth:d,naturalHeight:f}=n;if(!i||!l||!o||!d||!f||typeof createImageBitmap!="function")return e;try{const p=await createImageBitmap(e),h=d?p.width/d:1,y=f?p.height/f:1,g=(h+y)/2||1,b=l*g,v=o/b,S=o/b,N=(0-i.x)/l*g,j=(0-i.y)/l*g,E=Math.min(Math.max(v,1),p.width),A=Math.min(Math.max(S,1),p.height),M=p.width-E,_=p.height-A,T=Math.min(Math.max(N,0),Math.max(M,0)),k=Math.min(Math.max(j,0),Math.max(_,0)),C=document.createElement("canvas");C.width=Math.round(E),C.height=Math.round(A),C.getContext("2d").drawImage(p,T,k,E,A,0,0,C.width,C.height),p.close?.();const z=s.mimeType||e.type||"image/jpeg",G=s.quality||(z==="image/png"?void 0:.92),U=await new Promise((V,R)=>{C.toBlob(B=>{B?V(B):R(new Error("Unable to crop image"))},z,G)}),X=(()=>{if(!e.name)return"cropped-image";const V=z==="image/png"?".png":".jpg";return e.name.toLowerCase().endsWith(V)?e.name:`${e.name.includes(".")?e.name.slice(0,e.name.lastIndexOf(".")):e.name}${V}`})();return new File([U],X,{type:z})}catch(p){return console.warn(" Unable to crop image, using original selection",p),e}},OD=[{value:"hidden",label:"Hidden"},{value:"partial",label:"Partial"},{value:"visible",label:"Visible"}],$D=new Set(["image/png","image/jpeg","image/jpg"]),FD=2*1024*1024,zD=new Set(["global","selective","hidden"]),BD=new Set(["global","selective","hidden","owner_only"]),fd=()=>({campaigns:[],users:[],characters:[]}),yp=(e="")=>{const n=String(e||"").trim();return n?{readMode:"selective",readCampaigns:[n],readUsers:[],readCharacters:[],writeMode:"selective",writeCampaigns:[n],writeUsers:[]}:{readMode:"global",readCampaigns:[],readUsers:[],readCharacters:[],writeMode:"global",writeCampaigns:[],writeUsers:[]}},UD=e=>Number.isFinite(e)?e>=1024*1024?`${(e/(1024*1024)).toFixed(1)} MB`:e>=1024?`${(e/1024).toFixed(1)} KB`:`${e} bytes`:"",qD=e=>{const n=e?.options?.choices;return!Array.isArray(n)||n.length===0?[]:n.map((s,i)=>{if(s==null)return null;if(typeof s=="object"){const o=s.value??s.id??s.key??s.slug??`choice-${i}`,d=s.label??s.name??s.title??s.display??o;return o==null?null:{value:o,label:String(d??o)}}const l=String(s);return{value:l,label:l}}).filter(Boolean)},PD=e=>{if(!e)return"";if(e instanceof Date)return e.toISOString().slice(0,10);if(typeof e=="string"){const s=e.trim();if(!s)return"";if(/^\d{4}-\d{2}-\d{2}/.test(s))return s.slice(0,10);const i=new Date(s);return Number.isNaN(i.getTime())?"":i.toISOString().slice(0,10)}const n=new Date(e);return Number.isNaN(n.getTime())?"":n.toISOString().slice(0,10)},HD=(e,n)=>{if(e==null)return"";switch(n?.dataType||n?.data_type){case"boolean":{if(typeof e=="boolean")return e?"true":"false";if(typeof e=="number")return e!==0?"true":"false";if(typeof e=="string"){const i=e.trim().toLowerCase();if(i==="true"||i==="false")return i}return""}case"number":return e===""?"":String(e);case"date":return PD(e);case"entity_reference":case"location_reference":case"reference":{if(typeof e=="object"&&e!==null){const i=e.id??e.value??e.entity_id??e.entityId??null;if(i!=null)return String(i)}return String(e)}default:return String(e)}},VD=(e,n)=>{const s=n?.dataType||n?.data_type;if(e!=null){if(typeof e=="string"){const i=e.trim();if(s!=="boolean"&&i==="")return"";e=i}switch(s){case"number":{if(e==="")return"";const i=Number(e);return Number.isNaN(i)?e:i}case"boolean":{if(typeof e=="boolean")return e;if(typeof e=="number")return e!==0;if(typeof e=="string"){const i=e.toLowerCase();if(i==="true")return!0;if(i==="false")return!1}return e}case"reference":return typeof e=="string"?e.trim():e;default:return e}}},BS="entity-form-advanced-open",YD=e=>{if(e==null)return"";if(typeof e=="object")try{return JSON.stringify(e)}catch{return""}return String(e)},GD=e=>{const n=e.trim();if(n.length===0)return"";if(n==="true")return!0;if(n==="false")return!1;const s=n[0],i=n[n.length-1];if(s==="{"&&i==="}"||s==="["&&i==="]")try{return JSON.parse(n)}catch{return e}return e};function w1({worldId:e,entityId:n,onCancel:s,onSaved:i,formId:l="entity-form",onStateChange:o,hideActions:d=!1,selectedEntityTypeId:f="",activeView:p="details",onViewChange:h,defaultCampaignId:y=""}){const g=!!n,b=u.useRef(0),v=u.useRef(null),S=u.useRef(null),N=u.useRef(null),j=u.useRef(String(y??"")),E=u.useCallback((ae="",Ke="")=>(b.current+=1,{id:b.current,key:ae,value:Ke}),[b]),[A,M]=u.useState([]),[_,T]=u.useState(!1),[k,C]=u.useState(!1),[L,z]=u.useState(!1),[G,U]=u.useState(!1),[X,V]=u.useState(""),[R,B]=u.useState({name:"",description:"",entityTypeId:f||"",visibility:"visible"}),[D,O]=u.useState(()=>(b.current=0,[E()])),[$,F]=u.useState([]),[H,I]=u.useState({}),[Y,P]=u.useState({}),[W,le]=u.useState(()=>yp(y)),[K,de]=u.useState(()=>fd()),[Q,he]=u.useState(!1),[re,Ce]=u.useState(""),Re=u.useRef(!1),[ue,se]=u.useState(null),[Le,be]=u.useState(null),[De,Me]=u.useState(null),[mt,ht]=u.useState(""),[Ct,At]=u.useState(""),[we,st]=u.useState(!1),[lt,Fe]=u.useState(!1),[Xe,dt]=u.useState(()=>{if(typeof window>"u")return!1;try{return window.sessionStorage?.getItem(BS)==="true"}catch(ae){return console.warn(" Unable to read advanced options preference",ae),!1}}),ie=u.useMemo(()=>D.some(ae=>ae.key.trim()!==""||ae.value.trim()!==""),[D]),ee=u.useCallback(ae=>{if(ae&&typeof URL<"u")try{URL.revokeObjectURL(ae)}catch(Ke){console.warn("Unable to revoke preview URL",Ke)}},[]),ce=u.useCallback(()=>{be(null),Me(null),At(""),ht(ae=>(ee(ae),"")),S.current&&(S.current.value=""),N.current&&(N.current.value="")},[ee]);u.useEffect(()=>()=>{ee(mt)},[ee,mt]);const fe=u.useCallback(ae=>{const Ke=ae.target.files?.[0];if(Ke){if(!$D.has(Ke.type)){At("Only PNG or JPG images are allowed."),ae.target.value="";return}if(Ke.size>FD){At("Image must be smaller than 2 MB."),ae.target.value="";return}At(""),be(Ke),Me(null),ht(ot=>(ee(ot),URL.createObjectURL(Ke)))}},[ee]),qe=u.useCallback(()=>{!n||we||lt||k||S.current?.click()},[n,lt,we,k]),Pe=u.useCallback(ae=>{if(!ae){se(null);return}const Ke=ae.imageData??ae.image_data??null,ot=ae.imageMimeType??ae.image_mime_type??null;se(Ke&&ot?{imageData:Ke,imageMimeType:ot}:null)},[]),Be=u.useCallback(async()=>{if(!n)return null;const ae=await Hs(n),Ke=Ya(ae);return Ke&&Pe(Ke),Ke},[Pe,n]),Te=u.useCallback(async()=>{if(!(!n||!Le)){st(!0),At("");try{const ae=De?await S1(Le,De):Le;await Bj(n,ae),await Be(),ce()}catch(ae){At(ae.message||"Failed to upload image")}finally{st(!1)}}},[n,Le,De,Be,ce]),gt=u.useCallback(async()=>{if(!(!n||we||lt)){At(""),Fe(!0);try{await Uj(n),await Be(),ce()}catch(ae){At(ae.message||"Failed to remove image")}finally{Fe(!1)}}},[n,lt,we,Be,ce]),jt=u.useMemo(()=>{const ae="PNG or JPG up to 2 MB.";return Le?`${ae} Selected: ${Le.name} (${UD(Le.size)})`:ae},[Le]),Mt=Le?t.jsxs("div",{className:"entity-image-actions",children:[t.jsx("button",{type:"button",className:"btn submit",onClick:Te,disabled:we,children:we?"Uploading":"Save Image"}),t.jsx("button",{type:"button",className:"btn secondary",onClick:ce,disabled:we,children:"Cancel"})]}):null,tt=u.useCallback(ae=>ae.length>0?ae:[E()],[E]),ft=u.useCallback(ae=>{if(b.current=0,!ae||typeof ae!="object"||Array.isArray(ae))return[E()];const Ke=Object.entries(ae);return Ke.length===0?[E()]:Ke.map(([ot,St])=>E(ot,YD(St)))},[E]);u.useEffect(()=>{let ae=!1;return(async()=>{if(ae||V(""),!e){M([]),T(!1);return}T(!0);try{const ot=await wr({worldId:e}),St=Array.isArray(ot)?ot:Array.isArray(ot?.data)?ot.data:[];if(!ae){const me=St.map(nt=>{const Ge=nt?.id||nt?.entity_type_id||nt?.entityTypeId||"";return Ge?{id:Ge,name:nt?.name||nt?.label||nt?.title||"Untitled"}:null}).filter(Boolean);M(me)}}catch(ot){ae||(V(ot.message||"Failed to load entity types"),M([]))}finally{ae||T(!1)}})(),()=>{ae=!0}},[e]),u.useEffect(()=>{if(!e){B(ae=>({...ae,entityTypeId:""}));return}B(ae=>!ae.entityTypeId||A.some(ot=>ot.id===ae.entityTypeId)?ae:{...ae,entityTypeId:""})},[e,A]),u.useEffect(()=>{let ae=!1;const Ke=()=>{b.current=0,B({name:"",description:"",entityTypeId:f||"",visibility:"visible"}),O([E()]),F([]),I({}),V(""),h?.("details");const St=yp(j.current);le(St),Re.current=!1,de(fd()),Ce(""),se(null),ce()};if(!g)return Ke(),C(!1),v.current=null,()=>{};const ot=async()=>{C(!0),V(""),At("");try{const St=await Hs(n),me=Ya(St);if(!me)throw new Error("Entity not found");if(!ae){const nt=ft(me.metadata);B({name:me.name||"",description:me.description||"",entityTypeId:me.entity_type_id||me.entityType?.id||"",visibility:me.visibility||"visible"}),O(tt(nt)),Pe(me),ce()}}catch(St){ae||V(St.message||"Failed to load entity")}finally{ae||C(!1)}};return v.current!==n&&(se(null),ce(),v.current=n),ot(),()=>{ae=!0}},[n,g,tt,E,ft,f,h,Pe,ce]);const Rt=ae=>Ke=>{const{value:ot}=Ke.target;B(St=>({...St,[ae]:ot}))},Ft=(ae,Ke)=>ot=>{const{value:St}=ot.target;O(me=>me.map(nt=>nt.id===ae?{...nt,[Ke]:St}:nt))},Zt=()=>{O(ae=>[...ae,E()])},Tt=ae=>{O(Ke=>tt(Ke.filter(ot=>ot.id!==ae)))},We=ae=>Ke=>{const{value:ot}=Ke.target;I(St=>({...St,[ae]:ot}))},it=u.useCallback((ae,Ke)=>{Ce(""),le(ot=>{const St={...ot};if(ae==="readMode"||ae==="writeMode"){const me=typeof Ke=="string"?Ke.trim().toLowerCase():"global";return ae==="readMode"?(St.readMode=zD.has(me)?me:"global",St.readMode!=="selective"&&(St.readCampaigns=[],St.readUsers=[],St.readCharacters=[])):(St.writeMode=BD.has(me)?me:"global",St.writeMode!=="selective"&&(St.writeCampaigns=[],St.writeUsers=[])),St}return["readCampaigns","readUsers","readCharacters","writeCampaigns","writeUsers"].includes(ae)?(St[ae]=Array.isArray(Ke)?Ke.map(me=>String(me).trim()).filter(Boolean):[],St):(St[ae]=Ke,St)})},[]);u.useEffect(()=>{Re.current=!1,de(fd()),Ce("")},[e]),u.useEffect(()=>{if(g)return;const ae=String(y??"");if(ae===j.current)return;const Ke=yp(ae);j.current=ae,le(Ke)},[y,g]),u.useEffect(()=>{if(p!=="access"||!e||Re.current)return;let ae=!1;return he(!0),Ce(""),(async()=>{try{const ot=await Bg(e);if(ae)return;de({campaigns:ot.campaigns??[],users:ot.users??[],characters:ot.characters??[]}),Re.current=!0}catch(ot){if(ae)return;de(fd()),Ce(ot.message||"Failed to load access options"),Re.current=!1}finally{ae||he(!1)}})(),()=>{ae=!0}},[p,e]);const bt=u.useCallback(()=>{dt(ae=>{const Ke=!ae;try{typeof window<"u"&&window.sessionStorage?.setItem(BS,Ke?"true":"false")}catch(ot){console.warn(" Unable to persist advanced options preference",ot)}return Ke})},[]),oe=async ae=>{if(ae.preventDefault(),!e&&!g){V("A world must be selected before creating an entity.");return}const Ke=R.name.trim();if(!Ke){V("Name is required.");return}const ot=R.entityTypeId||f||"";if(!ot){V("Entity type is required.");return}const St=g&&R.visibility||"visible";if(g&&!OD.some(vt=>vt.value===St)){V("Invalid visibility selected.");return}let me={};if(g)D.forEach(({key:vt,value:ct})=>{const Nt=vt.trim();Nt&&(me[Nt]=GD(ct))});else if($.length>0){const vt={};for(const ct of $){const Nt=ct.name,Ye=H[Nt],Je=Ye!=null&&(typeof Ye!="string"||Ye.trim()!=="");if(ct.required&&!Je){const Et=ct.label||ct.name;V(`${Et} is required.`);return}Je&&(vt[Nt]=VD(Ye,ct))}me=vt}const nt=R.description?R.description.trim():"",Ge={name:Ke,description:nt,visibility:St,metadata:me,entity_type_id:ot};try{if(U(!0),V(""),g)await bg(n,Ge);else{const vt={read_access:W.readMode,write_access:W.writeMode,read_campaign_ids:W.readMode==="selective"?W.readCampaigns:[],read_user_ids:W.readMode==="selective"?W.readUsers:[],read_character_ids:W.readMode==="selective"?W.readCharacters:[],write_campaign_ids:W.writeMode==="selective"?W.writeCampaigns:[],write_user_ids:W.writeMode==="selective"?W.writeUsers:[]};await gg({...Ge,...vt,world_id:e})}i?.(g?"edit":"create")}catch(vt){V(vt.message||"Failed to save entity")}finally{U(!1)}},Ee=_||k||L,Se=!g,Ve=Se&&p==="access";u.useEffect(()=>{if(h){if(!Se&&p!=="details"){h("details");return}Ve&&!e&&h("details")}},[p,Se,Ve,h,e]),u.useEffect(()=>{if(!o)return;o({mode:g?"edit":"create",saving:G,isBusy:Ee,submitLabel:G?"Saving...":g?"Save Changes":"Create Entity",submitDisabled:G||Ee,cancelDisabled:G,accessButtonVisible:Se,accessButtonDisabled:G||Ee||!e&&!Ve})},[o,g,G,Ee,Se,Ve,e]),u.useEffect(()=>{g||B(ae=>({...ae,entityTypeId:f||""}))},[g,f]);const xe=u.useMemo(()=>g?"":R.entityTypeId?R.entityTypeId:f||"",[g,f,R.entityTypeId]);u.useEffect(()=>{if(g){F([]),I({}),P({});return}if(!xe){F([]),I({}),P({});return}let ae=!1;return(async()=>{z(!0);try{const ot=await x1(xe),St=Array.isArray(ot)?ot:Array.isArray(ot?.data)?ot.data:[];if(ae)return;const me=St.map(Ge=>{if(!Ge)return null;const vt=Ge.name||Ge.field_name;if(!vt)return null;const ct=Ge.data_type||Ge.dataType||"text",Nt=Ge.reference_type_id??Ge.referenceTypeId??Ge.referenceType?.id??null,Ye=Ge.reference_type_name??Ge.referenceTypeName??Ge.referenceType?.name??"",Je=Ge.reference_filter??Ge.referenceFilter??Ge.referenceFilterJson??{};return{id:Ge.id||vt,name:vt,label:Ge.label||Ge.name||vt,dataType:ct,required:!!Ge.required,options:Ge.options||{},defaultValue:Ge.default_value??Ge.defaultValue??null,referenceTypeId:Nt,referenceTypeName:Ye,referenceFilter:Je}}).filter(Boolean);F(me),P({});const nt={};me.forEach(Ge=>{const vt=Ge.defaultValue;vt!=null&&vt!==""?nt[Ge.name]=HD(vt,Ge):nt[Ge.name]=""}),I(nt)}catch(ot){ae||(V(ot.message||"Failed to load metadata fields"),F([]),I({}),P({}))}finally{ae||z(!1)}})(),()=>{ae=!0}},[xe,g]);const $e=u.useMemo(()=>{const ae=R.entityTypeId||f||"";return ae&&A.find(Ke=>Ke.id===ae)||null},[A,R.entityTypeId,f]),He=ae=>{const Ke=`metadata-field-${ae.id}`,ot=H[ae.name]??"",St=!!ae.required;switch(ae.dataType){case"boolean":return t.jsxs("select",{id:Ke,value:ot,onChange:We(ae.name),disabled:G||L,required:St,children:[t.jsx("option",{value:"",children:"Select..."}),t.jsx("option",{value:"true",children:"True"}),t.jsx("option",{value:"false",children:"False"})]});case"enum":{const me=qD(ae);return t.jsxs("select",{id:Ke,value:ot,onChange:We(ae.name),disabled:G||L,required:St,children:[t.jsx("option",{value:"",children:"Select..."}),me.map(nt=>t.jsx("option",{value:nt.value,children:nt.label},nt.value))]})}case"entity_reference":case"location_reference":case"reference":{const me=ae.referenceTypeId??ae.reference_type_id??null,nt=me?String(me).trim():null,Ge=ae.dataType==="location_reference";ae.dataType;const vt=ae.referenceTypeName||(Ge?"locations":"entities"),ct=typeof vt=="string"&&vt.trim()?vt.trim():Ge?"locations":"entities",Nt=Array.isArray(ae.options?.choices)?ae.options.choices.map((zt,Ut)=>{if(zt==null)return null;if(typeof zt=="object"){const Un=zt.value??zt.id??zt.key??zt.slug??`choice-${Ut}`;if(Un==null)return null;const yn=zt.label??zt.name??zt.title??zt.display??zt.displayName??Un;return{value:String(Un),label:String(yn)}}const dn=String(zt);return{value:dn,label:dn}}).filter(Boolean):[],Ye=Nt.length>0,Je=!!(e&&(nt||Ge)),Et=G||L||!Ye&&!Je,te=Y[ae.name]||"",ve=!te&&ot&&Nt.find(zt=>String(zt.value)===String(ot))?.label||"",Ie=ot&&(te||ve)?{id:ot,name:te||ve}:ot,rt=ot?String(ot):"",_t=Y[ae.name]||ve||ct,Lt=zt=>{if(!zt){I(yn=>({...yn,[ae.name]:""})),P(yn=>{if(!yn[ae.name])return yn;const ja={...yn};return delete ja[ae.name],ja});return}const Ut=zt.id??zt.value??zt.key??zt.slug??zt.uuid??null;if(Ut==null){I(yn=>({...yn,[ae.name]:""}));return}const dn=String(Ut),Un=zt.name??zt.label??zt.title??zt.display??zt.displayName??"";I(yn=>({...yn,[ae.name]:dn})),P(yn=>({...yn,[ae.name]:Un||dn}))},nn=zt=>{if(!zt){P(yn=>{if(!yn[ae.name])return yn;const ja={...yn};return delete ja[ae.name],ja});return}const Ut=zt.id??zt.value??zt.key??zt.slug??zt.uuid??null;if(Ut==null)return;const dn=String(Ut),Un=zt.name??zt.label??zt.title??zt.display??zt.displayName??"";P(yn=>yn[ae.name]===(Un||dn)?yn:{...yn,[ae.name]:Un||dn})},Pt=Ge?c1:kc;return t.jsxs("div",{className:"reference-field-control",children:[t.jsxs("div",{className:"reference-field-input-row",children:[t.jsx(Pt,{worldId:e,value:Ie,allowedTypeIds:nt&&nt.length>0?[nt]:[],placeholder:`Search ${ct.toLowerCase()}...`,disabled:Et,staticOptions:Nt,onChange:Lt,onResolved:nn,required:St,minSearchLength:Ge&&!nt?0:void 0}),rt&&t.jsx(Na,{entityId:rt,entityName:_t,className:"reference-field-info-btn"})]}),!nt&&!Ge&&t.jsx("p",{className:"field-hint warning",children:"Reference type configuration is missing."}),!e&&Je&&t.jsxs("p",{className:"field-hint warning",children:["Select a world to search for ",Ge?"locations":"entities","."]})]})}case"number":return t.jsx("input",{id:Ke,type:"number",value:ot,onChange:We(ae.name),disabled:G||L,required:St});case"text":return t.jsx("textarea",{id:Ke,value:ot,onChange:We(ae.name),disabled:G||L,rows:4,required:St});case"date":return t.jsx("input",{id:Ke,type:"date",value:ot,onChange:We(ae.name),disabled:G||L,required:St});default:return t.jsx("input",{id:Ke,type:"text",value:ot,onChange:We(ae.name),disabled:G||L,required:St})}},J=!g&&!!f,Z=!g&&$.length>0,je=()=>t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"entity-type",children:"Type *"}),J?t.jsx("input",{id:"entity-type",type:"text",value:$e?.name||"",readOnly:!0,disabled:!0}):t.jsxs("select",{id:"entity-type",value:R.entityTypeId,onChange:Rt("entityTypeId"),disabled:G||_,required:!0,children:[t.jsx("option",{value:"",children:"Select type..."}),A.map(ae=>t.jsx("option",{value:ae.id,children:ae.name},ae.id))]})]}),Ne=mt||ao(ue),pe=R.name?`${R.name} artwork`:"Entity artwork",Ue=()=>t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"entity-name",children:"Name *"}),t.jsx("input",{id:"entity-name",type:"text",value:R.name,onChange:Rt("name"),placeholder:"e.g. Waterdeep",disabled:G,required:!0,"data-autofocus":!0})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"entity-description",children:"Description"}),t.jsx("textarea",{id:"entity-description",value:R.description,onChange:Rt("description"),placeholder:"Optional summary of the entity",rows:4,disabled:G})]})]});return t.jsxs("form",{id:l,className:"entity-form",onSubmit:oe,children:[Ee?t.jsx("div",{className:"form-loading",children:"Loading..."}):t.jsx(t.Fragment,{children:Ve?t.jsxs("section",{className:"entity-card entity-access-card drawer-access-card",children:[t.jsx("h3",{className:"entity-card-title",children:"Manage access"}),t.jsx("p",{className:"entity-access-note help-text",children:"Configure who can view and edit this entity. Users with write access will automatically receive read access."}),re&&t.jsx("div",{className:"alert error",role:"alert",children:re}),e?t.jsx(zg,{canEdit:!G,accessSettings:W,accessOptions:K,accessOptionsLoading:Q,accessSaving:G,onSettingChange:it,idPrefix:"entity-create-access"}):t.jsx("p",{className:"entity-empty-state",children:"Assign this entity to a world to configure access settings."})]}):t.jsxs(t.Fragment,{children:[g&&ue?t.jsxs("div",{className:"entity-form-image-wrapper",children:[t.jsxs("div",{className:"entity-form-image-panel","aria-live":"polite",children:[t.jsx("div",{className:`entity-image-preview ${Ne?"has-image":""}`.trim(),children:Ne?t.jsx("img",{src:Ne,alt:pe,loading:"lazy"}):t.jsx("div",{className:"entity-image-placeholder",children:t.jsx("p",{children:"No image"})})}),t.jsxs("div",{className:"entity-form-image-panel-actions",children:[t.jsx("button",{type:"button",className:"btn secondary",onClick:qe,disabled:!n||we||lt||k,children:we?"Uploading":"Replace Image"}),t.jsx("button",{type:"button",className:"btn secondary",onClick:gt,disabled:!n||lt||we,children:lt?"Removing":"Remove Image"})]}),Mt,t.jsx("input",{type:"file",ref:S,accept:"image/png,image/jpeg",onChange:fe,hidden:!0,disabled:!n||we||lt}),t.jsx("p",{className:"entity-image-helper",children:jt}),Ct?t.jsx("p",{className:"entity-image-status entity-image-status--error",children:Ct}):null,!Ct&&we?t.jsx("p",{className:"entity-image-status",children:"Uploading image"}):null,!Ct&&lt?t.jsx("p",{className:"entity-image-status",children:"Removing image"}):null]}),t.jsx("div",{className:"entity-form-image-fields",children:Ue()})]}):Ue(),!g&&je(),g&&!ue?t.jsxs("div",{className:"form-group entity-form-upload-section",children:[t.jsx("label",{htmlFor:"entity-image-upload",children:"Upload image"}),t.jsx("input",{id:"entity-image-upload",type:"file",accept:"image/png,image/jpeg",ref:N,onChange:fe,disabled:!n||we||lt}),Le&&mt?t.jsx("div",{className:"entity-form-upload-preview",children:t.jsx(v1,{src:mt,size:220,zoomLabel:"Zoom to crop",onCropChange:Me})}):null,Mt,t.jsx("p",{className:"entity-image-helper",children:jt}),Ct?t.jsx("p",{className:"entity-image-status entity-image-status--error",children:Ct}):null,!Ct&&we?t.jsx("p",{className:"entity-image-status",children:"Uploading image"}):null,!Ct&&lt?t.jsx("p",{className:"entity-image-status",children:"Removing image"}):null]}):null,Z&&t.jsxs("div",{className:"metadata-field-section",children:[t.jsx("h3",{children:"Information"}),$.map(ae=>t.jsxs("div",{className:"form-group",children:[t.jsxs("label",{htmlFor:`metadata-field-${ae.id}`,children:[ae.label,ae.required?" *":""]}),He(ae)]},ae.id))]}),Se&&!e&&t.jsx("p",{className:"help-text",children:"Assign a world to configure access controls."}),g&&t.jsx("div",{className:"form-two-column",children:je()}),g&&t.jsxs("div",{className:"advanced-options",children:[t.jsxs("button",{type:"button",className:"advanced-options-toggle",onClick:bt,"aria-expanded":Xe,children:[t.jsx("span",{children:"Advanced options"}),ie?t.jsx("span",{className:"advanced-indicator",children:"Metadata added"}):null,t.jsx("span",{className:"advanced-chevron","aria-hidden":"true",children:Xe?"":""})]}),Xe&&t.jsx("div",{className:"advanced-options-body",children:t.jsxs("div",{className:"metadata-editor",children:[t.jsxs("div",{className:"metadata-header",children:[t.jsxs("h3",{children:["Metadata ",ie?"":"(optional)"]}),t.jsx("button",{type:"button",className:"btn neutral",onClick:Zt,disabled:G,children:"Add field"})]}),t.jsx("div",{className:"metadata-list",children:D.map((ae,Ke)=>t.jsxs("div",{className:"metadata-row",children:[t.jsxs("div",{className:"form-group",children:[t.jsxs("label",{htmlFor:`metadata-key-${ae.id}`,className:"sr-only",children:["Metadata key ",Ke+1]}),t.jsx("input",{id:`metadata-key-${ae.id}`,type:"text",placeholder:"Key",value:ae.key,onChange:Ft(ae.id,"key"),disabled:G})]}),t.jsxs("div",{className:"form-group",children:[t.jsxs("label",{htmlFor:`metadata-value-${ae.id}`,className:"sr-only",children:["Metadata value ",Ke+1]}),t.jsx("input",{id:`metadata-value-${ae.id}`,type:"text",placeholder:"Value",value:ae.value,onChange:Ft(ae.id,"value"),disabled:G})]}),t.jsx("div",{className:"metadata-actions",children:t.jsx("button",{type:"button",className:"icon-btn",onClick:()=>Tt(ae.id),disabled:G||D.length===1,title:"Remove field",children:""})})]},ae.id))})]})})]})]})}),X&&t.jsx("div",{className:"form-error",role:"alert",children:X}),!d&&t.jsxs("div",{className:"form-actions",children:[t.jsx("button",{type:"button",className:"btn cancel",onClick:s,disabled:G,children:"Cancel"}),t.jsx("button",{type:"submit",className:"btn submit",disabled:G||Ee,children:G?"Saving...":g?"Save Changes":"Create Entity"})]})]})}const WD={critical:"",important:"",medium:""};function Cy({importance:e,className:n="entity-importance-indicator"}){const{selectedCampaignId:s}=wn();if(!s||!e)return null;const i=WD[e]||"",l=e.charAt(0).toUpperCase()+e.slice(1);return t.jsx("span",{className:n,title:`Importance: ${l}`,children:i})}const XD={visible:"badge-visible",partial:"badge-partial",hidden:"badge-hidden"},KD=new Set(["system_admin"]),US="entityType",rs=["name","type","visibility","createdAt"],md=[{key:"name",label:"Name",type:"core"},{key:"type",label:"Type",type:"core"},{key:"importance",label:"Importance",type:"core"},{key:"visibility",label:"Visibility",type:"core"},{key:"createdAt",label:"Created",type:"core"},{key:"description",label:"Description",type:"core"}],gp="user",qS="system",Al=(e="create")=>({mode:e,submitLabel:e==="edit"?"Save Changes":"Create Entity",submitDisabled:!1,cancelDisabled:!1,accessButtonVisible:!1,accessButtonDisabled:!1}),bp=(e=[],n=[])=>e.length!==n.length?!1:e.every((s,i)=>s===n[i]),xp=(e,n,s)=>{const i=new Set(s),l=[];if(Array.isArray(e)&&e.forEach(d=>{if(typeof d!="string")return;const f=d.trim();!f||!i.has(f)||l.includes(f)||l.push(f)}),l.length>0)return l;const o=Array.isArray(n)?n.filter(d=>typeof d=="string"&&i.has(d)):[];return o.length>0?[...o]:i.size>0?[i.values().next().value]:[]},ZD=e=>{if(!e||typeof e!="object")return"";const n=e.displayValue??e.display??e.label??e.displayName??e.text??e.name??e.title??e.value??e.id??null;return n!=null?String(n).trim():""},Ug=e=>!e||typeof e!="object"?!1:Array.isArray(e)?e.some(n=>Ug(n)):Object.prototype.hasOwnProperty.call(e,"displayValue")||Object.prototype.hasOwnProperty.call(e,"display")||Object.prototype.hasOwnProperty.call(e,"label"),N1=e=>{if(e==null)return"";if(Array.isArray(e)){const n=e.map(s=>N1(s)).filter(s=>!!s);return n.length?n.join(", "):""}return typeof e=="object"?ZD(e):String(e).trim()},vp=(e,n=null)=>{if(e==null)return"";const s=n?.dataType||n?.data_type||"";if(s==="reference"||Ug(e))return N1(e)||"";if(typeof e=="boolean")return e?"Yes":"No";if(typeof e=="number")return Number.isFinite(e)?String(e):"";if(s==="number"){const o=Number(e);return Number.isFinite(o)?String(o):""}if(e instanceof Date)return e.toLocaleDateString();if(s==="date"||typeof e=="string"&&s==="text"){const o=new Date(e);if(!Number.isNaN(o.getTime()))return o.toLocaleDateString()}if(Array.isArray(e))return e.length===0?"":e.filter(o=>o!=null&&String(o).trim()!=="").map(o=>typeof o=="string"?o.trim():String(o)).join(", ");if(typeof e=="object")try{return JSON.stringify(e)}catch(o){return console.warn(" Failed to stringify metadata value",o),""}return String(e).trim()||""};function QD(){const{user:e,token:n,sessionReady:s}=un(),{selectedCampaign:i,selectedCampaignId:l,activeWorld:o,activeWorldId:d,selectedContextType:f,viewAsCharacterId:p,contextKey:h}=wn(),[y,g]=mj(),b=to(),[v,S]=u.useState([]),[N,j]=u.useState(!1),[E,A]=u.useState(""),[M,_]=u.useState(!1),[T,k]=u.useState(null),[C,L]=u.useState(""),[z,G]=u.useState(""),[U,X]=u.useState(null),[V,R]=u.useState(null),[B,D]=u.useState(!1),[O,$]=u.useState(""),[F,H]=u.useState(null),[I,Y]=u.useState(null),[P,W]=u.useState(()=>[...rs]),[le,K]=u.useState(()=>[...rs]),[de,Q]=u.useState(!1),[he,re]=u.useState(""),[Ce,Re]=u.useState(""),[ue,se]=u.useState(""),[Le,be]=u.useState(""),[De,Me]=u.useState(()=>Al("create")),[mt,ht]=u.useState("details"),[Ct,At]=u.useState(!1),[we,st]=u.useState({open:!1,columnKey:"",columnLabel:"",x:0,y:0}),[lt,Fe]=u.useState(!1),[Xe,dt]=u.useState([]),[ie,ee]=u.useState([]),[ce,fe]=u.useState(null),[qe,Pe]=u.useState(!1),Be=y.toString(),Te=d||"",gt=!!Te,jt=y.get(US)??"",Mt=!!jt,tt=y.get("parentEntity")??"",ft=!!tt,Rt=u.useRef(`entity-form-${Math.random().toString(36).slice(2)}`),Ft=u.useRef(`${Te}:${h}`),Zt=u.useCallback((ye,Oe="info")=>{X({message:ye,tone:Oe})},[]);u.useEffect(()=>{!b||!de||Q(!1)},[b,de]),u.useEffect(()=>{De.accessButtonVisible||mt!=="details"&&ht("details")},[De.accessButtonVisible,mt]),u.useEffect(()=>{if(!we.open)return;const ye=()=>st({open:!1,columnKey:"",columnLabel:"",x:0,y:0});return window.addEventListener("click",ye),window.addEventListener("contextmenu",ye),()=>{window.removeEventListener("click",ye),window.removeEventListener("contextmenu",ye)}},[we.open]),u.useEffect(()=>{if(!U)return;const ye=setTimeout(()=>X(null),3500);return()=>clearTimeout(ye)},[U]);const Tt=u.useCallback(ye=>{if(!ye)return"";const Oe=new Date(ye);return Number.isNaN(Oe.getTime())?"":Oe.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})},[]),We=u.useMemo(()=>!i||!e?"":i.members?.find(Oe=>Oe.user_id===e.id)?.role||"",[i,e]),it=u.useMemo(()=>{if(!o||!e?.id)return!1;const ye=o.created_by||o.creator?.id||o.owner_id||o.owner?.id||"";return ye?String(ye)===String(e.id):!1},[o,e?.id]),bt=u.useMemo(()=>e?KD.has(e.role)?!0:Te?f==="world"?it:!!(i&&(We==="dm"||it)):!1:!1,[e,Te,f,i,We,it]),oe=o?.entity_creation_scope??"",Ee=u.useMemo(()=>!l||!i||!e||oe!==zi.ALL_PLAYERS?!1:We==="player",[l,i,e,oe,We]),Se=bt||Ee,Ve=e?.role==="system_admin",xe=u.useCallback(async(ye,Oe={})=>{if(!n)return S([]),[];const{useUnassigned:$t=!1,viewAsCharacterId:Qt=""}=Oe;if($t){if(!Ve)return S([]),A("Only system administrators can view unassigned entities"),[];j(!0),A("");try{const _e=await oI(),pt=Array.isArray(_e)?_e:Array.isArray(_e?.data)?_e.data:[];return S(pt),pt}catch(_e){return console.error(" Failed to load unassigned entities",_e),A(_e.message||"Failed to load unassigned entities"),S([]),[]}finally{j(!1)}}const ge=ye??Te;if(!ge)return S([]),[];j(!0),A("");try{const _e=await Mc(ge,{viewAsCharacterId:Qt,importance:Xe.length>0?Xe:void 0}),pt=Array.isArray(_e)?_e:Array.isArray(_e?.data)?_e.data:[];return S(pt),pt}catch(_e){return console.error(" Failed to load entities",_e),A(_e.message||"Failed to load entities"),S([]),[]}finally{j(!1)}},[n,Te,Ve,h]);u.useEffect(()=>{if(!n){S([]);return}if(lt){xe(null,{useUnassigned:!0});return}if(!Te){S([]);return}xe(Te,{viewAsCharacterId:p})},[Te,n,lt,xe,h,p,Xe]),u.useEffect(()=>{if(lt){Ft.current=`${Te}:${h}`;return}const ye=`${Te}:${h}`;Ft.current!==ye&&(M&&(_(!1),k(null)),L(""),Me(Al("create")),A(""),X(null),Ft.current=ye)},[Te,h,M,lt]),u.useEffect(()=>{!Ve&&lt&&Fe(!1)},[Ve,lt]),u.useEffect(()=>{lt&&M&&(_(!1),k(null),L(""),Me(Al("create")))},[lt,M]),u.useEffect(()=>{if(Q(!1),re(""),!jt||!n||!s){R(null),$(""),H(null),Y(null),W([...rs]),K([...rs]),D(!1);return}let ye=!1;return(async()=>{D(!0),$("");try{const $t=await MI(jt);if(ye)return;const Qt=$t?.data??$t??{},ge=Qt.data??Qt,_e=Array.isArray(ge.coreColumns)&&ge.coreColumns.length?ge.coreColumns:md,pt=new Map(md.map(Xt=>[Xt.key,Xt])),Dt=_e.map(Xt=>{const Ca=pt.get(Xt.key)??{};return{...Ca,...Xt,type:"core",label:Xt.label||Ca.label||Xt.key}}),Ht=md.filter(Xt=>!Dt.some(Ca=>Ca.key===Xt.key)),tn=[...Dt,...Ht],en=(Array.isArray(ge.metadataColumns)?ge.metadataColumns:[]).filter(Xt=>typeof Xt?.key=="string").map(Xt=>({key:Xt.key,name:Xt.name||Xt.key.replace(/^metadata\./,""),label:Xt.label||Xt.name||Xt.key.replace(/^metadata\./,""),dataType:Xt.dataType||Xt.data_type||"",required:!!Xt.required,options:Xt.options||Xt.choices||{},referenceTypeId:Xt.referenceTypeId||Xt.reference_type_id||null,referenceTypeName:Xt.referenceTypeName||Xt.reference_type_name||"",referenceFilter:Xt.referenceFilter||Xt.reference_filter||Xt.referenceFilterJson||{}})).sort((Xt,Ca)=>Xt.label.localeCompare(Ca.label,void 0,{sensitivity:"base"})),Cn=new Set([...tn.map(Xt=>Xt.key),...en.map(Xt=>Xt.key)]);rs.forEach(Xt=>Cn.add(Xt));const Pn=xp(rs,rs,Cn),oa=ge.systemDefault?.columns,_a=Array.isArray(oa)&&oa.length?xp(oa,Pn,Cn):[...Pn],ga=ge.userPreference?.columns,ks=Array.isArray(ga)&&ga.length>0,$a=ks?xp(ga,_a,Cn):[],fi=ks&&$a.length?$a:_a;R({coreColumns:tn,metadataColumns:en}),Y(_a.length?{columns:[..._a],updatedAt:ge.systemDefault?.updatedAt??null}:null),H(ks&&$a.length?{columns:[...$a],updatedAt:ge.userPreference?.updatedAt??null}:null),W([...fi]),K([...fi])}catch($t){if(ye)return;console.error(" Failed to load column configuration",$t),$($t.message||"Failed to load column configuration"),R(null),H(null),Y(null),W([...rs]),K([...rs])}finally{ye||D(!1)}})(),()=>{ye=!0}},[jt,n,s]),u.useEffect(()=>{if(!tt||!n){ee([]),fe(null);return}let ye=!1;return Pe(!0),(async()=>{try{const $t=v.find(_e=>String(_e.id)===String(tt));$t&&fe($t);const Qt=await g1(tt),ge=Array.isArray(Qt?.data)?Qt.data:Array.isArray(Qt)?Qt:[];ye||ee(ge)}catch($t){console.error("Failed to load parent entity relationships:",$t),ye||ee([])}finally{ye||Pe(!1)}})(),()=>{ye=!0}},[tt,n,v]);const $e=u.useMemo(()=>{let ye=v;if(jt&&(ye=ye.filter(Oe=>(Oe.entity_type_id||Oe.entityType?.id||Oe.entity_type?.id||"")===jt)),Xe.length>0&&l&&(ye=ye.filter(Oe=>{const $t=Oe.importance||null;return Xe.includes($t)})),tt&&ie.length>0){const Oe=new Set,$t=String(tt);ie.forEach(Qt=>{const ge=String(Qt.from_entity||Qt.fromEntity||Qt.from?.id||""),_e=String(Qt.to_entity||Qt.toEntity||Qt.to?.id||""),pt=Qt.relationshipType||Qt.relationship_type,Dt=pt?.name||pt?.label||pt?.from_label||pt?.to_label||"",Ht=Qt.bidirectional===!0,tn=/(parent|owns|contains|has child|has member|supervises|manages)/i.test(Dt),rn=/(child|belongs to|part of|member of|reports to|works for)/i.test(Dt);ge===$t&&(tn||!rn&&!tn)?Oe.add(_e):_e===$t&&(rn||Ht&&tn)?Oe.add(ge):Ht&&(ge===$t?Oe.add(_e):_e===$t&&Oe.add(ge))}),ye=ye.filter(Qt=>{const ge=String(Qt.id);return Oe.has(ge)})}return ye},[v,jt,Xe,l,tt,ie]),He=u.useMemo(()=>{if(!jt)return"";const ye=v.find(Oe=>(Oe.entity_type_id||Oe.entityType?.id||Oe.entity_type?.id||"")===jt);return ye?.entityType?.name||ye?.entity_type?.name||""},[v,jt]),J=u.useMemo(()=>{const ye=[],Oe=new Set,$t=(_e,pt)=>{if(!_e||typeof _e!="object")return;const Dt=typeof _e.key=="string"?_e.key.trim():"";if(!Dt||Oe.has(Dt))return;const Ht=_e.label||_e.name||(typeof _e.title=="string"?_e.title:""),tn=typeof Ht=="string"&&Ht.trim()?Ht.trim():Dt;ye.push({..._e,key:Dt,label:tn,type:_e.type||pt}),Oe.add(Dt)};return(V?.coreColumns??md).forEach(_e=>$t(_e,"core")),(V?.metadataColumns??[]).forEach(_e=>$t(_e,"metadata")),ye},[V]),Z=u.useMemo(()=>{const ye=new Map;return J.forEach(Oe=>{ye.set(Oe.key,{...Oe,type:Oe.type==="metadata"?"metadata":"core"})}),ye},[J]),je=u.useMemo(()=>Array.from(Z.keys()),[Z]),Ne=u.useMemo(()=>{const ye=rs.filter(Oe=>Z.has(Oe));return ye.length>0?ye:je.length>0?[je[0]]:[...rs]},[je,Z]),pe=u.useMemo(()=>{if(b){const ye=[];return Z.has("name")&&ye.push("name"),Z.has("description")&&ye.push("description"),ye.length>0?ye:Ne.filter(Oe=>Z.has(Oe))}return jt?P:rs},[b,Z,Ne,jt,P]);u.useEffect(()=>{jt&&W(ye=>{const Oe=ye.filter($t=>Z.has($t));return Oe.length>0?Oe:Ne})},[jt,Z,Ne]),u.useEffect(()=>{K([...P])},[P]);const Ue=u.useMemo(()=>{const ye=pe.map(Oe=>Z.get(Oe)).filter(Boolean);return ye.length>0?ye:Ne.map(Oe=>Z.get(Oe)).filter(Boolean)},[pe,Z,Ne]),ae=I?.columns??Ne,Ke=F?.columns??ae,ot=!!jt&&!bp(le,Ke),St=!!jt&&!bp(le,ae),me=Ce===gp,nt=Ce===qS,Ge=bp(le,ae),vt=()=>{K([...ae]),re(""),se(""),be("")},ct=ye=>{jt&&K(Oe=>Oe.includes(ye)?Oe.length===1?(re("You must keep at least one column selected."),Oe):(re(""),ue===ye&&(se(""),be("")),Oe.filter($t=>$t!==ye)):Z.has(ye)?(re(""),[...Oe,ye]):Oe)},Nt=(ye,Oe)=>{jt&&le.includes(ye)&&(se(ye),be(""),Oe?.dataTransfer&&(Oe.dataTransfer.effectAllowed="move",Oe.dataTransfer.setData("text/plain",ye)))},Ye=(ye,Oe)=>{!ue||ue===ye||le.includes(ye)&&(Oe&&(Oe.preventDefault(),Oe.dataTransfer&&(Oe.dataTransfer.dropEffect="move")),be(ye))},Je=ye=>{jt&&(K(Oe=>{if(!ue||ue===ye)return Oe;const $t=Oe.indexOf(ue),Qt=Oe.indexOf(ye);if($t===-1||Qt===-1)return Oe;const ge=[...Oe],[_e]=ge.splice($t,1),pt=$t<Qt?Math.max(Qt-1,0):Qt;return ge.splice(pt,0,_e),ge}),be(""),se(""))},Et=()=>{jt&&(K(ye=>{if(!ue||!ye.includes(ue))return ye;const Oe=ye.filter($t=>$t!==ue);return Oe.push(ue),Oe}),be(""),se(""))},te=()=>{be(""),se("")},ve=()=>{jt&&(re(""),Q(ye=>{const Oe=!ye;return!ye&&Oe&&(K([...P]),se(""),be("")),ye&&!Oe&&(se(""),be("")),Oe}))},Ie=()=>{Q(!1),be(""),se("")},rt=async ye=>{if(jt){if(le.length===0){re("Please select at least one column.");return}Re(ye),re("");try{await kI(jt,{scope:ye,columns:le}),ye===gp?(H({columns:[...le],updatedAt:new Date().toISOString()}),W([...le]),Ie(),Zt("Column preference saved","success")):(Y({columns:[...le],updatedAt:new Date().toISOString()}),W([...le]),Zt("System default updated","success"))}catch(Oe){console.error(" Failed to save column selection",Oe),re(Oe.message||"Failed to save column settings")}finally{Re("")}}},_t=u.useCallback(ye=>ye?.entityType?.name||ye?.entity_type?.name||"",[]),Lt=u.useCallback((ye,Oe)=>{if(!ye)return"";switch(Oe){case"name":return ye.name||"";case"type":return _t(ye);case"visibility":return ye.visibility||"visible";case"createdAt":return ye.createdAt||ye.created_at||"";case"description":return ye.description||"";default:{if(Oe.startsWith("metadata.")){const $t=ye.metadata&&typeof ye.metadata=="object"?ye.metadata:{},Qt=Oe.replace(/^metadata\./,"");return $t?.[Qt]}return ye[Oe]}}},[_t]),nn=u.useCallback(ye=>{if(ye==null||ye==="")return null;if(typeof ye=="string"){const Oe=ye.trim();return Oe.length>0?Oe:null}if(typeof ye=="object"&&!Array.isArray(ye)){const Oe=ye.id??ye.value??ye.key??ye.slug??ye.uuid??null;return Oe!=null?String(Oe).trim():null}if(Array.isArray(ye)){for(const Oe of ye){const $t=nn(Oe);if($t)return $t}return null}return null},[]),Pt=u.useMemo(()=>{const ye=[];return Z.forEach(Oe=>{const Qt=(Oe.type==="metadata"?Oe.dataType||Oe.data_type||"string":Oe.dataType)||(Oe.key==="createdAt"?"date":"string"),ge=Qt==="reference"||Oe.dataType&&String(Oe.dataType).toLowerCase()==="reference"||Oe.data_type&&String(Oe.data_type).toLowerCase()==="reference",_e=pt=>{const Dt=Lt(pt,Oe.key);if(ge){const Ht=nn(Dt);return Ht!==null?Ht:Dt}return Dt};ye.push({key:Oe.key,label:Oe.label||Oe.name||Oe.key,dataType:Qt,accessor:_e})}),ye},[Z,Lt,nn]),zt=u.useMemo(()=>new Map(Pt.map(ye=>[ye.key,ye])),[Pt]),Ut=Xj($e,{columns:Pt}),dn=u.useCallback(ye=>{const Oe=Ut.groupBy?Z.get(Ut.groupBy):null;if(!Oe)return vp(ye);if(Oe.key==="visibility"){const $t=typeof ye=="string"?ye:"";return $t?$t.charAt(0).toUpperCase()+$t.slice(1):"Hidden"}return Oe.key==="createdAt"?Tt(ye):Oe.key==="type"?ye||"Unassigned":Oe.key.startsWith("metadata.")?vp(ye,Oe):Oe.key==="name"||Oe.key==="description"?ye?String(ye):"":ye?String(ye):"Unassigned"},[Z,Ut.groupBy,Tt]),Un=u.useMemo(()=>Pt.map(ye=>{const Oe=Z.get(ye.key),$t=Oe?.data_type||Oe?.dataType||ye.dataType,Qt={key:ye.key,label:zt.get(ye.key)?.label||ye.label||ye.key,dataType:ye.dataType,originalDataType:$t};Oe?.options&&(Qt.options=Oe.options);const ge=Oe?.referenceTypeId||Oe?.reference_type_id;ge&&(Qt.referenceTypeId=ge);const _e=Oe?.referenceTypeName||Oe?.referenceType?.name;_e&&(Qt.referenceTypeName=_e);const pt=Oe?.referenceFilter||Oe?.reference_filter;return pt&&(Qt.referenceFilter=pt),Qt}),[Pt,zt,Z]),yn=ye=>{ye&&Ut.toggleSort(ye)},ja=(ye,Oe)=>{ye.preventDefault(),st({open:!0,columnKey:Oe.key,columnLabel:Oe.label||Oe.name||Oe.key,x:ye.clientX,y:ye.clientY})},ha=ye=>{Ut.setGroupBy(ye),st({open:!1,columnKey:"",columnLabel:"",x:0,y:0})},Xi=(ye,Oe)=>{const $t=Oe.metadata&&typeof Oe.metadata=="object"?Oe.metadata:{};switch(ye.key){case"name":const Qt=(Oe.childCount||0)>0,ge=_e=>{_e.preventDefault(),_e.stopPropagation();const pt=new URLSearchParams(y);pt.set("parentEntity",Oe.id),g(pt)};return t.jsxs(t.Fragment,{children:[t.jsx(Yt,{to:`/entities/${Oe.id}`,state:{fromEntities:{search:Be}},className:"entity-name-link",children:Oe.name}),Qt&&t.jsxs(t.Fragment,{children:["",t.jsx("button",{type:"button",onClick:ge,style:{background:"none",border:"none",padding:0,cursor:"pointer",display:"inline-flex",alignItems:"center",verticalAlign:"middle"},title:"View children","aria-label":"View children",children:t.jsx(xr,{size:14,style:{color:"#6b7280"}})})]}),Oe.id?t.jsxs(t.Fragment,{children:["",t.jsx(Na,{entityId:Oe.id,entityName:Oe.name||"entity"})]}):null,"",t.jsx(Cy,{importance:Oe.importance})]});case"type":return _t(Oe);case"visibility":{const _e=Oe.visibility||"visible",pt=XD[_e]||"badge-hidden";return t.jsx("span",{className:`visibility-badge ${pt}`,children:_e.charAt(0).toUpperCase()+_e.slice(1)})}case"createdAt":return Tt(Oe.createdAt||Oe.created_at);case"description":return Oe.description?Oe.description:"";case"importance":{if(!l)return"";const _e=Oe.importance;if(!_e)return"";const pt={critical:"Critical",important:"Important",medium:"Medium"},Dt={critical:"#dc2626",important:"#ea580c",medium:"#6b7280"};return t.jsx("span",{className:"importance-badge",style:{"--importance-color":Dt[_e]},children:pt[_e]||_e})}default:{if(ye.key.startsWith("metadata.")){const _e=ye.key.replace(/^metadata\./,""),pt=$t?.[_e],Dt=vp(pt,ye);if(((ye?.dataType||ye?.data_type||"")==="reference"||Ug(pt))&&pt!==null&&pt!==void 0){const rn=Rg(pt),en=Ig(pt)||Dt||"entity";if(rn)return t.jsxs(t.Fragment,{children:[Dt,"",t.jsx(Na,{entityId:rn,entityName:en})]})}return Dt}return""}}},na=()=>{_(!1),k(null),L(""),Me(Al("create")),ht("details")},hs=async ye=>{na(),lt?await xe(null,{useUnassigned:!0}):Te&&await xe(Te,{viewAsCharacterId:p}),Zt(ye==="create"?"Entity created":"Entity updated","success")},jr=async ye=>{if(!(!bt||!ye?.id||!window.confirm(`Delete entity "${ye.name}"? This action cannot be undone.`)))try{G(ye.id),await dI(ye.id),Zt("Entity deleted","success"),lt?await xe(null,{useUnassigned:!0}):Te&&await xe(Te,{viewAsCharacterId:p})}catch($t){console.error(" Failed to delete entity",$t),Zt($t.message||"Failed to delete entity","error")}finally{G("")}},ui=()=>{if(lt){xe(null,{useUnassigned:!0});return}Te&&xe(Te,{viewAsCharacterId:p})},ps=()=>{!Se||!Te||lt||(k(null),L(""),Me(Al("create")),ht("details"),_(!0))},qn=ye=>{if(!bt||!ye?.id)return;const Oe=typeof ye.name=="string"?ye.name.trim():"";k(ye.id),L(Oe),Me(Al("edit")),ht("details"),_(!0)},Xs=u.useCallback(ye=>{ye&&Me(Oe=>({...Oe,...ye}))},[]),Ea=u.useMemo(()=>{if(!T)return"";const ye=v.find($t=>$t.id===T);return typeof ye?.name=="string"&&ye.name.trim()||typeof C=="string"&&C.trim()||""||"Untitled entity"},[v,T,C]),io=T?`Edit Entity: ${Ea}`:"Add Entity",Ki=u.useCallback(()=>{g(ye=>{const Oe=new URLSearchParams(ye);return Oe.delete(US),Oe})},[g]);if(!s)return t.jsx("p",{children:"Restoring session..."});if(!n)return t.jsx("p",{children:"Authenticating..."});const Zi=$e.length>0,di=Ut.groupBy?Ut.groups.some(ye=>ye.items.length>0):Ut.data.length>0,lo=`entities-page${b?" entities-page--mobile":""}`,oo=i?`${i.name}${o?.name?`  ${o.name}`:""}`:gt?`World  ${o?.name||"Untitled world"}`:"";return t.jsxs("section",{className:lo,children:[t.jsx("div",{className:"entities-header",children:t.jsxs("div",{className:"entities-header-top",children:[t.jsxs("div",{className:"entities-header-left",children:[t.jsx("h1",{children:"Entities"}),ft&&ce&&t.jsx("div",{style:{marginBottom:"0.75rem",padding:"0.75rem",backgroundColor:"#f8fafc",borderRadius:"0.5rem",border:"1px solid #e5e7eb"},children:t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",flexWrap:"wrap"},children:[t.jsx("span",{style:{color:"#6b7280",fontSize:"0.875rem"},children:"Viewing children of:"}),t.jsx(Yt,{to:`/entities/${ce.id}`,style:{color:"#1e293b",textDecoration:"none",fontWeight:500,fontSize:"0.875rem"},children:ce.name}),t.jsx("button",{type:"button",onClick:()=>{const ye=new URLSearchParams(y);ye.delete("parentEntity"),g(ye)},style:{background:"none",border:"none",color:"#6b7280",cursor:"pointer",fontSize:"0.875rem",padding:"0.25rem 0.5rem",borderRadius:"0.25rem"},onMouseEnter:ye=>{ye.target.style.backgroundColor="#e5e7eb"},onMouseLeave:ye=>{ye.target.style.backgroundColor="transparent"},children:"(View all entities)"})]})}),lt?t.jsx("p",{className:"entities-subtitle",children:"Showing entities without a world assignment."}):gt?t.jsx("p",{className:"entities-subtitle",children:oo}):t.jsx("p",{className:"entities-subtitle",children:"Select a campaign or world you own to choose a world context."})]}),t.jsxs("div",{className:"entities-header-controls-row",children:[t.jsx(xg,{value:Ut.searchTerm,onChange:Ut.setSearchTerm,placeholder:"Search entities...",ariaLabel:"Search entities"}),t.jsxs("div",{className:"entities-controls",children:[Ve&&t.jsx("button",{type:"button",className:`btn secondary compact${lt?" is-active":""}`,onClick:()=>Fe(ye=>!ye),"aria-pressed":lt,title:lt?"Show entities for the selected world":"Show entities that do not have a world assigned",children:"No World"}),l&&t.jsxs("div",{className:"entities-importance-filters",children:[["critical","important","medium"].map(ye=>{const Oe=Xe.includes(ye);return t.jsx("button",{type:"button",className:`btn secondary compact importance-filter importance-${ye}${Oe?" is-active":""}`,onClick:()=>{dt($t=>Oe?$t.filter(Qt=>Qt!==ye):[...$t,ye])},title:`Filter by ${ye} importance`,children:ye.charAt(0).toUpperCase()+ye.slice(1)},ye)}),Xe.length>0&&t.jsx("button",{type:"button",className:"btn secondary compact importance-filter-clear",onClick:()=>dt([]),title:"Clear importance filters",children:t.jsx(Bn,{size:14})})]}),t.jsxs("div",{className:"entities-filters-refresh-group",children:[t.jsxs("button",{type:"button",className:`btn secondary compact${Ut.filterActive?" is-active":""}`,onClick:()=>At(!0),children:[t.jsx(Ef,{size:16})," Filters"]}),t.jsx("button",{type:"button",className:"icon-btn",title:"Refresh entities",onClick:ui,disabled:N||!lt&&!Te,children:t.jsx(Vi,{size:16})})]}),!b&&Mt&&t.jsxs("div",{className:"entities-column-menu-wrapper",children:[t.jsxs("button",{type:"button",className:"btn secondary compact","aria-haspopup":"dialog",onClick:ve,children:[t.jsx(qk,{size:16})," Columns"]}),de&&t.jsx("div",{className:"entities-column-drawer-overlay",role:"presentation",onClick:Ie,children:t.jsxs("div",{className:"entities-column-drawer",role:"dialog","aria-modal":"true","aria-labelledby":"column-drawer-title",onClick:ye=>ye.stopPropagation(),children:[t.jsxs("div",{className:"entities-column-drawer-header",children:[t.jsxs("div",{children:[t.jsxs("h3",{id:"column-drawer-title",children:["Columns for ",He||"selected type"]}),t.jsx("p",{className:"entities-column-info",children:"Choose which fields are visible in this list. Drag the handle to reorder selected columns and save to keep your personal preference."})]}),t.jsx("button",{type:"button",className:"icon-btn",onClick:Ie,title:"Close column settings",children:t.jsx(Bn,{size:16})})]}),t.jsx("div",{className:"entities-column-drawer-body",children:B?t.jsx("p",{className:"entities-column-info",children:"Loading columns"}):O?t.jsx("div",{className:"alert error",role:"alert",children:O}):t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"entities-column-hint",children:"Checked columns appear in the table. Drag the grip icon to adjust their display order."}),t.jsxs("ul",{className:"entities-column-list",children:[le.map(ye=>{const Oe=J.find(ge=>ge.key===ye);if(!Oe)return null;const $t=ue===ye,Qt=Oe.type==="metadata"?"Metadata":"Core";return t.jsxs(u.Fragment,{children:[Le===ye&&t.jsx("div",{className:"drop-indicator"}),t.jsxs("li",{className:`entities-column-item${$t?" is-dragging":""}`,draggable:!0,onDragStart:ge=>Nt(ye,ge),onDragOver:ge=>Ye(ye,ge),onDrop:()=>Je(ye),onDragEnd:te,children:[t.jsxs("div",{className:"entities-column-item-main",children:[t.jsx("input",{type:"checkbox",checked:!0,onChange:()=>ct(ye)}),t.jsx("label",{className:"entities-column-name",children:Oe.label}),t.jsx("span",{className:"entities-column-type-badge",children:Qt})]}),t.jsx("button",{type:"button",className:"entities-column-handle",draggable:!0,onDragStart:ge=>Nt(ye,ge),children:t.jsx(WM,{size:18})})]})]},ye)}),ue&&Le==="__end"&&t.jsx("div",{className:"drop-indicator end"}),J.filter(ye=>!le.includes(ye.key)).map(ye=>{const Oe=ye.type==="metadata"?"Metadata":"Core";return t.jsxs("li",{className:"entities-column-item inactive",children:[t.jsxs("div",{className:"entities-column-item-main",children:[t.jsx("input",{type:"checkbox",checked:!1,onChange:()=>ct(ye.key)}),t.jsx("label",{className:"entities-column-name",children:ye.label}),t.jsx("span",{className:"entities-column-type-badge",children:Oe})]}),t.jsx("div",{className:"entities-column-handle-placeholder"})]},ye.key)})]}),ue&&t.jsx("div",{className:`entities-column-dropzone${Le==="__end"?" is-active":""}`,onDragOver:ye=>{ue&&(ye.preventDefault(),ye.dataTransfer&&(ye.dataTransfer.dropEffect="move"),be("__end"))},onDragLeave:()=>{Le==="__end"&&be("")},onDrop:ye=>{ye.preventDefault(),Et()},children:"Drop here to move column to the end"}),J.every(ye=>ye.type!=="metadata")&&t.jsx("p",{className:"entities-column-empty",children:"This entity type does not have metadata fields yet."}),he&&t.jsx("p",{className:"entities-column-error",children:he})]})}),t.jsxs("div",{className:"entities-column-drawer-footer",children:[t.jsx("div",{className:"entities-column-footer-left",children:t.jsx("button",{type:"button",className:"btn secondary",onClick:vt,disabled:B||Ge,children:"Use system default"})}),t.jsxs("div",{className:"entities-column-footer-right",children:[t.jsx("button",{type:"button",className:"btn submit",onClick:()=>rt(gp),disabled:B||me||!ot,children:me?"Saving":"Save for me"}),Ve&&t.jsxs("div",{className:"entities-column-admin",children:[t.jsx("span",{className:"entities-column-admin-label",children:"System settings (admin only)"}),t.jsx("button",{type:"button",className:"btn secondary",onClick:()=>rt(qS),disabled:B||nt||!St,title:"Set these columns as the default for all users",children:nt?"Saving":"Set as system default"})]})]})]})]})})]})]}),t.jsxs("button",{type:"button",className:"btn submit",onClick:ps,disabled:!Se||!Te||N||lt,children:[t.jsx(Wn,{size:18})," Add Entity"]})]})]})}),lt&&t.jsx("div",{className:"alert info",role:"status",children:"Entities listed here do not have a world assigned. Open an entity to update its world from the entity detail view."}),U&&t.jsx("div",{className:`toast-banner ${U.tone}`,role:"status",children:U.message}),E&&t.jsx("div",{className:"alert error",role:"alert",children:E}),N?t.jsx("div",{className:"empty-state",children:"Loading entities..."}):!Te&&!lt?t.jsx("div",{className:"empty-state",children:"Select a campaign to view its entities."}):Zi?di?t.jsx("div",{className:"entities-table-wrapper",children:t.jsxs("table",{className:"entities-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[Ue.map(ye=>{const Oe=Ut.sortState.key===ye.key,$t=Ut.groupBy===ye.key;return t.jsx("th",{onClick:()=>yn(ye.key),onContextMenu:Qt=>ja(Qt,ye),className:"sortable-header",children:t.jsxs("span",{className:"header-label",children:[ye.label,Oe&&t.jsx("span",{className:"sort-indicator",children:Ut.sortState.direction==="asc"?"":""}),$t&&t.jsx("span",{className:"group-indicator",children:"Grouped"})]})},ye.key)}),bt&&t.jsx("th",{className:"actions-column",children:"Actions"})]})}),t.jsx("tbody",{children:Ut.groupBy?Ut.groups.map(ye=>t.jsxs(u.Fragment,{children:[t.jsx("tr",{className:"entities-group-row",children:t.jsxs("td",{colSpan:Ue.length+(bt?1:0),children:[t.jsx("button",{type:"button",className:"group-toggle",onClick:()=>Ut.toggleGroupCollapse(ye.id),"aria-label":`Toggle group ${dn(ye.value)}`,children:Ut.isGroupCollapsed(ye.id)?t.jsx(xr,{size:14}):t.jsx(Ss,{size:14})}),t.jsxs("span",{className:"entities-group-label",children:[dn(ye.value)," ",t.jsxs("span",{className:"entities-group-count",children:["(",ye.items.length,")"]})]})]})}),!Ut.isGroupCollapsed(ye.id)&&ye.items.map(Oe=>t.jsxs("tr",{children:[Ue.map($t=>t.jsx("td",{children:Xi($t,Oe)},$t.key)),bt&&t.jsx("td",{className:"actions-column",children:t.jsxs("div",{className:"entity-actions",children:[t.jsx("button",{type:"button",className:"icon-btn",onClick:()=>qn(Oe),title:"Edit entity",disabled:N,children:t.jsx(Ga,{size:16})}),t.jsx("button",{type:"button",className:"icon-btn danger",onClick:()=>jr(Oe),title:"Delete entity",disabled:z===Oe.id,children:t.jsx(zn,{size:16})})]})})]},Oe.id))]},ye.id)):Ut.data.map(ye=>t.jsxs("tr",{children:[Ue.map(Oe=>t.jsx("td",{children:Xi(Oe,ye)},Oe.key)),bt&&t.jsx("td",{className:"actions-column",children:t.jsxs("div",{className:"entity-actions",children:[t.jsx("button",{type:"button",className:"icon-btn",onClick:()=>qn(ye),title:"Edit entity",disabled:N,children:t.jsx(Ga,{size:16})}),t.jsx("button",{type:"button",className:"icon-btn danger",onClick:()=>jr(ye),title:"Delete entity",disabled:z===ye.id,children:t.jsx(zn,{size:16})})]})})]},ye.id))})]})}):t.jsxs("div",{className:"empty-state",children:[t.jsx("p",{className:"empty-title",children:"No entities match your filters."}),t.jsx("div",{className:"empty-actions",children:(Ut.filterActive||Ut.searchTerm)&&t.jsxs("div",{className:"empty-action-buttons",children:[Ut.filterActive&&t.jsx("button",{type:"button",className:"btn secondary",onClick:()=>Ut.clearFilters(),children:"Clear filters"}),Ut.searchTerm&&t.jsx("button",{type:"button",className:"btn secondary",onClick:()=>Ut.setSearchTerm(""),children:"Reset search"})]})})]}):t.jsx("div",{className:"empty-state",children:Mt?t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"empty-title",children:"No entities of this type yet."}),t.jsx("button",{type:"button",className:"btn secondary",onClick:Ki,children:"View all entities"})]}):Se?t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"empty-title",children:"No entities yet."}),t.jsxs("p",{children:["Click ",t.jsx("strong",{children:"Add Entity"})," to create your first entity."]})]}):t.jsx("p",{children:"Nothing to show right now."})}),we.open&&t.jsxs("div",{className:"column-context-menu",style:{top:we.y,left:we.x},role:"menu",children:[t.jsx("button",{type:"button",onClick:()=>ha(we.columnKey),children:Ut.groupBy===we.columnKey?"Remove grouping":`Group by ${we.columnLabel}`}),Ut.groupBy&&Ut.groupBy!==we.columnKey&&t.jsx("button",{type:"button",onClick:()=>ha(""),children:"Clear grouping"})]}),t.jsx(Zj,{open:Ct,onClose:()=>At(!1),fields:Un,value:Ut.filters,worldId:Te,onApply:ye=>{Ut.setFilters(ye),At(!1)}}),t.jsx(Ps,{isOpen:M,onClose:na,title:io,width:420,footerActions:t.jsxs(t.Fragment,{children:[t.jsx("button",{type:"button",className:"btn cancel",onClick:na,disabled:De.cancelDisabled,children:"Cancel"}),De.accessButtonVisible&&t.jsx("button",{type:"button",className:"btn secondary",onClick:()=>ht(ye=>ye==="access"?"details":"access"),disabled:De.accessButtonDisabled,children:mt==="access"?"Details":"Access"}),t.jsx("button",{type:"submit",className:"btn submit",form:Rt.current,disabled:De.submitDisabled,children:De.submitLabel})]}),children:t.jsx(w1,{worldId:lt?"":Te,entityId:T,onCancel:na,onSaved:hs,formId:Rt.current,onStateChange:Xs,hideActions:!0,selectedEntityTypeId:Mt?jt:"",activeView:mt,onViewChange:ht,defaultCampaignId:i?.id||""})})]})}function j1({tabs:e=[],activeTab:n,onChange:s}){if(!Array.isArray(e)||e.length===0)return null;const i=l=>{typeof s=="function"&&s(l)};return t.jsx("nav",{className:"tab-nav flex flex-wrap gap-2",role:"tablist",children:e.map(l=>{const{id:o,label:d}=l,f=o===n;return t.jsx("button",{type:"button",role:"tab","aria-selected":f,className:`tab-nav-button whitespace-nowrap px-3 py-2 ${f?"is-active":""}`,onClick:()=>i(o),children:d},o)})})}const JD=(e,n)=>{const s=new URLSearchParams;n&&s.set("campaignId",n);const i=s.toString(),l=i?`/entities/${e}/follow?${i}`:`/entities/${e}/follow`;return kt.post(l)},E1=(e,n)=>{const s=new URLSearchParams;n&&s.set("campaignId",n);const i=s.toString(),l=i?`/entities/${e}/follow?${i}`:`/entities/${e}/follow`;return kt.delete(l)},e4=e=>{const n=new URLSearchParams;e&&n.set("campaignId",e);const s=n.toString(),i=s?`/entities/followed?${s}`:"/entities/followed";return kt.get(i)},t4=(e,n)=>{const s=new URLSearchParams;n&&s.set("campaignId",n);const i=s.toString(),l=i?`/entities/${e}/follow-status?${i}`:`/entities/${e}/follow-status`;return kt.get(l)};function n4({entityId:e}){const{user:n}=un(),{selectedCampaignId:s}=wn(),[i,l]=u.useState(!1),[o,d]=u.useState(!1),[f,p]=u.useState(!0);u.useEffect(()=>{if(!e||!s||!n?.id){p(!1);return}(async()=>{try{p(!0);const g=await t4(e,s);l(g?.following??!1)}catch(g){console.error("Failed to check follow status",g),l(!1)}finally{p(!1)}})()},[e,s,n?.id]);const h=async()=>{if(!e||!s||o||f)return;const y=!i;d(!0);try{y?await JD(e,s):await E1(e,s),l(y)}catch(g){console.error("Failed to toggle follow",g),l(!y)}finally{d(!1)}};return s?f?t.jsx("button",{type:"button",className:"entity-follow-button",disabled:!0,title:"Checking follow status...",children:t.jsx(Pl,{size:18})}):t.jsx("button",{type:"button",className:`entity-follow-button ${i?"following":""}`,onClick:h,disabled:o,title:i?"Unfollow entity":"Follow entity",children:i?t.jsx(Nf,{size:18}):t.jsx(Pl,{size:18})}):null}function a4({entityId:e,name:n,canEdit:s,isEditing:i,onToggleEdit:l,onSave:o,isSaving:d=!1,isSaveDisabled:f=!1,isMobile:p=!1}){const h=n||"Untitled entity",y=()=>{typeof l=="function"&&l()},g=()=>{typeof o=="function"&&o()};return t.jsxs("div",{className:"entity-header flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 sm:gap-2",role:"banner",children:[t.jsx("div",{className:"entity-header-center",children:t.jsx("h1",{className:p?"entity-header-title-mobile":"",children:h})}),t.jsxs("div",{className:"entity-header-right",children:[e&&t.jsx(n4,{entityId:e}),s?t.jsxs("div",{className:"entity-header-actions",children:[i&&typeof o=="function"?t.jsx("button",{type:"button",className:"btn submit",onClick:g,disabled:f||d,children:d?"Saving":"Save"}):null,t.jsxs("button",{type:"button",className:`edit-mode-toggle ${i?"is-active":""}`,role:"switch","aria-checked":i,onClick:y,children:[t.jsx("span",{className:"edit-mode-toggle-track","aria-hidden":"true",children:t.jsx("span",{className:"edit-mode-toggle-thumb"})}),t.jsx("span",{className:"edit-mode-toggle-text",children:"Edit"})]})]}):null]})]})}const s4=[{value:"critical",label:"Critical",icon:ta,color:"#dc2626"},{value:"important",label:"Important",icon:Jl,color:"#ea580c"},{value:"medium",label:"Medium",icon:hg,color:"#6b7280"},{value:null,label:"None",icon:Bn,color:"#9ca3af"}];function r4({entityId:e,importance:n,onUpdate:s}){const{selectedCampaignId:i}=wn(),[l,o]=u.useState(!1);if(!i)return null;const d=async f=>{if(!(l||f===n)){o(!0);try{await uI(e,f),s?.(f)}catch(p){console.error("Failed to update entity importance",p)}finally{o(!1)}}};return t.jsxs("div",{className:"entity-importance-selector",children:[t.jsx("span",{className:"entity-importance-label",children:"Importance:"}),t.jsx("div",{className:"entity-importance-buttons",children:s4.map(f=>{const p=f.icon,h=n===f.value;return t.jsxs("button",{type:"button",className:`entity-importance-button ${h?"selected":""}`,onClick:()=>d(f.value),disabled:l,title:f.label,style:h?{"--importance-color":f.color}:{},children:[t.jsx(p,{size:16}),t.jsx("span",{className:"entity-importance-button-label",children:f.label})]},f.value||"none")})})]})}var Sp={exports:{}},wp,PS;function i4(){if(PS)return wp;PS=1;var e="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED";return wp=e,wp}var Np,HS;function l4(){if(HS)return Np;HS=1;var e=i4();function n(){}function s(){}return s.resetWarningCache=n,Np=function(){function i(d,f,p,h,y,g){if(g!==e){var b=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw b.name="Invariant Violation",b}}i.isRequired=i;function l(){return i}var o={array:i,bigint:i,bool:i,func:i,number:i,object:i,string:i,symbol:i,any:i,arrayOf:l,element:i,elementType:i,instanceOf:l,node:i,objectOf:l,oneOf:l,oneOfType:l,shape:l,exact:l,checkPropTypes:s,resetWarningCache:n};return o.PropTypes=o,o},Np}var VS;function o4(){return VS||(VS=1,Sp.exports=l4()()),Sp.exports}var c4=o4();const Ot=Pi(c4);function qg({maxWidth:e=1280,className:n="",children:s}){const l={"--entity-page-max-width":typeof e=="number"?`${e}px`:e},o=["entity-page-layout",n].filter(Boolean).join(" ");return t.jsx("div",{className:o,style:l,children:t.jsx("div",{className:"entity-page-layout__inner",children:s})})}qg.propTypes={maxWidth:Ot.oneOfType([Ot.number,Ot.string]),className:Ot.string,children:Ot.node};const u4=new Set(["image/png","image/jpeg","image/jpg"]),d4=2*1024*1024,f4=e=>Number.isFinite(e)?e>=1024*1024?`${(e/(1024*1024)).toFixed(1)} MB`:e>=1024?`${(e/1024).toFixed(1)} KB`:`${e} bytes`:"";function m4({entity:e,canEdit:n,isEditing:s,onEntityUpdate:i,variant:l="card"}){const[o,d]=u.useState(null),[f,p]=u.useState(""),[h,y]=u.useState(""),[g,b]=u.useState(!1),[v,S]=u.useState(!1),N=u.useRef(null),[j,E]=u.useState(null),A=!!e?.id,M=!!(e?.imageData&&e?.imageMimeType),_=u.useMemo(()=>ao(e),[e]),T=f||_,k=e?.name?`${e.name} artwork`:"Entity artwork",C=l==="compact",L=u.useCallback(()=>{d(null),p($=>($&&URL.revokeObjectURL($),"")),E(null),y(""),N.current&&(N.current.value="")},[]);u.useEffect(()=>()=>{f&&URL.revokeObjectURL(f)},[f]),u.useEffect(()=>{!s&&o&&L()},[s,o,L]);const z=()=>{!n||!s||g||v||N.current?.click()},G=$=>{const F=$.target.files?.[0];if(F){if(!u4.has(F.type)){y("Only PNG or JPG images are allowed."),$.target.value="";return}if(F.size>d4){y("Image must be smaller than 2 MB."),$.target.value="";return}y(""),d(F),E(null),p(H=>(H&&URL.revokeObjectURL(H),URL.createObjectURL(F)))}},U=u.useCallback($=>{$&&typeof i=="function"&&i($)},[i]),X=async()=>{if(!(!o||!A)){b(!0),y("");try{const $=j?await S1(o,j):o,F=await Bj(e.id,$),H=Ya(F);if(!H)throw new Error("Failed to upload image");U(H),L()}catch($){y($.message||"Failed to upload image")}finally{b(!1)}}},V=async()=>{if(A){S(!0),y("");try{const $=await Uj(e.id),F=Ya($);if(F)U(F);else{const H=Kj({...e||{},imageData:null,imageMimeType:null,image_data:null,image_mime_type:null});U(H)}L()}catch($){y($.message||"Failed to delete image")}finally{S(!1)}}},R=u.useMemo(()=>{const $=["PNG or JPG up to 2 MB.","Uploads are resized to 256256 JPG (~70% quality, ~150 KB)."];return o&&$.push(`Selected: ${o.name} (${f4(o.size)})`),$.join(" ")},[o]),B=C?"div":"section",D=C?"entity-image-card entity-image-card--compact":"entity-card entity-image-card",O=u.useCallback($=>{E($)},[]);return u.useEffect(()=>{o||E(null)},[o]),t.jsxs(B,{className:D,children:[t.jsxs("div",{className:"entity-card-header",children:[t.jsxs("div",{children:[t.jsx("h3",{className:"entity-card-title",children:"Image"}),t.jsx("p",{children:C?"Shown in the dossier summary.":"Displayed on the dossier tab."})]}),n&&s?t.jsxs("div",{className:"entity-card-actions",children:[M&&!o?t.jsx("button",{type:"button",className:"btn secondary",onClick:V,disabled:v,children:v?"Removing":t.jsxs("span",{className:"entity-image-action-label",children:[t.jsx(zn,{size:16,"aria-hidden":"true"})," Remove image"]})}):null,t.jsx("button",{type:"button",className:"btn secondary",onClick:z,disabled:g||v,children:t.jsxs("span",{className:"entity-image-action-label",children:[t.jsx(Qk,{size:16,"aria-hidden":"true"})," Choose image"]})})]}):null]}),t.jsxs("div",{className:"entity-card-body",children:[t.jsxs("div",{className:`entity-image-preview ${T&&!o?"has-image":""}`.trim(),children:[o&&f?t.jsx(v1,{src:f,size:220,onCropChange:O}):T?t.jsx("img",{src:T,alt:k,loading:"lazy"}):t.jsxs("div",{className:"entity-image-placeholder",children:[t.jsx(ZM,{size:32,"aria-hidden":"true"}),t.jsx("p",{children:"No image uploaded"})]}),o?t.jsx("button",{type:"button",className:"entity-image-preview-clear",onClick:L,disabled:g,"aria-label":"Clear selected image",children:t.jsx(Bn,{size:16,"aria-hidden":"true"})}):null]}),o&&n&&s?t.jsxs("div",{className:"entity-image-actions",children:[t.jsx("button",{type:"button",className:"btn submit",onClick:X,disabled:g,children:g?"Uploading":"Save Image"}),t.jsx("button",{type:"button",className:"btn secondary",onClick:L,disabled:g,children:"Cancel"})]}):null,t.jsx("input",{type:"file",ref:N,accept:"image/png,image/jpeg",onChange:G,hidden:!0}),t.jsx("p",{className:"entity-image-helper",children:R}),h?t.jsx("p",{className:"entity-image-status entity-image-status--error",children:h}):null,!h&&g?t.jsx("p",{className:"entity-image-status",children:"Uploading image"}):null,!h&&v?t.jsx("p",{className:"entity-image-status",children:"Removing image"}):null]})]})}function _1({open:e,eyebrowLabel:n="Heads up",title:s="Unsaved changes",description:i="You have unsaved changes on this record.",destinationLabel:l="",saving:o=!1,onSaveAndContinue:d,onContinueWithoutSaving:f,onStay:p}){if(!e)return null;const h=l?` before continuing to ${l}`:"";return t.jsx("div",{className:"unsaved-dialog-backdrop",role:"dialog","aria-modal":"true",children:t.jsxs("div",{className:"unsaved-dialog",role:"document",children:[t.jsxs("div",{className:"unsaved-dialog-header",children:[t.jsxs("div",{children:[t.jsx("p",{className:"unsaved-dialog-label",children:n}),t.jsx("h2",{children:s})]}),t.jsx("button",{type:"button",className:"icon-btn","aria-label":"Close dialog",onClick:p,children:t.jsx(Bn,{size:18})})]}),t.jsxs("div",{className:"unsaved-dialog-body",children:[t.jsxs("p",{children:[i,h,"."]}),t.jsx("p",{className:"unsaved-dialog-help",children:"Choose an option below to continue."})]}),t.jsxs("div",{className:"unsaved-dialog-actions",children:[t.jsx("button",{type:"button",className:"btn submit",onClick:d,disabled:o,children:o?"Saving":"Save and continue"}),t.jsx("button",{type:"button",className:"btn ghost",onClick:f,disabled:o,children:"Continue without saving"}),t.jsx("button",{type:"button",className:"btn cancel",onClick:p,disabled:o,children:"Stay here"})]})]})})}const jp=()=>({relationshipTypes:{mode:"all",values:[]},relatedEntityTypes:{mode:"all",values:[]}}),h4=e=>e==null?"":String(e).trim(),Bf=e=>{let n={};typeof e=="string"?n={worldId:e}:e&&typeof e=="object"&&!Array.isArray(e)&&(n={...e});const s=new URLSearchParams,i=h4(n.worldId??n.world_id);i&&s.set("worldId",i);const l=s.toString(),o=l?`?${l}`:"";return kt.get(`/entity-relationship-types${o}`)},p4=e=>kt.get(`/entity-relationship-types/${e}`),y4=e=>kt.post("/entity-relationship-types",e),g4=(e,n)=>kt.patch(`/entity-relationship-types/${e}`,n),b4=e=>kt.delete(`/entity-relationship-types/${e}`);function x4({worldId:e,onCreated:n}){const[s,i]=u.useState(""),[l,o]=u.useState(""),[d,f]=u.useState(""),[p,h]=u.useState(!1),[y,g]=u.useState(""),[b,v]=u.useState([]);u.useEffect(()=>{let N=!1;return(async()=>{if(!e){v([]);return}try{const E=await wr({worldId:e});if(!N){const A=Array.isArray(E?.data)?E.data:E;v(Array.isArray(A)?A:[])}}catch(E){N||(console.error(" Failed to load entity types",E),v([]))}})(),()=>{N=!0}},[e]);const S=async N=>{if(N.preventDefault(),!s||!l){g("Name and type are required.");return}try{h(!0),g("");const E=await gg({world_id:e,name:s,description:d,entity_type_id:l,visibility:"visible"}),A=E?.data||E;n(A),i(""),o(""),f("")}catch(j){console.error(" Failed to create entity inline",j),g(j.message||"Failed to create entity")}finally{h(!1)}};return t.jsxs("form",{className:"inline-entity-creator",onSubmit:S,children:[t.jsx("h4",{children:"Create New Entity"}),y&&t.jsx("div",{className:"alert error",children:y}),t.jsxs("div",{className:"form-row",children:[t.jsx("label",{children:"Name"}),t.jsx("input",{type:"text",value:s,onChange:N=>i(N.target.value),placeholder:"Entity name..."})]}),t.jsxs("div",{className:"form-row",children:[t.jsx("label",{children:"Type"}),t.jsxs("select",{value:l,onChange:N=>o(N.target.value),children:[t.jsx("option",{value:"",children:"Select type..."}),b.map(N=>t.jsx("option",{value:N.id,children:N.name},N.id))]})]}),t.jsxs("div",{className:"form-row",children:[t.jsx("label",{children:"Description"}),t.jsx("textarea",{rows:"2",value:d,onChange:N=>f(N.target.value),placeholder:"Optional..."})]}),t.jsx("div",{className:"form-actions",children:t.jsx("button",{type:"submit",className:"btn primary",disabled:p||!e,children:p?"Creating":"Create Entity"})})]})}function C1({worldId:e,fromEntity:n=null,onCreated:s,onCancel:i,existingRelationships:l=[]}){const[o,d]=u.useState([]),[f,p]=u.useState(!0),[h,y]=u.useState(""),[g,b]=u.useState(null),[v,S]=u.useState(null),[N,j]=u.useState(""),[E,A]=u.useState(null),[M,_]=u.useState(!1);u.useEffect(()=>{e&&(p(!0),Bf({worldId:e}).then(O=>{const $=Array.isArray(O?.data)?O.data:O?.data||[];d($||[])}).catch(O=>y(O.message||"Failed to load data")).finally(()=>p(!1)))},[e]),u.useEffect(()=>{if(!n||g||!n.id||!n.name)return;const O={id:n.id,name:n.name,entity_type_id:n.entity_type_id||n.entityType?.id||n.entity_type?.id,entityType:n.entityType||n.entity_type||null,typeName:n.typeName||n.entityType?.name||n.entity_type?.name};b(O)},[n]);const T=O=>{if(!O)return null;const $=O.entity_type_id||O.typeId||O.entityType?.id||O.entity_type?.id,F=O.typeName||O.entityType?.name||O.entity_type?.name;return{...O,entity_type_id:$,typeName:F}},k=O=>O?.name||O?.title||O?.displayName||"Unnamed entity",C=u.useMemo(()=>{const O=T(g),$=T(v);if(!O||!$)return[];const F=O.entity_type_id,H=$.entity_type_id;if(!F||!H)return[];const I=(Y=[])=>Y.map(P=>P.id||P.entity_type_id||P.entityTypeId||P.type_id||P.typeId||P).map(String);return o.map(Y=>{const P=I(Y.from_entity_types),W=I(Y.to_entity_types),le=P.includes(String(F))&&W.includes(String(H)),K=P.includes(String(H))&&W.includes(String(F));return le||K?{...Y,_supportsDirect:le,_supportsReverse:K}:null}).filter(Boolean)},[o,g,v]),L=u.useMemo(()=>C.find(O=>String(O.id)===String(N)),[N,C]),z=u.useMemo(()=>L?E==="reverse"&&L._supportsReverse?"reverse":E==="direct"&&L._supportsDirect||L._supportsDirect?"direct":L._supportsReverse?"reverse":null:null,[E,L]);u.useEffect(()=>{if(!L){E!==null&&A(null);return}if(z===null){E!==null&&A(null);return}if(E===null){A(z);return}E!==z&&A(z)},[L,z,E]),u.useEffect(()=>{if(!N)return;C.some($=>String($.id)===String(N))||(j(""),A(null))},[C,N]);const G=z==="direct"?g:v,U=z==="direct"?v:g,X=k(G),V=k(U),R=L?.from_name||L?.fromName||L?.name||"relates to",B=L?.to_name||L?.toName||L?.name||"relates to",D=async()=>{if(y(""),!g||!v||!N)return y("Please select both entities and a relationship type.");if(g.id===v.id)return y("Cannot create self-relationships.");if(l.find(I=>(I.from_entity_id===g.id&&I.to_entity_id===v.id||I.from_entity_id===v.id&&I.to_entity_id===g.id)&&I.relationship_type_id===N)){y("This relationship already exists.");return}const $=z;if(!L||!$){y("Please select a valid relationship type.");return}const F=$==="direct"?g.id:v.id,H=$==="direct"?v.id:g.id;try{await b1({from_entity_id:F,to_entity_id:H,relationship_type_id:N}),s?.({from_entity_id:F,to_entity_id:H,relationship_type_id:N,__direction:$})}catch(I){I.response?.status===409||I.response?.data?.message?.toLowerCase?.().includes("duplicate")||I.message?.toLowerCase?.().includes("duplicate")||I.message?.toLowerCase?.().includes("conflict")?y("This relationship already exists."):I.response?.data?.message?y(I.response.data.message):y("Failed to create relationship."),console.warn(" Relationship create error:",I)}};return f?t.jsx("p",{children:"Loading relationship data"}):t.jsxs("div",{className:"relationship-builder-v3",children:[t.jsx("h2",{children:"Add Relationship"}),h&&t.jsx("div",{className:"alert error",children:h}),t.jsx("div",{className:"form-row",children:t.jsx(kc,{worldId:e,label:"Entity 1",value:g?.id||"",onChange:O=>{n||(b(O),j(""),A(null))},disabled:!!n})}),t.jsxs("div",{className:"form-row entity2-section",children:[t.jsx(kc,{worldId:e,label:"Entity 2",value:v?.id||"",onChange:O=>S(O)}),!M&&t.jsx("button",{type:"button",className:"btn small tertiary",onClick:()=>_(!0),style:{alignSelf:"flex-start",marginTop:"0.4rem"},children:"+ Create new entity"}),M&&t.jsx(x4,{worldId:e,onCreated:async O=>{try{const $=await Hs(O.id),F=Ya($)||O;S(F)}catch{S(O)}_(!1)}})]}),g&&v&&t.jsxs("div",{className:"form-row",children:[t.jsx("label",{children:"Relationship Type"}),t.jsxs("select",{value:N,onChange:O=>{const $=O.target.value;if(j($),!$){A(null);return}const F=C.find(H=>String(H.id)===String($));F?._supportsDirect?A("direct"):F?._supportsReverse?A("reverse"):A(null)},children:[t.jsx("option",{value:"",children:"Select relationship type"}),C.length>0?C.map(O=>t.jsxs("option",{value:O.id,children:[O.name," (",O.from_name,"  ",O.to_name,")"]},O.id)):t.jsx("option",{disabled:!0,children:"No valid relationship types"})]})]}),g&&v&&L&&z&&t.jsxs("div",{className:"relationship-preview",children:[t.jsxs("div",{className:"preview-header",children:[t.jsx("h3",{children:"Relationship preview"}),L._supportsDirect&&L._supportsReverse&&t.jsx("button",{type:"button",className:"btn small secondary",onClick:()=>A(O=>O==="reverse"?"direct":"reverse"),children:"Swap entities"})]}),t.jsxs("p",{children:[t.jsx("strong",{children:X})," ",R," ",t.jsx("strong",{children:V})]}),t.jsxs("p",{children:[t.jsx("strong",{children:V})," ",B," ",t.jsx("strong",{children:X})]})]}),t.jsxs("div",{className:"form-actions",children:[t.jsx("button",{className:"btn primary",disabled:!g||!v||!N,onClick:D,children:"Create Relationship"}),t.jsx("button",{className:"btn secondary",onClick:i,children:"Cancel"})]})]})}const A1=["global","selective","hidden"],v4=[...A1,"owner_only"],YS=new Set(A1),GS=new Set(v4),Ep=(e,n)=>{if(typeof e!="string")return"global";const s=e.toLowerCase();return n.has(s)?s:"global"},ac=e=>e?Array.isArray(e)?e.map(n=>n==null?"":String(n).trim()).filter(Boolean):typeof e=="string"?e.split(",").map(n=>n.trim()).filter(Boolean):[]:[],_p=()=>({campaigns:[],users:[],characters:[]});function S4(e,n,s){const i=e?.id,l=e?.world?.id||e?.world_id||"",o=u.useMemo(()=>e?{readMode:Ep(e.read_access||e.readAccess,YS),readCampaigns:ac(e.read_campaign_ids||e.readCampaignIds),readUsers:ac(e.read_user_ids||e.readUserIds),readCharacters:ac(e.read_character_ids||e.readCharacterIds),writeMode:Ep(e.write_access||e.writeAccess,GS),writeCampaigns:ac(e.write_campaign_ids||e.writeCampaignIds),writeUsers:ac(e.write_user_ids||e.writeUserIds)}:{readMode:"global",readCampaigns:[],readUsers:[],readCharacters:[],writeMode:"global",writeCampaigns:[],writeUsers:[]},[e]),[d,f]=u.useState(o),[p,h]=u.useState(()=>_p()),[y,g]=u.useState(!1),[b,v]=u.useState(""),[S,N]=u.useState(!1),[j,E]=u.useState(""),[A,M]=u.useState("");u.useEffect(()=>{f(o)},[o]);const _=u.useCallback(async()=>{if(n){if(!l){h(_p()),v(""),g(!1);return}g(!0),v("");try{const z=await Bg(l);h({campaigns:z.campaigns??[],users:z.users??[],characters:z.characters??[]})}catch(z){console.error(" Failed to load access options",z),h(_p()),v(z.message||"Failed to load access options")}finally{g(!1)}}},[n,l]);u.useEffect(()=>{_()},[_]);const T=u.useMemo(()=>{const z=["readMode","readCampaigns","readUsers","readCharacters","writeMode","writeCampaigns","writeUsers"],G=U=>Array.isArray(U)?U.map(X=>String(X).trim()).filter(Boolean).sort():[];return z.some(U=>{const X=d[U],V=o[U];if(Array.isArray(X)||Array.isArray(V)){const R=G(X),B=G(V);return R.length!==B.length?!0:R.some((D,O)=>D!==B[O])}return X!==V})},[d,o]),k=u.useCallback((z,G)=>{E(""),M(""),f(U=>{const X={...U};if(z==="readMode"||z==="writeMode"){const R=Ep(G,z==="readMode"?YS:GS);return X[z]=R,z==="readMode"&&R!=="selective"&&(X.readCampaigns=[],X.readUsers=[],X.readCharacters=[]),z==="writeMode"&&R!=="selective"&&(X.writeCampaigns=[],X.writeUsers=[]),X}return["readCampaigns","readUsers","readCharacters","writeCampaigns","writeUsers"].includes(z)?(X[z]=Array.isArray(G)?G.map(V=>String(V).trim()).filter(Boolean):[],X):(X[z]=G,X)})},[]),C=u.useCallback(()=>{f(o),E(""),M("")},[o]),L=u.useCallback(async()=>{if(!s||!i)return!1;if(!T)return!0;E(""),M(""),N(!0);try{const z={read_access:d.readMode,write_access:d.writeMode,read_campaign_ids:d.readMode==="selective"?d.readCampaigns:[],read_user_ids:d.readMode==="selective"?d.readUsers:[],read_character_ids:d.readMode==="selective"?d.readCharacters:[],write_campaign_ids:d.writeMode==="selective"?d.writeCampaigns:[],write_user_ids:d.writeMode==="selective"?d.writeUsers:[]},G=await bg(i,z);if(!(G?.data||G))throw new Error("Failed to save access settings");return M("Access settings saved."),!0}catch(z){return console.error(" Failed to save access settings",z),E(z.message||"Failed to save access settings"),!1}finally{N(!1)}},[s,i,d,T]);return{accessSettings:d,accessOptions:p,accessOptionsError:b,accessOptionsLoading:y,accessSaving:S,accessSaveError:j,accessSaveSuccess:A,isAccessDirty:T,handleAccessSettingChange:k,resetAccessSettings:C,handleAccessSave:L}}function w4(e){const n=u.useMemo(()=>typeof e=="function"?e:()=>!1,[e]);return ij(n)||ki}function N4({isEditing:e,canEdit:n,formError:s,formRef:i,editSchema:l,editInitialData:o,handleUpdate:d,handleFormStateChange:f,dossierSchema:p,viewData:h,featuredImageSrc:y,renderSchemaSections:g,imageSection:b,fieldRules:v,viewRuleContext:S}){const N=Array.isArray(p?.sections)?p.sections:[],j=N[0]||null,E=N[1]||null,A=N.slice(2),M=S?.actionsByField??{},_=S?.showRuleTargets??new Set,T=(G,U)=>{if(!G)return null;const X=Number.isFinite(G.columns)?Math.max(1,Number(G.columns)):1,V=Array.isArray(G.fields)?G.fields:[];return V.length?t.jsx("div",{className:`entity-field-grid ${X>1?"grid grid-cols-1 sm:grid-cols-2 gap-4":""}`,style:{"--entity-field-columns":X},children:V.map((R,B)=>{const D=R?.key||R?.name||R?.field||`${U}-${B}`,O=M[D],$=R.visibleByDefault!==void 0?!!R.visibleByDefault:R.visible_by_default!==void 0?!!R.visible_by_default:!0;return Rc(D,O,_,$)?null:t.jsx(Wc,{field:{...R},data:h,mode:"view"},`${U}-${D}`)})}):t.jsx("p",{className:"entity-empty-state",children:"No fields available."})},k=!!y&&!e,C=h?.name||"Entity",L=!!b&&e&&n,z=()=>{if(!k)return g(p,h,"dossier",S);const G={...p||{},sections:A};return t.jsxs(t.Fragment,{children:[t.jsx("section",{className:"entity-card entity-dossier-header-card bg-white rounded-lg border p-4 sm:p-6 w-full",children:t.jsxs("div",{className:"entity-dossier-header",children:[t.jsxs("div",{className:"entity-dossier-header-content",children:[j?.title?t.jsx("h2",{className:"entity-card-title",children:j.title}):null,T(j,"dossier-summary"),E?t.jsx("div",{className:"entity-dossier-description",children:T(E,"dossier-description")}):null]}),t.jsx("div",{className:"entity-dossier-header-image sm:ml-6 sm:w-64 w-full mt-4 sm:mt-0",children:t.jsx("img",{src:y,alt:`${C} artwork`,loading:"lazy"})})]})}),g(G,h,"dossier",S)]})};return t.jsxs("div",{className:"entity-tab-content",children:[s&&t.jsx("section",{className:"entity-card bg-white rounded-lg border p-4 sm:p-6 w-full",children:t.jsx("div",{className:"alert error",role:"alert",children:s})}),e&&n?t.jsx("section",{className:"entity-card entity-card--form entity-edit-form-wrapper bg-white rounded-lg border p-4 sm:p-6 w-full",children:t.jsxs("div",{className:"entity-edit-form-container",children:[t.jsx("div",{className:"entity-edit-form-content",children:t.jsx(us,{ref:i,schema:l,initialData:o||{},onSubmit:d,onStateChange:f,hideActions:!0,enableUnsavedPrompt:!1,fieldRules:v})}),L?t.jsx("div",{className:"entity-edit-form-image sm:ml-6 sm:w-64 w-full mt-4 sm:mt-0",children:b}):null]})}):z()]})}function j4({entity:e,toast:n,onExplore:s,canEdit:i,relationshipsLoading:l,relationshipsError:o,filteredRelationships:d,sortedRelationships:f,relationshipsEmptyMessage:p,relationshipFilters:h,relationshipFilterOptions:y,filterButtonDisabled:g,handleRelationshipFiltersChange:b,handleRelationshipFiltersReset:v,showRelationshipForm:S,setShowRelationshipForm:N,worldId:j,loadRelationships:E}){const[A,M]=u.useState(!1),_=S!==void 0?S:A,[T,k]=u.useState(!1),C=u.useRef(null);u.useEffect(()=>{if(!T)return;const O=F=>{C.current&&(C.current.contains(F.target)||k(!1))},$=F=>{F.key==="Escape"&&k(!1)};return document.addEventListener("mousedown",O),document.addEventListener("touchstart",O),document.addEventListener("keydown",$),()=>{document.removeEventListener("mousedown",O),document.removeEventListener("touchstart",O),document.removeEventListener("keydown",$)}},[T]);const L=Array.isArray(y?.relationshipTypes)?y.relationshipTypes:[],z=Array.isArray(y?.relatedEntityTypes)?y.relatedEntityTypes:[],G=h?.relationshipTypes?.values||[],U=h?.relatedEntityTypes?.values||[],X=O=>{const $=Array.from(O.target.selectedOptions,F=>F.value);b&&b({relationshipTypes:{mode:$.length>0?"include":"all",values:$},relatedEntityTypes:h?.relatedEntityTypes||{mode:"all",values:[]}})},V=O=>{const $=Array.from(O.target.selectedOptions,F=>F.value);b&&b({relationshipTypes:h?.relationshipTypes||{mode:"all",values:[]},relatedEntityTypes:{mode:$.length>0?"include":"all",values:$}})},R=()=>{v&&v(),k(!1)},B=()=>{k(!1)},D=G.length>0||U.length>0;return t.jsxs(t.Fragment,{children:[n&&t.jsxs("div",{className:`toast-banner ${n.tone}`,role:"status",children:[t.jsx("span",{children:n.message}),n.link?t.jsx(Yt,{to:n.link.to,className:"toast-banner-link",children:n.link.label}):null]}),t.jsxs("div",{className:"bg-white border border-neutral-200 rounded-xl shadow-sm p-6 mb-6 w-full",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx("h2",{className:"text-xl font-semibold",children:"Relationships"}),t.jsxs("div",{className:"flex items-center gap-2",children:[typeof s=="function"?t.jsx("button",{type:"button",className:"btn-secondary",onClick:s,children:"Explore"}):null,t.jsxs("div",{className:"relative",ref:C,children:[t.jsx("button",{id:"filterButton",type:"button",className:`btn-secondary${D?" is-active":""}`,onClick:()=>k(O=>!O),disabled:g,children:"Filter"}),T&&!g?t.jsxs("div",{className:"bg-white border border-neutral-200 rounded-lg shadow-lg p-4 w-[260px] absolute top-full mt-2 right-0 z-10",children:[t.jsxs("div",{className:"mb-4",children:[t.jsx("label",{className:"text-sm font-medium text-neutral-700 mb-1 block",children:"Relationship Types"}),t.jsx("select",{className:"w-full border border-neutral-300 rounded-md px-3 py-1 text-sm",multiple:!0,size:5,value:G,onChange:X,children:L.map(O=>t.jsx("option",{value:O.value,children:O.label},O.value))})]}),t.jsxs("div",{className:"mb-4",children:[t.jsx("label",{className:"text-sm font-medium text-neutral-700 mb-1 block",children:"Related Entity Types"}),t.jsx("select",{className:"w-full border border-neutral-300 rounded-md px-3 py-1 text-sm",multiple:!0,size:5,value:U,onChange:V,children:z.map(O=>t.jsx("option",{value:O.value,children:O.label},O.value))})]}),t.jsxs("div",{className:"flex items-center justify-between mt-2",children:[t.jsx("button",{type:"button",className:"text-sm text-neutral-600 hover:text-neutral-900",onClick:R,children:"Clear filters"}),t.jsx("button",{type:"button",className:"btn-secondary text-sm",onClick:B,children:"Done"})]})]}):null]}),i&&t.jsx("button",{type:"button",className:"btn-primary",onClick:()=>{N&&N(!0),S===void 0&&M(!0)},children:"Add relationship"})]})]}),l?t.jsx("p",{children:"Loading relationships..."}):o?t.jsx("div",{className:"alert error",role:"alert",children:o}):f.length===0?t.jsx("p",{className:"text-sm text-neutral-500",children:p}):d.length===0?t.jsx("p",{className:"text-sm text-neutral-500",children:"No relationships match your filters."}):t.jsxs("table",{className:"w-full text-sm",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"text-left text-neutral-600 border-b border-neutral-200",children:[t.jsx("th",{className:"py-2 font-medium",children:"Relationship"}),t.jsx("th",{className:"py-2 font-medium",children:"Type"}),t.jsx("th",{className:"py-2 font-medium",children:"Direction"})]})}),t.jsx("tbody",{children:d.map(O=>{const $=String(O.fromId)===String(e.id),F=$?O.toName:O.fromName,H=$?O.toId:O.fromId,I=O.sourceLabel||O.source_relationship_label||"",Y=O.targetLabel||O.target_relationship_label||"";return t.jsxs("tr",{className:"border-b border-neutral-100 last:border-0",children:[t.jsxs("td",{className:"py-3",children:[t.jsx("strong",{children:e.name})," ",$?I:Y," ",t.jsx(Yt,{to:`/entities/${H}`,className:"text-blue-600 hover:underline",children:F||""}),H?t.jsx(Na,{entityId:H,entityName:F}):null]}),t.jsx("td",{className:"py-3",children:O.typeName||""}),t.jsx("td",{className:"py-3",children:$?"Outgoing":"Incoming"})]},O.id)})})]})]}),j&&e?t.jsx(Ps,{isOpen:_,onClose:()=>{N?N(!1):M(!1)},title:"Add relationship",description:"Link this entity to others without leaving the page.",size:"md",children:t.jsx(C1,{worldId:j,fromEntity:e,onCreated:()=>{N?N(!1):M(!1),E&&E()},onCancel:()=>{N?N(!1):M(!1)}})}):null]})}function E4({canEdit:e,worldId:n,accessSettings:s,accessOptions:i,accessOptionsError:l,accessOptionsLoading:o,accessSaving:d,accessSaveError:f,accessSaveSuccess:p,handleAccessSettingChange:h}){return t.jsx("div",{className:"entity-tab-content",children:t.jsxs("section",{className:"entity-card entity-access-card",children:[t.jsx("h2",{className:"entity-card-title",children:"Access controls"}),t.jsx("p",{className:"entity-access-note help-text",children:"Configure who can view and edit this entity. Users with write access will automatically receive read access. Changes are saved along with the rest of the record."}),l&&t.jsx("div",{className:"alert error",role:"alert",children:l}),n?t.jsxs(t.Fragment,{children:[t.jsx(zg,{canEdit:e,accessSettings:s,accessOptions:i,accessOptionsLoading:o,accessSaving:d,onSettingChange:h}),t.jsxs("div",{className:"entity-access-actions",children:[f&&t.jsx("div",{className:"alert error",role:"alert",children:f}),p&&t.jsx("div",{className:"alert success",role:"status",children:p})]})]}):t.jsx("p",{className:"entity-empty-state",children:"Assign this entity to a world to configure access settings."})]})})}function _4({renderSchemaSections:e,systemSchema:n,viewData:s}){return t.jsx("div",{className:"entity-tab-content",children:e(n,s,"system")})}const WS=e=>{if(!e)return"";const n=new Date(e);return Number.isNaN(n.getTime())?"":n.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})},hd=e=>{if(!e)return"";const n=e.username?.trim?.()||"",s=e.email?.trim?.()||"";return n&&s&&n!==s?`${n} (${s})`:n||s||"Unknown user"},C4=e=>Array.isArray(e)?e.filter(n=>n&&typeof n=="object").map(n=>({...n})):[],Cp=(e,n)=>{const s=new Set,i=[];return e.forEach(l=>{if(!l)return;let o=l[n];if(o||(n==="user_id"?o=l.user?.id:n==="campaign_id"&&(o=l.campaign?.id)),!o)return;const d=String(o);s.has(d)||(s.add(d),i.push(l))}),i},XS=(e,n)=>{if(!e)return[];const s=Array.isArray(e.permissions)?e.permissions:[],i=new Set,l=[];return s.forEach(o=>{if(!o)return;let d=o[n];if(d||(n==="user_id"?d=o.user?.id:n==="campaign_id"&&(d=o.campaign?.id)),!d)return;const f=String(d);i.has(f)||(i.add(f),l.push(f))}),l};function A4({entity:e,secrets:n,worldId:s,canManageSecrets:i,onSecretCreated:l,onSecretUpdated:o}){const[d,f]=u.useState(""),[p,h]=u.useState(""),[y,g]=u.useState([]),[b,v]=u.useState([]),[S,N]=u.useState({campaigns:[],users:[]}),[j,E]=u.useState(!1),[A,M]=u.useState(""),[_,T]=u.useState(!1),[k,C]=u.useState(!1),[L,z]=u.useState(""),[G,U]=u.useState(""),[X,V]=u.useState(!1),[R,B]=u.useState(null),D=u.useMemo(()=>!!R?.id,[R?.id]),O=u.useMemo(()=>`entity-secret-create-${e?.id||"new"}`,[e?.id]),$=u.useMemo(()=>C4(n),[n]),F=u.useCallback(()=>{f(""),h(""),g([]),v([])},[]),H=u.useCallback(()=>{k||(B(null),F(),z(""),U(""),V(!0))},[F,k]),I=u.useCallback(re=>{if(!i||k||!re)return;const Ce=re.title??"",Re=re.content??"";f(Ce?String(Ce):""),h(Re?String(Re):""),g(XS(re,"campaign_id")),v(XS(re,"user_id")),N(ue=>{const se=Array.isArray(ue?.campaigns)?[...ue.campaigns]:[],Le=Array.isArray(ue?.users)?[...ue.users]:[],be=(Me,mt,ht)=>{if(!mt)return;const Ct=String(mt);Me.some(At=>At?.value===Ct)||Me.push({value:Ct,label:ht})};return(Array.isArray(re.permissions)?re.permissions:[]).forEach(Me=>{if(!Me)return;const mt=Me.user_id??Me.user?.id;if(mt){const Ct=Me.user?hd(Me.user):`User ${String(mt).slice(0,8)}`;be(Le,mt,Ct)}const ht=Me.campaign_id??Me.campaign?.id;if(ht){const Ct=Me.campaign?.name?Me.campaign.name:`Campaign ${String(ht).slice(0,8)}`;be(se,ht,Ct)}}),{campaigns:se,users:Le}}),B(re),z(""),U(""),V(!0)},[i,k]),Y=u.useCallback(()=>{k||(V(!1),z(""),B(null),F())},[F,k]),P=u.useCallback(async()=>{if(!i||!s){N({campaigns:[],users:[]}),M(""),E(!1),T(!0);return}E(!0),M("");try{const[re,Ce]=await Promise.all([Vc({world_id:s}),Cs({world_id:s})]),ue=(Array.isArray(re?.data)?re.data:Array.isArray(re)?re:[]).map(De=>({value:String(De.id),label:De.name||"Untitled campaign"})),se=Array.isArray(Ce?.data)?Ce.data:Array.isArray(Ce)?Ce:[],Le=[];se.forEach(De=>{const Me=De?.player||{},mt=Me.id||De?.user_id;mt&&Le.push({value:String(mt),label:hd(Me)})});const be=Cp(Le,"value");N({campaigns:ue,users:be}),T(!0)}catch(re){console.error(" Failed to load secret visibility options",re),N({campaigns:[],users:[]}),M(re.message||"Failed to load share options"),T(!0)}finally{E(!1)}},[i,s]);u.useEffect(()=>{T(!1),N({campaigns:[],users:[]}),M("")},[s,i]),u.useEffect(()=>{!X||_||P()},[X,_,P]);const W=async re=>{if(re.preventDefault(),!e?.id||k)return;const Ce=p.trim();if(!Ce){z("Description is required."),U("");return}C(!0),z(""),U("");try{const Re={summary:d.trim()||void 0,description:Ce,campaign_ids:y,user_ids:b};let ue;D&&R?.id?ue=await mI(e.id,R.id,Re):ue=await fI(e.id,Re);const se=ue?.data||ue;D&&R?.id?(o?.(se),U("Secret updated successfully.")):(l?.(se),U("Secret created successfully.")),F(),B(null),V(!1)}catch(Re){z(Re.message||"Failed to save secret")}finally{C(!1)}},le=re=>{if(!i||!Array.isArray(re?.permissions))return null;const Ce=re.permissions.map(se=>({...se})).filter(se=>se);if(Ce.length===0)return t.jsx("p",{className:"entity-secret-shared",children:"Not shared with any campaigns or users."});const Re=Cp(Ce.filter(se=>se.user_id||se.user),"user_id"),ue=Cp(Ce.filter(se=>se.campaign_id||se.campaign),"campaign_id");return t.jsxs("div",{className:"entity-secret-shared",children:[Re.length>0&&t.jsxs("div",{children:[t.jsx("strong",{children:"Shared with players:"}),t.jsx("ul",{className:"entity-secret-share-list",children:Re.map(se=>{const Le=se.user?hd(se.user):`User ${String(se.user_id).slice(0,8)}`,be=se.user_id||Le;return t.jsx("li",{className:"entity-secret-share-pill",children:Le},be)})})]}),ue.length>0&&t.jsxs("div",{children:[t.jsx("strong",{children:"Shared with campaigns:"}),t.jsx("ul",{className:"entity-secret-share-list",children:ue.map(se=>{const Le=se.campaign?.name||`Campaign ${String(se.campaign_id).slice(0,8)}`,be=se.campaign_id||Le;return t.jsx("li",{className:"entity-secret-share-pill",children:Le},be)})})]})]})},K=D?"Edit secret":"Create a secret",de=D?"Update the secret content or who can access it.":"Secrets are hidden notes that are only visible to selected campaigns or players.",Q=D?"Update secret":"Save secret",he=D?"Updating secret...":"Creating secret...";return t.jsxs("div",{className:"entity-tab-content",children:[i&&t.jsx(Ps,{isOpen:X,onClose:Y,title:K,description:de,size:"lg",footerActions:t.jsxs("div",{className:"flex justify-end gap-3",children:[t.jsx("button",{type:"button",className:"border border-neutral-300 bg-white px-4 py-2 rounded-md text-sm hover:bg-neutral-100 text-neutral-700 disabled:opacity-50 disabled:cursor-not-allowed",onClick:Y,disabled:k,children:"Cancel"}),t.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-4 py-2 rounded-md text-sm hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",form:O,disabled:k,children:k?he:Q})]}),children:t.jsxs("form",{id:O,className:"entity-secret-form-body",onSubmit:W,children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"entity-secret-summary",className:"text-sm font-medium text-neutral-700",children:"Summary"}),t.jsx("input",{id:"entity-secret-summary",type:"text",value:d,onChange:re=>f(re.target.value),placeholder:"Short label for this secret (optional)",disabled:k,"data-autofocus":"true",className:"w-full border rounded-md px-3 py-2 text-sm"})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"entity-secret-description",className:"text-sm font-medium text-neutral-700",children:"Description"}),t.jsx("textarea",{id:"entity-secret-description",value:p,onChange:re=>h(re.target.value),rows:4,placeholder:"Detail the secret information...",disabled:k,required:!0,className:"w-full border rounded-md px-3 py-2 text-sm min-h-[120px]"})]}),t.jsxs("div",{className:"entity-secret-share-grid",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"entity-secret-campaigns",className:"text-sm font-medium text-neutral-700",children:"Share with campaigns"}),t.jsx(zs,{inputId:"entity-secret-campaigns",selected:y,options:S.campaigns,onChange:g,placeholder:"Select campaigns...",disabled:k||j,loading:j,noOptionsMessage:j?"Loading campaigns...":"No campaigns available in this world."}),t.jsx("p",{className:"help-text",children:"Dungeon Masters of selected campaigns will be able to read this secret."})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"entity-secret-users",className:"text-sm font-medium text-neutral-700",children:"Share with players"}),t.jsx(zs,{inputId:"entity-secret-users",selected:b,options:S.users,onChange:v,placeholder:"Select users...",disabled:k||j,loading:j,noOptionsMessage:j?"Loading users...":"No eligible players found for this world."}),t.jsx("p",{className:"help-text",children:"Choose specific players who should see this information."})]})]}),A&&t.jsx("div",{className:"alert error",role:"alert",children:A}),L&&t.jsx("div",{className:"alert error",role:"alert",children:L})]})}),t.jsxs("section",{className:"entity-card entity-secret-list-card",children:[t.jsxs("div",{className:"entity-card-header entity-card-header--subtle",children:[t.jsxs("h2",{className:"entity-card-title",children:["Secrets for ",e?.name||"this entity"]}),i&&t.jsx("div",{className:"entity-card-actions",children:t.jsx("button",{type:"button",className:"btn submit",onClick:H,disabled:k,children:"New secret"})})]}),G&&t.jsx("div",{className:"alert success",role:"status",children:G}),$.length===0?t.jsx("p",{className:"entity-empty-state",children:"No secrets available for this entity yet."}):t.jsx("ul",{className:"entity-secret-list",children:$.map(re=>{const Ce=re.createdAt||re.created_at,Re=re.updatedAt||re.updated_at,ue=hd(re.creator);return t.jsxs("li",{className:"entity-secret-item",children:[t.jsxs("div",{className:"entity-secret-header",children:[t.jsx("h3",{children:re.title||"Untitled secret"}),t.jsxs("div",{className:"entity-secret-meta",children:[ue&&t.jsxs("span",{children:["Created by ",ue]}),Ce&&t.jsxs("span",{children:["Created ",WS(Ce)]}),Re&&Re!==Ce&&t.jsxs("span",{children:["Updated ",WS(Re)]})]})]}),i&&t.jsx("div",{className:"entity-secret-actions",children:t.jsx("button",{type:"button",className:"btn secondary",onClick:()=>I(re),disabled:k,children:"Edit secret"})}),re.content?t.jsx("p",{className:"entity-secret-content",children:re.content}):null,le(re)]},re.id||re.createdAt)})})]})]})}function T4(e){if(Array.isArray(e)){for(var n=0,s=new Array(e.length);n<e.length;n++)s[n]=e[n];return s}}function M4(e){if(Symbol.iterator in Object(e)||Object.prototype.toString.call(e)==="[object Arguments]")return Array.from(e)}function k4(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function nf(e){return T4(e)||M4(e)||k4()}function ds(){return ds=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var s=arguments[n];for(var i in s)Object.prototype.hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},ds.apply(this,arguments)}function R4(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function I4(e,n){for(var s=0;s<n.length;s++){var i=n[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function L4(e,n,s){return n&&I4(e.prototype,n),e}function pn(e){if(e===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ay(e,n){return Ay=Object.setPrototypeOf||function(i,l){return i.__proto__=l,i},Ay(e,n)}function D4(e,n){if(typeof n!="function"&&n!==null)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),n&&Ay(e,n)}function zl(e){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?zl=function(s){return typeof s}:zl=function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":typeof s},zl(e)}function Bd(e){return typeof Symbol=="function"&&zl(Symbol.iterator)==="symbol"?Bd=function(s){return zl(s)}:Bd=function(s){return s&&typeof Symbol=="function"&&s.constructor===Symbol&&s!==Symbol.prototype?"symbol":zl(s)},Bd(e)}function O4(e,n){return n&&(Bd(n)==="object"||typeof n=="function")?n:pn(e)}function af(e){return af=Object.setPrototypeOf?Object.getPrototypeOf:function(s){return s.__proto__||Object.getPrototypeOf(s)},af(e)}function fn(e,n,s){return n in e?Object.defineProperty(e,n,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[n]=s,e}var Ap,KS;function $4(){if(KS)return Ap;KS=1;var e=function(n,s,i,l,o,d,f,p){if(!n){var h;if(s===void 0)h=new Error("Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.");else{var y=[i,l,o,d,f,p],g=0;h=new Error(s.replace(/%s/g,function(){return y[g++]})),h.name="Invariant Violation"}throw h.framesToPop=1,h}};return Ap=e,Ap}var F4=$4();const Yl=Pi(F4);function z4(e){if(Array.isArray(e))return e}function B4(e,n){var s=[],i=!0,l=!1,o=void 0;try{for(var d=e[Symbol.iterator](),f;!(i=(f=d.next()).done)&&(s.push(f.value),!(n&&s.length===n));i=!0);}catch(p){l=!0,o=p}finally{try{!i&&d.return!=null&&d.return()}finally{if(l)throw o}}return s}function U4(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function sf(e,n){return z4(e)||B4(e,n)||U4()}function q4(e,n){if(e==null)return{};var s={},i=Object.keys(e),l,o;for(o=0;o<i.length;o++)l=i[o],!(n.indexOf(l)>=0)&&(s[l]=e[l]);return s}function P4(e,n){if(e==null)return{};var s=q4(e,n),i,l;if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(l=0;l<o.length;l++)i=o[l],!(n.indexOf(i)>=0)&&Object.prototype.propertyIsEnumerable.call(e,i)&&(s[i]=e[i])}return s}var Tp,ZS;function H4(){if(ZS)return Tp;ZS=1;function e(n,s,i){return s in n?Object.defineProperty(n,s,{value:i,enumerable:!0,configurable:!0,writable:!0}):n[s]=i,n}return Tp=e,Tp}var V4=H4();const Ic=Pi(V4);var Mp,QS;function Y4(){if(QS)return Mp;QS=1;function e(n){if(Array.isArray(n)){for(var s=0,i=new Array(n.length);s<n.length;s++)i[s]=n[s];return i}}return Mp=e,Mp}var kp,JS;function G4(){if(JS)return kp;JS=1;function e(n){if(Symbol.iterator in Object(n)||Object.prototype.toString.call(n)==="[object Arguments]")return Array.from(n)}return kp=e,kp}var Rp,ew;function W4(){if(ew)return Rp;ew=1;function e(){throw new TypeError("Invalid attempt to spread non-iterable instance")}return Rp=e,Rp}var Ip,tw;function X4(){if(tw)return Ip;tw=1;var e=Y4(),n=G4(),s=W4();function i(l){return e(l)||n(l)||s()}return Ip=i,Ip}var K4=X4();const yr=Pi(K4);var so=function(n){return n===Object(n)?Object.keys(n):[]},T1=function(n){return n===Object(n)?Object.values(n):[]};function M1(e,n){var s=Object.assign({},e);return Ud(e)&&Ud(n)&&so(n).forEach(function(i){Ud(n[i])?i in e?s[i]=M1(e[i],n[i]):Object.assign(s,Ic({},i,n[i])):Object.assign(s,Ic({},i,n[i]))}),s}var Ty=function(n){for(var s=arguments.length,i=new Array(s>1?s-1:0),l=1;l<s;l++)i[l-1]=arguments[l];return i.reduce(function(o,d){return M1(o,d)},n)},Z4=function(n,s){var i=Object.assign({},n);if(s)for(var l=0;l<s.length;l++)delete i[s[l]];return i},Ud=function(n){return n===Object(n)&&!(n instanceof Date)&&!Array.isArray(n)},Q4=function(n){return(n||[]).filter(Boolean)},Pg=function(n){return n[0]==="&"},J4=function(n){return!Pg(n)},nw=function(n){return n.replace(/-(\w)/g,function(s,i){return i.toUpperCase()})},e3=function(n){for(var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[],i=so(n),l={},o=0,d=i.length;o<d;o+=1){var f=i[o],p=Object.prototype.toString.call(n[f])!=="[object Object]"||f[0]===":"||f[0]==="@"||s.indexOf(f)>=0;p&&(l[f]=n[f])}return l},k1=function(n,s){for(var i=s.map(nw),l=so(n),o={},d=0,f=l.length;d<f;d+=1){var p=l[d];(s.indexOf(p)>=0||i.indexOf(nw(p))>=0)&&(o[p]=n[p])}return o},t3=function e(n,s){for(var i=Ty.apply(void 0,[{},Z4(n,s)].concat(yr(T1(k1(n,s))))),l=so(i).filter(Pg),o=0,d=l.length;o<d;o+=1){var f=l[o],p=e(i[f],s);s.indexOf(f)>=0?(delete i[f],i=Ty({},i,p)):i[f]=p}return i};function aw(e,n){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter(function(l){return Object.getOwnPropertyDescriptor(e,l).enumerable})),s.push.apply(s,i)}return s}function sw(e){for(var n=1;n<arguments.length;n++){var s=arguments[n]!=null?arguments[n]:{};n%2?aw(Object(s),!0).forEach(function(i){Ic(e,i,s[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):aw(Object(s)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(s,i))})}return e}var n3=["animationName"],R1=function(n){var s=n.style,i=n.className;return sw(sw({},s?{style:e3(s,n3)}:{}),i?{className:i}:{})},I1=u.createContext(R1);I1.Provider;var L1=function(n){if(n){if(typeof n=="string")return[n];if(!Array.isArray(n)){var s=n;return so(n).reduce(function(i,l){return i.concat(s[l]?[l]:[])},[])}}else return[];return n},a3={},s3=function(n){return function(s,i){var l=i||a3;n.memoize=n.memoize||new WeakMap;var o;n.memoize.has(l)?o=n.memoize.get(l):(o={},n.memoize.set(l,o));var d=L1(s).join(" ");return d in o?o[d]:o[d]=n(s||[],i)}};function rw(e,n){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter(function(l){return Object.getOwnPropertyDescriptor(e,l).enumerable})),s.push.apply(s,i)}return s}function Tl(e){for(var n=1;n<arguments.length;n++){var s=arguments[n]!=null?arguments[n]:{};n%2?rw(Object(s),!0).forEach(function(i){Ic(e,i,s[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):rw(Object(s)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(s,i))})}return e}var r3=function(n){var s=n&&so(n)[0];return s&&s.split("__")[0].split("--")[0]},i3=function(n,s,i){if(n){var l=n.split(" ")[0],o=[].concat(yr(s.length===0?i.map(function(d){return"".concat(l,"--").concat(d.substring(1))}):[]),yr(s.map(function(d){return"".concat(l,"__").concat(d)})));return s.length===0?[n].concat(yr(o)):o}};function D1(e){var n=e.style,s=e.className,i=e.classNames,l=arguments.length>1&&arguments[1]!==void 0?arguments[1]:R1,o=s||r3(i)||n?.className,d=typeof n=="function"?n:s3(function(g,b){var v=L1(g);Yl(Array.isArray(v),"First parameter must be a string, an array of strings, a plain object with boolean values, or a falsy value."),Yl(!b||Ud(b),"Optional second parameter must be a plain object.");var S=v.filter(Pg),N=v.filter(J4),j=N.length>0?function(M){return T1(k1(M,N))}:function(M){return[M]},E=function(){var _=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return j(t3(_,S))},A=i3(o,N,S);return D1(Tl(Tl(Tl({},(n||b)&&{style:Ty.apply(void 0,[{}].concat(yr(E(b)),yr(E(n))))}),A&&{className:A.join(" ")}),i&&{classNames:i}),l)}),f=Tl({},typeof n=="function"?n:{style:n}),p=yr(new Set([].concat(yr(f.className?f.className.split(" "):[]),yr(o?o.split(" "):[])))),h=i?Q4(p.map(function(g){return i[g]})):p,y=l(Tl(Tl({},f),h.length>0?{className:h.join(" ")}:{}));return Object.assign(d,y),d}function iw(e,n){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter(function(l){return Object.getOwnPropertyDescriptor(e,l).enumerable})),s.push.apply(s,i)}return s}function sc(e){for(var n=1;n<arguments.length;n++){var s=arguments[n]!=null?arguments[n]:{};n%2?iw(Object(s),!0).forEach(function(i){Ic(e,i,s[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):iw(Object(s)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(s,i))})}return e}var l3=function(){for(var n=arguments.length,s=new Array(n),i=0;i<n;i++)s[i]=arguments[i];return s.reduce(function(l,o){return sc(sc(sc({},l),typeof o=="function"?o:{}),{},{style:sc(sc({},l.style),typeof o=="function"?o.style:o)})},{})},Hg=function(n,s,i){var l=s.style,o=s.className,d=s.classNames,f=u.useContext(I1),p=u.useMemo(function(){return D1({style:l,className:o,classNames:d},f)},[l,o,d,f]);return p(i,n)},qd=function(n){return n.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")},Fs={id:"__id__",display:"__display__"},lw=function(n,s){Yl(s==="id"||s==="display",'Second arg must be either "id" or "display", got: "'.concat(s,'"'));var i=n.indexOf(Fs.display),l=n.indexOf(Fs.id);return i<0&&(i=null),l<0&&(l=null),Yl(i!==null||l!==null,"The markup '".concat(n,"' does not contain either of the placeholders '__id__' or '__display__'")),i!==null&&l!==null?s==="id"&&l<=i||s==="display"&&i<=l?0:1:0},o3=function(n){var s=/^\/(.+)\/(\w+)?$/;return new RegExp(n.map(function(i){var l=s.exec(i.toString()),o=sf(l,3),d=o[1],f=o[2];return Yl(!f,"RegExp flags are not supported. Change /".concat(d,"/").concat(f," into /").concat(d,"/")),"(".concat(d,")")}).join("|"),"g")},O1=function(n){var s=0;return n.indexOf("__id__")>=0&&s++,n.indexOf("__display__")>=0&&s++,s},c3=function(){},Xc=function(n,s,i){for(var l=arguments.length>3&&arguments[3]!==void 0?arguments[3]:c3,o=o3(s.map(function(T){return T.regex})),d=2,f=s.map(function(T){var k=T.markup,C=d;return d+=O1(k)+1,C}),p,h=0,y=0;(p=o.exec(n))!==null;){var g=f.find(function(T){return!!p[T]}),b=f.indexOf(g),v=s[b],S=v.markup,N=v.displayTransform,j=g+lw(S,"id"),E=g+lw(S,"display"),A=p[j],M=N(A,p[E]),_=n.substring(h,p.index);l(_,h,y),y+=_.length,i(p[0],p.index,y,A,M,b,h),y+=M.length,h=o.lastIndex}h<n.length&&l(n.substring(h),h,y)},Ri=function(n,s){var i="";return Xc(n,s,function(l,o,d,f,p){i+=p},function(l){i+=l}),i},wa=function(n,s,i){var l=arguments.length>3&&arguments[3]!==void 0?arguments[3]:"START";if(typeof i!="number")return i;var o,d=function(h,y,g){o===void 0&&g+h.length>=i&&(o=y+i-g)},f=function(h,y,g,b,v,S,N){o===void 0&&g+v.length>i&&(l==="NULL"?o=null:o=y+(l==="END"?h.length:0))};return Xc(n,s,f,d),o===void 0?n.length:o},jc=function(n,s,i,l){return n.substring(0,s)+l+n.substring(i)},u3=function(n,s,i,l){var o=i.selectionStartBefore,d=i.selectionEndBefore,f=i.selectionEndAfter,p=Ri(n,l),h=p.length-s.length;o==="undefined"&&(o=f+h),d==="undefined"&&(d=o),o===d&&d===f&&p.length===s.length&&(o=o-1);var y=s.slice(o,f),g=Math.min(o,f),b=d;o===f&&(b=Math.max(d,o+h));var v=wa(n,l,g,"START"),S=wa(n,l,b,"END"),N=wa(n,l,g,"NULL"),j=wa(n,l,b,"NULL"),E=N===null||j===null,A=jc(n,v,S,y);if(!E){var M=Ri(A,l);if(M!==s){for(g=0;s[g]===M[g];)g++;y=s.slice(g,f),b=p.lastIndexOf(s.substring(f)),v=wa(n,l,g,"START"),S=wa(n,l,b,"END"),A=jc(n,v,S,y)}}return A},ow=function(n,s,i){var l=i,o=!1,d=function(p,h,y,g,b,v,S){y<=i&&y+b.length>i&&(l=y,o=!0)};if(Xc(n,s,d),o)return l},bc=function(n,s){var i=[];return Xc(n,s,function(l,o,d,f,p,h,y){i.push({id:f,display:p,childIndex:h,index:o,plainTextIndex:d})}),i},$1=function(n,s){return"".concat(n,"-").concat(s)},pd=function(n){return Object.values(n).reduce(function(s,i){var l=i.results;return s+l.length},0)},d3=function(n,s){var i=bc(n,s),l=i[i.length-1];return l?l.plainTextIndex+l.display.length:0},f3=function(n){var s=qd(n),i=n[n.indexOf(Fs.display)+Fs.display.length],l=n[n.indexOf(Fs.id)+Fs.id.length];return new RegExp(s.replace(Fs.display,"([^".concat(qd(i||""),"]+?)")).replace(Fs.id,"([^".concat(qd(l||""),"]+?)")))},Kr=function(n){return u.Children.toArray(n).map(function(s){var i=s.props,l=i.markup,o=i.regex,d=i.displayTransform;return{markup:l,regex:o?m3(o,l):f3(l),displayTransform:d||function(f,p){return p||f}}})},m3=function(n,s){var i=new RegExp(n.toString()+"|").exec("").length-1,l=O1(s);return Yl(i===l,"Number of capturing groups in RegExp ".concat(n.toString()," (").concat(i,") does not match the number of placeholders in the markup '").concat(s,"' (").concat(l,")")),n},h3=function(n,s,i){return n.replace(Fs.id,s).replace(Fs.display,i)},p3=[{base:"A",letters:/(&#65;|&#9398;|&#65313;|&#192;|&#193;|&#194;|&#7846;|&#7844;|&#7850;|&#7848;|&#195;|&#256;|&#258;|&#7856;|&#7854;|&#7860;|&#7858;|&#550;|&#480;|&#196;|&#478;|&#7842;|&#197;|&#506;|&#461;|&#512;|&#514;|&#7840;|&#7852;|&#7862;|&#7680;|&#260;|&#570;|&#11375;|[\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F])/g},{base:"AA",letters:/(&#42802;|[\uA732])/g},{base:"AE",letters:/(&#198;|&#508;|&#482;|[\u00C6\u01FC\u01E2])/g},{base:"AO",letters:/(&#42804;|[\uA734])/g},{base:"AU",letters:/(&#42806;|[\uA736])/g},{base:"AV",letters:/(&#42808;|&#42810;|[\uA738\uA73A])/g},{base:"AY",letters:/(&#42812;|[\uA73C])/g},{base:"B",letters:/(&#66;|&#9399;|&#65314;|&#7682;|&#7684;|&#7686;|&#579;|&#386;|&#385;|[\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181])/g},{base:"C",letters:/(&#67;|&#9400;|&#65315;|&#262;|&#264;|&#266;|&#268;|&#199;|&#7688;|&#391;|&#571;|&#42814;|[\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E])/g},{base:"D",letters:/(&#68;|&#9401;|&#65316;|&#7690;|&#270;|&#7692;|&#7696;|&#7698;|&#7694;|&#272;|&#395;|&#394;|&#393;|&#42873;|&#208;|[\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779\u00D0])/g},{base:"DZ",letters:/(&#497;|&#452;|[\u01F1\u01C4])/g},{base:"Dz",letters:/(&#498;|&#453;|[\u01F2\u01C5])/g},{base:"E",letters:/(&#69;|&#9402;|&#65317;|&#200;|&#201;|&#202;|&#7872;|&#7870;|&#7876;|&#7874;|&#7868;|&#274;|&#7700;|&#7702;|&#276;|&#278;|&#203;|&#7866;|&#282;|&#516;|&#518;|&#7864;|&#7878;|&#552;|&#7708;|&#280;|&#7704;|&#7706;|&#400;|&#398;|[\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E])/g},{base:"F",letters:/(&#70;|&#9403;|&#65318;|&#7710;|&#401;|&#42875;|[\u0046\u24BB\uFF26\u1E1E\u0191\uA77B])/g},{base:"G",letters:/(&#71;|&#9404;|&#65319;|&#500;|&#284;|&#7712;|&#286;|&#288;|&#486;|&#290;|&#484;|&#403;|&#42912;|&#42877;|&#42878;|[\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E])/g},{base:"H",letters:/(&#72;|&#9405;|&#65320;|&#292;|&#7714;|&#7718;|&#542;|&#7716;|&#7720;|&#7722;|&#294;|&#11367;|&#11381;|&#42893;|[\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D])/g},{base:"I",letters:/(&#73;|&#9406;|&#65321;|&#204;|&#205;|&#206;|&#296;|&#298;|&#300;|&#304;|&#207;|&#7726;|&#7880;|&#463;|&#520;|&#522;|&#7882;|&#302;|&#7724;|&#407;|[\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197])/g},{base:"J",letters:/(&#74;|&#9407;|&#65322;|&#308;|&#584;|[\u004A\u24BF\uFF2A\u0134\u0248])/g},{base:"K",letters:/(&#75;|&#9408;|&#65323;|&#7728;|&#488;|&#7730;|&#310;|&#7732;|&#408;|&#11369;|&#42816;|&#42818;|&#42820;|&#42914;|[\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2])/g},{base:"L",letters:/(&#76;|&#9409;|&#65324;|&#319;|&#313;|&#317;|&#7734;|&#7736;|&#315;|&#7740;|&#7738;|&#321;|&#573;|&#11362;|&#11360;|&#42824;|&#42822;|&#42880;|[\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780])/g},{base:"LJ",letters:/(&#455;|[\u01C7])/g},{base:"Lj",letters:/(&#456;|[\u01C8])/g},{base:"M",letters:/(&#77;|&#9410;|&#65325;|&#7742;|&#7744;|&#7746;|&#11374;|&#412;|[\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C])/g},{base:"N",letters:/(&#78;|&#9411;|&#65326;|&#504;|&#323;|&#209;|&#7748;|&#327;|&#7750;|&#325;|&#7754;|&#7752;|&#544;|&#413;|&#42896;|&#42916;|&#330;|[\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4\u014A])/g},{base:"NJ",letters:/(&#458;|[\u01CA])/g},{base:"Nj",letters:/(&#459;|[\u01CB])/g},{base:"O",letters:/(&#79;|&#9412;|&#65327;|&#210;|&#211;|&#212;|&#7890;|&#7888;|&#7894;|&#7892;|&#213;|&#7756;|&#556;|&#7758;|&#332;|&#7760;|&#7762;|&#334;|&#558;|&#560;|&#214;|&#554;|&#7886;|&#336;|&#465;|&#524;|&#526;|&#416;|&#7900;|&#7898;|&#7904;|&#7902;|&#7906;|&#7884;|&#7896;|&#490;|&#492;|&#216;|&#510;|&#390;|&#415;|&#42826;|&#42828;|[\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C])/g},{base:"OE",letters:/(&#338;|[\u0152])/g},{base:"OI",letters:/(&#418;|[\u01A2])/g},{base:"OO",letters:/(&#42830;|[\uA74E])/g},{base:"OU",letters:/(&#546;|[\u0222])/g},{base:"P",letters:/(&#80;|&#9413;|&#65328;|&#7764;|&#7766;|&#420;|&#11363;|&#42832;|&#42834;|&#42836;|[\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754])/g},{base:"Q",letters:/(&#81;|&#9414;|&#65329;|&#42838;|&#42840;|&#586;|[\u0051\u24C6\uFF31\uA756\uA758\u024A])/g},{base:"R",letters:/(&#82;|&#9415;|&#65330;|&#340;|&#7768;|&#344;|&#528;|&#530;|&#7770;|&#7772;|&#342;|&#7774;|&#588;|&#11364;|&#42842;|&#42918;|&#42882;|[\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782])/g},{base:"S",letters:/(&#83;|&#9416;|&#65331;|&#7838;|&#346;|&#7780;|&#348;|&#7776;|&#352;|&#7782;|&#7778;|&#7784;|&#536;|&#350;|&#11390;|&#42920;|&#42884;|[\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784])/g},{base:"T",letters:/(&#84;|&#9417;|&#65332;|&#7786;|&#356;|&#7788;|&#538;|&#354;|&#7792;|&#7790;|&#358;|&#428;|&#430;|&#574;|&#42886;|[\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786])/g},{base:"TH",letters:/(&#222;|[\u00DE])/g},{base:"TZ",letters:/(&#42792;|[\uA728])/g},{base:"U",letters:/(&#85;|&#9418;|&#65333;|&#217;|&#218;|&#219;|&#360;|&#7800;|&#362;|&#7802;|&#364;|&#220;|&#475;|&#471;|&#469;|&#473;|&#7910;|&#366;|&#368;|&#467;|&#532;|&#534;|&#431;|&#7914;|&#7912;|&#7918;|&#7916;|&#7920;|&#7908;|&#7794;|&#370;|&#7798;|&#7796;|&#580;|[\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244])/g},{base:"V",letters:/(&#86;|&#9419;|&#65334;|&#7804;|&#7806;|&#434;|&#42846;|&#581;|[\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245])/g},{base:"VY",letters:/(&#42848;|[\uA760])/g},{base:"W",letters:/(&#87;|&#9420;|&#65335;|&#7808;|&#7810;|&#372;|&#7814;|&#7812;|&#7816;|&#11378;|[\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72])/g},{base:"X",letters:/(&#88;|&#9421;|&#65336;|&#7818;|&#7820;|[\u0058\u24CD\uFF38\u1E8A\u1E8C])/g},{base:"Y",letters:/(&#89;|&#9422;|&#65337;|&#7922;|&#221;|&#374;|&#7928;|&#562;|&#7822;|&#376;|&#7926;|&#7924;|&#435;|&#590;|&#7934;|[\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE])/g},{base:"Z",letters:/(&#90;|&#9423;|&#65338;|&#377;|&#7824;|&#379;|&#381;|&#7826;|&#7828;|&#437;|&#548;|&#11391;|&#11371;|&#42850;|[\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762])/g},{base:"a",letters:/(&#97;|&#9424;|&#65345;|&#7834;|&#224;|&#225;|&#226;|&#7847;|&#7845;|&#7851;|&#7849;|&#227;|&#257;|&#259;|&#7857;|&#7855;|&#7861;|&#7859;|&#551;|&#481;|&#228;|&#479;|&#7843;|&#229;|&#507;|&#462;|&#513;|&#515;|&#7841;|&#7853;|&#7863;|&#7681;|&#261;|&#11365;|&#592;|[\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250])/g},{base:"aa",letters:/(&#42803;|[\uA733])/g},{base:"ae",letters:/(&#230;|&#509;|&#483;|[\u00E6\u01FD\u01E3])/g},{base:"ao",letters:/(&#42805;|[\uA735])/g},{base:"au",letters:/(&#42807;|[\uA737])/g},{base:"av",letters:/(&#42809;|&#42811;|[\uA739\uA73B])/g},{base:"ay",letters:/(&#42813;|[\uA73D])/g},{base:"b",letters:/(&#98;|&#9425;|&#65346;|&#7683;|&#7685;|&#7687;|&#384;|&#387;|&#595;|[\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253])/g},{base:"c",letters:/(&#99;|&#9426;|&#65347;|&#263;|&#265;|&#267;|&#269;|&#231;|&#7689;|&#392;|&#572;|&#42815;|&#8580;|[\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184])/g},{base:"d",letters:/(&#100;|&#9427;|&#65348;|&#7691;|&#271;|&#7693;|&#7697;|&#7699;|&#7695;|&#273;|&#396;|&#598;|&#599;|&#42874;|&#240;|[\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A\u00F0])/g},{base:"dz",letters:/(&#499;|&#454;|[\u01F3\u01C6])/g},{base:"e",letters:/(&#101;|&#9428;|&#65349;|&#232;|&#233;|&#234;|&#7873;|&#7871;|&#7877;|&#7875;|&#7869;|&#275;|&#7701;|&#7703;|&#277;|&#279;|&#235;|&#7867;|&#283;|&#517;|&#519;|&#7865;|&#7879;|&#553;|&#7709;|&#281;|&#7705;|&#7707;|&#583;|&#603;|&#477;|[\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD])/g},{base:"f",letters:/(&#102;|&#9429;|&#65350;|&#7711;|&#402;|&#42876;|[\u0066\u24D5\uFF46\u1E1F\u0192\uA77C])/g},{base:"g",letters:/(&#103;|&#9430;|&#65351;|&#501;|&#285;|&#7713;|&#287;|&#289;|&#487;|&#291;|&#485;|&#608;|&#42913;|&#7545;|&#42879;|[\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F])/g},{base:"h",letters:/(&#104;|&#9431;|&#65352;|&#293;|&#7715;|&#7719;|&#543;|&#7717;|&#7721;|&#7723;|&#7830;|&#295;|&#11368;|&#11382;|&#613;|[\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265])/g},{base:"hv",letters:/(&#405;|[\u0195])/g},{base:"i",letters:/(&#105;|&#9432;|&#65353;|&#236;|&#237;|&#238;|&#297;|&#299;|&#301;|&#239;|&#7727;|&#7881;|&#464;|&#521;|&#523;|&#7883;|&#303;|&#7725;|&#616;|&#305;|[\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131])/g},{base:"ij",letters:/(&#307;|[\u0133])/g},{base:"j",letters:/(&#106;|&#9433;|&#65354;|&#309;|&#496;|&#585;|[\u006A\u24D9\uFF4A\u0135\u01F0\u0249])/g},{base:"k",letters:/(&#107;|&#9434;|&#65355;|&#7729;|&#489;|&#7731;|&#311;|&#7733;|&#409;|&#11370;|&#42817;|&#42819;|&#42821;|&#42915;|[\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3])/g},{base:"l",letters:/(&#108;|&#9435;|&#65356;|&#320;|&#314;|&#318;|&#7735;|&#7737;|&#316;|&#7741;|&#7739;|&#322;|&#410;|&#619;|&#11361;|&#42825;|&#42881;|&#42823;|[\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u0142\u019A\u026B\u2C61\uA749\uA781\uA747])/g},{base:"lj",letters:/(&#457;|[\u01C9])/g},{base:"m",letters:/(&#109;|&#9436;|&#65357;|&#7743;|&#7745;|&#7747;|&#625;|&#623;|[\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F])/g},{base:"n",letters:/(&#110;|&#9437;|&#65358;|&#505;|&#324;|&#241;|&#7749;|&#328;|&#7751;|&#326;|&#7755;|&#7753;|&#414;|&#626;|&#329;|&#42897;|&#42917;|&#331;|[\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5\u014B])/g},{base:"nj",letters:/(&#460;|[\u01CC])/g},{base:"o",letters:/(&#111;|&#9438;|&#65359;|&#242;|&#243;|&#244;|&#7891;|&#7889;|&#7895;|&#7893;|&#245;|&#7757;|&#557;|&#7759;|&#333;|&#7761;|&#7763;|&#335;|&#559;|&#561;|&#246;|&#555;|&#7887;|&#337;|&#466;|&#525;|&#527;|&#417;|&#7901;|&#7899;|&#7905;|&#7903;|&#7907;|&#7885;|&#7897;|&#491;|&#493;|&#248;|&#511;|&#596;|&#42827;|&#42829;|&#629;|[\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275])/g},{base:"oe",letters:/(&#339;|[\u0153])/g},{base:"oi",letters:/(&#419;|[\u01A3])/g},{base:"ou",letters:/(&#547;|[\u0223])/g},{base:"oo",letters:/(&#42831;|[\uA74F])/g},{base:"p",letters:/(&#112;|&#9439;|&#65360;|&#7765;|&#7767;|&#421;|&#7549;|&#42833;|&#42835;|&#42837;|[\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755])/g},{base:"q",letters:/(&#113;|&#9440;|&#65361;|&#587;|&#42839;|&#42841;|[\u0071\u24E0\uFF51\u024B\uA757\uA759])/g},{base:"r",letters:/(&#114;|&#9441;|&#65362;|&#341;|&#7769;|&#345;|&#529;|&#531;|&#7771;|&#7773;|&#343;|&#7775;|&#589;|&#637;|&#42843;|&#42919;|&#42883;|[\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783])/g},{base:"s",letters:/(&#115;|&#9442;|&#65363;|&#347;|&#7781;|&#349;|&#7777;|&#353;|&#7783;|&#7779;|&#7785;|&#537;|&#351;|&#575;|&#42921;|&#42885;|&#7835;|&#383;|[\u0073\u24E2\uFF53\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B\u017F])/g},{base:"ss",letters:/(&#223;|[\u00DF])/g},{base:"t",letters:/(&#116;|&#9443;|&#65364;|&#7787;|&#7831;|&#357;|&#7789;|&#539;|&#355;|&#7793;|&#7791;|&#359;|&#429;|&#648;|&#11366;|&#42887;|[\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787])/g},{base:"th",letters:/(&#254;|[\u00FE])/g},{base:"tz",letters:/(&#42793;|[\uA729])/g},{base:"u",letters:/(&#117;|&#9444;|&#65365;|&#249;|&#250;|&#251;|&#361;|&#7801;|&#363;|&#7803;|&#365;|&#252;|&#476;|&#472;|&#470;|&#474;|&#7911;|&#367;|&#369;|&#468;|&#533;|&#535;|&#432;|&#7915;|&#7913;|&#7919;|&#7917;|&#7921;|&#7909;|&#7795;|&#371;|&#7799;|&#7797;|&#649;|[\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289])/g},{base:"v",letters:/(&#118;|&#9445;|&#65366;|&#7805;|&#7807;|&#651;|&#42847;|&#652;|[\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C])/g},{base:"vy",letters:/(&#42849;|[\uA761])/g},{base:"w",letters:/(&#119;|&#9446;|&#65367;|&#7809;|&#7811;|&#373;|&#7815;|&#7813;|&#7832;|&#7817;|&#11379;|[\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73])/g},{base:"x",letters:/(&#120;|&#9447;|&#65368;|&#7819;|&#7821;|[\u0078\u24E7\uFF58\u1E8B\u1E8D])/g},{base:"y",letters:/(&#121;|&#9448;|&#65369;|&#7923;|&#253;|&#375;|&#7929;|&#563;|&#7823;|&#255;|&#7927;|&#7833;|&#7925;|&#436;|&#591;|&#7935;|[\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF])/g},{base:"z",letters:/(&#122;|&#9449;|&#65370;|&#378;|&#7825;|&#380;|&#382;|&#7827;|&#7829;|&#438;|&#549;|&#576;|&#11372;|&#42851;|[\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763])/g}],y3=function(n){var s=n;return p3.forEach(function(i){s=s.replace(i.letters,i.base)}),s},cw=function(n){return y3(n).toLowerCase()},F1=function(n,s,i){return i?cw(n).indexOf(cw(s)):n.toLowerCase().indexOf(s.toLowerCase())},g3=function(){return!!document.documentMode},My=function(n){return typeof n=="number"},b3=function(n){return n===Object(n)?Object.keys(n):[]},x3=function(n){for(var s,i=arguments.length,l=new Array(i>1?i-1:0),o=1;o<i;o++)l[o-1]=arguments[o];var d=(s=[]).concat.apply(s,l);return Object.keys(n).reduce(function(f,p){return n.hasOwnProperty(p)&&!d.includes(p)&&n[p]!==void 0&&(f[p]=n[p]),f},{})},v3=["style","className","classNames"];function uw(e,n){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter(function(l){return Object.getOwnPropertyDescriptor(e,l).enumerable})),s.push.apply(s,i)}return s}function dw(e){for(var n=1;n<arguments.length;n++){var s=arguments[n]!=null?arguments[n]:{};n%2?uw(Object(s),!0).forEach(function(i){fn(e,i,s[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):uw(Object(s)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(s,i))})}return e}function Uf(e,n){var s=function(l){var o=function(p){var h=p.style,y=p.className,g=p.classNames,b=P4(p,v3),v=n?n(b):void 0,S=Hg(e,{style:h,className:y,classNames:g},v);return Ze.createElement(l,ds({},b,{style:S}))},d=l.displayName||l.name||"Component";return o.displayName="defaultStyle(".concat(d,")"),Ze.forwardRef(function(f,p){return o(dw(dw({},f),{},{ref:p}))})};return s}var S3=function(n,s){return n.hasOwnProperty(s)?n[s]++:n[s]=0,s+"_"+n[s]};function z1(e){var n=e.selectionStart,s=e.selectionEnd,i=e.value,l=i===void 0?"":i,o=e.onCaretPositionChange,d=e.containerRef,f=e.children;e.singleLine;var p=e.style,h=u.useState({left:void 0,top:void 0}),y=sf(h,2),g=y[0],b=y[1],v=u.useState(),S=sf(v,2),N=S[0],j=S[1];u.useEffect(function(){E()});var E=function(){if(N){var R=N.offsetLeft,B=N.offsetTop;if(!(g.left===R&&g.top===B)){var D={left:R,top:B};b(D),o(D)}}},A=Kr(f),M;s===n&&(M=wa(l,A,n,"START"));var _=[],T={},k=_,C=0,L=function(R,B,D){if(My(M)&&M>=B&&M<=B+R.length){var O=M-B;k.push(G(R.substring(0,O),C)),k=[G(R.substring(O),C)]}else k.push(G(R,C));C++},z=function(R,B,D,O,$,F,H){var I=S3(T,O);k.push(U(O,$,F,I))},G=function(R,B){return Ze.createElement("span",ds({},p("substring"),{key:B}),R)},U=function(R,B,D,O){var $={id:R,display:B,key:O},F=u.Children.toArray(f)[D];return Ze.cloneElement(F,$)},X=function(R){return Ze.createElement("span",ds({},p("caret"),{ref:j,key:"caret"}),R)};return Xc(l,A,z,L),k.push(" "),k!==_&&_.push(X(k)),Ze.createElement("div",ds({},p,{ref:d}),_)}z1.propTypes={selectionStart:Ot.number,selectionEnd:Ot.number,value:Ot.string.isRequired,onCaretPositionChange:Ot.func.isRequired,containerRef:Ot.oneOfType([Ot.func,Ot.shape({current:typeof Element>"u"?Ot.any:Ot.instanceOf(Element)})]),children:Ot.oneOfType([Ot.element,Ot.arrayOf(Ot.element)]).isRequired};var w3=Uf({position:"relative",boxSizing:"border-box",width:"100%",color:"transparent",overflow:"hidden",whiteSpace:"pre-wrap",wordWrap:"break-word",border:"1px solid transparent",textAlign:"start","&singleLine":{whiteSpace:"pre",wordWrap:null},substring:{visibility:"hidden"}},function(e){return{"&singleLine":e.singleLine}}),N3=w3(z1);function B1(e){var n=e.id,s=e.focused,i=e.ignoreAccents,l=e.index,o=e.onClick,d=e.onMouseEnter,f=e.query,p=e.renderSuggestion,h=e.suggestion,y=e.style;e.className,e.classNames;var g={onClick:o,onMouseEnter:d},b=function(){var j=v(),E=S(j);return p?p(h,f,E,l,s):E},v=function(){if(typeof h=="string")return h;var j=h.id,E=h.display;return j===void 0||!E?j:E},S=function(j){var E=F1(j,f,i);return E===-1?Ze.createElement("span",y("display"),j):Ze.createElement("span",y("display"),j.substring(0,E),Ze.createElement("b",y("highlight"),j.substring(E,E+f.length)),j.substring(E+f.length))};return Ze.createElement("li",ds({id:n,role:"option","aria-selected":s},g,y),b())}B1.propTypes={id:Ot.string.isRequired,query:Ot.string.isRequired,index:Ot.number.isRequired,ignoreAccents:Ot.bool,suggestion:Ot.oneOfType([Ot.string,Ot.shape({id:Ot.oneOfType([Ot.string,Ot.number]).isRequired,display:Ot.string})]).isRequired,renderSuggestion:Ot.func,focused:Ot.bool};var j3=Uf({cursor:"pointer"},function(e){return{"&focused":e.focused}}),E3=j3(B1);function _3(e){var n=e.style,s=e.className,i=e.classNames,l=Hg(C3,{style:n,className:s,classNames:i}),o=l("spinner");return Ze.createElement("div",l,Ze.createElement("div",o,Ze.createElement("div",o(["element","element1"])),Ze.createElement("div",o(["element","element2"])),Ze.createElement("div",o(["element","element3"])),Ze.createElement("div",o(["element","element4"])),Ze.createElement("div",o(["element","element5"]))))}var C3={};function U1(e){var n=e.id,s=e.suggestions,i=s===void 0?{}:s,l=e.a11ySuggestionsListLabel,o=e.focusIndex,d=e.position,f=e.left,p=e.right,h=e.top,y=e.scrollFocusedIntoView,g=e.isLoading,b=e.isOpened,v=e.onSelect,S=v===void 0?function(){return null}:v,N=e.ignoreAccents,j=e.containerRef,E=e.children,A=e.style,M=e.customSuggestionsContainer,_=e.onMouseDown,T=e.onMouseEnter,k=u.useState(void 0),C=sf(k,2),L=C[0],z=C[1];u.useEffect(function(){if(!(!L||L.offsetHeight>=L.scrollHeight||!y)){var D=L.scrollTop,O=L.children[o].getBoundingClientRect(),$=O.top,F=O.bottom,H=L.getBoundingClientRect(),I=H.top;$=$-I+D,F=F-I+D,$<D?L.scrollTop=$:F>L.offsetHeight&&(L.scrollTop=F-L.offsetHeight)}},[o,y,L]);var G=function(){var O=Ze.createElement("ul",ds({ref:z,id:n,role:"listbox","aria-label":l},A("list")),Object.values(i).reduce(function($,F){var H=F.results,I=F.queryInfo;return[].concat(nf($),nf(H.map(function(Y,P){return U(Y,I,$.length+P)})))},[]));return M?M(O):O},U=function(O,$,F){var H=F===o,I=$.childIndex,Y=$.query,P=u.Children.toArray(E)[I].props.renderSuggestion;return Ze.createElement(E3,{style:A("item"),key:"".concat(I,"-").concat(B(O)),id:$1(n,F),query:Y,index:F,ignoreAccents:N,renderSuggestion:P,suggestion:O,focused:H,onClick:function(){return R(O,$)},onMouseEnter:function(){return V(F)}})},X=function(){if(g)return Ze.createElement(_3,{style:A("loadingIndicator")})},V=function(O,$){T&&T(O)},R=function(O,$){S(O,$)},B=function(O){return typeof O=="string"?O:O.id};return b?Ze.createElement("div",ds({},l3({position:d||"absolute",left:f,right:p,top:h},A),{onMouseDown:_,ref:j}),G(),X()):null}U1.propTypes={id:Ot.string.isRequired,suggestions:Ot.object.isRequired,a11ySuggestionsListLabel:Ot.string,focusIndex:Ot.number,position:Ot.string,left:Ot.number,right:Ot.number,top:Ot.number,scrollFocusedIntoView:Ot.bool,isLoading:Ot.bool,isOpened:Ot.bool.isRequired,onSelect:Ot.func,ignoreAccents:Ot.bool,customSuggestionsContainer:Ot.func,containerRef:Ot.oneOfType([Ot.func,Ot.shape({current:typeof Element>"u"?Ot.any:Ot.instanceOf(Element)})])};var A3=Uf({zIndex:1,backgroundColor:"white",marginTop:14,minWidth:100,list:{margin:0,padding:0,listStyleType:"none"}}),T3=A3(U1);function fw(e,n){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter(function(l){return Object.getOwnPropertyDescriptor(e,l).enumerable})),s.push.apply(s,i)}return s}function xs(e){for(var n=1;n<arguments.length;n++){var s=arguments[n]!=null?arguments[n]:{};n%2?fw(Object(s),!0).forEach(function(i){fn(e,i,s[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):fw(Object(s)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(s,i))})}return e}function M3(e){var n=k3();return function(){var i=af(e),l;if(n){var o=af(this).constructor;l=Reflect.construct(i,arguments,o)}else l=i.apply(this,arguments);return O4(this,l)}}function k3(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}var R3=function(n){var s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(n instanceof RegExp)return n;var i=s.allowSpaceInQuery,l=qd(n);return new RegExp("(?:^|\\s)(".concat(l,"([^").concat(i?"":"\\s").concat(l,"]*))$"))},I3=function(n,s){return n instanceof Array?function(i,l){for(var o=[],d=0,f=n.length;d<f;++d){var p=n[d].display||n[d].id;F1(p,i,s)>=0&&o.push(n[d])}return o}:n},Ml={TAB:9,RETURN:13,ESC:27,UP:38,DOWN:40},yd=!1,q1={singleLine:Ot.bool,allowSpaceInQuery:Ot.bool,allowSuggestionsAboveCursor:Ot.bool,forceSuggestionsAboveCursor:Ot.bool,ignoreAccents:Ot.bool,a11ySuggestionsListLabel:Ot.string,value:Ot.string,onKeyDown:Ot.func,customSuggestionsContainer:Ot.func,onSelect:Ot.func,onBlur:Ot.func,onChange:Ot.func,suggestionsPortalHost:typeof Element>"u"?Ot.any:Ot.PropTypes.instanceOf(Element),inputRef:Ot.oneOfType([Ot.func,Ot.shape({current:typeof Element>"u"?Ot.any:Ot.instanceOf(Element)})]),children:Ot.oneOfType([Ot.element,Ot.arrayOf(Ot.element)]).isRequired},Vg=(function(e){D4(s,e);var n=M3(s);function s(i){var l;return R4(this,s),l=n.call(this,i),fn(pn(l),"setContainerElement",function(o){l.containerElement=o}),fn(pn(l),"getInputProps",function(){var o=l.props,d=o.readOnly,f=o.disabled,p=o.style,h=x3(l.props,["style","classNames","className"],b3(q1));return xs(xs(xs(xs({},h),p("input")),{},{value:l.getPlainText(),onScroll:l.updateHighlighterScroll},!d&&!f&&{onChange:l.handleChange,onSelect:l.handleSelect,onKeyDown:l.handleKeyDown,onBlur:l.handleBlur,onCompositionStart:l.handleCompositionStart,onCompositionEnd:l.handleCompositionEnd}),l.isOpened()&&{role:"combobox","aria-controls":l.uuidSuggestionsOverlay,"aria-expanded":!0,"aria-autocomplete":"list","aria-haspopup":"listbox","aria-activedescendant":$1(l.uuidSuggestionsOverlay,l.state.focusIndex)})}),fn(pn(l),"renderControl",function(){var o=l.props,d=o.singleLine,f=o.style,p=l.getInputProps();return Ze.createElement("div",f("control"),l.renderHighlighter(),d?l.renderInput(p):l.renderTextarea(p))}),fn(pn(l),"renderInput",function(o){return Ze.createElement("input",ds({type:"text",ref:l.setInputRef},o))}),fn(pn(l),"renderTextarea",function(o){return Ze.createElement("textarea",ds({ref:l.setInputRef},o))}),fn(pn(l),"setInputRef",function(o){l.inputElement=o;var d=l.props.inputRef;typeof d=="function"?d(o):d&&(d.current=o)}),fn(pn(l),"setSuggestionsElement",function(o){l.suggestionsElement=o}),fn(pn(l),"renderSuggestionsOverlay",function(){if(!My(l.state.selectionStart))return null;var o=l.state.suggestionsPosition,d=o.position,f=o.left,p=o.top,h=o.right,y=Ze.createElement(T3,{id:l.uuidSuggestionsOverlay,style:l.props.style("suggestions"),position:d,left:f,top:p,right:h,focusIndex:l.state.focusIndex,scrollFocusedIntoView:l.state.scrollFocusedIntoView,containerRef:l.setSuggestionsElement,suggestions:l.state.suggestions,customSuggestionsContainer:l.props.customSuggestionsContainer,onSelect:l.addMention,onMouseDown:l.handleSuggestionsMouseDown,onMouseEnter:l.handleSuggestionsMouseEnter,isLoading:l.isLoading(),isOpened:l.isOpened(),ignoreAccents:l.props.ignoreAccents,a11ySuggestionsListLabel:l.props.a11ySuggestionsListLabel},l.props.children);return l.props.suggestionsPortalHost?pj.createPortal(y,l.props.suggestionsPortalHost):y}),fn(pn(l),"renderHighlighter",function(){var o=l.state,d=o.selectionStart,f=o.selectionEnd,p=l.props,h=p.singleLine,y=p.children,g=p.value,b=p.style;return Ze.createElement(N3,{containerRef:l.setHighlighterElement,style:b("highlighter"),value:g,singleLine:h,selectionStart:d,selectionEnd:f,onCaretPositionChange:l.handleCaretPositionChange},y)}),fn(pn(l),"setHighlighterElement",function(o){l.highlighterElement=o}),fn(pn(l),"handleCaretPositionChange",function(o){l.setState({caretPosition:o})}),fn(pn(l),"getPlainText",function(){return Ri(l.props.value||"",Kr(l.props.children))}),fn(pn(l),"executeOnChange",function(o){for(var d=arguments.length,f=new Array(d>1?d-1:0),p=1;p<d;p++)f[p-1]=arguments[p];if(l.props.onChange){var h;return(h=l.props).onChange.apply(h,[o].concat(f))}if(l.props.valueLink){var y;return(y=l.props.valueLink).requestChange.apply(y,[o.target.value].concat(f))}}),fn(pn(l),"handleChange",function(o){if(yd=!1,g3()){var d=document.activeElement&&document.activeElement.contentDocument||document;if(d.activeElement!==o.target)return}var f=l.props.value||"",p=Kr(l.props.children),h=o.target.value,y=l.state.selectionStart;y==null&&(y=o.target.selectionStart);var g=l.state.selectionEnd;g==null&&(g=o.target.selectionEnd);var b=u3(f,h,{selectionStartBefore:y,selectionEndBefore:g,selectionEndAfter:o.target.selectionEnd},p);h=Ri(b,p);var v=o.target.selectionStart,S=o.target.selectionEnd,N=!1,j=ow(f,p,v);j!==void 0&&l.state.selectionEnd>j&&(v=j+(o.nativeEvent.data?o.nativeEvent.data.length:0),S=v,N=!0),l.setState({selectionStart:v,selectionEnd:S,setSelectionAfterMentionChange:N});var E=bc(b,p);o.nativeEvent.isComposing&&v===S&&l.updateMentionsQueries(l.inputElement.value,v);var A={target:{value:b}};l.executeOnChange(A,b,h,E)}),fn(pn(l),"handleSelect",function(o){if(l.setState({selectionStart:o.target.selectionStart,selectionEnd:o.target.selectionEnd}),!yd){var d=l.inputElement;o.target.selectionStart===o.target.selectionEnd?l.updateMentionsQueries(d.value,o.target.selectionStart):l.clearSuggestions(),l.updateHighlighterScroll(),l.props.onSelect(o)}}),fn(pn(l),"handleKeyDown",function(o){var d=pd(l.state.suggestions);if(d===0||!l.suggestionsElement){l.props.onKeyDown(o);return}switch(Object.values(Ml).indexOf(o.keyCode)>=0&&(o.preventDefault(),o.stopPropagation()),o.keyCode){case Ml.ESC:{l.clearSuggestions();return}case Ml.DOWN:{l.shiftFocus(1);return}case Ml.UP:{l.shiftFocus(-1);return}case Ml.RETURN:{l.selectFocused();return}case Ml.TAB:{l.selectFocused();return}default:return}}),fn(pn(l),"shiftFocus",function(o){var d=pd(l.state.suggestions);l.setState({focusIndex:(d+l.state.focusIndex+o)%d,scrollFocusedIntoView:!0})}),fn(pn(l),"selectFocused",function(){var o=l.state,d=o.suggestions,f=o.focusIndex,p=Object.values(d).reduce(function(g,b){var v=b.results,S=b.queryInfo;return[].concat(nf(g),nf(v.map(function(N){return{result:N,queryInfo:S}})))},[])[f],h=p.result,y=p.queryInfo;l.addMention(h,y),l.setState({focusIndex:0})}),fn(pn(l),"handleBlur",function(o){var d=l._suggestionsMouseDown;l._suggestionsMouseDown=!1,d||l.setState({selectionStart:null,selectionEnd:null}),window.setTimeout(function(){l.updateHighlighterScroll()},1),l.props.onBlur(o,d)}),fn(pn(l),"handleSuggestionsMouseDown",function(o){l._suggestionsMouseDown=!0}),fn(pn(l),"handleSuggestionsMouseEnter",function(o){l.setState({focusIndex:o,scrollFocusedIntoView:!1})}),fn(pn(l),"updateSuggestionsPosition",function(){var o=l.state.caretPosition,d=l.props,f=d.suggestionsPortalHost,p=d.allowSuggestionsAboveCursor,h=d.forceSuggestionsAboveCursor;if(!(!o||!l.suggestionsElement)){var y=l.suggestionsElement,g=l.highlighterElement,b=g.getBoundingClientRect(),v=Lp(g,"font-size"),S={left:b.left+o.left,top:b.top+o.top+v},N=Math.max(document.documentElement.clientHeight,window.innerHeight||0);if(y){var j={};if(f){j.position="fixed";var E=S.left,A=S.top;E-=Lp(y,"margin-left"),A-=Lp(y,"margin-top"),E-=g.scrollLeft,A-=g.scrollTop;var M=Math.max(document.documentElement.clientWidth,window.innerWidth||0);E+y.offsetWidth>M?j.left=Math.max(0,M-y.offsetWidth):j.left=E,p&&A+y.offsetHeight>N&&y.offsetHeight<A-v||h?j.top=Math.max(0,A-y.offsetHeight-v):j.top=A}else{var _=o.left-g.scrollLeft,T=o.top-g.scrollTop;_+y.offsetWidth>l.containerElement.offsetWidth?j.right=0:j.left=_,p&&S.top-g.scrollTop+y.offsetHeight>N&&y.offsetHeight<b.top-v-g.scrollTop||h?j.top=T-y.offsetHeight-v:j.top=T}j.left===l.state.suggestionsPosition.left&&j.top===l.state.suggestionsPosition.top&&j.position===l.state.suggestionsPosition.position||l.setState({suggestionsPosition:j})}}}),fn(pn(l),"updateHighlighterScroll",function(){var o=l.inputElement,d=l.highlighterElement;!o||!d||(d.scrollLeft=o.scrollLeft,d.scrollTop=o.scrollTop,d.height=o.height)}),fn(pn(l),"handleCompositionStart",function(){yd=!0}),fn(pn(l),"handleCompositionEnd",function(){yd=!1}),fn(pn(l),"setSelection",function(o,d){if(!(o===null||d===null)){var f=l.inputElement;if(f.setSelectionRange)f.setSelectionRange(o,d);else if(f.createTextRange){var p=f.createTextRange();p.collapse(!0),p.moveEnd("character",d),p.moveStart("character",o),p.select()}}}),fn(pn(l),"updateMentionsQueries",function(o,d){l._queryId++,l.suggestions={},l.setState({suggestions:{}});var f=l.props.value||"",p=l.props.children,h=Kr(p),y=wa(f,h,d,"NULL");if(y!==null){var g=d3(f.substring(0,y),h),b=o.substring(g,d);Ze.Children.forEach(p,function(v,S){if(v){var N=R3(v.props.trigger,l.props),j=b.match(N);if(j){var E=g+b.indexOf(j[1],j.index);l.queryData(j[2],S,E,E+j[1].length,o)}}})}}),fn(pn(l),"clearSuggestions",function(){l._queryId++,l.suggestions={},l.setState({suggestions:{},focusIndex:0})}),fn(pn(l),"queryData",function(o,d,f,p,h){var y=l.props,g=y.children,b=y.ignoreAccents,v=u.Children.toArray(g)[d],S=I3(v.props.data,b),N=S(o,l.updateSuggestions.bind(null,l._queryId,d,o,f,p,h));N instanceof Array&&l.updateSuggestions(l._queryId,d,o,f,p,h,N)}),fn(pn(l),"updateSuggestions",function(o,d,f,p,h,y,g){if(o===l._queryId){l.suggestions=xs(xs({},l.suggestions),{},fn({},d,{queryInfo:{childIndex:d,query:f,querySequenceStart:p,querySequenceEnd:h,plainTextValue:y},results:g}));var b=l.state.focusIndex,v=pd(l.suggestions);l.setState({suggestions:l.suggestions,focusIndex:b>=v?Math.max(v-1,0):b})}}),fn(pn(l),"addMention",function(o,d){var f=o.id,p=o.display,h=d.childIndex,y=d.querySequenceStart,g=d.querySequenceEnd,b=d.plainTextValue,v=l.props.value||"",S=Kr(l.props.children),N=u.Children.toArray(l.props.children)[h],j=N.props,E=j.markup,A=j.displayTransform,M=j.appendSpaceOnAdd,_=j.onAdd,T=wa(v,S,y,"START"),k=T+g-y,C=h3(E,f,p);M&&(C+=" ");var L=jc(v,T,k,C);l.inputElement.focus();var z=A(f,p);M&&(z+=" ");var G=y+z.length;l.setState({selectionStart:G,selectionEnd:G,setSelectionAfterMentionChange:!0});var U={target:{value:L}},X=bc(L,S),V=jc(b,y,g,z);l.executeOnChange(U,L,V,X),_&&_(f,p,T,k),l.clearSuggestions()}),fn(pn(l),"isLoading",function(){var o=!1;return Ze.Children.forEach(l.props.children,function(d){o=o||d&&d.props.isLoading}),o}),fn(pn(l),"isOpened",function(){return My(l.state.selectionStart)&&(pd(l.state.suggestions)!==0||l.isLoading())}),fn(pn(l),"_queryId",0),l.suggestions={},l.uuidSuggestionsOverlay=Math.random().toString(16).substring(2),l.handleCopy=l.handleCopy.bind(pn(l)),l.handleCut=l.handleCut.bind(pn(l)),l.handlePaste=l.handlePaste.bind(pn(l)),l.state={focusIndex:0,selectionStart:null,selectionEnd:null,suggestions:{},caretPosition:null,suggestionsPosition:{},setSelectionAfterHandlePaste:!1},l}return L4(s,[{key:"componentDidMount",value:function(){document.addEventListener("copy",this.handleCopy),document.addEventListener("cut",this.handleCut),document.addEventListener("paste",this.handlePaste),this.updateSuggestionsPosition()}},{key:"componentDidUpdate",value:function(l,o){o.suggestionsPosition===this.state.suggestionsPosition&&this.updateSuggestionsPosition(),this.state.setSelectionAfterMentionChange&&(this.setState({setSelectionAfterMentionChange:!1}),this.setSelection(this.state.selectionStart,this.state.selectionEnd)),this.state.setSelectionAfterHandlePaste&&(this.setState({setSelectionAfterHandlePaste:!1}),this.setSelection(this.state.selectionStart,this.state.selectionEnd))}},{key:"componentWillUnmount",value:function(){document.removeEventListener("copy",this.handleCopy),document.removeEventListener("cut",this.handleCut),document.removeEventListener("paste",this.handlePaste)}},{key:"render",value:function(){return Ze.createElement("div",ds({ref:this.setContainerElement},this.props.style),this.renderControl(),this.renderSuggestionsOverlay())}},{key:"handlePaste",value:function(l){if(l.target===this.inputElement&&this.supportsClipboardActions(l)){l.preventDefault();var o=this.state,d=o.selectionStart,f=o.selectionEnd,p=this.props,h=p.value,y=p.children,g=Kr(y),b=wa(h,g,d,"START"),v=wa(h,g,f,"END"),S=l.clipboardData.getData("text/react-mentions"),N=l.clipboardData.getData("text/plain"),j=jc(h,b,v,S||N).replace(/\r/g,""),E=Ri(j,g),A={target:xs(xs({},l.target),{},{value:j})};this.executeOnChange(A,j,E,bc(j,g));var M=ow(h,g,d),_=(M||d)+Ri(S||N,g).length;this.setState({selectionStart:_,selectionEnd:_,setSelectionAfterHandlePaste:!0})}}},{key:"saveSelectionToClipboard",value:function(l){var o=this.inputElement.selectionStart,d=this.inputElement.selectionEnd,f=this.props,p=f.children,h=f.value,y=Kr(p),g=wa(h,y,o,"START"),b=wa(h,y,d,"END");l.clipboardData.setData("text/plain",l.target.value.slice(o,d)),l.clipboardData.setData("text/react-mentions",h.slice(g,b))}},{key:"supportsClipboardActions",value:function(l){return!!l.clipboardData}},{key:"handleCopy",value:function(l){l.target===this.inputElement&&this.supportsClipboardActions(l)&&(l.preventDefault(),this.saveSelectionToClipboard(l))}},{key:"handleCut",value:function(l){if(l.target===this.inputElement&&this.supportsClipboardActions(l)){l.preventDefault(),this.saveSelectionToClipboard(l);var o=this.state,d=o.selectionStart,f=o.selectionEnd,p=this.props,h=p.children,y=p.value,g=Kr(h),b=wa(y,g,d,"START"),v=wa(y,g,f,"END"),S=[y.slice(0,b),y.slice(v)].join(""),N=Ri(S,g),j={target:xs(xs({},l.target),{},{value:N})};this.executeOnChange(j,S,N,bc(y,g))}}}]),s})(Ze.Component);fn(Vg,"propTypes",q1);fn(Vg,"defaultProps",{ignoreAccents:!1,singleLine:!1,allowSuggestionsAboveCursor:!1,onKeyDown:function(){return null},onSelect:function(){return null},onBlur:function(){return null}});var Lp=function(n,s){var i=parseFloat(window.getComputedStyle(n,null).getPropertyValue(s));return isFinite(i)?i:0},L3=typeof navigator<"u"&&/iPhone|iPad|iPod/i.test(navigator.userAgent),D3=Uf({position:"relative",overflowY:"visible",input:{display:"block",width:"100%",position:"absolute",margin:0,top:0,left:0,boxSizing:"border-box",backgroundColor:"transparent",fontFamily:"inherit",fontSize:"inherit",letterSpacing:"inherit"},"&multiLine":{input:xs({height:"100%",bottom:0,overflow:"hidden",resize:"none"},L3?{marginTop:1,marginLeft:-3}:null)}},function(e){var n=e.singleLine;return{"&singleLine":n,"&multiLine":!n}}),O3=D3(Vg),$3={fontWeight:"inherit"},li=function(n){var s=n.display,i=n.style,l=n.className,o=n.classNames,d=Hg($3,{style:i,className:l,classNames:o});return Ze.createElement("strong",d,s)};li.propTypes={onAdd:Ot.func,onRemove:Ot.func,renderSuggestion:Ot.func,trigger:Ot.oneOfType([Ot.string,Ot.instanceOf(RegExp)]),markup:Ot.string,displayTransform:Ot.func,allowSpaceInQuery:Ot.bool,isLoading:Ot.bool};li.defaultProps={trigger:"@",markup:"@[__display__](__id__)",displayTransform:function(n,s){return s||n},onAdd:function(){return null},onRemove:function(){return null},renderSuggestion:null,isLoading:!1,appendSpaceOnAdd:!1};function Gl({inputProps:e,...n}){const s=u.useRef(null);return u.useEffect(()=>{if(!s.current||!e)return;const i=()=>{const l=s.current?.querySelector("textarea");return l?(Object.entries(e).forEach(([o,d])=>{if(d!=null)if(o==="className"){const f=l.className||"";l.className=f?`${f} ${d}`.trim():d}else if(o.startsWith("data-")||o.startsWith("aria-"))l.setAttribute(o,String(d));else if(o==="rows")l.setAttribute("rows",String(d));else if(o==="required")l.required=!!d;else if(o==="id")l.id=String(d);else try{typeof d=="boolean"?d?l.setAttribute(o,""):l.removeAttribute(o):l[o]=d}catch{try{l.setAttribute(o,String(d))}catch{}}}),!0):!1};if(!i()){const l=setTimeout(()=>{i()},10);return()=>clearTimeout(l)}},[e]),t.jsx("div",{ref:s,children:t.jsx(O3,{...n})})}const F3=/\s*\(([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})\)$/i,z3=/\(([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})\)/gi,ky=e=>{if(!e)return"";let n=String(e).trim();return n=n.replace(F3,"").trim(),n=n.replace(z3,"").trim(),n},Bi=(e="",n=[])=>{const s=typeof e=="string"?e:"";if(!s)return[];const i=Array.isArray(n)?n:[],l=new Map;i.forEach(h=>{if(!h)return;const y=h.entityId??h.entity_id??h.id??h.entityID??null,g=h.locationId??h.location_id??null,b=h.type??h.mentionType??(g?"location":"entity"),v=y||g;if(!v)return;const S=String(v),N=`${b}:${S}`;if(l.has(N))return;const j=h.entityName??h.entity_name??h.locationName??h.location_name??h.label??h.name,E=j?ky(j):"";b==="location"?(l.set(N,{locationId:S,locationName:E,type:"location"}),l.set(S,{locationId:S,locationName:E,type:"location"})):(l.set(N,{entityId:S,entityName:E,type:"entity"}),l.set(S,{entityId:S,entityName:E,type:"entity"}))});const o=[],d=/@\[(.+?)]\(([^)]+)\)/g;let f=0,p;for(;(p=d.exec(s))!==null;){if(p.index>f){const N=s.slice(f,p.index);N.trim().length>0&&o.push({type:"text",text:N})}const h=String(p[2]).trim(),y=p[1],g=ky(y)||String(y??"").trim();let b=h.trim(),v=null;if(h.includes(":")){const N=h.split(":");N.length===2&&(v=N[0].trim(),b=N[1].trim())}if(b=b.trim(),!b){f=d.lastIndex;continue}let S=l.get(b);if(!S&&v){const N=`${v}:${b}`;S=l.get(N)}if(!S){const N=i.find(j=>{if(!j)return!1;const E=String(j.entityId??j.entity_id??j.id??j.entityID??"").trim(),A=String(j.locationId??j.location_id??"").trim();return E&&E===b||A&&A===b});if(N){const j=N.type??N.mentionType??(N.locationId||N.location_id?"location":"entity"),E=N.locationName??N.location_name??N.entityName??N.entity_name??N.label??N.name??g;j==="location"?S={locationId:b,locationName:E,type:"location"}:S={entityId:b,entityName:E,type:"entity"}}else v==="location"?S={locationId:b,locationName:g,type:"location"}:S={entityId:b,entityName:g,type:"entity"}}if(S||(v==="location"?S={locationId:b,locationName:g||"location",type:"location"}:S={entityId:b,entityName:g||"entity",type:"entity"}),S.entityId&&!S.entityName&&(S.entityName=g||"entity"),S.locationId&&!S.locationName&&(S.locationName=g||"location"),S&&(S.entityId||S.locationId)){const{type:N,...j}=S;o.push({type:"mention",...j})}else{const N={type:"mention",entityId:b||"unknown",entityName:g||"Unresolved",isPlaceholder:!0};o.push(N)}f=d.lastIndex}if(f<s.length){const h=s.slice(f);h.trim().length>0&&o.push({type:"text",text:h})}return o},B3={private:"Private",companions:"Shared with companions",dm:"Shared with DM",party:"Share with Party"},U3=[{value:"private",label:"Private"},{value:"companions",label:"My Companions"}],q3=[{value:"private",label:"Private"},{value:"party",label:"Share with Party"}],Dp=e=>{if(!e)return"";if(e instanceof Date){if(Number.isNaN(e.getTime()))return"";try{return e.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(n){return console.warn("Unable to format Date object",n,e),""}}if(typeof e=="string"||typeof e=="number")try{const n=new Date(e);return Number.isNaN(n.getTime())?(console.warn("Invalid date value:",e),""):n.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(n){return console.warn("Unable to parse date value",n,e),""}return console.warn("Unexpected date value type:",typeof e,e),""},Op=e=>e?.author?.username||e?.author?.name||e?.author?.email||e?.author_name||e?.author_email||"Unknown adventurer",mw=e=>{const n=e?.author||{},s=n?.id??n?.authorId??e?.authorId??e?.author_id??e?.authorID;if(s!=null)return`id:${String(s)}`;const i=n?.email??e?.author_email;if(i)return`email:${String(i).toLowerCase()}`;const l=n?.username??n?.name??e?.author_username??e?.author_name;return l?`name:${String(l).toLowerCase()}`:"unknown"},xa=Object.freeze([]),hw="What do you want to remember?";function P1({entity:e,worldId:n,selectedCampaign:s,selectedCampaignId:i,isCampaignDm:l,isCampaignPlayer:o,canCreateNote:d,notes:f=xa,loading:p,error:h,onCreateNote:y,creating:g,campaignMatchesEntityWorld:b,onNoteUpdate:v,onNoteDelete:S}){const{user:N}=un(),[j,E]=u.useState(""),[A,M]=u.useState("private"),[_,T]=u.useState(""),[k,C]=u.useState(xa),[L,z]=u.useState(!1),[G,U]=u.useState(""),[X,V]=u.useState(""),[R,B]=u.useState(""),[D,O]=u.useState(!1),[$,F]=u.useState("all"),[H,I]=u.useState("notes"),[Y,P]=u.useState("entity"),[W,le]=u.useState(null),[K,de]=u.useState(""),[Q,he]=u.useState("private"),[re,Ce]=u.useState(""),[Re,ue]=u.useState(!1),[se,Le]=u.useState(null),[be,De]=u.useState({items:xa,loading:!1,error:"",loaded:!1}),[Me,mt]=u.useState({items:xa,loading:!1,error:"",loaded:!1}),[ht,Ct]=u.useState(()=>new Set),At=!!i&&!!d&&!!b,we=u.useMemo(()=>l?q3:U3,[l]),st=u.useMemo(()=>n||e&&typeof e=="object"&&((e.world||{}).id||e.world_id)||"",[e,n]),lt=u.useCallback(me=>{if(!N||!me)return!1;const nt=me?.author?.id??me?.createdBy??me?.created_by??me?.authorId??me?.author_id??null;return nt?String(nt)===String(N.id):!1},[N]),Fe=u.useCallback((me,nt)=>{const Ge=typeof nt=="string"?nt:typeof me?.target?.value=="string"?me.target.value:"";E(Ge),V("")},[]),Xe=u.useCallback(async(me,nt)=>{const Ge=me?.trim()??"";if(typeof nt!="function")return;if(!st||Ge.length===0){nt([]);return}const{searchMentions:vt}=await ci(async()=>{const{searchMentions:ct}=await import("./mentionSearch-CLdrbUuU.js");return{searchMentions:ct}},[]);await vt({worldId:st,query:Ge,limit:8,callback:nt})},[st]),dt=u.useCallback(()=>{O(!1),V(""),B("")},[]),ie=u.useCallback(()=>{At&&(V(""),B(""),O(!0))},[At]),ee=u.useCallback(async me=>{if(me.preventDefault(),!At||!y)return;const nt=j.trim();if(!nt){V("Please enter a note before saving");return}if(o&&!_){V("Select which character this note is for");return}V(""),B("");try{const Ge={content:nt,shareType:A,campaignId:i};o&&(Ge.characterId=_);const vt=await y(Ge);if(!vt||vt.success!==!0){V(vt?.message||"Failed to save note");return}E(""),o||T(""),dt()}catch(Ge){console.error("Failed to submit note",Ge),V(Ge.message||"Failed to save note")}},[At,j,y,A,i,o,_,dt]),ce=u.useCallback(me=>{if(!me||!e?.id)return;const nt=me?.characterId??me?.character_id??"";le(me.id),de(me?.content??""),he(me?.shareType??me?.share_type??"private"),Ce(nt),V("")},[e?.id]),fe=u.useCallback(()=>{le(null),de(""),he("private"),Ce(""),V("")},[]),qe=u.useCallback((me,nt)=>{const Ge=typeof nt=="string"?nt:typeof me?.target?.value=="string"?me.target.value:"";de(Ge),V("")},[]),Pe=u.useCallback(async me=>{if(!me||!e?.id||!i)return;const nt=K.trim();if(!nt){V("Please enter a note before saving");return}const Ge=me?.characterId??me?.character_id??"";if(o&&Ge&&!re){V("Select which character this note is for");return}ue(!0),V("");try{const vt={content:nt,shareType:Q,campaignId:i};o&&re&&(vt.characterId=re);const ct=await qj(e.id,me.id,vt),Nt=ct?.data||ct;if(!Nt)throw new Error("Note could not be updated");v&&await v(Nt),fe()}catch(vt){console.error("Failed to update note",vt),V(vt.message||"Failed to update note")}finally{ue(!1)}},[e?.id,i,K,Q,re,o,v,fe]),Be=u.useCallback(async me=>{if(!(!me?.id||!e?.id||!i||!window.confirm("Are you sure you want to delete this note? This action cannot be undone."))){Le(me.id),V("");try{await Pj(e.id,me.id,{campaignId:i}),S&&await S(me.id)}catch(Ge){console.error("Failed to delete note",Ge),V(Ge.message||"Failed to delete note")}finally{Le(null)}}},[e?.id,i,S]),Te=u.useMemo(()=>{const me=Array.isArray(f)?f:xa;return me.length<=1?me:[...me].sort((nt,Ge)=>{const vt=new Date(nt?.createdAt??nt?.created_at??0).getTime(),ct=new Date(Ge?.createdAt??Ge?.created_at??0).getTime();return Number.isNaN(vt)||Number.isNaN(ct)?0:ct-vt})},[f]),gt=u.useMemo(()=>{const me=[{value:"all",label:"All notes"}],nt=new Set(["all"]);return Te.forEach(Ge=>{const vt=mw(Ge);!vt||nt.has(vt)||(nt.add(vt),me.push({value:vt,label:Op(Ge)}))}),me},[Te]),jt=u.useMemo(()=>$==="all"?Te:Te.filter(me=>mw(me)===$),[$,Te]),Mt=u.useMemo(()=>Array.isArray(be.items)?be.items:xa,[be.items]),tt=u.useMemo(()=>Array.isArray(Me.items)?Me.items:xa,[Me.items]);u.useEffect(()=>{M("private")},[l,i]),u.useEffect(()=>{gt.some(me=>me.value===$)||F("all")},[gt,$]),u.useEffect(()=>{De({items:xa,loading:!1,error:"",loaded:!1}),mt({items:xa,loading:!1,error:"",loaded:!1}),Ct(new Set),P("entity")},[i,e?.id,b]),u.useEffect(()=>{let me=!1;return!o||!i?(C(xa),z(!1),U(""),T(""),()=>{me=!0}):((async()=>{z(!0),U("");try{const Ge=await Cs({scope:"my",campaign_id:i});if(me)return;const ct=(Array.isArray(Ge?.data)?Ge.data:Array.isArray(Ge)?Ge:[]).map(Nt=>({id:Nt?.id?String(Nt.id):"",name:Nt?.name||"Unnamed character"})).filter(Nt=>Nt.id);C(ct),ct.length===1?T(ct[0].id):ct.some(Nt=>Nt.id===_)||T("")}catch(Ge){if(me)return;console.error("Failed to load characters for notes",Ge),C(xa),T(""),U(Ge.message||"Failed to load characters")}finally{me||z(!1)}})(),()=>{me=!0})},[o,i,_]);const ft=u.useCallback(async()=>{if(!(!e?.id||!i||!b)){De(me=>({...me,loading:!0,error:""}));try{const me=await pI(e.id,{campaignId:i}),nt=Array.isArray(me?.data)?me.data:Array.isArray(me)?me:xa;De({items:nt,loading:!1,error:"",loaded:!0})}catch(me){De({items:xa,loading:!1,error:me?.message||"Failed to load mentions",loaded:!0})}}},[b,e?.id,i]),Rt=u.useCallback(async()=>{if(!(!e?.id||!i||!b)){mt(me=>({...me,loading:!0,error:""}));try{const me=await yI(e.id,{campaignId:i}),nt=Array.isArray(me?.data)?me.data:Array.isArray(me)?me:xa;mt({items:nt,loading:!1,error:"",loaded:!0})}catch(me){mt({items:xa,loading:!1,error:me?.message||"Failed to load mentions",loaded:!0})}}},[b,e?.id,i]);u.useEffect(()=>{H==="mentions"&&(!be.loading&&!be.loaded&&ft(),!Me.loading&&!Me.loaded&&Rt())},[H,be.loading,be.loaded,Me.loading,Me.loaded,ft,Rt]);const Ft=u.useCallback(me=>{const nt=Bi(me?.content,me?.mentions);if(!nt.length)return"";const Ge=nt.map(vt=>vt.type==="mention"?`@${vt.entityName||"entity"}`:vt.text||"").join("").replace(/\s+/g," ").trim();return Ge.length<=180?Ge:`${Ge.slice(0,177)}`},[]),Zt=u.useCallback(me=>{const nt=me?.sessionDate??me?.session_date;if(!nt)return"";try{const Ge=new Date(nt);if(!Number.isNaN(Ge.getTime()))return Ge.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}catch(Ge){return console.warn("Unable to format session date",Ge),nt}return nt},[]),Tt=u.useCallback(me=>{const nt=String(me);Ct(Ge=>{const vt=new Set(Ge);return vt.has(nt)?vt.delete(nt):vt.add(nt),vt})},[]),We=u.useCallback(me=>ht.has(String(me)),[ht]),it=u.useCallback(()=>{!e?.id||!i||!b||(Y==="entity"?ft():Rt())},[b,e?.id,ft,Rt,Y,i]),bt=u.useCallback(me=>{const nt=Bi(me?.content,me?.mentions);return nt.length?nt.map((Ge,vt)=>{if(Ge.type==="mention"){if(Ge.locationId){const Ye=`${me?.id||"note"}-mention-${vt}`,Je=Ge.locationName||"location";return t.jsxs("span",{className:"entity-note-mention",children:["@",Je,t.jsx(fs,{locationId:Ge.locationId,locationName:Je})]},Ye)}if(Ge.entityId){const Ye=`${me?.id||"note"}-mention-${vt}`,Je=Ge.entityName||"entity";return t.jsxs("span",{className:"entity-note-mention",children:["@",Je,t.jsx(Na,{entityId:Ge.entityId,entityName:Je})]},Ye)}const ct=Ge.locationName||Ge.entityName||"mention",Nt=`${me?.id||"note"}-mention-${vt}`;return t.jsxs("span",{className:"entity-note-mention",children:["@",ct]},Nt)}return t.jsx("span",{className:"entity-note-text",children:Ge.text},`${me?.id||"note"}-text-${vt}`)}):null},[]);u.useCallback(me=>`entity-note-share entity-note-share-${me}`,[]);const oe=Mt.length,Ee=tt.length,Se=be.loading,Ve=Me.loading,xe=be.error,$e=Me.error,He=be.loaded,J=Me.loaded,Z=!i||!b||(Y==="entity"?Se:Ve),je=o&&At,Ne=je&&k.length===1,pe=g,Ue=g||!j.trim()||o&&!_,ae=Te.length===0||gt.length<=1;u.useEffect(()=>{(H!=="notes"||!At)&&D&&dt()},[H,At,D,dt]);const Ke=s?.name||"",ot=u.useCallback(me=>{const nt=Op(me),Ge=me?.character?.name||"";return Ge?`${nt} (as ${Ge})`:nt},[]),St=u.useCallback(me=>{const nt=String(me?.shareType??me?.share_type??"private");return B3[nt]||"Private"},[]);return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"entity-notes-card-strict",children:[t.jsxs("div",{className:"entity-notes-header-row",children:[t.jsx("h2",{className:"entity-notes-title",children:"Notes"}),H==="notes"&&At?t.jsx("button",{type:"button",className:"btn-primary",onClick:ie,disabled:g,children:"+ Create note"}):null]}),s?.name?t.jsxs("p",{className:"entity-notes-campaign-line",children:["Campaign: ",Ke]}):null,t.jsxs("div",{className:"entity-notes-tabs-row",children:[t.jsx("button",{type:"button",className:`entity-notes-strict-tab-button${H==="notes"?" active":""}`,onClick:()=>I("notes"),children:"Notes"}),t.jsx("button",{type:"button",className:`entity-notes-strict-tab-button${H==="mentions"?" active":""}`,onClick:()=>I("mentions"),children:"@Mentions"})]}),H==="notes"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"entity-notes-strict-filter",children:[t.jsx("span",{className:"entity-notes-strict-filter-label",children:"Show notes from"}),t.jsx("select",{className:"entity-notes-strict-filter-select",value:$,onChange:me=>F(me.target.value),disabled:ae,children:gt.map(me=>t.jsx("option",{value:me.value,children:me.label},me.value))})]}),h?t.jsxs("div",{className:"entity-notes-strict-alert error",children:[t.jsx(ta,{size:16}),t.jsx("p",{children:h})]}):null,p?t.jsxs("div",{className:"entity-notes-strict-loading",children:[t.jsx(mn,{className:"spin",size:20}),t.jsx("span",{children:"Loading notes"})]}):null,!p&&jt.length===0?t.jsx("p",{className:"entity-notes-strict-empty",children:"No notes yet."}):null,!p&&jt.length>0?t.jsx("div",{className:"entity-notes-strict-list",children:jt.map(me=>{const nt=me?.createdAt??me?.created_at??me?.timestamp??null,Ge=Dp(nt);String(me?.shareType??me?.share_type??"private");const vt=W===me?.id,ct=lt(me);return me?.characterId??me?.character_id,t.jsx("div",{className:"entity-notes-strict-note-item",children:vt?t.jsxs("div",{className:"entity-notes-strict-edit-panel",children:[t.jsx(Gl,{value:K,onChange:qe,markup:"@[__display__](__id__)",placeholder:hw,className:"entity-note-mentions",inputProps:{className:"entity-notes-strict-textarea","aria-label":"Edit note content",rows:5,required:!0},children:t.jsx(li,{trigger:"@",markup:"@[__display__](__id__)",displayTransform:(Nt,Ye)=>`@${Ye||(Nt.includes(":")?Nt.split(":")[1]:Nt)}`,data:Xe,appendSpaceOnAdd:!0})}),t.jsx("p",{className:"entity-notes-strict-share-label",children:"Share with"}),t.jsx("div",{className:"entity-notes-strict-share-options",children:we.map(Nt=>t.jsxs("label",{className:"entity-notes-strict-share-option",children:[t.jsx("input",{type:"radio",name:`entity-note-share-edit-${me.id}`,value:Nt.value,checked:Q===Nt.value,onChange:()=>he(Nt.value),disabled:Re}),Nt.value==="private"?"Private":Nt.value==="party"?"Share with Party":Nt.label]},Nt.value))}),X?t.jsxs("div",{className:"entity-notes-strict-alert error",children:[t.jsx(ta,{size:16}),t.jsx("p",{children:X})]}):null,t.jsxs("div",{className:"entity-notes-strict-edit-actions",children:[t.jsx("button",{type:"button",className:"btn-primary",onClick:()=>Pe(me),disabled:Re||!K.trim(),children:Re?t.jsxs(t.Fragment,{children:[t.jsx(mn,{className:"spin",size:16})," Saving"]}):"Save"}),t.jsx("button",{type:"button",className:"btn-secondary",onClick:fe,disabled:Re,children:"Cancel"})]})]}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"entity-notes-strict-note-header",children:[t.jsxs("div",{className:"entity-notes-strict-note-title-row",children:[t.jsx("span",{className:"entity-notes-strict-note-title",children:ot(me)}),t.jsx("span",{className:"entity-notes-strict-note-visibility",children:St(me)})]}),t.jsx("span",{className:"entity-notes-strict-note-timestamp",children:Ge||""})]}),t.jsx("p",{className:"entity-notes-strict-note-body",children:bt(me)}),ct?t.jsxs("div",{className:"entity-notes-strict-note-actions",children:[t.jsx("button",{type:"button",className:"entity-notes-strict-edit-button",onClick:()=>ce(me),children:"Edit"}),t.jsx("button",{type:"button",className:"entity-notes-strict-delete-button",onClick:()=>Be(me),disabled:se===me.id,children:se===me.id?t.jsx(mn,{className:"spin",size:14}):"Delete"})]}):null]})},me?.id)})}):null]}):t.jsxs("div",{className:"entity-notes-strict-mentions",children:[t.jsxs("div",{className:"entity-notes-strict-mentions-header",children:[t.jsxs("div",{className:"entity-notes-strict-mention-toggle",children:[t.jsxs("button",{type:"button",className:`entity-notes-strict-mention-toggle-button${Y==="entity"?" active":""}`,onClick:()=>P("entity"),children:["Entity Notes",He?t.jsx("span",{className:"entity-notes-strict-mention-count",children:oe}):null]}),t.jsxs("button",{type:"button",className:`entity-notes-strict-mention-toggle-button${Y==="session"?" active":""}`,onClick:()=>P("session"),children:["Session Notes",J?t.jsx("span",{className:"entity-notes-strict-mention-count",children:Ee}):null]})]}),t.jsx("button",{type:"button",className:"btn-secondary",onClick:it,disabled:Z,children:(Y==="entity"?Se:Ve)?t.jsxs(t.Fragment,{children:[t.jsx(mn,{className:"spin",size:16})," Refreshing"]}):"Refresh"})]}),Y==="entity"?t.jsxs(t.Fragment,{children:[xe?t.jsxs("div",{className:"entity-notes-strict-alert error",children:[t.jsx(ta,{size:16}),t.jsx("p",{children:xe})]}):null,Se?t.jsxs("div",{className:"entity-notes-strict-loading",children:[t.jsx(mn,{className:"spin",size:20}),t.jsx("span",{children:"Loading mentions"})]}):null,!Se&&He&&oe===0?t.jsx("p",{className:"entity-notes-strict-empty",children:"This entity hasn't been mentioned in entity or location notes yet."}):null,!Se&&He&&oe>0?t.jsx("div",{className:"entity-notes-strict-list",children:Mt.map((me,nt)=>{const Ge=me?.id??me?.entityNoteId??me?.entity_note_id??`entity-mention-${nt}`,vt=String(Ge),ct=me?.createdAt??me?.created_at,Nt=ct?new Date(ct):null,Ye=Dp(Nt);String(me?.shareType??me?.share_type??"private"),Nt&&!Number.isNaN(Nt.getTime())&&Nt.toISOString();const Je=me?.entity?.name??me?.entityName??"Unnamed entity",Et=me?.entity?.id??me?.entityId??me?.entity_id??null,te=me?.location?.name??me?.locationName??"Unnamed location",ve=me?.location?.id??me?.locationId??me?.location_id??null;return t.jsxs("div",{className:"entity-notes-strict-note-item",children:[t.jsxs("div",{className:"entity-notes-strict-note-header",children:[t.jsxs("div",{className:"entity-notes-strict-note-title-row",children:[t.jsxs("span",{className:"entity-notes-strict-note-title",children:[ot(me),Et?t.jsxs(t.Fragment,{children:[" ","on"," ",t.jsx("span",{style:{fontWeight:500},children:Je})," ",t.jsx(Na,{entityId:Et,entityName:Je})]}):ve?t.jsxs(t.Fragment,{children:[" ","on"," ",t.jsx("span",{style:{fontWeight:500},children:te})," ",t.jsx(fs,{locationId:ve,locationName:te})]}):null]}),t.jsx("span",{className:"entity-notes-strict-note-visibility",children:St(me)})]}),t.jsx("span",{className:"entity-notes-strict-note-timestamp",children:Ye||""})]}),t.jsx("p",{className:"entity-notes-strict-note-body",children:bt(me)})]},`entity-mention-${vt}`)})}):null]}):t.jsxs(t.Fragment,{children:[$e?t.jsxs("div",{className:"entity-notes-strict-alert error",children:[t.jsx(ta,{size:16}),t.jsx("p",{children:$e})]}):null,Ve?t.jsxs("div",{className:"entity-notes-strict-loading",children:[t.jsx(mn,{className:"spin",size:20}),t.jsx("span",{children:"Loading session mentions"})]}):null,!Ve&&J&&Ee===0?t.jsx("p",{className:"entity-notes-strict-empty",children:"This entity hasn't been mentioned in session notes yet."}):null,!Ve&&J&&Ee>0?t.jsx("div",{className:"entity-notes-strict-list",children:tt.map((me,nt)=>{const Ge=me?.id??me?.noteId??me?.note_id??`session-mention-${nt}`,vt=String(Ge),ct=We(vt),Nt=Ft(me),Ye=me?.sessionTitle??me?.session_title??"Session note";Zt(me),Op(me);const Je=me?.updatedAt??me?.updated_at??me?.createdAt??me?.created_at,Et=Je?new Date(Je):null,te=Dp(Et),ve=Nt||"This session note does not include any text.";return t.jsxs("div",{className:"entity-notes-strict-note-item",children:[t.jsxs("div",{className:"entity-notes-strict-note-header",children:[t.jsx("div",{className:"entity-notes-strict-note-title-row",children:t.jsx("span",{className:"entity-notes-strict-note-title",children:Ye})}),t.jsx("span",{className:"entity-notes-strict-note-timestamp",children:te||""})]}),ct?t.jsx("p",{className:"entity-notes-strict-note-body",children:bt(me)}):t.jsx("p",{className:"entity-notes-strict-note-body",children:ve}),t.jsx("div",{className:"entity-notes-strict-note-actions",children:t.jsx("button",{type:"button",className:"entity-notes-strict-action-button",onClick:()=>Tt(vt),children:ct?"Hide note":"View note"})})]},`session-mention-${vt}`)})}):null]})]})]}),t.jsx(Ps,{isOpen:D&&At,onClose:dt,title:"Create note",children:t.jsx("div",{className:"entity-notes-form",children:t.jsxs("form",{onSubmit:ee,className:"entity-notes-form-body",children:[t.jsx("label",{className:"entity-notes-label",htmlFor:"entity-note-content",children:"Note"}),t.jsx("div",{className:"entity-note-editor-field",children:t.jsx(Gl,{value:j,onChange:Fe,markup:"@[__display__](__id__)",placeholder:hw,className:"entity-note-mentions",inputProps:{id:"entity-note-content",className:"entity-note-textarea","aria-label":"Entity note content",rows:5,required:!0,"data-autofocus":!0},children:t.jsx(li,{trigger:"@",markup:"@[__display__](__id__)",displayTransform:(me,nt)=>`@${nt||(me.includes(":")?me.split(":")[1]:me)}`,data:Xe,appendSpaceOnAdd:!0})})}),t.jsxs("fieldset",{className:"entity-notes-share",children:[t.jsx("legend",{children:"Share with"}),we.map(me=>t.jsxs("label",{className:"entity-notes-share-option",children:[t.jsx("input",{type:"radio",name:"entity-note-share",value:me.value,checked:A===me.value,onChange:()=>M(me.value),disabled:pe}),t.jsx("span",{children:me.label})]},me.value))]}),je?t.jsxs("div",{className:"entity-notes-character",children:[t.jsx("label",{htmlFor:"entity-note-character",children:"Character"}),t.jsxs("select",{id:"entity-note-character",value:_,onChange:me=>T(me.target.value),disabled:L||Ne,required:!0,children:[t.jsx("option",{value:"",disabled:!0,children:L?"Loading characters":"Select character"}),k.map(me=>t.jsx("option",{value:me.id,children:me.name},me.id))]}),Ne?t.jsxs("p",{className:"entity-notes-hint",children:["Notes will be associated with your character ",k[0]?.name,"."]}):null,G?t.jsxs("div",{className:"entity-notes-alert error",children:[t.jsx(ta,{size:16}),t.jsx("p",{children:G})]}):null,!L&&!G&&k.length===0?t.jsx("p",{className:"entity-notes-hint",children:"You need an active character in this campaign to attach notes."}):null]}):null,X?t.jsxs("div",{className:"entity-notes-alert error",children:[t.jsx(ta,{size:16}),t.jsx("p",{children:X})]}):null,R?t.jsx("div",{className:"entity-notes-alert success",children:t.jsx("p",{children:R})}):null,t.jsx("div",{className:"entity-notes-actions",children:t.jsx("button",{type:"submit",className:"primary",disabled:Ue,children:g?t.jsxs(t.Fragment,{children:[t.jsx(mn,{className:"spin",size:16})," Saving"]}):"Save note"})})]})})})]})}P1.propTypes={entity:It.object,worldId:It.oneOfType([It.string,It.number]),selectedCampaign:It.object,selectedCampaignId:It.oneOfType([It.string,It.number]),isCampaignDm:It.bool,isCampaignPlayer:It.bool,canCreateNote:It.bool,notes:It.arrayOf(It.object),loading:It.bool,error:It.string,onCreateNote:It.func,creating:It.bool,campaignMatchesEntityWorld:It.bool,onNoteUpdate:It.func,onNoteDelete:It.func};const P3=e=>{const n=e?.options?.choices;return!Array.isArray(n)||n.length===0?[]:n.map((s,i)=>{if(s==null)return null;if(typeof s=="object"){const o=s.value??s.id??s.key??s.slug??`choice-${i}`,d=s.label??s.name??s.title??s.display??o;return o==null?null:{value:o,label:String(d??o)}}const l=String(s);return{value:l,label:l}}).filter(Boolean)},H3=e=>{if(!e?.name)return null;const n=`metadata.${e.name}`,s=e.visibleByDefault!==void 0?!!e.visibleByDefault:e.visible_by_default!==void 0?!!e.visible_by_default:!0,i={key:n,name:n,label:e.label||e.name,metadataField:e.name,dataType:e.dataType,visibleByDefault:s};switch(e.dataType){case"text":return{...i,type:"textarea",rows:3};case"boolean":return{...i,type:"boolean"};case"enum":return{...i,type:"select",options:P3(e)};case"number":return{...i,type:"text",inputType:"number"};case"date":return{...i,type:"text"};case"entity_reference":case"location_reference":case"reference":{const l=e.referenceTypeId??e.reference_type_id??e.referenceType?.id??null,o=e.referenceTypeName??e.reference_type_name??e.referenceType?.name??"",d=e.referenceFilter??e.reference_filter??e.referenceFilterJson??{},f=(()=>{if(e.displayValue)return String(e.displayValue);if(e.display)return String(e.display);if(e.selectedLabel)return String(e.selectedLabel);const p=e.value;if(!p||typeof p!="object")return"";const h=p.label??p.name??p.title??p.display??p.displayName??p.text??p.value;return h!=null?String(h):""})();return{...i,type:"reference",referenceTypeId:l,referenceTypeName:o,referenceFilter:d,displayKey:`metadataDisplay.${e.name}`,selectedLabel:f}}default:return{...i,type:"text"}}},gd=(e,n,s="")=>{if(e!=null){const i=String(e).trim();if(i)return i}if(n!=null){const i=String(n).trim();if(i)return`name:${i.toLowerCase()}`}if(s){const i=String(s).trim();if(i)return`label:${i.toLowerCase().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")||"fallback"}`}return""};function V3(){const{id:e}=Ka(),n=_n(),s=Xa(),{user:i,token:l,sessionReady:o}=un(),{selectedCampaign:d,selectedCampaignId:f,setSelectedCampaignId:p}=wn(),h=to(),[y,g]=u.useState(null),b=u.useCallback(ge=>{const _e=Ya(ge);_e&&g(pt=>pt?!_e.permissions&&pt.permissions?{..._e,permissions:pt.permissions}:(_e.permissions,_e):_e)},[]),[v,S]=u.useState(!0),[N,j]=u.useState(""),[E,A]=u.useState(""),[M,_]=u.useState("dossier"),[T,k]=u.useState(!1),[C,L]=u.useState(!1),[z,G]=u.useState(!1),[U,X]=u.useState(null),[V,R]=u.useState({items:[],loading:!1,error:""}),[B,D]=u.useState(!1),O=u.useRef(null),[$,F]=u.useState({isDirty:!1,isSubmitting:!1}),[H,I]=u.useState(!1),[Y,P]=u.useState(null),W=u.useRef(null),[le,K]=u.useState(!1),[de,Q]=u.useState([]),[he,re]=u.useState(""),[Ce,Re]=u.useState(!1),[ue,se]=u.useState([]),[Le,be]=u.useState([]),[De,Me]=u.useState(()=>jp()),mt=u.useRef(s),ht=u.useRef(null),At=u.useMemo(()=>!d||!i?.id?null:(Array.isArray(d.members)?d.members:[]).find(pt=>{if(!pt)return!1;const Dt=pt.user_id??pt.userId??pt.user?.id??pt.id??null;return Dt?String(Dt)===String(i.id):!1})||null,[d,i?.id])?.role??null,we=u.useMemo(()=>i?.role==="system_admin"?!0:At==="dm",[At,i?.role]),st=u.useMemo(()=>At==="player",[At]),lt=u.useMemo(()=>!!(we||st),[we,st]),Fe=u.useMemo(()=>y?y.world?.id?String(y.world.id):y.world_id?String(y.world_id):y.worldId?String(y.worldId):"":"",[y]),Xe=u.useMemo(()=>d?d.world?.id?String(d.world.id):d.world_id?String(d.world_id):"":"",[d]),dt=u.useMemo(()=>!f||!Fe||!Xe?!0:String(Fe)===String(Xe),[f,Fe,Xe]),ie=s.state?.fromEntities?.search||"",ee=u.useMemo(()=>ie?ie.startsWith("?")?`/entities${ie}`:`/entities?${ie}`:"/entities",[ie]),ce=u.useCallback(ge=>{if(!ge)return"the next page";const _e=ge.pathname||"",pt=ge.search||"",Dt=`${_e}${pt}`;return Dt?Dt===ee?"the previous page":Dt:"the next page"},[ee]),fe=u.useCallback(ge=>{if(!ge)return"";const _e=ge.pathname||"",pt=ge.search||"",Dt=ge.hash||"";return`${_e}${pt}${Dt}`},[]),qe=u.useCallback(ge=>{if(!ge||typeof ge!="string")return null;const _e=ge.indexOf("#"),pt=ge.indexOf("?");let Dt=ge.length;_e>=0&&(Dt=_e),pt>=0&&pt<Dt&&(Dt=pt);const Ht=ge.slice(0,Dt)||"",tn=pt>=0?ge.slice(pt,_e>=0?_e:void 0):"",rn=_e>=0?ge.slice(_e):"";return{pathname:Ht,search:tn,hash:rn}},[]),Pe=u.useCallback(ge=>{if(ge){if(ge.externalUrl){typeof window<"u"&&window.location.assign(ge.externalUrl);return}if(ge.to!==void 0&&ge.to!==null){const _e=ge.to;if(typeof _e=="string"){ht.current=_e,n(_e,{replace:ge.replace,state:ge.state});return}const pt=fe(_e);pt&&(ht.current=pt),n(_e,{replace:ge.replace,state:ge.state})}}},[fe,n]),Be=u.useCallback(ge=>{ge&&g(_e=>{if(!_e)return _e;const pt=Array.isArray(_e.secrets)?_e.secrets:[],Dt=pt.findIndex(en=>!en||!ge||!en.id||!ge.id?!1:String(en.id)===String(ge.id)),Ht=Dt>=0?pt.map((en,Cn)=>Cn===Dt?ge:en):[...pt,ge],tn=en=>{if(!en)return 0;const Cn=new Date(en).getTime();return Number.isNaN(Cn)?0:Cn},rn=Ht.slice().sort((en,Cn)=>tn(en?.created_at||en?.createdAt)-tn(Cn?.created_at||Cn?.createdAt));return{..._e,secrets:rn}})},[]),Te=u.useCallback(async()=>{const ge=await hI(e,{campaignId:f});return Array.isArray(ge?.data)?ge.data:Array.isArray(ge)?ge:[]},[e,f]);u.useEffect(()=>{let ge=!1;return!e||!f||!dt?(R({items:[],loading:!1,error:""}),()=>{ge=!0}):(R(pt=>({...pt,loading:!0,error:""})),(async()=>{try{const pt=await Te();ge||R({items:pt,loading:!1,error:""})}catch(pt){if(!ge){const tn=(pt.status===403||pt.status==="403"||pt.message==="Forbidden")&&!!f?"CAMPAIGN_CONTEXT_ACCESS_DENIED":pt.message||"Failed to load notes";R(rn=>({...rn,loading:!1,error:tn}))}}})(),()=>{ge=!0})},[e,f,dt,Te]);const gt=u.useCallback(async()=>{if(!e||!f||!dt){R({items:[],loading:!1,error:""});return}R(ge=>({...ge,loading:!0,error:""}));try{const ge=await Te();R({items:ge,loading:!1,error:""})}catch(ge){R(_e=>({..._e,loading:!1,error:ge.message||"Failed to load notes"}))}},[e,f,dt,Te]),jt=u.useCallback(async ge=>{if(!e)return{success:!1,message:"Entity not found"};if(!f)return{success:!1,message:"Select a campaign first"};D(!0);try{const _e={...ge,campaignId:ge?.campaignId??f},pt=await gI(e,_e),Dt=pt?.data||pt;if(!Dt)throw new Error("Note could not be created");const Ht=Dt?.createdAt??Dt?.created_at??new Date().toISOString(),tn=Dt?.createdAt&&Dt?.created_at?Dt:{...Dt,...Dt?.createdAt?{}:{createdAt:Ht},...Dt?.created_at?{}:{created_at:Ht}};return R(rn=>{const en=Array.isArray(rn?.items)?rn.items.slice():[],Cn=Dt?.id,Pn=Cn?en.filter(oa=>oa?.id!==Cn):en;return{items:[tn,...Pn],loading:!1,error:""}}),{success:!0,note:tn}}catch(_e){return{success:!1,message:_e.message||"Failed to create note"}}finally{D(!1)}},[e,f]),Mt=u.useCallback(async ge=>{if(!ge?.id)return;const _e=ge?.updatedAt??ge?.updated_at??ge?.createdAt??ge?.created_at??new Date().toISOString(),pt=ge?.updatedAt&&ge?.updated_at?ge:{...ge,...ge?.updatedAt?{}:{updatedAt:_e},...ge?.updated_at?{}:{updated_at:_e}};R(Dt=>{const Ht=Array.isArray(Dt?.items)?Dt.items.slice():[],tn=pt?.id;if(!tn)return Dt;const rn=Ht.findIndex(en=>en?.id===tn);if(rn>=0){const en=[...Ht];return en[rn]=pt,{items:en,loading:!1,error:""}}return{items:[pt,...Ht],loading:!1,error:""}})},[]),tt=u.useCallback(async ge=>{ge&&R(_e=>({items:(Array.isArray(_e?.items)?_e.items.slice():[]).filter(Ht=>Ht?.id!==ge),loading:!1,error:""}))},[]),ft=u.useMemo(()=>y?.permissions&&typeof y.permissions.canEdit=="boolean"?y.permissions.canEdit:!y||!i?!1:!!(i.role==="system_admin"||y.world?.created_by&&y.world.created_by===i.id||y.created_by&&y.created_by===i.id),[y,i]),Rt=u.useMemo(()=>Array.isArray(y?.secrets)?y.secrets:[],[y?.secrets]),Ft=u.useMemo(()=>!!y?.permissions?.canManageSecrets,[y?.permissions?.canManageSecrets]),Zt=Ft||Rt.length>0,Tt=u.useMemo(()=>{const ge=[{id:"dossier",label:"Dossier"},{id:"notes",label:"Notes"},{id:"relationships",label:"Relationships"}];return Zt&&ge.push({id:"secrets",label:"Secrets"}),ft&&T&&ge.push({id:"access",label:"Access"}),ge.push({id:"system",label:"System"}),ge},[Zt,ft,T]);u.useEffect(()=>{new Set(Tt.map(_e=>_e.id)).has(M)||_("dossier")},[Tt,M]);const We=u.useCallback((ge,_e,pt,Dt=null)=>{if(!ge)return null;const Ht=Array.isArray(ge.sections)?ge.sections:[],tn=Dt?.actionsByField??{},rn=Dt?.showRuleTargets??new Set;return Ht.map((en,Cn)=>{const Pn=`${pt||"section"}-${en.title||Cn}`,oa=Number.isFinite(en.columns)?Math.max(1,Number(en.columns)):1,_a=Array.isArray(en.fields)?en.fields:[];return t.jsxs("section",{className:"entity-card bg-white rounded-lg border p-4 sm:p-6 w-full",children:[en.title?t.jsx("h2",{className:"entity-card-title",children:en.title}):null,t.jsx("div",{className:`entity-field-grid ${oa>1?"grid grid-cols-1 sm:grid-cols-2 gap-4":""}`,style:{"--entity-field-columns":oa},children:_a.length>0?_a.map((ga,ks)=>{const $a=ga?.key||ga?.name||ga?.field||`${Pn}-field-${ks}`,fi=tn[$a],Xt=ga.visibleByDefault!==void 0?!!ga.visibleByDefault:ga.visible_by_default!==void 0?!!ga.visible_by_default:!0;return Rc($a,fi,rn,Xt)?null:t.jsx(Wc,{field:{...ga},data:_e,mode:"view"},$a)}):t.jsx("p",{className:"entity-empty-state",children:"No fields available."})})]},Pn)})},[]);u.useEffect(()=>{if(!U)return;const ge=setTimeout(()=>X(null),4e3);return()=>clearTimeout(ge)},[U]);const it=u.useCallback(async()=>{if(e){S(!0),j(""),A("");try{const ge=await Hs(e),_e=Ya(ge);if(!_e){g(null),j("Entity not found");return}b(_e)}catch(ge){const _e=ge.status===403||ge.status==="403"||ge.message==="Forbidden";j(_e&&!!f?"CAMPAIGN_CONTEXT_ACCESS_DENIED":ge.message||"Failed to load entity"),g(null)}finally{S(!1)}}},[e,b,f]),bt=u.useCallback(async ge=>{if(!ge){se([]),be([]);return}try{const[_e,pt]=await Promise.all([If(ge).catch(()=>null),Lf(ge).catch(()=>null)]);se(ii(_e)),be(ii(pt))}catch{se([]),be([])}},[]);u.useEffect(()=>{o&&l&&it()},[o,l,it]),u.useEffect(()=>{const ge=y?.entity_type_id||y?.entityType?.id||y?.entity_type?.id||null;if(!ge){se([]),be([]);return}bt(ge)},[y?.entity_type_id,y?.entityType?.id,y?.entity_type?.id,bt]);const oe=u.useMemo(()=>Array.isArray(y?.fields)?_g(y.fields,ue).map(_e=>H3(_e)).filter(Boolean):[],[y?.fields,ue]),Ee=u.useMemo(()=>!y?.fields||y.fields.length===0?{__placeholder:"No metadata defined for this entity type."}:kg(y.fields),[y]),Se=y?.fields,Ve=u.useMemo(()=>Ag(Le,Se),[Le,Se]),xe=u.useMemo(()=>!y?.fields||y.fields.length===0?{}:d1(y.fields),[y]),$e=u.useMemo(()=>!y?.fields||y.fields.length===0?{}:u1(y.fields),[y]),He=u.useMemo(()=>{if(!y?.id)return null;const ge=y?.entityType?.name||y?.entity_type?.name||y?.entityTypeName||"entity";return{id:y.id,type:`entity:${ge}`,title:y.name||"Untitled entity",worldId:Fe,worldName:y?.world?.name||y?.world_name||""}},[y?.id,y?.name,y?.entityType?.name,y?.entity_type?.name,y?.entityTypeName,Fe,y?.world?.name,y?.world_name]);Ij(He);const J=u.useRef(null),Z=u.useRef(!1),je=u.useRef(!1);u.useEffect(()=>{const ge=y?.id,_e=J.current;ge!==_e&&_e!==null&&!je.current&&(k(!1),Z.current=!1),J.current=ge},[y?.id,T]);const Ne=y?.createdAt||y?.created_at,pe=y?.updatedAt||y?.updated_at,Ue=u.useMemo(()=>{if(!y)return null;const ge=y.location?.id||y.location_id||null,_e=y.location?.name||null;return{name:y.name||"",description:y.description||"",typeName:y.entityType?.name||y.entity_type?.name||"",location:ge,locationName:_e||"",worldName:y.world?.name||y.world_name||"",worldId:Fe,createdAt:os(Ne),updatedAt:os(pe),metadata:Ee,metadataDisplay:xe,createdBy:y.creator?.username||y.creator?.email||y.created_by||"",updatedBy:y.updated_by||""}},[y,Ee,xe,Fe,Ne,pe]),ae=u.useMemo(()=>Tg(Ve,Ue||{}),[Ve,Ue]),Ke=u.useMemo(()=>{if(!y)return null;const ge=y.location?.id||y.location_id||null;return{name:y.name||"",description:y.description||"",visibility:y.visibility||"visible",entityTypeName:y.entityType?.name||y.entity_type?.name||"",location_id:ge||null,worldName:y.world?.name||y.world_name||"",worldId:Fe,createdAt:os(Ne),updatedAt:os(pe),metadata:$e}},[y,Fe,Ne,pe,$e]);u.useEffect(()=>{if(!T||!y||!Ke||!O.current?.reset||!Z.current)return;const ge=setTimeout(()=>{O.current?.reset&&Ke&&O.current.reset(Ke),Z.current=!1},150);return()=>clearTimeout(ge)},[T,y,Ke]);const ot=u.useMemo(()=>{if(!y)return"";const ge=y.imageMimeType||y.image_mime_type||"",_e=y.imageData||y.image_data||"";return!ge||!_e?"":`data:${ge};base64,${_e}`},[y]),St=u.useMemo(()=>!y||!ft?null:t.jsx(m4,{entity:y,canEdit:ft,isEditing:T,onEntityUpdate:b,variant:T?"compact":"card"}),[y,ft,T,b]),me="Information",nt=u.useMemo(()=>{const ge=oe.length>0;return{title:"Edit Entity",sections:[{title:"Edit Entity",columns:2,fields:[{key:"name",label:"Name",type:"text"},{key:"entityTypeName",label:"Type",type:"readonly"},{key:"location_id",label:"Location",type:"location_reference",dataType:"location_reference"},{key:"description",label:"Description",type:"textarea",rows:4,span:2}]},{title:me,columns:ge?2:1,fields:ge?oe:[{key:"metadata.__placeholder",name:"metadata.__placeholder",label:"Information",type:"readonly"}]}]}},[oe,me]),Ge=u.useMemo(()=>{const ge=oe.length>0?oe:[{key:"metadata.__placeholder",name:"metadata.__placeholder",label:"Information",type:"readonly"}];return{title:"Entity Overview",sections:[{title:"Summary",columns:2,fields:[{key:"name",label:"Name",type:"readonly"},{key:"typeName",label:"Type",type:"readonly"},{key:"location",label:"Location",type:"location_reference",dataType:"location_reference"}]},{title:"Description",columns:1,fields:[{key:"description",label:"Description",type:"textarea",rows:4}]},{title:me,columns:oe.length>0?2:1,fields:ge}]}},[oe,me]),vt=u.useMemo(()=>({sections:[{title:"System",columns:2,fields:[{key:"worldName",label:"World",type:"readonly"},{key:"createdAt",label:"Created",type:"readonly"},{key:"createdBy",label:"Created by",type:"readonly"},{key:"updatedAt",label:"Updated",type:"readonly"},{key:"updatedBy",label:"Updated by",type:"readonly"}]}]}),[]),{accessSettings:ct,accessOptions:Nt,accessOptionsError:Ye,accessOptionsLoading:Je,accessSaving:Et,accessSaveError:te,accessSaveSuccess:ve,isAccessDirty:Ie,handleAccessSettingChange:rt,resetAccessSettings:_t,handleAccessSave:Lt}=S4(y,l,ft),nn=u.useMemo(()=>y?.world?.id||y?.world_id||"",[y]),Pt=y?.id?String(y.id):"",zt=u.useCallback(async()=>{if(!Pt||!l){Q([]),re(""),Re(!1);return}Re(!0),re("");try{const ge=await g1(Pt),_e=Array.isArray(ge)?ge:Array.isArray(ge?.data)?ge.data:[];Q(_e)}catch(ge){Q([]),re(ge.message||"Failed to load relationships")}finally{Re(!1)}},[Pt,l]);u.useEffect(()=>{zt()},[zt]);const Ut=u.useMemo(()=>{if(!Array.isArray(de))return[];const ge=_e=>_e?typeof _e=="string"||typeof _e=="number"?String(_e).trim():typeof _e=="object"?String(_e.id||_e.entity_id||_e.entityId||"").trim():"":"";return de.map(_e=>{const pt=_e.relationshipType||_e.relationship_type||_e.type||_e.relationshipTypeId||{},Dt=pt?.from_name||pt?.fromName||_e.source_relationship_label||_e.sourceLabel||"",Ht=pt?.to_name||pt?.toName||_e.target_relationship_label||_e.targetLabel||"";return{id:_e.id,typeId:ge(_e.relationship_type_id||_e.relationshipTypeId||_e.typeId||_e.type),typeName:_e.relationshipType?.name||_e.type?.name||"",fromId:ge(_e.from_entity_id||_e.fromEntityId||_e.from),toId:ge(_e.to_entity_id||_e.toEntityId||_e.to),fromName:_e.from_entity?.name||_e.from?.name||"",toName:_e.to_entity?.name||_e.to?.name||"",fromEntityTypeName:_e.from_entity_type?.name||_e.fromEntityTypeName||"",toEntityTypeName:_e.to_entity_type?.name||_e.toEntityTypeName||"",direction:_e.context?.__direction==="reverse"?"reverse":"forward",sourceLabel:Dt||"",targetLabel:Ht||""}})},[de]),dn=u.useMemo(()=>Ut.filter(ge=>ge.fromId===Pt||ge.toId===Pt).sort((ge,_e)=>{const pt=ge.fromId===Pt?ge.toName:ge.fromName,Dt=_e.fromId===Pt?_e.toName:_e.fromName;return pt.localeCompare(Dt,void 0,{sensitivity:"base"})}),[Ut,Pt]),Un=u.useMemo(()=>{const ge=new Map,_e=new Map;dn.forEach(Ht=>{const tn=Ht.typeName||"Unknown type",rn=gd(Ht.typeId,Ht.typeName,tn);rn&&!ge.has(rn)&&ge.set(rn,tn);const Cn=Ht.fromId===Pt?Ht.toEntityTypeName:Ht.fromEntityTypeName,Pn=gd(null,Cn,Cn);Pn&&!_e.has(Pn)&&_e.set(Pn,Cn)});const pt=Array.from(ge.entries()).map(([Ht,tn])=>({value:Ht,label:tn})),Dt=Array.from(_e.entries()).map(([Ht,tn])=>({value:Ht,label:tn}));return{relationshipTypes:pt,relatedEntityTypes:Dt}},[dn,Pt]),yn=u.useMemo(()=>{const ge=De.relationshipTypes||{mode:"all",values:[]},_e=De.relatedEntityTypes||{mode:"all",values:[]};return dn.filter(pt=>{const Dt=gd(pt.typeId,pt.typeName,pt.typeName);if(ge.mode!=="all"&&ge.values.length){const Ht=Dt&&ge.values.includes(Dt);if(ge.mode==="include"&&!Ht||ge.mode==="exclude"&&Ht)return!1}if(_e.mode!=="all"&&_e.values.length){const tn=pt.fromId===Pt?pt.toEntityTypeName:pt.fromEntityTypeName,rn=gd(null,tn,tn),en=rn&&_e.values.includes(rn);if(_e.mode==="include"&&!en||_e.mode==="exclude"&&en)return!1}return!0})},[dn,De,Pt]),ja=u.useCallback(ge=>{Me(!ge||typeof ge!="object"?jp():ge)},[]),ha=u.useCallback(()=>{Me(jp())},[]),Xi=Ce,na=u.useMemo(()=>`No relationships found for ${y?.name||"this entity"}.`,[y?.name]),hs=u.useCallback(async()=>{if(!ft)return!1;je.current=!0;let ge=!0,_e=!1;try{if($.isDirty&&O.current?.submit&&await O.current.submit()===!1&&(ge=!1),ge&&Ie&&(await Lt()?_e=!0:ge=!1),ge&&_e&&y?.id)try{const pt=await Hs(y.id),Dt=Ya(pt);Dt&&b(Dt)}catch{}return ge}finally{setTimeout(()=>{je.current=!1},200)}},[ft,$.isDirty,Ie,Lt,y?.id,b,T]),jr=u.useCallback(()=>{const ge=W.current;P(null),ge?.proceed?.()},[]),ui=u.useCallback(async()=>{K(!0);try{if(await hs()){I(!1);const _e=W.current;_e?.type!=="exit-edit"?jr():(P(null),_e?.proceed?.())}}finally{K(!1)}},[hs,jr]),ps=u.useCallback(()=>{O.current?.reset?.(Ke||{}),_t()},[Ke,_t]),qn=u.useMemo(()=>T&&($.isDirty||Ie),[T,$.isDirty,Ie]),Xs=u.useCallback(()=>{k(!1),_("dossier")},[_,y?.id,ft,qn]),Ea=u.useCallback(ge=>{if(!ge)return;const _e=()=>{if(ge.label)return ge.label;if(ge.externalUrl)return ge.externalLabel||ge.externalUrl;if(typeof ge.to=="string"){const pt=ge.location||qe(ge.to);return ce(pt)}return ce(ge.location||ge.to)};if(!qn){Pe(ge);return}P({type:"navigation",label:_e(),proceed:()=>Pe(ge),discard:()=>Pe(ge),stay:()=>{}}),I(!0)},[ce,qn,qe,Pe,P,I]);u.useEffect(()=>{if(typeof document>"u"||!qn)return;const ge=_e=>{if(!qn||_e.defaultPrevented||_e.button!==0||_e.metaKey||_e.ctrlKey||_e.shiftKey||_e.altKey)return;const pt=_e.target,Dt=pt instanceof Element?pt:pt&&"parentElement"in pt?pt.parentElement:null;if(!Dt||typeof Dt.closest!="function")return;const Ht=Dt.closest("a[href]");if(!Ht||Ht.hasAttribute("data-ignore-unsaved-warning"))return;const tn=Ht.getAttribute("href");if(!tn||tn.startsWith("#")||tn.startsWith("javascript:"))return;const rn=Ht.getAttribute("target");if(rn&&rn.toLowerCase()!=="_self")return;let en;try{en=new URL(tn,window.location.href)}catch{return}const Cn=Ht.getAttribute("data-navigation-label")||Ht.getAttribute("aria-label")||Ht.title||Ht.textContent?.trim()||"",Pn=en.origin!==window.location.origin;if(_e.preventDefault(),_e.stopPropagation(),Pn){Ea({externalUrl:en.href,label:Cn||en.href});return}const oa=`${en.pathname}${en.search}${en.hash}`,_a=`${window.location.pathname}${window.location.search}${window.location.hash}`;!oa||oa===_a||Ea({to:oa,location:qe(oa),label:Cn||ce({pathname:en.pathname,search:en.search})})};return document.addEventListener("click",ge,!0),()=>{document.removeEventListener("click",ge,!0)}},[ce,qn,qe,Ea]);const io=u.useCallback(()=>{const ge=`/entities/${e}/relationship-viewer`;Ea({to:ge,location:qe(ge)})},[e,qe,Ea]),Ki=u.useCallback(()=>{if(ft){if(A(""),!T){k(!0);return}if(qn){P({type:"exit-edit",label:"view mode",proceed:async()=>{await hs()&&Xs()},discard:()=>{ps(),Xs()}}),I(!0);return}Xs()}},[ft,Xs,qn,T,ps,hs]),Zi=u.useCallback(async ge=>{if(!y?.id)return!1;A("");try{const _e={name:ge?.name,description:ge?.description,metadata:ge?.metadata||{}};y?.visibility&&(_e.visibility=y.visibility),_e.location_id=ge?.location_id||null;const pt=await bg(y.id,_e),Dt=Ya(pt);if(!Dt)throw new Error("Failed to update entity");return b(Dt),Z.current=!0,{message:"Entity updated successfully."}}catch(_e){return A(_e.message||"Failed to update entity"),Z.current=!1,!1}},[y?.id,y?.visibility,b,T]),di=u.useCallback(ge=>{F(_e=>{const pt={isDirty:!!ge?.isDirty,isSubmitting:!!ge?.isSubmitting};return _e.isDirty===pt.isDirty&&_e.isSubmitting===pt.isSubmitting?_e:pt})},[y?.id,T]),lo=u.useCallback(ge=>{!ge||ge===M||_(ge)},[M,_]),oo=u.useCallback(()=>{I(!1);const ge=W.current;P(null),ge?.discard?.()},[]),ye=u.useCallback(()=>{I(!1);const ge=W.current;P(null),ge?.stay?.()},[]);hj(u.useCallback(ge=>{qn&&(ge.preventDefault(),ge.returnValue="")},[qn]),{capture:!0});const Oe=u.useCallback(({currentLocation:ge,nextLocation:_e})=>!qn||!_e?!1:!(ge.pathname===_e.pathname&&ge.search===_e.search&&ge.hash===_e.hash),[qn]),$t=w4(Oe);if(u.useEffect(()=>{W.current=Y},[Y]),u.useEffect(()=>{if($t.state==="blocked"){if(!qn){$t.reset?.();return}if(Y){if(Y.type==="navigation")return;$t.reset?.();return}P({type:"navigation",label:ce($t.location),proceed:()=>$t.proceed?.(),discard:()=>$t.proceed?.(),stay:()=>$t.reset?.()}),I(!0)}},[$t,qn,Y,ce]),u.useEffect(()=>{const ge=mt.current,_e=fe(ge),pt=fe(s);if(_e===pt){mt.current=s;return}if(!qn){mt.current=s,ht.current=null;return}if(ht.current&&ht.current===pt){ht.current=null,mt.current=s;return}if(!ge||Y){mt.current=ge||s;return}const Dt=pt||"/",Ht=_e||"/",tn=()=>{ht.current=Dt,n(Dt)},rn=()=>{ht.current=Ht,n(Ht)};P({type:"navigation",label:ce(s),proceed:tn,discard:tn,stay:rn}),I(!0),ht.current=Ht,n(Ht,{replace:!0})},[fe,ce,qn,s,n,Y]),!o)return t.jsx("p",{children:"Restoring session..."});if(!l)return t.jsx("p",{children:"Authenticating..."});if(v)return t.jsx("p",{children:"Loading entity..."});if(N==="CAMPAIGN_CONTEXT_ACCESS_DENIED")return t.jsxs("div",{className:"alert error",style:{padding:"1.5rem",maxWidth:"600px",margin:"2rem auto"},children:[t.jsx("h2",{style:{marginTop:0,marginBottom:"1rem"},children:"Access Restricted by Campaign Context"}),t.jsx("p",{style:{marginBottom:"1rem"},children:"You don't have access to this entity with your current campaign context selected. This entity may belong to a different campaign or world, or your current campaign context doesn't have permission to view it."}),t.jsx("p",{style:{marginBottom:"1.5rem"},children:"To view this entity, please change your campaign context using the selector in the header to a campaign that has access to this entity."}),t.jsx("div",{style:{display:"flex",gap:"1rem",flexWrap:"wrap"},children:t.jsx("button",{type:"button",onClick:()=>n("/entities"),style:{padding:"0.5rem 1rem",backgroundColor:"#6c757d",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Go to Entities"})})]});if(N)return t.jsx("div",{className:"alert error",children:N});if(!y||!Ue)return t.jsx("p",{children:"Entity not found"});const Qt=`entity-detail-page${h?" entity-detail-page--mobile":""}${h&&C?" entity-detail-page--header-expanded":""}`;return t.jsxs(t.Fragment,{children:[t.jsx(qg,{maxWidth:1280,className:Qt,children:t.jsxs("div",{className:"w-full max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 overflow-x-hidden",children:[t.jsx("header",{className:`entity-page-header ${h&&!C?"entity-page-header--collapsed":""}`,children:t.jsxs("div",{className:"entity-page-header__inner",children:[h&&t.jsx("button",{type:"button",className:"entity-page-header__drag-handle",onClick:()=>L(!C),"aria-label":C?"Collapse header":"Expand header","aria-expanded":C,children:t.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:C?"rotated":"",children:t.jsx("polyline",{points:"6 9 12 15 18 9"})})}),t.jsx(a4,{entityId:e,name:y.name,canEdit:ft,isEditing:T,onToggleEdit:Ki,onSave:hs,isSaving:$.isSubmitting||Et,isSaveDisabled:!$.isDirty&&!Ie,isMobile:h}),t.jsxs("div",{className:`entity-page-header__tabs flex flex-wrap items-center justify-between gap-4 mt-4 ${h&&!C?"entity-page-header__tabs--collapsed":""}`,children:[t.jsx(j1,{tabs:Tt,activeTab:M,onChange:lo}),e&&t.jsx(r4,{entityId:e,importance:y.importance,onUpdate:ge=>{g(_e=>_e?{..._e,importance:ge}:null)}})]})]})}),t.jsx("div",{className:"entity-detail-shell",children:t.jsxs("div",{className:"entity-detail-body",children:[t.jsx("div",{className:"entity-tab-panel",role:"tabpanel",hidden:M!=="dossier",children:t.jsx(N4,{isEditing:T,canEdit:ft,formError:E,formRef:O,editSchema:nt,editInitialData:Ke,handleUpdate:Zi,handleFormStateChange:di,dossierSchema:Ge,viewData:Ue,featuredImageSrc:ot,renderSchemaSections:We,imageSection:St,fieldRules:Ve,viewRuleContext:ae})}),M==="notes"&&t.jsx(P1,{entity:y,worldId:Fe,selectedCampaign:d,selectedCampaignId:f,isCampaignDm:we,isCampaignPlayer:st,canCreateNote:lt,notes:V.items,loading:V.loading,error:V.error,onReload:gt,onCreateNote:jt,onNoteUpdate:Mt,onNoteDelete:tt,creating:B,campaignMatchesEntityWorld:dt}),M==="relationships"&&t.jsx(j4,{entity:y,toast:U,onExplore:io,canEdit:ft,relationshipsLoading:Ce,relationshipsError:he,sortedRelationships:dn,filteredRelationships:yn,relationshipsEmptyMessage:na,relationshipFilters:De,relationshipFilterOptions:Un,filterButtonDisabled:Xi,handleRelationshipFiltersChange:ja,handleRelationshipFiltersReset:ha,showRelationshipForm:z,setShowRelationshipForm:G,worldId:nn,loadRelationships:zt}),M==="secrets"&&Zt&&t.jsx(A4,{entity:y,secrets:Rt,worldId:nn,canManageSecrets:Ft,onSecretCreated:Be,onSecretUpdated:Be}),M==="access"&&T&&ft&&t.jsx(E4,{canEdit:ft,worldId:nn,accessSettings:ct,accessOptions:Nt,accessOptionsError:Ye,accessOptionsLoading:Je,accessSaving:Et,accessSaveError:te,accessSaveSuccess:ve,handleAccessSettingChange:rt}),M==="system"&&t.jsx(_4,{renderSchemaSections:We,systemSchema:vt,viewData:Ue})]})})]})}),t.jsx(_1,{open:H,destinationLabel:Y?.label||"",saving:le,onSaveAndContinue:ui,onContinueWithoutSaving:oo,onStay:ye})]})}function Y3({initialData:e={},onSubmit:n,onCancel:s,submitting:i=!1,errorMessage:l,worlds:o=[]}){const[d,f]=u.useState({name:"",description:"",worldId:""}),[p,h]=u.useState("");u.useEffect(()=>{const v=e?.world_id||e?.worldId||e?.world?.id||"";f({name:e?.name||"",description:e?.description||"",worldId:v?String(v):""}),h("")},[e]);const y=u.useMemo(()=>d.name!==(e?.name||"")||d.description!==(e?.description||"")||d.worldId!==(e?.world_id||e?.worldId||e?.world?.id||""),[e,d.description,d.name,d.worldId]);u.useEffect(()=>{h(l||"")},[l]);const g=v=>S=>{const{value:N}=S.target;f(j=>({...j,[v]:N}))},b=async v=>{v.preventDefault();const S=d.name.trim();if(!S){h("Name is required.");return}const N=d.worldId.trim();if(!N){h("Select a world for this entity type.");return}h("");const j={name:S,description:d.description?.trim()||"",world_id:N};try{if(await n?.(j)===!1)return}catch(E){h(E.message||"Failed to save entity type")}};return t.jsxs("form",{className:"entity-type-form",onSubmit:b,children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"entity-type-name",children:"Name *"}),t.jsx("input",{id:"entity-type-name",type:"text",value:d.name,onChange:g("name"),placeholder:"e.g. Faction",disabled:i,autoFocus:!0})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"entity-type-world",children:"World *"}),t.jsxs("select",{id:"entity-type-world",value:d.worldId,onChange:g("worldId"),disabled:i,required:!0,children:[t.jsx("option",{value:"",children:"Select world..."}),o.map(v=>t.jsx("option",{value:v.id,children:v.name},v.id))]})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"entity-type-description",children:"Description"}),t.jsx("textarea",{id:"entity-type-description",value:d.description,onChange:g("description"),placeholder:"Optional description for this entity type",rows:5,disabled:i,className:"textarea-field"})]}),p&&t.jsx("div",{className:"form-error",role:"alert",children:p}),t.jsxs("div",{className:"form-actions",children:[t.jsx("button",{type:"button",className:"btn cancel",onClick:s,disabled:i,children:"Cancel"}),t.jsx("button",{type:"submit",className:"btn submit",disabled:i||!y,children:i?"Saving...":"Save"})]})]})}const G3=new Set(["system_admin"]);function W3(){const e=_n(),{user:n,token:s,sessionReady:i}=un(),{selectedCampaign:l,activeWorld:o,activeWorldId:d,contextKey:f}=wn(),[p,h]=u.useState([]),[y,g]=u.useState(!1),[b,v]=u.useState(""),[S,N]=u.useState(!1),[j,E]=u.useState(null),[A,M]=u.useState(!1),[_,T]=u.useState(""),[k,C]=u.useState(""),[L,z]=u.useState(null),G=d||l?.world?.id||"",U=u.useRef(`${G}:${f}`),X=!!G,V=u.useMemo(()=>G?[{id:G,name:o?.name||l?.world?.name||"Untitled world"}]:[],[G,o?.name,l?.world?.name]),R=u.useMemo(()=>{const Q=l?.world||o;return Q&&(Q.created_by||Q.creator?.id||Q.owner_id||Q.owner?.id)||""},[l,o]),B=!!(n?.id&&R===n.id),D=u.useMemo(()=>n?n.role&&G3.has(n.role)?!0:B:!1,[n,B]),O=u.useMemo(()=>{if(l){const Q=l.name||"Selected campaign",he=l.world?.name||o?.name;return he?`${Q}  ${he}`:Q}return o?o.name||"Selected world":""},[l,o]),$=u.useCallback((Q,he="info")=>{z({message:Q,tone:he})},[]);u.useEffect(()=>{if(!L)return;const Q=setTimeout(()=>z(null),3500);return()=>clearTimeout(Q)},[L]);const F=u.useCallback(async()=>{if(!s||!G)return g(!1),h([]),[];g(!0),v("");try{const Q=await wr({worldId:G}),he=Array.isArray(Q)?Q:Array.isArray(Q?.data)?Q.data:[];return h(he),he}catch(Q){return console.error(" Failed to load entity types",Q),v(Q.message||"Failed to load entity types"),h([]),[]}finally{g(!1)}},[s,G]);u.useEffect(()=>{if(!(!i||!s)){if(!G){h([]),v(""),g(!1);return}F()}},[i,s,G,F,f]),u.useEffect(()=>{const Q=`${G}:${f}`;U.current!==Q&&(N(!1),E(null),C(""),z(null),h([]),v(""),M(!1),T(""),U.current=Q)},[G,f]);const H=()=>{!D||!X||e("/entity-types/new")},I=Q=>{D&&(E(Q),C(""),N(!0))},Y=Q=>{Q?.id&&e(`/entity-types/${Q.id}/fields`)},P=()=>{N(!1),E(null),C("")},W=async Q=>{if(!j?.id)return C("No entity type selected for editing."),!1;try{M(!0),C(""),await EI(j.id,Q),$("Entity type updated","success"),P(),await F()}catch(he){console.error(" Failed to save entity type",he);const re=he.message||"Failed to save entity type";return C(re),$(re,"error"),!1}finally{M(!1)}return!0},le=async Q=>{if(!(!D||!Q?.id||!window.confirm(`Delete entity type "${Q.name}"? This action cannot be undone.`)))try{T(Q.id),await _I(Q.id),$("Entity type deleted","success"),j?.id===Q.id&&P(),await F()}catch(re){console.error(" Failed to delete entity type",re),$(re.message||"Failed to delete entity type","error")}finally{T("")}},K=Q=>{if(!Q)return"";const he=new Date(Q);return Number.isNaN(he.getTime())?"":he.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})},de=p.length;return i?s?t.jsxs("section",{className:"entity-types-page",children:[t.jsxs("div",{className:"entity-types-header",children:[t.jsxs("div",{children:[t.jsx("h1",{children:"Entity Types"}),l?t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"entity-types-subtitle",children:O}),t.jsxs("p",{className:"entity-types-subtitle",children:[de," types defined"]})]}):t.jsx("p",{className:"entity-types-subtitle",children:"Select a campaign or world you own to choose a world context."})]}),t.jsxs("button",{type:"button",className:"btn submit",onClick:H,disabled:!D||A||_||!X,children:[t.jsx(Wn,{size:18})," Add Entity Type"]})]}),!D&&t.jsx("div",{className:"alert info",role:"status",children:"You can view the existing entity types, but only system administrators or the world owner can make changes."}),L&&t.jsx("div",{className:`toast-banner ${L.tone}`,role:"status",children:L.message}),b&&t.jsx("div",{className:"alert error",role:"alert",children:b}),t.jsx("div",{className:"entity-types-table-wrapper",children:X?y?t.jsx("div",{className:"empty-state",children:"Loading entity types..."}):p.length===0?t.jsx("div",{className:"empty-state",children:"No entity types defined yet."}):t.jsxs("table",{className:"entity-types-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Name"}),t.jsx("th",{children:"Description"}),t.jsx("th",{children:"World"}),t.jsx("th",{children:"Created"}),t.jsx("th",{className:"actions-column",children:"Actions"})]})}),t.jsx("tbody",{children:p.map(Q=>{const he=Q.createdAt||Q.created_at,re=Q?.world?.name||Q?.world_name||Q?.worldName||"";return t.jsxs("tr",{children:[t.jsx("td",{children:Q.name}),t.jsx("td",{className:"description-cell",children:Q.description?Q.description:""}),t.jsx("td",{children:re}),t.jsx("td",{children:K(he)}),t.jsx("td",{className:"actions-column",children:t.jsxs("div",{className:"entity-type-actions",children:[t.jsx("button",{type:"button",className:"icon-btn",title:"Manage fields",onClick:()=>Y(Q),children:t.jsx(Qd,{size:16})}),D&&t.jsxs(t.Fragment,{children:[t.jsx("button",{type:"button",className:"icon-btn",title:"Edit entity type",onClick:()=>I(Q),disabled:A||_===Q.id,children:t.jsx(Ga,{size:16})}),t.jsx("button",{type:"button",className:"icon-btn danger",title:"Delete entity type",onClick:()=>le(Q),disabled:_===Q.id||A,children:t.jsx(zn,{size:16})})]})]})})]},Q.id)})})]}):t.jsx("div",{className:"empty-state",children:"Select a campaign or world you own to view entity types."})}),t.jsx("div",{className:"entity-type-cards",children:X?y?t.jsx("div",{className:"card-placeholder",children:"Loading entity types..."}):p.length===0?t.jsx("div",{className:"card-placeholder",children:"No entity types defined yet."}):p.map(Q=>{const he=Q.createdAt||Q.created_at;return t.jsxs("div",{className:"entity-type-card",children:[t.jsxs("div",{className:"card-header",children:[t.jsx("h3",{children:Q.name}),t.jsxs("div",{className:"entity-type-actions",children:[t.jsx("button",{type:"button",className:"icon-btn",title:"Manage fields",onClick:()=>Y(Q),children:t.jsx(Qd,{size:16})}),D&&t.jsxs(t.Fragment,{children:[t.jsx("button",{type:"button",className:"icon-btn",title:"Edit entity type",onClick:()=>I(Q),disabled:A||_===Q.id,children:t.jsx(Ga,{size:16})}),t.jsx("button",{type:"button",className:"icon-btn danger",title:"Delete entity type",onClick:()=>le(Q),disabled:_===Q.id||A,children:t.jsx(zn,{size:16})})]})]})]}),t.jsx("p",{className:"card-description",children:Q.description?Q.description:"No description"}),t.jsxs("p",{className:"card-meta",children:["World: ",Q?.world?.name||Q?.world_name||""]}),t.jsxs("p",{className:"card-meta",children:["Created ",K(he)]})]},`card-${Q.id}`)}):t.jsx("div",{className:"card-placeholder",children:"Select a campaign or world you own to view entity types."})}),S&&t.jsx("div",{className:"side-panel-overlay",role:"dialog","aria-modal":"true",children:t.jsxs("div",{className:"side-panel",children:[t.jsxs("div",{className:"side-panel-header",children:[t.jsx("h2",{children:j?"Edit Entity Type":"Add Entity Type"}),t.jsx("button",{type:"button",className:"icon-btn",onClick:P,title:"Close form",disabled:A,children:t.jsx(Bn,{size:18})})]}),t.jsx("div",{className:"side-panel-content",children:t.jsx(Y3,{initialData:j,onSubmit:W,onCancel:P,submitting:A,errorMessage:k,worlds:V})})]})})]}):t.jsx("p",{children:"Authenticating..."}):t.jsx("p",{children:"Restoring session..."})}const X3=[{value:"text",label:"Text"},{value:"number",label:"Number"},{value:"boolean",label:"Boolean"},{value:"date",label:"Date"},{value:"enum",label:"Enum"},{value:"entity_reference",label:"Entity Reference"},{value:"location_reference",label:"Location Reference"}];function K3({initialData:e={},entityReferenceTypes:n=[],locationReferenceTypes:s=[],onSubmit:i,onCancel:l,submitting:o=!1,errorMessage:d}){const[f,p]=u.useState({name:"",label:"",data_type:"text",required:!1,visibleByDefault:!0,enumChoices:"",reference_type_id:"",reference_filter:""}),[h,y]=u.useState("");u.useEffect(()=>{if(!e){p({name:"",label:"",data_type:"text",required:!1,visibleByDefault:!0,enumChoices:"",reference_type_id:"",reference_filter:""}),y("");return}const M=Array.isArray(e.options?.choices)?e.options.choices.join(", "):typeof e.options=="string"?e.options:"",_=e.reference_filter?typeof e.reference_filter=="string"?e.reference_filter:JSON.stringify(e.reference_filter,null,2):"";let T=e.data_type||"text";T==="reference"&&(T="entity_reference"),p({name:e.name||"",label:e.label||"",data_type:T,required:!!e.required,visibleByDefault:e.visibleByDefault!==void 0?!!e.visibleByDefault:e.visible_by_default!==void 0?!!e.visible_by_default:!0,enumChoices:M,reference_type_id:e.reference_type_id||"",reference_filter:_}),y("")},[e]),u.useEffect(()=>{y(d||"")},[d]);const g=f.data_type==="enum",b=f.data_type==="entity_reference",v=f.data_type==="location_reference",S=b||v,N=u.useMemo(()=>n.map(M=>({value:M.id,label:M.name})),[n]),j=u.useMemo(()=>s.map(M=>({value:M.id,label:M.name})),[s]),E=M=>_=>{const{value:T,type:k,checked:C}=_.target;p(L=>({...L,[M]:k==="checkbox"?C:T}))},A=async M=>{M.preventDefault();const _=f.name.trim(),T=f.label.trim();if(!_){y("Field name is required.");return}if(!T){y("Field label is required.");return}if(!f.data_type){y("Data type is required.");return}let k={};if(S){if(b&&!f.reference_type_id){y("Reference type is required for entity reference fields.");return}const L=f.reference_filter.trim();if(L)try{if(k=JSON.parse(L),typeof k!="object"||Array.isArray(k))throw new Error("Reference filter must be a JSON object.")}catch(z){y(z.message||"Reference filter must be valid JSON.");return}}const C={name:_,label:T,data_type:f.data_type,required:!!f.required,visible_by_default:!!f.visibleByDefault};if(g){const L=f.enumChoices.split(",").map(z=>z.trim()).filter(Boolean);if(!L.length){y("Enum options are required for enum fields.");return}C.options={choices:L}}else C.options={};S?(C.reference_type_id=f.reference_type_id||null,C.reference_filter=k):(C.reference_type_id=null,C.reference_filter={});try{if(await i?.(C)===!1)return;y("")}catch(L){y(L.message||"Failed to save field")}};return t.jsxs("form",{className:"entity-type-field-form",onSubmit:A,children:[t.jsxs("div",{className:"form-grid",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"entity-field-name",children:"Field Name *"}),t.jsx("input",{id:"entity-field-name",type:"text",value:f.name,onChange:E("name"),placeholder:"e.g. alignment",disabled:o})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"entity-field-label",children:"Label *"}),t.jsx("input",{id:"entity-field-label",type:"text",value:f.label,onChange:E("label"),placeholder:"e.g. Alignment",disabled:o})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"entity-field-data-type",children:"Data Type *"}),t.jsx("select",{id:"entity-field-data-type",value:f.data_type,onChange:E("data_type"),disabled:o,children:X3.map(M=>t.jsx("option",{value:M.value,children:M.label},M.value))}),t.jsx("p",{className:"field-hint",children:"Determines how the value is stored and rendered in entity forms."})]}),t.jsxs("div",{className:"form-group checkbox-group",children:[t.jsxs("div",{className:"checkbox-control",children:[t.jsx("input",{id:"entity-field-required",type:"checkbox",checked:f.required,onChange:E("required"),disabled:o}),t.jsx("label",{htmlFor:"entity-field-required",children:"Required"})]}),t.jsx("span",{className:"field-hint",children:"Mark as required on entity forms."})]}),t.jsxs("div",{className:"form-group checkbox-group",children:[t.jsxs("div",{className:"checkbox-control",children:[t.jsx("input",{id:"entity-field-visible-default",type:"checkbox",checked:f.visibleByDefault,onChange:E("visibleByDefault"),disabled:o}),t.jsx("label",{htmlFor:"entity-field-visible-default",children:"Visible by default"})]}),t.jsx("span",{className:"field-hint",children:"Uncheck to hide this field unless a rule explicitly shows it."})]}),g&&t.jsxs("div",{className:"form-group form-group-full",children:[t.jsx("label",{htmlFor:"entity-field-options",children:"Enum Options *"}),t.jsx("textarea",{id:"entity-field-options",value:f.enumChoices,onChange:E("enumChoices"),placeholder:"Comma separated values, e.g. Lawful Good, Neutral, Chaotic Evil",rows:3,disabled:o}),t.jsx("p",{className:"field-hint",children:"Comma-separated list of allowed values."})]}),S&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"form-group form-group-full",children:[t.jsxs("label",{htmlFor:"entity-field-reference-type",children:[b?"Entity":"Location"," Reference Type",b?" *":""]}),t.jsxs("select",{id:"entity-field-reference-type",value:f.reference_type_id,onChange:E("reference_type_id"),disabled:o,children:[t.jsx("option",{value:"",children:b?"Select entity type":"All locations (no type restriction)"}),(b?N:j).map(M=>t.jsx("option",{value:M.value,children:M.label},M.value))]}),t.jsx("p",{className:"field-hint",children:b?"Choose which entity type this field should reference.":"Choose a specific location type to restrict selection, or leave blank to allow any location."})]}),t.jsxs("div",{className:"form-group form-group-full",children:[t.jsx("label",{htmlFor:"entity-field-reference-filter",children:"Reference Filter"}),t.jsx("textarea",{id:"entity-field-reference-filter",value:f.reference_filter,onChange:E("reference_filter"),placeholder:'Optional JSON filter, e.g. {"metadata.subtype": "Town"}',rows:4,disabled:o}),t.jsxs("p",{className:"field-hint",children:["Limit selectable ",b?"entities":"locations"," by filter criteria."]})]})]})]}),h&&t.jsx("div",{className:"form-error",role:"alert",children:h}),t.jsxs("div",{className:"form-actions",children:[t.jsx("button",{type:"button",className:"btn cancel",onClick:l,disabled:o,children:"Cancel"}),t.jsx("button",{type:"submit",className:"btn submit",disabled:o,children:o?"Saving...":"Save Field"})]})]})}const Z3=[{value:"equals",label:"Equals"},{value:"not_equals",label:"Does not equal"},{value:"contains",label:"Contains"},{value:"not_contains",label:"Does not contain"},{value:"in",label:"Is one of"},{value:"not_in",label:"Is not one of"},{value:"gt",label:"Greater than"},{value:"gte",label:"Greater than or equal"},{value:"lt",label:"Less than"},{value:"lte",label:"Less than or equal"},{value:"is_set",label:"Has a value"},{value:"is_not_set",label:"Is empty"}],Q3=[{value:"show",label:"Show field"},{value:"hide",label:"Hide field"}],J3=[{value:"all",label:"All conditions must match"},{value:"any",label:"Any condition can match"},{value:"none",label:"None of the conditions can match"}],e5=new Set(["is_set","is_not_set"]),Ry=()=>({field:"",operator:"equals",valuesText:""}),Iy=()=>({target:"",action:"show"}),t5=(e=[])=>Array.isArray(e)?e.map((n,s)=>{if(n==null)return null;if(typeof n=="object"){const l=n.value??n.id??n.key??n.slug??`choice-${s}`;if(l==null)return null;const o=n.label??n.name??n.title??n.display??l;return{value:String(l),label:String(o??l)}}const i=String(n);return{value:i,label:i}}).filter(Boolean):[],n5=(e=[])=>!Array.isArray(e)||!e.length?[Ry()]:e.map(n=>({field:n.field||n.fieldKey||"",operator:n.operator||"equals",valuesText:Array.isArray(n.values)?n.values.join(", "):""})),a5=(e=[])=>!Array.isArray(e)||!e.length?[Iy()]:e.map(n=>({target:n.target||n.field||"",action:n.action||"show"})),$p=e=>e.split(",").map(n=>n.trim()).filter(n=>n.length>0);function s5({fields:e=[],initialData:n=null,onSubmit:s,onCancel:i,submitting:l=!1,errorMessage:o=""}){const[d,f]=u.useState(""),[p,h]=u.useState("all"),[y,g]=u.useState([Ry()]),[b,v]=u.useState([Iy()]),[S,N]=u.useState("");u.useEffect(()=>{f(n?.name||""),h(n?.match_mode||n?.matchMode||"all"),g(n5(n?.conditions)),v(a5(n?.actions))},[n]),u.useEffect(()=>{N(o||"")},[o]);const j=u.useMemo(()=>e.map(U=>({value:U.id||U.name,label:U.label||U.name})),[e]),E=u.useMemo(()=>{const U=new Map;return e.forEach(X=>{if(!X)return;const V=R=>{if(R==null)return;const B=String(R);B&&(U.set(B,X),U.set(B.toLowerCase(),X))};V(X.id),V(X.field_id),V(X.fieldId),V(X.name),V(X.key)}),U},[e]),A=u.useCallback(U=>{if(U==null)return null;const X=String(U);return E.get(X)||E.get(X.toLowerCase())||null},[E]),M=(U,X,V)=>{g(R=>{const B=R.slice();return B[U]={...B[U],[X]:V},B})},_=(U,X,V)=>{v(R=>{const B=R.slice();return B[U]={...B[U],[X]:V},B})},T=()=>g(U=>[...U,Ry()]),k=U=>g(X=>X.length===1?X:X.filter((V,R)=>R!==U)),C=()=>v(U=>[...U,Iy()]),L=U=>v(X=>X.length===1?X:X.filter((V,R)=>R!==U)),z=u.useCallback((U,X)=>{g(V=>{if(!Array.isArray(V)||U<0||U>=V.length)return V;const R=V.slice(),B=R[U];if(!B)return V;const D=$p(B.valuesText||""),O=String(X);let $;return D.includes(O)?$=D.filter(F=>F!==O):$=[...D,O],R[U]={...B,valuesText:$.join(", ")},R})},[]),G=async U=>{if(U.preventDefault(),!y.length){N("Add at least one condition.");return}if(!b.length){N("Add at least one action.");return}const X=y.map(B=>({field:B.field,operator:B.operator,values:$p(B.valuesText||"")})).filter(B=>B.field&&B.operator);if(!X.length){N("Each condition needs a field and operator.");return}const V=b.map(B=>({target:B.target,action:B.action})).filter(B=>B.target&&B.action);if(!V.length){N("Each action needs a target and action type.");return}const R={name:d.trim(),match_mode:p,conditions:X,actions:V};try{if(await s?.(R)===!1)return;N("")}catch(B){N(B.message||"Failed to save rule")}};return t.jsxs("form",{className:"field-rule-form",onSubmit:G,children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"field-rule-name",children:"Rule Name"}),t.jsx("input",{id:"field-rule-name",type:"text",value:d,onChange:U=>f(U.target.value),placeholder:"e.g. Show hometown when origin is set",disabled:l})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"field-rule-match-mode",children:"When should this rule run?"}),t.jsx("select",{id:"field-rule-match-mode",value:p,onChange:U=>h(U.target.value),disabled:l,children:J3.map(U=>t.jsx("option",{value:U.value,children:U.label},U.value))})]}),t.jsxs("div",{className:"field-rule-editor-section",children:[t.jsxs("div",{className:"field-rule-editor-heading",children:[t.jsx("h3",{children:"Conditions"}),t.jsx("button",{type:"button",className:"btn ghost",onClick:T,disabled:l,children:"Add condition"})]}),t.jsx("p",{className:"field-hint",children:"Fields to watch before applying the actions."}),t.jsx("div",{className:"field-rule-list",role:"list",children:y.map((U,X)=>t.jsxs("div",{className:"field-rule-row",role:"listitem",children:[t.jsxs("select",{value:U.field,onChange:V=>M(X,"field",V.target.value),disabled:l,children:[t.jsx("option",{value:"",children:"Choose field"}),j.map(V=>t.jsx("option",{value:V.value,children:V.label},V.value))]}),t.jsx("select",{value:U.operator,onChange:V=>M(X,"operator",V.target.value),disabled:l,children:Z3.map(V=>t.jsx("option",{value:V.value,children:V.label},V.value))}),(()=>{const V=A(U.field),B=(V?.data_type||V?.dataType)==="enum"?t5(V?.options?.choices):[],D=e5.has(U.operator);if(!D&&B.length>0){const $=new Set($p(U.valuesText||""));return t.jsx("div",{className:"field-rule-enum-values",role:"group","aria-label":"Enum choices",children:B.map(F=>t.jsxs("label",{className:"field-rule-enum-option",children:[t.jsx("input",{type:"checkbox",checked:$.has(F.value),onChange:()=>z(X,F.value),disabled:l}),t.jsx("span",{children:F.label})]},`${F.value}-${X}`))})}return t.jsx("input",{type:"text",value:U.valuesText,onChange:$=>M(X,"valuesText",$.target.value),placeholder:"Comma separated values",disabled:l||D})})(),t.jsx("button",{type:"button",className:"icon-btn",onClick:()=>k(X),disabled:y.length===1||l,title:"Remove condition",children:""})]},`condition-${X}`))})]}),t.jsxs("div",{className:"field-rule-editor-section",children:[t.jsxs("div",{className:"field-rule-editor-heading",children:[t.jsx("h3",{children:"Actions"}),t.jsx("button",{type:"button",className:"btn ghost",onClick:C,disabled:l,children:"Add action"})]}),t.jsx("p",{className:"field-hint",children:"Choose what should happen when the conditions above match."}),t.jsx("div",{className:"field-rule-list",role:"list",children:b.map((U,X)=>t.jsxs("div",{className:"field-rule-row",role:"listitem",children:[t.jsxs("select",{value:U.target,onChange:V=>_(X,"target",V.target.value),disabled:l,children:[t.jsx("option",{value:"",children:"Choose field"}),j.map(V=>t.jsx("option",{value:V.value,children:V.label},V.value))]}),t.jsx("select",{value:U.action,onChange:V=>_(X,"action",V.target.value),disabled:l,children:Q3.map(V=>t.jsx("option",{value:V.value,children:V.label},V.value))}),t.jsx("button",{type:"button",className:"icon-btn",onClick:()=>L(X),disabled:b.length===1||l,title:"Remove action",children:""})]},`action-${X}`))})]}),S&&t.jsx("div",{className:"form-error",role:"alert",children:S}),t.jsxs("div",{className:"form-actions",children:[t.jsx("button",{type:"button",className:"btn cancel",onClick:i,disabled:l,children:"Cancel"}),t.jsx("button",{type:"submit",className:"btn submit",disabled:l,children:l?"Saving":"Save Rule"})]})]})}const r5=new Set(["system_admin"]),Fp={text:"Text",number:"Number",boolean:"Boolean",date:"Date",enum:"Enum",entity_reference:"Entity Reference",location_reference:"Location Reference"},i5={equals:"equals",not_equals:"does not equal",contains:"contains",not_contains:"does not contain",in:"is one of",not_in:"is not one of",gt:"is greater than",gte:"is greater than or equal to",lt:"is less than",lte:"is less than or equal to",is_set:"is set",is_not_set:"is empty"},l5={show:"Show",hide:"Hide"},pw={all:"All conditions must match",any:"Any condition can match",none:"No conditions can match"};function o5(){const{id:e}=Ka(),n=_n(),{user:s,token:i,sessionReady:l}=un(),[o,d]=u.useState(null),[f,p]=u.useState([]),[h,y]=u.useState([]),[g,b]=u.useState([]),[v,S]=u.useState(!1),[N,j]=u.useState(!1),[E,A]=u.useState(""),[M,_]=u.useState(""),[T,k]=u.useState(!1),[C,L]=u.useState(null),[z,G]=u.useState(!1),[U,X]=u.useState(""),[V,R]=u.useState(""),[B,D]=u.useState(null),[O,$]=u.useState([]),[F,H]=u.useState([]),[I,Y]=u.useState([]),[P,W]=u.useState(!1),[le,K]=u.useState(!1),[de,Q]=u.useState(""),[he,re]=u.useState(!1),[Ce,Re]=u.useState(!1),[ue,se]=u.useState(""),[Le,be]=u.useState(!1),[De,Me]=u.useState(null),[mt,ht]=u.useState(!1),[Ct,At]=u.useState(""),[we,st]=u.useState(""),[lt,Fe]=u.useState(""),Xe=o?.name||"Entity Type",dt=u.useMemo(()=>!o||!s?!1:r5.has(s.role)||o.world_owner_id&&o.world_owner_id===s.id||o.created_by&&o.created_by===s.id?!0:Array.isArray(o.managers)?o.managers.some(J=>J===s.id):!1,[o,s]),ie=J=>{if(!J)return"";const{options:Z}=J;return Z?Array.isArray(Z.choices)&&Z.choices.length>0?Z.choices.join(", "):typeof Z=="string"&&Z.trim()?Z:"":""},ee=u.useCallback((J,Z="info")=>{D({message:J,tone:Z})},[]);u.useEffect(()=>{if(!B)return;const J=setTimeout(()=>D(null),3500);return()=>clearTimeout(J)},[B]);const ce=J=>J?Array.isArray(J)?J:J?.data?J.data:J:null,fe=u.useCallback(async()=>{if(e){S(!0),A("");try{const J=await jI(e),Z=ce(J);d(Z)}catch(J){console.error(" Failed to load entity type details",J),A(J.message||"Failed to load entity type")}finally{S(!1)}}},[e]),qe=u.useCallback(async J=>{const Z=typeof J=="string"?J.trim():J||"";if(!Z){p([]),y([]);return}try{const[je,Ne]=await Promise.all([wr({worldId:Z}).catch(ae=>(console.error(" Failed to load entity types",ae),null)),Nr({worldId:Z}).catch(ae=>(console.error(" Failed to load location types",ae),null))]),pe=je?ce(je):[],Ue=Ne?ce(Ne):[];p(Array.isArray(pe)?pe:[]),y(Array.isArray(Ue)?Ue:[])}catch(je){console.error(" Failed to load reference types",je),p([]),y([])}},[]),Pe=u.useCallback(async()=>{if(e){j(!0),_("");try{const J=await x1(e),Z=ce(J);b(Array.isArray(Z)?Z:[])}catch(J){console.error(" Failed to load fields",J),_(J.message||"Failed to load fields"),b([])}finally{j(!1)}}},[e]),Be=u.useCallback(async()=>{if(e){re(!0),Re(!0),Q(""),se("");try{const[J,Z]=await Promise.all([If(e).catch(je=>(console.error(" Failed to load field order",je),Q(je.message||"Failed to load field order"),null)),Lf(e).catch(je=>(console.error(" Failed to load field rules",je),se(je.message||"Failed to load conditional rules"),null))]);$(ii(J)),H(ii(Z))}catch(J){Q(J.message||"Failed to load field order"),se(J.message||"Failed to load conditional rules"),$([]),H([])}finally{re(!1),Re(!1)}}},[e]);u.useEffect(()=>{!l||!i||(fe(),Pe(),Be())},[l,i,fe,Pe,Be]),u.useEffect(()=>{if(!o){p([]),y([]);return}const J=o?.world_id||o?.worldId||o?.world?.id||"";qe(J)},[o,o?.world_id,o?.worldId,o?.world?.id,qe]),u.useEffect(()=>{l&&(i||n("/login"))},[l,i,n]);const Te=u.useCallback(()=>!Array.isArray(g)||g.length===0?[]:_g(g,O).map((Z,je)=>({id:Z.id,name:Z.name,label:Z.label||Z.name,data_type:Z.data_type,required:Z.required,order:je})),[g,O]);u.useEffect(()=>{P||Y(Te())},[Te,P]);const gt=u.useCallback(()=>{W(!1),Y(Te())},[Te]),jt=u.useMemo(()=>{const J=new Map;return g.forEach(Z=>{if(!Z)return;const je=Z.label||Z.name||"Field";Z.id&&(J.set(Z.id,je),J.set(String(Z.id).toLowerCase(),je)),Z.name&&(J.set(Z.name,je),J.set(Z.name.toLowerCase(),je))}),J},[g]),Mt=u.useCallback(J=>{if(!J)return"";const Z=jt.get(J.field)||J.field,je=i5[J.operator]||J.operator,Ne=Array.isArray(J.values)?J.values.filter(Boolean):[];return!Ne.length||["is_set","is_not_set"].includes(J.operator)?`${Z} ${je}`:`${Z} ${je} ${Ne.join(", ")}`},[jt]),tt=u.useCallback(J=>{if(!J)return"";const Z=jt.get(J.target)||J.target;return`${l5[J.action]||J.action} ${Z}`},[jt]),ft=()=>{dt&&(L(null),R(""),k(!0))},Rt=J=>{dt&&(L(J),R(""),k(!0))},Ft=()=>{k(!1),L(null),R("")},Zt=async J=>{if(!dt)return!1;try{G(!0),R(""),C?.id?(await MD(C.id,J),ee("Field updated","success")):(await TD(e,J),ee("Field created","success")),Ft(),await Pe(),await Be()}catch(Z){console.error(" Failed to save field",Z);const je=Z.message||"Failed to save field";return R(je),ee(je,"error"),!1}finally{G(!1)}return!0},Tt=async J=>{if(!(!dt||!J?.id||!window.confirm(`Delete field "${J.label||J.name}"? This action cannot be undone.`)))try{X(J.id),await kD(J.id),ee("Field deleted","success"),await Pe(),await Be()}catch(je){console.error(" Failed to delete field",je),ee(je.message||"Failed to delete field","error")}finally{X("")}},We=(J,Z)=>{Y(je=>{const Ne=J+Z;if(Ne<0||Ne>=je.length)return je;const pe=je.slice(),[Ue]=pe.splice(J,1);return pe.splice(Ne,0,Ue),pe.map((ae,Ke)=>({...ae,order:Ke}))}),W(!0)},it=async()=>{if(!(!dt||!P)){K(!0);try{const J=I.map((Z,je)=>({field_id:Z.id,section_order:0,column_order:0,field_order:je,priority:je}));await CI(e,{entries:J}),ee("Field order updated","success"),W(!1),await Be()}catch(J){const Z=J.message||"Failed to update field order";Q(Z),ee(Z,"error")}finally{K(!1)}}},bt=(J=null)=>{dt&&(Me(J),At(""),be(!0))},oe=()=>{be(!1),Me(null),At("")},Ee=async J=>{if(!dt)return!1;try{ht(!0),At(""),De?.id?(await cp(De.id,J),ee("Rule updated","success")):(await AI(e,J),ee("Rule created","success")),oe(),await Be()}catch(Z){const je=Z.message||"Failed to save rule";return At(je),ee(je,"error"),!1}finally{ht(!1)}return!0},Se=async J=>{if(!(!dt||!J?.id||!window.confirm(`Delete the rule "${J.name||"Untitled rule"}"?`)))try{st(J.id),await TI(J.id),ee("Rule deleted","success"),await Be()}catch(je){ee(je.message||"Failed to delete rule","error")}finally{st("")}},Ve=async(J,Z)=>{if(!dt||!J?.id)return;const je=F.findIndex(Ue=>Ue.id===J.id),Ne=je+Z;if(je===-1||Ne<0||Ne>=F.length)return;const pe=F[Ne];try{Fe(J.id),await Promise.all([cp(J.id,{priority:Ne}),cp(pe.id,{priority:je})]),ee("Rule order updated","success"),await Be()}catch(Ue){ee(Ue.message||"Failed to reorder rule","error")}finally{Fe("")}},xe=J=>{if(!J)return"";const Z=new Date(J);return Number.isNaN(Z.getTime())?"":Z.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})},$e=u.useMemo(()=>{const J=new Map;return f.forEach(Z=>{Z?.id&&J.set(Z.id,Z.name)}),h.forEach(Z=>{Z?.id&&J.set(Z.id,Z.name)}),J},[f,h]),He=E||M;return l?i?t.jsxs("section",{className:"entity-type-fields-page",children:[t.jsxs("div",{className:"entity-type-fields-header",children:[t.jsxs("div",{className:"entity-type-fields-heading",children:[t.jsxs("button",{type:"button",className:"link-button",onClick:()=>n("/entity-types"),children:[t.jsx(Tc,{size:16})," Back to Entity Types"]}),t.jsxs("h1",{children:["Fields for ",Xe]}),o?.world_name&&t.jsxs("p",{className:"entity-type-fields-subtitle",children:["World: ",o.world_name]})]}),dt&&t.jsxs("button",{type:"button",className:"btn submit",onClick:ft,disabled:z||U,children:[t.jsx(Wn,{size:18})," Add Field"]})]}),!dt&&t.jsx("div",{className:"alert info",role:"status",children:"You can view these fields, but only the world owner or system administrators can make changes."}),B&&t.jsx("div",{className:`toast-banner ${B.tone}`,role:"status",children:B.message}),He&&t.jsx("div",{className:"alert error",role:"alert",children:He}),t.jsx("div",{className:"entity-types-table-wrapper",children:v||N?t.jsx("div",{className:"empty-state",children:"Loading fields..."}):g.length===0?t.jsx("div",{className:"empty-state",children:"No custom fields defined yet."}):t.jsxs("table",{className:"entity-types-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Field Name"}),t.jsx("th",{children:"Label"}),t.jsx("th",{children:"Data Type"}),t.jsx("th",{children:"Reference Type"}),t.jsx("th",{children:"Required"}),t.jsx("th",{children:"Created"}),dt&&t.jsx("th",{className:"actions-column",children:"Actions"})]})}),t.jsx("tbody",{children:g.map(J=>{const Z=J.createdAt||J.created_at,je=J.reference_type_name||$e.get(J.reference_type_id),Ne=Fp[J.data_type]||J.data_type;return t.jsxs("tr",{children:[t.jsx("td",{children:J.name}),t.jsx("td",{children:J.label||""}),t.jsx("td",{children:Ne}),t.jsx("td",{children:je||(J.data_type==="entity_reference"||J.data_type==="location_reference"?"":"N/A")}),t.jsx("td",{children:J.required?"Yes":"No"}),t.jsx("td",{children:xe(Z)}),dt&&t.jsx("td",{className:"actions-column",children:t.jsxs("div",{className:"entity-type-actions",children:[t.jsx("button",{type:"button",className:"icon-btn",title:"Edit field",onClick:()=>Rt(J),disabled:z||U===J.id,children:t.jsx(Ga,{size:16})}),t.jsx("button",{type:"button",className:"icon-btn danger",title:"Delete field",onClick:()=>Tt(J),disabled:U===J.id||z,children:t.jsx(zn,{size:16})})]})})]},J.id)})})]})}),t.jsxs("section",{className:"field-layout-card",children:[t.jsxs("div",{className:"card-header",children:[t.jsxs("h2",{children:[t.jsx(wj,{size:18})," Field order"]}),dt&&t.jsxs("div",{className:"layout-card-actions",children:[t.jsx("button",{type:"button",className:"btn ghost",onClick:gt,disabled:le||!P,children:"Reset"}),t.jsx("button",{type:"button",className:"btn submit",onClick:it,disabled:le||!P||I.length===0,children:le?"Saving":"Save order"})]})]}),t.jsx("p",{className:"card-description",children:"Use this list to control how the metadata fields appear on entity forms and detail pages."}),de&&t.jsx("div",{className:"alert error",role:"alert",children:de}),he?t.jsx("div",{className:"card-placeholder",children:"Loading layout"}):I.length===0?t.jsx("div",{className:"card-placeholder",children:"No fields available to order yet."}):t.jsx("ol",{className:"field-layout-list",children:I.map((J,Z)=>t.jsxs("li",{className:"field-layout-row",children:[t.jsxs("div",{className:"field-layout-info",children:[t.jsx("span",{className:"field-layout-index",children:Z+1}),t.jsxs("div",{className:"field-layout-details",children:[t.jsx("span",{className:"field-layout-name",children:J.label||J.name}),t.jsx("span",{className:"field-layout-meta",children:Fp[J.data_type]||J.data_type})]})]}),dt&&t.jsxs("div",{className:"layout-controls",children:[t.jsx("button",{type:"button",className:"icon-btn",onClick:()=>We(Z,-1),disabled:Z===0||le,title:"Move up",children:t.jsx(yy,{size:16})}),t.jsx("button",{type:"button",className:"icon-btn",onClick:()=>We(Z,1),disabled:Z===I.length-1||le,title:"Move down",children:t.jsx(xS,{size:16})})]})]},J.id||J.name||Z))})]}),t.jsxs("section",{className:"field-rules-card",children:[t.jsxs("div",{className:"card-header",children:[t.jsxs("h2",{children:[t.jsx(Yi,{size:18})," Conditional rules"]}),dt&&t.jsxs("button",{type:"button",className:"btn submit",onClick:()=>bt(null),disabled:mt,children:[t.jsx(Wn,{size:16})," Add rule"]})]}),t.jsx("p",{className:"card-description",children:"Automatically show or hide fields when other metadata matches specific conditions."}),ue&&t.jsx("div",{className:"alert error",role:"alert",children:ue}),Ce?t.jsx("div",{className:"card-placeholder",children:"Loading rules"}):F.length===0?t.jsx("div",{className:"card-placeholder",children:"No conditional rules have been configured."}):t.jsx("div",{className:"field-rules-list",children:F.map((J,Z)=>t.jsxs("article",{className:"field-rule-card",children:[t.jsxs("div",{className:"field-rule-content",children:[t.jsx("h3",{children:J.name||`Rule ${Z+1}`}),t.jsx("p",{className:"field-rule-match",children:pw[J.match_mode]||pw.all}),t.jsx("ul",{className:"field-rule-condition-list",children:Array.isArray(J.conditions)&&J.conditions.map((je,Ne)=>t.jsx("li",{children:Mt(je)},`condition-${J.id}-${Ne}`))}),t.jsx("div",{className:"field-rule-action-list",children:Array.isArray(J.actions)&&J.actions.map((je,Ne)=>t.jsx("span",{children:tt(je)},`action-${J.id}-${Ne}`))})]}),dt&&t.jsxs("div",{className:"field-rule-controls",children:[t.jsx("button",{type:"button",className:"icon-btn",onClick:()=>Ve(J,-1),disabled:Z===0||lt===J.id,title:"Move rule up",children:t.jsx(yy,{size:16})}),t.jsx("button",{type:"button",className:"icon-btn",onClick:()=>Ve(J,1),disabled:Z===F.length-1||lt===J.id,title:"Move rule down",children:t.jsx(xS,{size:16})}),t.jsx("button",{type:"button",className:"icon-btn",onClick:()=>bt(J),title:"Edit rule",disabled:mt||we===J.id,children:t.jsx(Ga,{size:16})}),t.jsx("button",{type:"button",className:"icon-btn danger",onClick:()=>Se(J),title:"Delete rule",disabled:we===J.id||mt,children:t.jsx(zn,{size:16})})]})]},J.id))})]}),t.jsx("div",{className:"entity-type-cards",children:v||N?t.jsx("div",{className:"card-placeholder",children:"Loading fields..."}):g.length===0?t.jsx("div",{className:"card-placeholder",children:"No custom fields defined yet."}):g.map(J=>{const Z=J.createdAt||J.created_at,je=J.reference_type_name||$e.get(J.reference_type_id),Ne=Fp[J.data_type]||J.data_type;return t.jsxs("div",{className:"entity-type-card",children:[t.jsxs("div",{className:"card-header",children:[t.jsx("h3",{children:J.label||J.name}),dt&&t.jsxs("div",{className:"entity-type-actions",children:[t.jsx("button",{type:"button",className:"icon-btn",title:"Edit field",onClick:()=>Rt(J),disabled:z||U===J.id,children:t.jsx(Ga,{size:16})}),t.jsx("button",{type:"button",className:"icon-btn danger",title:"Delete field",onClick:()=>Tt(J),disabled:U===J.id||z,children:t.jsx(zn,{size:16})})]})]}),t.jsxs("dl",{className:"field-card-metadata",children:[t.jsxs("div",{children:[t.jsx("dt",{children:"Field Name"}),t.jsx("dd",{children:J.name})]}),t.jsxs("div",{children:[t.jsx("dt",{children:"Data Type"}),t.jsx("dd",{children:Ne})]}),t.jsxs("div",{children:[t.jsx("dt",{children:"Required"}),t.jsx("dd",{children:J.required?"Yes":"No"})]}),J.data_type==="enum"&&t.jsxs("div",{children:[t.jsx("dt",{children:"Options"}),t.jsx("dd",{children:ie(J)})]}),J.data_type==="reference"&&t.jsxs("div",{children:[t.jsx("dt",{children:"Reference Type"}),t.jsx("dd",{children:je||""})]}),t.jsxs("div",{children:[t.jsx("dt",{children:"Created"}),t.jsx("dd",{children:xe(Z)})]})]})]},`field-card-${J.id}`)})}),T&&t.jsx("div",{className:"side-panel-overlay",role:"dialog","aria-modal":"true",children:t.jsxs("div",{className:"side-panel",children:[t.jsxs("div",{className:"side-panel-header",children:[t.jsx("h2",{children:C?"Edit Field":"Add Field"}),t.jsx("button",{type:"button",className:"icon-btn",onClick:Ft,title:"Close form",disabled:z,children:t.jsx(Bn,{size:18})})]}),t.jsx("div",{className:"side-panel-content",children:t.jsx(K3,{initialData:C,entityReferenceTypes:f,locationReferenceTypes:h,onSubmit:Zt,onCancel:Ft,submitting:z,errorMessage:V})})]})}),Le&&t.jsx("div",{className:"side-panel-overlay",role:"dialog","aria-modal":"true",children:t.jsxs("div",{className:"side-panel",children:[t.jsxs("div",{className:"side-panel-header",children:[t.jsx("h2",{children:De?"Edit conditional rule":"Add conditional rule"}),t.jsx("button",{type:"button",className:"icon-btn",onClick:oe,title:"Close form",disabled:mt,children:t.jsx(Bn,{size:18})})]}),t.jsx("div",{className:"side-panel-content",children:t.jsx(s5,{fields:g,initialData:De,onSubmit:Ee,onCancel:oe,submitting:mt,errorMessage:Ct})})]})})]}):t.jsx("p",{children:"Authenticating..."}):t.jsx("p",{children:"Restoring session..."})}const c5="Create Entity Type",u5=[{title:"Details",columns:1,fields:[{key:"name",label:"Name",type:"text",placeholder:"e.g. Faction"},{key:"world_id",label:"World",type:"select",optionsSource:"worlds",placeholder:"Select the world this type belongs to",required:!0},{key:"description",label:"Description",type:"textarea",placeholder:"Optional description for this entity type"}]}],d5={title:c5,sections:u5};function f5(){const e=_n(),{user:n,token:s,sessionReady:i}=un(),{selectedCampaign:l}=wn(),[o,d]=u.useState(!1),f=u.useMemo(()=>{if(!l?.world)return"";const S=l.world;return S.created_by||S.creator?.id||S.owner_id||S.owner?.id||""},[l]),p=!!(n?.id&&f===n.id),h=u.useMemo(()=>n?n.role==="system_admin"?!0:p:!1,[n,p]),y=l?.world?.id??"",g=l?.world?.name??"";if(!i)return t.jsx("p",{children:"Restoring session..."});if(!s)return t.jsx("p",{children:"Authenticating..."});if(!h)return t.jsxs("section",{className:"page limited-access",children:[t.jsx("h1",{children:"Create Entity Type"}),t.jsx("p",{children:"Only system administrators or the world owner can create entity types."}),t.jsx("button",{type:"button",className:"btn cancel",onClick:()=>e("/entity-types"),children:"Back to Entity Types"})]});if(!y)return t.jsxs("section",{className:"page create-entity-type",children:[t.jsx("h1",{children:"Create Entity Type"}),t.jsx("p",{children:"Select a campaign from the header to choose a world context before creating entity types."}),t.jsx("button",{type:"button",className:"btn cancel",onClick:()=>e("/entity-types"),children:"Back to Entity Types"})]});const b=()=>{e("/entity-types")},v=async S=>{if(o)return!1;const N=typeof S?.name=="string"?S.name.trim():"",j=typeof S?.description=="string"?S.description.trim():"",A=(typeof S?.world_id=="string"&&S.world_id||typeof S?.worldId=="string"&&S.worldId||S?.world&&typeof S.world.id=="string"&&S.world.id||y||"").trim();if(!N)return alert("Name is required"),!1;if(!A)return alert("Select a world before creating the entity type"),!1;d(!0);try{const _=await NI({name:N,description:j,world_id:A}),T=_?.data??_;return!T||!T.id?(alert("Failed to create entity type"),!1):(e(`/entity-types/${T.id}/fields`),!0)}catch(M){return alert(`Failed to create entity type: ${M.message}`),!1}finally{d(!1)}};return t.jsxs("section",{className:"page create-entity-type",children:[o&&t.jsx("div",{className:"form-status",role:"status","aria-live":"polite",children:"Saving entity type..."}),t.jsx(us,{schema:d5,initialData:{world_id:y,world:y?{id:y,name:g||"Selected world"}:void 0},onSubmit:v,onCancel:b,showUpdateAction:!1})]})}const H1=u.createContext({}),m5=new Set(["true","1","yes","on"]),yw=e=>{if(e==null)return;if(typeof e=="boolean")return e;const n=String(e).trim().toLowerCase();if(n!=="")return m5.has(n)},h5=e=>{const n=yw(e);if(n!==void 0)return n;const s=yw(void 0);return s!==void 0?s:!1};function p5({children:e,initialFeatures:n={}}){const s=h5(n.rel_builder_v2),i=u.useMemo(()=>({...n,rel_builder_v2:s}),[n,s]);return t.jsx(H1.Provider,{value:i,children:e})}const y5=()=>u.useContext(H1),g5=e=>!!y5()?.[e],b5="visible",x5=e=>{if(!e)return null;const n=e.id??e.value??e.entity_type_id??e.entityTypeId??(typeof e=="string"||typeof e=="number"?e:null);if(n==null||n==="")return null;const s=e.name||e.label||e.title||e.display||e.slug||(typeof e=="string"||typeof e=="number"?String(e):"Untitled type");return{id:String(n),name:String(s)}};function gw({allowedTypeIds:e=[],defaultTypeId:n="",worldId:s,onCreated:i,onCancel:l,entityTypes:o=[],onToast:d}){const[f,p]=u.useState({name:"",entityTypeId:"",summary:""}),[h,y]=u.useState(!1),[g,b]=u.useState(""),[v,S]=u.useState(""),N=u.useRef(!1),j=u.useMemo(()=>new Set((e||[]).map(C=>String(C))),[e]),E=u.useMemo(()=>{const C=(Array.isArray(o)?o:[]).map(L=>x5(L)).filter(Boolean);return j.size===0?C:C.filter(L=>j.has(L.id))},[o,j]),A=u.useMemo(()=>n&&j.size>0&&j.has(String(n))?String(n):E.length>0?E[0].id:n?String(n):"",[n,j,E]);u.useEffect(()=>{p(C=>({...C,entityTypeId:A}))},[A]);const M=u.useCallback(()=>{p({name:"",entityTypeId:A,summary:""}),b(""),S(""),N.current=!1},[A]),_=C=>L=>{const{value:z}=L.target;p(G=>({...G,[C]:z}))};u.useEffect(()=>{if(!f.entityTypeId){S("");return}j.size>0&&!j.has(String(f.entityTypeId))?(S("This type is not allowed for the selected relationship."),N.current||(d?.("This entity type is not allowed for this relationship.","warning"),N.current=!0)):(S(""),N.current=!1)},[f.entityTypeId,j,d]);const T=async C=>{if(C.preventDefault(),!s){b("Select a world before creating entities.");return}const L=f.name.trim();if(!L){b("Name is required.");return}const z=f.entityTypeId;if(!z){b("Entity type is required.");return}if(j.size>0&&!j.has(String(z))){S("This type is not allowed for the selected relationship."),N.current||(d?.("This entity type is not allowed for this relationship.","warning"),N.current=!0);return}try{y(!0),b("");const G={world_id:s,name:L,entity_type_id:z,visibility:b5},U=f.summary.trim();U&&(G.description=U);const X=await gg(G),V=X?.data?.data??X?.data??X;if(!V||V.id===void 0||V.id===null)throw new Error("Failed to create entity");i?.(V),M()}catch(G){b(G.message||"Could not create entity. Please try again."),d?.("Could not create entity. Please try again.","error")}finally{y(!1)}},k=h||!f.name.trim()||!f.entityTypeId||j.size>0&&!j.has(String(f.entityTypeId))||E.length===0;return t.jsxs("div",{className:"entity-mini-create-inline",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"entity-mini-name",children:"Name *"}),t.jsx("input",{id:"entity-mini-name",type:"text",value:f.name,onChange:_("name"),disabled:h,required:!0})]}),t.jsxs("div",{className:"form-two-column",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"entity-mini-type",children:"Type *"}),t.jsxs("select",{id:"entity-mini-type",value:f.entityTypeId,onChange:_("entityTypeId"),disabled:h||E.length===0,required:!0,children:[t.jsx("option",{value:"",children:"Select type..."}),E.map(C=>t.jsx("option",{value:C.id,children:C.name},C.id))]})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"entity-mini-summary",children:"Summary"}),t.jsx("input",{id:"entity-mini-summary",type:"text",value:f.summary,onChange:_("summary"),placeholder:"Optional short summary",disabled:h})]})]}),(g||v)&&t.jsx("div",{className:`form-error${v?" warning":""}`,role:"alert",children:v||g}),t.jsxs("div",{className:"inline-actions",children:[t.jsx("button",{type:"button",className:"btn secondary",onClick:l,disabled:h,children:"Cancel"}),t.jsx("button",{type:"button",className:"btn",disabled:k,onClick:T,children:h?"Creating":"Save"})]})]})}const v5=[{value:"source",label:"This entity is the source"},{value:"target",label:"This entity is the target"}];function S5({value:e,onChange:n,disabled:s=!1}){const i=l=>{const o=l.target.value==="target"?"target":"source";o!==e&&n?.(o)};return t.jsxs("fieldset",{className:"perspective-toggle",disabled:s,children:[t.jsx("legend",{children:"Relationship Perspective"}),t.jsx("div",{role:"radiogroup","aria-label":"Relationship perspective",className:"perspective-toggle-options",children:v5.map(l=>{const o=["perspective-toggle-option"];return l.value===e&&o.push("active"),s&&o.push("disabled"),t.jsxs("label",{className:o.join(" "),children:[t.jsx("input",{type:"radio",name:"relationship-perspective",value:l.value,checked:e===l.value,onChange:i,disabled:s}),t.jsx("span",{children:l.label})]},l.value)})})]})}const bd=e=>e==null?"":String(e).trim(),w5=e=>{if(e==null)return"";if(typeof e=="object")try{return JSON.stringify(e)}catch{return""}return String(e)},N5=e=>{const n=e.trim();if(!n)return"";if(n==="true")return!0;if(n==="false")return!1;const s=n[0],i=n[n.length-1];if(s==="{"&&i==="}"||s==="["&&i==="]")try{return JSON.parse(n)}catch{return e}const l=Number(n);return!Number.isNaN(l)&&n!==""?l:e},xd=e=>{if(!Array.isArray(e)||e.length===0)return"";if(e.length===1)return e[0];if(e.length===2)return`${e[0]} or ${e[1]}`;const n=e.slice(0,-1),s=e[e.length-1];return`${n.join(", ")}, or ${s}`},j5=e=>{if(!e||e.id===void 0||e.id===null)return null;const n=e.entity_type_id??e.entityTypeId??e.entity_type?.id??e.entityType?.id??null,s=e.entityType||e.entity_type||(n&&e.entity_type_name?{id:n,name:e.entity_type_name}:null);return{...e,id:e.id,name:e.name||"Untitled entity",entity_type_id:n,entityType:s}},bw=e=>e?.name||e?.entityType?.name||e?.entity_type?.name||"",xc=(e,n)=>{if(!e)return[];const s=n==="from"?e?.from_entity_types??e?.fromEntityTypes??e?.fromTypes??[]:e?.to_entity_types??e?.toEntityTypes??e?.toTypes??[];return Array.isArray(s)?s:[]},E5=e=>{if(!e)return"";if(typeof e=="string"||typeof e=="number")return String(e).trim();if(typeof e=="object"){if(e.id!==void 0&&e.id!==null)return String(e.id);if(e.entity_type_id!==void 0&&e.entity_type_id!==null)return String(e.entity_type_id);if(e.entityTypeId!==void 0&&e.entityTypeId!==null)return String(e.entityTypeId);if(e.entityType?.id!==void 0&&e.entityType?.id!==null)return String(e.entityType.id);if(e.entity_type?.id!==void 0&&e.entity_type?.id!==null)return String(e.entity_type.id)}return""},rc=(e,n)=>xc(e,n).map(s=>E5(s)).filter(s=>s!=="");function _5({worldId:e,relationshipId:n,onCancel:s,onSaved:i,onToast:l,defaultFromEntityId:o,lockFromEntity:d=!1,defaultToEntityId:f,lockToEntity:p=!1,defaultPerspective:h="source",currentEntityId:y,currentEntityTypeId:g,formId:b="relationship-form",onStateChange:v,hideActions:S=!1}){const N=!!n,j=N,E=N,A=u.useRef(0),M=u.useCallback((te="",ve="")=>(A.current+=1,{id:A.current,key:te,value:ve}),[]),_=u.useCallback(te=>te.length>0?te:[M()],[M]),T=u.useCallback(te=>{if(!te||typeof te!="object"||Array.isArray(te))return"";const ve=te.__direction||te.direction;return ve?String(ve):""},[]),k=u.useCallback(te=>{if(A.current=0,!te||typeof te!="object"||Array.isArray(te))return[M()];const ve=Object.entries(te).filter(([Ie])=>typeof Ie!="string"?!0:!Ie.startsWith("__"));return ve.length===0?[M()]:ve.map(([Ie,rt])=>M(Ie,w5(rt)))},[M]),C=bd(o),L=bd(f),z=bd(y),G=bd(g),U=h==="target"?"reverse":"forward",X=U==="forward"?C:"",V=U==="reverse"?L:"",[R,B]=u.useState([]),[D,O]=u.useState([]),[$,F]=u.useState([]),[H,I]=u.useState({fromEntityId:X,toEntityId:V,relationshipTypeId:""}),[Y,P]=u.useState(()=>(A.current=0,[M()])),[W,le]=u.useState(U),[K,de]=u.useState(!1),[Q,he]=u.useState(!1),[re,Ce]=u.useState(!1),[Re,ue]=u.useState(!1),[se,Le]=u.useState(!1),[be,De]=u.useState(""),[Me,mt]=u.useState(""),[ht,Ct]=u.useState(null),At=u.useRef({from:null,to:null}),[we,st]=u.useState({from:"",to:""}),lt=W==="reverse"?"target":"source",Fe=lt==="source",Xe=u.useMemo(()=>lt==="target"?p?"to":d?"from":"":d?"from":p?"to":"",[d,p,lt]),dt=Xe==="from"?"to":Xe==="to"?"from":"",ie=u.useMemo(()=>Y.some(te=>te.key.trim()!==""||te.value.trim()!==""),[Y]);u.useEffect(()=>{let te=!1;return e?((async()=>{de(!0);try{const Ie=await Mc(e),rt=Array.isArray(Ie)?Ie:Array.isArray(Ie?.data)?Ie.data:[];te||B(rt)}catch(Ie){te||(B([]),De(Ie.message||"Failed to load entities"))}finally{te||de(!1)}})(),()=>{te=!0}):(B([]),()=>{})},[e]),u.useEffect(()=>{let te=!1;return e?((async()=>{he(!0);try{const Ie=await Bf({worldId:e}),rt=Array.isArray(Ie)?Ie:Array.isArray(Ie?.data)?Ie.data:[];te||O(rt)}catch(Ie){te||(O([]),De(Ie.message||"Failed to load relationship types"))}finally{te||he(!1)}})(),()=>{te=!0}):(O([]),he(!1),()=>{})},[e]),u.useEffect(()=>{let te=!1;return(async()=>{if(!e){F([]),Ce(!1);return}Ce(!0);try{const Ie=await wr({worldId:e}),rt=Array.isArray(Ie)?Ie:Array.isArray(Ie?.data)?Ie.data:[];te||F(rt)}catch(Ie){te||(F([]),De(rt=>rt||Ie.message||"Failed to load entity types"))}finally{te||Ce(!1)}})(),()=>{te=!0}},[e]);const ee=te=>{if(!te)return"";const ve=te.entity_type_id??te.entityTypeId??te.entityType?.id??te.entity_type?.id??"";return ve?String(ve):""},ce=u.useMemo(()=>H.fromEntityId&&R.find(te=>String(te.id)===String(H.fromEntityId))||null,[R,H.fromEntityId]),fe=u.useMemo(()=>ee(ce),[ce]),qe=u.useMemo(()=>H.toEntityId&&R.find(te=>String(te.id)===String(H.toEntityId))||null,[R,H.toEntityId]),Pe=u.useMemo(()=>ee(qe),[qe]),Be=u.useMemo(()=>Xe==="from"?fe||(z&&H.fromEntityId===z&&G||C&&H.fromEntityId===C&&G?G:""):Xe==="to"?Pe||(z&&H.toEntityId===z&&G||L&&H.toEntityId===L&&G?G:""):"",[Xe,fe,Pe,H.fromEntityId,H.toEntityId,z,G,C,L]),Te=u.useMemo(()=>W==="reverse"?Xe==="to"?"from":"to":"from",[W,Xe]),gt=u.useMemo(()=>W==="reverse"?Xe==="to"?"to":"from":"to",[W,Xe]),jt=u.useMemo(()=>{const te=Be?String(Be):"";if(te){if(Xe==="from")return{typeId:te,role:Te};if(Xe==="to")return{typeId:te,role:gt}}return fe?{typeId:String(fe),role:Te}:Pe?{typeId:String(Pe),role:gt}:null},[Be,Xe,fe,Pe,Te,gt]),Mt=u.useMemo(()=>{if(!D?.length)return[];const te=(Ie,rt,_t)=>{if(!_t)return Ie;const Lt=String(_t);return Ie.filter(nn=>{const Pt=rc(nn,rt);return Pt.length===0?!0:Pt.includes(Lt)})};let ve=D;if(jt){const{typeId:Ie,role:rt}=jt;ve=te(ve,rt,Ie)}return ve=te(ve,Te,fe),ve=te(ve,gt,Pe),ve},[D,jt,Te,gt,fe,Pe]),tt=u.useMemo(()=>H.relationshipTypeId?D.find(te=>String(te.id)===String(H.relationshipTypeId)):null,[D,H.relationshipTypeId]),ft=u.useMemo(()=>tt?rc(tt,Te):[],[tt,Te]),Rt=u.useMemo(()=>tt?rc(tt,gt):[],[tt,gt]),Ft=u.useMemo(()=>ft.length>0?String(ft[0]):"",[ft]),Zt=u.useMemo(()=>Rt.length>0?String(Rt[0]):"",[Rt]),Tt=te=>{const ve=te==="target"?"reverse":"forward";mt(""),W!==ve&&I(Ie=>{const rt={...Ie,relationshipTypeId:""};if(!N){const _t=z||"";if(ve==="reverse"){const Lt=L||_t;Lt&&(rt.toEntityId=Lt,d&&Ie.fromEntityId===Lt&&(rt.fromEntityId=""))}else{const Lt=C||_t;Lt&&(rt.fromEntityId=Lt,p&&Ie.toEntityId===Lt&&(rt.toEntityId=""))}}return rt}),le(Ie=>Ie===ve?Ie:ve)},We=u.useCallback(te=>{if(te==="from"){if(Xe==="from")return;if(!ft.length){l?.("This entity type is not allowed for this relationship.","warning");return}}else{if(Xe==="to")return;if(!Rt.length){l?.("This entity type is not allowed for this relationship.","warning");return}}Ct(te)},[ft.length,Rt.length,Xe,l]);u.useEffect(()=>{(ht==="from"&&ft.length===0||ht==="to"&&Rt.length===0)&&Ct(null)},[ht,ft.length,Rt.length]);const it=u.useMemo(()=>{if(!ft.length)return R;const te=new Set(ft);return R.filter(ve=>te.has(ee(ve)))},[R,ft]),bt=u.useMemo(()=>{if(!Rt.length)return R;const te=new Set(Rt);return R.filter(ve=>te.has(ee(ve)))},[R,Rt]);u.useEffect(()=>{if(!H.relationshipTypeId)return;Mt.some(ve=>String(ve.id)===String(H.relationshipTypeId))||I(ve=>({...ve,relationshipTypeId:""}))},[Mt,H.relationshipTypeId]),u.useEffect(()=>{if(!H.relationshipTypeId||!fe)return;if(d||p||z){mt("");return}const te=String(fe),ve=D.find(nn=>String(nn.id)===String(H.relationshipTypeId));if(!ve)return;const Ie=rc(ve,"from"),rt=rc(ve,"to"),_t=Ie.includes(te),Lt=rt.includes(te);if(_t&&Lt){mt("");return}if(_t&&W!=="forward"){le("forward"),mt("");return}if(!_t&&Lt){const nn="Direction auto-corrected because this entity is only allowed as a target.";W!=="reverse"?(le("reverse"),mt(nn)):mt(Pt=>Pt||nn);return}!_t&&!Lt&&(mt(""),I(nn=>({...nn,relationshipTypeId:""})))},[H.relationshipTypeId,fe,D,W,d,p,z]),u.useEffect(()=>{if(!H.fromEntityId||!ft.length)return;const te=new Set(ft),ve=R.find(rt=>String(rt.id)===String(H.fromEntityId));if(!ve)return;const Ie=ee(ve);(!Ie||!te.has(Ie))&&I(rt=>({...rt,fromEntityId:""}))},[ft,R,H.fromEntityId]),u.useEffect(()=>{if(!H.toEntityId||!Rt.length)return;const te=new Set(Rt),ve=R.find(rt=>String(rt.id)===String(H.toEntityId));if(!ve)return;const Ie=ee(ve);(!Ie||!te.has(Ie))&&I(rt=>({...rt,toEntityId:""}))},[Rt,R,H.toEntityId]);const oe=u.useMemo(()=>{if(!tt)return"";const te=xc(tt,Te);return te.length?te.map(ve=>ve?.name||ve?.entityType?.name||ve?.entity_type?.name||"Unknown type").join(", "):""},[tt,Te]),Ee=u.useMemo(()=>{if(!tt)return"";const te=xc(tt,gt);return te.length?te.map(ve=>ve?.name||ve?.entityType?.name||ve?.entity_type?.name||"Unknown type").join(", "):""},[tt,gt]),Se=Te==="from"?"source":"target",Ve=gt==="from"?"source":"target",xe=`Allowed ${Se}s`,$e=`Allowed ${Ve}s`,He=u.useMemo(()=>tt&&(W==="reverse"?tt.to_name||tt.toName:tt.from_name||tt.fromName)||"",[tt,W]),J=u.useMemo(()=>tt&&(W==="reverse"?tt.from_name||tt.fromName:tt.to_name||tt.toName)||"",[tt,W]),Z=u.useMemo(()=>tt?xc(tt,Te).map(te=>bw(te)).filter(te=>te&&te.trim()):[],[tt,Te]),je=u.useMemo(()=>tt?xc(tt,gt).map(te=>bw(te)).filter(te=>te&&te.trim()):[],[tt,gt]),Ne=u.useMemo(()=>!tt||!Z.length&&!je.length?"":Z.length&&je.length?`This relationship can only be initiated from ${xd(Z)} and targets ${xd(je)}.`:Z.length?`This relationship can only be initiated from ${xd(Z)}.`:`This relationship targets ${xd(je)}.`,[tt,Z,je]),pe=u.useMemo(()=>{if(!Xe||!tt)return"";const te=Be?String(Be):"";if(!te)return"";if(Xe==="from"){if(ft.length>0&&!ft.includes(te))return Fe?"This entity is not an allowed source for the selected relationship type. Try switching perspective.":"This entity is not an allowed target for the selected relationship type. Try switching perspective."}else if(Xe==="to"&&Rt.length>0&&!Rt.includes(te))return Fe?"This entity is not an allowed target for the selected relationship type. Try switching perspective.":"This entity is not an allowed source for the selected relationship type. Try switching perspective.";return""},[Xe,tt,Be,ft,Rt,Fe]),Ue=u.useMemo(()=>Xe?Xe==="from"?Fe?"This entity is fixed as the source for this relationship.":"This field is locked to the current entity.":Xe==="to"?Fe?"This field is locked to the current entity.":"This entity is fixed as the target for this relationship.":"":"",[Xe,Fe]),ae=!!pe;u.useEffect(()=>{let te=!1;const ve=()=>{A.current=0,I({fromEntityId:U==="forward"?C:"",toEntityId:U==="reverse"?L:"",relationshipTypeId:""}),P([M()]),le(U),De(""),Ct(null)};return!N||!n?(ve(),ue(!1),()=>{}):((async()=>{ue(!0),De("");try{const rt=await _D(n),_t=rt?.data||rt;if(!_t)throw new Error("Relationship not found");if(!te){const Lt=_t.from_entity_id||_t.fromEntityId||_t.from_entity?.id||_t.fromEntity?.id||"",nn=_t.to_entity_id||_t.toEntityId||_t.to_entity?.id||_t.toEntity?.id||"",Pt=_t.entity_relationship_type_id||_t.relationship_type_id||_t.relationshipType?.id||_t.relationship_type?.id||"";I({fromEntityId:Lt?String(Lt):"",toEntityId:nn?String(nn):"",relationshipTypeId:Pt?String(Pt):""}),le(T(_t.context)||"forward"),P(_(k(_t.context)))}}catch(rt){te||De(rt.message||"Failed to load relationship")}finally{te||ue(!1)}})(),()=>{te=!0})},[n,N,_,k,M,T,U,C,L]),u.useEffect(()=>{if(N)return;const te=h==="target"?"reverse":"forward";le(ve=>ve===te?ve:te)},[h,N]),u.useEffect(()=>{if(N||!Xe)return;const te=z||"",ve=Xe==="from"?C||te:L||te;ve&&I(Ie=>{const rt=Xe==="from"?"fromEntityId":"toEntityId";if(Ie[rt]===ve)return Ie;const _t={...Ie,[rt]:ve};return Xe==="from"&&p&&Ie.toEntityId===ve&&(_t.toEntityId=""),Xe==="to"&&d&&Ie.fromEntityId===ve&&(_t.fromEntityId=""),_t})},[N,Xe,d,p,C,L,z]);const Ke=te=>ve=>{const{value:Ie}=ve.target;I(rt=>{if(N)return{...rt,[te]:Ie};const _t={...rt,relationshipTypeId:Ie};return Xe==="from"?_t.toEntityId="":Xe==="to"&&(_t.fromEntityId=""),_t}),Ct(null)},ot=te=>{const{value:ve}=te.target;Ct(Ie=>Ie==="from"?null:Ie),I(Ie=>({...Ie,fromEntityId:ve}))},St=te=>{const{value:ve}=te.target;Ct(Ie=>Ie==="to"?null:Ie),I(Ie=>({...Ie,toEntityId:ve}))},me=u.useCallback(()=>{Ct(null)},[]),nt=u.useCallback((te,ve)=>{const Ie=te==="to"?"to":"from",rt=ve?String(ve):"";st(_t=>({..._t,[Ie]:rt})),At.current[Ie]&&clearTimeout(At.current[Ie]),At.current[Ie]=setTimeout(()=>{st(_t=>({..._t,[Ie]:""})),At.current[Ie]=null},2e3)},[]),Ge=u.useCallback((te,ve)=>{const Ie=j5(ve);if(!Ie)return;const rt=String(Ie.id);B(Pt=>{const zt={...Ie,id:rt},Ut=Pt.findIndex(dn=>String(dn.id)===rt);if(Ut>=0){const dn=[...Pt];return dn[Ut]={...dn[Ut],...zt},dn}return[zt,...Pt]}),te==="from"?I(Pt=>({...Pt,fromEntityId:rt})):te==="to"&&I(Pt=>({...Pt,toEntityId:rt})),nt(te,rt),Ct(null);const _t=te==="from"?Se:Ve,Lt=`${_t[0].toUpperCase()}${_t.slice(1)}`,nn=Lt?`New ${Lt} entity added and selected.`:"New entity added and selected.";l?.(nn,"success")},[nt,Se,Ve,l]);u.useEffect(()=>{const te=At.current;return()=>{Object.values(te).forEach(ve=>{ve&&clearTimeout(ve)})}},[]);const vt=(te,ve)=>Ie=>{const{value:rt}=Ie.target;P(_t=>_t.map(Lt=>Lt.id===te?{...Lt,[ve]:rt}:Lt))},ct=()=>{P(te=>[...te,M()])},Nt=te=>{P(ve=>_(ve.filter(Ie=>Ie.id!==te)))},Ye=async te=>{if(te.preventDefault(),!e){De("Select a world before creating relationships.");return}const ve=H.fromEntityId.trim(),Ie=H.toEntityId.trim(),rt=H.relationshipTypeId.trim();if(!ve||!Ie){De("Both entities are required.");return}if(!rt){De("Relationship type is required.");return}const _t={};Y.forEach(({key:dn,value:Un})=>{const yn=dn.trim();yn&&(yn.startsWith("__")||(_t[yn]=N5(Un)))});const Lt=W==="reverse"?"reverse":"forward";_t.__direction=Lt;let nn=ve,Pt=Ie;Lt==="reverse"&&(!z||H.fromEntityId===z)&&(nn=Ie,Pt=ve);const Ut={world_id:e,from_entity_id:nn,to_entity_id:Pt,relationship_type_id:rt,bidirectional:!0,context:_t};try{if(Le(!0),De(""),N)await CD(n,Ut),i?.("edit");else{const dn=await b1(Ut),Un=dn?.data??dn,yn=Un?.data??Un;i?.("create",yn)}}catch(dn){De(dn.message||"Failed to save relationship")}finally{Le(!1)}},Je=K||Q||Re||re,Et=!!jt?.typeId&&Mt.length===0;return u.useEffect(()=>{if(!v)return;v({mode:N?"edit":"create",saving:se,isBusy:Je,submitLabel:se?"Saving...":N?"Save Changes":"Create Relationship",submitDisabled:se||Je||ae,cancelDisabled:se})},[v,N,se,Je,ae]),t.jsxs("form",{id:b,className:"entity-form relationship-form",onSubmit:Ye,children:[t.jsx(S5,{value:lt,onChange:Tt,disabled:se||Je}),pe&&t.jsx("div",{className:"alert warning",role:"alert",children:pe}),Me&&t.jsx("div",{className:"alert warning",role:"status",children:Me}),t.jsxs("div",{className:"form-two-column",children:[t.jsxs("div",{className:`form-group${we.from&&we.from===H.fromEntityId?" entity-select-highlight":""}`,children:[t.jsx("label",{htmlFor:"relationship-from-entity",children:"From Entity *"}),t.jsxs("select",{id:"relationship-from-entity",value:H.fromEntityId,onChange:ot,disabled:se||Je||Xe==="from",required:!0,"data-autofocus":dt==="from"?!0:void 0,children:[t.jsx("option",{value:"",children:"Select entity..."}),it.map(te=>t.jsx("option",{value:te.id,children:te.name},te.id))]}),Xe==="from"&&Ue&&t.jsx("p",{className:"field-hint",children:Ue}),j&&He&&t.jsxs("p",{className:"field-hint",children:["Displayed label: ",He]}),j&&tt&&oe&&t.jsxs("p",{className:"field-hint",children:[xe,": ",oe]}),Xe!=="from"&&t.jsx("div",{className:"inline-create-trigger",children:ft.length>0?t.jsx("button",{type:"button",className:"link-button",onClick:()=>We("from"),disabled:ht==="from",children:"+ Create new"}):t.jsx("button",{type:"button",className:"link-button disabled",disabled:!0,children:"+ Create new"})}),Xe!=="from"&&ft.length===0&&t.jsx("p",{className:"inline-create-hint disabled",children:"Inline creation isnt available for this relationship."}),tt&&ft.length>0&&it.length===0&&t.jsxs("p",{className:"field-hint",children:["No entities match the allowed ",Se," types yet. Use + Create new to add one without leaving this page."]}),Xe!=="from"&&ht==="from"&&t.jsx(gw,{allowedTypeIds:ft,defaultTypeId:Ft,worldId:e,entityTypes:$,onCreated:te=>Ge("from",te),onCancel:me,onToast:l},`inline-from-${H.relationshipTypeId}`)]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"relationship-type",children:"Relationship Type *"}),t.jsxs("select",{id:"relationship-type",value:H.relationshipTypeId,onChange:Ke("relationshipTypeId"),disabled:se||Je||!Mt.length,required:!0,children:[t.jsx("option",{value:"",children:"Select type..."}),Mt.map(te=>{const ve=te.from_name||te.fromName||te.name,Ie=te.to_name||te.toName||te.name,rt=ve===Ie?ve:`${ve}  ${Ie}`;return t.jsxs("option",{value:te.id,children:[te.name,"  ",rt]},te.id)})]}),Et&&t.jsx("p",{className:"field-hint",children:"No relationship types include the selected entity type."}),Ne&&t.jsx("p",{className:"helper-hint",children:Ne})]})]}),t.jsx("div",{className:"form-two-column",children:t.jsxs("div",{className:`form-group${we.to&&we.to===H.toEntityId?" entity-select-highlight":""}`,children:[t.jsx("label",{htmlFor:"relationship-to-entity",children:"To Entity *"}),t.jsxs("select",{id:"relationship-to-entity",value:H.toEntityId,onChange:St,disabled:se||Je||Xe==="to",required:!0,"data-autofocus":dt==="to"?!0:void 0,children:[t.jsx("option",{value:"",children:"Select entity..."}),bt.map(te=>t.jsx("option",{value:te.id,children:te.name},te.id))]}),Xe==="to"&&Ue&&t.jsx("p",{className:"field-hint",children:Ue}),j&&J&&t.jsxs("p",{className:"field-hint",children:["Displayed label: ",J]}),j&&tt&&Ee&&t.jsxs("p",{className:"field-hint",children:[$e,": ",Ee]}),Xe!=="to"&&t.jsx("div",{className:"inline-create-trigger",children:Rt.length>0?t.jsx("button",{type:"button",className:"link-button",onClick:()=>We("to"),disabled:ht==="to",children:"+ Create new"}):t.jsx("button",{type:"button",className:"link-button disabled",disabled:!0,children:"+ Create new"})}),Xe!=="to"&&Rt.length===0&&t.jsx("p",{className:"inline-create-hint disabled",children:"Inline creation isnt available for this relationship."}),tt&&Rt.length>0&&bt.length===0&&t.jsxs("p",{className:"field-hint",children:["No entities match the allowed ",Ve," types yet. Use + Create new to add one without losing your place."]}),Xe!=="to"&&ht==="to"&&t.jsx(gw,{allowedTypeIds:Rt,defaultTypeId:Zt,worldId:e,entityTypes:$,onCreated:te=>Ge("to",te),onCancel:me,onToast:l},`inline-to-${H.relationshipTypeId}`)]})}),E&&t.jsxs("div",{className:"metadata-editor",children:[t.jsxs("div",{className:"metadata-header",children:[t.jsxs("h3",{children:["Context ",ie?"":"(optional)"]}),t.jsx("button",{type:"button",className:"btn neutral",onClick:ct,disabled:se||Je,children:"Add field"})]}),t.jsx("div",{className:"metadata-list",children:Y.map((te,ve)=>t.jsxs("div",{className:"metadata-row",children:[t.jsxs("div",{className:"form-group",children:[t.jsxs("label",{htmlFor:`context-key-${te.id}`,className:"sr-only",children:["Context key ",ve+1]}),t.jsx("input",{id:`context-key-${te.id}`,type:"text",placeholder:"Key",value:te.key,onChange:vt(te.id,"key"),disabled:se||Je})]}),t.jsxs("div",{className:"form-group",children:[t.jsxs("label",{htmlFor:`context-value-${te.id}`,className:"sr-only",children:["Context value ",ve+1]}),t.jsx("input",{id:`context-value-${te.id}`,type:"text",placeholder:"Value",value:te.value,onChange:vt(te.id,"value"),disabled:se||Je})]}),t.jsx("div",{className:"metadata-actions",children:t.jsx("button",{type:"button",className:"icon-btn",onClick:()=>Nt(te.id),disabled:se||Je||Y.length===1,title:"Remove field",children:""})})]},te.id))})]}),Je&&t.jsx("div",{className:"form-loading",role:"status",children:"Loading data..."}),be&&t.jsx("div",{className:"form-error",role:"alert",children:be}),!S&&t.jsxs("div",{className:"form-actions",children:[t.jsx("button",{type:"button",className:"btn cancel",onClick:s,disabled:se,children:"Cancel"}),t.jsx("button",{type:"submit",className:"btn submit",disabled:se||Je||ae,children:se?"Saving...":N?"Save Changes":"Create Relationship"})]})]})}function C5(e){return t.jsx(_5,{...e})}const A5=new Set(["system_admin"]),xw=(e="create")=>({mode:e,submitLabel:e==="edit"?"Save Changes":"Create Relationship",submitDisabled:!1,cancelDisabled:!1,saving:!1,isBusy:!1});function T5(){const{user:e,token:n,sessionReady:s}=un(),{selectedCampaign:i,activeWorld:l,activeWorldId:o,selectedContextType:d,contextKey:f}=wn(),p=g5("rel_builder_v2"),[h,y]=u.useState(!1),[g,b]=u.useState(!1),[v,S]=u.useState([]),[N,j]=u.useState([]),[E,A]=u.useState({}),M=u.useRef({}),[_,T]=u.useState(!1),[k,C]=u.useState(!1),[L,z]=u.useState(""),[G,U]=u.useState(null),[X,V]=u.useState(""),[R,B]=u.useState(null),[D,O]=u.useState(()=>xw("create")),[$,F]=u.useState(""),[H,I]=u.useState(""),Y=o||"",P=!!Y,W=u.useRef(`${Y}:${f}`),le=u.useRef(`relationship-form-${Math.random().toString(36).slice(2)}`),K=(ie="create")=>{O(xw(ie))},de=u.useCallback((ie,ee="info")=>{B({message:ie,tone:ee})},[]);u.useEffect(()=>{if(!R)return;const ie=setTimeout(()=>B(null),3500);return()=>clearTimeout(ie)},[R]);const Q=u.useMemo(()=>!i||!e?"":i.members?.find(ee=>ee.user_id===e.id)?.role||"",[i,e]),he=u.useMemo(()=>{const ie=i?.world||l;if(!ie||!e?.id)return!1;const ee=ie.created_by||ie.creator?.id||ie.owner_id||ie.owner?.id||"";return ee?String(ee)===String(e.id):!1},[i,l,e?.id]),re=u.useMemo(()=>!e||!Y?!1:A5.has(e.role)?!0:d==="world"?he:!!(i&&(Q==="dm"||he)),[e,Y,d,i,Q,he]),Ce=u.useCallback(async ie=>{const ee=Array.from(new Set(ie.map(Be=>Be==null?"":String(Be)).filter(Boolean)));if(ee.length===0)return;const ce=M.current,fe=ee.filter(Be=>!ce[Be]);if(fe.length===0)return;const qe=await Promise.all(fe.map(async Be=>{try{const Te=await Hs(Be),gt=Ya(Te);return{id:Be,data:gt}}catch(Te){return console.error(" Failed to resolve entity",Te),{id:Be,data:null}}})),Pe={};qe.forEach(({id:Be,data:Te})=>{Te?Pe[Be]={id:Te.id||Be,name:Te.name||`Entity ${Be}`,typeName:Te.entityType?.name||Te.entity_type?.name||""}:Pe[Be]={id:Be,name:`Entity #${Be}`,typeName:""}}),M.current={...M.current,...Pe},A(Be=>({...Be,...Pe}))},[]),Re=u.useCallback(async ie=>{const ee=ie?{worldId:ie}:{};C(!0);try{const ce=await Bf(ee),fe=Array.isArray(ce)?ce:Array.isArray(ce?.data)?ce.data:[];j(fe)}catch(ce){console.error(" Failed to load relationship types",ce),de(ce.message||"Failed to load relationship types","error"),j([])}finally{C(!1)}},[de]);u.useEffect(()=>{if(!Y){j([]);return}Re(Y)},[Re,Y,f]);const ue=u.useCallback(async ie=>{const ee=ie??Y;if(!ee||!n)return S([]),[];T(!0),z("");try{const ce=await ED(ee),fe=Array.isArray(ce)?ce:Array.isArray(ce?.data)?ce.data:[];S(fe);const qe=[];return fe.forEach(Pe=>{const Be=Pe.from_entity_id||Pe.fromEntityId||Pe.from_entity?.id||Pe.fromEntity?.id||"",Te=Pe.to_entity_id||Pe.toEntityId||Pe.to_entity?.id||Pe.toEntity?.id||"";Be&&qe.push(Be),Te&&qe.push(Te)}),await Ce(qe),fe}catch(ce){return console.error(" Failed to load relationships",ce),S([]),z(ce.message||"Failed to load relationships"),[]}finally{T(!1)}},[Y,n,Ce,f]);u.useEffect(()=>{if(!Y||!n){S([]),M.current={},A({});return}ue(Y)},[Y,n,ue,f]),u.useEffect(()=>{const ie=`${Y}:${f}`;W.current!==ie&&(h&&y(!1),g&&b(!1),U(null),B(null),F(""),I(""),z(""),M.current={},A({}),W.current=ie)},[Y,f,h,g]);const se=u.useMemo(()=>{const ie=new Map;return N.forEach(ee=>{ee?.id&&ie.set(String(ee.id),ee)}),ie},[N]),Le=ie=>{if(!ie)return"";if(typeof ie=="object"&&ie!==null&&!Array.isArray(ie)){const ee=ie.__direction||ie.direction;return ee?String(ee):""}return""},be=u.useMemo(()=>v.map(ie=>{const ee=ie.from_entity_id||ie.fromEntityId||ie.from_entity?.id||ie.fromEntity?.id||"",ce=ie.to_entity_id||ie.toEntityId||ie.to_entity?.id||ie.toEntity?.id||"",fe=ie.entity_relationship_type_id||ie.relationship_type_id||ie.relationshipType?.id||ie.relationship_type?.id||"",qe=ie.relationshipType||ie.relationship_type||se.get(String(fe))||{},Pe=qe.name||ie.relationshipTypeName||se.get(String(fe))?.name||"",Be=qe.from_name||qe.fromName||se.get(String(fe))?.from_name||se.get(String(fe))?.fromName||Pe,Te=qe.to_name||qe.toName||se.get(String(fe))?.to_name||se.get(String(fe))?.toName||Pe,gt=Le(ie.context),jt=gt==="reverse"?Te:Be,Mt=!!(ie.bidirectional??ie.is_bidirectional??ie.two_way??!1);return{...ie,fromEntityId:ee?String(ee):"",toEntityId:ce?String(ce):"",relationshipTypeId:fe?String(fe):"",typeName:jt,direction:gt,typeFromName:Be,typeToName:Te,bidirectional:Mt,fromEntityName:ie.fromEntity?.name||ie.from_entity?.name||ie.fromEntityName||"",toEntityName:ie.toEntity?.name||ie.to_entity?.name||ie.toEntityName||"",fromEntityTypeName:ie.fromEntity?.entityType?.name||ie.from_entity?.entity_type?.name||"",toEntityTypeName:ie.toEntity?.entityType?.name||ie.to_entity?.entity_type?.name||""}}),[v,se]),De=i?`${i.name}${l?.name?`  ${l.name}`:""}`:P?`World  ${l?.name||"Untitled world"}`:"",Me=u.useCallback((ie,ee="",ce="")=>{if(!ie)return"";const fe=E[ie],qe=fe?.name||ee||`Entity #${ie}`,Pe=fe?.typeName||ce;return Pe?`${qe} (${Pe})`:qe},[E]),mt=u.useMemo(()=>{const ie=H.trim().toLowerCase();return be.filter(ee=>{if($&&ee.relationshipTypeId!==$)return!1;if(!ie)return!0;const ce=Me(ee.fromEntityId,ee.fromEntityName,ee.fromEntityTypeName).toLowerCase(),fe=Me(ee.toEntityId,ee.toEntityName,ee.toEntityTypeName).toLowerCase();return ce.includes(ie)||fe.includes(ie)})},[be,$,H,Me]);if(!s)return t.jsx("p",{children:"Restoring session..."});if(!n)return t.jsx("p",{children:"Authenticating..."});const ht=mt.length>0,Ct=G?"Edit Relationship":"Add Relationship",At=()=>{Y&&ue(Y)},we=()=>{if(!(!re||!Y)){if(p){y(!0);return}U(null),K("create"),b(!0)}},st=ie=>{!re||!ie?.id||(U(ie.id),K("edit"),b(!0))},lt=()=>{b(!1),U(null),K("create")},Fe=(ie={})=>{O(ee=>({...ee,...ie}))},Xe=async(ie,ee)=>{if(lt(),!!Y){if(await ue(Y),ie==="create"&&ee){const ce=Me(ee.from_entity_id,ee?.from_entity?.name,ee?.from_entity?.entityType?.name||ee?.from_entity?.entity_type?.name),fe=Me(ee.to_entity_id,ee?.to_entity?.name,ee?.to_entity?.entityType?.name||ee?.to_entity?.entity_type?.name),qe=ee?.relationshipType?.name||"relationship";de(`Added ${ce}  ${fe} (${qe}).`,"success");return}de(ie==="create"?"Relationship created":"Relationship updated","success")}},dt=async ie=>{if(!re||!ie?.id)return;const ee=Me(ie.fromEntityId,ie.fromEntityName,ie.fromEntityTypeName),ce=Me(ie.toEntityId,ie.toEntityName,ie.toEntityTypeName);if(window.confirm(`Delete relationship "${ee}"  "${ce}"? This action cannot be undone.`))try{V(ie.id),await AD(ie.id),de("Relationship deleted","success"),Y&&await ue(Y)}catch(qe){console.error(" Failed to delete relationship",qe),de(qe.message||"Failed to delete relationship","error")}finally{V("")}};return t.jsxs("section",{className:"entities-page relationships-page",children:[t.jsxs("div",{className:"entities-header",children:[t.jsxs("div",{children:[t.jsx("h1",{children:"Entity Relationships"}),P?t.jsx("p",{className:"entities-subtitle",children:De}):t.jsx("p",{className:"entities-subtitle",children:"Select a campaign or world you own to choose a world context."})]}),t.jsxs("div",{className:"entities-controls",children:[t.jsxs("select",{value:$,onChange:ie=>F(ie.target.value),disabled:k||N.length===0,title:"Filter by relationship type",children:[t.jsx("option",{value:"",children:"All types"}),N.map(ie=>t.jsx("option",{value:String(ie.id),children:ie.name},ie.id))]}),t.jsx(xg,{value:H,onChange:I}),t.jsx("button",{type:"button",className:"icon-btn",title:"Refresh relationships",onClick:At,disabled:!Y||_,children:t.jsx(Vi,{size:16})}),t.jsxs("button",{type:"button",className:"btn submit",onClick:we,disabled:!re||!Y||_,children:[t.jsx(Wn,{size:16})," Add Relationship"]})]})]}),i&&P&&!re&&t.jsx("div",{className:"alert info",role:"status",children:"You can view existing relationships, but only the world owner, a campaign DM, or a system administrator can create or edit them."}),R&&t.jsx("div",{className:`toast-banner ${R.tone}`,role:"status",children:R.message}),L&&t.jsx("div",{className:"alert error",role:"alert",children:L}),_?t.jsx("div",{className:"empty-state",children:"Loading relationships..."}):Y?ht?t.jsx("div",{className:"entities-table-wrapper",children:t.jsxs("table",{className:"entities-table relationships-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"From Entity"}),t.jsx("th",{children:"Relationship Type"}),t.jsx("th",{children:"To Entity"}),t.jsx("th",{children:"Bidirectional"}),re&&t.jsx("th",{className:"actions-column",children:"Actions"})]})}),t.jsx("tbody",{children:mt.map(ie=>{const ee=Me(ie.fromEntityId,ie.fromEntityName,ie.fromEntityTypeName),ce=Me(ie.toEntityId,ie.toEntityName,ie.toEntityTypeName);return t.jsxs("tr",{children:[t.jsx("td",{children:ee}),t.jsx("td",{children:ie.typeName||""}),t.jsx("td",{children:ce}),t.jsx("td",{children:t.jsx("span",{className:`visibility-badge ${ie.bidirectional?"badge-visible":"badge-hidden"}`,children:ie.bidirectional?"Yes":"No"})}),re&&t.jsx("td",{className:"actions-column",children:t.jsxs("div",{className:"entity-actions",children:[t.jsx("button",{type:"button",className:"icon-btn",onClick:()=>st(ie),title:"Edit relationship",disabled:_,children:t.jsx(Ga,{size:16})}),t.jsx("button",{type:"button",className:"icon-btn danger",onClick:()=>dt(ie),title:"Delete relationship",disabled:X===ie.id,children:t.jsx(zn,{size:16})})]})})]},ie.id)})})]})}):t.jsx("div",{className:"empty-state",children:$||H?t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"empty-title",children:"No relationships match your filters."}),t.jsx("button",{type:"button",className:"btn secondary",onClick:()=>{F(""),I("")},children:"Clear filters"})]}):re?t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"empty-title",children:"No relationships yet."}),t.jsxs("button",{type:"button",className:"btn submit",onClick:we,disabled:!Y,children:[t.jsx(Wn,{size:16})," Add your first relationship"]})]}):t.jsx("p",{className:"empty-title",children:"No relationships to display."})}):t.jsx("div",{className:"empty-state",children:"Select a campaign or world you own to view its relationships."}),p&&t.jsx(Ps,{isOpen:h,onClose:()=>y(!1),title:"Add Relationship",description:"Link two entities in this world.",size:"lg",children:t.jsx(C1,{worldId:Y,existingRelationships:v||[],onCreated:()=>{y(!1),ue(Y),de("Relationship created","success")},onCancel:()=>y(!1)})}),t.jsx(Ps,{isOpen:g,onClose:lt,title:Ct,size:"lg",footerActions:t.jsxs(t.Fragment,{children:[t.jsx("button",{type:"button",className:"btn cancel",onClick:lt,disabled:D.cancelDisabled,children:"Cancel"}),t.jsx("button",{type:"submit",className:"btn submit",form:le.current,disabled:D.submitDisabled,children:D.submitLabel})]}),children:t.jsx(C5,{worldId:Y,relationshipId:G,onCancel:lt,onSaved:Xe,onStateChange:Fe,formId:le.current,hideActions:!0})})]})}const M5=new Set(["system_admin"]),k5=e=>{if(!e)return"";const n=new Date(e);return Number.isNaN(n.getTime())?"":n.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})},vw=(e=[])=>!Array.isArray(e)||e.length===0?"":e.map(n=>n?.name||n?.label||"Unknown").filter(Boolean).join(", "),R5=e=>{if(!e)return"";const n=e.from_name||e.fromName||e.name||"",s=e.to_name||e.toName||e.name||"";return`${n}  ${s}`};function I5(){const e=_n(),n=Xa(),{user:s,token:i,sessionReady:l}=un(),{selectedCampaign:o}=wn(),[d,f]=u.useState([]),[p,h]=u.useState(!1),[y,g]=u.useState(""),[b,v]=u.useState(null),[S,N]=u.useState(""),j=u.useMemo(()=>{if(!o?.world)return"";const R=o.world;return R.created_by||R.creator?.id||R.owner_id||R.owner?.id||""},[o]),E=!!(s?.id&&j===s.id),A=u.useMemo(()=>s?s.role&&M5.has(s.role)?!0:E:!1,[s,E]),M=o?.world?.id??"",_=!!M,T=u.useRef(M),k=u.useMemo(()=>{if(!o)return"";const R=o.name||"Selected campaign",B=o.world?.name;return B?`${R}  ${B}`:R},[o]);u.useEffect(()=>{if(!b)return;const R=setTimeout(()=>v(null),3500);return()=>clearTimeout(R)},[b]);const C=u.useCallback((R,B="info")=>{v({message:R,tone:B})},[]),L=u.useCallback(()=>{e(n.pathname,{replace:!0,state:{}})},[n.pathname,e]);u.useEffect(()=>{if(n.state?.toast){const{message:R,tone:B}=n.state.toast;C(R,B),L()}},[n.state,C,L]),u.useEffect(()=>{T.current!==M&&(T.current=M,f([]),g(""),h(!1),v(null),N(""))},[M]);const z=u.useCallback(async()=>{if(!(!i||!A)){if(!M){f([]),g("");return}h(!0),g("");try{const R=await Bf({worldId:M}),B=Array.isArray(R)?R:Array.isArray(R?.data)?R.data:[];f(B)}catch(R){console.error(" Failed to load relationship types",R),f([]),g(R.message||"Failed to load relationship types")}finally{h(!1)}}},[i,A,M]);u.useEffect(()=>{if(!(!l||!i||!A)){if(!M){f([]),h(!1),g("");return}z()}},[l,i,A,M,z]);const G=()=>{!i||p||!_||!A||z()},U=()=>{!A||!_||e("/relationship-types/new")},X=R=>{!A||!R?.id||e(`/relationship-types/${R.id}/edit`)},V=async R=>{if(!(!A||!_||!R?.id||!window.confirm(`Delete relationship type "${R.name}"? This cannot be undone.`)))try{N(R.id),await b4(R.id),C("Relationship type deleted","success"),await z()}catch(D){console.error(" Failed to delete relationship type",D),C(D.message||"Failed to delete relationship type","error")}finally{N("")}};return l?i?A?t.jsxs("section",{className:"entity-types-page relationship-types-page",children:[t.jsxs("div",{className:"entity-types-header",children:[t.jsxs("div",{children:[t.jsx("h1",{children:"Relationship Types"}),o?t.jsxs("p",{className:"entity-types-subtitle",children:[k,_?`  ${d.length} types defined`:""]}):t.jsx("p",{className:"entity-types-subtitle",children:"Select a campaign from the header to choose a world context."})]}),t.jsxs("div",{className:"entity-types-actions",children:[t.jsx("button",{type:"button",className:"icon-btn",title:"Refresh",onClick:G,disabled:p||!_,children:t.jsx(Vi,{size:16})}),t.jsxs("button",{type:"button",className:"btn submit",onClick:U,disabled:p||!_,children:[t.jsx(Wn,{size:18})," Add Relationship Type"]})]})]}),b&&t.jsx("div",{className:`toast-banner ${b.tone}`,children:b.message}),y&&t.jsx("div",{className:"alert error",children:y}),t.jsx("div",{className:"entity-types-table-wrapper",children:_?p?t.jsx("div",{className:"empty-state",children:"Loading relationship types..."}):d.length===0?t.jsx("div",{className:"empty-state",children:"No relationship types defined yet."}):t.jsxs("table",{className:"entity-types-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Name"}),t.jsx("th",{children:"Directional Labels"}),t.jsx("th",{children:"World"}),t.jsx("th",{children:"Allowed Sources"}),t.jsx("th",{children:"Allowed Targets"}),t.jsx("th",{children:"Created"}),t.jsx("th",{className:"actions-column",children:"Actions"})]})}),t.jsx("tbody",{children:d.map(R=>{const B=R.createdAt||R.created_at;return t.jsxs("tr",{children:[t.jsx("td",{children:R.name}),t.jsx("td",{children:R5(R)}),t.jsx("td",{children:R.world?.name||""}),t.jsx("td",{children:vw(R.from_entity_types)}),t.jsx("td",{children:vw(R.to_entity_types)}),t.jsx("td",{children:k5(B)}),t.jsxs("td",{className:"actions-column",children:[t.jsx("button",{className:"icon-btn",title:"Edit",onClick:()=>X(R),disabled:p||S===R.id,children:t.jsx(Ga,{size:16})}),t.jsx("button",{className:"icon-btn danger",title:"Delete",onClick:()=>V(R),disabled:S===R.id,children:t.jsx(zn,{size:16})})]})]},R.id)})})]}):t.jsx("div",{className:"empty-state",children:"Select a campaign from the header to view relationship types."})})]}):t.jsxs("section",{className:"entity-types-page relationship-types-page",children:[t.jsx("div",{className:"entity-types-header",children:t.jsx("h1",{children:"Relationship Types"})}),t.jsx("div",{className:"alert info",children:"Only system administrators or the world owner can manage relationship types."})]}):t.jsx("p",{children:"Authenticating..."}):t.jsx("p",{children:"Restoring session..."})}const Sw=e=>Array.isArray(e)?[...new Set(e.map(n=>n?String(n):"").filter(Boolean))]:[],ww=(e={})=>({name:e?.name||"",fromName:e?.from_name||e?.fromName||"",toName:e?.to_name||e?.toName||"",description:e?.description||"",worldId:e?.world?.id||e?.world_id||"",fromEntityTypeIds:Sw((e?.from_entity_types||[]).map(n=>n?.id||n?.entity_type_id)),toEntityTypeIds:Sw((e?.to_entity_types||[]).map(n=>n?.id||n?.entity_type_id))}),Nw=(e=[],n=[])=>{if(e.length!==n.length)return!1;const s=[...e].sort(),i=[...n].sort();return s.every((l,o)=>l===i[o])};function V1({initialValues:e={},entityTypes:n=[],worlds:s=[],saving:i=!1,optionsLoading:l=!1,errorMessage:o="",onSubmit:d,onCancel:f}){const p=u.useMemo(()=>ww(e),[e]),[h,y]=u.useState(p),[g,b]=u.useState("");u.useEffect(()=>{y(ww(e)),b("")},[e]),u.useEffect(()=>{b(o||"")},[o]);const v=u.useMemo(()=>h.name!==p.name||h.fromName!==p.fromName||h.toName!==p.toName||h.description!==p.description||h.worldId!==p.worldId||!Nw(h.fromEntityTypeIds,p.fromEntityTypeIds)||!Nw(h.toEntityTypeIds,p.toEntityTypeIds),[p,h]),S=u.useMemo(()=>Array.isArray(n)?n.map(M=>{const _=M?.id||M?.entity_type_id||M?.entityTypeId||M?.value||"";if(!_)return null;const T=M?.world_id||M?.worldId||M?.world?.id||"";return{value:String(_),label:M?.name||M?.label||"Untitled type",worldId:T?String(T):""}}).filter(Boolean):[],[n]),N=u.useMemo(()=>{const M=h.worldId?String(h.worldId):"";return M?S.filter(_=>_.worldId===M):[]},[S,h.worldId]);u.useEffect(()=>{if(!(h.worldId?String(h.worldId):"")){y(T=>T.fromEntityTypeIds.length===0&&T.toEntityTypeIds.length===0?T:{...T,fromEntityTypeIds:[],toEntityTypeIds:[]});return}const _=new Set(N.map(T=>T.value));y(T=>{const k=T.fromEntityTypeIds.filter(L=>_.has(String(L))),C=T.toEntityTypeIds.filter(L=>_.has(String(L)));return k.length===T.fromEntityTypeIds.length&&C.length===T.toEntityTypeIds.length?T:{...T,fromEntityTypeIds:k,toEntityTypeIds:C}})},[N,h.worldId]);const j=M=>_=>{const{value:T}=_.target;y(k=>({...k,[M]:T}))},E=M=>(_=[])=>{const T=Array.isArray(_)?_:[];y(k=>({...k,[M]:T}))},A=async M=>{M.preventDefault();const _=h.name.trim(),T=h.fromName.trim(),k=h.toName.trim();if(!_)return b("Name is required.");if(!T)return b("Provide a label for the source direction.");if(!k)return b("Provide a label for the target direction.");if(!h.worldId)return b("Select a world for this relationship type.");if(!h.fromEntityTypeIds.length)return b("Select at least one allowed source entity type.");if(!h.toEntityTypeIds.length)return b("Select at least one allowed target entity type.");b("");const C={name:_,from_name:T,to_name:k,description:h.description?.trim()||"",world_id:h.worldId,from_entity_type_ids:h.fromEntityTypeIds,to_entity_type_ids:h.toEntityTypeIds};try{if(await d?.(C)===!1)return}catch(L){b(L.message||"Failed to save relationship type")}};return t.jsxs("form",{className:"relationship-type-form",onSubmit:A,children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"relationship-type-name",children:"Name *"}),t.jsx("input",{id:"relationship-type-name",type:"text",value:h.name,onChange:j("name"),placeholder:"e.g. Enemy",disabled:i||l,autoFocus:!0})]}),t.jsxs("div",{className:"form-two-column",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"relationship-type-from-name",children:"Source relationship label *"}),t.jsx("input",{id:"relationship-type-from-name",type:"text",value:h.fromName,onChange:j("fromName"),placeholder:"e.g. Parent of",disabled:i||l})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"relationship-type-to-name",children:"Target relationship label *"}),t.jsx("input",{id:"relationship-type-to-name",type:"text",value:h.toName,onChange:j("toName"),placeholder:"e.g. Child of",disabled:i||l})]})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"relationship-type-description",children:"Description"}),t.jsx("textarea",{id:"relationship-type-description",value:h.description,onChange:j("description"),placeholder:"Optional description",rows:4,disabled:i||l,className:"textarea-field"})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"relationship-type-world",children:"World *"}),t.jsxs("select",{id:"relationship-type-world",value:h.worldId,onChange:j("worldId"),disabled:i||l,required:!0,children:[t.jsx("option",{value:"",children:"Select world..."}),s.map(M=>t.jsx("option",{value:M.id,children:M.name},M.id))]})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"relationship-type-from-entities",children:"Allowed source entity types *"}),t.jsx(zs,{selected:h.fromEntityTypeIds,options:N,onChange:E("fromEntityTypeIds"),placeholder:"Search entity types...",disabled:i||l,loading:l,noOptionsMessage:h.worldId?"No entity types available for this world.":"Select a world to choose entity types."})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"relationship-type-to-entities",children:"Allowed target entity types *"}),t.jsx(zs,{selected:h.toEntityTypeIds,options:N,onChange:E("toEntityTypeIds"),placeholder:"Search entity types...",disabled:i||l,loading:l,noOptionsMessage:h.worldId?"No entity types available for this world.":"Select a world to choose entity types."})]}),g&&t.jsx("div",{className:"form-error",children:g}),t.jsxs("div",{className:"form-actions",children:[t.jsx("button",{type:"button",className:"btn cancel",onClick:f,disabled:i,children:"Cancel"}),t.jsx("button",{type:"submit",className:"btn submit",disabled:i||l||!v,children:i?"Saving...":"Save"})]})]})}function L5(){const e=_n(),{user:n,token:s,sessionReady:i}=un(),{selectedCampaign:l}=wn(),[o,d]=u.useState([]),[f,p]=u.useState(!1),[h,y]=u.useState(""),[g,b]=u.useState(""),[v,S]=u.useState(!1),N=u.useMemo(()=>{if(!l?.world)return"";const C=l.world;return C.created_by||C.creator?.id||C.owner_id||C.owner?.id||""},[l]),j=!!(n?.id&&N===n.id),E=u.useMemo(()=>n?n.role==="system_admin"?!0:j:!1,[n,j]),A=l?.world?.id??"",M=u.useMemo(()=>{if(!l?.world?.id)return[];const C=l.world;return[{id:C.id,name:C.name||"Untitled world"}]},[l]),_=u.useCallback(async()=>{if(!s||!A){d([]),y("Select a campaign to choose a world context before creating relationship types.");return}p(!0),y("");try{const C=await wr({worldId:A}),L=Array.isArray(C?.data)?C.data:Array.isArray(C)?C:[];d(L)}catch(C){console.error(" Failed to load relationship type options",C),d([]),y(C.message||"Failed to load supporting data")}finally{p(!1)}},[s,A]);if(u.useEffect(()=>{!i||!s||_()},[i,s,_]),!i)return t.jsx("p",{children:"Restoring session..."});if(!s)return t.jsx("p",{children:"Authenticating..."});if(!E)return t.jsxs("section",{className:"page relationship-type-form-page limited-access",children:[t.jsx("h1",{children:"Create Relationship Type"}),t.jsx("p",{children:"Only system administrators or the world owner can create relationship types."}),t.jsx("button",{type:"button",className:"btn cancel",onClick:()=>e("/relationship-types"),children:"Back to Relationship Types"})]});if(!A)return t.jsxs("section",{className:"page relationship-type-form-page",children:[t.jsx("h1",{children:"Create Relationship Type"}),t.jsx("p",{children:"Select a campaign from the header to choose a world context before creating relationship types."}),t.jsx("button",{type:"button",className:"btn cancel",onClick:()=>e("/relationship-types"),children:"Back to Relationship Types"})]});const T=()=>e("/relationship-types"),k=async C=>{if(v)return!1;b(""),S(!0);try{const L={...C,world_id:C.world_id??C.worldId??C.world?.id??A};if(!L.world_id)throw new Error("A world must be selected before creating a relationship type");console.log(" Final payload being sent:",L);const z=await y4(L),G=z?.data??z;if(!G||!G.id)throw new Error("Failed to create relationship type");return e("/relationship-types",{state:{toast:{message:"Relationship type created",tone:"success"}}}),!0}catch(L){return console.error(" Failed to create relationship type",L),b(L.message||"Failed to create relationship type"),!1}finally{S(!1)}};return t.jsxs("section",{className:"page relationship-type-form-page",children:[t.jsx("h1",{children:"Create Relationship Type"}),t.jsx("p",{className:"page-subtitle",children:"Define the directional names and allowed entity types for this relationship."}),h&&t.jsx("div",{className:"alert error",children:h}),t.jsx(V1,{initialValues:{world_id:A},entityTypes:o,worlds:M,saving:v,optionsLoading:f,errorMessage:g,onSubmit:k,onCancel:T})]})}function D5(){const e=_n(),{id:n}=Ka(),{user:s,token:i,sessionReady:l}=un(),{selectedCampaign:o}=wn(),[d,f]=u.useState([]),[p,h]=u.useState(!1),[y,g]=u.useState(""),[b,v]=u.useState(""),[S,N]=u.useState(null),[j,E]=u.useState(!0),[A,M]=u.useState(""),[_,T]=u.useState(!1),k=s?.role==="system_admin",C=u.useMemo(()=>{if(!o||!s)return!1;const $=o.world?.created_by??o.world?.creator?.id??o.world?.owner_id??o.world?.owner?.id??"";return $?$===s.id:!1},[o,s]),L=u.useMemo(()=>!!(k||C),[k,C]),z=o?.world?.id??"",G=o?.world?.name??"",U=u.useMemo(()=>{if(!S)return null;const $=S?.world?.id||S?.world_id||S?.worldId||"";if(!$)return null;const F=S?.world?.name||S?.world_name||S?.worldName||"";return{id:$,name:F||"Untitled world"}},[S]),[X,V]=u.useState([]);u.useEffect(()=>{const $=[];z&&$.push({id:z,name:G||"Untitled world"}),U&&!$.some(F=>F.id===U.id)&&$.push(U),V($)},[z,G,U]);const R=u.useCallback(async()=>{if(i){h(!0),g("");try{const $=z||U?.id||S?.world?.id||S?.world_id||"";if(!$){f([]),g("Select a campaign to choose a world context before editing relationship types.");return}const F=await wr({worldId:$}),H=Array.isArray(F?.data)?F.data:Array.isArray(F)?F:[];f(H)}catch($){console.error(" Failed to load relationship type options",$),f([]),g($.message||"Failed to load supporting data")}finally{h(!1)}}},[i,z,U,S]),B=u.useCallback(async()=>{if(!(!i||!n)){E(!0),M("");try{const $=await p4(n),F=$?.data??$;if(!F)throw new Error("Relationship type not found");N(F)}catch($){console.error(" Failed to load relationship type",$),M($.message||"Failed to load relationship type"),N(null)}finally{E(!1)}}},[n,i]);if(u.useEffect(()=>{!l||!i||B()},[l,i,B]),u.useEffect(()=>{!l||!i||j||R()},[l,i,j,R]),!l)return t.jsx("p",{children:"Restoring session..."});if(!i)return t.jsx("p",{children:"Authenticating..."});if(!L)return t.jsxs("section",{className:"page relationship-type-form-page limited-access",children:[t.jsx("h1",{children:"Edit Relationship Type"}),t.jsx("p",{children:"Only system administrators can edit relationship types."}),t.jsx("button",{type:"button",className:"btn cancel",onClick:()=>e("/relationship-types"),children:"Back to Relationship Types"})]});const D=()=>e("/relationship-types"),O=async $=>{if(_||!n)return!1;v(""),T(!0);try{const F={...$,world_id:$.world_id||$.worldId||$.selectedWorldId||$.world?.id||z||S?.world_id};if(!F.world_id)throw new Error("A world must be selected before saving changes");const H=await g4(n,F),I=H?.data??H;if(!I||!I.id)throw new Error("Failed to update relationship type");return e("/relationship-types",{state:{toast:{message:"Relationship type updated",tone:"success"}}}),!0}catch(F){return console.error(" Failed to update relationship type",F),v(F.message||"Failed to update relationship type"),!1}finally{T(!1)}};return j?t.jsxs("section",{className:"page relationship-type-form-page",children:[t.jsx("h1",{children:"Edit Relationship Type"}),t.jsx("div",{className:"form-status",children:"Loading relationship type..."})]}):A||!S?t.jsxs("section",{className:"page relationship-type-form-page",children:[t.jsx("h1",{children:"Edit Relationship Type"}),t.jsx("div",{className:"alert error",children:A||"Relationship type not found."}),t.jsx("button",{type:"button",className:"btn cancel",onClick:()=>e("/relationship-types"),children:"Back to Relationship Types"})]}):t.jsxs("section",{className:"page relationship-type-form-page",children:[t.jsx("h1",{children:"Edit Relationship Type"}),t.jsx("p",{className:"page-subtitle",children:"Update the directional labels or allowed entity types for this relationship."}),y&&t.jsx("div",{className:"alert error",children:y}),t.jsx(V1,{initialValues:S,entityTypes:d,worlds:X,saving:_,optionsLoading:p,errorMessage:b,onSubmit:O,onCancel:D})]})}function O5(){return t.jsx("section",{className:"page-placeholder",children:t.jsx("h1",{children:"Entity Secrets Page  Coming Soon"})})}function $5({children:e}){const{token:n,sessionReady:s}=un();return s?n?e:t.jsx(gc,{to:"/login",replace:!0}):t.jsx("p",{children:"Restoring session..."})}function ma(e){if(typeof e=="string"||typeof e=="number")return""+e;let n="";if(Array.isArray(e))for(let s=0,i;s<e.length;s++)(i=ma(e[s]))!==""&&(n+=(n&&" ")+i);else for(let s in e)e[s]&&(n+=(n&&" ")+s);return n}var zp={exports:{}},Bp={},Up={exports:{}},qp={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var jw;function F5(){if(jw)return qp;jw=1;var e=qc();function n(g,b){return g===b&&(g!==0||1/g===1/b)||g!==g&&b!==b}var s=typeof Object.is=="function"?Object.is:n,i=e.useState,l=e.useEffect,o=e.useLayoutEffect,d=e.useDebugValue;function f(g,b){var v=b(),S=i({inst:{value:v,getSnapshot:b}}),N=S[0].inst,j=S[1];return o(function(){N.value=v,N.getSnapshot=b,p(N)&&j({inst:N})},[g,v,b]),l(function(){return p(N)&&j({inst:N}),g(function(){p(N)&&j({inst:N})})},[g]),d(v),v}function p(g){var b=g.getSnapshot;g=g.value;try{var v=b();return!s(g,v)}catch{return!0}}function h(g,b){return b()}var y=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?h:f;return qp.useSyncExternalStore=e.useSyncExternalStore!==void 0?e.useSyncExternalStore:y,qp}var Ew;function z5(){return Ew||(Ew=1,Up.exports=F5()),Up.exports}/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var _w;function B5(){if(_w)return Bp;_w=1;var e=qc(),n=z5();function s(h,y){return h===y&&(h!==0||1/h===1/y)||h!==h&&y!==y}var i=typeof Object.is=="function"?Object.is:s,l=n.useSyncExternalStore,o=e.useRef,d=e.useEffect,f=e.useMemo,p=e.useDebugValue;return Bp.useSyncExternalStoreWithSelector=function(h,y,g,b,v){var S=o(null);if(S.current===null){var N={hasValue:!1,value:null};S.current=N}else N=S.current;S=f(function(){function E(k){if(!A){if(A=!0,M=k,k=b(k),v!==void 0&&N.hasValue){var C=N.value;if(v(C,k))return _=C}return _=k}if(C=_,i(M,k))return C;var L=b(k);return v!==void 0&&v(C,L)?(M=k,C):(M=k,_=L)}var A=!1,M,_,T=g===void 0?null:g;return[function(){return E(y())},T===null?void 0:function(){return E(T())}]},[y,g,b,v]);var j=l(h,S[0],S[1]);return d(function(){N.hasValue=!0,N.value=j},[j]),p(j),j},Bp}var Cw;function U5(){return Cw||(Cw=1,zp.exports=B5()),zp.exports}var q5=U5();const P5=Pi(q5),H5={},Aw=e=>{let n;const s=new Set,i=(y,g)=>{const b=typeof y=="function"?y(n):y;if(!Object.is(b,n)){const v=n;n=g??(typeof b!="object"||b===null)?b:Object.assign({},n,b),s.forEach(S=>S(n,v))}},l=()=>n,p={setState:i,getState:l,getInitialState:()=>h,subscribe:y=>(s.add(y),()=>s.delete(y)),destroy:()=>{(H5?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),s.clear()}},h=n=e(i,l,p);return p},V5=e=>e?Aw(e):Aw,{useDebugValue:Y5}=Ze,{useSyncExternalStoreWithSelector:G5}=P5,W5=e=>e;function Y1(e,n=W5,s){const i=G5(e.subscribe,e.getState,e.getServerState||e.getInitialState,n,s);return Y5(i),i}const Tw=(e,n)=>{const s=V5(e),i=(l,o=n)=>Y1(s,l,o);return Object.assign(i,s),i},X5=(e,n)=>e?Tw(e,n):Tw;function la(e,n){if(Object.is(e,n))return!0;if(typeof e!="object"||e===null||typeof n!="object"||n===null)return!1;if(e instanceof Map&&n instanceof Map){if(e.size!==n.size)return!1;for(const[i,l]of e)if(!Object.is(l,n.get(i)))return!1;return!0}if(e instanceof Set&&n instanceof Set){if(e.size!==n.size)return!1;for(const i of e)if(!n.has(i))return!1;return!0}const s=Object.keys(e);if(s.length!==Object.keys(n).length)return!1;for(const i of s)if(!Object.prototype.hasOwnProperty.call(n,i)||!Object.is(e[i],n[i]))return!1;return!0}var K5={value:()=>{}};function qf(){for(var e=0,n=arguments.length,s={},i;e<n;++e){if(!(i=arguments[e]+"")||i in s||/[\s.]/.test(i))throw new Error("illegal type: "+i);s[i]=[]}return new Pd(s)}function Pd(e){this._=e}function Z5(e,n){return e.trim().split(/^|\s+/).map(function(s){var i="",l=s.indexOf(".");if(l>=0&&(i=s.slice(l+1),s=s.slice(0,l)),s&&!n.hasOwnProperty(s))throw new Error("unknown type: "+s);return{type:s,name:i}})}Pd.prototype=qf.prototype={constructor:Pd,on:function(e,n){var s=this._,i=Z5(e+"",s),l,o=-1,d=i.length;if(arguments.length<2){for(;++o<d;)if((l=(e=i[o]).type)&&(l=Q5(s[l],e.name)))return l;return}if(n!=null&&typeof n!="function")throw new Error("invalid callback: "+n);for(;++o<d;)if(l=(e=i[o]).type)s[l]=Mw(s[l],e.name,n);else if(n==null)for(l in s)s[l]=Mw(s[l],e.name,null);return this},copy:function(){var e={},n=this._;for(var s in n)e[s]=n[s].slice();return new Pd(e)},call:function(e,n){if((l=arguments.length-2)>0)for(var s=new Array(l),i=0,l,o;i<l;++i)s[i]=arguments[i+2];if(!this._.hasOwnProperty(e))throw new Error("unknown type: "+e);for(o=this._[e],i=0,l=o.length;i<l;++i)o[i].value.apply(n,s)},apply:function(e,n,s){if(!this._.hasOwnProperty(e))throw new Error("unknown type: "+e);for(var i=this._[e],l=0,o=i.length;l<o;++l)i[l].value.apply(n,s)}};function Q5(e,n){for(var s=0,i=e.length,l;s<i;++s)if((l=e[s]).name===n)return l.value}function Mw(e,n,s){for(var i=0,l=e.length;i<l;++i)if(e[i].name===n){e[i]=K5,e=e.slice(0,i).concat(e.slice(i+1));break}return s!=null&&e.push({name:n,value:s}),e}var Ly="http://www.w3.org/1999/xhtml";const kw={svg:"http://www.w3.org/2000/svg",xhtml:Ly,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function Pf(e){var n=e+="",s=n.indexOf(":");return s>=0&&(n=e.slice(0,s))!=="xmlns"&&(e=e.slice(s+1)),kw.hasOwnProperty(n)?{space:kw[n],local:e}:e}function J5(e){return function(){var n=this.ownerDocument,s=this.namespaceURI;return s===Ly&&n.documentElement.namespaceURI===Ly?n.createElement(e):n.createElementNS(s,e)}}function eO(e){return function(){return this.ownerDocument.createElementNS(e.space,e.local)}}function G1(e){var n=Pf(e);return(n.local?eO:J5)(n)}function tO(){}function Yg(e){return e==null?tO:function(){return this.querySelector(e)}}function nO(e){typeof e!="function"&&(e=Yg(e));for(var n=this._groups,s=n.length,i=new Array(s),l=0;l<s;++l)for(var o=n[l],d=o.length,f=i[l]=new Array(d),p,h,y=0;y<d;++y)(p=o[y])&&(h=e.call(p,p.__data__,y,o))&&("__data__"in p&&(h.__data__=p.__data__),f[y]=h);return new Wa(i,this._parents)}function aO(e){return e==null?[]:Array.isArray(e)?e:Array.from(e)}function sO(){return[]}function W1(e){return e==null?sO:function(){return this.querySelectorAll(e)}}function rO(e){return function(){return aO(e.apply(this,arguments))}}function iO(e){typeof e=="function"?e=rO(e):e=W1(e);for(var n=this._groups,s=n.length,i=[],l=[],o=0;o<s;++o)for(var d=n[o],f=d.length,p,h=0;h<f;++h)(p=d[h])&&(i.push(e.call(p,p.__data__,h,d)),l.push(p));return new Wa(i,l)}function X1(e){return function(){return this.matches(e)}}function K1(e){return function(n){return n.matches(e)}}var lO=Array.prototype.find;function oO(e){return function(){return lO.call(this.children,e)}}function cO(){return this.firstElementChild}function uO(e){return this.select(e==null?cO:oO(typeof e=="function"?e:K1(e)))}var dO=Array.prototype.filter;function fO(){return Array.from(this.children)}function mO(e){return function(){return dO.call(this.children,e)}}function hO(e){return this.selectAll(e==null?fO:mO(typeof e=="function"?e:K1(e)))}function pO(e){typeof e!="function"&&(e=X1(e));for(var n=this._groups,s=n.length,i=new Array(s),l=0;l<s;++l)for(var o=n[l],d=o.length,f=i[l]=[],p,h=0;h<d;++h)(p=o[h])&&e.call(p,p.__data__,h,o)&&f.push(p);return new Wa(i,this._parents)}function Z1(e){return new Array(e.length)}function yO(){return new Wa(this._enter||this._groups.map(Z1),this._parents)}function rf(e,n){this.ownerDocument=e.ownerDocument,this.namespaceURI=e.namespaceURI,this._next=null,this._parent=e,this.__data__=n}rf.prototype={constructor:rf,appendChild:function(e){return this._parent.insertBefore(e,this._next)},insertBefore:function(e,n){return this._parent.insertBefore(e,n)},querySelector:function(e){return this._parent.querySelector(e)},querySelectorAll:function(e){return this._parent.querySelectorAll(e)}};function gO(e){return function(){return e}}function bO(e,n,s,i,l,o){for(var d=0,f,p=n.length,h=o.length;d<h;++d)(f=n[d])?(f.__data__=o[d],i[d]=f):s[d]=new rf(e,o[d]);for(;d<p;++d)(f=n[d])&&(l[d]=f)}function xO(e,n,s,i,l,o,d){var f,p,h=new Map,y=n.length,g=o.length,b=new Array(y),v;for(f=0;f<y;++f)(p=n[f])&&(b[f]=v=d.call(p,p.__data__,f,n)+"",h.has(v)?l[f]=p:h.set(v,p));for(f=0;f<g;++f)v=d.call(e,o[f],f,o)+"",(p=h.get(v))?(i[f]=p,p.__data__=o[f],h.delete(v)):s[f]=new rf(e,o[f]);for(f=0;f<y;++f)(p=n[f])&&h.get(b[f])===p&&(l[f]=p)}function vO(e){return e.__data__}function SO(e,n){if(!arguments.length)return Array.from(this,vO);var s=n?xO:bO,i=this._parents,l=this._groups;typeof e!="function"&&(e=gO(e));for(var o=l.length,d=new Array(o),f=new Array(o),p=new Array(o),h=0;h<o;++h){var y=i[h],g=l[h],b=g.length,v=wO(e.call(y,y&&y.__data__,h,i)),S=v.length,N=f[h]=new Array(S),j=d[h]=new Array(S),E=p[h]=new Array(b);s(y,g,N,j,E,v,n);for(var A=0,M=0,_,T;A<S;++A)if(_=N[A]){for(A>=M&&(M=A+1);!(T=j[M])&&++M<S;);_._next=T||null}}return d=new Wa(d,i),d._enter=f,d._exit=p,d}function wO(e){return typeof e=="object"&&"length"in e?e:Array.from(e)}function NO(){return new Wa(this._exit||this._groups.map(Z1),this._parents)}function jO(e,n,s){var i=this.enter(),l=this,o=this.exit();return typeof e=="function"?(i=e(i),i&&(i=i.selection())):i=i.append(e+""),n!=null&&(l=n(l),l&&(l=l.selection())),s==null?o.remove():s(o),i&&l?i.merge(l).order():l}function EO(e){for(var n=e.selection?e.selection():e,s=this._groups,i=n._groups,l=s.length,o=i.length,d=Math.min(l,o),f=new Array(l),p=0;p<d;++p)for(var h=s[p],y=i[p],g=h.length,b=f[p]=new Array(g),v,S=0;S<g;++S)(v=h[S]||y[S])&&(b[S]=v);for(;p<l;++p)f[p]=s[p];return new Wa(f,this._parents)}function _O(){for(var e=this._groups,n=-1,s=e.length;++n<s;)for(var i=e[n],l=i.length-1,o=i[l],d;--l>=0;)(d=i[l])&&(o&&d.compareDocumentPosition(o)^4&&o.parentNode.insertBefore(d,o),o=d);return this}function CO(e){e||(e=AO);function n(g,b){return g&&b?e(g.__data__,b.__data__):!g-!b}for(var s=this._groups,i=s.length,l=new Array(i),o=0;o<i;++o){for(var d=s[o],f=d.length,p=l[o]=new Array(f),h,y=0;y<f;++y)(h=d[y])&&(p[y]=h);p.sort(n)}return new Wa(l,this._parents).order()}function AO(e,n){return e<n?-1:e>n?1:e>=n?0:NaN}function TO(){var e=arguments[0];return arguments[0]=this,e.apply(null,arguments),this}function MO(){return Array.from(this)}function kO(){for(var e=this._groups,n=0,s=e.length;n<s;++n)for(var i=e[n],l=0,o=i.length;l<o;++l){var d=i[l];if(d)return d}return null}function RO(){let e=0;for(const n of this)++e;return e}function IO(){return!this.node()}function LO(e){for(var n=this._groups,s=0,i=n.length;s<i;++s)for(var l=n[s],o=0,d=l.length,f;o<d;++o)(f=l[o])&&e.call(f,f.__data__,o,l);return this}function DO(e){return function(){this.removeAttribute(e)}}function OO(e){return function(){this.removeAttributeNS(e.space,e.local)}}function $O(e,n){return function(){this.setAttribute(e,n)}}function FO(e,n){return function(){this.setAttributeNS(e.space,e.local,n)}}function zO(e,n){return function(){var s=n.apply(this,arguments);s==null?this.removeAttribute(e):this.setAttribute(e,s)}}function BO(e,n){return function(){var s=n.apply(this,arguments);s==null?this.removeAttributeNS(e.space,e.local):this.setAttributeNS(e.space,e.local,s)}}function UO(e,n){var s=Pf(e);if(arguments.length<2){var i=this.node();return s.local?i.getAttributeNS(s.space,s.local):i.getAttribute(s)}return this.each((n==null?s.local?OO:DO:typeof n=="function"?s.local?BO:zO:s.local?FO:$O)(s,n))}function Q1(e){return e.ownerDocument&&e.ownerDocument.defaultView||e.document&&e||e.defaultView}function qO(e){return function(){this.style.removeProperty(e)}}function PO(e,n,s){return function(){this.style.setProperty(e,n,s)}}function HO(e,n,s){return function(){var i=n.apply(this,arguments);i==null?this.style.removeProperty(e):this.style.setProperty(e,i,s)}}function VO(e,n,s){return arguments.length>1?this.each((n==null?qO:typeof n=="function"?HO:PO)(e,n,s??"")):Wl(this.node(),e)}function Wl(e,n){return e.style.getPropertyValue(n)||Q1(e).getComputedStyle(e,null).getPropertyValue(n)}function YO(e){return function(){delete this[e]}}function GO(e,n){return function(){this[e]=n}}function WO(e,n){return function(){var s=n.apply(this,arguments);s==null?delete this[e]:this[e]=s}}function XO(e,n){return arguments.length>1?this.each((n==null?YO:typeof n=="function"?WO:GO)(e,n)):this.node()[e]}function J1(e){return e.trim().split(/^|\s+/)}function Gg(e){return e.classList||new eE(e)}function eE(e){this._node=e,this._names=J1(e.getAttribute("class")||"")}eE.prototype={add:function(e){var n=this._names.indexOf(e);n<0&&(this._names.push(e),this._node.setAttribute("class",this._names.join(" ")))},remove:function(e){var n=this._names.indexOf(e);n>=0&&(this._names.splice(n,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(e){return this._names.indexOf(e)>=0}};function tE(e,n){for(var s=Gg(e),i=-1,l=n.length;++i<l;)s.add(n[i])}function nE(e,n){for(var s=Gg(e),i=-1,l=n.length;++i<l;)s.remove(n[i])}function KO(e){return function(){tE(this,e)}}function ZO(e){return function(){nE(this,e)}}function QO(e,n){return function(){(n.apply(this,arguments)?tE:nE)(this,e)}}function JO(e,n){var s=J1(e+"");if(arguments.length<2){for(var i=Gg(this.node()),l=-1,o=s.length;++l<o;)if(!i.contains(s[l]))return!1;return!0}return this.each((typeof n=="function"?QO:n?KO:ZO)(s,n))}function e6(){this.textContent=""}function t6(e){return function(){this.textContent=e}}function n6(e){return function(){var n=e.apply(this,arguments);this.textContent=n??""}}function a6(e){return arguments.length?this.each(e==null?e6:(typeof e=="function"?n6:t6)(e)):this.node().textContent}function s6(){this.innerHTML=""}function r6(e){return function(){this.innerHTML=e}}function i6(e){return function(){var n=e.apply(this,arguments);this.innerHTML=n??""}}function l6(e){return arguments.length?this.each(e==null?s6:(typeof e=="function"?i6:r6)(e)):this.node().innerHTML}function o6(){this.nextSibling&&this.parentNode.appendChild(this)}function c6(){return this.each(o6)}function u6(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function d6(){return this.each(u6)}function f6(e){var n=typeof e=="function"?e:G1(e);return this.select(function(){return this.appendChild(n.apply(this,arguments))})}function m6(){return null}function h6(e,n){var s=typeof e=="function"?e:G1(e),i=n==null?m6:typeof n=="function"?n:Yg(n);return this.select(function(){return this.insertBefore(s.apply(this,arguments),i.apply(this,arguments)||null)})}function p6(){var e=this.parentNode;e&&e.removeChild(this)}function y6(){return this.each(p6)}function g6(){var e=this.cloneNode(!1),n=this.parentNode;return n?n.insertBefore(e,this.nextSibling):e}function b6(){var e=this.cloneNode(!0),n=this.parentNode;return n?n.insertBefore(e,this.nextSibling):e}function x6(e){return this.select(e?b6:g6)}function v6(e){return arguments.length?this.property("__data__",e):this.node().__data__}function S6(e){return function(n){e.call(this,n,this.__data__)}}function w6(e){return e.trim().split(/^|\s+/).map(function(n){var s="",i=n.indexOf(".");return i>=0&&(s=n.slice(i+1),n=n.slice(0,i)),{type:n,name:s}})}function N6(e){return function(){var n=this.__on;if(n){for(var s=0,i=-1,l=n.length,o;s<l;++s)o=n[s],(!e.type||o.type===e.type)&&o.name===e.name?this.removeEventListener(o.type,o.listener,o.options):n[++i]=o;++i?n.length=i:delete this.__on}}}function j6(e,n,s){return function(){var i=this.__on,l,o=S6(n);if(i){for(var d=0,f=i.length;d<f;++d)if((l=i[d]).type===e.type&&l.name===e.name){this.removeEventListener(l.type,l.listener,l.options),this.addEventListener(l.type,l.listener=o,l.options=s),l.value=n;return}}this.addEventListener(e.type,o,s),l={type:e.type,name:e.name,value:n,listener:o,options:s},i?i.push(l):this.__on=[l]}}function E6(e,n,s){var i=w6(e+""),l,o=i.length,d;if(arguments.length<2){var f=this.node().__on;if(f){for(var p=0,h=f.length,y;p<h;++p)for(l=0,y=f[p];l<o;++l)if((d=i[l]).type===y.type&&d.name===y.name)return y.value}return}for(f=n?j6:N6,l=0;l<o;++l)this.each(f(i[l],n,s));return this}function aE(e,n,s){var i=Q1(e),l=i.CustomEvent;typeof l=="function"?l=new l(n,s):(l=i.document.createEvent("Event"),s?(l.initEvent(n,s.bubbles,s.cancelable),l.detail=s.detail):l.initEvent(n,!1,!1)),e.dispatchEvent(l)}function _6(e,n){return function(){return aE(this,e,n)}}function C6(e,n){return function(){return aE(this,e,n.apply(this,arguments))}}function A6(e,n){return this.each((typeof n=="function"?C6:_6)(e,n))}function*T6(){for(var e=this._groups,n=0,s=e.length;n<s;++n)for(var i=e[n],l=0,o=i.length,d;l<o;++l)(d=i[l])&&(yield d)}var sE=[null];function Wa(e,n){this._groups=e,this._parents=n}function Kc(){return new Wa([[document.documentElement]],sE)}function M6(){return this}Wa.prototype=Kc.prototype={constructor:Wa,select:nO,selectAll:iO,selectChild:uO,selectChildren:hO,filter:pO,data:SO,enter:yO,exit:NO,join:jO,merge:EO,selection:M6,order:_O,sort:CO,call:TO,nodes:MO,node:kO,size:RO,empty:IO,each:LO,attr:UO,style:VO,property:XO,classed:JO,text:a6,html:l6,raise:c6,lower:d6,append:f6,insert:h6,remove:y6,clone:x6,datum:v6,on:E6,dispatch:A6,[Symbol.iterator]:T6};function ls(e){return typeof e=="string"?new Wa([[document.querySelector(e)]],[document.documentElement]):new Wa([[e]],sE)}function k6(e){let n;for(;n=e.sourceEvent;)e=n;return e}function ws(e,n){if(e=k6(e),n===void 0&&(n=e.currentTarget),n){var s=n.ownerSVGElement||n;if(s.createSVGPoint){var i=s.createSVGPoint();return i.x=e.clientX,i.y=e.clientY,i=i.matrixTransform(n.getScreenCTM().inverse()),[i.x,i.y]}if(n.getBoundingClientRect){var l=n.getBoundingClientRect();return[e.clientX-l.left-n.clientLeft,e.clientY-l.top-n.clientTop]}}return[e.pageX,e.pageY]}const R6={passive:!1},Lc={capture:!0,passive:!1};function Pp(e){e.stopImmediatePropagation()}function Bl(e){e.preventDefault(),e.stopImmediatePropagation()}function rE(e){var n=e.document.documentElement,s=ls(e).on("dragstart.drag",Bl,Lc);"onselectstart"in n?s.on("selectstart.drag",Bl,Lc):(n.__noselect=n.style.MozUserSelect,n.style.MozUserSelect="none")}function iE(e,n){var s=e.document.documentElement,i=ls(e).on("dragstart.drag",null);n&&(i.on("click.drag",Bl,Lc),setTimeout(function(){i.on("click.drag",null)},0)),"onselectstart"in s?i.on("selectstart.drag",null):(s.style.MozUserSelect=s.__noselect,delete s.__noselect)}const vd=e=>()=>e;function Dy(e,{sourceEvent:n,subject:s,target:i,identifier:l,active:o,x:d,y:f,dx:p,dy:h,dispatch:y}){Object.defineProperties(this,{type:{value:e,enumerable:!0,configurable:!0},sourceEvent:{value:n,enumerable:!0,configurable:!0},subject:{value:s,enumerable:!0,configurable:!0},target:{value:i,enumerable:!0,configurable:!0},identifier:{value:l,enumerable:!0,configurable:!0},active:{value:o,enumerable:!0,configurable:!0},x:{value:d,enumerable:!0,configurable:!0},y:{value:f,enumerable:!0,configurable:!0},dx:{value:p,enumerable:!0,configurable:!0},dy:{value:h,enumerable:!0,configurable:!0},_:{value:y}})}Dy.prototype.on=function(){var e=this._.on.apply(this._,arguments);return e===this._?this:e};function I6(e){return!e.ctrlKey&&!e.button}function L6(){return this.parentNode}function D6(e,n){return n??{x:e.x,y:e.y}}function O6(){return navigator.maxTouchPoints||"ontouchstart"in this}function $6(){var e=I6,n=L6,s=D6,i=O6,l={},o=qf("start","drag","end"),d=0,f,p,h,y,g=0;function b(_){_.on("mousedown.drag",v).filter(i).on("touchstart.drag",j).on("touchmove.drag",E,R6).on("touchend.drag touchcancel.drag",A).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function v(_,T){if(!(y||!e.call(this,_,T))){var k=M(this,n.call(this,_,T),_,T,"mouse");k&&(ls(_.view).on("mousemove.drag",S,Lc).on("mouseup.drag",N,Lc),rE(_.view),Pp(_),h=!1,f=_.clientX,p=_.clientY,k("start",_))}}function S(_){if(Bl(_),!h){var T=_.clientX-f,k=_.clientY-p;h=T*T+k*k>g}l.mouse("drag",_)}function N(_){ls(_.view).on("mousemove.drag mouseup.drag",null),iE(_.view,h),Bl(_),l.mouse("end",_)}function j(_,T){if(e.call(this,_,T)){var k=_.changedTouches,C=n.call(this,_,T),L=k.length,z,G;for(z=0;z<L;++z)(G=M(this,C,_,T,k[z].identifier,k[z]))&&(Pp(_),G("start",_,k[z]))}}function E(_){var T=_.changedTouches,k=T.length,C,L;for(C=0;C<k;++C)(L=l[T[C].identifier])&&(Bl(_),L("drag",_,T[C]))}function A(_){var T=_.changedTouches,k=T.length,C,L;for(y&&clearTimeout(y),y=setTimeout(function(){y=null},500),C=0;C<k;++C)(L=l[T[C].identifier])&&(Pp(_),L("end",_,T[C]))}function M(_,T,k,C,L,z){var G=o.copy(),U=ws(z||k,T),X,V,R;if((R=s.call(_,new Dy("beforestart",{sourceEvent:k,target:b,identifier:L,active:d,x:U[0],y:U[1],dx:0,dy:0,dispatch:G}),C))!=null)return X=R.x-U[0]||0,V=R.y-U[1]||0,function B(D,O,$){var F=U,H;switch(D){case"start":l[L]=B,H=d++;break;case"end":delete l[L],--d;case"drag":U=ws($||O,T),H=d;break}G.call(D,_,new Dy(D,{sourceEvent:O,subject:R,target:b,identifier:L,active:H,x:U[0]+X,y:U[1]+V,dx:U[0]-F[0],dy:U[1]-F[1],dispatch:G}),C)}}return b.filter=function(_){return arguments.length?(e=typeof _=="function"?_:vd(!!_),b):e},b.container=function(_){return arguments.length?(n=typeof _=="function"?_:vd(_),b):n},b.subject=function(_){return arguments.length?(s=typeof _=="function"?_:vd(_),b):s},b.touchable=function(_){return arguments.length?(i=typeof _=="function"?_:vd(!!_),b):i},b.on=function(){var _=o.on.apply(o,arguments);return _===o?b:_},b.clickDistance=function(_){return arguments.length?(g=(_=+_)*_,b):Math.sqrt(g)},b}function Wg(e,n,s){e.prototype=n.prototype=s,s.constructor=e}function lE(e,n){var s=Object.create(e.prototype);for(var i in n)s[i]=n[i];return s}function Zc(){}var Dc=.7,lf=1/Dc,Ul="\\s*([+-]?\\d+)\\s*",Oc="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",qs="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",F6=/^#([0-9a-f]{3,8})$/,z6=new RegExp(`^rgb\\(${Ul},${Ul},${Ul}\\)$`),B6=new RegExp(`^rgb\\(${qs},${qs},${qs}\\)$`),U6=new RegExp(`^rgba\\(${Ul},${Ul},${Ul},${Oc}\\)$`),q6=new RegExp(`^rgba\\(${qs},${qs},${qs},${Oc}\\)$`),P6=new RegExp(`^hsl\\(${Oc},${qs},${qs}\\)$`),H6=new RegExp(`^hsla\\(${Oc},${qs},${qs},${Oc}\\)$`),Rw={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};Wg(Zc,$c,{copy(e){return Object.assign(new this.constructor,this,e)},displayable(){return this.rgb().displayable()},hex:Iw,formatHex:Iw,formatHex8:V6,formatHsl:Y6,formatRgb:Lw,toString:Lw});function Iw(){return this.rgb().formatHex()}function V6(){return this.rgb().formatHex8()}function Y6(){return oE(this).formatHsl()}function Lw(){return this.rgb().formatRgb()}function $c(e){var n,s;return e=(e+"").trim().toLowerCase(),(n=F6.exec(e))?(s=n[1].length,n=parseInt(n[1],16),s===6?Dw(n):s===3?new Da(n>>8&15|n>>4&240,n>>4&15|n&240,(n&15)<<4|n&15,1):s===8?Sd(n>>24&255,n>>16&255,n>>8&255,(n&255)/255):s===4?Sd(n>>12&15|n>>8&240,n>>8&15|n>>4&240,n>>4&15|n&240,((n&15)<<4|n&15)/255):null):(n=z6.exec(e))?new Da(n[1],n[2],n[3],1):(n=B6.exec(e))?new Da(n[1]*255/100,n[2]*255/100,n[3]*255/100,1):(n=U6.exec(e))?Sd(n[1],n[2],n[3],n[4]):(n=q6.exec(e))?Sd(n[1]*255/100,n[2]*255/100,n[3]*255/100,n[4]):(n=P6.exec(e))?Fw(n[1],n[2]/100,n[3]/100,1):(n=H6.exec(e))?Fw(n[1],n[2]/100,n[3]/100,n[4]):Rw.hasOwnProperty(e)?Dw(Rw[e]):e==="transparent"?new Da(NaN,NaN,NaN,0):null}function Dw(e){return new Da(e>>16&255,e>>8&255,e&255,1)}function Sd(e,n,s,i){return i<=0&&(e=n=s=NaN),new Da(e,n,s,i)}function G6(e){return e instanceof Zc||(e=$c(e)),e?(e=e.rgb(),new Da(e.r,e.g,e.b,e.opacity)):new Da}function Oy(e,n,s,i){return arguments.length===1?G6(e):new Da(e,n,s,i??1)}function Da(e,n,s,i){this.r=+e,this.g=+n,this.b=+s,this.opacity=+i}Wg(Da,Oy,lE(Zc,{brighter(e){return e=e==null?lf:Math.pow(lf,e),new Da(this.r*e,this.g*e,this.b*e,this.opacity)},darker(e){return e=e==null?Dc:Math.pow(Dc,e),new Da(this.r*e,this.g*e,this.b*e,this.opacity)},rgb(){return this},clamp(){return new Da($i(this.r),$i(this.g),$i(this.b),of(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:Ow,formatHex:Ow,formatHex8:W6,formatRgb:$w,toString:$w}));function Ow(){return`#${Di(this.r)}${Di(this.g)}${Di(this.b)}`}function W6(){return`#${Di(this.r)}${Di(this.g)}${Di(this.b)}${Di((isNaN(this.opacity)?1:this.opacity)*255)}`}function $w(){const e=of(this.opacity);return`${e===1?"rgb(":"rgba("}${$i(this.r)}, ${$i(this.g)}, ${$i(this.b)}${e===1?")":`, ${e})`}`}function of(e){return isNaN(e)?1:Math.max(0,Math.min(1,e))}function $i(e){return Math.max(0,Math.min(255,Math.round(e)||0))}function Di(e){return e=$i(e),(e<16?"0":"")+e.toString(16)}function Fw(e,n,s,i){return i<=0?e=n=s=NaN:s<=0||s>=1?e=n=NaN:n<=0&&(e=NaN),new Ns(e,n,s,i)}function oE(e){if(e instanceof Ns)return new Ns(e.h,e.s,e.l,e.opacity);if(e instanceof Zc||(e=$c(e)),!e)return new Ns;if(e instanceof Ns)return e;e=e.rgb();var n=e.r/255,s=e.g/255,i=e.b/255,l=Math.min(n,s,i),o=Math.max(n,s,i),d=NaN,f=o-l,p=(o+l)/2;return f?(n===o?d=(s-i)/f+(s<i)*6:s===o?d=(i-n)/f+2:d=(n-s)/f+4,f/=p<.5?o+l:2-o-l,d*=60):f=p>0&&p<1?0:d,new Ns(d,f,p,e.opacity)}function X6(e,n,s,i){return arguments.length===1?oE(e):new Ns(e,n,s,i??1)}function Ns(e,n,s,i){this.h=+e,this.s=+n,this.l=+s,this.opacity=+i}Wg(Ns,X6,lE(Zc,{brighter(e){return e=e==null?lf:Math.pow(lf,e),new Ns(this.h,this.s,this.l*e,this.opacity)},darker(e){return e=e==null?Dc:Math.pow(Dc,e),new Ns(this.h,this.s,this.l*e,this.opacity)},rgb(){var e=this.h%360+(this.h<0)*360,n=isNaN(e)||isNaN(this.s)?0:this.s,s=this.l,i=s+(s<.5?s:1-s)*n,l=2*s-i;return new Da(Hp(e>=240?e-240:e+120,l,i),Hp(e,l,i),Hp(e<120?e+240:e-120,l,i),this.opacity)},clamp(){return new Ns(zw(this.h),wd(this.s),wd(this.l),of(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const e=of(this.opacity);return`${e===1?"hsl(":"hsla("}${zw(this.h)}, ${wd(this.s)*100}%, ${wd(this.l)*100}%${e===1?")":`, ${e})`}`}}));function zw(e){return e=(e||0)%360,e<0?e+360:e}function wd(e){return Math.max(0,Math.min(1,e||0))}function Hp(e,n,s){return(e<60?n+(s-n)*e/60:e<180?s:e<240?n+(s-n)*(240-e)/60:n)*255}const cE=e=>()=>e;function K6(e,n){return function(s){return e+s*n}}function Z6(e,n,s){return e=Math.pow(e,s),n=Math.pow(n,s)-e,s=1/s,function(i){return Math.pow(e+i*n,s)}}function Q6(e){return(e=+e)==1?uE:function(n,s){return s-n?Z6(n,s,e):cE(isNaN(n)?s:n)}}function uE(e,n){var s=n-e;return s?K6(e,s):cE(isNaN(e)?n:e)}const Bw=(function e(n){var s=Q6(n);function i(l,o){var d=s((l=Oy(l)).r,(o=Oy(o)).r),f=s(l.g,o.g),p=s(l.b,o.b),h=uE(l.opacity,o.opacity);return function(y){return l.r=d(y),l.g=f(y),l.b=p(y),l.opacity=h(y),l+""}}return i.gamma=e,i})(1);function Zr(e,n){return e=+e,n=+n,function(s){return e*(1-s)+n*s}}var $y=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,Vp=new RegExp($y.source,"g");function J6(e){return function(){return e}}function e7(e){return function(n){return e(n)+""}}function t7(e,n){var s=$y.lastIndex=Vp.lastIndex=0,i,l,o,d=-1,f=[],p=[];for(e=e+"",n=n+"";(i=$y.exec(e))&&(l=Vp.exec(n));)(o=l.index)>s&&(o=n.slice(s,o),f[d]?f[d]+=o:f[++d]=o),(i=i[0])===(l=l[0])?f[d]?f[d]+=l:f[++d]=l:(f[++d]=null,p.push({i:d,x:Zr(i,l)})),s=Vp.lastIndex;return s<n.length&&(o=n.slice(s),f[d]?f[d]+=o:f[++d]=o),f.length<2?p[0]?e7(p[0].x):J6(n):(n=p.length,function(h){for(var y=0,g;y<n;++y)f[(g=p[y]).i]=g.x(h);return f.join("")})}var Uw=180/Math.PI,Fy={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function dE(e,n,s,i,l,o){var d,f,p;return(d=Math.sqrt(e*e+n*n))&&(e/=d,n/=d),(p=e*s+n*i)&&(s-=e*p,i-=n*p),(f=Math.sqrt(s*s+i*i))&&(s/=f,i/=f,p/=f),e*i<n*s&&(e=-e,n=-n,p=-p,d=-d),{translateX:l,translateY:o,rotate:Math.atan2(n,e)*Uw,skewX:Math.atan(p)*Uw,scaleX:d,scaleY:f}}var Nd;function n7(e){const n=new(typeof DOMMatrix=="function"?DOMMatrix:WebKitCSSMatrix)(e+"");return n.isIdentity?Fy:dE(n.a,n.b,n.c,n.d,n.e,n.f)}function a7(e){return e==null||(Nd||(Nd=document.createElementNS("http://www.w3.org/2000/svg","g")),Nd.setAttribute("transform",e),!(e=Nd.transform.baseVal.consolidate()))?Fy:(e=e.matrix,dE(e.a,e.b,e.c,e.d,e.e,e.f))}function fE(e,n,s,i){function l(h){return h.length?h.pop()+" ":""}function o(h,y,g,b,v,S){if(h!==g||y!==b){var N=v.push("translate(",null,n,null,s);S.push({i:N-4,x:Zr(h,g)},{i:N-2,x:Zr(y,b)})}else(g||b)&&v.push("translate("+g+n+b+s)}function d(h,y,g,b){h!==y?(h-y>180?y+=360:y-h>180&&(h+=360),b.push({i:g.push(l(g)+"rotate(",null,i)-2,x:Zr(h,y)})):y&&g.push(l(g)+"rotate("+y+i)}function f(h,y,g,b){h!==y?b.push({i:g.push(l(g)+"skewX(",null,i)-2,x:Zr(h,y)}):y&&g.push(l(g)+"skewX("+y+i)}function p(h,y,g,b,v,S){if(h!==g||y!==b){var N=v.push(l(v)+"scale(",null,",",null,")");S.push({i:N-4,x:Zr(h,g)},{i:N-2,x:Zr(y,b)})}else(g!==1||b!==1)&&v.push(l(v)+"scale("+g+","+b+")")}return function(h,y){var g=[],b=[];return h=e(h),y=e(y),o(h.translateX,h.translateY,y.translateX,y.translateY,g,b),d(h.rotate,y.rotate,g,b),f(h.skewX,y.skewX,g,b),p(h.scaleX,h.scaleY,y.scaleX,y.scaleY,g,b),h=y=null,function(v){for(var S=-1,N=b.length,j;++S<N;)g[(j=b[S]).i]=j.x(v);return g.join("")}}}var s7=fE(n7,"px, ","px)","deg)"),r7=fE(a7,", ",")",")"),i7=1e-12;function qw(e){return((e=Math.exp(e))+1/e)/2}function l7(e){return((e=Math.exp(e))-1/e)/2}function o7(e){return((e=Math.exp(2*e))-1)/(e+1)}const c7=(function e(n,s,i){function l(o,d){var f=o[0],p=o[1],h=o[2],y=d[0],g=d[1],b=d[2],v=y-f,S=g-p,N=v*v+S*S,j,E;if(N<i7)E=Math.log(b/h)/n,j=function(C){return[f+C*v,p+C*S,h*Math.exp(n*C*E)]};else{var A=Math.sqrt(N),M=(b*b-h*h+i*N)/(2*h*s*A),_=(b*b-h*h-i*N)/(2*b*s*A),T=Math.log(Math.sqrt(M*M+1)-M),k=Math.log(Math.sqrt(_*_+1)-_);E=(k-T)/n,j=function(C){var L=C*E,z=qw(T),G=h/(s*A)*(z*o7(n*L+T)-l7(T));return[f+G*v,p+G*S,h*z/qw(n*L+T)]}}return j.duration=E*1e3*n/Math.SQRT2,j}return l.rho=function(o){var d=Math.max(.001,+o),f=d*d,p=f*f;return e(d,f,p)},l})(Math.SQRT2,2,4);var Xl=0,vc=0,ic=0,mE=1e3,cf,Sc,uf=0,Ui=0,Hf=0,Fc=typeof performance=="object"&&performance.now?performance:Date,hE=typeof window=="object"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(e){setTimeout(e,17)};function Xg(){return Ui||(hE(u7),Ui=Fc.now()+Hf)}function u7(){Ui=0}function df(){this._call=this._time=this._next=null}df.prototype=pE.prototype={constructor:df,restart:function(e,n,s){if(typeof e!="function")throw new TypeError("callback is not a function");s=(s==null?Xg():+s)+(n==null?0:+n),!this._next&&Sc!==this&&(Sc?Sc._next=this:cf=this,Sc=this),this._call=e,this._time=s,zy()},stop:function(){this._call&&(this._call=null,this._time=1/0,zy())}};function pE(e,n,s){var i=new df;return i.restart(e,n,s),i}function d7(){Xg(),++Xl;for(var e=cf,n;e;)(n=Ui-e._time)>=0&&e._call.call(void 0,n),e=e._next;--Xl}function Pw(){Ui=(uf=Fc.now())+Hf,Xl=vc=0;try{d7()}finally{Xl=0,m7(),Ui=0}}function f7(){var e=Fc.now(),n=e-uf;n>mE&&(Hf-=n,uf=e)}function m7(){for(var e,n=cf,s,i=1/0;n;)n._call?(i>n._time&&(i=n._time),e=n,n=n._next):(s=n._next,n._next=null,n=e?e._next=s:cf=s);Sc=e,zy(i)}function zy(e){if(!Xl){vc&&(vc=clearTimeout(vc));var n=e-Ui;n>24?(e<1/0&&(vc=setTimeout(Pw,e-Fc.now()-Hf)),ic&&(ic=clearInterval(ic))):(ic||(uf=Fc.now(),ic=setInterval(f7,mE)),Xl=1,hE(Pw))}}function Hw(e,n,s){var i=new df;return n=n==null?0:+n,i.restart(l=>{i.stop(),e(l+n)},n,s),i}var h7=qf("start","end","cancel","interrupt"),p7=[],yE=0,Vw=1,By=2,Hd=3,Yw=4,Uy=5,Vd=6;function Vf(e,n,s,i,l,o){var d=e.__transition;if(!d)e.__transition={};else if(s in d)return;y7(e,s,{name:n,index:i,group:l,on:h7,tween:p7,time:o.time,delay:o.delay,duration:o.duration,ease:o.ease,timer:null,state:yE})}function Kg(e,n){var s=Ms(e,n);if(s.state>yE)throw new Error("too late; already scheduled");return s}function Ws(e,n){var s=Ms(e,n);if(s.state>Hd)throw new Error("too late; already running");return s}function Ms(e,n){var s=e.__transition;if(!s||!(s=s[n]))throw new Error("transition not found");return s}function y7(e,n,s){var i=e.__transition,l;i[n]=s,s.timer=pE(o,0,s.time);function o(h){s.state=Vw,s.timer.restart(d,s.delay,s.time),s.delay<=h&&d(h-s.delay)}function d(h){var y,g,b,v;if(s.state!==Vw)return p();for(y in i)if(v=i[y],v.name===s.name){if(v.state===Hd)return Hw(d);v.state===Yw?(v.state=Vd,v.timer.stop(),v.on.call("interrupt",e,e.__data__,v.index,v.group),delete i[y]):+y<n&&(v.state=Vd,v.timer.stop(),v.on.call("cancel",e,e.__data__,v.index,v.group),delete i[y])}if(Hw(function(){s.state===Hd&&(s.state=Yw,s.timer.restart(f,s.delay,s.time),f(h))}),s.state=By,s.on.call("start",e,e.__data__,s.index,s.group),s.state===By){for(s.state=Hd,l=new Array(b=s.tween.length),y=0,g=-1;y<b;++y)(v=s.tween[y].value.call(e,e.__data__,s.index,s.group))&&(l[++g]=v);l.length=g+1}}function f(h){for(var y=h<s.duration?s.ease.call(null,h/s.duration):(s.timer.restart(p),s.state=Uy,1),g=-1,b=l.length;++g<b;)l[g].call(e,y);s.state===Uy&&(s.on.call("end",e,e.__data__,s.index,s.group),p())}function p(){s.state=Vd,s.timer.stop(),delete i[n];for(var h in i)return;delete e.__transition}}function Yd(e,n){var s=e.__transition,i,l,o=!0,d;if(s){n=n==null?null:n+"";for(d in s){if((i=s[d]).name!==n){o=!1;continue}l=i.state>By&&i.state<Uy,i.state=Vd,i.timer.stop(),i.on.call(l?"interrupt":"cancel",e,e.__data__,i.index,i.group),delete s[d]}o&&delete e.__transition}}function g7(e){return this.each(function(){Yd(this,e)})}function b7(e,n){var s,i;return function(){var l=Ws(this,e),o=l.tween;if(o!==s){i=s=o;for(var d=0,f=i.length;d<f;++d)if(i[d].name===n){i=i.slice(),i.splice(d,1);break}}l.tween=i}}function x7(e,n,s){var i,l;if(typeof s!="function")throw new Error;return function(){var o=Ws(this,e),d=o.tween;if(d!==i){l=(i=d).slice();for(var f={name:n,value:s},p=0,h=l.length;p<h;++p)if(l[p].name===n){l[p]=f;break}p===h&&l.push(f)}o.tween=l}}function v7(e,n){var s=this._id;if(e+="",arguments.length<2){for(var i=Ms(this.node(),s).tween,l=0,o=i.length,d;l<o;++l)if((d=i[l]).name===e)return d.value;return null}return this.each((n==null?b7:x7)(s,e,n))}function Zg(e,n,s){var i=e._id;return e.each(function(){var l=Ws(this,i);(l.value||(l.value={}))[n]=s.apply(this,arguments)}),function(l){return Ms(l,i).value[n]}}function gE(e,n){var s;return(typeof n=="number"?Zr:n instanceof $c?Bw:(s=$c(n))?(n=s,Bw):t7)(e,n)}function S7(e){return function(){this.removeAttribute(e)}}function w7(e){return function(){this.removeAttributeNS(e.space,e.local)}}function N7(e,n,s){var i,l=s+"",o;return function(){var d=this.getAttribute(e);return d===l?null:d===i?o:o=n(i=d,s)}}function j7(e,n,s){var i,l=s+"",o;return function(){var d=this.getAttributeNS(e.space,e.local);return d===l?null:d===i?o:o=n(i=d,s)}}function E7(e,n,s){var i,l,o;return function(){var d,f=s(this),p;return f==null?void this.removeAttribute(e):(d=this.getAttribute(e),p=f+"",d===p?null:d===i&&p===l?o:(l=p,o=n(i=d,f)))}}function _7(e,n,s){var i,l,o;return function(){var d,f=s(this),p;return f==null?void this.removeAttributeNS(e.space,e.local):(d=this.getAttributeNS(e.space,e.local),p=f+"",d===p?null:d===i&&p===l?o:(l=p,o=n(i=d,f)))}}function C7(e,n){var s=Pf(e),i=s==="transform"?r7:gE;return this.attrTween(e,typeof n=="function"?(s.local?_7:E7)(s,i,Zg(this,"attr."+e,n)):n==null?(s.local?w7:S7)(s):(s.local?j7:N7)(s,i,n))}function A7(e,n){return function(s){this.setAttribute(e,n.call(this,s))}}function T7(e,n){return function(s){this.setAttributeNS(e.space,e.local,n.call(this,s))}}function M7(e,n){var s,i;function l(){var o=n.apply(this,arguments);return o!==i&&(s=(i=o)&&T7(e,o)),s}return l._value=n,l}function k7(e,n){var s,i;function l(){var o=n.apply(this,arguments);return o!==i&&(s=(i=o)&&A7(e,o)),s}return l._value=n,l}function R7(e,n){var s="attr."+e;if(arguments.length<2)return(s=this.tween(s))&&s._value;if(n==null)return this.tween(s,null);if(typeof n!="function")throw new Error;var i=Pf(e);return this.tween(s,(i.local?M7:k7)(i,n))}function I7(e,n){return function(){Kg(this,e).delay=+n.apply(this,arguments)}}function L7(e,n){return n=+n,function(){Kg(this,e).delay=n}}function D7(e){var n=this._id;return arguments.length?this.each((typeof e=="function"?I7:L7)(n,e)):Ms(this.node(),n).delay}function O7(e,n){return function(){Ws(this,e).duration=+n.apply(this,arguments)}}function $7(e,n){return n=+n,function(){Ws(this,e).duration=n}}function F7(e){var n=this._id;return arguments.length?this.each((typeof e=="function"?O7:$7)(n,e)):Ms(this.node(),n).duration}function z7(e,n){if(typeof n!="function")throw new Error;return function(){Ws(this,e).ease=n}}function B7(e){var n=this._id;return arguments.length?this.each(z7(n,e)):Ms(this.node(),n).ease}function U7(e,n){return function(){var s=n.apply(this,arguments);if(typeof s!="function")throw new Error;Ws(this,e).ease=s}}function q7(e){if(typeof e!="function")throw new Error;return this.each(U7(this._id,e))}function P7(e){typeof e!="function"&&(e=X1(e));for(var n=this._groups,s=n.length,i=new Array(s),l=0;l<s;++l)for(var o=n[l],d=o.length,f=i[l]=[],p,h=0;h<d;++h)(p=o[h])&&e.call(p,p.__data__,h,o)&&f.push(p);return new vr(i,this._parents,this._name,this._id)}function H7(e){if(e._id!==this._id)throw new Error;for(var n=this._groups,s=e._groups,i=n.length,l=s.length,o=Math.min(i,l),d=new Array(i),f=0;f<o;++f)for(var p=n[f],h=s[f],y=p.length,g=d[f]=new Array(y),b,v=0;v<y;++v)(b=p[v]||h[v])&&(g[v]=b);for(;f<i;++f)d[f]=n[f];return new vr(d,this._parents,this._name,this._id)}function V7(e){return(e+"").trim().split(/^|\s+/).every(function(n){var s=n.indexOf(".");return s>=0&&(n=n.slice(0,s)),!n||n==="start"})}function Y7(e,n,s){var i,l,o=V7(n)?Kg:Ws;return function(){var d=o(this,e),f=d.on;f!==i&&(l=(i=f).copy()).on(n,s),d.on=l}}function G7(e,n){var s=this._id;return arguments.length<2?Ms(this.node(),s).on.on(e):this.each(Y7(s,e,n))}function W7(e){return function(){var n=this.parentNode;for(var s in this.__transition)if(+s!==e)return;n&&n.removeChild(this)}}function X7(){return this.on("end.remove",W7(this._id))}function K7(e){var n=this._name,s=this._id;typeof e!="function"&&(e=Yg(e));for(var i=this._groups,l=i.length,o=new Array(l),d=0;d<l;++d)for(var f=i[d],p=f.length,h=o[d]=new Array(p),y,g,b=0;b<p;++b)(y=f[b])&&(g=e.call(y,y.__data__,b,f))&&("__data__"in y&&(g.__data__=y.__data__),h[b]=g,Vf(h[b],n,s,b,h,Ms(y,s)));return new vr(o,this._parents,n,s)}function Z7(e){var n=this._name,s=this._id;typeof e!="function"&&(e=W1(e));for(var i=this._groups,l=i.length,o=[],d=[],f=0;f<l;++f)for(var p=i[f],h=p.length,y,g=0;g<h;++g)if(y=p[g]){for(var b=e.call(y,y.__data__,g,p),v,S=Ms(y,s),N=0,j=b.length;N<j;++N)(v=b[N])&&Vf(v,n,s,N,b,S);o.push(b),d.push(y)}return new vr(o,d,n,s)}var Q7=Kc.prototype.constructor;function J7(){return new Q7(this._groups,this._parents)}function e$(e,n){var s,i,l;return function(){var o=Wl(this,e),d=(this.style.removeProperty(e),Wl(this,e));return o===d?null:o===s&&d===i?l:l=n(s=o,i=d)}}function bE(e){return function(){this.style.removeProperty(e)}}function t$(e,n,s){var i,l=s+"",o;return function(){var d=Wl(this,e);return d===l?null:d===i?o:o=n(i=d,s)}}function n$(e,n,s){var i,l,o;return function(){var d=Wl(this,e),f=s(this),p=f+"";return f==null&&(p=f=(this.style.removeProperty(e),Wl(this,e))),d===p?null:d===i&&p===l?o:(l=p,o=n(i=d,f))}}function a$(e,n){var s,i,l,o="style."+n,d="end."+o,f;return function(){var p=Ws(this,e),h=p.on,y=p.value[o]==null?f||(f=bE(n)):void 0;(h!==s||l!==y)&&(i=(s=h).copy()).on(d,l=y),p.on=i}}function s$(e,n,s){var i=(e+="")=="transform"?s7:gE;return n==null?this.styleTween(e,e$(e,i)).on("end.style."+e,bE(e)):typeof n=="function"?this.styleTween(e,n$(e,i,Zg(this,"style."+e,n))).each(a$(this._id,e)):this.styleTween(e,t$(e,i,n),s).on("end.style."+e,null)}function r$(e,n,s){return function(i){this.style.setProperty(e,n.call(this,i),s)}}function i$(e,n,s){var i,l;function o(){var d=n.apply(this,arguments);return d!==l&&(i=(l=d)&&r$(e,d,s)),i}return o._value=n,o}function l$(e,n,s){var i="style."+(e+="");if(arguments.length<2)return(i=this.tween(i))&&i._value;if(n==null)return this.tween(i,null);if(typeof n!="function")throw new Error;return this.tween(i,i$(e,n,s??""))}function o$(e){return function(){this.textContent=e}}function c$(e){return function(){var n=e(this);this.textContent=n??""}}function u$(e){return this.tween("text",typeof e=="function"?c$(Zg(this,"text",e)):o$(e==null?"":e+""))}function d$(e){return function(n){this.textContent=e.call(this,n)}}function f$(e){var n,s;function i(){var l=e.apply(this,arguments);return l!==s&&(n=(s=l)&&d$(l)),n}return i._value=e,i}function m$(e){var n="text";if(arguments.length<1)return(n=this.tween(n))&&n._value;if(e==null)return this.tween(n,null);if(typeof e!="function")throw new Error;return this.tween(n,f$(e))}function h$(){for(var e=this._name,n=this._id,s=xE(),i=this._groups,l=i.length,o=0;o<l;++o)for(var d=i[o],f=d.length,p,h=0;h<f;++h)if(p=d[h]){var y=Ms(p,n);Vf(p,e,s,h,d,{time:y.time+y.delay+y.duration,delay:0,duration:y.duration,ease:y.ease})}return new vr(i,this._parents,e,s)}function p$(){var e,n,s=this,i=s._id,l=s.size();return new Promise(function(o,d){var f={value:d},p={value:function(){--l===0&&o()}};s.each(function(){var h=Ws(this,i),y=h.on;y!==e&&(n=(e=y).copy(),n._.cancel.push(f),n._.interrupt.push(f),n._.end.push(p)),h.on=n}),l===0&&o()})}var y$=0;function vr(e,n,s,i){this._groups=e,this._parents=n,this._name=s,this._id=i}function xE(){return++y$}var fr=Kc.prototype;vr.prototype={constructor:vr,select:K7,selectAll:Z7,selectChild:fr.selectChild,selectChildren:fr.selectChildren,filter:P7,merge:H7,selection:J7,transition:h$,call:fr.call,nodes:fr.nodes,node:fr.node,size:fr.size,empty:fr.empty,each:fr.each,on:G7,attr:C7,attrTween:R7,style:s$,styleTween:l$,text:u$,textTween:m$,remove:X7,tween:v7,delay:D7,duration:F7,ease:B7,easeVarying:q7,end:p$,[Symbol.iterator]:fr[Symbol.iterator]};function g$(e){return((e*=2)<=1?e*e*e:(e-=2)*e*e+2)/2}var b$={time:null,delay:0,duration:250,ease:g$};function x$(e,n){for(var s;!(s=e.__transition)||!(s=s[n]);)if(!(e=e.parentNode))throw new Error(`transition ${n} not found`);return s}function v$(e){var n,s;e instanceof vr?(n=e._id,e=e._name):(n=xE(),(s=b$).time=Xg(),e=e==null?null:e+"");for(var i=this._groups,l=i.length,o=0;o<l;++o)for(var d=i[o],f=d.length,p,h=0;h<f;++h)(p=d[h])&&Vf(p,e,n,h,d,s||x$(p,n));return new vr(i,this._parents,e,n)}Kc.prototype.interrupt=g7;Kc.prototype.transition=v$;const jd=e=>()=>e;function S$(e,{sourceEvent:n,target:s,transform:i,dispatch:l}){Object.defineProperties(this,{type:{value:e,enumerable:!0,configurable:!0},sourceEvent:{value:n,enumerable:!0,configurable:!0},target:{value:s,enumerable:!0,configurable:!0},transform:{value:i,enumerable:!0,configurable:!0},_:{value:l}})}function gr(e,n,s){this.k=e,this.x=n,this.y=s}gr.prototype={constructor:gr,scale:function(e){return e===1?this:new gr(this.k*e,this.x,this.y)},translate:function(e,n){return e===0&n===0?this:new gr(this.k,this.x+this.k*e,this.y+this.k*n)},apply:function(e){return[e[0]*this.k+this.x,e[1]*this.k+this.y]},applyX:function(e){return e*this.k+this.x},applyY:function(e){return e*this.k+this.y},invert:function(e){return[(e[0]-this.x)/this.k,(e[1]-this.y)/this.k]},invertX:function(e){return(e-this.x)/this.k},invertY:function(e){return(e-this.y)/this.k},rescaleX:function(e){return e.copy().domain(e.range().map(this.invertX,this).map(e.invert,e))},rescaleY:function(e){return e.copy().domain(e.range().map(this.invertY,this).map(e.invert,e))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};var br=new gr(1,0,0);gr.prototype;function Yp(e){e.stopImmediatePropagation()}function lc(e){e.preventDefault(),e.stopImmediatePropagation()}function w$(e){return(!e.ctrlKey||e.type==="wheel")&&!e.button}function N$(){var e=this;return e instanceof SVGElement?(e=e.ownerSVGElement||e,e.hasAttribute("viewBox")?(e=e.viewBox.baseVal,[[e.x,e.y],[e.x+e.width,e.y+e.height]]):[[0,0],[e.width.baseVal.value,e.height.baseVal.value]]):[[0,0],[e.clientWidth,e.clientHeight]]}function Gw(){return this.__zoom||br}function j$(e){return-e.deltaY*(e.deltaMode===1?.05:e.deltaMode?1:.002)*(e.ctrlKey?10:1)}function E$(){return navigator.maxTouchPoints||"ontouchstart"in this}function _$(e,n,s){var i=e.invertX(n[0][0])-s[0][0],l=e.invertX(n[1][0])-s[1][0],o=e.invertY(n[0][1])-s[0][1],d=e.invertY(n[1][1])-s[1][1];return e.translate(l>i?(i+l)/2:Math.min(0,i)||Math.max(0,l),d>o?(o+d)/2:Math.min(0,o)||Math.max(0,d))}function vE(){var e=w$,n=N$,s=_$,i=j$,l=E$,o=[0,1/0],d=[[-1/0,-1/0],[1/0,1/0]],f=250,p=c7,h=qf("start","zoom","end"),y,g,b,v=500,S=150,N=0,j=10;function E(R){R.property("__zoom",Gw).on("wheel.zoom",L,{passive:!1}).on("mousedown.zoom",z).on("dblclick.zoom",G).filter(l).on("touchstart.zoom",U).on("touchmove.zoom",X).on("touchend.zoom touchcancel.zoom",V).style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}E.transform=function(R,B,D,O){var $=R.selection?R.selection():R;$.property("__zoom",Gw),R!==$?T(R,B,D,O):$.interrupt().each(function(){k(this,arguments).event(O).start().zoom(null,typeof B=="function"?B.apply(this,arguments):B).end()})},E.scaleBy=function(R,B,D,O){E.scaleTo(R,function(){var $=this.__zoom.k,F=typeof B=="function"?B.apply(this,arguments):B;return $*F},D,O)},E.scaleTo=function(R,B,D,O){E.transform(R,function(){var $=n.apply(this,arguments),F=this.__zoom,H=D==null?_($):typeof D=="function"?D.apply(this,arguments):D,I=F.invert(H),Y=typeof B=="function"?B.apply(this,arguments):B;return s(M(A(F,Y),H,I),$,d)},D,O)},E.translateBy=function(R,B,D,O){E.transform(R,function(){return s(this.__zoom.translate(typeof B=="function"?B.apply(this,arguments):B,typeof D=="function"?D.apply(this,arguments):D),n.apply(this,arguments),d)},null,O)},E.translateTo=function(R,B,D,O,$){E.transform(R,function(){var F=n.apply(this,arguments),H=this.__zoom,I=O==null?_(F):typeof O=="function"?O.apply(this,arguments):O;return s(br.translate(I[0],I[1]).scale(H.k).translate(typeof B=="function"?-B.apply(this,arguments):-B,typeof D=="function"?-D.apply(this,arguments):-D),F,d)},O,$)};function A(R,B){return B=Math.max(o[0],Math.min(o[1],B)),B===R.k?R:new gr(B,R.x,R.y)}function M(R,B,D){var O=B[0]-D[0]*R.k,$=B[1]-D[1]*R.k;return O===R.x&&$===R.y?R:new gr(R.k,O,$)}function _(R){return[(+R[0][0]+ +R[1][0])/2,(+R[0][1]+ +R[1][1])/2]}function T(R,B,D,O){R.on("start.zoom",function(){k(this,arguments).event(O).start()}).on("interrupt.zoom end.zoom",function(){k(this,arguments).event(O).end()}).tween("zoom",function(){var $=this,F=arguments,H=k($,F).event(O),I=n.apply($,F),Y=D==null?_(I):typeof D=="function"?D.apply($,F):D,P=Math.max(I[1][0]-I[0][0],I[1][1]-I[0][1]),W=$.__zoom,le=typeof B=="function"?B.apply($,F):B,K=p(W.invert(Y).concat(P/W.k),le.invert(Y).concat(P/le.k));return function(de){if(de===1)de=le;else{var Q=K(de),he=P/Q[2];de=new gr(he,Y[0]-Q[0]*he,Y[1]-Q[1]*he)}H.zoom(null,de)}})}function k(R,B,D){return!D&&R.__zooming||new C(R,B)}function C(R,B){this.that=R,this.args=B,this.active=0,this.sourceEvent=null,this.extent=n.apply(R,B),this.taps=0}C.prototype={event:function(R){return R&&(this.sourceEvent=R),this},start:function(){return++this.active===1&&(this.that.__zooming=this,this.emit("start")),this},zoom:function(R,B){return this.mouse&&R!=="mouse"&&(this.mouse[1]=B.invert(this.mouse[0])),this.touch0&&R!=="touch"&&(this.touch0[1]=B.invert(this.touch0[0])),this.touch1&&R!=="touch"&&(this.touch1[1]=B.invert(this.touch1[0])),this.that.__zoom=B,this.emit("zoom"),this},end:function(){return--this.active===0&&(delete this.that.__zooming,this.emit("end")),this},emit:function(R){var B=ls(this.that).datum();h.call(R,this.that,new S$(R,{sourceEvent:this.sourceEvent,target:E,transform:this.that.__zoom,dispatch:h}),B)}};function L(R,...B){if(!e.apply(this,arguments))return;var D=k(this,B).event(R),O=this.__zoom,$=Math.max(o[0],Math.min(o[1],O.k*Math.pow(2,i.apply(this,arguments)))),F=ws(R);if(D.wheel)(D.mouse[0][0]!==F[0]||D.mouse[0][1]!==F[1])&&(D.mouse[1]=O.invert(D.mouse[0]=F)),clearTimeout(D.wheel);else{if(O.k===$)return;D.mouse=[F,O.invert(F)],Yd(this),D.start()}lc(R),D.wheel=setTimeout(H,S),D.zoom("mouse",s(M(A(O,$),D.mouse[0],D.mouse[1]),D.extent,d));function H(){D.wheel=null,D.end()}}function z(R,...B){if(b||!e.apply(this,arguments))return;var D=R.currentTarget,O=k(this,B,!0).event(R),$=ls(R.view).on("mousemove.zoom",Y,!0).on("mouseup.zoom",P,!0),F=ws(R,D),H=R.clientX,I=R.clientY;rE(R.view),Yp(R),O.mouse=[F,this.__zoom.invert(F)],Yd(this),O.start();function Y(W){if(lc(W),!O.moved){var le=W.clientX-H,K=W.clientY-I;O.moved=le*le+K*K>N}O.event(W).zoom("mouse",s(M(O.that.__zoom,O.mouse[0]=ws(W,D),O.mouse[1]),O.extent,d))}function P(W){$.on("mousemove.zoom mouseup.zoom",null),iE(W.view,O.moved),lc(W),O.event(W).end()}}function G(R,...B){if(e.apply(this,arguments)){var D=this.__zoom,O=ws(R.changedTouches?R.changedTouches[0]:R,this),$=D.invert(O),F=D.k*(R.shiftKey?.5:2),H=s(M(A(D,F),O,$),n.apply(this,B),d);lc(R),f>0?ls(this).transition().duration(f).call(T,H,O,R):ls(this).call(E.transform,H,O,R)}}function U(R,...B){if(e.apply(this,arguments)){var D=R.touches,O=D.length,$=k(this,B,R.changedTouches.length===O).event(R),F,H,I,Y;for(Yp(R),H=0;H<O;++H)I=D[H],Y=ws(I,this),Y=[Y,this.__zoom.invert(Y),I.identifier],$.touch0?!$.touch1&&$.touch0[2]!==Y[2]&&($.touch1=Y,$.taps=0):($.touch0=Y,F=!0,$.taps=1+!!y);y&&(y=clearTimeout(y)),F&&($.taps<2&&(g=Y[0],y=setTimeout(function(){y=null},v)),Yd(this),$.start())}}function X(R,...B){if(this.__zooming){var D=k(this,B).event(R),O=R.changedTouches,$=O.length,F,H,I,Y;for(lc(R),F=0;F<$;++F)H=O[F],I=ws(H,this),D.touch0&&D.touch0[2]===H.identifier?D.touch0[0]=I:D.touch1&&D.touch1[2]===H.identifier&&(D.touch1[0]=I);if(H=D.that.__zoom,D.touch1){var P=D.touch0[0],W=D.touch0[1],le=D.touch1[0],K=D.touch1[1],de=(de=le[0]-P[0])*de+(de=le[1]-P[1])*de,Q=(Q=K[0]-W[0])*Q+(Q=K[1]-W[1])*Q;H=A(H,Math.sqrt(de/Q)),I=[(P[0]+le[0])/2,(P[1]+le[1])/2],Y=[(W[0]+K[0])/2,(W[1]+K[1])/2]}else if(D.touch0)I=D.touch0[0],Y=D.touch0[1];else return;D.zoom("touch",s(M(H,I,Y),D.extent,d))}}function V(R,...B){if(this.__zooming){var D=k(this,B).event(R),O=R.changedTouches,$=O.length,F,H;for(Yp(R),b&&clearTimeout(b),b=setTimeout(function(){b=null},v),F=0;F<$;++F)H=O[F],D.touch0&&D.touch0[2]===H.identifier?delete D.touch0:D.touch1&&D.touch1[2]===H.identifier&&delete D.touch1;if(D.touch1&&!D.touch0&&(D.touch0=D.touch1,delete D.touch1),D.touch0)D.touch0[1]=this.__zoom.invert(D.touch0[0]);else if(D.end(),D.taps===2&&(H=ws(H,this),Math.hypot(g[0]-H[0],g[1]-H[1])<j)){var I=ls(this).on("dblclick.zoom");I&&I.apply(this,arguments)}}}return E.wheelDelta=function(R){return arguments.length?(i=typeof R=="function"?R:jd(+R),E):i},E.filter=function(R){return arguments.length?(e=typeof R=="function"?R:jd(!!R),E):e},E.touchable=function(R){return arguments.length?(l=typeof R=="function"?R:jd(!!R),E):l},E.extent=function(R){return arguments.length?(n=typeof R=="function"?R:jd([[+R[0][0],+R[0][1]],[+R[1][0],+R[1][1]]]),E):n},E.scaleExtent=function(R){return arguments.length?(o[0]=+R[0],o[1]=+R[1],E):[o[0],o[1]]},E.translateExtent=function(R){return arguments.length?(d[0][0]=+R[0][0],d[1][0]=+R[1][0],d[0][1]=+R[0][1],d[1][1]=+R[1][1],E):[[d[0][0],d[0][1]],[d[1][0],d[1][1]]]},E.constrain=function(R){return arguments.length?(s=R,E):s},E.duration=function(R){return arguments.length?(f=+R,E):f},E.interpolate=function(R){return arguments.length?(p=R,E):p},E.on=function(){var R=h.on.apply(h,arguments);return R===h?E:R},E.clickDistance=function(R){return arguments.length?(N=(R=+R)*R,E):Math.sqrt(N)},E.tapDistance=function(R){return arguments.length?(j=+R,E):j},E}const Yf=u.createContext(null),C$=Yf.Provider,Sr={error001:()=>"[React Flow]: Seems like you have not used zustand provider as an ancestor. Help: https://reactflow.dev/error#001",error002:()=>"It looks like you've created a new nodeTypes or edgeTypes object. If this wasn't on purpose please define the nodeTypes/edgeTypes outside of the component or memoize them.",error003:e=>`Node type "${e}" not found. Using fallback type "default".`,error004:()=>"The React Flow parent container needs a width and a height to render the graph.",error005:()=>"Only child nodes can use a parent extent.",error006:()=>"Can't create edge. An edge needs a source and a target.",error007:e=>`The old edge with id=${e} does not exist.`,error009:e=>`Marker type "${e}" doesn't exist.`,error008:(e,n)=>`Couldn't create edge for ${e?"target":"source"} handle id: "${e?n.targetHandle:n.sourceHandle}", edge id: ${n.id}.`,error010:()=>"Handle: No node id found. Make sure to only use a Handle inside a custom Node.",error011:e=>`Edge type "${e}" not found. Using fallback type "default".`,error012:e=>`Node with id "${e}" does not exist, it may have been removed. This can happen when a node is deleted before the "onNodeClick" handler is called.`},SE=Sr.error001();function Dn(e,n){const s=u.useContext(Yf);if(s===null)throw new Error(SE);return Y1(s,e,n)}const ra=()=>{const e=u.useContext(Yf);if(e===null)throw new Error(SE);return u.useMemo(()=>({getState:e.getState,setState:e.setState,subscribe:e.subscribe,destroy:e.destroy}),[e])},A$=e=>e.userSelectionActive?"none":"all";function Qg({position:e,children:n,className:s,style:i,...l}){const o=Dn(A$),d=`${e}`.split("-");return Ze.createElement("div",{className:ma(["react-flow__panel",s,...d]),style:{...i,pointerEvents:o},...l},n)}function T$({proOptions:e,position:n="bottom-right"}){return e?.hideAttribution?null:Ze.createElement(Qg,{position:n,className:"react-flow__attribution","data-message":"Please only hide this attribution when you are subscribed to React Flow Pro: https://reactflow.dev/pro"},Ze.createElement("a",{href:"https://reactflow.dev",target:"_blank",rel:"noopener noreferrer","aria-label":"React Flow attribution"},"React Flow"))}const M$=({x:e,y:n,label:s,labelStyle:i={},labelShowBg:l=!0,labelBgStyle:o={},labelBgPadding:d=[2,4],labelBgBorderRadius:f=2,children:p,className:h,...y})=>{const g=u.useRef(null),[b,v]=u.useState({x:0,y:0,width:0,height:0}),S=ma(["react-flow__edge-textwrapper",h]);return u.useEffect(()=>{if(g.current){const N=g.current.getBBox();v({x:N.x,y:N.y,width:N.width,height:N.height})}},[s]),typeof s>"u"||!s?null:Ze.createElement("g",{transform:`translate(${e-b.width/2} ${n-b.height/2})`,className:S,visibility:b.width?"visible":"hidden",...y},l&&Ze.createElement("rect",{width:b.width+2*d[0],x:-d[0],y:-d[1],height:b.height+2*d[1],className:"react-flow__edge-textbg",style:o,rx:f,ry:f}),Ze.createElement("text",{className:"react-flow__edge-text",y:b.height/2,dy:"0.3em",ref:g,style:i},s),p)};var k$=u.memo(M$);const Jg=e=>({width:e.offsetWidth,height:e.offsetHeight}),Kl=(e,n=0,s=1)=>Math.min(Math.max(e,n),s),eb=(e={x:0,y:0},n)=>({x:Kl(e.x,n[0][0],n[1][0]),y:Kl(e.y,n[0][1],n[1][1])}),Ww=(e,n,s)=>e<n?Kl(Math.abs(e-n),1,50)/50:e>s?-Kl(Math.abs(e-s),1,50)/50:0,wE=(e,n)=>{const s=Ww(e.x,35,n.width-35)*20,i=Ww(e.y,35,n.height-35)*20;return[s,i]},NE=e=>e.getRootNode?.()||window?.document,jE=(e,n)=>({x:Math.min(e.x,n.x),y:Math.min(e.y,n.y),x2:Math.max(e.x2,n.x2),y2:Math.max(e.y2,n.y2)}),zc=({x:e,y:n,width:s,height:i})=>({x:e,y:n,x2:e+s,y2:n+i}),EE=({x:e,y:n,x2:s,y2:i})=>({x:e,y:n,width:s-e,height:i-n}),Xw=e=>({...e.positionAbsolute||{x:0,y:0},width:e.width||0,height:e.height||0}),R$=(e,n)=>EE(jE(zc(e),zc(n))),qy=(e,n)=>{const s=Math.max(0,Math.min(e.x+e.width,n.x+n.width)-Math.max(e.x,n.x)),i=Math.max(0,Math.min(e.y+e.height,n.y+n.height)-Math.max(e.y,n.y));return Math.ceil(s*i)},I$=e=>cs(e.width)&&cs(e.height)&&cs(e.x)&&cs(e.y),cs=e=>!isNaN(e)&&isFinite(e),Yn=Symbol.for("internals"),_E=["Enter"," ","Escape"],L$=(e,n)=>{},D$=e=>"nativeEvent"in e;function Py(e){const s=(D$(e)?e.nativeEvent:e).composedPath?.()?.[0]||e.target;return["INPUT","SELECT","TEXTAREA"].includes(s?.nodeName)||s?.hasAttribute("contenteditable")||!!s?.closest(".nokey")}const CE=e=>"clientX"in e,ai=(e,n)=>{const s=CE(e),i=s?e.clientX:e.touches?.[0].clientX,l=s?e.clientY:e.touches?.[0].clientY;return{x:i-(n?.left??0),y:l-(n?.top??0)}},ff=()=>typeof navigator<"u"&&navigator?.userAgent?.indexOf("Mac")>=0,ro=({id:e,path:n,labelX:s,labelY:i,label:l,labelStyle:o,labelShowBg:d,labelBgStyle:f,labelBgPadding:p,labelBgBorderRadius:h,style:y,markerEnd:g,markerStart:b,interactionWidth:v=20})=>Ze.createElement(Ze.Fragment,null,Ze.createElement("path",{id:e,style:y,d:n,fill:"none",className:"react-flow__edge-path",markerEnd:g,markerStart:b}),v&&Ze.createElement("path",{d:n,fill:"none",strokeOpacity:0,strokeWidth:v,className:"react-flow__edge-interaction"}),l&&cs(s)&&cs(i)?Ze.createElement(k$,{x:s,y:i,label:l,labelStyle:o,labelShowBg:d,labelBgStyle:f,labelBgPadding:p,labelBgBorderRadius:h}):null);ro.displayName="BaseEdge";function oc(e,n,s){return s===void 0?s:i=>{const l=n().edges.find(o=>o.id===e);l&&s(i,{...l})}}function AE({sourceX:e,sourceY:n,targetX:s,targetY:i}){const l=Math.abs(s-e)/2,o=s<e?s+l:s-l,d=Math.abs(i-n)/2,f=i<n?i+d:i-d;return[o,f,l,d]}function TE({sourceX:e,sourceY:n,targetX:s,targetY:i,sourceControlX:l,sourceControlY:o,targetControlX:d,targetControlY:f}){const p=e*.125+l*.375+d*.375+s*.125,h=n*.125+o*.375+f*.375+i*.125,y=Math.abs(p-e),g=Math.abs(h-n);return[p,h,y,g]}var qi;(function(e){e.Strict="strict",e.Loose="loose"})(qi||(qi={}));var Oi;(function(e){e.Free="free",e.Vertical="vertical",e.Horizontal="horizontal"})(Oi||(Oi={}));var Bc;(function(e){e.Partial="partial",e.Full="full"})(Bc||(Bc={}));var ti;(function(e){e.Bezier="default",e.Straight="straight",e.Step="step",e.SmoothStep="smoothstep",e.SimpleBezier="simplebezier"})(ti||(ti={}));var mf;(function(e){e.Arrow="arrow",e.ArrowClosed="arrowclosed"})(mf||(mf={}));var Gt;(function(e){e.Left="left",e.Top="top",e.Right="right",e.Bottom="bottom"})(Gt||(Gt={}));function Kw({pos:e,x1:n,y1:s,x2:i,y2:l}){return e===Gt.Left||e===Gt.Right?[.5*(n+i),s]:[n,.5*(s+l)]}function ME({sourceX:e,sourceY:n,sourcePosition:s=Gt.Bottom,targetX:i,targetY:l,targetPosition:o=Gt.Top}){const[d,f]=Kw({pos:s,x1:e,y1:n,x2:i,y2:l}),[p,h]=Kw({pos:o,x1:i,y1:l,x2:e,y2:n}),[y,g,b,v]=TE({sourceX:e,sourceY:n,targetX:i,targetY:l,sourceControlX:d,sourceControlY:f,targetControlX:p,targetControlY:h});return[`M${e},${n} C${d},${f} ${p},${h} ${i},${l}`,y,g,b,v]}const tb=u.memo(({sourceX:e,sourceY:n,targetX:s,targetY:i,sourcePosition:l=Gt.Bottom,targetPosition:o=Gt.Top,label:d,labelStyle:f,labelShowBg:p,labelBgStyle:h,labelBgPadding:y,labelBgBorderRadius:g,style:b,markerEnd:v,markerStart:S,interactionWidth:N})=>{const[j,E,A]=ME({sourceX:e,sourceY:n,sourcePosition:l,targetX:s,targetY:i,targetPosition:o});return Ze.createElement(ro,{path:j,labelX:E,labelY:A,label:d,labelStyle:f,labelShowBg:p,labelBgStyle:h,labelBgPadding:y,labelBgBorderRadius:g,style:b,markerEnd:v,markerStart:S,interactionWidth:N})});tb.displayName="SimpleBezierEdge";const Zw={[Gt.Left]:{x:-1,y:0},[Gt.Right]:{x:1,y:0},[Gt.Top]:{x:0,y:-1},[Gt.Bottom]:{x:0,y:1}},O$=({source:e,sourcePosition:n=Gt.Bottom,target:s})=>n===Gt.Left||n===Gt.Right?e.x<s.x?{x:1,y:0}:{x:-1,y:0}:e.y<s.y?{x:0,y:1}:{x:0,y:-1},Qw=(e,n)=>Math.sqrt(Math.pow(n.x-e.x,2)+Math.pow(n.y-e.y,2));function $$({source:e,sourcePosition:n=Gt.Bottom,target:s,targetPosition:i=Gt.Top,center:l,offset:o}){const d=Zw[n],f=Zw[i],p={x:e.x+d.x*o,y:e.y+d.y*o},h={x:s.x+f.x*o,y:s.y+f.y*o},y=O$({source:p,sourcePosition:n,target:h}),g=y.x!==0?"x":"y",b=y[g];let v=[],S,N;const j={x:0,y:0},E={x:0,y:0},[A,M,_,T]=AE({sourceX:e.x,sourceY:e.y,targetX:s.x,targetY:s.y});if(d[g]*f[g]===-1){S=l.x??A,N=l.y??M;const C=[{x:S,y:p.y},{x:S,y:h.y}],L=[{x:p.x,y:N},{x:h.x,y:N}];d[g]===b?v=g==="x"?C:L:v=g==="x"?L:C}else{const C=[{x:p.x,y:h.y}],L=[{x:h.x,y:p.y}];if(g==="x"?v=d.x===b?L:C:v=d.y===b?C:L,n===i){const V=Math.abs(e[g]-s[g]);if(V<=o){const R=Math.min(o-1,o-V);d[g]===b?j[g]=(p[g]>e[g]?-1:1)*R:E[g]=(h[g]>s[g]?-1:1)*R}}if(n!==i){const V=g==="x"?"y":"x",R=d[g]===f[V],B=p[V]>h[V],D=p[V]<h[V];(d[g]===1&&(!R&&B||R&&D)||d[g]!==1&&(!R&&D||R&&B))&&(v=g==="x"?C:L)}const z={x:p.x+j.x,y:p.y+j.y},G={x:h.x+E.x,y:h.y+E.y},U=Math.max(Math.abs(z.x-v[0].x),Math.abs(G.x-v[0].x)),X=Math.max(Math.abs(z.y-v[0].y),Math.abs(G.y-v[0].y));U>=X?(S=(z.x+G.x)/2,N=v[0].y):(S=v[0].x,N=(z.y+G.y)/2)}return[[e,{x:p.x+j.x,y:p.y+j.y},...v,{x:h.x+E.x,y:h.y+E.y},s],S,N,_,T]}function F$(e,n,s,i){const l=Math.min(Qw(e,n)/2,Qw(n,s)/2,i),{x:o,y:d}=n;if(e.x===o&&o===s.x||e.y===d&&d===s.y)return`L${o} ${d}`;if(e.y===d){const h=e.x<s.x?-1:1,y=e.y<s.y?1:-1;return`L ${o+l*h},${d}Q ${o},${d} ${o},${d+l*y}`}const f=e.x<s.x?1:-1,p=e.y<s.y?-1:1;return`L ${o},${d+l*p}Q ${o},${d} ${o+l*f},${d}`}function hf({sourceX:e,sourceY:n,sourcePosition:s=Gt.Bottom,targetX:i,targetY:l,targetPosition:o=Gt.Top,borderRadius:d=5,centerX:f,centerY:p,offset:h=20}){const[y,g,b,v,S]=$$({source:{x:e,y:n},sourcePosition:s,target:{x:i,y:l},targetPosition:o,center:{x:f,y:p},offset:h});return[y.reduce((j,E,A)=>{let M="";return A>0&&A<y.length-1?M=F$(y[A-1],E,y[A+1],d):M=`${A===0?"M":"L"}${E.x} ${E.y}`,j+=M,j},""),g,b,v,S]}const Gf=u.memo(({sourceX:e,sourceY:n,targetX:s,targetY:i,label:l,labelStyle:o,labelShowBg:d,labelBgStyle:f,labelBgPadding:p,labelBgBorderRadius:h,style:y,sourcePosition:g=Gt.Bottom,targetPosition:b=Gt.Top,markerEnd:v,markerStart:S,pathOptions:N,interactionWidth:j})=>{const[E,A,M]=hf({sourceX:e,sourceY:n,sourcePosition:g,targetX:s,targetY:i,targetPosition:b,borderRadius:N?.borderRadius,offset:N?.offset});return Ze.createElement(ro,{path:E,labelX:A,labelY:M,label:l,labelStyle:o,labelShowBg:d,labelBgStyle:f,labelBgPadding:p,labelBgBorderRadius:h,style:y,markerEnd:v,markerStart:S,interactionWidth:j})});Gf.displayName="SmoothStepEdge";const nb=u.memo(e=>Ze.createElement(Gf,{...e,pathOptions:u.useMemo(()=>({borderRadius:0,offset:e.pathOptions?.offset}),[e.pathOptions?.offset])}));nb.displayName="StepEdge";function z$({sourceX:e,sourceY:n,targetX:s,targetY:i}){const[l,o,d,f]=AE({sourceX:e,sourceY:n,targetX:s,targetY:i});return[`M ${e},${n}L ${s},${i}`,l,o,d,f]}const ab=u.memo(({sourceX:e,sourceY:n,targetX:s,targetY:i,label:l,labelStyle:o,labelShowBg:d,labelBgStyle:f,labelBgPadding:p,labelBgBorderRadius:h,style:y,markerEnd:g,markerStart:b,interactionWidth:v})=>{const[S,N,j]=z$({sourceX:e,sourceY:n,targetX:s,targetY:i});return Ze.createElement(ro,{path:S,labelX:N,labelY:j,label:l,labelStyle:o,labelShowBg:d,labelBgStyle:f,labelBgPadding:p,labelBgBorderRadius:h,style:y,markerEnd:g,markerStart:b,interactionWidth:v})});ab.displayName="StraightEdge";function Ed(e,n){return e>=0?.5*e:n*25*Math.sqrt(-e)}function Jw({pos:e,x1:n,y1:s,x2:i,y2:l,c:o}){switch(e){case Gt.Left:return[n-Ed(n-i,o),s];case Gt.Right:return[n+Ed(i-n,o),s];case Gt.Top:return[n,s-Ed(s-l,o)];case Gt.Bottom:return[n,s+Ed(l-s,o)]}}function kE({sourceX:e,sourceY:n,sourcePosition:s=Gt.Bottom,targetX:i,targetY:l,targetPosition:o=Gt.Top,curvature:d=.25}){const[f,p]=Jw({pos:s,x1:e,y1:n,x2:i,y2:l,c:d}),[h,y]=Jw({pos:o,x1:i,y1:l,x2:e,y2:n,c:d}),[g,b,v,S]=TE({sourceX:e,sourceY:n,targetX:i,targetY:l,sourceControlX:f,sourceControlY:p,targetControlX:h,targetControlY:y});return[`M${e},${n} C${f},${p} ${h},${y} ${i},${l}`,g,b,v,S]}const pf=u.memo(({sourceX:e,sourceY:n,targetX:s,targetY:i,sourcePosition:l=Gt.Bottom,targetPosition:o=Gt.Top,label:d,labelStyle:f,labelShowBg:p,labelBgStyle:h,labelBgPadding:y,labelBgBorderRadius:g,style:b,markerEnd:v,markerStart:S,pathOptions:N,interactionWidth:j})=>{const[E,A,M]=kE({sourceX:e,sourceY:n,sourcePosition:l,targetX:s,targetY:i,targetPosition:o,curvature:N?.curvature});return Ze.createElement(ro,{path:E,labelX:A,labelY:M,label:d,labelStyle:f,labelShowBg:p,labelBgStyle:h,labelBgPadding:y,labelBgBorderRadius:g,style:b,markerEnd:v,markerStart:S,interactionWidth:j})});pf.displayName="BezierEdge";const sb=u.createContext(null),B$=sb.Provider;sb.Consumer;const U$=()=>u.useContext(sb),q$=e=>"id"in e&&"source"in e&&"target"in e,P$=({source:e,sourceHandle:n,target:s,targetHandle:i})=>`reactflow__edge-${e}${n||""}-${s}${i||""}`,Hy=(e,n)=>typeof e>"u"?"":typeof e=="string"?e:`${n?`${n}__`:""}${Object.keys(e).sort().map(i=>`${i}=${e[i]}`).join("&")}`,H$=(e,n)=>n.some(s=>s.source===e.source&&s.target===e.target&&(s.sourceHandle===e.sourceHandle||!s.sourceHandle&&!e.sourceHandle)&&(s.targetHandle===e.targetHandle||!s.targetHandle&&!e.targetHandle)),V$=(e,n)=>{if(!e.source||!e.target)return n;let s;return q$(e)?s={...e}:s={...e,id:P$(e)},H$(s,n)?n:n.concat(s)},Vy=({x:e,y:n},[s,i,l],o,[d,f])=>{const p={x:(e-s)/l,y:(n-i)/l};return o?{x:d*Math.round(p.x/d),y:f*Math.round(p.y/f)}:p},RE=({x:e,y:n},[s,i,l])=>({x:e*l+s,y:n*l+i}),Fi=(e,n=[0,0])=>{if(!e)return{x:0,y:0,positionAbsolute:{x:0,y:0}};const s=(e.width??0)*n[0],i=(e.height??0)*n[1],l={x:e.position.x-s,y:e.position.y-i};return{...l,positionAbsolute:e.positionAbsolute?{x:e.positionAbsolute.x-s,y:e.positionAbsolute.y-i}:l}},Wf=(e,n=[0,0])=>{if(e.length===0)return{x:0,y:0,width:0,height:0};const s=e.reduce((i,l)=>{const{x:o,y:d}=Fi(l,n).positionAbsolute;return jE(i,zc({x:o,y:d,width:l.width||0,height:l.height||0}))},{x:1/0,y:1/0,x2:-1/0,y2:-1/0});return EE(s)},IE=(e,n,[s,i,l]=[0,0,1],o=!1,d=!1,f=[0,0])=>{const p={x:(n.x-s)/l,y:(n.y-i)/l,width:n.width/l,height:n.height/l},h=[];return e.forEach(y=>{const{width:g,height:b,selectable:v=!0,hidden:S=!1}=y;if(d&&!v||S)return!1;const{positionAbsolute:N}=Fi(y,f),j={x:N.x,y:N.y,width:g||0,height:b||0},E=qy(p,j),A=typeof g>"u"||typeof b>"u"||g===null||b===null,M=o&&E>0,_=(g||0)*(b||0);(A||M||E>=_||y.dragging)&&h.push(y)}),h},LE=(e,n)=>{const s=e.map(i=>i.id);return n.filter(i=>s.includes(i.source)||s.includes(i.target))},DE=(e,n,s,i,l,o=.1)=>{const d=n/(e.width*(1+o)),f=s/(e.height*(1+o)),p=Math.min(d,f),h=Kl(p,i,l),y=e.x+e.width/2,g=e.y+e.height/2,b=n/2-y*h,v=s/2-g*h;return{x:b,y:v,zoom:h}},Mi=(e,n=0)=>e.transition().duration(n);function eN(e,n,s,i){return(n[s]||[]).reduce((l,o)=>(`${e.id}-${o.id}-${s}`!==i&&l.push({id:o.id||null,type:s,nodeId:e.id,x:(e.positionAbsolute?.x??0)+o.x+o.width/2,y:(e.positionAbsolute?.y??0)+o.y+o.height/2}),l),[])}function Y$(e,n,s,i,l,o){const{x:d,y:f}=ai(e),h=n.elementsFromPoint(d,f).find(S=>S.classList.contains("react-flow__handle"));if(h){const S=h.getAttribute("data-nodeid");if(S){const N=rb(void 0,h),j=h.getAttribute("data-handleid"),E=o({nodeId:S,id:j,type:N});if(E){const A=l.find(M=>M.nodeId===S&&M.type===N&&M.id===j);return{handle:{id:j,type:N,nodeId:S,x:A?.x||s.x,y:A?.y||s.y},validHandleResult:E}}}}let y=[],g=1/0;if(l.forEach(S=>{const N=Math.sqrt((S.x-s.x)**2+(S.y-s.y)**2);if(N<=i){const j=o(S);N<=g&&(N<g?y=[{handle:S,validHandleResult:j}]:N===g&&y.push({handle:S,validHandleResult:j}),g=N)}}),!y.length)return{handle:null,validHandleResult:OE()};if(y.length===1)return y[0];const b=y.some(({validHandleResult:S})=>S.isValid),v=y.some(({handle:S})=>S.type==="target");return y.find(({handle:S,validHandleResult:N})=>v?S.type==="target":b?N.isValid:!0)||y[0]}const G$={source:null,target:null,sourceHandle:null,targetHandle:null},OE=()=>({handleDomNode:null,isValid:!1,connection:G$,endHandle:null});function $E(e,n,s,i,l,o,d){const f=l==="target",p=d.querySelector(`.react-flow__handle[data-id="${e?.nodeId}-${e?.id}-${e?.type}"]`),h={...OE(),handleDomNode:p};if(p){const y=rb(void 0,p),g=p.getAttribute("data-nodeid"),b=p.getAttribute("data-handleid"),v=p.classList.contains("connectable"),S=p.classList.contains("connectableend"),N={source:f?g:s,sourceHandle:f?b:i,target:f?s:g,targetHandle:f?i:b};h.connection=N,v&&S&&(n===qi.Strict?f&&y==="source"||!f&&y==="target":g!==s||b!==i)&&(h.endHandle={nodeId:g,handleId:b,type:y},h.isValid=o(N))}return h}function W$({nodes:e,nodeId:n,handleId:s,handleType:i}){return e.reduce((l,o)=>{if(o[Yn]){const{handleBounds:d}=o[Yn];let f=[],p=[];d&&(f=eN(o,d,"source",`${n}-${s}-${i}`),p=eN(o,d,"target",`${n}-${s}-${i}`)),l.push(...f,...p)}return l},[])}function rb(e,n){return e||(n?.classList.contains("target")?"target":n?.classList.contains("source")?"source":null)}function Gp(e){e?.classList.remove("valid","connecting","react-flow__handle-valid","react-flow__handle-connecting")}function X$(e,n){let s=null;return n?s="valid":e&&!n&&(s="invalid"),s}function FE({event:e,handleId:n,nodeId:s,onConnect:i,isTarget:l,getState:o,setState:d,isValidConnection:f,edgeUpdaterType:p,onReconnectEnd:h}){const y=NE(e.target),{connectionMode:g,domNode:b,autoPanOnConnect:v,connectionRadius:S,onConnectStart:N,panBy:j,getNodes:E,cancelConnection:A}=o();let M=0,_;const{x:T,y:k}=ai(e),C=y?.elementFromPoint(T,k),L=rb(p,C),z=b?.getBoundingClientRect();if(!z||!L)return;let G,U=ai(e,z),X=!1,V=null,R=!1,B=null;const D=W$({nodes:E(),nodeId:s,handleId:n,handleType:L}),O=()=>{if(!v)return;const[H,I]=wE(U,z);j({x:H,y:I}),M=requestAnimationFrame(O)};d({connectionPosition:U,connectionStatus:null,connectionNodeId:s,connectionHandleId:n,connectionHandleType:L,connectionStartHandle:{nodeId:s,handleId:n,type:L},connectionEndHandle:null}),N?.(e,{nodeId:s,handleId:n,handleType:L});function $(H){const{transform:I}=o();U=ai(H,z);const{handle:Y,validHandleResult:P}=Y$(H,y,Vy(U,I,!1,[1,1]),S,D,W=>$E(W,g,s,n,l?"target":"source",f,y));if(_=Y,X||(O(),X=!0),B=P.handleDomNode,V=P.connection,R=P.isValid,d({connectionPosition:_&&R?RE({x:_.x,y:_.y},I):U,connectionStatus:X$(!!_,R),connectionEndHandle:P.endHandle}),!_&&!R&&!B)return Gp(G);V.source!==V.target&&B&&(Gp(G),G=B,B.classList.add("connecting","react-flow__handle-connecting"),B.classList.toggle("valid",R),B.classList.toggle("react-flow__handle-valid",R))}function F(H){(_||B)&&V&&R&&i?.(V),o().onConnectEnd?.(H),p&&h?.(H),Gp(G),A(),cancelAnimationFrame(M),X=!1,R=!1,V=null,B=null,y.removeEventListener("mousemove",$),y.removeEventListener("mouseup",F),y.removeEventListener("touchmove",$),y.removeEventListener("touchend",F)}y.addEventListener("mousemove",$),y.addEventListener("mouseup",F),y.addEventListener("touchmove",$),y.addEventListener("touchend",F)}const tN=()=>!0,K$=e=>({connectionStartHandle:e.connectionStartHandle,connectOnClick:e.connectOnClick,noPanClassName:e.noPanClassName}),Z$=(e,n,s)=>i=>{const{connectionStartHandle:l,connectionEndHandle:o,connectionClickStartHandle:d}=i;return{connecting:l?.nodeId===e&&l?.handleId===n&&l?.type===s||o?.nodeId===e&&o?.handleId===n&&o?.type===s,clickConnecting:d?.nodeId===e&&d?.handleId===n&&d?.type===s}},zE=u.forwardRef(({type:e="source",position:n=Gt.Top,isValidConnection:s,isConnectable:i=!0,isConnectableStart:l=!0,isConnectableEnd:o=!0,id:d,onConnect:f,children:p,className:h,onMouseDown:y,onTouchStart:g,...b},v)=>{const S=d||null,N=e==="target",j=ra(),E=U$(),{connectOnClick:A,noPanClassName:M}=Dn(K$,la),{connecting:_,clickConnecting:T}=Dn(Z$(E,S,e),la);E||j.getState().onError?.("010",Sr.error010());const k=z=>{const{defaultEdgeOptions:G,onConnect:U,hasDefaultEdges:X}=j.getState(),V={...G,...z};if(X){const{edges:R,setEdges:B}=j.getState();B(V$(V,R))}U?.(V),f?.(V)},C=z=>{if(!E)return;const G=CE(z);l&&(G&&z.button===0||!G)&&FE({event:z,handleId:S,nodeId:E,onConnect:k,isTarget:N,getState:j.getState,setState:j.setState,isValidConnection:s||j.getState().isValidConnection||tN}),G?y?.(z):g?.(z)},L=z=>{const{onClickConnectStart:G,onClickConnectEnd:U,connectionClickStartHandle:X,connectionMode:V,isValidConnection:R}=j.getState();if(!E||!X&&!l)return;if(!X){G?.(z,{nodeId:E,handleId:S,handleType:e}),j.setState({connectionClickStartHandle:{nodeId:E,type:e,handleId:S}});return}const B=NE(z.target),D=s||R||tN,{connection:O,isValid:$}=$E({nodeId:E,id:S,type:e},V,X.nodeId,X.handleId||null,X.type,D,B);$&&k(O),U?.(z),j.setState({connectionClickStartHandle:null})};return Ze.createElement("div",{"data-handleid":S,"data-nodeid":E,"data-handlepos":n,"data-id":`${E}-${S}-${e}`,className:ma(["react-flow__handle",`react-flow__handle-${n}`,"nodrag",M,h,{source:!N,target:N,connectable:i,connectablestart:l,connectableend:o,connecting:T,connectionindicator:i&&(l&&!_||o&&_)}]),onMouseDown:C,onTouchStart:C,onClick:A?L:void 0,ref:v,...b},p)});zE.displayName="Handle";var Es=u.memo(zE);const BE=({data:e,isConnectable:n,targetPosition:s=Gt.Top,sourcePosition:i=Gt.Bottom})=>Ze.createElement(Ze.Fragment,null,Ze.createElement(Es,{type:"target",position:s,isConnectable:n}),e?.label,Ze.createElement(Es,{type:"source",position:i,isConnectable:n}));BE.displayName="DefaultNode";var Yy=u.memo(BE);const UE=({data:e,isConnectable:n,sourcePosition:s=Gt.Bottom})=>Ze.createElement(Ze.Fragment,null,e?.label,Ze.createElement(Es,{type:"source",position:s,isConnectable:n}));UE.displayName="InputNode";var qE=u.memo(UE);const PE=({data:e,isConnectable:n,targetPosition:s=Gt.Top})=>Ze.createElement(Ze.Fragment,null,Ze.createElement(Es,{type:"target",position:s,isConnectable:n}),e?.label);PE.displayName="OutputNode";var HE=u.memo(PE);const ib=()=>null;ib.displayName="GroupNode";const Q$=e=>({selectedNodes:e.getNodes().filter(n=>n.selected),selectedEdges:e.edges.filter(n=>n.selected).map(n=>({...n}))}),_d=e=>e.id;function J$(e,n){return la(e.selectedNodes.map(_d),n.selectedNodes.map(_d))&&la(e.selectedEdges.map(_d),n.selectedEdges.map(_d))}const VE=u.memo(({onSelectionChange:e})=>{const n=ra(),{selectedNodes:s,selectedEdges:i}=Dn(Q$,J$);return u.useEffect(()=>{const l={nodes:s,edges:i};e?.(l),n.getState().onSelectionChange.forEach(o=>o(l))},[s,i,e]),null});VE.displayName="SelectionListener";const eF=e=>!!e.onSelectionChange;function tF({onSelectionChange:e}){const n=Dn(eF);return e||n?Ze.createElement(VE,{onSelectionChange:e}):null}const nF=e=>({setNodes:e.setNodes,setEdges:e.setEdges,setDefaultNodesAndEdges:e.setDefaultNodesAndEdges,setMinZoom:e.setMinZoom,setMaxZoom:e.setMaxZoom,setTranslateExtent:e.setTranslateExtent,setNodeExtent:e.setNodeExtent,reset:e.reset});function kl(e,n){u.useEffect(()=>{typeof e<"u"&&n(e)},[e])}function hn(e,n,s){u.useEffect(()=>{typeof n<"u"&&s({[e]:n})},[n])}const aF=({nodes:e,edges:n,defaultNodes:s,defaultEdges:i,onConnect:l,onConnectStart:o,onConnectEnd:d,onClickConnectStart:f,onClickConnectEnd:p,nodesDraggable:h,nodesConnectable:y,nodesFocusable:g,edgesFocusable:b,edgesUpdatable:v,elevateNodesOnSelect:S,minZoom:N,maxZoom:j,nodeExtent:E,onNodesChange:A,onEdgesChange:M,elementsSelectable:_,connectionMode:T,snapGrid:k,snapToGrid:C,translateExtent:L,connectOnClick:z,defaultEdgeOptions:G,fitView:U,fitViewOptions:X,onNodesDelete:V,onEdgesDelete:R,onNodeDrag:B,onNodeDragStart:D,onNodeDragStop:O,onSelectionDrag:$,onSelectionDragStart:F,onSelectionDragStop:H,noPanClassName:I,nodeOrigin:Y,rfId:P,autoPanOnConnect:W,autoPanOnNodeDrag:le,onError:K,connectionRadius:de,isValidConnection:Q,nodeDragThreshold:he})=>{const{setNodes:re,setEdges:Ce,setDefaultNodesAndEdges:Re,setMinZoom:ue,setMaxZoom:se,setTranslateExtent:Le,setNodeExtent:be,reset:De}=Dn(nF,la),Me=ra();return u.useEffect(()=>{const mt=i?.map(ht=>({...ht,...G}));return Re(s,mt),()=>{De()}},[]),hn("defaultEdgeOptions",G,Me.setState),hn("connectionMode",T,Me.setState),hn("onConnect",l,Me.setState),hn("onConnectStart",o,Me.setState),hn("onConnectEnd",d,Me.setState),hn("onClickConnectStart",f,Me.setState),hn("onClickConnectEnd",p,Me.setState),hn("nodesDraggable",h,Me.setState),hn("nodesConnectable",y,Me.setState),hn("nodesFocusable",g,Me.setState),hn("edgesFocusable",b,Me.setState),hn("edgesUpdatable",v,Me.setState),hn("elementsSelectable",_,Me.setState),hn("elevateNodesOnSelect",S,Me.setState),hn("snapToGrid",C,Me.setState),hn("snapGrid",k,Me.setState),hn("onNodesChange",A,Me.setState),hn("onEdgesChange",M,Me.setState),hn("connectOnClick",z,Me.setState),hn("fitViewOnInit",U,Me.setState),hn("fitViewOnInitOptions",X,Me.setState),hn("onNodesDelete",V,Me.setState),hn("onEdgesDelete",R,Me.setState),hn("onNodeDrag",B,Me.setState),hn("onNodeDragStart",D,Me.setState),hn("onNodeDragStop",O,Me.setState),hn("onSelectionDrag",$,Me.setState),hn("onSelectionDragStart",F,Me.setState),hn("onSelectionDragStop",H,Me.setState),hn("noPanClassName",I,Me.setState),hn("nodeOrigin",Y,Me.setState),hn("rfId",P,Me.setState),hn("autoPanOnConnect",W,Me.setState),hn("autoPanOnNodeDrag",le,Me.setState),hn("onError",K,Me.setState),hn("connectionRadius",de,Me.setState),hn("isValidConnection",Q,Me.setState),hn("nodeDragThreshold",he,Me.setState),kl(e,re),kl(n,Ce),kl(N,ue),kl(j,se),kl(L,Le),kl(E,be),null},nN={display:"none"},sF={position:"absolute",width:1,height:1,margin:-1,border:0,padding:0,overflow:"hidden",clip:"rect(0px, 0px, 0px, 0px)",clipPath:"inset(100%)"},YE="react-flow__node-desc",GE="react-flow__edge-desc",rF="react-flow__aria-live",iF=e=>e.ariaLiveMessage;function lF({rfId:e}){const n=Dn(iF);return Ze.createElement("div",{id:`${rF}-${e}`,"aria-live":"assertive","aria-atomic":"true",style:sF},n)}function oF({rfId:e,disableKeyboardA11y:n}){return Ze.createElement(Ze.Fragment,null,Ze.createElement("div",{id:`${YE}-${e}`,style:nN},"Press enter or space to select a node.",!n&&"You can then use the arrow keys to move the node around."," Press delete to remove it and escape to cancel."," "),Ze.createElement("div",{id:`${GE}-${e}`,style:nN},"Press enter or space to select an edge. You can then press delete to remove it or escape to cancel."),!n&&Ze.createElement(lF,{rfId:e}))}var Uc=(e=null,n={actInsideInputWithModifier:!0})=>{const[s,i]=u.useState(!1),l=u.useRef(!1),o=u.useRef(new Set([])),[d,f]=u.useMemo(()=>{if(e!==null){const h=(Array.isArray(e)?e:[e]).filter(g=>typeof g=="string").map(g=>g.split("+")),y=h.reduce((g,b)=>g.concat(...b),[]);return[h,y]}return[[],[]]},[e]);return u.useEffect(()=>{const p=typeof document<"u"?document:null,h=n?.target||p;if(e!==null){const y=v=>{if(l.current=v.ctrlKey||v.metaKey||v.shiftKey,(!l.current||l.current&&!n.actInsideInputWithModifier)&&Py(v))return!1;const N=sN(v.code,f);o.current.add(v[N]),aN(d,o.current,!1)&&(v.preventDefault(),i(!0))},g=v=>{if((!l.current||l.current&&!n.actInsideInputWithModifier)&&Py(v))return!1;const N=sN(v.code,f);aN(d,o.current,!0)?(i(!1),o.current.clear()):o.current.delete(v[N]),v.key==="Meta"&&o.current.clear(),l.current=!1},b=()=>{o.current.clear(),i(!1)};return h?.addEventListener("keydown",y),h?.addEventListener("keyup",g),window.addEventListener("blur",b),()=>{h?.removeEventListener("keydown",y),h?.removeEventListener("keyup",g),window.removeEventListener("blur",b)}}},[e,i]),s};function aN(e,n,s){return e.filter(i=>s||i.length===n.size).some(i=>i.every(l=>n.has(l)))}function sN(e,n){return n.includes(e)?"code":"key"}function WE(e,n,s,i){const l=e.parentNode||e.parentId;if(!l)return s;const o=n.get(l),d=Fi(o,i);return WE(o,n,{x:(s.x??0)+d.x,y:(s.y??0)+d.y,z:(o[Yn]?.z??0)>(s.z??0)?o[Yn]?.z??0:s.z??0},i)}function XE(e,n,s){e.forEach(i=>{const l=i.parentNode||i.parentId;if(l&&!e.has(l))throw new Error(`Parent node ${l} not found`);if(l||s?.[i.id]){const{x:o,y:d,z:f}=WE(i,e,{...i.position,z:i[Yn]?.z??0},n);i.positionAbsolute={x:o,y:d},i[Yn].z=f,s?.[i.id]&&(i[Yn].isParent=!0)}})}function Wp(e,n,s,i){const l=new Map,o={},d=i?1e3:0;return e.forEach(f=>{const p=(cs(f.zIndex)?f.zIndex:0)+(f.selected?d:0),h=n.get(f.id),y={...f,positionAbsolute:{x:f.position.x,y:f.position.y}},g=f.parentNode||f.parentId;g&&(o[g]=!0);const b=h?.type&&h?.type!==f.type;Object.defineProperty(y,Yn,{enumerable:!1,value:{handleBounds:b?void 0:h?.[Yn]?.handleBounds,z:p}}),l.set(f.id,y)}),XE(l,s,o),l}function KE(e,n={}){const{getNodes:s,width:i,height:l,minZoom:o,maxZoom:d,d3Zoom:f,d3Selection:p,fitViewOnInitDone:h,fitViewOnInit:y,nodeOrigin:g}=e(),b=n.initial&&!h&&y;if(f&&p&&(b||!n.initial)){const S=s().filter(j=>{const E=n.includeHiddenNodes?j.width&&j.height:!j.hidden;return n.nodes?.length?E&&n.nodes.some(A=>A.id===j.id):E}),N=S.every(j=>j.width&&j.height);if(S.length>0&&N){const j=Wf(S,g),{x:E,y:A,zoom:M}=DE(j,i,l,n.minZoom??o,n.maxZoom??d,n.padding??.1),_=br.translate(E,A).scale(M);return typeof n.duration=="number"&&n.duration>0?f.transform(Mi(p,n.duration),_):f.transform(p,_),!0}}return!1}function cF(e,n){return e.forEach(s=>{const i=n.get(s.id);i&&n.set(i.id,{...i,[Yn]:i[Yn],selected:s.selected})}),new Map(n)}function uF(e,n){return n.map(s=>{const i=e.find(l=>l.id===s.id);return i&&(s.selected=i.selected),s})}function Cd({changedNodes:e,changedEdges:n,get:s,set:i}){const{nodeInternals:l,edges:o,onNodesChange:d,onEdgesChange:f,hasDefaultNodes:p,hasDefaultEdges:h}=s();e?.length&&(p&&i({nodeInternals:cF(e,l)}),d?.(e)),n?.length&&(h&&i({edges:uF(n,o)}),f?.(n))}const Rl=()=>{},dF={zoomIn:Rl,zoomOut:Rl,zoomTo:Rl,getZoom:()=>1,setViewport:Rl,getViewport:()=>({x:0,y:0,zoom:1}),fitView:()=>!1,setCenter:Rl,fitBounds:Rl,project:e=>e,screenToFlowPosition:e=>e,flowToScreenPosition:e=>e,viewportInitialized:!1},fF=e=>({d3Zoom:e.d3Zoom,d3Selection:e.d3Selection}),mF=()=>{const e=ra(),{d3Zoom:n,d3Selection:s}=Dn(fF,la);return u.useMemo(()=>s&&n?{zoomIn:l=>n.scaleBy(Mi(s,l?.duration),1.2),zoomOut:l=>n.scaleBy(Mi(s,l?.duration),1/1.2),zoomTo:(l,o)=>n.scaleTo(Mi(s,o?.duration),l),getZoom:()=>e.getState().transform[2],setViewport:(l,o)=>{const[d,f,p]=e.getState().transform,h=br.translate(l.x??d,l.y??f).scale(l.zoom??p);n.transform(Mi(s,o?.duration),h)},getViewport:()=>{const[l,o,d]=e.getState().transform;return{x:l,y:o,zoom:d}},fitView:l=>KE(e.getState,l),setCenter:(l,o,d)=>{const{width:f,height:p,maxZoom:h}=e.getState(),y=typeof d?.zoom<"u"?d.zoom:h,g=f/2-l*y,b=p/2-o*y,v=br.translate(g,b).scale(y);n.transform(Mi(s,d?.duration),v)},fitBounds:(l,o)=>{const{width:d,height:f,minZoom:p,maxZoom:h}=e.getState(),{x:y,y:g,zoom:b}=DE(l,d,f,p,h,o?.padding??.1),v=br.translate(y,g).scale(b);n.transform(Mi(s,o?.duration),v)},project:l=>{const{transform:o,snapToGrid:d,snapGrid:f}=e.getState();return console.warn("[DEPRECATED] `project` is deprecated. Instead use `screenToFlowPosition`. There is no need to subtract the react flow bounds anymore! https://reactflow.dev/api-reference/types/react-flow-instance#screen-to-flow-position"),Vy(l,o,d,f)},screenToFlowPosition:l=>{const{transform:o,snapToGrid:d,snapGrid:f,domNode:p}=e.getState();if(!p)return l;const{x:h,y}=p.getBoundingClientRect(),g={x:l.x-h,y:l.y-y};return Vy(g,o,d,f)},flowToScreenPosition:l=>{const{transform:o,domNode:d}=e.getState();if(!d)return l;const{x:f,y:p}=d.getBoundingClientRect(),h=RE(l,o);return{x:h.x+f,y:h.y+p}},viewportInitialized:!0}:dF,[n,s])};function Xf(){const e=mF(),n=ra(),s=u.useCallback(()=>n.getState().getNodes().map(N=>({...N})),[]),i=u.useCallback(N=>n.getState().nodeInternals.get(N),[]),l=u.useCallback(()=>{const{edges:N=[]}=n.getState();return N.map(j=>({...j}))},[]),o=u.useCallback(N=>{const{edges:j=[]}=n.getState();return j.find(E=>E.id===N)},[]),d=u.useCallback(N=>{const{getNodes:j,setNodes:E,hasDefaultNodes:A,onNodesChange:M}=n.getState(),_=j(),T=typeof N=="function"?N(_):N;if(A)E(T);else if(M){const k=T.length===0?_.map(C=>({type:"remove",id:C.id})):T.map(C=>({item:C,type:"reset"}));M(k)}},[]),f=u.useCallback(N=>{const{edges:j=[],setEdges:E,hasDefaultEdges:A,onEdgesChange:M}=n.getState(),_=typeof N=="function"?N(j):N;if(A)E(_);else if(M){const T=_.length===0?j.map(k=>({type:"remove",id:k.id})):_.map(k=>({item:k,type:"reset"}));M(T)}},[]),p=u.useCallback(N=>{const j=Array.isArray(N)?N:[N],{getNodes:E,setNodes:A,hasDefaultNodes:M,onNodesChange:_}=n.getState();if(M){const k=[...E(),...j];A(k)}else if(_){const T=j.map(k=>({item:k,type:"add"}));_(T)}},[]),h=u.useCallback(N=>{const j=Array.isArray(N)?N:[N],{edges:E=[],setEdges:A,hasDefaultEdges:M,onEdgesChange:_}=n.getState();if(M)A([...E,...j]);else if(_){const T=j.map(k=>({item:k,type:"add"}));_(T)}},[]),y=u.useCallback(()=>{const{getNodes:N,edges:j=[],transform:E}=n.getState(),[A,M,_]=E;return{nodes:N().map(T=>({...T})),edges:j.map(T=>({...T})),viewport:{x:A,y:M,zoom:_}}},[]),g=u.useCallback(({nodes:N,edges:j})=>{const{nodeInternals:E,getNodes:A,edges:M,hasDefaultNodes:_,hasDefaultEdges:T,onNodesDelete:k,onEdgesDelete:C,onNodesChange:L,onEdgesChange:z}=n.getState(),G=(N||[]).map(B=>B.id),U=(j||[]).map(B=>B.id),X=A().reduce((B,D)=>{const O=D.parentNode||D.parentId,$=!G.includes(D.id)&&O&&B.find(H=>H.id===O);return(typeof D.deletable=="boolean"?D.deletable:!0)&&(G.includes(D.id)||$)&&B.push(D),B},[]),V=M.filter(B=>typeof B.deletable=="boolean"?B.deletable:!0),R=V.filter(B=>U.includes(B.id));if(X||R){const B=LE(X,V),D=[...R,...B],O=D.reduce(($,F)=>($.includes(F.id)||$.push(F.id),$),[]);if((T||_)&&(T&&n.setState({edges:M.filter($=>!O.includes($.id))}),_&&(X.forEach($=>{E.delete($.id)}),n.setState({nodeInternals:new Map(E)}))),O.length>0&&(C?.(D),z&&z(O.map($=>({id:$,type:"remove"})))),X.length>0&&(k?.(X),L)){const $=X.map(F=>({id:F.id,type:"remove"}));L($)}}},[]),b=u.useCallback(N=>{const j=I$(N),E=j?null:n.getState().nodeInternals.get(N.id);return!j&&!E?[null,null,j]:[j?N:Xw(E),E,j]},[]),v=u.useCallback((N,j=!0,E)=>{const[A,M,_]=b(N);return A?(E||n.getState().getNodes()).filter(T=>{if(!_&&(T.id===M.id||!T.positionAbsolute))return!1;const k=Xw(T),C=qy(k,A);return j&&C>0||C>=A.width*A.height}):[]},[]),S=u.useCallback((N,j,E=!0)=>{const[A]=b(N);if(!A)return!1;const M=qy(A,j);return E&&M>0||M>=A.width*A.height},[]);return u.useMemo(()=>({...e,getNodes:s,getNode:i,getEdges:l,getEdge:o,setNodes:d,setEdges:f,addNodes:p,addEdges:h,toObject:y,deleteElements:g,getIntersectingNodes:v,isNodeIntersecting:S}),[e,s,i,l,o,d,f,p,h,y,g,v,S])}const hF={actInsideInputWithModifier:!1};var pF=({deleteKeyCode:e,multiSelectionKeyCode:n})=>{const s=ra(),{deleteElements:i}=Xf(),l=Uc(e,hF),o=Uc(n);u.useEffect(()=>{if(l){const{edges:d,getNodes:f}=s.getState(),p=f().filter(y=>y.selected),h=d.filter(y=>y.selected);i({nodes:p,edges:h}),s.setState({nodesSelectionActive:!1})}},[l]),u.useEffect(()=>{s.setState({multiSelectionActive:o})},[o])};function yF(e){const n=ra();u.useEffect(()=>{let s;const i=()=>{if(!e.current)return;const l=Jg(e.current);(l.height===0||l.width===0)&&n.getState().onError?.("004",Sr.error004()),n.setState({width:l.width||500,height:l.height||500})};return i(),window.addEventListener("resize",i),e.current&&(s=new ResizeObserver(()=>i()),s.observe(e.current)),()=>{window.removeEventListener("resize",i),s&&e.current&&s.unobserve(e.current)}},[])}const lb={position:"absolute",width:"100%",height:"100%",top:0,left:0},gF=(e,n)=>e.x!==n.x||e.y!==n.y||e.zoom!==n.k,Ad=e=>({x:e.x,y:e.y,zoom:e.k}),Il=(e,n)=>e.target.closest(`.${n}`),rN=(e,n)=>n===2&&Array.isArray(e)&&e.includes(2),iN=e=>{const n=e.ctrlKey&&ff()?10:1;return-e.deltaY*(e.deltaMode===1?.05:e.deltaMode?1:.002)*n},bF=e=>({d3Zoom:e.d3Zoom,d3Selection:e.d3Selection,d3ZoomHandler:e.d3ZoomHandler,userSelectionActive:e.userSelectionActive}),xF=({onMove:e,onMoveStart:n,onMoveEnd:s,onPaneContextMenu:i,zoomOnScroll:l=!0,zoomOnPinch:o=!0,panOnScroll:d=!1,panOnScrollSpeed:f=.5,panOnScrollMode:p=Oi.Free,zoomOnDoubleClick:h=!0,elementsSelectable:y,panOnDrag:g=!0,defaultViewport:b,translateExtent:v,minZoom:S,maxZoom:N,zoomActivationKeyCode:j,preventScrolling:E=!0,children:A,noWheelClassName:M,noPanClassName:_})=>{const T=u.useRef(),k=ra(),C=u.useRef(!1),L=u.useRef(!1),z=u.useRef(null),G=u.useRef({x:0,y:0,zoom:0}),{d3Zoom:U,d3Selection:X,d3ZoomHandler:V,userSelectionActive:R}=Dn(bF,la),B=Uc(j),D=u.useRef(0),O=u.useRef(!1),$=u.useRef();return yF(z),u.useEffect(()=>{if(z.current){const F=z.current.getBoundingClientRect(),H=vE().scaleExtent([S,N]).translateExtent(v),I=ls(z.current).call(H),Y=br.translate(b.x,b.y).scale(Kl(b.zoom,S,N)),P=[[0,0],[F.width,F.height]],W=H.constrain()(Y,P,v);H.transform(I,W),H.wheelDelta(iN),k.setState({d3Zoom:H,d3Selection:I,d3ZoomHandler:I.on("wheel.zoom"),transform:[W.x,W.y,W.k],domNode:z.current.closest(".react-flow")})}},[]),u.useEffect(()=>{X&&U&&(d&&!B&&!R?X.on("wheel.zoom",F=>{if(Il(F,M))return!1;F.preventDefault(),F.stopImmediatePropagation();const H=X.property("__zoom").k||1;if(F.ctrlKey&&o){const Q=ws(F),he=iN(F),re=H*Math.pow(2,he);U.scaleTo(X,re,Q,F);return}const I=F.deltaMode===1?20:1;let Y=p===Oi.Vertical?0:F.deltaX*I,P=p===Oi.Horizontal?0:F.deltaY*I;!ff()&&F.shiftKey&&p!==Oi.Vertical&&(Y=F.deltaY*I,P=0),U.translateBy(X,-(Y/H)*f,-(P/H)*f,{internal:!0});const W=Ad(X.property("__zoom")),{onViewportChangeStart:le,onViewportChange:K,onViewportChangeEnd:de}=k.getState();clearTimeout($.current),O.current||(O.current=!0,n?.(F,W),le?.(W)),O.current&&(e?.(F,W),K?.(W),$.current=setTimeout(()=>{s?.(F,W),de?.(W),O.current=!1},150))},{passive:!1}):typeof V<"u"&&X.on("wheel.zoom",function(F,H){if(!E&&F.type==="wheel"&&!F.ctrlKey||Il(F,M))return null;F.preventDefault(),V.call(this,F,H)},{passive:!1}))},[R,d,p,X,U,V,B,o,E,M,n,e,s]),u.useEffect(()=>{U&&U.on("start",F=>{if(!F.sourceEvent||F.sourceEvent.internal)return null;D.current=F.sourceEvent?.button;const{onViewportChangeStart:H}=k.getState(),I=Ad(F.transform);C.current=!0,G.current=I,F.sourceEvent?.type==="mousedown"&&k.setState({paneDragging:!0}),H?.(I),n?.(F.sourceEvent,I)})},[U,n]),u.useEffect(()=>{U&&(R&&!C.current?U.on("zoom",null):R||U.on("zoom",F=>{const{onViewportChange:H}=k.getState();if(k.setState({transform:[F.transform.x,F.transform.y,F.transform.k]}),L.current=!!(i&&rN(g,D.current??0)),(e||H)&&!F.sourceEvent?.internal){const I=Ad(F.transform);H?.(I),e?.(F.sourceEvent,I)}}))},[R,U,e,g,i]),u.useEffect(()=>{U&&U.on("end",F=>{if(!F.sourceEvent||F.sourceEvent.internal)return null;const{onViewportChangeEnd:H}=k.getState();if(C.current=!1,k.setState({paneDragging:!1}),i&&rN(g,D.current??0)&&!L.current&&i(F.sourceEvent),L.current=!1,(s||H)&&gF(G.current,F.transform)){const I=Ad(F.transform);G.current=I,clearTimeout(T.current),T.current=setTimeout(()=>{H?.(I),s?.(F.sourceEvent,I)},d?150:0)}})},[U,d,g,s,i]),u.useEffect(()=>{U&&U.filter(F=>{const H=B||l,I=o&&F.ctrlKey;if((g===!0||Array.isArray(g)&&g.includes(1))&&F.button===1&&F.type==="mousedown"&&(Il(F,"react-flow__node")||Il(F,"react-flow__edge")))return!0;if(!g&&!H&&!d&&!h&&!o||R||!h&&F.type==="dblclick"||Il(F,M)&&F.type==="wheel"||Il(F,_)&&(F.type!=="wheel"||d&&F.type==="wheel"&&!B)||!o&&F.ctrlKey&&F.type==="wheel"||!H&&!d&&!I&&F.type==="wheel"||!g&&(F.type==="mousedown"||F.type==="touchstart")||Array.isArray(g)&&!g.includes(F.button)&&F.type==="mousedown")return!1;const Y=Array.isArray(g)&&g.includes(F.button)||!F.button||F.button<=1;return(!F.ctrlKey||F.type==="wheel")&&Y})},[R,U,l,o,d,h,g,y,B]),Ze.createElement("div",{className:"react-flow__renderer",ref:z,style:lb},A)},vF=e=>({userSelectionActive:e.userSelectionActive,userSelectionRect:e.userSelectionRect});function SF(){const{userSelectionActive:e,userSelectionRect:n}=Dn(vF,la);return e&&n?Ze.createElement("div",{className:"react-flow__selection react-flow__container",style:{width:n.width,height:n.height,transform:`translate(${n.x}px, ${n.y}px)`}}):null}function lN(e,n){const s=n.parentNode||n.parentId,i=e.find(l=>l.id===s);if(i){const l=n.position.x+n.width-i.width,o=n.position.y+n.height-i.height;if(l>0||o>0||n.position.x<0||n.position.y<0){if(i.style={...i.style},i.style.width=i.style.width??i.width,i.style.height=i.style.height??i.height,l>0&&(i.style.width+=l),o>0&&(i.style.height+=o),n.position.x<0){const d=Math.abs(n.position.x);i.position.x=i.position.x-d,i.style.width+=d,n.position.x=0}if(n.position.y<0){const d=Math.abs(n.position.y);i.position.y=i.position.y-d,i.style.height+=d,n.position.y=0}i.width=i.style.width,i.height=i.style.height}}}function ZE(e,n){if(e.some(i=>i.type==="reset"))return e.filter(i=>i.type==="reset").map(i=>i.item);const s=e.filter(i=>i.type==="add").map(i=>i.item);return n.reduce((i,l)=>{const o=e.filter(f=>f.id===l.id);if(o.length===0)return i.push(l),i;const d={...l};for(const f of o)if(f)switch(f.type){case"select":{d.selected=f.selected;break}case"position":{typeof f.position<"u"&&(d.position=f.position),typeof f.positionAbsolute<"u"&&(d.positionAbsolute=f.positionAbsolute),typeof f.dragging<"u"&&(d.dragging=f.dragging),d.expandParent&&lN(i,d);break}case"dimensions":{typeof f.dimensions<"u"&&(d.width=f.dimensions.width,d.height=f.dimensions.height),typeof f.updateStyle<"u"&&(d.style={...d.style||{},...f.dimensions}),typeof f.resizing=="boolean"&&(d.resizing=f.resizing),d.expandParent&&lN(i,d);break}case"remove":return i}return i.push(d),i},s)}function ob(e,n){return ZE(e,n)}function QE(e,n){return ZE(e,n)}const Qr=(e,n)=>({id:e,type:"select",selected:n});function $l(e,n){return e.reduce((s,i)=>{const l=n.includes(i.id);return!i.selected&&l?(i.selected=!0,s.push(Qr(i.id,!0))):i.selected&&!l&&(i.selected=!1,s.push(Qr(i.id,!1))),s},[])}const Xp=(e,n)=>s=>{s.target===n.current&&e?.(s)},wF=e=>({userSelectionActive:e.userSelectionActive,elementsSelectable:e.elementsSelectable,dragging:e.paneDragging}),JE=u.memo(({isSelecting:e,selectionMode:n=Bc.Full,panOnDrag:s,onSelectionStart:i,onSelectionEnd:l,onPaneClick:o,onPaneContextMenu:d,onPaneScroll:f,onPaneMouseEnter:p,onPaneMouseMove:h,onPaneMouseLeave:y,children:g})=>{const b=u.useRef(null),v=ra(),S=u.useRef(0),N=u.useRef(0),j=u.useRef(),{userSelectionActive:E,elementsSelectable:A,dragging:M}=Dn(wF,la),_=()=>{v.setState({userSelectionActive:!1,userSelectionRect:null}),S.current=0,N.current=0},T=V=>{o?.(V),v.getState().resetSelectedElements(),v.setState({nodesSelectionActive:!1})},k=V=>{if(Array.isArray(s)&&s?.includes(2)){V.preventDefault();return}d?.(V)},C=f?V=>f(V):void 0,L=V=>{const{resetSelectedElements:R,domNode:B}=v.getState();if(j.current=B?.getBoundingClientRect(),!A||!e||V.button!==0||V.target!==b.current||!j.current)return;const{x:D,y:O}=ai(V,j.current);R(),v.setState({userSelectionRect:{width:0,height:0,startX:D,startY:O,x:D,y:O}}),i?.(V)},z=V=>{const{userSelectionRect:R,nodeInternals:B,edges:D,transform:O,onNodesChange:$,onEdgesChange:F,nodeOrigin:H,getNodes:I}=v.getState();if(!e||!j.current||!R)return;v.setState({userSelectionActive:!0,nodesSelectionActive:!1});const Y=ai(V,j.current),P=R.startX??0,W=R.startY??0,le={...R,x:Y.x<P?Y.x:P,y:Y.y<W?Y.y:W,width:Math.abs(Y.x-P),height:Math.abs(Y.y-W)},K=I(),de=IE(B,le,O,n===Bc.Partial,!0,H),Q=LE(de,D).map(re=>re.id),he=de.map(re=>re.id);if(S.current!==he.length){S.current=he.length;const re=$l(K,he);re.length&&$?.(re)}if(N.current!==Q.length){N.current=Q.length;const re=$l(D,Q);re.length&&F?.(re)}v.setState({userSelectionRect:le})},G=V=>{if(V.button!==0)return;const{userSelectionRect:R}=v.getState();!E&&R&&V.target===b.current&&T?.(V),v.setState({nodesSelectionActive:S.current>0}),_(),l?.(V)},U=V=>{E&&(v.setState({nodesSelectionActive:S.current>0}),l?.(V)),_()},X=A&&(e||E);return Ze.createElement("div",{className:ma(["react-flow__pane",{dragging:M,selection:e}]),onClick:X?void 0:Xp(T,b),onContextMenu:Xp(k,b),onWheel:Xp(C,b),onMouseEnter:X?void 0:p,onMouseDown:X?L:void 0,onMouseMove:X?z:h,onMouseUp:X?G:void 0,onMouseLeave:X?U:y,ref:b,style:lb},g,Ze.createElement(SF,null))});JE.displayName="Pane";function e_(e,n){const s=e.parentNode||e.parentId;if(!s)return!1;const i=n.get(s);return i?i.selected?!0:e_(i,n):!1}function oN(e,n,s){let i=e;do{if(i?.matches(n))return!0;if(i===s.current)return!1;i=i.parentElement}while(i);return!1}function NF(e,n,s,i){return Array.from(e.values()).filter(l=>(l.selected||l.id===i)&&(!l.parentNode||l.parentId||!e_(l,e))&&(l.draggable||n&&typeof l.draggable>"u")).map(l=>({id:l.id,position:l.position||{x:0,y:0},positionAbsolute:l.positionAbsolute||{x:0,y:0},distance:{x:s.x-(l.positionAbsolute?.x??0),y:s.y-(l.positionAbsolute?.y??0)},delta:{x:0,y:0},extent:l.extent,parentNode:l.parentNode||l.parentId,parentId:l.parentNode||l.parentId,width:l.width,height:l.height,expandParent:l.expandParent}))}function jF(e,n){return!n||n==="parent"?n:[n[0],[n[1][0]-(e.width||0),n[1][1]-(e.height||0)]]}function t_(e,n,s,i,l=[0,0],o){const d=jF(e,e.extent||i);let f=d;const p=e.parentNode||e.parentId;if(e.extent==="parent"&&!e.expandParent)if(p&&e.width&&e.height){const g=s.get(p),{x:b,y:v}=Fi(g,l).positionAbsolute;f=g&&cs(b)&&cs(v)&&cs(g.width)&&cs(g.height)?[[b+e.width*l[0],v+e.height*l[1]],[b+g.width-e.width+e.width*l[0],v+g.height-e.height+e.height*l[1]]]:f}else o?.("005",Sr.error005()),f=d;else if(e.extent&&p&&e.extent!=="parent"){const g=s.get(p),{x:b,y:v}=Fi(g,l).positionAbsolute;f=[[e.extent[0][0]+b,e.extent[0][1]+v],[e.extent[1][0]+b,e.extent[1][1]+v]]}let h={x:0,y:0};if(p){const g=s.get(p);h=Fi(g,l).positionAbsolute}const y=f&&f!=="parent"?eb(n,f):n;return{position:{x:y.x-h.x,y:y.y-h.y},positionAbsolute:y}}function Kp({nodeId:e,dragItems:n,nodeInternals:s}){const i=n.map(l=>({...s.get(l.id),position:l.position,positionAbsolute:l.positionAbsolute}));return[e?i.find(l=>l.id===e):i[0],i]}const cN=(e,n,s,i)=>{const l=n.querySelectorAll(e);if(!l||!l.length)return null;const o=Array.from(l),d=n.getBoundingClientRect(),f={x:d.width*i[0],y:d.height*i[1]};return o.map(p=>{const h=p.getBoundingClientRect();return{id:p.getAttribute("data-handleid"),position:p.getAttribute("data-handlepos"),x:(h.left-d.left-f.x)/s,y:(h.top-d.top-f.y)/s,...Jg(p)}})};function cc(e,n,s){return s===void 0?s:i=>{const l=n().nodeInternals.get(e);l&&s(i,{...l})}}function Gy({id:e,store:n,unselect:s=!1,nodeRef:i}){const{addSelectedNodes:l,unselectNodesAndEdges:o,multiSelectionActive:d,nodeInternals:f,onError:p}=n.getState(),h=f.get(e);if(!h){p?.("012",Sr.error012(e));return}n.setState({nodesSelectionActive:!1}),h.selected?(s||h.selected&&d)&&(o({nodes:[h],edges:[]}),requestAnimationFrame(()=>i?.current?.blur())):l([e])}function EF(){const e=ra();return u.useCallback(({sourceEvent:s})=>{const{transform:i,snapGrid:l,snapToGrid:o}=e.getState(),d=s.touches?s.touches[0].clientX:s.clientX,f=s.touches?s.touches[0].clientY:s.clientY,p={x:(d-i[0])/i[2],y:(f-i[1])/i[2]};return{xSnapped:o?l[0]*Math.round(p.x/l[0]):p.x,ySnapped:o?l[1]*Math.round(p.y/l[1]):p.y,...p}},[])}function Zp(e){return(n,s,i)=>e?.(n,i)}function n_({nodeRef:e,disabled:n=!1,noDragClassName:s,handleSelector:i,nodeId:l,isSelectable:o,selectNodesOnDrag:d}){const f=ra(),[p,h]=u.useState(!1),y=u.useRef([]),g=u.useRef({x:null,y:null}),b=u.useRef(0),v=u.useRef(null),S=u.useRef({x:0,y:0}),N=u.useRef(null),j=u.useRef(!1),E=u.useRef(!1),A=u.useRef(!1),M=EF();return u.useEffect(()=>{if(e?.current){const _=ls(e.current),T=({x:L,y:z})=>{const{nodeInternals:G,onNodeDrag:U,onSelectionDrag:X,updateNodePositions:V,nodeExtent:R,snapGrid:B,snapToGrid:D,nodeOrigin:O,onError:$}=f.getState();g.current={x:L,y:z};let F=!1,H={x:0,y:0,x2:0,y2:0};if(y.current.length>1&&R){const Y=Wf(y.current,O);H=zc(Y)}if(y.current=y.current.map(Y=>{const P={x:L-Y.distance.x,y:z-Y.distance.y};D&&(P.x=B[0]*Math.round(P.x/B[0]),P.y=B[1]*Math.round(P.y/B[1]));const W=[[R[0][0],R[0][1]],[R[1][0],R[1][1]]];y.current.length>1&&R&&!Y.extent&&(W[0][0]=Y.positionAbsolute.x-H.x+R[0][0],W[1][0]=Y.positionAbsolute.x+(Y.width??0)-H.x2+R[1][0],W[0][1]=Y.positionAbsolute.y-H.y+R[0][1],W[1][1]=Y.positionAbsolute.y+(Y.height??0)-H.y2+R[1][1]);const le=t_(Y,P,G,W,O,$);return F=F||Y.position.x!==le.position.x||Y.position.y!==le.position.y,Y.position=le.position,Y.positionAbsolute=le.positionAbsolute,Y}),!F)return;V(y.current,!0,!0),h(!0);const I=l?U:Zp(X);if(I&&N.current){const[Y,P]=Kp({nodeId:l,dragItems:y.current,nodeInternals:G});I(N.current,Y,P)}},k=()=>{if(!v.current)return;const[L,z]=wE(S.current,v.current);if(L!==0||z!==0){const{transform:G,panBy:U}=f.getState();g.current.x=(g.current.x??0)-L/G[2],g.current.y=(g.current.y??0)-z/G[2],U({x:L,y:z})&&T(g.current)}b.current=requestAnimationFrame(k)},C=L=>{const{nodeInternals:z,multiSelectionActive:G,nodesDraggable:U,unselectNodesAndEdges:X,onNodeDragStart:V,onSelectionDragStart:R}=f.getState();E.current=!0;const B=l?V:Zp(R);(!d||!o)&&!G&&l&&(z.get(l)?.selected||X()),l&&o&&d&&Gy({id:l,store:f,nodeRef:e});const D=M(L);if(g.current=D,y.current=NF(z,U,D,l),B&&y.current){const[O,$]=Kp({nodeId:l,dragItems:y.current,nodeInternals:z});B(L.sourceEvent,O,$)}};if(n)_.on(".drag",null);else{const L=$6().on("start",z=>{const{domNode:G,nodeDragThreshold:U}=f.getState();U===0&&C(z),A.current=!1;const X=M(z);g.current=X,v.current=G?.getBoundingClientRect()||null,S.current=ai(z.sourceEvent,v.current)}).on("drag",z=>{const G=M(z),{autoPanOnNodeDrag:U,nodeDragThreshold:X}=f.getState();if(z.sourceEvent.type==="touchmove"&&z.sourceEvent.touches.length>1&&(A.current=!0),!A.current){if(!j.current&&E.current&&U&&(j.current=!0,k()),!E.current){const V=G.xSnapped-(g?.current?.x??0),R=G.ySnapped-(g?.current?.y??0);Math.sqrt(V*V+R*R)>X&&C(z)}(g.current.x!==G.xSnapped||g.current.y!==G.ySnapped)&&y.current&&E.current&&(N.current=z.sourceEvent,S.current=ai(z.sourceEvent,v.current),T(G))}}).on("end",z=>{if(!(!E.current||A.current)&&(h(!1),j.current=!1,E.current=!1,cancelAnimationFrame(b.current),y.current)){const{updateNodePositions:G,nodeInternals:U,onNodeDragStop:X,onSelectionDragStop:V}=f.getState(),R=l?X:Zp(V);if(G(y.current,!1,!1),R){const[B,D]=Kp({nodeId:l,dragItems:y.current,nodeInternals:U});R(z.sourceEvent,B,D)}}}).filter(z=>{const G=z.target;return!z.button&&(!s||!oN(G,`.${s}`,e))&&(!i||oN(G,i,e))});return _.call(L),()=>{_.on(".drag",null)}}}},[e,n,s,i,o,f,l,d,M]),p}function a_(){const e=ra();return u.useCallback(s=>{const{nodeInternals:i,nodeExtent:l,updateNodePositions:o,getNodes:d,snapToGrid:f,snapGrid:p,onError:h,nodesDraggable:y}=e.getState(),g=d().filter(A=>A.selected&&(A.draggable||y&&typeof A.draggable>"u")),b=f?p[0]:5,v=f?p[1]:5,S=s.isShiftPressed?4:1,N=s.x*b*S,j=s.y*v*S,E=g.map(A=>{if(A.positionAbsolute){const M={x:A.positionAbsolute.x+N,y:A.positionAbsolute.y+j};f&&(M.x=p[0]*Math.round(M.x/p[0]),M.y=p[1]*Math.round(M.y/p[1]));const{positionAbsolute:_,position:T}=t_(A,M,i,l,void 0,h);A.position=T,A.positionAbsolute=_}return A});o(E,!0,!1)},[])}const ql={ArrowUp:{x:0,y:-1},ArrowDown:{x:0,y:1},ArrowLeft:{x:-1,y:0},ArrowRight:{x:1,y:0}};var uc=e=>{const n=({id:s,type:i,data:l,xPos:o,yPos:d,xPosOrigin:f,yPosOrigin:p,selected:h,onClick:y,onMouseEnter:g,onMouseMove:b,onMouseLeave:v,onContextMenu:S,onDoubleClick:N,style:j,className:E,isDraggable:A,isSelectable:M,isConnectable:_,isFocusable:T,selectNodesOnDrag:k,sourcePosition:C,targetPosition:L,hidden:z,resizeObserver:G,dragHandle:U,zIndex:X,isParent:V,noDragClassName:R,noPanClassName:B,initialized:D,disableKeyboardA11y:O,ariaLabel:$,rfId:F,hasHandleBounds:H})=>{const I=ra(),Y=u.useRef(null),P=u.useRef(null),W=u.useRef(C),le=u.useRef(L),K=u.useRef(i),de=M||A||y||g||b||v,Q=a_(),he=cc(s,I.getState,g),re=cc(s,I.getState,b),Ce=cc(s,I.getState,v),Re=cc(s,I.getState,S),ue=cc(s,I.getState,N),se=De=>{const{nodeDragThreshold:Me}=I.getState();if(M&&(!k||!A||Me>0)&&Gy({id:s,store:I,nodeRef:Y}),y){const mt=I.getState().nodeInternals.get(s);mt&&y(De,{...mt})}},Le=De=>{if(!Py(De)&&!O)if(_E.includes(De.key)&&M){const Me=De.key==="Escape";Gy({id:s,store:I,unselect:Me,nodeRef:Y})}else A&&h&&Object.prototype.hasOwnProperty.call(ql,De.key)&&(I.setState({ariaLiveMessage:`Moved selected node ${De.key.replace("Arrow","").toLowerCase()}. New position, x: ${~~o}, y: ${~~d}`}),Q({x:ql[De.key].x,y:ql[De.key].y,isShiftPressed:De.shiftKey}))};u.useEffect(()=>()=>{P.current&&(G?.unobserve(P.current),P.current=null)},[]),u.useEffect(()=>{if(Y.current&&!z){const De=Y.current;(!D||!H||P.current!==De)&&(P.current&&G?.unobserve(P.current),G?.observe(De),P.current=De)}},[z,D,H]),u.useEffect(()=>{const De=K.current!==i,Me=W.current!==C,mt=le.current!==L;Y.current&&(De||Me||mt)&&(De&&(K.current=i),Me&&(W.current=C),mt&&(le.current=L),I.getState().updateNodeDimensions([{id:s,nodeElement:Y.current,forceUpdate:!0}]))},[s,i,C,L]);const be=n_({nodeRef:Y,disabled:z||!A,noDragClassName:R,handleSelector:U,nodeId:s,isSelectable:M,selectNodesOnDrag:k});return z?null:Ze.createElement("div",{className:ma(["react-flow__node",`react-flow__node-${i}`,{[B]:A},E,{selected:h,selectable:M,parent:V,dragging:be}]),ref:Y,style:{zIndex:X,transform:`translate(${f}px,${p}px)`,pointerEvents:de?"all":"none",visibility:D?"visible":"hidden",...j},"data-id":s,"data-testid":`rf__node-${s}`,onMouseEnter:he,onMouseMove:re,onMouseLeave:Ce,onContextMenu:Re,onClick:se,onDoubleClick:ue,onKeyDown:T?Le:void 0,tabIndex:T?0:void 0,role:T?"button":void 0,"aria-describedby":O?void 0:`${YE}-${F}`,"aria-label":$},Ze.createElement(B$,{value:s},Ze.createElement(e,{id:s,data:l,type:i,xPos:o,yPos:d,selected:h,isConnectable:_,sourcePosition:C,targetPosition:L,dragging:be,dragHandle:U,zIndex:X})))};return n.displayName="NodeWrapper",u.memo(n)};const _F=e=>{const n=e.getNodes().filter(s=>s.selected);return{...Wf(n,e.nodeOrigin),transformString:`translate(${e.transform[0]}px,${e.transform[1]}px) scale(${e.transform[2]})`,userSelectionActive:e.userSelectionActive}};function CF({onSelectionContextMenu:e,noPanClassName:n,disableKeyboardA11y:s}){const i=ra(),{width:l,height:o,x:d,y:f,transformString:p,userSelectionActive:h}=Dn(_F,la),y=a_(),g=u.useRef(null);if(u.useEffect(()=>{s||g.current?.focus({preventScroll:!0})},[s]),n_({nodeRef:g}),h||!l||!o)return null;const b=e?S=>{const N=i.getState().getNodes().filter(j=>j.selected);e(S,N)}:void 0,v=S=>{Object.prototype.hasOwnProperty.call(ql,S.key)&&y({x:ql[S.key].x,y:ql[S.key].y,isShiftPressed:S.shiftKey})};return Ze.createElement("div",{className:ma(["react-flow__nodesselection","react-flow__container",n]),style:{transform:p}},Ze.createElement("div",{ref:g,className:"react-flow__nodesselection-rect",onContextMenu:b,tabIndex:s?void 0:-1,onKeyDown:s?void 0:v,style:{width:l,height:o,top:f,left:d}}))}var AF=u.memo(CF);const TF=e=>e.nodesSelectionActive,s_=({children:e,onPaneClick:n,onPaneMouseEnter:s,onPaneMouseMove:i,onPaneMouseLeave:l,onPaneContextMenu:o,onPaneScroll:d,deleteKeyCode:f,onMove:p,onMoveStart:h,onMoveEnd:y,selectionKeyCode:g,selectionOnDrag:b,selectionMode:v,onSelectionStart:S,onSelectionEnd:N,multiSelectionKeyCode:j,panActivationKeyCode:E,zoomActivationKeyCode:A,elementsSelectable:M,zoomOnScroll:_,zoomOnPinch:T,panOnScroll:k,panOnScrollSpeed:C,panOnScrollMode:L,zoomOnDoubleClick:z,panOnDrag:G,defaultViewport:U,translateExtent:X,minZoom:V,maxZoom:R,preventScrolling:B,onSelectionContextMenu:D,noWheelClassName:O,noPanClassName:$,disableKeyboardA11y:F})=>{const H=Dn(TF),I=Uc(g),Y=Uc(E),P=Y||G,W=Y||k,le=I||b&&P!==!0;return pF({deleteKeyCode:f,multiSelectionKeyCode:j}),Ze.createElement(xF,{onMove:p,onMoveStart:h,onMoveEnd:y,onPaneContextMenu:o,elementsSelectable:M,zoomOnScroll:_,zoomOnPinch:T,panOnScroll:W,panOnScrollSpeed:C,panOnScrollMode:L,zoomOnDoubleClick:z,panOnDrag:!I&&P,defaultViewport:U,translateExtent:X,minZoom:V,maxZoom:R,zoomActivationKeyCode:A,preventScrolling:B,noWheelClassName:O,noPanClassName:$},Ze.createElement(JE,{onSelectionStart:S,onSelectionEnd:N,onPaneClick:n,onPaneMouseEnter:s,onPaneMouseMove:i,onPaneMouseLeave:l,onPaneContextMenu:o,onPaneScroll:d,panOnDrag:P,isSelecting:!!le,selectionMode:v},e,H&&Ze.createElement(AF,{onSelectionContextMenu:D,noPanClassName:$,disableKeyboardA11y:F})))};s_.displayName="FlowRenderer";var MF=u.memo(s_);function kF(e){return Dn(u.useCallback(s=>e?IE(s.nodeInternals,{x:0,y:0,width:s.width,height:s.height},s.transform,!0):s.getNodes(),[e]))}function RF(e){const n={input:uc(e.input||qE),default:uc(e.default||Yy),output:uc(e.output||HE),group:uc(e.group||ib)},s={},i=Object.keys(e).filter(l=>!["input","default","output","group"].includes(l)).reduce((l,o)=>(l[o]=uc(e[o]||Yy),l),s);return{...n,...i}}const IF=({x:e,y:n,width:s,height:i,origin:l})=>!s||!i?{x:e,y:n}:l[0]<0||l[1]<0||l[0]>1||l[1]>1?{x:e,y:n}:{x:e-s*l[0],y:n-i*l[1]},LF=e=>({nodesDraggable:e.nodesDraggable,nodesConnectable:e.nodesConnectable,nodesFocusable:e.nodesFocusable,elementsSelectable:e.elementsSelectable,updateNodeDimensions:e.updateNodeDimensions,onError:e.onError}),r_=e=>{const{nodesDraggable:n,nodesConnectable:s,nodesFocusable:i,elementsSelectable:l,updateNodeDimensions:o,onError:d}=Dn(LF,la),f=kF(e.onlyRenderVisibleElements),p=u.useRef(),h=u.useMemo(()=>{if(typeof ResizeObserver>"u")return null;const y=new ResizeObserver(g=>{const b=g.map(v=>({id:v.target.getAttribute("data-id"),nodeElement:v.target,forceUpdate:!0}));o(b)});return p.current=y,y},[]);return u.useEffect(()=>()=>{p?.current?.disconnect()},[]),Ze.createElement("div",{className:"react-flow__nodes",style:lb},f.map(y=>{let g=y.type||"default";e.nodeTypes[g]||(d?.("003",Sr.error003(g)),g="default");const b=e.nodeTypes[g]||e.nodeTypes.default,v=!!(y.draggable||n&&typeof y.draggable>"u"),S=!!(y.selectable||l&&typeof y.selectable>"u"),N=!!(y.connectable||s&&typeof y.connectable>"u"),j=!!(y.focusable||i&&typeof y.focusable>"u"),E=e.nodeExtent?eb(y.positionAbsolute,e.nodeExtent):y.positionAbsolute,A=E?.x??0,M=E?.y??0,_=IF({x:A,y:M,width:y.width??0,height:y.height??0,origin:e.nodeOrigin});return Ze.createElement(b,{key:y.id,id:y.id,className:y.className,style:y.style,type:g,data:y.data,sourcePosition:y.sourcePosition||Gt.Bottom,targetPosition:y.targetPosition||Gt.Top,hidden:y.hidden,xPos:A,yPos:M,xPosOrigin:_.x,yPosOrigin:_.y,selectNodesOnDrag:e.selectNodesOnDrag,onClick:e.onNodeClick,onMouseEnter:e.onNodeMouseEnter,onMouseMove:e.onNodeMouseMove,onMouseLeave:e.onNodeMouseLeave,onContextMenu:e.onNodeContextMenu,onDoubleClick:e.onNodeDoubleClick,selected:!!y.selected,isDraggable:v,isSelectable:S,isConnectable:N,isFocusable:j,resizeObserver:h,dragHandle:y.dragHandle,zIndex:y[Yn]?.z??0,isParent:!!y[Yn]?.isParent,noDragClassName:e.noDragClassName,noPanClassName:e.noPanClassName,initialized:!!y.width&&!!y.height,rfId:e.rfId,disableKeyboardA11y:e.disableKeyboardA11y,ariaLabel:y.ariaLabel,hasHandleBounds:!!y[Yn]?.handleBounds})}))};r_.displayName="NodeRenderer";var DF=u.memo(r_);const OF=(e,n,s)=>s===Gt.Left?e-n:s===Gt.Right?e+n:e,$F=(e,n,s)=>s===Gt.Top?e-n:s===Gt.Bottom?e+n:e,uN="react-flow__edgeupdater",dN=({position:e,centerX:n,centerY:s,radius:i=10,onMouseDown:l,onMouseEnter:o,onMouseOut:d,type:f})=>Ze.createElement("circle",{onMouseDown:l,onMouseEnter:o,onMouseOut:d,className:ma([uN,`${uN}-${f}`]),cx:OF(n,i,e),cy:$F(s,i,e),r:i,stroke:"transparent",fill:"transparent"}),FF=()=>!0;var Ll=e=>{const n=({id:s,className:i,type:l,data:o,onClick:d,onEdgeDoubleClick:f,selected:p,animated:h,label:y,labelStyle:g,labelShowBg:b,labelBgStyle:v,labelBgPadding:S,labelBgBorderRadius:N,style:j,source:E,target:A,sourceX:M,sourceY:_,targetX:T,targetY:k,sourcePosition:C,targetPosition:L,elementsSelectable:z,hidden:G,sourceHandleId:U,targetHandleId:X,onContextMenu:V,onMouseEnter:R,onMouseMove:B,onMouseLeave:D,reconnectRadius:O,onReconnect:$,onReconnectStart:F,onReconnectEnd:H,markerEnd:I,markerStart:Y,rfId:P,ariaLabel:W,isFocusable:le,isReconnectable:K,pathOptions:de,interactionWidth:Q,disableKeyboardA11y:he})=>{const re=u.useRef(null),[Ce,Re]=u.useState(!1),[ue,se]=u.useState(!1),Le=ra(),be=u.useMemo(()=>`url('#${Hy(Y,P)}')`,[Y,P]),De=u.useMemo(()=>`url('#${Hy(I,P)}')`,[I,P]);if(G)return null;const Me=ce=>{const{edges:fe,addSelectedEdges:qe,unselectNodesAndEdges:Pe,multiSelectionActive:Be}=Le.getState(),Te=fe.find(gt=>gt.id===s);Te&&(z&&(Le.setState({nodesSelectionActive:!1}),Te.selected&&Be?(Pe({nodes:[],edges:[Te]}),re.current?.blur()):qe([s])),d&&d(ce,Te))},mt=oc(s,Le.getState,f),ht=oc(s,Le.getState,V),Ct=oc(s,Le.getState,R),At=oc(s,Le.getState,B),we=oc(s,Le.getState,D),st=(ce,fe)=>{if(ce.button!==0)return;const{edges:qe,isValidConnection:Pe}=Le.getState(),Be=fe?A:E,Te=(fe?X:U)||null,gt=fe?"target":"source",jt=Pe||FF,Mt=fe,tt=qe.find(Ft=>Ft.id===s);se(!0),F?.(ce,tt,gt);const ft=Ft=>{se(!1),H?.(Ft,tt,gt)};FE({event:ce,handleId:Te,nodeId:Be,onConnect:Ft=>$?.(tt,Ft),isTarget:Mt,getState:Le.getState,setState:Le.setState,isValidConnection:jt,edgeUpdaterType:gt,onReconnectEnd:ft})},lt=ce=>st(ce,!0),Fe=ce=>st(ce,!1),Xe=()=>Re(!0),dt=()=>Re(!1),ie=!z&&!d,ee=ce=>{if(!he&&_E.includes(ce.key)&&z){const{unselectNodesAndEdges:fe,addSelectedEdges:qe,edges:Pe}=Le.getState();ce.key==="Escape"?(re.current?.blur(),fe({edges:[Pe.find(Te=>Te.id===s)]})):qe([s])}};return Ze.createElement("g",{className:ma(["react-flow__edge",`react-flow__edge-${l}`,i,{selected:p,animated:h,inactive:ie,updating:Ce}]),onClick:Me,onDoubleClick:mt,onContextMenu:ht,onMouseEnter:Ct,onMouseMove:At,onMouseLeave:we,onKeyDown:le?ee:void 0,tabIndex:le?0:void 0,role:le?"button":"img","data-testid":`rf__edge-${s}`,"aria-label":W===null?void 0:W||`Edge from ${E} to ${A}`,"aria-describedby":le?`${GE}-${P}`:void 0,ref:re},!ue&&Ze.createElement(e,{id:s,source:E,target:A,selected:p,animated:h,label:y,labelStyle:g,labelShowBg:b,labelBgStyle:v,labelBgPadding:S,labelBgBorderRadius:N,data:o,style:j,sourceX:M,sourceY:_,targetX:T,targetY:k,sourcePosition:C,targetPosition:L,sourceHandleId:U,targetHandleId:X,markerStart:be,markerEnd:De,pathOptions:de,interactionWidth:Q}),K&&Ze.createElement(Ze.Fragment,null,(K==="source"||K===!0)&&Ze.createElement(dN,{position:C,centerX:M,centerY:_,radius:O,onMouseDown:lt,onMouseEnter:Xe,onMouseOut:dt,type:"source"}),(K==="target"||K===!0)&&Ze.createElement(dN,{position:L,centerX:T,centerY:k,radius:O,onMouseDown:Fe,onMouseEnter:Xe,onMouseOut:dt,type:"target"})))};return n.displayName="EdgeWrapper",u.memo(n)};function zF(e){const n={default:Ll(e.default||pf),straight:Ll(e.bezier||ab),step:Ll(e.step||nb),smoothstep:Ll(e.step||Gf),simplebezier:Ll(e.simplebezier||tb)},s={},i=Object.keys(e).filter(l=>!["default","bezier"].includes(l)).reduce((l,o)=>(l[o]=Ll(e[o]||pf),l),s);return{...n,...i}}function fN(e,n,s=null){const i=(s?.x||0)+n.x,l=(s?.y||0)+n.y,o=s?.width||n.width,d=s?.height||n.height;switch(e){case Gt.Top:return{x:i+o/2,y:l};case Gt.Right:return{x:i+o,y:l+d/2};case Gt.Bottom:return{x:i+o/2,y:l+d};case Gt.Left:return{x:i,y:l+d/2}}}function mN(e,n){return e?e.length===1||!n?e[0]:n&&e.find(s=>s.id===n)||null:null}const BF=(e,n,s,i,l,o)=>{const d=fN(s,e,n),f=fN(o,i,l);return{sourceX:d.x,sourceY:d.y,targetX:f.x,targetY:f.y}};function UF({sourcePos:e,targetPos:n,sourceWidth:s,sourceHeight:i,targetWidth:l,targetHeight:o,width:d,height:f,transform:p}){const h={x:Math.min(e.x,n.x),y:Math.min(e.y,n.y),x2:Math.max(e.x+s,n.x+l),y2:Math.max(e.y+i,n.y+o)};h.x===h.x2&&(h.x2+=1),h.y===h.y2&&(h.y2+=1);const y=zc({x:(0-p[0])/p[2],y:(0-p[1])/p[2],width:d/p[2],height:f/p[2]}),g=Math.max(0,Math.min(y.x2,h.x2)-Math.max(y.x,h.x)),b=Math.max(0,Math.min(y.y2,h.y2)-Math.max(y.y,h.y));return Math.ceil(g*b)>0}function hN(e){const n=e?.[Yn]?.handleBounds||null,s=n&&e?.width&&e?.height&&typeof e?.positionAbsolute?.x<"u"&&typeof e?.positionAbsolute?.y<"u";return[{x:e?.positionAbsolute?.x||0,y:e?.positionAbsolute?.y||0,width:e?.width||0,height:e?.height||0},n,!!s]}const qF=[{level:0,isMaxLevel:!0,edges:[]}];function PF(e,n,s=!1){let i=-1;const l=e.reduce((d,f)=>{const p=cs(f.zIndex);let h=p?f.zIndex:0;if(s){const y=n.get(f.target),g=n.get(f.source),b=f.selected||y?.selected||g?.selected,v=Math.max(g?.[Yn]?.z||0,y?.[Yn]?.z||0,1e3);h=(p?f.zIndex:0)+(b?v:0)}return d[h]?d[h].push(f):d[h]=[f],i=h>i?h:i,d},{}),o=Object.entries(l).map(([d,f])=>{const p=+d;return{edges:f,level:p,isMaxLevel:p===i}});return o.length===0?qF:o}function HF(e,n,s){const i=Dn(u.useCallback(l=>e?l.edges.filter(o=>{const d=n.get(o.source),f=n.get(o.target);return d?.width&&d?.height&&f?.width&&f?.height&&UF({sourcePos:d.positionAbsolute||{x:0,y:0},targetPos:f.positionAbsolute||{x:0,y:0},sourceWidth:d.width,sourceHeight:d.height,targetWidth:f.width,targetHeight:f.height,width:l.width,height:l.height,transform:l.transform})}):l.edges,[e,n]));return PF(i,n,s)}const VF=({color:e="none",strokeWidth:n=1})=>Ze.createElement("polyline",{style:{stroke:e,strokeWidth:n},strokeLinecap:"round",strokeLinejoin:"round",fill:"none",points:"-5,-4 0,0 -5,4"}),YF=({color:e="none",strokeWidth:n=1})=>Ze.createElement("polyline",{style:{stroke:e,fill:e,strokeWidth:n},strokeLinecap:"round",strokeLinejoin:"round",points:"-5,-4 0,0 -5,4 -5,-4"}),pN={[mf.Arrow]:VF,[mf.ArrowClosed]:YF};function GF(e){const n=ra();return u.useMemo(()=>Object.prototype.hasOwnProperty.call(pN,e)?pN[e]:(n.getState().onError?.("009",Sr.error009(e)),null),[e])}const WF=({id:e,type:n,color:s,width:i=12.5,height:l=12.5,markerUnits:o="strokeWidth",strokeWidth:d,orient:f="auto-start-reverse"})=>{const p=GF(n);return p?Ze.createElement("marker",{className:"react-flow__arrowhead",id:e,markerWidth:`${i}`,markerHeight:`${l}`,viewBox:"-10 -10 20 20",markerUnits:o,orient:f,refX:"0",refY:"0"},Ze.createElement(p,{color:s,strokeWidth:d})):null},XF=({defaultColor:e,rfId:n})=>s=>{const i=[];return s.edges.reduce((l,o)=>([o.markerStart,o.markerEnd].forEach(d=>{if(d&&typeof d=="object"){const f=Hy(d,n);i.includes(f)||(l.push({id:f,color:d.color||e,...d}),i.push(f))}}),l),[]).sort((l,o)=>l.id.localeCompare(o.id))},i_=({defaultColor:e,rfId:n})=>{const s=Dn(u.useCallback(XF({defaultColor:e,rfId:n}),[e,n]),(i,l)=>!(i.length!==l.length||i.some((o,d)=>o.id!==l[d].id)));return Ze.createElement("defs",null,s.map(i=>Ze.createElement(WF,{id:i.id,key:i.id,type:i.type,color:i.color,width:i.width,height:i.height,markerUnits:i.markerUnits,strokeWidth:i.strokeWidth,orient:i.orient})))};i_.displayName="MarkerDefinitions";var KF=u.memo(i_);const ZF=e=>({nodesConnectable:e.nodesConnectable,edgesFocusable:e.edgesFocusable,edgesUpdatable:e.edgesUpdatable,elementsSelectable:e.elementsSelectable,width:e.width,height:e.height,connectionMode:e.connectionMode,nodeInternals:e.nodeInternals,onError:e.onError}),l_=({defaultMarkerColor:e,onlyRenderVisibleElements:n,elevateEdgesOnSelect:s,rfId:i,edgeTypes:l,noPanClassName:o,onEdgeContextMenu:d,onEdgeMouseEnter:f,onEdgeMouseMove:p,onEdgeMouseLeave:h,onEdgeClick:y,onEdgeDoubleClick:g,onReconnect:b,onReconnectStart:v,onReconnectEnd:S,reconnectRadius:N,children:j,disableKeyboardA11y:E})=>{const{edgesFocusable:A,edgesUpdatable:M,elementsSelectable:_,width:T,height:k,connectionMode:C,nodeInternals:L,onError:z}=Dn(ZF,la),G=HF(n,L,s);return T?Ze.createElement(Ze.Fragment,null,G.map(({level:U,edges:X,isMaxLevel:V})=>Ze.createElement("svg",{key:U,style:{zIndex:U},width:T,height:k,className:"react-flow__edges react-flow__container"},V&&Ze.createElement(KF,{defaultColor:e,rfId:i}),Ze.createElement("g",null,X.map(R=>{const[B,D,O]=hN(L.get(R.source)),[$,F,H]=hN(L.get(R.target));if(!O||!H)return null;let I=R.type||"default";l[I]||(z?.("011",Sr.error011(I)),I="default");const Y=l[I]||l.default,P=C===qi.Strict?F.target:(F.target??[]).concat(F.source??[]),W=mN(D.source,R.sourceHandle),le=mN(P,R.targetHandle),K=W?.position||Gt.Bottom,de=le?.position||Gt.Top,Q=!!(R.focusable||A&&typeof R.focusable>"u"),he=R.reconnectable||R.updatable,re=typeof b<"u"&&(he||M&&typeof he>"u");if(!W||!le)return z?.("008",Sr.error008(W,R)),null;const{sourceX:Ce,sourceY:Re,targetX:ue,targetY:se}=BF(B,W,K,$,le,de);return Ze.createElement(Y,{key:R.id,id:R.id,className:ma([R.className,o]),type:I,data:R.data,selected:!!R.selected,animated:!!R.animated,hidden:!!R.hidden,label:R.label,labelStyle:R.labelStyle,labelShowBg:R.labelShowBg,labelBgStyle:R.labelBgStyle,labelBgPadding:R.labelBgPadding,labelBgBorderRadius:R.labelBgBorderRadius,style:R.style,source:R.source,target:R.target,sourceHandleId:R.sourceHandle,targetHandleId:R.targetHandle,markerEnd:R.markerEnd,markerStart:R.markerStart,sourceX:Ce,sourceY:Re,targetX:ue,targetY:se,sourcePosition:K,targetPosition:de,elementsSelectable:_,onContextMenu:d,onMouseEnter:f,onMouseMove:p,onMouseLeave:h,onClick:y,onEdgeDoubleClick:g,onReconnect:b,onReconnectStart:v,onReconnectEnd:S,reconnectRadius:N,rfId:i,ariaLabel:R.ariaLabel,isFocusable:Q,isReconnectable:re,pathOptions:"pathOptions"in R?R.pathOptions:void 0,interactionWidth:R.interactionWidth,disableKeyboardA11y:E})})))),j):null};l_.displayName="EdgeRenderer";var QF=u.memo(l_);const JF=e=>`translate(${e.transform[0]}px,${e.transform[1]}px) scale(${e.transform[2]})`;function e8({children:e}){const n=Dn(JF);return Ze.createElement("div",{className:"react-flow__viewport react-flow__container",style:{transform:n}},e)}function t8(e){const n=Xf(),s=u.useRef(!1);u.useEffect(()=>{!s.current&&n.viewportInitialized&&e&&(setTimeout(()=>e(n),1),s.current=!0)},[e,n.viewportInitialized])}const n8={[Gt.Left]:Gt.Right,[Gt.Right]:Gt.Left,[Gt.Top]:Gt.Bottom,[Gt.Bottom]:Gt.Top},o_=({nodeId:e,handleType:n,style:s,type:i=ti.Bezier,CustomComponent:l,connectionStatus:o})=>{const{fromNode:d,handleId:f,toX:p,toY:h,connectionMode:y}=Dn(u.useCallback(k=>({fromNode:k.nodeInternals.get(e),handleId:k.connectionHandleId,toX:(k.connectionPosition.x-k.transform[0])/k.transform[2],toY:(k.connectionPosition.y-k.transform[1])/k.transform[2],connectionMode:k.connectionMode}),[e]),la),g=d?.[Yn]?.handleBounds;let b=g?.[n];if(y===qi.Loose&&(b=b||g?.[n==="source"?"target":"source"]),!d||!b)return null;const v=f?b.find(k=>k.id===f):b[0],S=v?v.x+v.width/2:(d.width??0)/2,N=v?v.y+v.height/2:d.height??0,j=(d.positionAbsolute?.x??0)+S,E=(d.positionAbsolute?.y??0)+N,A=v?.position,M=A?n8[A]:null;if(!A||!M)return null;if(l)return Ze.createElement(l,{connectionLineType:i,connectionLineStyle:s,fromNode:d,fromHandle:v,fromX:j,fromY:E,toX:p,toY:h,fromPosition:A,toPosition:M,connectionStatus:o});let _="";const T={sourceX:j,sourceY:E,sourcePosition:A,targetX:p,targetY:h,targetPosition:M};return i===ti.Bezier?[_]=kE(T):i===ti.Step?[_]=hf({...T,borderRadius:0}):i===ti.SmoothStep?[_]=hf(T):i===ti.SimpleBezier?[_]=ME(T):_=`M${j},${E} ${p},${h}`,Ze.createElement("path",{d:_,fill:"none",className:"react-flow__connection-path",style:s})};o_.displayName="ConnectionLine";const a8=e=>({nodeId:e.connectionNodeId,handleType:e.connectionHandleType,nodesConnectable:e.nodesConnectable,connectionStatus:e.connectionStatus,width:e.width,height:e.height});function s8({containerStyle:e,style:n,type:s,component:i}){const{nodeId:l,handleType:o,nodesConnectable:d,width:f,height:p,connectionStatus:h}=Dn(a8,la);return!(l&&o&&f&&d)?null:Ze.createElement("svg",{style:e,width:f,height:p,className:"react-flow__edges react-flow__connectionline react-flow__container"},Ze.createElement("g",{className:ma(["react-flow__connection",h])},Ze.createElement(o_,{nodeId:l,handleType:o,style:n,type:s,CustomComponent:i,connectionStatus:h})))}function yN(e,n){return u.useRef(null),ra(),u.useMemo(()=>n(e),[e])}const c_=({nodeTypes:e,edgeTypes:n,onMove:s,onMoveStart:i,onMoveEnd:l,onInit:o,onNodeClick:d,onEdgeClick:f,onNodeDoubleClick:p,onEdgeDoubleClick:h,onNodeMouseEnter:y,onNodeMouseMove:g,onNodeMouseLeave:b,onNodeContextMenu:v,onSelectionContextMenu:S,onSelectionStart:N,onSelectionEnd:j,connectionLineType:E,connectionLineStyle:A,connectionLineComponent:M,connectionLineContainerStyle:_,selectionKeyCode:T,selectionOnDrag:k,selectionMode:C,multiSelectionKeyCode:L,panActivationKeyCode:z,zoomActivationKeyCode:G,deleteKeyCode:U,onlyRenderVisibleElements:X,elementsSelectable:V,selectNodesOnDrag:R,defaultViewport:B,translateExtent:D,minZoom:O,maxZoom:$,preventScrolling:F,defaultMarkerColor:H,zoomOnScroll:I,zoomOnPinch:Y,panOnScroll:P,panOnScrollSpeed:W,panOnScrollMode:le,zoomOnDoubleClick:K,panOnDrag:de,onPaneClick:Q,onPaneMouseEnter:he,onPaneMouseMove:re,onPaneMouseLeave:Ce,onPaneScroll:Re,onPaneContextMenu:ue,onEdgeContextMenu:se,onEdgeMouseEnter:Le,onEdgeMouseMove:be,onEdgeMouseLeave:De,onReconnect:Me,onReconnectStart:mt,onReconnectEnd:ht,reconnectRadius:Ct,noDragClassName:At,noWheelClassName:we,noPanClassName:st,elevateEdgesOnSelect:lt,disableKeyboardA11y:Fe,nodeOrigin:Xe,nodeExtent:dt,rfId:ie})=>{const ee=yN(e,RF),ce=yN(n,zF);return t8(o),Ze.createElement(MF,{onPaneClick:Q,onPaneMouseEnter:he,onPaneMouseMove:re,onPaneMouseLeave:Ce,onPaneContextMenu:ue,onPaneScroll:Re,deleteKeyCode:U,selectionKeyCode:T,selectionOnDrag:k,selectionMode:C,onSelectionStart:N,onSelectionEnd:j,multiSelectionKeyCode:L,panActivationKeyCode:z,zoomActivationKeyCode:G,elementsSelectable:V,onMove:s,onMoveStart:i,onMoveEnd:l,zoomOnScroll:I,zoomOnPinch:Y,zoomOnDoubleClick:K,panOnScroll:P,panOnScrollSpeed:W,panOnScrollMode:le,panOnDrag:de,defaultViewport:B,translateExtent:D,minZoom:O,maxZoom:$,onSelectionContextMenu:S,preventScrolling:F,noDragClassName:At,noWheelClassName:we,noPanClassName:st,disableKeyboardA11y:Fe},Ze.createElement(e8,null,Ze.createElement(QF,{edgeTypes:ce,onEdgeClick:f,onEdgeDoubleClick:h,onlyRenderVisibleElements:X,onEdgeContextMenu:se,onEdgeMouseEnter:Le,onEdgeMouseMove:be,onEdgeMouseLeave:De,onReconnect:Me,onReconnectStart:mt,onReconnectEnd:ht,reconnectRadius:Ct,defaultMarkerColor:H,noPanClassName:st,elevateEdgesOnSelect:!!lt,disableKeyboardA11y:Fe,rfId:ie},Ze.createElement(s8,{style:A,type:E,component:M,containerStyle:_})),Ze.createElement("div",{className:"react-flow__edgelabel-renderer"}),Ze.createElement(DF,{nodeTypes:ee,onNodeClick:d,onNodeDoubleClick:p,onNodeMouseEnter:y,onNodeMouseMove:g,onNodeMouseLeave:b,onNodeContextMenu:v,selectNodesOnDrag:R,onlyRenderVisibleElements:X,noPanClassName:st,noDragClassName:At,disableKeyboardA11y:Fe,nodeOrigin:Xe,nodeExtent:dt,rfId:ie})))};c_.displayName="GraphView";var r8=u.memo(c_);const Wy=[[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY]],Wr={rfId:"1",width:0,height:0,transform:[0,0,1],nodeInternals:new Map,edges:[],onNodesChange:null,onEdgesChange:null,hasDefaultNodes:!1,hasDefaultEdges:!1,d3Zoom:null,d3Selection:null,d3ZoomHandler:void 0,minZoom:.5,maxZoom:2,translateExtent:Wy,nodeExtent:Wy,nodesSelectionActive:!1,userSelectionActive:!1,userSelectionRect:null,connectionNodeId:null,connectionHandleId:null,connectionHandleType:"source",connectionPosition:{x:0,y:0},connectionStatus:null,connectionMode:qi.Strict,domNode:null,paneDragging:!1,noPanClassName:"nopan",nodeOrigin:[0,0],nodeDragThreshold:0,snapGrid:[15,15],snapToGrid:!1,nodesDraggable:!0,nodesConnectable:!0,nodesFocusable:!0,edgesFocusable:!0,edgesUpdatable:!0,elementsSelectable:!0,elevateNodesOnSelect:!0,fitViewOnInit:!1,fitViewOnInitDone:!1,fitViewOnInitOptions:void 0,onSelectionChange:[],multiSelectionActive:!1,connectionStartHandle:null,connectionEndHandle:null,connectionClickStartHandle:null,connectOnClick:!0,ariaLiveMessage:"",autoPanOnConnect:!0,autoPanOnNodeDrag:!0,connectionRadius:20,onError:L$,isValidConnection:void 0},i8=()=>X5((e,n)=>({...Wr,setNodes:s=>{const{nodeInternals:i,nodeOrigin:l,elevateNodesOnSelect:o}=n();e({nodeInternals:Wp(s,i,l,o)})},getNodes:()=>Array.from(n().nodeInternals.values()),setEdges:s=>{const{defaultEdgeOptions:i={}}=n();e({edges:s.map(l=>({...i,...l}))})},setDefaultNodesAndEdges:(s,i)=>{const l=typeof s<"u",o=typeof i<"u",d=l?Wp(s,new Map,n().nodeOrigin,n().elevateNodesOnSelect):new Map;e({nodeInternals:d,edges:o?i:[],hasDefaultNodes:l,hasDefaultEdges:o})},updateNodeDimensions:s=>{const{onNodesChange:i,nodeInternals:l,fitViewOnInit:o,fitViewOnInitDone:d,fitViewOnInitOptions:f,domNode:p,nodeOrigin:h}=n(),y=p?.querySelector(".react-flow__viewport");if(!y)return;const g=window.getComputedStyle(y),{m22:b}=new window.DOMMatrixReadOnly(g.transform),v=s.reduce((N,j)=>{const E=l.get(j.id);if(E?.hidden)l.set(E.id,{...E,[Yn]:{...E[Yn],handleBounds:void 0}});else if(E){const A=Jg(j.nodeElement);!!(A.width&&A.height&&(E.width!==A.width||E.height!==A.height||j.forceUpdate))&&(l.set(E.id,{...E,[Yn]:{...E[Yn],handleBounds:{source:cN(".source",j.nodeElement,b,h),target:cN(".target",j.nodeElement,b,h)}},...A}),N.push({id:E.id,type:"dimensions",dimensions:A}))}return N},[]);XE(l,h);const S=d||o&&!d&&KE(n,{initial:!0,...f});e({nodeInternals:new Map(l),fitViewOnInitDone:S}),v?.length>0&&i?.(v)},updateNodePositions:(s,i=!0,l=!1)=>{const{triggerNodeChanges:o}=n(),d=s.map(f=>{const p={id:f.id,type:"position",dragging:l};return i&&(p.positionAbsolute=f.positionAbsolute,p.position=f.position),p});o(d)},triggerNodeChanges:s=>{const{onNodesChange:i,nodeInternals:l,hasDefaultNodes:o,nodeOrigin:d,getNodes:f,elevateNodesOnSelect:p}=n();if(s?.length){if(o){const h=ob(s,f()),y=Wp(h,l,d,p);e({nodeInternals:y})}i?.(s)}},addSelectedNodes:s=>{const{multiSelectionActive:i,edges:l,getNodes:o}=n();let d,f=null;i?d=s.map(p=>Qr(p,!0)):(d=$l(o(),s),f=$l(l,[])),Cd({changedNodes:d,changedEdges:f,get:n,set:e})},addSelectedEdges:s=>{const{multiSelectionActive:i,edges:l,getNodes:o}=n();let d,f=null;i?d=s.map(p=>Qr(p,!0)):(d=$l(l,s),f=$l(o(),[])),Cd({changedNodes:f,changedEdges:d,get:n,set:e})},unselectNodesAndEdges:({nodes:s,edges:i}={})=>{const{edges:l,getNodes:o}=n(),d=s||o(),f=i||l,p=d.map(y=>(y.selected=!1,Qr(y.id,!1))),h=f.map(y=>Qr(y.id,!1));Cd({changedNodes:p,changedEdges:h,get:n,set:e})},setMinZoom:s=>{const{d3Zoom:i,maxZoom:l}=n();i?.scaleExtent([s,l]),e({minZoom:s})},setMaxZoom:s=>{const{d3Zoom:i,minZoom:l}=n();i?.scaleExtent([l,s]),e({maxZoom:s})},setTranslateExtent:s=>{n().d3Zoom?.translateExtent(s),e({translateExtent:s})},resetSelectedElements:()=>{const{edges:s,getNodes:i}=n(),o=i().filter(f=>f.selected).map(f=>Qr(f.id,!1)),d=s.filter(f=>f.selected).map(f=>Qr(f.id,!1));Cd({changedNodes:o,changedEdges:d,get:n,set:e})},setNodeExtent:s=>{const{nodeInternals:i}=n();i.forEach(l=>{l.positionAbsolute=eb(l.position,s)}),e({nodeExtent:s,nodeInternals:new Map(i)})},panBy:s=>{const{transform:i,width:l,height:o,d3Zoom:d,d3Selection:f,translateExtent:p}=n();if(!d||!f||!s.x&&!s.y)return!1;const h=br.translate(i[0]+s.x,i[1]+s.y).scale(i[2]),y=[[0,0],[l,o]],g=d?.constrain()(h,y,p);return d.transform(f,g),i[0]!==g.x||i[1]!==g.y||i[2]!==g.k},cancelConnection:()=>e({connectionNodeId:Wr.connectionNodeId,connectionHandleId:Wr.connectionHandleId,connectionHandleType:Wr.connectionHandleType,connectionStatus:Wr.connectionStatus,connectionStartHandle:Wr.connectionStartHandle,connectionEndHandle:Wr.connectionEndHandle}),reset:()=>e({...Wr})}),Object.is),u_=({children:e})=>{const n=u.useRef(null);return n.current||(n.current=i8()),Ze.createElement(C$,{value:n.current},e)};u_.displayName="ReactFlowProvider";const d_=({children:e})=>u.useContext(Yf)?Ze.createElement(Ze.Fragment,null,e):Ze.createElement(u_,null,e);d_.displayName="ReactFlowWrapper";const l8={input:qE,default:Yy,output:HE,group:ib},o8={default:pf,straight:ab,step:nb,smoothstep:Gf,simplebezier:tb},c8=[0,0],u8=[15,15],d8={x:0,y:0,zoom:1},f8={width:"100%",height:"100%",overflow:"hidden",position:"relative",zIndex:0},cb=u.forwardRef(({nodes:e,edges:n,defaultNodes:s,defaultEdges:i,className:l,nodeTypes:o=l8,edgeTypes:d=o8,onNodeClick:f,onEdgeClick:p,onInit:h,onMove:y,onMoveStart:g,onMoveEnd:b,onConnect:v,onConnectStart:S,onConnectEnd:N,onClickConnectStart:j,onClickConnectEnd:E,onNodeMouseEnter:A,onNodeMouseMove:M,onNodeMouseLeave:_,onNodeContextMenu:T,onNodeDoubleClick:k,onNodeDragStart:C,onNodeDrag:L,onNodeDragStop:z,onNodesDelete:G,onEdgesDelete:U,onSelectionChange:X,onSelectionDragStart:V,onSelectionDrag:R,onSelectionDragStop:B,onSelectionContextMenu:D,onSelectionStart:O,onSelectionEnd:$,connectionMode:F=qi.Strict,connectionLineType:H=ti.Bezier,connectionLineStyle:I,connectionLineComponent:Y,connectionLineContainerStyle:P,deleteKeyCode:W="Backspace",selectionKeyCode:le="Shift",selectionOnDrag:K=!1,selectionMode:de=Bc.Full,panActivationKeyCode:Q="Space",multiSelectionKeyCode:he=ff()?"Meta":"Control",zoomActivationKeyCode:re=ff()?"Meta":"Control",snapToGrid:Ce=!1,snapGrid:Re=u8,onlyRenderVisibleElements:ue=!1,selectNodesOnDrag:se=!0,nodesDraggable:Le,nodesConnectable:be,nodesFocusable:De,nodeOrigin:Me=c8,edgesFocusable:mt,edgesUpdatable:ht,elementsSelectable:Ct,defaultViewport:At=d8,minZoom:we=.5,maxZoom:st=2,translateExtent:lt=Wy,preventScrolling:Fe=!0,nodeExtent:Xe,defaultMarkerColor:dt="#b1b1b7",zoomOnScroll:ie=!0,zoomOnPinch:ee=!0,panOnScroll:ce=!1,panOnScrollSpeed:fe=.5,panOnScrollMode:qe=Oi.Free,zoomOnDoubleClick:Pe=!0,panOnDrag:Be=!0,onPaneClick:Te,onPaneMouseEnter:gt,onPaneMouseMove:jt,onPaneMouseLeave:Mt,onPaneScroll:tt,onPaneContextMenu:ft,children:Rt,onEdgeContextMenu:Ft,onEdgeDoubleClick:Zt,onEdgeMouseEnter:Tt,onEdgeMouseMove:We,onEdgeMouseLeave:it,onEdgeUpdate:bt,onEdgeUpdateStart:oe,onEdgeUpdateEnd:Ee,onReconnect:Se,onReconnectStart:Ve,onReconnectEnd:xe,reconnectRadius:$e=10,edgeUpdaterRadius:He=10,onNodesChange:J,onEdgesChange:Z,noDragClassName:je="nodrag",noWheelClassName:Ne="nowheel",noPanClassName:pe="nopan",fitView:Ue=!1,fitViewOptions:ae,connectOnClick:Ke=!0,attributionPosition:ot,proOptions:St,defaultEdgeOptions:me,elevateNodesOnSelect:nt=!0,elevateEdgesOnSelect:Ge=!1,disableKeyboardA11y:vt=!1,autoPanOnConnect:ct=!0,autoPanOnNodeDrag:Nt=!0,connectionRadius:Ye=20,isValidConnection:Je,onError:Et,style:te,id:ve,nodeDragThreshold:Ie,...rt},_t)=>{const Lt=ve||"1";return Ze.createElement("div",{...rt,style:{...te,...f8},ref:_t,className:ma(["react-flow",l]),"data-testid":"rf__wrapper",id:ve},Ze.createElement(d_,null,Ze.createElement(r8,{onInit:h,onMove:y,onMoveStart:g,onMoveEnd:b,onNodeClick:f,onEdgeClick:p,onNodeMouseEnter:A,onNodeMouseMove:M,onNodeMouseLeave:_,onNodeContextMenu:T,onNodeDoubleClick:k,nodeTypes:o,edgeTypes:d,connectionLineType:H,connectionLineStyle:I,connectionLineComponent:Y,connectionLineContainerStyle:P,selectionKeyCode:le,selectionOnDrag:K,selectionMode:de,deleteKeyCode:W,multiSelectionKeyCode:he,panActivationKeyCode:Q,zoomActivationKeyCode:re,onlyRenderVisibleElements:ue,selectNodesOnDrag:se,defaultViewport:At,translateExtent:lt,minZoom:we,maxZoom:st,preventScrolling:Fe,zoomOnScroll:ie,zoomOnPinch:ee,zoomOnDoubleClick:Pe,panOnScroll:ce,panOnScrollSpeed:fe,panOnScrollMode:qe,panOnDrag:Be,onPaneClick:Te,onPaneMouseEnter:gt,onPaneMouseMove:jt,onPaneMouseLeave:Mt,onPaneScroll:tt,onPaneContextMenu:ft,onSelectionContextMenu:D,onSelectionStart:O,onSelectionEnd:$,onEdgeContextMenu:Ft,onEdgeDoubleClick:Zt,onEdgeMouseEnter:Tt,onEdgeMouseMove:We,onEdgeMouseLeave:it,onReconnect:Se??bt,onReconnectStart:Ve??oe,onReconnectEnd:xe??Ee,reconnectRadius:$e??He,defaultMarkerColor:dt,noDragClassName:je,noWheelClassName:Ne,noPanClassName:pe,elevateEdgesOnSelect:Ge,rfId:Lt,disableKeyboardA11y:vt,nodeOrigin:Me,nodeExtent:Xe}),Ze.createElement(aF,{nodes:e,edges:n,defaultNodes:s,defaultEdges:i,onConnect:v,onConnectStart:S,onConnectEnd:N,onClickConnectStart:j,onClickConnectEnd:E,nodesDraggable:Le,nodesConnectable:be,nodesFocusable:De,edgesFocusable:mt,edgesUpdatable:ht,elementsSelectable:Ct,elevateNodesOnSelect:nt,minZoom:we,maxZoom:st,nodeExtent:Xe,onNodesChange:J,onEdgesChange:Z,snapToGrid:Ce,snapGrid:Re,connectionMode:F,translateExtent:lt,connectOnClick:Ke,defaultEdgeOptions:me,fitView:Ue,fitViewOptions:ae,onNodesDelete:G,onEdgesDelete:U,onNodeDragStart:C,onNodeDrag:L,onNodeDragStop:z,onSelectionDrag:R,onSelectionDragStart:V,onSelectionDragStop:B,noPanClassName:pe,nodeOrigin:Me,rfId:Lt,autoPanOnConnect:ct,autoPanOnNodeDrag:Nt,onError:Et,connectionRadius:Ye,isValidConnection:Je,nodeDragThreshold:Ie}),Ze.createElement(tF,{onSelectionChange:X}),Rt,Ze.createElement(T$,{proOptions:St,position:ot}),Ze.createElement(oF,{rfId:Lt,disableKeyboardA11y:vt})))});cb.displayName="ReactFlow";const m8=e=>e.domNode?.querySelector(".react-flow__edgelabel-renderer");function h8({children:e}){const n=Dn(m8);return n?Ql.createPortal(e,n):null}const f_=({id:e,x:n,y:s,width:i,height:l,style:o,color:d,strokeColor:f,strokeWidth:p,className:h,borderRadius:y,shapeRendering:g,onClick:b,selected:v})=>{const{background:S,backgroundColor:N}=o||{},j=d||S||N;return Ze.createElement("rect",{className:ma(["react-flow__minimap-node",{selected:v},h]),x:n,y:s,rx:y,ry:y,width:i,height:l,fill:j,stroke:f,strokeWidth:p,shapeRendering:g,onClick:b?E=>b(E,e):void 0})};f_.displayName="MiniMapNode";var p8=u.memo(f_);const y8=e=>e.nodeOrigin,g8=e=>e.getNodes().filter(n=>!n.hidden&&n.width&&n.height),Qp=e=>e instanceof Function?e:()=>e;function b8({nodeStrokeColor:e="transparent",nodeColor:n="#e2e2e2",nodeClassName:s="",nodeBorderRadius:i=5,nodeStrokeWidth:l=2,nodeComponent:o=p8,onClick:d}){const f=Dn(g8,la),p=Dn(y8),h=Qp(n),y=Qp(e),g=Qp(s),b=typeof window>"u"||window.chrome?"crispEdges":"geometricPrecision";return Ze.createElement(Ze.Fragment,null,f.map(v=>{const{x:S,y:N}=Fi(v,p).positionAbsolute;return Ze.createElement(o,{key:v.id,x:S,y:N,width:v.width,height:v.height,style:v.style,selected:v.selected,className:g(v),color:h(v),borderRadius:i,strokeColor:y(v),strokeWidth:l,shapeRendering:b,onClick:d,id:v.id})}))}var x8=u.memo(b8);const v8=200,S8=150,w8=e=>{const n=e.getNodes(),s={x:-e.transform[0]/e.transform[2],y:-e.transform[1]/e.transform[2],width:e.width/e.transform[2],height:e.height/e.transform[2]};return{viewBB:s,boundingRect:n.length>0?R$(Wf(n,e.nodeOrigin),s):s,rfId:e.rfId}},N8="react-flow__minimap-desc";function m_({style:e,className:n,nodeStrokeColor:s="transparent",nodeColor:i="#e2e2e2",nodeClassName:l="",nodeBorderRadius:o=5,nodeStrokeWidth:d=2,nodeComponent:f,maskColor:p="rgb(240, 240, 240, 0.6)",maskStrokeColor:h="none",maskStrokeWidth:y=1,position:g="bottom-right",onClick:b,onNodeClick:v,pannable:S=!1,zoomable:N=!1,ariaLabel:j="React Flow mini map",inversePan:E=!1,zoomStep:A=10,offsetScale:M=5}){const _=ra(),T=u.useRef(null),{boundingRect:k,viewBB:C,rfId:L}=Dn(w8,la),z=e?.width??v8,G=e?.height??S8,U=k.width/z,X=k.height/G,V=Math.max(U,X),R=V*z,B=V*G,D=M*V,O=k.x-(R-k.width)/2-D,$=k.y-(B-k.height)/2-D,F=R+D*2,H=B+D*2,I=`${N8}-${L}`,Y=u.useRef(0);Y.current=V,u.useEffect(()=>{if(T.current){const le=ls(T.current),K=he=>{const{transform:re,d3Selection:Ce,d3Zoom:Re}=_.getState();if(he.sourceEvent.type!=="wheel"||!Ce||!Re)return;const ue=-he.sourceEvent.deltaY*(he.sourceEvent.deltaMode===1?.05:he.sourceEvent.deltaMode?1:.002)*A,se=re[2]*Math.pow(2,ue);Re.scaleTo(Ce,se)},de=he=>{const{transform:re,d3Selection:Ce,d3Zoom:Re,translateExtent:ue,width:se,height:Le}=_.getState();if(he.sourceEvent.type!=="mousemove"||!Ce||!Re)return;const be=Y.current*Math.max(1,re[2])*(E?-1:1),De={x:re[0]-he.sourceEvent.movementX*be,y:re[1]-he.sourceEvent.movementY*be},Me=[[0,0],[se,Le]],mt=br.translate(De.x,De.y).scale(re[2]),ht=Re.constrain()(mt,Me,ue);Re.transform(Ce,ht)},Q=vE().on("zoom",S?de:null).on("zoom.wheel",N?K:null);return le.call(Q),()=>{le.on("zoom",null)}}},[S,N,E,A]);const P=b?le=>{const K=ws(le);b(le,{x:K[0],y:K[1]})}:void 0,W=v?(le,K)=>{const de=_.getState().nodeInternals.get(K);v(le,de)}:void 0;return Ze.createElement(Qg,{position:g,style:e,className:ma(["react-flow__minimap",n]),"data-testid":"rf__minimap"},Ze.createElement("svg",{width:z,height:G,viewBox:`${O} ${$} ${F} ${H}`,role:"img","aria-labelledby":I,ref:T,onClick:P},j&&Ze.createElement("title",{id:I},j),Ze.createElement(x8,{onClick:W,nodeColor:i,nodeStrokeColor:s,nodeBorderRadius:o,nodeClassName:l,nodeStrokeWidth:d,nodeComponent:f}),Ze.createElement("path",{className:"react-flow__minimap-mask",d:`M${O-D},${$-D}h${F+D*2}v${H+D*2}h${-F-D*2}z
        M${C.x},${C.y}h${C.width}v${C.height}h${-C.width}z`,fill:p,fillRule:"evenodd",stroke:h,strokeWidth:y,pointerEvents:"none"})))}m_.displayName="MiniMap";var h_=u.memo(m_);function j8(){return Ze.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32"},Ze.createElement("path",{d:"M32 18.133H18.133V32h-4.266V18.133H0v-4.266h13.867V0h4.266v13.867H32z"}))}function E8(){return Ze.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 5"},Ze.createElement("path",{d:"M0 0h32v4.2H0z"}))}function _8(){return Ze.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 30"},Ze.createElement("path",{d:"M3.692 4.63c0-.53.4-.938.939-.938h5.215V0H4.708C2.13 0 0 2.054 0 4.63v5.216h3.692V4.631zM27.354 0h-5.2v3.692h5.17c.53 0 .984.4.984.939v5.215H32V4.631A4.624 4.624 0 0027.354 0zm.954 24.83c0 .532-.4.94-.939.94h-5.215v3.768h5.215c2.577 0 4.631-2.13 4.631-4.707v-5.139h-3.692v5.139zm-23.677.94c-.531 0-.939-.4-.939-.94v-5.138H0v5.139c0 2.577 2.13 4.707 4.708 4.707h5.138V25.77H4.631z"}))}function C8(){return Ze.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},Ze.createElement("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0 8 0 4.571 3.429 4.571 7.619v3.048H3.048A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047zm4.724-13.866H7.467V7.619c0-2.59 2.133-4.724 4.723-4.724 2.591 0 4.724 2.133 4.724 4.724v3.048z"}))}function A8(){return Ze.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 25 32"},Ze.createElement("path",{d:"M21.333 10.667H19.81V7.619C19.81 3.429 16.38 0 12.19 0c-4.114 1.828-1.37 2.133.305 2.438 1.676.305 4.42 2.59 4.42 5.181v3.048H3.047A3.056 3.056 0 000 13.714v15.238A3.056 3.056 0 003.048 32h18.285a3.056 3.056 0 003.048-3.048V13.714a3.056 3.056 0 00-3.048-3.047zM12.19 24.533a3.056 3.056 0 01-3.047-3.047 3.056 3.056 0 013.047-3.048 3.056 3.056 0 013.048 3.048 3.056 3.056 0 01-3.048 3.047z"}))}const wc=({children:e,className:n,...s})=>Ze.createElement("button",{type:"button",className:ma(["react-flow__controls-button",n]),...s},e);wc.displayName="ControlButton";const T8=e=>({isInteractive:e.nodesDraggable||e.nodesConnectable||e.elementsSelectable,minZoomReached:e.transform[2]<=e.minZoom,maxZoomReached:e.transform[2]>=e.maxZoom}),p_=({style:e,showZoom:n=!0,showFitView:s=!0,showInteractive:i=!0,fitViewOptions:l,onZoomIn:o,onZoomOut:d,onFitView:f,onInteractiveChange:p,className:h,children:y,position:g="bottom-left"})=>{const b=ra(),[v,S]=u.useState(!1),{isInteractive:N,minZoomReached:j,maxZoomReached:E}=Dn(T8,la),{zoomIn:A,zoomOut:M,fitView:_}=Xf();if(u.useEffect(()=>{S(!0)},[]),!v)return null;const T=()=>{A(),o?.()},k=()=>{M(),d?.()},C=()=>{_(l),f?.()},L=()=>{b.setState({nodesDraggable:!N,nodesConnectable:!N,elementsSelectable:!N}),p?.(!N)};return Ze.createElement(Qg,{className:ma(["react-flow__controls",h]),position:g,style:e,"data-testid":"rf__controls"},n&&Ze.createElement(Ze.Fragment,null,Ze.createElement(wc,{onClick:T,className:"react-flow__controls-zoomin",title:"zoom in","aria-label":"zoom in",disabled:E},Ze.createElement(j8,null)),Ze.createElement(wc,{onClick:k,className:"react-flow__controls-zoomout",title:"zoom out","aria-label":"zoom out",disabled:j},Ze.createElement(E8,null))),s&&Ze.createElement(wc,{className:"react-flow__controls-fitview",onClick:C,title:"fit view","aria-label":"fit view"},Ze.createElement(_8,null)),i&&Ze.createElement(wc,{className:"react-flow__controls-interactive",onClick:L,title:"toggle interactivity","aria-label":"toggle interactivity"},N?Ze.createElement(A8,null):Ze.createElement(C8,null)),y)};p_.displayName="Controls";var y_=u.memo(p_),_s;(function(e){e.Lines="lines",e.Dots="dots",e.Cross="cross"})(_s||(_s={}));function M8({color:e,dimensions:n,lineWidth:s}){return Ze.createElement("path",{stroke:e,strokeWidth:s,d:`M${n[0]/2} 0 V${n[1]} M0 ${n[1]/2} H${n[0]}`})}function k8({color:e,radius:n}){return Ze.createElement("circle",{cx:n,cy:n,r:n,fill:e})}const R8={[_s.Dots]:"#91919a",[_s.Lines]:"#eee",[_s.Cross]:"#e2e2e2"},I8={[_s.Dots]:1,[_s.Lines]:1,[_s.Cross]:6},L8=e=>({transform:e.transform,patternId:`pattern-${e.rfId}`});function g_({id:e,variant:n=_s.Dots,gap:s=20,size:i,lineWidth:l=1,offset:o=2,color:d,style:f,className:p}){const h=u.useRef(null),{transform:y,patternId:g}=Dn(L8,la),b=d||R8[n],v=i||I8[n],S=n===_s.Dots,N=n===_s.Cross,j=Array.isArray(s)?s:[s,s],E=[j[0]*y[2]||1,j[1]*y[2]||1],A=v*y[2],M=N?[A,A]:E,_=S?[A/o,A/o]:[M[0]/o,M[1]/o];return Ze.createElement("svg",{className:ma(["react-flow__background",p]),style:{...f,position:"absolute",width:"100%",height:"100%",top:0,left:0},ref:h,"data-testid":"rf__background"},Ze.createElement("pattern",{id:g+e,x:y[0]%E[0],y:y[1]%E[1],width:E[0],height:E[1],patternUnits:"userSpaceOnUse",patternTransform:`translate(-${_[0]},-${_[1]})`},S?Ze.createElement(k8,{color:b,radius:A/o}):Ze.createElement(M8,{dimensions:M,color:b,lineWidth:l})),Ze.createElement("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:`url(#${g+e})`}))}g_.displayName="Background";var b_=u.memo(g_);const D8=420,O8=520,$8=16,Td=(e,n,s)=>Math.min(Math.max(e,n),s),gN=e=>e?.type?.name||e?.typeName||"Entity";function F8({position:e,cluster:n,onClose:s,onAddToBoard:i,onReturnToGroup:l,onSetTargetEntity:o,onOpenEntityInfo:d,releasedEntityIds:f=[]}){const{label:p,relationshipType:h,entities:y=[],placedEntityIds:g=[],sourceId:b}=n||{},[v,S]=u.useState(null),[N,j]=u.useState(null),[E,A]=u.useState({x:e?.x??100,y:e?.y??100}),M=u.useRef(null),_=u.useRef(null),T=u.useCallback(()=>{const $=v?.parentElement;if($){const F=$.getBoundingClientRect();return{left:F.left,top:F.top,width:F.width,height:F.height}}return{left:0,top:0,width:window.innerWidth,height:window.innerHeight}},[v]),k=u.useMemo(()=>new Set((Array.isArray(g)?g:[]).map(String)),[g]),C=u.useMemo(()=>new Set((Array.isArray(f)?f:[]).map(String)),[f]),L=u.useMemo(()=>Array.isArray(y)?y.filter($=>!C.has(String($.id))):[],[y,C]),z=L.length,G=u.useMemo(()=>{const $=T(),F=M.current?.offsetWidth??D8,H=M.current?.offsetHeight??Math.min($.height*.7,O8),I=$8;return{minX:I,minY:I,maxX:Math.max(I,$.width-F-I),maxY:Math.max(I,$.height-H-I),containerRect:$,entityCount:z}},[z,T]);u.useEffect(()=>{const $=document.querySelector(".react-flow__renderer")||document.querySelector(".react-flow")||document.body,F=document.createElement("div");return F.style.position=$===document.body?"fixed":"absolute",F.style.top="0",F.style.left="0",F.style.right="0",F.style.bottom="0",F.style.zIndex="2500",F.style.pointerEvents="auto",$.appendChild(F),S(F),()=>$.removeChild(F)},[]),u.useEffect(()=>{A({x:Td(e?.x??100,G.minX,G.maxX),y:Td(e?.y??100,G.minY,G.maxY)})},[G,e?.x,e?.y]);const U=u.useCallback($=>{if(!_.current)return;const{offsetX:F,offsetY:H,bounds:I,containerRect:Y}=_.current,P=Td($.clientX-Y.left-F,I.minX,I.maxX),W=Td($.clientY-Y.top-H,I.minY,I.maxY);A({x:P,y:W})},[]),X=u.useCallback(()=>{_.current=null,window.removeEventListener("pointermove",U),window.removeEventListener("pointerup",X),window.removeEventListener("pointercancel",X)},[U]),V=$=>{if($.button!==0||$.target.closest("button")||$.target.closest(".cluster-popup-entity"))return;$.preventDefault(),$.stopPropagation();const F=G,H=F.containerRect||T(),I=$.clientX-H.left-(E?.x??F.minX),Y=$.clientY-H.top-(E?.y??F.minY);_.current={offsetX:I,offsetY:Y,bounds:F,containerRect:H},window.addEventListener("pointermove",U),window.addEventListener("pointerup",X),window.addEventListener("pointercancel",X)};u.useEffect(()=>()=>X(),[X]);const R=u.useCallback(()=>{X(),s?.()},[X,s]);u.useEffect(()=>{const $=F=>F.key==="Escape"&&R();return document.addEventListener("keydown",$),()=>document.removeEventListener("keydown",$)},[R]),u.useEffect(()=>{j(null)},[n?.id]);const B=u.useCallback(($,F)=>{F||j(H=>H===$?null:$)},[]),D=u.useCallback($=>{$&&(C.has(String($))||(i?.(n,$),j(null)))},[n,i,C]),O=u.useCallback($=>{$&&(l?.(n,$),j(null))},[n,l]);return v?pj.createPortal(t.jsx("div",{className:"cluster-popup-overlay",children:t.jsxs("div",{ref:M,className:"cluster-popup-panel",style:{top:`${E?.y??100}px`,left:`${E?.x??100}px`},children:[t.jsxs("div",{className:"cluster-popup-header",onPointerDown:V,children:[t.jsxs("div",{className:"cluster-popup-title",children:[t.jsx("div",{className:"cluster-popup-relationship",children:h||"Cluster"}),t.jsx("div",{className:"cluster-popup-label",children:p||"Entities"})]}),t.jsx("button",{onClick:R,className:"cluster-popup-close","aria-label":"Close cluster",children:t.jsx("span",{"aria-hidden":"true",children:""})})]}),t.jsx("div",{className:"cluster-popup-instructions",children:"Use the action icons to set a relationship target, open entity details, or add and manage entities on the board."}),t.jsx("div",{className:"cluster-popup-entities",children:L.length?L.map($=>{const F=String($.id),H=k.has(F)||C.has(F),I=N===F,Y=b!=null&&F===String(b);return t.jsxs("div",{className:`cluster-popup-entity ${H?"is-placed":""} ${I?"is-selected":""}`,title:$.name||`Entity ${$.id}`,onClick:()=>B(F,H),children:[t.jsx("div",{className:"cluster-popup-entity-header",children:t.jsx("div",{className:"cluster-popup-entity-name",children:$.name||`Entity ${$.id}`})}),t.jsx("div",{className:"cluster-popup-entity-meta",title:gN($),children:gN($)}),t.jsxs("div",{className:"cluster-popup-entity-actions",role:"group","aria-label":"Entity actions",children:[H?t.jsx("button",{type:"button",className:"cluster-popup-entity-action",onClick:P=>{P.stopPropagation(),O($)},onPointerDown:P=>P.stopPropagation(),"aria-label":"Recall entity to cluster",title:"Recall to cluster",disabled:!l,children:t.jsx(Vi,{size:16,"aria-hidden":"true"})}):t.jsx("button",{type:"button",className:"cluster-popup-entity-action is-primary",onClick:P=>{P.stopPropagation(),D(F)},onPointerDown:P=>P.stopPropagation(),"aria-label":"Add entity to board",title:"Add to board",disabled:!i,children:t.jsx(Wn,{size:16,"aria-hidden":"true"})}),t.jsx("button",{type:"button",className:"cluster-popup-entity-action",onClick:P=>{P.stopPropagation(),d?.(F)},onPointerDown:P=>P.stopPropagation(),"aria-label":"Open entity details",title:"Open details",disabled:!d,children:t.jsx(xj,{size:16,"aria-hidden":"true"})}),!Y&&t.jsx("button",{type:"button",className:"cluster-popup-entity-action",onClick:P=>{P.stopPropagation(),o?.(F)},onPointerDown:P=>P.stopPropagation(),"aria-label":"Use as relationship source",title:"Set as source",disabled:!o,children:t.jsx(pg,{size:16,"aria-hidden":"true"})})]})]},$.id)}):t.jsx("div",{className:"cluster-popup-empty",children:"No entities in this cluster."})})]})}),v):null}function z8({id:e,data:n}){const[s,i]=u.useState(!1),[l,o]=u.useState({x:0,y:0}),[d,f]=u.useState([]);u.useEffect(()=>{const j=n?.containedIds||n?.data?.containedIds||[],E=n?.allNodes||n?.data?.allNodes||[];if(j.length&&E.length){const A=E.filter(M=>j.includes(M.id));f(A)}else f([])},[n]);const p=j=>{j.stopPropagation();const A=(document.querySelector(".react-flow__renderer")||document.querySelector(".react-flow"))?.getBoundingClientRect(),M=A?.width??window.innerWidth,_=A?.height??window.innerHeight,T=420,k=Math.min(_*.7,520),C=16,L=j.clientX-(A?.left??0),z=j.clientY-(A?.top??0);let G=L+C,U=z-k/2;const X=M-T-C,V=C;G>X&&(G=Math.max(V,L-T-C)),G=Math.max(V,Math.min(G,X));const R=_-k-C,B=C;U<B?U=B:U>R&&(U=R),o({x:G,y:U}),i(!0)},h=()=>i(!1),y=u.useMemo(()=>new Set((n?.placedEntityIds||[]).map(j=>String(j))),[n?.placedEntityIds]),g=d.length,b=n?.count??g+y.size,v=g,S=b?`contains ${v} of ${b}`:"contains 0 of 0",N=n?.relationshipType||n?.label||"Cluster";return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"cluster-node",onClick:p,children:[t.jsx(Es,{id:"top",type:"target",position:Gt.Top,style:{width:12,height:12,background:"#fcd34d",border:"1px solid #fff",borderRadius:"999px",boxShadow:"0 1px 2px rgba(120, 53, 15, 0.2)"}}),t.jsx("div",{className:"cluster-node__header",children:t.jsx("div",{className:"cluster-node__badge",children:v})}),t.jsx("div",{className:"cluster-node__label",children:N}),t.jsx("div",{className:"cluster-node__count",children:S}),t.jsx(Es,{id:"bottom",type:"source",position:Gt.Bottom,style:{width:12,height:12,background:"#fcd34d",border:"1px solid #fff",borderRadius:"999px",boxShadow:"0 1px 2px rgba(120, 53, 15, 0.2)"}})]}),s&&t.jsx(F8,{position:l,cluster:{id:e,label:n?.label,entities:d,relationshipType:n?.relationshipType,sourceId:n?.sourceId,placedEntityIds:n?.placedEntityIds||[]},onClose:h,onAddToBoard:n?.onAddToBoard,onReturnToGroup:n?.onReturnToGroup,onSetTargetEntity:n?.onSetTargetEntity,onOpenEntityInfo:n?.onOpenEntityInfo,releasedEntityIds:n?.manuallyReleasedIds||[]})]})}function B8({data:e}){const n=!!e?.isCenter,s=e?.label||"Entity",i=e?.typeName||"Entity",l=e?.style||{},o=e?.entityId||e?.id,d=e?.imageUrl||ao(e?.entity),f=h=>{h?.preventDefault(),h?.stopPropagation(),!(!e?.onSetTarget||!o||n)&&e.onSetTarget(String(o))},p=h=>{h?.preventDefault(),h?.stopPropagation(),!(!e?.onOpenInfo||!o)&&e.onOpenInfo(String(o))};return t.jsxs("div",{className:`entity-node ${n?"entity-node--center":"entity-node--standard"}`,style:{...l},children:[t.jsx(Es,{id:"top",type:"target",position:Gt.Top,style:{width:12,height:12,background:"#cbd5f5",border:"1px solid #fff",borderRadius:"999px",boxShadow:"0 1px 2px rgba(15, 23, 42, 0.25)"}}),n&&t.jsx("span",{className:"entity-node__center-indicator"}),t.jsxs("div",{className:"entity-node__content",children:[t.jsxs("div",{className:"entity-node__row entity-node__row--title",children:[d?t.jsx("div",{className:"entity-node__avatar","aria-hidden":"true",children:t.jsx("img",{src:d,alt:"",loading:"lazy"})}):null,t.jsx("div",{className:"entity-node__label",title:s,children:s})]}),t.jsxs("div",{className:"entity-node__row entity-node__row--meta",children:[t.jsx("div",{className:`entity-node__type-pill ${n?"is-center":""}`,children:i}),t.jsxs("div",{className:"entity-node__actions","aria-hidden":!e?.onSetTarget&&!e?.onOpenInfo,children:[t.jsx("button",{type:"button",className:"entity-node__action",onClick:f,onPointerDown:h=>h.stopPropagation(),"aria-label":"Use as relationship source",disabled:n||!e?.onSetTarget,children:t.jsx(pg,{size:16,strokeWidth:2.25,absoluteStrokeWidth:!0,"aria-hidden":"true"})}),t.jsx("button",{type:"button",className:"entity-node__action",onClick:p,onPointerDown:h=>h.stopPropagation(),"aria-label":"Open entity in new window",disabled:!e?.onOpenInfo,children:t.jsx(Jl,{size:16,strokeWidth:2.25,absoluteStrokeWidth:!0,"aria-hidden":"true"})})]})]})]}),t.jsx(Es,{id:"bottom",type:"source",position:Gt.Bottom,style:{width:12,height:12,background:"#cbd5f5",border:"1px solid #fff",borderRadius:"999px",boxShadow:"0 1px 2px rgba(15, 23, 42, 0.25)"}})]})}const Kf=220,ub=160,Qc=220,x_=120,db=40,v_=5,sa="Related",U8=40,q8=120,dc=Math.max(Qc,Kf)+U8,S_=x_+q8,yf=Qc+db,Xy=/(part of|owned by|managed by|works for|reports to|child of|belongs to|member of|subsidiary of|division of|child)/i,bN=/(owns|manages|contains|has member|employs|parent of|parent|oversees|supervises|leads)/i,w_=/(owns|contains|parent|manages|supervises|leads|employs|has member|has child)/i,P8=/(child of|belongs to|part of|owned by|managed by|reports to|works for)/i,H8=/\s*\(linked to source\)/gi;function Sa(e,n){if(typeof e=="string"){const s=e.replace(H8,"").trim();if(s)return s}return n}function Gd(e){if(!e)return!1;const n=e?.type;return n==="cluster"||n==="clusterNode"}function V8(e,n,s){if(!e||!n||!(s instanceof Map))return!1;let i=String(n);const l=String(e),o=new Set;for(;i&&!o.has(i);){if(o.add(i),i===l)return!0;const d=s.get(i)?.parentId;i=d!=null?String(d):null}return!1}function xN(e){if(!e)return null;const n=String(e.id??"");if(!n)return null;const s=Sa(e?.name,`Entity ${n}`),i=e?.type?.name||e?.typeName||"Entity";return{...e,id:n,name:s,typeName:i}}function Y8(e,n){if(!e)return{parentId:null,childId:null};const s=e?.fromEntityId!=null?String(e.fromEntityId):null,i=e?.toEntityId!=null?String(e.toEntityId):null,l=e?.relationshipType;let o=s&&i?s:null,d=s&&i?i:null;const f=l&&typeof l=="object"?l:null,p=(...A)=>{for(const M of A)if(M!=null&&M!=="")return M;return null},h=p(f?.from_label,f?.fromLabel,f?.from_name,f?.fromName),y=p(f?.to_label,f?.toLabel,f?.to_name,f?.toName),g=A=>typeof A=="string"&&Xy.test(A),b=A=>typeof A=="string"&&bN.test(A),v=g(h),S=g(y),N=b(h),j=b(y);S&&!v?(o=i,d=s):v&&!S?(o=s,d=i):N&&!j?(o=i,d=s):j&&!N&&(o=s,d=i);const E=(()=>{if(!l)return"";if(typeof l=="string")return l.toLowerCase();const A=l?.label||l?.name||l?.from_label||l?.to_label||"";return String(A).toLowerCase()})();if(s&&i&&E){const A=/(parent|owns|contains)/.test(E);if(/(child|belongs to|part of)/.test(E)&&!A){const _=o;o=d,d=_}}return!o&&!d&&s&&i&&E&&(Xy.test(E)?(o=i,d=s):bN.test(E)&&(o=s,d=i)),{parentId:o,childId:d}}function N_(e,n){if(!e)return null;const s=e?.from_entity??e?.fromEntityId??e?.from??e?.source??e?.sourceId??null,i=e?.to_entity??e?.toEntityId??e?.to??e?.target??e?.targetId??null,l=s!=null?String(s):null,o=i!=null?String(i):null;if(!l||!o||l===o)return null;const d=e?.id!=null&&e.id!==""?String(e.id):`edge-${l}-${o}`,f=e?.relationshipType??e?.type??e?.data?.relationshipType??null,p={fromEntityId:l,toEntityId:o,relationshipType:f},{parentId:h,childId:y}=Y8(p),g=f&&typeof f=="object"?{id:f?.id??null,name:f?.name||f?.label||f?.from_label||f?.to_label||null,label:f?.label??null,from_label:f?.from_label??null,to_label:f?.to_label??null}:f,b=(()=>{if(!g)return e?.label||e?.typeName||e?.data?.typeName||sa;if(typeof g=="string")return g||sa;const{from_label:j,to_label:E,label:A,name:M}=g;return n!=null&&String(n)===l?j||A||M||sa:n!=null&&String(n)===o?E||A||M||sa:A||M||j||E||sa})(),v=String(b||sa).trim()||sa,S=!g||typeof g=="string"?(typeof g=="string"?g:null)||sa:g?.name||g?.label||g?.from_label||g?.to_label||sa,N=g&&typeof g=="object"?g?.id??null:null;return{id:d,source:h??l,target:y??o,parentId:h,childId:y,label:v,typeName:S??sa,typeId:N??null,fromEntityId:l,toEntityId:o,relationshipType:g??null,relationshipLabel:v,raw:e}}function G8(e,n,s=v_,i=null,l=1){const o=[],d=new Map,f=[],p=new Set,h=i!=null?String(i):null;if(!Array.isArray(n)||!n.length)return{clusters:o,suppressedNodes:d,edges:n||[]};const y=new Map((Array.isArray(e)?e:[]).map(C=>[String(C?.id??""),C])),g=new Map;h&&g.set(h,0),y.forEach((C,L)=>{const z=typeof C?.data?.level=="number"?C.data.level:typeof C?.level=="number"?C.level:null;z!=null&&Number.isFinite(z)&&g.set(L,z)});const b=new Map,v=new Map;n.forEach(C=>{if(!C)return;const L=C.parentId||C.source||null,z=C.childId||C.target||null;if(!L||!z)return;const G=String(L),U=String(z),X=y.get(G)||e.find(R=>String(R?.id??"")===G);!X||X.inCluster||(y.get(U)||e.find(R=>String(R?.id??"")===U))?.inCluster||(b.has(G)||b.set(G,new Set),b.get(G).add(U),v.has(U)||v.set(U,new Set),v.get(U).add(G))});const S=new Map;if(h){S.set(h,{parentId:null});const C=new Set,L=[h];for(;L.length;){const z=L.pop();if(!z||C.has(z))continue;C.add(z),S.has(z)||S.set(z,{parentId:null});const G=v.get(z);if(G&&G.size){const[U]=Array.from(G),X=U!=null?String(U):null;if(X){const V=S.get(z)||{};V.parentId?S.set(z,{...V}):S.set(z,{...V,parentId:X}),G.forEach(R=>{const B=R!=null?String(R):null;B&&(S.has(B)||S.set(B,{parentId:null}),C.has(B)||L.push(B))})}}}}const N=new Set(g.keys());if(h){N.add(h);const C=v.get(h);C&&C.forEach(L=>{g.has(L)||g.set(L,0),N.add(L)})}const j=Array.from(N),E=new Set(Array.from(N)),A=1e4;let M=0;for(;j.length&&M<A;){M+=1;const C=j.shift();if(!C)continue;E.has(C)||E.add(C);const L=g.get(C);if(L==null||!Number.isFinite(L))continue;const z=b.get(C);z&&z.forEach(G=>{if(E.has(G))return;const U=L+1,X=g.get(G);(X==null||U<X)&&(g.set(G,U),E.add(G),j.push(G))})}M>=A&&console.warn(`groupChildrenByRelationship: Reached maximum iteration limit (${A}), possible circular relationship detected`);const _=new Map;if(n.forEach(C=>{if(!C)return;const L=C.parentId||C.source||null,z=C.childId||C.target||null;if(!L||!z)return;const G=String(L),U=String(z);if(!G||!U||G===U)return;const X=y.get(G),V=y.get(U);if(X?.inCluster||V?.inCluster)return;const R=g.get(G)??0,B=g.get(U)??R+1;if(R>=l||B>l)return;const D=String(C.relationshipLabel||C.label||sa).trim()||sa,O=C.typeName&&String(C.typeName).trim()||(typeof C.relationshipType=="object"?String(C.relationshipType?.name||C.relationshipType?.label||C.relationshipType?.from_label||C.relationshipType?.to_label||"").trim():null)||null,$=C.typeId!=null?String(C.typeId):C.relationshipType&&typeof C.relationshipType=="object"&&C.relationshipType?.id!=null?String(C.relationshipType.id):null,F=O||$||"unknown-type",H=`${G}-${F}`;_.has(H)||_.set(H,{parentId:G,typeName:O,typeId:$,typeKey:F,relationshipLabel:D,childMap:new Map});const I=_.get(H);I.childMap.has(U)||I.childMap.set(U,[]),I.childMap.get(U).push(C)}),_.forEach(C=>{if(y.get(C.parentId)?.inCluster||e.find($=>String($?.id??"")===C.parentId)?.inCluster)return;const z=Array.from(C.childMap.keys()).filter($=>!y.get($)?.inCluster);if(z.length<s)return;const G=sz(C.typeName||C.typeKey),U=`cluster-${C.parentId}-${G}`,X=g.get(C.parentId)??0,V=C.typeName||C.relationshipLabel||sa,R=z.filter($=>!y.get($)?.inCluster);if(!R.length)return;const B={id:U,parentId:C.parentId,relationshipType:V,typeName:C.typeName,typeId:C.typeId,containedIds:[...R],label:"",count:0,parentLevel:X},D=h&&B.containedIds.length?B.containedIds.filter($=>V8($,h,S)):[],O=new Set(D);D.length&&(B.containedIds=B.containedIds.filter($=>!O.has($)),D.forEach($=>{const F=y.get($)||null;F&&(F.isExpandedProtected=!0,F.inCluster&&(F.inCluster=!1));const H=e.find(I=>String(I?.id??"")===$);H&&H!==F&&(H.isExpandedProtected=!0,H.inCluster&&(H.inCluster=!1))})),B.containedIds.length&&(B.containedIds.forEach($=>{const F=e.find(H=>String(H?.id??"")===$)||y.get($);F&&(F.inCluster=!0)}),B.count=B.containedIds.length,B.label=`${V} (${B.count})`,o.push(B),R.forEach($=>{if(O.has($))return;const F=y.get($)||e.find(I=>String(I?.id??"")===$)||null;if(F?.isExpandedProtected){F.inCluster=!1;return}d.set($,{clusterId:B.id,parentId:C.parentId,relationshipType:V,typeName:C.typeName,typeId:C.typeId,entity:F}),F&&(F.inCluster=!0),(C.childMap.get($)||[]).forEach(I=>p.add(I.id))}),f.push({id:`edge-${C.parentId}-${B.id}`,source:C.parentId,target:B.id,label:B.label,parentId:C.parentId,childId:B.id,relationshipLabel:V,relationshipType:V,typeName:C.typeName,typeId:C.typeId,isClusterEdge:!0}))}),!o.length)return{clusters:o,suppressedNodes:d,edges:n};const k=[...n.filter(C=>{if(!C||p.has(C.id))return!1;const L=String(C.target??C.childId??"");if(L&&d.has(L))return!1;const z=String(C.source??C.parentId??"");return!(z&&d.has(z))}),...f];return{clusters:o,suppressedNodes:d,edges:k}}function W8(e,{isCenter:n=!1}={}){const s=String(e.id),i=Sa(e?.name,`Entity ${s}`),l=e?.typeName||"Entity",o=!!e?.isExpandedProtected,d=ao(e);return{id:s,type:"entity",width:Qc,height:x_,isExpandedProtected:o,position:{x:0,y:0},data:{label:i,typeName:l,entityId:s,isCenter:n,isExpandedProtected:o,imageUrl:d}}}function X8(e,n){const s=e.relationshipType||sa,i=e.label||s,l=e.count??(Array.isArray(e.containedIds)?e.containedIds.length:0),o=typeof e.parentLevel=="number"&&Number.isFinite(e.parentLevel)?e.parentLevel:null;return{id:e.id,type:"cluster",width:Kf,height:ub,position:{x:0,y:0},data:{label:i,relationshipType:s,containedIds:e.containedIds,count:l,sourceId:e.parentId,placedEntityIds:[],allNodes:n,parentLevel:o}}}function K8(e,n,s){const i=s!=null?String(s):null;n.forEach(l=>{if(!l)return;const o=String(l.id);e.has(o)||e.set(o,o===i?0:1)}),i&&e.set(i,0),e.forEach((l,o)=>{(typeof l!="number"||!Number.isFinite(l))&&e.set(o,o===i?0:1)})}function Z8(e,n){let s=1/0;n.forEach(f=>{if(!f)return;const p=e.get(f.id);typeof p=="number"&&Number.isFinite(p)&&p<s&&(s=p)}),Number.isFinite(s)||(s=0);const i=new Map,l=new Map;n.forEach(f=>{if(!f)return;const h=(e.get(f.id)??0)-s;l.set(f.id,h),i.has(h)||i.set(h,[]),i.get(h).push(f)});const o=Array.from(i.keys()).sort((f,p)=>f-p),d=new Map;return o.forEach(f=>{const p=i.get(f)||[];p.sort((h,y)=>{const g=h?.data?.label||h.id,b=y?.data?.label||y.id;return g.localeCompare(b)}),d.set(f,p)}),{groups:d,visualLevels:l}}function Ky(e){if(!e)return"";const n=typeof e?.data?.label=="string"?e.data.label.trim():"";if(n)return n;const s=typeof e?.name=="string"?e.name.trim():"";return s||(e?.id!=null?String(e.id):"")}function j_(e,n){const s=Ky(e),i=Ky(n);return s.localeCompare(i)}function Q8(e,n,s,i={}){const{centerId:l=null}=i,o=l!=null?String(l):null,d=new Map;e.forEach(p=>{if(!p)return;const h=p?.parentId??p?.data?.parentId??p?.source??p?.data?.source??null,y=p?.childId??p?.data?.childId??p?.target??p?.data?.target??null,g=h!=null?String(h):null,b=y!=null?String(y):null;if(!g||!b||g===b)return;const v=p?.label??p?.relationshipLabel??"",S=v||E_(p),N=v||nz(p),j=pr(S)||pr(N)||pr(v),E=!!S&&(tz(S)||w_.test(S)),A={parentId:g,relationshipKey:j,relationshipName:N,indicatesParental:E};d.has(b)||d.set(b,[]),d.get(b).push(A)});const f=new Map;return d.forEach((p,h)=>{let y=null,g=1/0,b="",v=null,S="",N="";p.forEach(j=>{if(!j)return;const E=j.parentId,A=n.get(E);if(typeof A!="number"||!Number.isFinite(A))return;const M=s.get(E),_=Ky(M);if(y==null||A<g){y=E,g=A,b=_,v=j,S=pr(j?.relationshipKey),N=j?.relationshipName??"";return}if(A===g){const T=!!v?.indicatesParental;if(!!j?.indicatesParental&&!T){y=E,b=_,v=j,S=pr(j?.relationshipKey),N=j?.relationshipName??"";return}_.localeCompare(b)<0&&(y=E,b=_,v=j,S=pr(j?.relationshipKey),N=j?.relationshipName??"")}}),y!=null&&f.set(h,{parentId:y,relationshipKey:S,relationshipName:N,indicatesParental:!!v?.indicatesParental})}),s.forEach((p,h)=>{if(!p)return;const y=String(h);if(!y||f.has(y)||!Gd(p))return;const g=[p.parentId,p.data?.parentId,p.data?.sourceId,p.data?.source].map(S=>S!=null?String(S):null).filter(Boolean);let b=g.find(S=>s.has(S));!b&&g.length&&(b=g[0]);const v=n.get(y)??1/0;if(!b){const S=Array.isArray(p?.data?.containedIds)?p.data.containedIds.map(N=>N!=null?String(N):null).filter(N=>{if(!N||!s.has(N))return!1;const j=n.get(N);return typeof j=="number"&&Number.isFinite(j)&&j<v}):[];S.length&&(S.sort((N,j)=>{const E=n.get(N)??1/0,A=n.get(j)??1/0;return E===A?N.localeCompare(j):E-A}),b=S[0])}if(!b&&o&&s.has(o)&&(b=o===y?null:o),b){const S=[typeof p?.data?.relationshipType=="string"?p.data.relationshipType:null,typeof p?.relationshipType=="string"?p.relationshipType:null].filter(E=>typeof E=="string"&&E.trim()),N=S.length?S[0].trim():"",j=pr(N);f.set(y,{parentId:b,relationshipKey:j,relationshipName:N})}}),f}function Zy(e,n){if(!e||!n)return null;const s=e.get(n);return s?typeof s=="string"?{parentId:s,relationshipKey:"",relationshipName:""}:typeof s=="object"?{parentId:s?.parentId!=null?String(s.parentId):s?.sourceId!=null?String(s.sourceId):null,relationshipKey:pr(s?.relationshipKey),relationshipName:typeof s?.relationshipName=="string"?s.relationshipName:""}:null:null}function J8(e){return(n,s)=>{if(!n&&!s)return 0;if(!n)return 1;if(!s)return-1;const i=Zy(e,n.id),l=Zy(e,s.id),o=i?.relationshipKey||"",d=l?.relationshipKey||"";if(o&&d){const f=o.localeCompare(d);if(f!==0)return f}else{if(o)return-1;if(d)return 1}return j_(n,s)}}function ez(e,n=new Map){const s=new Map;let i=1/0;const l=0,o=Array.from(e.keys()).sort((h,y)=>h-y);let d=0;o.forEach(h=>{const y=e.get(h)||[];if(!y.length)return;const g=new Map,b=[];y.forEach(E=>{const A=Zy(n,E.id),M=A?.parentId??null,_=M?s.get(M):null;if(M&&_){const T=A?.relationshipKey||pr(A?.relationshipName)||"no-relationship";g.has(M)||g.set(M,{anchorX:_.x,relationshipGroups:new Map});const k=g.get(M);k.relationshipGroups.has(T)||k.relationshipGroups.set(T,[]),k.relationshipGroups.get(T).push(E)}else b.push(E)});const v=J8(n);g.forEach(E=>{E.relationshipGroups.forEach((A,M)=>{A.sort(v)})});const S=l+h*S_;let N=-1/0;if(Array.from(g.keys()).sort((E,A)=>{const M=g.get(E),_=g.get(A);return(M?.anchorX??0)-(_?.anchorX??0)}).forEach(E=>{const A=g.get(E);if(!A)return;const M=Array.from(A.relationshipGroups.keys()).sort(),_=[];if(M.forEach(C=>{const L=A.relationshipGroups.get(C)||[];_.push(...L)}),_.length===0)return;const T=(_.length-1)*dc,k=A.anchorX-T/2;_.forEach((C,L)=>{const z=k+L*dc;s.set(C.id,{x:z,y:S,level:h,levelIndex:d}),d+=1,z<i&&(i=z),z>N&&(N=z)})}),b.length){b.sort(j_);const E=(b.length-1)*dc,A=N!==-1/0?N+dc:-E/2;b.forEach((M,_)=>{const T=A+_*dc;s.set(M.id,{x:T,y:S,level:h,levelIndex:d}),d+=1,T<i&&(i=T),T>N&&(N=T)})}});const f=Number.isFinite(i)&&i<0?-i:0,p=new Map;return f>0?s.forEach((h,y)=>{p.set(y,{x:h.x+f,y:h.y,level:h.level,levelIndex:h.levelIndex})}):s.forEach((h,y)=>{p.set(y,h)}),p}function tz(e){return e?Xy.test(String(e)):!1}function E_(e){if(!e)return"";const n=e?.data?.relationshipType??e?.relationshipType??e?.data?.relationshipLabel??e?.relationshipLabel??e?.data?.label??e?.label??e?.data?.typeName??e?.typeName??"";if(typeof n=="string")return n.toLowerCase().trim();if(n&&typeof n=="object"){const s=n?.label??n?.name??n?.from_label??n?.to_label??"";if(typeof s=="string")return s.toLowerCase().trim()}return""}function nz(e){if(!e)return"";const n=e?.data?.relationshipType??e?.relationshipType??e?.data?.relationshipLabel??e?.relationshipLabel??e?.data?.label??e?.label??e?.data?.typeName??e?.typeName??"";if(typeof n=="string")return n.trim();if(n&&typeof n=="object"){const s=n?.label??n?.name??n?.from_label??n?.to_label??"";if(typeof s=="string")return s.trim()}return""}function pr(e){if(typeof e=="string"){const n=e.trim();return n?n.toLowerCase():""}return""}function az(e,n){const s=new Map;if(!e)return s;const i=String(e);s.set(i,0);const l=new Map,o=new Map;n.forEach(y=>{if(!y)return;const g=y?.parentId??y?.data?.parentId??y?.source??null,b=y?.childId??y?.data?.childId??y?.target??null,v=g!=null?String(g):null,S=b!=null?String(b):null;!v||!S||v===S||(l.has(v)||l.set(v,new Set),l.get(v).add(S),o.has(S)||o.set(S,new Set),o.get(S).add(v))});const d=[i],f=new Set([i]),p=1e4;let h=0;for(;d.length&&h<p;){h+=1;const y=d.shift();if(!y)continue;f.has(y)||f.add(y);const g=s.get(y)??0,b=o.get(y);b&&b.forEach(S=>{const N=S!=null?String(S):null;if(!N||f.has(N))return;const j=g-1,E=s.get(N);(E==null||j<E)&&(s.set(N,j),f.add(N),d.push(N))});const v=l.get(y);v&&v.forEach(S=>{const N=S!=null?String(S):null;if(!N||f.has(N))return;const j=g+1,E=s.get(N);(E==null||j<E)&&(s.set(N,j),f.add(N),d.push(N))})}return h>=p&&console.warn(`buildLevelsFromEdges: Reached maximum iteration limit (${p}), possible circular relationship detected`),s}function Nc(e,n,s){const i=Array.isArray(e)?e.map(_=>({..._,id:String(_.id),data:{..._.data}})):[];if(!i.length)return e;const l=i.filter(_=>Gd(_)),o=i.filter(_=>!Gd(_)),d=o.filter(_=>!_.inCluster),f=d.length?d:o,p=new Map;f.forEach(_=>p.set(_.id,_)),l.forEach(_=>p.set(_.id,_));const h=Array.from(p.values());if(!h.length)return e;const y=s!=null?String(s):h[0]?.id??null;if(!y)return e;const g=new Set(h.map(_=>_.id)),v=(Array.isArray(n)?n.map((_,T)=>{if(!_)return null;const k=_?.source!=null?String(_.source):"",C=_?.target!=null?String(_.target):"";if(!k||!C||k===C)return null;const L=_?.data?.relationshipType||_?.data?.typeName||_?.label||"",z=_?.data?.parentId??_?.parentId??_?.data?.parent??null,G=_?.data?.childId??_?.childId??null,U=z!=null?String(z):null,X=G!=null?String(G):null;return{id:_?.id!=null?String(_.id):`edge-${T}`,source:k,target:C,label:_?.label||L||sa,data:{relationshipType:L||sa,parentId:U,childId:X},parentId:U,childId:X}}).filter(Boolean):[]).map(_=>{if(!_)return null;const T={..._,data:{..._.data||{}}},k=T.source||"",C=T.target||"";if(!k||!C||k===C)return null;let L=T.parentId!=null?String(T.parentId):null,z=T.childId!=null?String(T.childId):null;if(!L||!z){let G=k,U=C;const X=E_(T),V=X&&w_.test(X);if(X&&P8.test(X)&&!V){const B=G;G=U,U=B}L=L??G,z=z??U}return(!L||!z||L===z)&&(L=k,z=C),T.source=L,T.target=z,T.parentId=L,T.childId=z,T.data={...T.data,parentId:L,childId:z},T}).filter(Boolean).filter(_=>g.has(_.source)&&g.has(_.target)),S=az(y,v);K8(S,h,y),h.forEach(_=>{if(!_||!Gd(_))return;const T=_.parentId??_.data?.parentId??_.data?.sourceId??_.data?.source??null;if(!T)return;const k=String(T),C=S.get(k)??0;S.set(_.id,C+1)});const{groups:N,visualLevels:j}=Z8(S,h),E=new Map(h.map(_=>[_.id,_])),A=Q8(v,S,E,{centerId:y}),M=ez(N,A);return i.map(_=>{const T=S.get(_.id)??0,k=j.get(_.id)??T,C={x:_?.position?.x??0,y:k*S_,level:k,levelIndex:_?.data?.levelIndex??0},L=M.get(_.id)||C;return{..._,position:{x:L.x,y:L.y},data:{..._.data,level:T,visualLevel:L.level??k,levelIndex:L.levelIndex}}})}function sz(e){return String(e??"group").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")}function rz(e){return Array.from(e.values()).map(n=>({id:n.id,name:n.name,typeName:n.typeName,isExpandedProtected:!!n.isExpandedProtected}))}function iz(e){const n=new Map;return Array.isArray(e)&&e.forEach(s=>{if(!s||s.isClusterEdge||s?.data?.isClusterEdge||s?.data?.isClusterChildEdge)return;const i=s?.parentId??s?.source??null,l=s?.childId??s?.target??null;if(i==null||l==null)return;const o=String(i),d=String(l);d&&(n.has(d)||n.set(d,new Set),n.get(d).add(o))}),n}function lz({centerId:e=null,parentLookup:n=new Map,suppressedIds:s=new Set,candidateIds:i=new Set,alwaysIncludeIds:l=new Set}){const o=new Map,d=e!=null?String(e):null,f=new Set(l instanceof Set?Array.from(l).map(String):Array.isArray(l)?l.map(h=>String(h)):[]);function p(h,y=new Set){const g=String(h);if(!g)return!1;if(o.has(g))return o.get(g);if(s.has(g)||!i.has(g)&&!f.has(g))return o.set(g,!1),!1;if(d&&g===d||f.has(g))return o.set(g,!0),!0;const b=n.get(g);if(!b||b.size===0)return o.set(g,!0),!0;if(y.has(g))return o.set(g,!1),!1;y.add(g);let v=!1;for(const S of b){const N=String(S);if(N&&!s.has(N)){if(!i.has(N)&&!f.has(N)){v=!0;continue}if(f.has(N)){v=!0;continue}p(N,y)&&(v=!0)}}return y.delete(g),v?(o.set(g,!0),!0):(o.set(g,!1),!1)}return p}function oz(e,n,s=v_,i={}){const l=n!=null?String(n):null,o=Array.isArray(e?.nodes)?e.nodes:[],d=Array.isArray(e?.edges)?e.edges:[],f=new Map;if(o.forEach(K=>{const de=xN(K);de&&f.set(de.id,de)}),!l)return{nodes:[],edges:[],suppressedNodes:new Map,clusters:[]};if(!f.has(l)){const K=xN(o[0]);K?f.set(l,{...K,id:l}):f.set(l,{id:l,name:`Entity ${l}`,typeName:"Entity"})}const p=d.map(K=>N_(K,l)).filter(Boolean),h=Array.from(f.values()),y=i?.alwaysIncludeIds,g=new Set(y instanceof Set?Array.from(y).map(String):Array.isArray(y)?y.map(K=>String(K)):y&&typeof y=="object"?Object.values(y).map(K=>String(K)):[]),{clusters:b,suppressedNodes:v,edges:S}=G8(h,p,s,l),N=rz(f),j=v instanceof Map?v:new Map(Object.entries(v||{}).map(([K,de])=>[String(K),de])),E=new Map;j.forEach((K,de)=>{const Q=String(de),he=K?.clusterId!=null?String(K.clusterId):null,re=K?.parentId!=null?String(K.parentId):null,Ce=K?.relationshipType||sa,Re=K?.entity||f.get(Q)||null;E.set(Q,{clusterId:he,parentId:re,relationshipType:Ce,entity:Re?{...Re,id:Q,name:Sa(Re?.name,`Entity ${Q}`),typeName:Re?.typeName||Re?.type?.name||"Entity",isExpandedProtected:!!Re?.isExpandedProtected}:null})}),g.forEach(K=>{E.delete(String(K))});const A=new Set(Array.from(E.keys())),M=(Array.isArray(b)?b:[]).map(K=>X8(K,N)),T=h.map(K=>W8(K,{isCenter:K.id===l})).filter(K=>!A.has(String(K.id))),k=new Set(T.map(K=>String(K.id)));l!=null&&k.add(String(l)),g.forEach(K=>{k.add(String(K))});const C=iz(p),L=lz({centerId:l,parentLookup:C,suppressedIds:A,candidateIds:k,alwaysIncludeIds:g}),z=T.filter(K=>L(String(K.id))),G=new Set(z.map(K=>String(K.id))),X=[...z.filter(K=>{const de=String(K.id);if(!de)return!1;const Q=C.get(de);if(!Q||!Q.size)return!0;for(const he of Q){const re=he!=null?String(he):"";if(re&&G.has(re))return!0}return!1}),...M],V=new Set(X.map(K=>String(K.id))),R=p.filter(K=>{if(!K)return!1;const de=K.parentId!=null?K.parentId:K.source!=null?K.source:null;if(de==null)return!0;const Q=String(de);return!(!V.has(Q)||A.has(Q))}),D=(Array.isArray(S)&&S.length?S:R).filter(K=>{if(!K)return!1;if(K.isClusterEdge)return!0;const de=K.parentId!=null?K.parentId:K.source!=null?K.source:null;if(de!=null){const Re=String(de);if(!V.has(Re)||A.has(Re))return!1}const Q=K.source!=null?K.source:K.parentId!=null?K.parentId:null,he=K.target!=null?K.target:K.childId!=null?K.childId:null,re=Q!=null?String(Q):"",Ce=he!=null?String(he):"";return!(re&&A.has(re)||Ce&&A.has(Ce))}),O=new Set;D.forEach(K=>{const de=K.source!=null?String(K.source):K.parentId!=null?String(K.parentId):null,Q=K.target!=null?String(K.target):K.childId!=null?String(K.childId):null;de&&O.add(de),Q&&O.add(Q)}),l&&O.add(l);const $=X.filter(K=>O.has(String(K.id))),F=new Set(l!=null?[String(l)]:[]);let H=!0;for(;H;){H=!1;for(const K of D){if(!K)continue;const de=K.parentId!=null?K.parentId:K.source!=null?K.source:null,Q=K.childId!=null?K.childId:K.target!=null?K.target:null,he=de!=null?String(de):"",re=Q!=null?String(Q):"",Ce=!!he,Re=!!re;Ce&&F.has(he)&&Re&&!F.has(re)&&(F.add(re),H=!0),Re&&F.has(re)&&Ce&&!F.has(he)&&(F.add(he),H=!0)}}const I=$.filter(K=>F.has(String(K.id))),P=D.filter(K=>{const de=K.parentId!=null?String(K.parentId):String(K.source??""),Q=K.childId!=null?String(K.childId):String(K.target??"");return de&&Q&&F.has(de)&&F.has(Q)}).map(K=>({id:K.id,source:K.source,target:K.target,type:"smoothstep",animated:!K.isClusterEdge,label:K.label||K.relationshipLabel||sa,data:{relationshipType:K.relationshipLabel||K.label||sa,parentId:K.parentId??null,childId:K.childId??null,isClusterEdge:!!K.isClusterEdge},parentId:K.parentId??null,childId:K.childId??null,sourceHandle:"bottom",targetHandle:"top"})),W=Nc(I,P,l),le=W.filter(K=>K.type==="cluster");return{nodes:W,edges:P,suppressedNodes:E,clusters:le}}function cz(e,n,s=[]){if(!e||!n)return null;const i=e?.position?.x??0,l=e?.position?.y??0,o=e?.width??Kf,d=e?.height??ub,f=String(n.id),p=ao(n),h=Array.isArray(s)?s.map(E=>String(E)):[],y=h.indexOf(f),g=Math.max(h.length-1,0)*yf,b=i+o/2,v=b-g/2,S=Qc,N=y>=0?v+y*yf-S/2:b-S/2,j=l+d+db;return{id:f,type:"entity",position:{x:N,y:j},data:{label:Sa(n.name,`Entity ${f}`),typeName:n?.type?.name||n?.typeName||"Entity",isCenter:!1,isAdHoc:!0,entityId:f,imageUrl:p}}}function Md(e,n,s=[]){if(!n||!Array.isArray(s)||s.length===0)return e;const i=s.map(N=>String(N)),l=new Map(i.map((N,j)=>[N,j])),o=n?.position?.x??0,d=n?.position?.y??0,f=n?.width??Kf,p=n?.height??ub,h=d+p+db,y=(i.length-1)*yf,b=o+f/2-y/2;let v=!1;const S=e.map(N=>{if(N.type!=="entity"||!N.data?.isAdHoc)return N;const j=l.get(String(N.id));if(j==null)return N;const E=N?.width??Qc,A=b+j*yf-E/2,M=h;return N?.position?.x===A&&N?.position?.y===M?N:(v=!0,{...N,position:{x:A,y:M}})});return v?S:e}function uz(e,n){return N_(e,n)}function __({onRefocus:e,onZoomToFit:n,onAutoArrange:s,depth:i,onIncreaseDepth:l,onDecreaseDepth:o,style:d}){return t.jsxs("div",{className:`relationship-toolbar ${d?.compact?"relationship-toolbar--compact":""}`,role:"toolbar","aria-label":"Relationship viewer controls",style:d,children:[t.jsxs("div",{className:"relationship-toolbar__actions",children:[t.jsxs("button",{type:"button",className:"relationship-toolbar__button",onClick:e,children:[t.jsx(pg,{"aria-hidden":"true"}),t.jsx("span",{children:"Refocus"})]}),t.jsxs("button",{type:"button",className:"relationship-toolbar__button",onClick:n,children:[t.jsx(fk,{"aria-hidden":"true"}),t.jsx("span",{children:"Zoom to fit"})]}),t.jsxs("button",{type:"button",className:"relationship-toolbar__button",onClick:s,children:[t.jsx(aR,{"aria-hidden":"true"}),t.jsx("span",{children:"Auto arrange"})]})]}),t.jsxs("div",{className:"relationship-toolbar__levels","aria-label":"Relationship depth controls",children:[t.jsx("span",{className:"relationship-toolbar__levels-label",children:"Levels"}),t.jsxs("div",{className:"relationship-toolbar__levels-controls",children:[t.jsx("button",{type:"button",className:"relationship-toolbar__levels-button",onClick:l,disabled:i>=3,"aria-label":"Increase relationship depth",children:t.jsx(Wn,{"aria-hidden":"true"})}),t.jsx("span",{className:"relationship-toolbar__levels-value","aria-live":"polite",children:i}),t.jsx("button",{type:"button",className:"relationship-toolbar__levels-button",onClick:o,disabled:i<=1,"aria-label":"Decrease relationship depth",children:t.jsx(hg,{"aria-hidden":"true"})})]})]})]})}__.propTypes={onRefocus:It.func.isRequired,onZoomToFit:It.func.isRequired,onAutoArrange:It.func.isRequired,depth:It.number.isRequired,onIncreaseDepth:It.func.isRequired,onDecreaseDepth:It.func.isRequired};function dz({id:e,source:n,target:s,data:i,markerEnd:l,style:o,selected:d}){const{getNode:f}=Xf(),p=f(n),h=f(s);if(!p||!h)return null;const y=p.width??200,g=p.height??80,b=h.width??200;h.height;const v=p.positionAbsolute?.x??p.position?.x??0,S=p.positionAbsolute?.y??p.position?.y??0,N=h.positionAbsolute?.x??h.position?.x??0,j=h.positionAbsolute?.y??h.position?.y??0,E=v+y/2,A=S+g,M=N+b/2,_=j,[T]=hf({sourceX:E,sourceY:A,sourcePosition:"bottom",targetX:M,targetY:_,targetPosition:"top"}),k=-18,C=M,L=_+k,z=i?.relationshipType||i?.label||"Related";return t.jsxs(t.Fragment,{children:[t.jsx(ro,{id:e,path:T,markerEnd:l,style:o,selected:d}),t.jsx(h8,{children:t.jsx("div",{style:{position:"absolute",transform:`translate(-50%, -50%) translate(${C}px,${L}px)`,fontSize:12,pointerEvents:"all",background:"rgba(255, 255, 255, 0.9)",padding:"2px 6px",borderRadius:"4px",border:"1px solid #e2e8f0",boxShadow:"0 1px 2px rgba(0, 0, 0, 0.1)",whiteSpace:"nowrap",zIndex:10},className:"nodrag nopan",children:z})})]})}const fz={cluster:z8,entity:B8},mz={smoothstep:dz},hz="Related";function pz(e){const n=new Map;return Array.isArray(e)&&e.forEach(s=>{if(!s)return;const i=s?.parentId!=null?s.parentId:s?.source!=null?s.source:null,l=s?.childId!=null?s.childId:s?.target!=null?s.target:null;if(i==null||l==null)return;const o=String(i),d=String(l);!o||!d||o===d||(n.has(o)||n.set(o,[]),n.get(o).push(s))}),n}function yz(e,n){const s=new Map;if(!e)return s;const i=String(e);if(!i)return s;s.set(i,0);const l=[i],o=new Set([i]),d=1e4;let f=0;for(;l.length&&f<d;){f+=1;const p=l.shift();if(!p)continue;const h=s.get(p)??0,y=n.get(p);!y||!y.length||y.forEach(g=>{if(!g)return;const b=g?.childId!=null?g.childId:g?.target!=null?g.target:null,v=b!=null?String(b):null;!v||o.has(v)||v===p||(s.set(v,h+1),o.add(v),l.push(v))})}return f>=d&&console.warn(`computeDepthLookup: Reached maximum iteration limit (${d}), possible circular relationship detected`),s}function gz(e){const n=new Map;return Array.isArray(e)&&e.forEach(s=>{if(!s)return;const i=s?.parentId!=null?s.parentId:s?.source!=null?s.source:null,l=s?.childId!=null?s.childId:s?.target!=null?s.target:null;if(i==null||l==null)return;const o=String(i),d=String(l);!o||!d||o===d||(n.has(d)||n.set(d,new Set),n.get(d).add(o))}),n}function bz(e,n,s=null){const i=e!=null?String(e):null;if(!i)return new Set;const l=gz(n);if(!l.size)return new Set;const o=new Set,d=[],f=new Map,p=l.get(i);for(p&&p.size&&p.forEach(h=>{const y=String(h);y&&(o.add(y),d.push(y),f.set(y,1))});d.length;){const h=d.shift();if(!h)continue;const y=f.get(h)??1;if(s!=null&&y>=s)continue;const g=l.get(h);!g||!g.size||g.forEach(b=>{const v=String(b);if(!v||v===h||o.has(v))return;const S=y+1;s!=null&&S>s||(o.add(v),f.set(v,S),d.push(v))})}return o}function vN(e){if(!e)return null;const n=e?.parentId!=null?e.parentId:e?.source!=null?e.source:null,s=e?.childId!=null?e.childId:e?.target!=null?e.target:null,i=n!=null?String(n):null,l=s!=null?String(s):null;if(!i||!l||i===l)return null;const o=e?.relationshipLabel||e?.label||e?.typeName||hz;return{id:e?.id!=null&&e.id!==""?String(e.id):`edge-${i}-${l}`,source:i,target:l,type:"smoothstep",animated:!e?.isClusterEdge,label:o,data:{relationshipType:o,parentId:i,childId:l,isClusterEdge:!!e?.isClusterEdge},parentId:i,childId:l,sourceHandle:"bottom",targetHandle:"top"}}function xz(){const{entityId:e}=Ka(),n=_n(),[s,i]=u.useState(!0),[l,o]=u.useState(null),[d,f]=u.useState([]),[p,h]=u.useState([]),[y,g]=u.useState({}),[b,v]=u.useState(null),[S,N]=u.useState(1),j=u.useRef(null),E=u.useRef(null),[A,M]=u.useState(null),[_,T]=u.useState(null),[k,C]=u.useState(null),[L,z]=u.useState(!1),[G,U]=u.useState([]),[X,V]=u.useState([]),R=u.useRef(new Map),B=u.useRef(new Map),D=u.useRef(new Map),O=u.useRef(new Set),$=u.useRef([]),F=u.useRef([]),H=u.useRef([]),I=u.useRef(new Map),Y=u.useRef(new Set),P=u.useRef(null),W=u.useRef(new Map),le=u.useRef(new Map),K=u.useRef(null),de=u.useMemo(()=>fz,[]),Q=u.useMemo(()=>mz,[]),he=u.useCallback(ie=>{if(!Array.isArray(ie)||!ie.length)return ie;const ee=I.current;if(!(ee instanceof Map)||!ee.size)return ie;let ce=!1;const fe=ie.map(qe=>{if(!qe||!(qe.type==="entity"||qe.type==="cluster"))return qe;const Be=ee.get(String(qe.id));return Be?(ce=!0,{...qe,position:{x:Be.x,y:Be.y},positionAbsolute:{x:Be.x,y:Be.y}}):qe});return ce?fe:ie},[]);u.useEffect(()=>{$.current=d},[d]),u.useEffect(()=>{F.current=p},[p]),u.useEffect(()=>()=>{K.current!=null&&(clearTimeout(K.current),K.current=null)},[]),u.useEffect(()=>{const ie=e!=null?String(e):null;if(ie&&P.current!==ie){P.current=ie,I.current=new Map,Y.current=new Set,g({});return}ie||(P.current=null,I.current=new Map,Y.current=new Set,g({}))},[e]),u.useEffect(()=>{if(!A){T(null),C(null),z(!1),U([]),V([]);return}let ie=!1;return(async()=>{z(!0),C(null),T(null);try{const ce=await Hs(A);if(ie)return;const fe=Ya(ce);T(fe||null)}catch(ce){if(ie)return;console.error("Failed to load entity info:",ce),T(null),C(ce.message||"Failed to load entity info")}finally{ie||z(!1)}})(),()=>{ie=!0}},[A]);const re=u.useMemo(()=>_&&(_.entity_type_id||_.entityType?.id||_.entity_type?.id)||null,[_]);u.useEffect(()=>{if(!re){U([]),V([]);return}let ie=!1;return(async()=>{try{const[ce,fe]=await Promise.all([If(re).catch(qe=>(console.error(" Failed to load drawer field order",qe),null)),Lf(re).catch(qe=>(console.error(" Failed to load drawer field rules",qe),null))]);if(ie)return;U(ii(ce)),V(ii(fe))}catch(ce){if(ie)return;console.error(" Failed to load drawer field layout",ce),U([]),V([])}})(),()=>{ie=!0}},[re]);const Ce=u.useCallback(ie=>f(ee=>ob(ie,ee)),[]),Re=u.useCallback(ie=>h(ee=>QE(ie,ee)),[]),ue=u.useCallback(ie=>{ie&&n(`/entities/${ie}/relationship-viewer`)},[n]),se=u.useCallback(ie=>{if(!ie)return;const ee=String(ie);M(ce=>ce===ee?ce:ee)},[]),Le=u.useCallback(()=>{M(null),T(null),C(null),z(!1)},[]),be=u.useCallback(ie=>{ie&&O.current.delete(String(ie))},[]),De=u.useCallback(ie=>{ie&&O.current.add(String(ie))},[]),Me=u.useCallback(ie=>{if(!ie)return new Map;const ee=String(ie),ce=Array.isArray(F.current)?F.current:[],fe=new Map,qe=[ee],Pe=new Set;for(;qe.length;){const Be=qe.pop();!Be||Pe.has(Be)||(Pe.add(Be),ce.forEach(Te=>{if(!Te||Te?.data?.isClusterEdge||Te?.data?.isClusterChildEdge)return;const gt=Te?.parentId??Te?.data?.parentId??Te?.source??null,jt=Te?.childId??Te?.data?.childId??Te?.target??null;if(gt==null||jt==null)return;const Mt=String(gt);if(Mt!==Be)return;const tt=String(jt);if(!(!tt||tt===ee)){if(!fe.has(tt)){const ft=Te?.data?.relationshipType||Te?.relationshipLabel||Te?.label||"Related";fe.set(tt,{parentId:Mt,relationshipType:ft})}Pe.has(tt)||qe.push(tt)}}))}return fe},[]),mt=u.useCallback((ie,ee)=>{if(ie==null||ee==null)return;const ce=String(ie);if(!ce)return;const fe=le.current instanceof Map?le.current:null;!fe||Y.current.has(ce)&&fe.has(ce)||fe.set(ce,ee)},[]),ht=u.useCallback((ie,ee)=>{if(!ie)return;const ce=String(typeof ie=="string"?ie:ie?.id??ie?.data?.id??ie);if(!ce)return;const fe=$.current.find(pe=>String(pe.id)===ce&&pe.type==="cluster");if(!fe)return;const qe=Y.current,Be=H.current.find(pe=>String(pe.id)===ce)||{id:ce,relationshipType:fe?.data?.relationshipType||fe?.data?.label||"Related",label:fe?.data?.label||fe?.data?.relationshipType||"Related",containedIds:(fe?.data?.containedIds||[]).map(pe=>String(pe)).filter(pe=>!qe.has(pe)),parentId:fe?.data?.sourceId!=null?String(fe.data.sourceId):null},Te=R.current,gt=D.current,jt=B.current;if(!(Te instanceof Map)||!(gt instanceof Map))return;const Mt=ee??(typeof ie=="object"&&ie?.entityId!=null?ie.entityId:null),tt=Mt!=null?String(Mt):null;if(tt&&qe.has(tt))return;const ft=new Map;Array.isArray($.current)&&$.current.forEach(pe=>{if(!pe||pe.type&&pe.type!=="entity")return;const Ue=String(pe.id);Ue&&ft.set(Ue,pe)}),gt instanceof Map&&gt.forEach((pe,Ue)=>{if(!pe)return;const ae=String(Ue);ae&&ft.set(ae,pe)}),(Array.isArray(fe?.data?.allNodes)?fe.data.allNodes:[]).forEach(pe=>{if(!pe||pe?.type&&pe.type!=="entity")return;const Ue=pe?.id!=null?String(pe.id):null;if(!Ue||ft.has(Ue))return;const ae=pe?.data||{},Ke=ae?.label||pe?.name||ae?.name||`Entity ${Ue}`,ot={id:Ue,type:pe?.type||"entity",position:pe?.position||{x:0,y:0},data:{...ae,label:Sa(Ke,`Entity ${Ue}`),typeName:ae?.typeName||ae?.type?.name||pe?.typeName||pe?.type&&pe?.type.name||"Entity",entityId:ae?.entityId!=null?String(ae.entityId):Ue,isAdHoc:ae?.isAdHoc!=null?!!ae.isAdHoc:!0,isExpandedProtected:!!ae?.isExpandedProtected}};ft.set(Ue,ot)});let Ft=tt?[tt].filter(pe=>Te.has(pe)):[];if(Ft.length===0&&tt&&(Ft=[String(tt)]),!Ft.length)if(tt){const pe=String(tt);Te.delete(pe),gt.delete(pe),jt instanceof Map&&jt.delete(pe),Y.current.add(pe)}else{be(ce);return}const Zt=Ft.map(pe=>{const Ue=String(pe);return{id:Ue,definition:gt.get(Ue)||ft.get(Ue)||null,meta:jt.get(Ue)||Te.get(Ue)||null}}).filter(pe=>{if(!pe?.definition)return!1;const Ue=pe?.id!=null?String(pe.id):null;return Ue?!qe.has(Ue):!1});if(!Zt.length){tt||be(ce);return}const Tt=Be.parentId!=null?String(Be.parentId):null,We=new Set($.current.map(pe=>String(pe.id))),it=Zt.filter(({id:pe,meta:Ue})=>{const ae=pe!=null?String(pe):null;if(ae&&qe.has(ae))return!1;const Ke=Ue?.parentId!=null?String(Ue.parentId):Tt;return Tt&&Ke!==Tt?!1:Ke?Te.has(Ke)?!1:We.has(Ke):!0});if(!it.length)return;it.forEach(({id:pe})=>{const Ue=String(pe);Ue&&qe.add(Ue)});const bt=Be.relationshipType||Be.label||"Related",oe=[...F.current];it.forEach(({id:pe})=>{Te.delete(String(pe))});const Ee=[],Se=[],Ve=W.current instanceof Map?W.current:new Map,xe=le.current instanceof Map?le.current:new Map,$e=Number.isFinite(Number(S))?Number(S):null;if(Ve.size){const pe=B.current instanceof Map?B.current:new Map,Ue=new Set(Array.isArray($.current)?$.current.map(ct=>String(ct.id)):[]),ae=new Set,Ke=new Set;it.forEach(({id:ct})=>{if(!ct)return;const Nt=String(ct);Ue.add(Nt),ae.add(Nt)});const ot=it.map(({id:ct})=>String(ct)),St=new Set,me=new Set,nt=new Set,Ge=1e4;let vt=0;if(!(xe instanceof Map)){console.warn("Depth lookup not properly initialized, skipping relationship extension");return}try{for(;ot.length&&vt<Ge;){vt+=1;const ct=ot.shift();if(!ct||St.has(ct))continue;if(nt.has(ct)){console.warn(`Circular reference detected for entity ${ct}, skipping`);continue}St.add(ct),nt.add(ct);const Nt=typeof xe.get=="function"?xe.get(ct)??0:0;if($e!=null&&Nt!=null&&Number.isFinite(Nt)&&Nt>=$e){nt.delete(ct);continue}if(!(Ve instanceof Map)||typeof Ve.get!="function"){nt.delete(ct);continue}const Ye=Ve.get(ct);if(!Array.isArray(Ye)||!Ye.length){nt.delete(ct);continue}Ye.forEach(Je=>{if(Je)try{const Et=Je?.childId!=null?Je.childId:Je?.target!=null?Je.target:null,te=Et!=null?String(Et):null;if(!te||te===ct)return;const ve=Number.isFinite(Nt)?Nt+1:1;if($e!=null&&Number.isFinite($e)&&ve>$e)return;if(Ue.has(te))mt(te,ve),ae.has(te)&&!St.has(te)&&!nt.has(te)&&ot.push(te);else if(!Ke.has(te)){let Ie=null;if(Te.has(te)){if(!(gt instanceof Map)||typeof gt.get!="function")return;const rt=gt.get(te);if(!rt)return;Te.delete(te),gt.delete(te),pe instanceof Map&&pe.delete(te),qe.add(te),Ie=rt}else{if(!(ft instanceof Map)||typeof ft.get!="function")return;const rt=ft.get(te);if(!rt)return;const _t=rt?.data?.label||rt?.data?.name||`Entity ${te}`;Ie={...rt,id:String(te),type:rt.type||"entity",position:rt.position||{x:0,y:0},data:{...rt?.data||{},label:Sa(_t,`Entity ${te}`),typeName:rt?.data?.typeName||rt?.data?.type?.name||"Entity",entityId:rt?.data?.entityId!=null?String(rt.data.entityId):String(te),isAdHoc:rt?.data?.isAdHoc!=null?!!rt.data.isAdHoc:!0,isExpandedProtected:!!rt?.data?.isExpandedProtected}}}Ie&&(Ee.push({id:te,definition:Ie}),Ke.add(te),Ue.add(te),ae.add(te),!St.has(te)&&!nt.has(te)&&ot.push(te),mt(te,ve),ft.set(te,Ie))}mt(te,ve);try{const Ie=vN(Je);Ie&&!me.has(Ie.id)&&(me.add(Ie.id),Se.push(Ie))}catch(Ie){console.warn("Failed to convert edge to ReactFlow format:",Ie)}}catch(Et){console.warn(`Error processing edge for entity ${ct}:`,Et)}}),nt.delete(ct)}vt>=Ge&&console.warn(`Relationship extension reached maximum iteration limit (${Ge}), stopping to prevent infinite loop`)}catch(ct){console.error("Error during relationship extension traversal:",ct)}if(Se.length){const ct=new Set(oe.map(Nt=>Nt.id));Se.forEach(Nt=>{!Nt||ct.has(Nt.id)||(ct.add(Nt.id),oe.push(Nt))})}}const He=Be.containedIds.filter(pe=>{const Ue=String(pe);return qe.has(Ue)?!1:Te.has(Ue)});g(pe=>{const Ue={...pe};let ae=!1;return it.forEach(({id:Ke})=>{Ue[Ke]||(Ue[Ke]={clusterId:Be.id,relationshipType:Be.relationshipType||null,sourceId:Be.parentId||null},ae=!0)}),ae?Ue:pe}),Se.length&&h(pe=>{const Ue=new Set(pe.map(Ke=>Ke.id)),ae=Se.filter(Ke=>!Ue.has(Ke.id));return ae.length?[...pe,...ae]:pe}),f(pe=>{const Ue=pe.find(ct=>String(ct.id)===ce&&ct.type==="cluster");if(!Ue)return pe;const ae=new Set(pe.map(ct=>String(ct.id)));let Ke=pe,ot=!1;const St=new Set((Ue.data?.placedEntityIds||[]).map(ct=>String(ct)));it.forEach(({id:ct,definition:Nt,meta:Ye})=>{const Je=String(ct);if(St.add(Je),ae.has(Je))return;const Et=Ye?.entity||{id:ct,name:Nt?.data?.label||`Entity ${ct}`,typeName:Nt?.data?.typeName||Nt?.data?.type?.name||"Entity",isExpandedProtected:!!Nt?.data?.isExpandedProtected},te=cz(Ue,Et,Array.from(St))||Nt;if(!te)return;const ve=Sa(te.data?.label,`Entity ${ct}`),Ie=Sa(Et?.name,ve),rt={...te,id:String(ct),type:"entity",data:{...te.data,label:Ie,typeName:Et?.typeName||te.data?.typeName||"Entity",entityId:String(ct),isAdHoc:!0,onSetTarget:ue,onOpenInfo:se,isExpandedProtected:!!Et?.isExpandedProtected}};ae.add(Je),ot=!0,Ke=[...Ke,rt];const _t=`cluster-context-${ce}-${Je}`;if(!F.current.find(nn=>nn.id===_t)){const nn={id:_t,source:ce,target:Je,type:"smoothstep",animated:!1,label:"",style:{stroke:"#bbb",strokeDasharray:"4 2"},data:{isClusterContext:!0,parentId:ce,childId:Je},sourceHandle:"bottom",targetHandle:"top"};F.current.push(nn),h(Pt=>[...Pt,nn])}}),Ee.forEach(({id:ct,definition:Nt})=>{if(!ct||ae.has(String(ct)))return;const Ye={...Nt,id:String(ct),type:"entity",data:{...Nt?.data,label:Nt?.data?.label||Nt?.data?.name||`Entity ${ct}`,typeName:Nt?.data?.typeName||Nt?.data?.type?.name||"Entity",entityId:String(ct),isAdHoc:!0,onSetTarget:ue,onOpenInfo:se,isExpandedProtected:!!Nt?.data?.isExpandedProtected}};ae.add(String(ct)),ot=!0,Ke=[...Ke,Ye]});const me=Array.from(St),nt=`${bt} (${He.length})`;let Ge=Ke.map(ct=>String(ct.id)!==ce||ct.type!=="cluster"?ct:{...ct,data:{...ct.data,placedEntityIds:me,manuallyReleasedIds:me,label:nt}});const vt=Ge.find(ct=>String(ct.id)===ce&&ct.type==="cluster")||Ue;return Ge=Md(Ge,vt,me),!ot&&!pe.some(Nt=>String(Nt.id)!==ce||Nt.type!=="cluster"?!1:Nt.data?.label!==nt)?pe:he(Nc(Ge,oe))});const J=`${bt} (${He.length})`;Be.label=J,H.current=H.current.map(pe=>String(pe.id)===ce?{...pe,label:J}:pe);const Z=pe=>{if(!Array.isArray(pe)||!pe.length)return[];const Ue=W.current instanceof Map?W.current:new Map,ae=le.current instanceof Map?le.current:new Map,Ke=Y.current,ot=R.current instanceof Map?R.current:null,St=D.current instanceof Map?D.current:null,me=B.current instanceof Map?B.current:null;if(!St)return[];const nt=Number.isFinite(Number(S))?Number(S):null,Ge=new Set(F.current.map(Je=>String(Je.id))),vt=[],ct=[],Nt=new Map,Ye=new Set;if(pe.forEach(Je=>{const Et=Je!=null?String(Je):null;if(!Et||!(Ue instanceof Map)||typeof Ue.get!="function"||!(ae instanceof Map)||typeof ae.get!="function")return;const te=Ue.get(Et)||[];if(!Array.isArray(te))return;const ve=ae.get(Et),Ie=Number.isFinite(ve)?ve+1:null;te.forEach(rt=>{if(rt)try{const _t=rt?.childId!=null?rt.childId:rt?.target!=null?rt.target:null,Lt=_t!=null?String(_t):null;if(!Lt||Lt===Et||Ke.has(Lt))return;try{const ha=vN(rt);ha&&!Ge.has(ha.id)&&(Ge.add(ha.id),vt.push(ha))}catch(ha){console.warn(`Failed to convert edge to ReactFlow format for parent ${Et}:`,ha)}if(!(nt==null||Ie!=null&&Ie<=nt)||!(St instanceof Map)||typeof St.has!="function"||!St.has(Lt))return;const Pt=St.get(Lt);if(!Pt)return;const zt=me&&me.get(Lt)||ot&&ot.get(Lt)||null;St.delete(Lt),ot&&ot.delete(Lt),me&&me.delete(Lt);const Ut=Ke.has(Lt);Ke.add(Lt),Ie!=null&&(!Ut||!(ae instanceof Map)||!ae.has(Lt))&&mt(Lt,Ie);const dn=zt?.entity||null,Un=Sa(Pt?.data?.label,Sa(Pt?.data?.name,`Entity ${Lt}`)),yn=Sa(dn?.name,Un),ja={...Pt,id:Lt,type:"entity",data:{...Pt?.data,label:yn,typeName:dn?.typeName||Pt?.data?.typeName||Pt?.data?.type?.name||"Entity",entityId:Lt,isAdHoc:!0,onSetTarget:ue,onOpenInfo:se,isExpandedProtected:!!(dn?.isExpandedProtected??Pt?.data?.isExpandedProtected)}};ct.push(ja),Ye.add(Lt),zt?.clusterId&&Nt.set(Lt,{clusterId:String(zt.clusterId),relationshipType:zt?.relationshipType||null,sourceId:zt?.parentId!=null?String(zt.parentId):null})}catch(_t){console.warn(`Error processing edge for parent ${Et} child ${childId}:`,_t)}})}),vt.length){const Je=vt.filter(Boolean);Je.length&&(F.current=[...F.current,...Je],h(Et=>[...Et,...Je]))}return ct.length&&f(Je=>{const Et=new Set(Je.map(rt=>String(rt.id))),te=ct.filter(rt=>{const _t=rt?.id!=null?String(rt.id):null;return!_t||Et.has(_t)?!1:(Et.add(_t),!0)});if(!te.length)return Je;const ve=[...Je,...te],Ie=Nc(ve,F.current);return he(Ie)}),Nt.size&&g(Je=>{const Et={...Je};let te=!1;return Nt.forEach((ve,Ie)=>{const rt=Et[Ie];(!rt||rt.clusterId!==ve.clusterId||rt.relationshipType!==ve.relationshipType||rt.sourceId!==ve.sourceId)&&(Et[Ie]=ve,te=!0)}),te?Et:Je}),Array.from(Ye)},je=new Set,Ne=[...it.map(({id:pe})=>String(pe)),...Ee.map(({id:pe})=>String(pe))].filter(Boolean);for(;Ne.length;){const pe=[];for(;Ne.length;){const ae=Ne.shift();!ae||je.has(ae)||pe.push(ae)}if(!pe.length)break;const Ue=Z(pe);pe.forEach(ae=>je.add(ae)),Ue.forEach(ae=>{je.has(ae)||Ne.push(ae)})}},[he,se,ue,mt,be,S]),Ct=u.useCallback((ie,ee)=>{if(!ie||!ee)return;const ce=String(ee.id),fe=String(ie.id);if(ee?.isExpandedProtected||$.current.some(Tt=>String(Tt?.id)===ce&&Tt?.data?.isExpandedProtected))return;const Pe=new Map($.current.map(Tt=>[String(Tt.id),Tt])),Be=Me(ce),gt=Array.from(Be.entries()).map(([Tt])=>String(Tt)).filter(Tt=>{if(Tt===ce)return!1;const We=Pe.get(Tt);return!(!We||We?.data?.isExpandedProtected)}),jt=new Set(gt);Y.current.delete(ce),I.current.delete(ce),gt.forEach(Tt=>{Y.current.delete(String(Tt)),I.current.delete(String(Tt))}),g(Tt=>{const We={...Tt};let it=!1;return We[ce]&&(delete We[ce],it=!0),gt.forEach(bt=>{We[bt]&&(delete We[bt],it=!0)}),it?We:Tt});let Mt=[];f(Tt=>{const We=Tt.find(Se=>Se.id===ie.id);let bt=Tt.filter(Se=>{const Ve=String(Se.id);return Ve===ce&&Se.type==="entity"?!Se.data?.isAdHoc:jt.has(Ve)&&Se.type==="entity"?!!Se.data?.isExpandedProtected:!0}).map(Se=>{if(Se.id!==ie.id||Se.type!=="cluster")return Se;const Ve=new Set((Se.data?.placedEntityIds||[]).map(String));return Ve.has(ce)?(Ve.delete(ce),{...Se,data:{...Se.data,placedEntityIds:Array.from(Ve),manuallyReleasedIds:Array.from(Ve)}}):Se});const oe=bt.find(Se=>Se.id===ie.id&&Se.type==="cluster"),Ee=oe?.data?.placedEntityIds?.map(Se=>String(Se))||[];return Mt=Ee,he(Md(bt,oe||We,Ee))}),h(Tt=>{const We=new Set([ce,...gt]);return Tt.filter(it=>{const bt=it?.source!=null?String(it.source):it?.parentId!=null?String(it.parentId):null,oe=it?.target!=null?String(it.target):it?.childId!=null?String(it.childId):null;return!(bt&&We.has(bt)||oe&&We.has(oe))})});const tt=ie.relationshipType||ie.label||"Related",ft=Sa(ee?.name,`Entity ${ce}`),Rt={clusterId:fe,parentId:ie.sourceId?String(ie.sourceId):null,relationshipType:tt,entity:{id:ce,name:ft,typeName:ee?.typeName||ee?.type?.name||"Entity",type:ee?.type}};R.current.set(ce,Rt),B.current.set(ce,Rt),D.current.set(ce,{id:ce,type:"entity",position:{x:0,y:0},data:{label:ft,typeName:ee?.typeName||ee?.type?.name||"Entity",entityId:ce,isAdHoc:!0,isExpandedProtected:!!ee?.isExpandedProtected}});const Ft=H.current.find(Tt=>Tt.id===fe);if(Ft){const Tt=Y.current,We=ie.containedIds.filter(bt=>{const oe=String(bt);return Tt.has(oe)?!1:R.current.has(oe)}),it=`${Ft.relationshipType||ie.relationshipType||"Related"} (${We.length})`;Ft.label=it,H.current=H.current.map(bt=>bt.id===fe?{...bt,label:it}:bt),f(bt=>bt.map(oe=>String(oe.id)!==fe||oe.type!=="cluster"?oe:{...oe,data:{...oe.data,label:it}}))}Mt.length?be(fe):De(fe);const Zt=Array.isArray(H.current)?H.current:[];gt.forEach(Tt=>{const We=Pe.get(Tt);if(!We)return;const it=Be.get(Tt)||{},bt=it?.parentId!=null?String(it.parentId):null,oe=it?.relationshipType||"Related",Ee=Zt.find(Ve=>{if(!Ve)return!1;const xe=Ve?.parentId!=null?String(Ve.parentId):null;return xe&&bt&&xe!==bt?!1:Array.isArray(Ve?.containedIds)?Ve.containedIds.some($e=>String($e)===String(Tt)):!1}),Se={clusterId:Ee?String(Ee.id):null,parentId:bt,relationshipType:oe,entity:{id:String(Tt),name:We?.data?.label||`Entity ${Tt}`,typeName:We?.data?.typeName||We?.data?.type?.name||"Entity",type:We?.data?.type||null,isExpandedProtected:!!We?.data?.isExpandedProtected}};R.current.set(String(Tt),Se),B.current.set(String(Tt),Se),D.current.set(String(Tt),{id:String(Tt),type:"entity",position:{x:0,y:0},data:{label:We?.data?.label||`Entity ${Tt}`,typeName:We?.data?.typeName||We?.data?.type?.name||"Entity",entityId:String(Tt),isAdHoc:!0,isExpandedProtected:!!We?.data?.isExpandedProtected}})})},[he,Me,De,be]),At=u.useCallback(ie=>{if(!ie)return;const ee=String(typeof ie=="string"?ie:ie?.id??ie?.data?.id??ie);if(!ee)return;const ce=H.current.find(Mt=>String(Mt.id)===ee);if(!ce)return;const fe=R.current,qe=B.current,Pe=ce.containedIds.filter(Mt=>$.current.some(tt=>String(tt.id)===String(Mt)));if(!Pe.length){De(ee);return}Pe.forEach(Mt=>{const tt=String(Mt);Y.current.delete(tt),I.current.delete(tt);const ft=$.current.find(Ft=>String(Ft.id)===tt);ft?.type==="entity"&&D.current.set(tt,{id:tt,type:"entity",position:{x:0,y:0},data:{label:ft.data?.label||`Entity ${tt}`,typeName:ft.data?.typeName||"Entity",entityId:tt,isAdHoc:!0,isExpandedProtected:!!ft.data?.isExpandedProtected}});const Rt=qe.get(tt)||{clusterId:ee,parentId:ce.parentId||null,relationshipType:ce.relationshipType||ce.label||"Related",entity:ft?.data?{id:tt,name:ft.data?.label||`Entity ${tt}`,typeName:ft.data?.typeName||"Entity",isExpandedProtected:!!ft.data?.isExpandedProtected}:D.current.get(tt)?.data?{id:tt,name:D.current.get(tt)?.data?.label||`Entity ${tt}`,typeName:D.current.get(tt)?.data?.typeName||"Entity",isExpandedProtected:!!D.current.get(tt)?.data?.isExpandedProtected}:null};fe.set(tt,Rt),qe.set(tt,Rt)});const Be=F.current.filter(Mt=>{const tt=String(Mt.source),ft=String(Mt.target);return!Pe.includes(tt)&&!Pe.includes(ft)});h(Be),g(Mt=>{const tt={...Mt};let ft=!1;return Pe.forEach(Rt=>{tt[Rt]&&(delete tt[Rt],ft=!0)}),ft?tt:Mt});const Te=Y.current,gt=ce.containedIds.filter(Mt=>{const tt=String(Mt);return Te.has(tt)?!1:fe.has(tt)}),jt=`${ce.relationshipType||ce.label||"Related"} (${gt.length})`;ce.label=jt,H.current=H.current.map(Mt=>String(Mt.id)===ee?{...Mt,label:jt}:Mt),f(Mt=>{const ft=Mt.filter(Rt=>!Pe.includes(String(Rt.id))).map(Rt=>String(Rt.id)!==ee||Rt.type!=="cluster"?Rt:{...Rt,data:{...Rt.data,placedEntityIds:ce.containedIds.filter(Ft=>{const Zt=String(Ft);return Te.has(Zt)?!1:!fe.has(Zt)}).map(Ft=>String(Ft)),manuallyReleasedIds:ce.containedIds.filter(Ft=>{const Zt=String(Ft);return Te.has(Zt)?!1:!fe.has(Zt)}).map(Ft=>String(Ft)),label:jt}});return he(Nc(ft,Be))}),De(ee)},[he,De]),we=u.useCallback((ie,ee)=>{if(!ee||ee.type!=="entity"&&ee.type!=="cluster")return;const ce=String(ee.id);if(I.current.set(ce,{x:ee?.position?.x??0,y:ee?.position?.y??0}),ee.type!=="entity")return;const fe=ce,qe=y[fe];if(!qe?.clusterId)return;const Pe=document.querySelector(`[data-id="${qe.clusterId}"]`),Be=document.querySelector(`[data-id="${fe}"]`);if(!Pe||!Be)return;const Te=Pe.getBoundingClientRect(),gt=Be.getBoundingClientRect(),jt=gt.left+gt.width/2,Mt=gt.top+gt.height/2;if(!(jt>=Te.left&&jt<=Te.right&&Mt>=Te.top&&Mt<=Te.bottom))return;const ft=d.find(Rt=>Rt.id===qe.clusterId);ft&&(ee?.data?.isExpandedProtected||Ct({id:ft.id,relationshipType:ft.data?.relationshipType,sourceId:ft.data?.sourceId,placedEntityIds:ft.data?.placedEntityIds||[]},{id:fe,name:ee?.data?.label,typeName:ee?.data?.typeName,isExpandedProtected:!!ee?.data?.isExpandedProtected}))},[y,Ct,d]);u.useEffect(()=>{f(ie=>{const ee=Object.entries(y).reduce((fe,[qe,Pe])=>{const Be=Pe?.clusterId;if(!Be)return fe;const Te=String(Be);return fe[Te]||(fe[Te]=[]),fe[Te].push(String(qe)),fe},{});let ce=ie.map(fe=>{if(fe.type!=="cluster")return fe;const qe=ee[fe.id]||[],Pe=(fe.data?.placedEntityIds||[]).map(Te=>String(Te));return qe.length!==Pe.length||qe.some((Te,gt)=>Te!==Pe[gt])?{...fe,data:{...fe.data,placedEntityIds:qe,manuallyReleasedIds:qe}}:fe});for(const[fe,qe]of Object.entries(ee)){const Pe=ce.find(Be=>Be.id===fe&&Be.type==="cluster");Pe&&(ce=Md(ce,Pe,qe))}return he(ce)})},[he,y]),u.useEffect(()=>{if(!e)return;let ie=!0;const ee=new AbortController,ce=3e4;async function fe(){i(!0),o(null);const qe=performance.now();console.log(`[RelationshipViewer] Starting graph fetch for entity ${e} at depth ${S}`);try{const Pe=R.current instanceof Map?Array.from(R.current.entries()):[],Be=new Map(Pe.map(([bt,oe])=>[String(bt),oe])),Te=new Set(Be.keys()),gt=new Promise((bt,oe)=>{setTimeout(()=>{oe(new Error(`Graph fetch timed out after ${ce/1e3} seconds`))},ce)}),jt=bI(e,S),Mt=await Promise.race([jt,gt]),tt=performance.now()-qe;console.log(`[RelationshipViewer] Graph fetch completed in ${tt.toFixed(2)}ms`);const ft=Mt??{};let Rt=Array.isArray(ft.edges)?ft.edges:[];Te.size&&Array.isArray(ft.edges)&&(Rt=ft.edges.filter(bt=>{const oe=bt?.from_entity??bt?.fromEntityId??bt?.from??bt?.source??bt?.sourceId??null,Ee=bt?.to_entity??bt?.toEntityId??bt?.to??bt?.target??bt?.targetId??null,Se=oe!=null?String(oe):null,Ve=Ee!=null?String(Ee):null,xe=Se?Te.has(Se):!1,$e=Ve?Te.has(Ve):!1;return!xe&&!$e?!0:!(xe&&$e)}));const Ft=Rt.map(bt=>uz(bt,e)).filter(Boolean),Zt=pz(Ft);W.current=Zt,le.current=yz(e,Zt);const Tt=Number.isFinite(Number(S))?Number(S):null,We=bz(e,Ft,Tt),it=performance.now();console.log(`[RelationshipViewer] Starting graph processing: ${Rt.length} edges`),setTimeout(()=>{try{if(!ie)return;const bt=performance.now(),{nodes:oe,edges:Ee,suppressedNodes:Se,clusters:Ve}=oz({...ft,edges:Rt},e,void 0,{alwaysIncludeIds:We}),xe=performance.now()-bt;if(console.log(`[RelationshipViewer] buildReactFlowGraph completed in ${xe.toFixed(2)}ms: ${oe.length} nodes, ${Ee.length} edges`),!ie)return;const $e=te=>te?te.type==="cluster"?{...te,data:{...te.data,onAddToBoard:(ve,Ie)=>ht(ve,Ie),onReturnToGroup:Ct,onCollapseCluster:At,onSetTargetEntity:ue,onOpenEntityInfo:se,placedEntityIds:[]}}:te.type==="entity"?{...te,data:{...te.data,onSetTarget:ue,onOpenInfo:se}}:{...te}:null,He=Y.current,J=oe.map($e),Z=Object.entries(y).reduce((te,[ve,Ie])=>{const rt=Ie?.clusterId!=null?String(Ie.clusterId):null;return rt&&(te.has(rt)||te.set(rt,[]),te.get(rt).push(String(ve))),te},new Map),je=te=>{const ve=Array.isArray(te)?te.map(Ie=>String(Ie)):[];return He.size?ve.filter(Ie=>!He.has(Ie)):ve},Ne=te=>{if(!te)return te;const ve=te?.id!=null?String(te.id):null,Ie=je(te?.data?.containedIds||[]),rt=ve&&Z.has(ve)?Z.get(ve):[],_t=Array.isArray(rt)?rt.map(Lt=>String(Lt)):[];return{...te,data:{...te?.data,containedIds:Ie,count:Ie.length+_t.length,placedEntityIds:_t,manuallyReleasedIds:_t}}},pe=J.map(te=>te?.type==="cluster"?Ne(te):te),Ue=new Map,ae=Se,Ke=(te,ve)=>{if(He.has(te))return;const Ie=Sa(ve?.entity?.name,`Entity ${te}`);Ue.set(te,{clusterId:ve?.clusterId!=null?String(ve.clusterId):null,parentId:ve?.parentId!=null?String(ve.parentId):null,relationshipType:ve?.relationshipType||"Related",entity:ve?.entity?{...ve.entity,id:String(ve.entity.id??te),name:Ie,typeName:ve.entity?.typeName||ve.entity?.type?.name||"Entity",isExpandedProtected:!!ve.entity?.isExpandedProtected}:null})};ae instanceof Map?ae.forEach((te,ve)=>{const Ie=String(ve);Ke(Ie,te)}):Object.entries(ae||{}).forEach(([te,ve])=>{const Ie=String(te);Ke(Ie,ve)}),R.current=Ue,B.current=new Map(Ue);const ot=new Map;ae instanceof Map?ae.forEach((te,ve)=>{const Ie=String(ve),rt=te?.entity||null,_t=Sa(rt?.name,`Entity ${Ie}`);ot.set(Ie,{id:Ie,type:"entity",position:{x:0,y:0},data:{label:_t,typeName:rt?.typeName||rt?.type?.name||"Entity",entityId:Ie,isAdHoc:!0,isExpandedProtected:!!rt?.isExpandedProtected}})}):Object.entries(ae||{}).forEach(([te,ve])=>{const Ie=String(te),rt=ve?.entity||null,_t=Sa(rt?.name,`Entity ${Ie}`);ot.set(Ie,{id:Ie,type:"entity",position:{x:0,y:0},data:{label:_t,typeName:rt?.typeName||rt?.type?.name||"Entity",entityId:Ie,isAdHoc:!0,isExpandedProtected:!!rt?.isExpandedProtected}})}),D.current=ot;const St=new Set,nt=(Array.isArray(Ve)?Ve:pe.filter(te=>te.type==="cluster")).map(te=>Ne(te));nt.forEach(te=>{St.add(String(te.id))}),O.current=St;const Ge=nt.map(te=>({id:String(te.id),relationshipType:te?.data?.relationshipType||te?.data?.label||"Related",label:te?.data?.label||te?.data?.relationshipType||"Related",containedIds:(te?.data?.containedIds||[]).map(ve=>String(ve)),parentId:te?.data?.sourceId!=null?String(te.data.sourceId):null}));H.current=Ge;const vt=new Map(Array.isArray($.current)?$.current.map(te=>[String(te.id),te]):[]),ct=[...pe];He.forEach(te=>{const ve=String(te);if(ct.some(_t=>String(_t.id)===ve))return;const Ie=vt.get(ve);if(Ie){ct.push(Ie);return}const rt=ot.get(ve);if(rt){const _t=$e(rt);_t&&ct.push({..._t,id:ve,type:"entity"})}});const Nt=new Set(Array.isArray(Ee)?Ee.map(te=>te.id):[]),Ye=(Array.isArray(F.current)?F.current:[]).filter(te=>{if(!te||Nt.has(te.id))return!1;const ve=te?.data?.childId??te?.target??te?.data?.targetId??null,Ie=te?.data?.parentId??te?.source??te?.data?.sourceId??null,rt=ve!=null?String(ve):null,_t=Ie!=null?String(Ie):null;return!!(rt&&He.has(rt)||_t&&He.has(_t))}),Je=Array.isArray(Ee)?[...Ee,...Ye]:Ye,Et=performance.now()-it;console.log(`[RelationshipViewer] Total processing completed in ${Et.toFixed(2)}ms`),f(he(ct)),h(Je),ie&&i(!1)}catch(bt){ie&&(console.error("[RelationshipViewer] Error processing graph data:",bt),o(bt.message||"Failed to process graph data"),i(!1))}},0)}catch(Pe){ie&&(console.error("[RelationshipViewer] Error fetching graph:",Pe),o(Pe.message||"Failed to load graph"),i(!1))}}return fe(),()=>{ie=!1,ee.abort()}},[he,e,S,ht,At,se,Ct,ue]);const st=u.useCallback(()=>{if(!b||!e)return;const ie=String(e),ee=b.getNode(ie);if(!ee)return;const ce=ee.width??0,fe=ee.height??0,qe=ee.position.x+ce/2,Pe=ee.position.y+fe/2;b.setCenter(qe,Pe,{zoom:Math.max(1,b.getZoom()),duration:500})},[e,b]),lt=u.useCallback(()=>{!b||!d.length||b.fitView({padding:.2,duration:500})},[d.length,b]),Fe=u.useCallback(()=>{e&&(f(ie=>{if(!ie?.length)return ie;const ee=Nc(ie,p,e),ce=new Map(ee.map(Te=>[String(Te.id),{...Te.position}])),fe=ie.map(Te=>{const gt=ce.get(String(Te.id));return!gt||Te?.position?.x===gt.x&&Te?.position?.y===gt.y?Te:{...Te,position:{...gt}}}),qe=Object.entries(y).reduce((Te,[gt,jt])=>{const Mt=jt?.clusterId;if(!Mt)return Te;const tt=String(Mt);return Te[tt]||(Te[tt]=[]),Te[tt].push(String(gt)),Te},{});if(!Object.keys(qe).length)return fe;let Pe=fe.map(Te=>{if(Te.type!=="cluster")return Te;const gt=qe[Te.id]||[],jt=(Te.data?.placedEntityIds||[]).map(String);return gt.length!==jt.length||gt.some((tt,ft)=>tt!==jt[ft])?{...Te,data:{...Te.data,placedEntityIds:gt,manuallyReleasedIds:gt}}:Te});for(const[Te,gt]of Object.entries(qe)){const jt=Pe.find(Mt=>Mt.id===Te&&Mt.type==="cluster");jt&&(Pe=Md(Pe,jt,gt))}const Be=I.current;return Be instanceof Map&&Be.size&&Pe.forEach(Te=>{if(!Te||!(Te.type==="entity"||Te.type==="cluster"))return;const jt=String(Te.id);Be.has(jt)&&Be.set(jt,{x:Te.position?.x??0,y:Te.position?.y??0})}),he(Pe)}),b&&requestAnimationFrame(()=>{b.fitView({padding:.2,duration:400})}))},[he,y,p,e,b]),Xe=u.useCallback(()=>{s||N(ie=>Math.min(3,ie+1))},[s]),dt=u.useCallback(()=>{s||N(ie=>Math.max(1,ie-1))},[s]);return u.useEffect(()=>{if(!j.current||!E.current)return;const ie=()=>{const fe=j.current,qe=E.current;if(!fe||!qe)return;const Pe=fe.getBoundingClientRect();Pe.width>0&&Pe.height>0&&(qe.style.width=`${Pe.width}px`,qe.style.height=`${Pe.height}px`)},ee=setTimeout(ie,0),ce=new ResizeObserver(ie);return ce.observe(j.current),()=>{clearTimeout(ee),ce.disconnect()}},[]),s?t.jsx("p",{className:"p-4",children:"Loading graph..."}):l?t.jsxs("p",{className:"p-4 text-red-500",children:["Error: ",l]}):d.length?t.jsxs("div",{className:"relative h-full w-full",style:{width:"100%",height:"100%"},children:[t.jsx("div",{ref:j,className:"absolute inset-0 bg-slate-100",style:{width:"100%",height:"100%"},children:t.jsx("div",{ref:E,className:"absolute inset-0",style:{width:"100%",height:"100%"},children:t.jsxs(cb,{nodes:d,edges:p,onNodesChange:Ce,onEdgesChange:Re,onNodeDragStop:we,nodeTypes:de,edgeTypes:Q,fitView:!0,onInit:v,children:[t.jsx(h_,{}),t.jsx(y_,{}),t.jsx(b_,{gap:16})]})})}),t.jsxs("header",{className:"absolute top-0 z-20 bg-white border-b px-6 py-4 flex items-center justify-between relationship-viewer-header",style:{left:0,right:0,width:"100%",boxShadow:"0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1)"},children:[t.jsx("h1",{className:"text-xl font-bold text-gray-900 tracking-tight",children:"Relationship Explorer"}),t.jsx(__,{style:{compact:!0},onRefocus:st,onZoomToFit:lt,onAutoArrange:Fe,depth:S,onIncreaseDepth:Xe,onDecreaseDepth:dt})]}),t.jsx(Lg,{entityId:A,entity:_,isLoading:L,error:k,onClose:Le,fieldOrder:G,fieldRules:X})]}):t.jsx("p",{className:"p-4",children:"No relationships found for this entity."})}function fc({step:e,title:n,subtitle:s,children:i,disabled:l=!1}){return t.jsxs("section",{className:`step-card${l?" step-card--disabled":""}`,"aria-disabled":l,children:[t.jsxs("header",{className:"step-card__header",children:[t.jsx("span",{className:"step-card__badge",children:e}),t.jsxs("div",{children:[t.jsx("h3",{className:"step-card__title",children:n}),s&&t.jsx("p",{className:"step-card__subtitle",children:s})]})]}),t.jsx("div",{className:"step-card__body",children:i})]})}const SN=["B","KB","MB","GB"];function vz(e){if(!Number.isFinite(e)||e<=0)return"0 B";const n=Math.min(Math.floor(Math.log(e)/Math.log(1024)),SN.length-1),s=e/1024**n;return`${s.toFixed(s>=10||n===0?0:1)} ${SN[n]}`}function Sz({files:e=[],selectedId:n,onSelect:s,onDelete:i}){return e.length?t.jsx("ul",{className:"uploaded-file-list",children:e.map(l=>{const o=l.id===n;return t.jsxs("li",{className:`uploaded-file-list__item${o?" is-selected":""}`,children:[t.jsxs("button",{type:"button",className:"uploaded-file-list__select",onClick:()=>s(o?null:l.id),children:[t.jsx(gy,{size:16}),t.jsx("span",{className:"uploaded-file-list__name",children:l.file_name}),t.jsx("span",{className:"uploaded-file-list__meta",children:vz(l.size_bytes)})]}),t.jsx("button",{type:"button",className:"uploaded-file-list__delete",onClick:()=>i(l.id),"aria-label":`Delete ${l.file_name}`,children:t.jsx(zn,{size:16})})]},l.id)})}):t.jsx("p",{className:"uploaded-file-list__empty",children:"No files uploaded yet."})}function wz({isOpen:e,onClose:n,preview:s,previewing:i,importing:l,onImport:o,error:d}){if(!e)return null;const f=!!(s&&!i&&!l);return t.jsxs("div",{className:"preview-popout",role:"dialog","aria-modal":"true",children:[t.jsx("div",{className:"preview-popout__overlay",onClick:n}),t.jsxs("div",{className:"preview-popout__panel",children:[t.jsxs("header",{className:"preview-popout__header",children:[t.jsxs("div",{children:[t.jsx("h2",{children:"Import Preview"}),t.jsx("p",{children:"Review the summary before running the upload."})]}),t.jsx("button",{type:"button",onClick:n,"aria-label":"Close preview",className:"preview-popout__close",children:t.jsx(Bn,{size:20})})]}),t.jsxs("div",{className:"preview-popout__content",children:[i&&t.jsxs("div",{className:"preview-popout__state",children:[t.jsx(mn,{className:"spin",size:28}),t.jsx("p",{children:"Generating preview"})]}),!i&&d&&t.jsxs("div",{className:"preview-popout__alert preview-popout__alert--error",children:[t.jsx(La,{size:18}),t.jsx("span",{children:d})]}),!i&&s&&t.jsxs("div",{className:"preview-popout__summary",children:[t.jsxs("div",{className:"preview-popout__summary-grid",children:[t.jsx(kd,{label:"Total rows",value:s.total}),t.jsx(kd,{label:"To create",value:s.createCount,tone:"success"}),t.jsx(kd,{label:"Duplicates",value:s.duplicateCount,tone:"warn"}),t.jsx(kd,{label:"Invalid",value:s.invalidCount,tone:"error"})]}),s.duplicateCount>0&&Array.isArray(s.duplicates)&&t.jsxs("div",{className:"preview-popout__list",children:[t.jsx("h3",{children:"Duplicate rows"}),t.jsx("ul",{children:s.duplicates.map(p=>t.jsxs("li",{children:[t.jsxs("span",{children:["Row ",p.row]}),t.jsx("span",{className:"preview-popout__list-name",children:p.name})]},p.row))})]}),s.invalidCount>0&&Array.isArray(s.invalidRows)&&t.jsxs("div",{className:"preview-popout__list",children:[t.jsx("h3",{children:"Invalid rows"}),t.jsx("ul",{children:s.invalidRows.map(p=>t.jsxs("li",{children:[t.jsxs("span",{children:["Row ",p.row]}),t.jsx("span",{className:"preview-popout__list-name",children:p.reason})]},p.row))})]})]})]}),t.jsxs("footer",{className:"preview-popout__footer",children:[t.jsx("button",{type:"button",className:"preview-popout__dismiss",onClick:n,children:"Cancel"}),t.jsxs("button",{type:"button",className:"preview-popout__confirm",disabled:!f,onClick:o,children:[l?t.jsx(mn,{className:"spin",size:18}):t.jsx(IM,{size:18}),"Run upload"]})]})]})]})}function kd({label:e,value:n,tone:s}){return t.jsxs("div",{className:`summary-metric${s?` summary-metric--${s}`:""}`,children:[t.jsx("span",{className:"summary-metric__label",children:e}),t.jsx("span",{className:"summary-metric__value",children:n}),s==="success"&&t.jsx("span",{className:"summary-metric__icon",children:t.jsx(jf,{size:18})}),s==="warn"&&t.jsx("span",{className:"summary-metric__icon",children:t.jsx(La,{size:18})}),s==="error"&&t.jsx("span",{className:"summary-metric__icon",children:t.jsx(La,{size:18})})]})}function Nz(){const{token:e}=un(),{activeWorldId:n,contextKey:s}=wn(),i=n||"",[l,o]=u.useState(null),[d,f]=u.useState(!1),[p,h]=u.useState(""),[y,g]=u.useState(""),[b,v]=u.useState([]),[S,N]=u.useState([]),[j,E]=u.useState(""),[A,M]=u.useState(null),[_,T]=u.useState(!1),[k,C]=u.useState(!1),[L,z]=u.useState(!1),[G,U]=u.useState(null),[X,V]=u.useState(!1),[R,B]=u.useState(""),D=u.useRef(null);u.useEffect(()=>{(async()=>{if(!i){N([]);return}T(!0);try{const Q=await Vj(i),he=Array.isArray(Q?.data)?Q.data:Array.isArray(Q)?Q:[];N(he)}catch(Q){console.warn(" Failed to load entity types",Q),N([])}finally{T(!1)}})()},[i,s]);const O=async()=>{try{const de=await fetch("/api/entities/upload",{headers:{Authorization:`Bearer ${e}`}});if(!de.ok)throw new Error("Failed to fetch uploads");const Q=await de.json();v(Q.files||[])}catch(de){console.warn(" Could not fetch uploads",de)}};u.useEffect(()=>{e&&O()},[e]);const $=de=>{const Q=de.target.files?.[0]??null;o(Q),h(""),g("")},F=async()=>{if(!l)return g("Please select a file to upload.");const de=new FormData;de.append("file",l),f(!0),h(""),g("");try{const Q=await fetch("/api/entities/upload",{method:"POST",headers:{Authorization:`Bearer ${e}`},body:de}),he=await Q.json();if(!Q.ok)throw new Error(he.message||"Upload failed");h("File uploaded successfully."),o(null),D.current&&(D.current.value=""),await O()}catch(Q){console.error("Upload error:",Q),g(Q.message)}finally{f(!1)}},H=async de=>{if(window.confirm("Delete this upload?"))try{const Q=await fetch(`/api/entities/upload/${de}`,{method:"DELETE",headers:{Authorization:`Bearer ${e}`}}),he=await Q.json();if(!Q.ok)throw new Error(he.message||"Failed to delete file");h("File deleted."),A===de&&(M(null),U(null)),await O()}catch(Q){console.error(" Delete error:",Q),g(Q.message)}},I=async()=>{if(j){g(""),h("");try{const de=await fetch(`/api/entities/template/${j}`,{headers:{Authorization:`Bearer ${e}`}});if(!de.ok)throw new Error("Failed to generate template");const Q=await de.blob(),he=window.URL.createObjectURL(Q),re=document.createElement("a");re.href=he,re.download="Entity_Template.xlsx",document.body.appendChild(re),re.click(),re.remove(),window.URL.revokeObjectURL(he),h("Template generated successfully.")}catch(de){console.error(" Template generation failed",de),g("Failed to generate template")}}},Y=async()=>{if(!j)return g("Select an Entity Type first.");if(!A)return g("Select an uploaded file to preview.");if(!i)return g("Select a world context before previewing.");z(!0),V(!0),U(null),B(""),h(""),g("");try{const de=await fetch(`/api/entities/preview/${j}`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({fileId:A,worldId:i})}),Q=await de.json();if(!de.ok||!Q.success)throw new Error(Q.message||"Preview failed");U(Q.summary)}catch(de){console.error(" Preview failed:",de),B(de.message)}finally{z(!1)}},P=async()=>{if(!j)return g("Select an Entity Type first.");if(!A)return g("Select an uploaded file to import.");if(!i)return g("Select a world context before importing.");C(!0),h(""),g("");try{const de=await fetch(`/api/entities/import/${j}`,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({fileId:A,worldId:i})}),Q=await de.json();if(!de.ok)throw new Error(Q.message||"Import failed");h(Q.message||"Import completed successfully."),V(!1),U(null),await O()}catch(de){console.error(" Import error:",de),B(de.message)}finally{C(!1)}},W=()=>{k||L||(V(!1),B(""))},le=u.useMemo(()=>S.find(de=>String(de.id)===String(j))?.name??"",[S,j]),K=u.useMemo(()=>b.find(de=>de.id===A)??null,[b,A]);return u.useEffect(()=>{M(null),U(null),V(!1),o(null),D.current&&(D.current.value=""),h(""),g(""),B("")},[j]),t.jsxs("div",{className:"bulk-upload-page",children:[t.jsxs("div",{className:"bulk-upload-page__header",children:[t.jsx("h1",{className:"bulk-upload-page__title",children:"Bulk Entity Upload"}),t.jsx("p",{className:"bulk-upload-page__subtitle",children:"Follow the guided steps to prepare your template, upload a data file, preview the import, and launch the upload from a dedicated review panel."})]}),p&&t.jsxs("div",{className:"bulk-upload-page__status",children:[t.jsx(jf,{size:18}),t.jsx("span",{children:p})]}),y&&t.jsxs("div",{className:"bulk-upload-page__status bulk-upload-page__status--error",children:[t.jsx(La,{size:18}),t.jsx("span",{children:y})]}),t.jsxs("div",{className:"bulk-upload-page__grid",children:[t.jsx(fc,{step:"Select",title:"Choose an entity type",subtitle:_?"Loading entity types for this world...":"Pick which entity type you want to work with. Steps unlock after choosing.",children:t.jsxs("select",{value:j,onChange:de=>E(de.target.value),className:"entity-type-select",children:[t.jsx("option",{value:"",children:_?"Loading":"Select Entity Type"}),S.map(de=>t.jsx("option",{value:de.id,children:de.name},de.id))]})}),j&&t.jsxs(t.Fragment,{children:[t.jsx(fc,{step:1,title:"Generate a template",subtitle:"Download a spreadsheet tailored to the selected entity type.",children:t.jsxs("div",{className:"step-actions",children:[t.jsxs("button",{type:"button",className:"primary-action",onClick:I,children:[t.jsx(BM,{size:18}),"Download template"]}),le&&t.jsxs("span",{className:"selected-file-banner",children:[t.jsx(Yi,{size:16})," Template matches ",le]})]})}),t.jsxs(fc,{step:2,title:"Upload your file",subtitle:"Upload the filled spreadsheet and pick which file to preview.",children:[t.jsxs("div",{className:"file-input",children:[t.jsxs("label",{htmlFor:"bulk-upload-file",children:[t.jsx(SS,{size:20}),t.jsxs("div",{children:[t.jsx("div",{className:"file-input__name",children:l?l.name:"Select a file to upload"}),t.jsx("small",{children:"Supported format: Excel (.xlsx)"})]})]}),t.jsx("input",{ref:D,id:"bulk-upload-file",type:"file",hidden:!0,onChange:$}),t.jsxs("button",{type:"button",className:"secondary-action",onClick:F,disabled:!l||d,children:[d?t.jsx(mn,{className:"spin",size:18}):t.jsx(SS,{size:18}),"Upload file"]})]}),K&&t.jsxs("div",{className:"selected-file-banner",children:[t.jsx(HM,{size:16})," Selected file: ",K.file_name]}),t.jsx(Sz,{files:b,selectedId:A,onSelect:de=>{M(de),U(null)},onDelete:H})]}),t.jsx(fc,{step:3,title:"Run a preview",subtitle:"Review potential changes in the popout before committing to an upload.",children:t.jsxs("div",{className:"step-actions",children:[t.jsxs("button",{type:"button",className:"primary-action",onClick:Y,disabled:!A||L,children:[L?t.jsx(mn,{className:"spin",size:18}):t.jsx(wj,{size:18}),"Preview import"]}),t.jsx("span",{className:"bulk-upload-page__empty-state",children:"The upload can only be launched from the preview popout."})]})}),t.jsx(fc,{step:4,title:"Launch the upload",subtitle:"Confirm the summary inside the popout, then run the upload from there.",children:t.jsxs("div",{className:"step-actions",children:[t.jsxs("span",{className:"bulk-upload-page__empty-state",children:["After reviewing the preview, use the ",t.jsx("strong",{children:"Run upload"})," button in the panel to finish."]}),t.jsxs("span",{className:"selected-file-banner",children:[t.jsx(gj,{size:16})," Preview popout controls the final import."]})]})})]})]}),t.jsx(wz,{isOpen:X,onClose:W,preview:G,previewing:L,importing:k,onImport:P,error:R})]})}function Qy({content:e="",mentions:n=[],segments:s=null,noteId:i="note",textClassName:l="note-text",mentionClassName:o="note-mention",renderEmpty:d=null}){const f=u.useMemo(()=>Array.isArray(s)?s:Bi(e,n),[e,n,s]);return!f||f.length===0?typeof d=="function"?d():null:f.map((p,h)=>{if(p.type==="mention"){if(p.isPlaceholder){const g=p.entityName||p.locationName||"Unresolved";return t.jsxs("span",{className:o,style:{display:"inline-block",backgroundColor:"#fef3c7",color:"#92400e",padding:"2px 6px",borderRadius:"4px",fontSize:"0.875em",fontWeight:500,border:"1px solid #fbbf24"},title:"Unresolved mention - check console for details",children:["@",g,"?"]},`${i}-mention-${h}`)}if(p.locationId){const g=p.locationName||"location";return t.jsxs("span",{className:o,children:["@",g,t.jsx(fs,{locationId:p.locationId,locationName:g})]},`${i}-mention-${h}`)}if(p.entityId){const g=p.entityName||"entity";return t.jsxs("span",{className:o,children:["@",g,t.jsx(Na,{entityId:p.entityId,entityName:g})]},`${i}-mention-${h}`)}const y=p.locationName||p.entityName||p.name||p.label||"mention";return t.jsxs("span",{className:o,style:{display:"inline-block",backgroundColor:"#fee2e2",color:"#991b1b",padding:"2px 6px",borderRadius:"4px",fontSize:"0.875em",fontWeight:500,border:"1px solid #f87171"},title:"Mention without ID - check console for details",children:["@",y,"?"]},`${i}-mention-${h}`)}return t.jsx("span",{className:l,children:p.text},`${i}-text-${h}`)})}const jz=2500,$s=Object.freeze([]),Ez="Use @ to tag entities mentioned in this session.",Jp=(e="create")=>({mode:e,submitLabel:e==="edit"?"Save Changes":"Create Entity",submitDisabled:!1,cancelDisabled:!1,accessButtonVisible:!1,accessButtonDisabled:!1}),ey=e=>{if(!e)return{id:"",sessionDate:"",sessionTitle:"Session note",content:"",mentions:$s,createdAt:null,updatedAt:null,author:null,lastEditor:null};const n=e.sessionDate??e.session_date??"",s=e.sessionTitle??e.session_title??"Session note",i=typeof e.content=="string"?e.content:"",l=Array.isArray(e.mentions)?e.mentions.filter(Boolean).map(o=>{const d=o?.entityName??o?.entity_name??o?.label??o?.name??"",f=ky(d);return{...o,entityName:f}}):$s;return{id:e.id??"",sessionDate:n,sessionTitle:s,content:i,mentions:l,createdAt:e.createdAt??e.created_at??null,updatedAt:e.updatedAt??e.updated_at??null,author:e.author??null,lastEditor:e.lastEditor??null}},Rd=()=>new Date().toISOString().slice(0,10),Id=e=>{if(!e)return"Undated session";const n=/^\d{4}-\d{2}-\d{2}$/.test(e)?`${e}T00:00:00Z`:e,s=new Date(n);return Number.isNaN(s.getTime())?e:s.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})},_z=e=>{if(!e)return"";const n=e instanceof Date?e:new Date(e);return Number.isNaN(n.getTime())?"":n.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})};function Cz(){const{user:e}=un(),{selectedCampaign:n,selectedCampaignId:s}=wn(),[i,l]=u.useState({items:$s,loading:!1,error:""}),[o,d]=u.useState(""),[f,p]=u.useState(null),[h,y]=u.useState(!1),[g,b]=u.useState({status:"idle",lastSaved:"",error:""}),[v,S]=u.useState(""),[N,j]=u.useState(!1),[E,A]=u.useState(!1),[M,_]=u.useState(""),T=u.useRef(null),k=u.useRef(""),C=u.useRef(null),L=u.useRef(!1),z=u.useRef(""),[G,U]=u.useState(!1),[X,V]=u.useState(()=>Jp("create")),[R,B]=u.useState("details"),D=u.useRef(`entity-form-${Math.random().toString(36).slice(2)}`),O=u.useMemo(()=>n?.world?.id?n.world.id:n?.world_id?n.world_id:"",[n]),$=u.useMemo(()=>!n||!Array.isArray(n.members)||!e?null:n.members.find(st=>st?.user_id===e.id)?.role??null,[n,e]),F=u.useMemo(()=>e?.role==="system_admin"?!0:$==="dm",[$,e]),H=u.useMemo(()=>e?.role==="system_admin"||$==="dm"?!0:$==="player"?(n?.world?.entity_creation_scope??"")===zi.ALL_PLAYERS:!1,[$,e,n]),I=u.useCallback(async()=>{if(s){l(we=>({...we,loading:!0,error:""}));try{const we=await mR(s),st=Array.isArray(we?.data)?we.data:Array.isArray(we)?we:[];l({items:st,loading:!1,error:""})}catch(we){console.error(" Failed to load session notes",we),l({items:$s,loading:!1,error:we?.message||"Failed to load session notes"})}}},[s]);u.useEffect(()=>{if(!s){l({items:$s,loading:!1,error:""}),d(""),p(null),C.current=null;return}I()},[s,I]),u.useEffect(()=>{T.current=f},[f]),u.useEffect(()=>{k.current=o},[o]);const Y=u.useMemo(()=>Array.isArray(i.items)?[...i.items].sort((we,st)=>{const lt=(we?.session_date??we?.sessionDate??"")||"",Fe=(st?.session_date??st?.sessionDate??"")||"";if(lt&&Fe&&lt!==Fe)return Fe.localeCompare(lt);const Xe=new Date(we?.updated_at??we?.updatedAt??we?.created_at??we?.createdAt??0).getTime();return new Date(st?.updated_at??st?.updatedAt??st?.created_at??st?.createdAt??0).getTime()-Xe}):$s,[i.items]),P=u.useMemo(()=>{const we=v.trim().toLowerCase();return we?Y.filter(st=>{if(!st)return!1;const lt=String(st?.session_title??st?.sessionTitle??"Session note").toLowerCase(),Fe=String(st?.content??"").toLowerCase(),Xe=Id(st?.session_date??st?.sessionDate??"").toString().toLowerCase();return lt.includes(we)||Fe.includes(we)||Xe.includes(we)}):Y},[v,Y]),W=u.useMemo(()=>o&&Y.find(we=>we?.id===o)||null,[Y,o]),le=u.useMemo(()=>f?.sessionDate?Id(f.sessionDate):"Undated session",[f?.sessionDate]),K=u.useMemo(()=>f?.updatedAt?_z(f.updatedAt):"",[f?.updatedAt]),de=u.useMemo(()=>f?.content?Bi(f.content,f.mentions):$s,[f?.content,f?.mentions]);u.useEffect(()=>{const we=v.trim().length>0,st=P.length>0?P:Y;if(!o&&st.length>0){d(st[0].id);return}if(we&&P.length===0){o&&d(""),p(null),C.current=null;return}if(o&&P.length>0&&!P.some(Xe=>Xe?.id===o)){d(P[0].id);return}if(!o){p(null),C.current=null;return}if(!W){d(""),p(null),C.current=null;return}const lt=ey(W);p(lt),C.current=lt,b(Fe=>({...Fe,status:"idle",error:""}))},[P,v,W,o,Y]),u.useEffect(()=>{if(!o){j(!1);return}if(z.current&&z.current===o){j(!0),z.current="";return}j(!1)},[o]),u.useEffect(()=>{_("")},[o]),u.useEffect(()=>{S("")},[s]);const Q=u.useCallback((we,st)=>{const lt=typeof st=="string"?st:typeof we?.target?.value=="string"?we.target.value:"";p(Fe=>Fe&&{...Fe,content:lt})},[]),he=u.useCallback(async(we,st)=>{const lt=we?.trim()??"";if(typeof st!="function")return;if(!O||lt.length===0){st([]);return}const{searchMentions:Fe}=await ci(async()=>{const{searchMentions:Xe}=await import("./mentionSearch-CLdrbUuU.js");return{searchMentions:Xe}},[]);await Fe({worldId:O,query:lt,limit:8,callback:st})},[O]),re=u.useCallback((we,st)=>{p(lt=>lt&&{...lt,[we]:st})},[]),Ce=u.useMemo(()=>{if(!f?.id)return!1;const we={sessionTitle:(f.sessionTitle||"").trim(),sessionDate:f.sessionDate||"",content:f.content||""},st=C.current||{},lt={sessionTitle:(st.sessionTitle||"").trim(),sessionDate:st.sessionDate||"",content:st.content||""};return JSON.stringify(we)!==JSON.stringify(lt)},[f]),Re=u.useCallback(async()=>{const we=s,st=k.current,lt=T.current;if(!we||!st||!lt||L.current)return;const Fe={sessionTitle:lt.sessionTitle?.trim()||"Session note",sessionDate:lt.sessionDate||Rd(),content:lt.content||""},Xe=C.current||{},dt={sessionTitle:Xe.sessionTitle?.trim()||"Session note",sessionDate:Xe.sessionDate||Rd(),content:Xe.content||""};if(JSON.stringify(Fe)!==JSON.stringify(dt))try{L.current=!0,b(fe=>({...fe,status:"saving",error:""}));const ie=await pR(we,st,Fe),ee=ie?.data??ie,ce=ey(ee);C.current=ce,p(ce),l(fe=>{const qe=Array.isArray(fe.items)?fe.items:$s,Pe=qe.some(Be=>Be?.id===ee?.id)?qe.map(Be=>Be?.id===ee?.id?{...Be,...ee}:Be):[ee,...qe];return{...fe,items:Pe}}),b({status:"saved",lastSaved:new Date().toISOString(),error:""})}catch(ie){console.error(" Failed to save session note",ie),b(ee=>({...ee,status:"error",error:ie?.message||"Failed to save session note"}))}finally{L.current=!1}},[s]);u.useEffect(()=>{if(!s||!f?.id||!Ce||L.current)return;const we=setTimeout(()=>{Re()},jz);return()=>clearTimeout(we)},[f,Ce,Re,s]);const ue=u.useCallback(()=>{Re()},[Re]),se=u.useCallback(async()=>{const we=s,st=k.current;if(!(!we||!st)){A(!0),_("");try{await yR(we,st),l(lt=>{const Xe=(Array.isArray(lt.items)?lt.items:$s).filter(dt=>String(dt?.id)!==String(st));return{...lt,items:Xe}}),k.current="",d(""),p(null),C.current=null,b({status:"idle",lastSaved:"",error:""})}catch(lt){console.error(" Failed to delete session note",lt),_(lt?.message||"Failed to delete session note")}finally{A(!1)}}},[s]),Le=u.useCallback(async()=>{if(s){y(!0),b(we=>({...we,error:""}));try{const we=await hR(s,{sessionTitle:`Session on ${Id(Rd())}`,sessionDate:Rd()}),st=we?.data??we,lt=ey(st);l(Fe=>{const dt=(Array.isArray(Fe.items)?Fe.items:$s).filter(ie=>ie?.id!==st?.id);return{...Fe,items:[st,...dt],error:""}}),S(""),z.current=st.id,d(st.id),p(lt),C.current=lt,j(!0),b({status:"idle",lastSaved:"",error:""})}catch(we){console.error(" Failed to create session note",we),b(st=>({...st,status:"error",error:we?.message||"Failed to create session note"}))}finally{y(!1)}}},[s]),be=u.useCallback(()=>{O&&(V(Jp("create")),B("details"),U(!0))},[O]),De=u.useCallback(()=>{U(!1),V(Jp("create")),B("details")},[]),Me=u.useCallback(we=>{we&&V(st=>({...st,...we}))},[]),mt=u.useCallback(async we=>{De()},[De]),ht=n?.name??"",Ct=Y.length,At=u.useMemo(()=>{if(g.status==="saving")return"Saving";if(g.status==="error")return"Changes not saved";if(g.status==="saved"&&g.lastSaved){const we=new Date(g.lastSaved);return Number.isNaN(we.getTime())?"Saved":`Saved ${we.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}`}return Ce?"Unsaved changes":""},[Ce,g]);return s?t.jsxs("div",{className:"notes-page",children:[t.jsx("div",{className:"notes-header",children:t.jsxs("div",{className:"notes-title",children:[t.jsx("h1",{children:"Session Notes"}),t.jsxs("p",{children:["Chronicle every game night for the ",t.jsx("strong",{children:ht})," campaign, @mention key entities, and keep everyone aligned with auto-saving notes."]})]})}),t.jsxs("div",{className:"session-notes-meta",children:[t.jsxs("span",{children:[t.jsx(_j,{size:16})," Players and DMs can add or update notes."," ",t.jsx(vS,{size:16})," ",Ct," ",Ct===1?"session":"sessions"," tracked."]}),At?t.jsxs("span",{className:`session-notes-autosave status-${g.status}`,children:[g.status==="saving"?t.jsx(mn,{size:14,className:"spinner"}):g.status==="saved"?t.jsx(bj,{size:14}):g.status==="error"?t.jsx(ta,{size:14}):Ce?t.jsx(ES,{size:14}):null,t.jsx("span",{children:At})]}):null]}),i.error&&t.jsxs("div",{className:"notes-error",role:"alert",children:[t.jsxs("strong",{children:[t.jsx(ta,{size:18})," Unable to load session notes"]}),t.jsx("span",{children:i.error})]}),t.jsxs("div",{className:"session-notes-layout",children:[t.jsxs("aside",{className:"session-notes-sidebar",children:[t.jsxs("label",{className:"session-notes-search",htmlFor:"session-notes-search-input",children:[t.jsx(Hl,{size:16}),t.jsx("input",{id:"session-notes-search-input",type:"search",placeholder:"Search session notes",value:v,onChange:we=>S(we.target.value)})]}),t.jsxs("button",{type:"button",className:"session-notes-item-button session-notes-new-button",onClick:Le,disabled:h||i.loading,children:[h?t.jsx(mn,{size:16,className:"spinner"}):t.jsx(Wn,{size:16}),t.jsx("span",{children:h?"Creating":"New Session"})]}),t.jsx("div",{className:"session-notes-list-container",children:i.loading?t.jsxs("div",{className:"session-notes-loading",children:[t.jsx(mn,{size:18,className:"spinner"}),t.jsx("span",{children:"Loading session notes"})]}):P.length===0?Y.length===0?t.jsxs("div",{className:"notes-empty",children:[t.jsx(Yi,{size:20}),t.jsx("strong",{children:"No session notes yet"}),t.jsx("span",{children:"Create the first note to kick off your campaign journal."})]}):t.jsxs("div",{className:"notes-empty",children:[t.jsx(Hl,{size:18}),t.jsx("strong",{children:"No matches"}),t.jsxs("span",{children:["No session notes include ",v.trim(),"."]})]}):t.jsx("ul",{className:"session-notes-list",role:"list",children:P.map(we=>{const st=we?.id,lt=st===o,Fe=we?.session_title??we?.sessionTitle??"Session note",Xe=Id(we?.session_date??we?.sessionDate);return t.jsx("li",{className:`session-notes-item ${lt?"active":""}`,children:t.jsxs("button",{type:"button",className:"session-notes-item-button",onClick:()=>d(st),children:[t.jsx("span",{className:"session-note-card-title",children:Fe}),t.jsx("span",{className:"session-note-card-date",children:Xe})]})},st)})})})]}),t.jsx("section",{className:"session-notes-panel",children:f?.id?t.jsxs("div",{className:"session-note-shell",children:[t.jsxs("header",{className:"session-note-header",children:[t.jsx("div",{className:"session-note-heading",children:t.jsx("h2",{children:f.sessionTitle||"Session note"})}),t.jsxs("div",{className:"session-note-toolbar",children:[F?t.jsxs("button",{type:"button",className:"session-note-action danger",onClick:se,disabled:E,children:[E?t.jsx(mn,{size:16,className:"spinner"}):t.jsx(zn,{size:16}),t.jsx("span",{children:E?"Deleting":"Delete"})]}):null,t.jsxs("button",{type:"button",className:"session-note-action",onClick:()=>j(we=>!we),children:[N?t.jsx(xj,{size:16}):t.jsx(jk,{size:16}),t.jsx("span",{children:N?"View note":"Edit note"})]}),N&&H?t.jsxs("button",{type:"button",className:"session-note-action primary",onClick:be,children:[t.jsx(Wn,{size:16}),t.jsx("span",{children:"Create Entity"})]}):null]})]}),M?t.jsxs("div",{className:"session-note-error",role:"alert",children:[t.jsx(ta,{size:16}),t.jsx("span",{children:M})]}):null,N?t.jsxs("div",{className:"session-note-form",children:[t.jsxs("div",{className:"session-note-fields session-note-fields-row",children:[t.jsxs("div",{className:"session-note-field",children:[t.jsx("label",{htmlFor:"session-note-title",children:"Title"}),t.jsx("input",{id:"session-note-title",type:"text",value:f.sessionTitle||"",onChange:we=>re("sessionTitle",we.target.value),placeholder:"The mystery of the Violet Spire"})]}),t.jsxs("div",{className:"session-note-field",children:[t.jsx("label",{htmlFor:"session-note-date",children:"Session date"}),t.jsx("input",{id:"session-note-date",type:"date",value:f.sessionDate||"",onChange:we=>re("sessionDate",we.target.value),max:"9999-12-31"})]})]}),t.jsxs("div",{className:"session-note-fields",children:[t.jsx("label",{htmlFor:"session-note-content",children:"Notes"}),t.jsx("div",{className:"session-note-editor-field",children:t.jsx(Gl,{value:f.content||"",onChange:Q,markup:"@[__display__](__id__)",placeholder:Ez,className:"session-note-mentions",inputProps:{id:"session-note-content",className:"session-note-textarea","aria-label":"Session note content",rows:14},children:t.jsx(li,{trigger:"@",markup:"@[__display__](__id__)",displayTransform:(we,st)=>`@${st||(we.includes(":")?we.split(":")[1]:we)}`,data:he,appendSpaceOnAdd:!0})})}),t.jsx("div",{className:"session-note-save-button",children:t.jsxs("button",{type:"button",className:"session-note-action primary",onClick:ue,disabled:g.status==="saving"||!Ce,children:[g.status==="saving"?t.jsx(mn,{size:16,className:"spinner"}):t.jsx(ES,{size:16}),t.jsx("span",{children:g.status==="saving"?"Saving":"Save now"})]})}),de.length>0?t.jsxs("div",{className:"session-note-preview","aria-live":"polite",children:[t.jsx("h3",{children:"Preview"}),t.jsx("div",{className:"session-note-preview-content",children:t.jsx(Qy,{segments:de,noteId:`${f?.id||"note"}-preview`,textClassName:"session-note-text",mentionClassName:"session-note-mention"})})]}):null]}),t.jsx("div",{className:"session-note-actions",children:f.author?.username?t.jsxs("span",{className:"session-note-meta",children:["Created by ",f.author.username,f.lastEditor?.username&&f.lastEditor.username!==f.author.username?`  Last updated by ${f.lastEditor.username}`:""]}):null})]}):t.jsxs("article",{className:"session-note-view","aria-live":"polite",children:[t.jsxs("div",{className:"session-note-view-meta",children:[t.jsxs("span",{children:[t.jsx(vS,{size:16})," ",le]}),K?t.jsxs("span",{children:["Updated ",K]}):null]}),t.jsx("div",{className:"session-note-view-body",children:t.jsx(Qy,{segments:de,noteId:`${f?.id||"note"}-view`,textClassName:"session-note-text",mentionClassName:"session-note-mention",renderEmpty:()=>t.jsx("p",{className:"session-note-view-empty",children:"No notes captured yet."})})}),f.author?.username?t.jsxs("div",{className:"session-note-view-meta session-note-view-authors",children:[t.jsxs("span",{children:["Created by ",f.author.username]}),f.lastEditor?.username&&f.lastEditor.username!==f.author.username?t.jsxs("span",{children:["Last updated by ",f.lastEditor.username]}):null]}):null]})]}):t.jsxs("div",{className:"notes-helper",children:[t.jsx(by,{size:28}),t.jsx("strong",{children:"Select a session to get started"}),t.jsx("span",{children:"Create a new note or choose one from the list to see its details."})]})})]}),t.jsx(Ps,{isOpen:G,onClose:De,title:"Create Entity",width:420,footerActions:t.jsxs(t.Fragment,{children:[t.jsx("button",{type:"button",className:"btn cancel",onClick:De,disabled:X.cancelDisabled,children:"Cancel"}),X.accessButtonVisible&&t.jsx("button",{type:"button",className:"btn secondary",onClick:()=>B(we=>we==="access"?"details":"access"),disabled:X.accessButtonDisabled,children:R==="access"?"Details":"Access"}),t.jsx("button",{type:"submit",className:"btn submit",form:D.current,disabled:X.submitDisabled,children:X.submitLabel})]}),children:t.jsx(w1,{worldId:O,entityId:null,onCancel:De,onSaved:mt,formId:D.current,onStateChange:Me,hideActions:!0,activeView:R,onViewChange:B,defaultCampaignId:s||""})})]}):t.jsxs("div",{className:"notes-page",children:[t.jsx("div",{className:"notes-header",children:t.jsxs("div",{className:"notes-title",children:[t.jsx("h1",{children:"Session Notes"}),t.jsx("p",{children:"Select a campaign from the header to start collecting your notes."})]})}),t.jsxs("div",{className:"notes-helper",children:[t.jsx(by,{size:28}),t.jsx("strong",{children:"No campaign selected"}),t.jsx("span",{children:"Pick a campaign to unlock collaborative session notes."})]})]})}const Az={private:"Private",party:"Party",companions:"Companions",dm:"DM"},Tz=[{value:"private",label:"Private"},{value:"companions",label:"My Companions"}],Mz=[{value:"private",label:"Private"},{value:"party",label:"Share with Party"}],kz="What do you want to remember?",Rz=e=>{if(!e)return"";const n=e instanceof Date?e:new Date(e);return Number.isNaN(n.getTime())?"":n.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"})},Ti=e=>{const n=[e?.entityId,e?.entity_id,e?.entity?.id];for(const s of n)if(s)return String(s);return""},ty=e=>{const n=[e?.author?.id,e?.createdBy,e?.created_by];for(const s of n)if(s)return String(s);return""},wN=e=>{const n=e?.author;return n?.username?n.username:n?.email?n.email:e?.character?.name?`${e.character.name} (Character)`:(e?.created_by,"Unknown author")},NN=e=>e?.entity?.name?e.entity.name:typeof e?.entityName=="string"&&e.entityName.trim()?e.entityName:"Unnamed entity",Jy=e=>{const n=[e?.entity?.entityTypeId,e?.entity?.entity_type_id,e?.entity?.entityType?.id,e?.entity?.entityType?.entity_type_id];for(const s of n)if(s)return String(s);return""},Iz=(e,n=new Map)=>{if(e?.entity?.entityType?.name)return e.entity.entityType.name;const s=Jy(e);return s&&n.has(s)?n.get(s):""},Ol=e=>{const n=[e?.locationId,e?.location_id,e?.location?.id];for(const s of n)if(s)return String(s);return""},jN=e=>e?.location?.name?e.location.name:typeof e?.locationName=="string"&&e.locationName.trim()?e.locationName:"Unnamed location",eg=e=>{const n=[e?.location?.locationTypeId,e?.location?.location_type_id,e?.location?.locationType?.id,e?.location?.locationType?.location_type_id];for(const s of n)if(s)return String(s);return""},Lz=(e,n=new Map)=>{if(e?.location?.locationType?.name)return e.location.locationType.name;const s=eg(e);return s&&n.has(s)?n.get(s):""},ny=e=>!!Ol(e);function Dz(){const{selectedCampaign:e,selectedCampaignId:n}=wn(),{user:s}=un(),[i,l]=u.useState({items:[],loading:!1,error:""}),[o,d]=u.useState(""),[f,p]=u.useState(""),[h,y]=u.useState(""),[g,b]=u.useState(null),[v,S]=u.useState(""),[N,j]=u.useState("private"),[E,A]=u.useState(""),[M,_]=u.useState(!1),[T,k]=u.useState(null),[C,L]=u.useState(""),[z,G]=u.useState([]),[U,X]=u.useState(!1),[V,R]=u.useState(""),[B,D]=u.useState([]),[O,$]=u.useState(!1),[F,H]=u.useState([]),[I,Y]=u.useState(!1),P=u.useCallback(async()=>{if(n){l(ee=>({...ee,loading:!0,error:""}));try{const[ee,ce]=await Promise.all([dR(n).catch(Be=>(console.error("Failed to load entity notes",Be),{data:[]})),fR(n).catch(Be=>(console.error("Failed to load location notes",Be),{data:[]}))]),fe=Array.isArray(ee?.data)?ee.data:Array.isArray(ee)?ee:[],qe=Array.isArray(ce?.data)?ce.data:Array.isArray(ce)?ce:[],Pe=[...fe,...qe];l({items:Pe,loading:!1,error:""})}catch(ee){console.error(" Failed to load campaign notes",ee),l({items:[],loading:!1,error:ee?.message||"Failed to load notes"})}}},[n]);u.useEffect(()=>{if(!n){l({items:[],loading:!1,error:""});return}P()},[n,P]),u.useEffect(()=>{d(""),p(""),y(""),b(null),S(""),j("private"),A(""),L("")},[n]);const le=u.useMemo(()=>!e||!s?.id?null:(Array.isArray(e.members)?e.members:[]).find(fe=>{if(!fe)return!1;const qe=fe.user_id??fe.userId??fe.user?.id??fe.id??null;return qe?String(qe)===String(s.id):!1})||null,[e,s?.id])?.role??null,K=u.useMemo(()=>s?.role==="system_admin"?!0:le==="dm",[le,s?.role]),de=u.useMemo(()=>le==="player",[le]),Q=u.useMemo(()=>e?.world?.id?e.world.id:e?.world_id?e.world_id:"",[e]);u.useEffect(()=>{let ee=!1;return Q?((async()=>{$(!0);try{const fe=await wr({worldId:Q});if(ee)return;const Pe=(Array.isArray(fe?.data)?fe.data:Array.isArray(fe)?fe:[]).map(Be=>({id:Be?.id?String(Be.id):"",name:Be?.name||"Unnamed type"})).filter(Be=>Be.id);D(Pe)}catch(fe){if(ee)return;console.error("Failed to load entity types",fe),D([])}finally{ee||$(!1)}})(),()=>{ee=!0}):(D([]),$(!1),()=>{ee=!0})},[Q]),u.useEffect(()=>{let ee=!1;return Q?((async()=>{Y(!0);try{const fe=await Nr({worldId:Q});if(ee)return;const Pe=(Array.isArray(fe?.data)?fe.data:Array.isArray(fe)?fe:[]).map(Be=>({id:Be?.id?String(Be.id):"",name:Be?.name||"Unnamed type"})).filter(Be=>Be.id);H(Pe)}catch(fe){if(ee)return;console.error("Failed to load location types",fe),H([])}finally{ee||Y(!1)}})(),()=>{ee=!0}):(H([]),Y(!1),()=>{ee=!0})},[Q]);const he=u.useMemo(()=>K?Mz:Tz,[K]),re=u.useCallback(ee=>{if(!s||!ee)return!1;const ce=ee?.author?.id??ee?.createdBy??ee?.created_by??ee?.authorId??ee?.author_id??null;return ce?String(ce)===String(s.id):!1},[s]);u.useEffect(()=>{let ee=!1;return!de||!n?(G([]),X(!1),R(""),A(""),()=>{ee=!0}):((async()=>{X(!0),R("");try{const fe=await Cs({scope:"my",campaign_id:n});if(ee)return;const Pe=(Array.isArray(fe?.data)?fe.data:Array.isArray(fe)?fe:[]).map(Be=>({id:Be?.id?String(Be.id):"",name:Be?.name||"Unnamed character"})).filter(Be=>Be.id);G(Pe),Pe.length===1?A(Pe[0].id):Pe.some(Be=>Be.id===E)||A("")}catch(fe){if(ee)return;console.error("Failed to load characters for notes",fe),G([]),A(""),R(fe.message||"Failed to load characters")}finally{ee||X(!1)}})(),()=>{ee=!0})},[de,n,E]);const Ce=u.useCallback(async(ee,ce)=>{const fe=ee?.trim()??"";if(typeof ce!="function")return;if(fe.length===0){ce([]);return}let qe="";if(g){const gt=i.items.find(jt=>jt?.id===g);gt&&(qe=Ti(gt))}if(qe||(qe=o||""),!qe){ce([]);return}const Pe=i.items.find(gt=>Ti(gt)===qe),Be=Pe?.entity?.world_id??Pe?.entity?.world?.id??Pe?.location?.world_id??Pe?.location?.world?.id??"";if(!Be){ce([]);return}const{searchMentions:Te}=await ci(async()=>{const{searchMentions:gt}=await import("./mentionSearch-CLdrbUuU.js");return{searchMentions:gt}},[]);await Te({worldId:Be,query:fe,limit:8,callback:ce})},[o,i.items,g]),Re=u.useCallback(ee=>{if(!ee)return;const ce=ee?.characterId??ee?.character_id??"";b(ee.id),S(ee?.content??""),j(ee?.shareType??ee?.share_type??"private"),A(ce),L("")},[]),ue=u.useCallback(()=>{b(null),S(""),j("private"),A(""),L("")},[]),se=u.useCallback((ee,ce)=>{const fe=typeof ce=="string"?ce:typeof ee?.target?.value=="string"?ee.target.value:"";S(fe),L("")},[]),Le=u.useCallback(async ee=>{if(!ee||!n)return;const ce=v.trim();if(!ce){L("Please enter a note before saving");return}const fe=ny(ee),qe=fe?null:Ti(ee),Pe=fe?Ol(ee):null;if(!qe&&!Pe){L("Unable to determine entity or location for this note");return}const Be=ee?.characterId??ee?.character_id??"";if(de&&Be&&!E){L("Select which character this note is for");return}_(!0),L("");try{const Te={content:ce,shareType:N,campaignId:n};de&&E&&(Te.characterId=E);const gt=fe?await jg(Pe,ee.id,Te):await qj(qe,ee.id,Te),jt=gt?.data||gt;if(!jt)throw new Error("Note could not be updated");l(Mt=>{const tt=Array.isArray(Mt?.items)?Mt.items.slice():[],ft=jt?.id;if(!ft)return Mt;const Rt=tt.findIndex(Ft=>Ft?.id===ft);if(Rt>=0){const Ft=[...tt];return Ft[Rt]=jt,{items:Ft,loading:!1,error:""}}return Mt}),ue()}catch(Te){console.error("Failed to update note",Te),L(Te.message||"Failed to update note")}finally{_(!1)}},[n,v,N,E,de,ue]),be=u.useCallback(async ee=>{if(!ee?.id||!n||!window.confirm("Are you sure you want to delete this note? This action cannot be undone."))return;const fe=ny(ee),qe=fe?null:Ti(ee),Pe=fe?Ol(ee):null;if(!qe&&!Pe){L("Unable to determine entity or location for this note");return}k(ee.id),L("");try{fe?await Eg(Pe,ee.id,{campaignId:n}):await Pj(qe,ee.id,{campaignId:n}),l(Be=>({items:(Array.isArray(Be?.items)?Be.items.slice():[]).filter(jt=>jt?.id!==ee.id),loading:!1,error:""}))}catch(Be){console.error("Failed to delete note",Be),L(Be.message||"Failed to delete note")}finally{k(null)}},[n]),De=u.useCallback(ee=>{const ce=Bi(ee?.content,ee?.mentions);return ce.length?ce.map((fe,qe)=>{if(fe.type==="mention"){if(fe.locationId){const Te=`${ee?.id||"note"}-mention-${qe}`,gt=fe.locationName||"location";return t.jsxs("span",{className:"note-mention",children:["@",gt,t.jsx(fs,{locationId:fe.locationId,locationName:gt})]},Te)}if(fe.entityId){const Te=`${ee?.id||"note"}-mention-${qe}`,gt=fe.entityName||"entity";return t.jsxs("span",{className:"note-mention",children:["@",gt,t.jsx(Na,{entityId:fe.entityId,entityName:gt})]},Te)}const Pe=fe.locationName||fe.entityName||"mention",Be=`${ee?.id||"note"}-mention-${qe}`;return t.jsxs("span",{className:"note-mention",children:["@",Pe]},Be)}return t.jsx("span",{className:"note-text",children:fe.text},`${ee?.id||"note"}-text-${qe}`)}):null},[]),Me=u.useMemo(()=>Array.isArray(i.items)?[...i.items].sort((ee,ce)=>{const fe=new Date(ee?.created_at||ee?.createdAt||0).getTime(),qe=new Date(ce?.created_at||ce?.createdAt||0).getTime();return Number.isNaN(qe)?-1:Number.isNaN(fe)?1:qe-fe}):[],[i.items]),mt=u.useMemo(()=>{const ee=new Map;return Me.forEach(ce=>{const fe=Ti(ce),qe=Ol(ce),Pe=fe||qe;if(!Pe)return;const Be=fe?NN(ce):jN(ce),Te=qe?"[Location] ":"[Entity] ";ee.has(Pe)||ee.set(Pe,Te+Be)}),Array.from(ee.entries()).map(([ce,fe])=>({id:ce,name:fe})).sort((ce,fe)=>ce.name.localeCompare(fe.name,void 0,{sensitivity:"base"}))},[Me]),ht=u.useMemo(()=>{const ee=new Map;return Me.forEach(ce=>{const fe=ty(ce);if(!fe)return;const qe=wN(ce);ee.has(fe)||ee.set(fe,qe)}),Array.from(ee.entries()).map(([ce,fe])=>({id:ce,name:fe})).sort((ce,fe)=>ce.name.localeCompare(fe.name,void 0,{sensitivity:"base"}))},[Me]),Ct=u.useMemo(()=>{const ee=new Map;return B.forEach(ce=>{ce.id&&ee.set(ce.id,ce.name)}),ee},[B]),At=u.useMemo(()=>{const ee=new Map;return F.forEach(ce=>{ce.id&&ee.set(ce.id,ce.name)}),ee},[F]),we=u.useMemo(()=>{const ee=new Map;return Me.forEach(ce=>{const fe=Jy(ce),qe=eg(ce),Pe=fe||qe;if(!Pe)return;const Be=fe?Iz(ce,Ct)||`Type ${fe.slice(0,8)}`:Lz(ce,At)||`Type ${qe.slice(0,8)}`,Te=qe?"[Location] ":"[Entity] ";ee.has(Pe)||ee.set(Pe,Te+Be)}),Array.from(ee.entries()).map(([ce,fe])=>({id:ce,name:fe})).sort((ce,fe)=>ce.name.localeCompare(fe.name,void 0,{sensitivity:"base"}))},[Me,Ct,At]),st=u.useMemo(()=>Me.filter(ee=>{const ce=Ti(ee),fe=Ol(ee),qe=ce||fe,Pe=ty(ee),Be=Jy(ee),Te=eg(ee),gt=Be||Te;return!(o&&qe!==o||f&&Pe!==f||h&&gt!==h)}),[Me,o,f,h]),lt=u.useCallback(()=>{if(!s?.id)return;const ee=String(s.id),ce=ht.find(fe=>Me.find(Pe=>ty(Pe)===fe.id&&re(Pe))!==void 0);ce?(p(ce.id),d("")):ht.some(fe=>fe.id===ee)&&(p(ee),d(""))},[s?.id,ht,Me,re]),Fe=e?.name??"",Xe=st.length,dt=Me.length,ie=!!(o||f||h);return n?t.jsxs("div",{className:"notes-page",children:[t.jsxs("div",{className:"notes-header",children:[t.jsxs("div",{className:"notes-title",children:[t.jsx("h1",{children:"Entity & Location Notes"}),t.jsxs("p",{children:["Browse the notes created for entities and locations in the"," ",t.jsx("strong",{children:Fe})," campaign, filter by entity/location or author, and jump back into the context of your adventures."]})]}),t.jsx("div",{className:"notes-actions",children:t.jsxs("button",{type:"button",className:"notes-action-button",onClick:P,disabled:i.loading,title:"Reload notes",children:[t.jsx(Vi,{size:16}),t.jsx("span",{children:i.loading?"Loading":"Reload"})]})})]}),t.jsxs("div",{className:"notes-filters",children:[t.jsxs("div",{className:"notes-filter-group",children:[t.jsx("label",{htmlFor:"entity-filter",children:"Entity / Location"}),t.jsxs("select",{id:"entity-filter",value:o,onChange:ee=>d(ee.target.value),disabled:i.loading||mt.length===0,children:[t.jsx("option",{value:"",children:"All entities & locations"}),mt.map(ee=>t.jsx("option",{value:ee.id,children:ee.name},ee.id))]})]}),t.jsxs("div",{className:"notes-filter-group",children:[t.jsx("label",{htmlFor:"author-filter",children:"Author"}),t.jsxs("select",{id:"author-filter",value:f,onChange:ee=>p(ee.target.value),disabled:i.loading||ht.length===0,children:[t.jsx("option",{value:"",children:"All authors"}),ht.map(ee=>t.jsx("option",{value:ee.id,children:ee.name},ee.id))]})]}),t.jsxs("div",{className:"notes-filter-group",children:[t.jsx("label",{htmlFor:"entity-type-filter",children:"Type"}),t.jsxs("select",{id:"entity-type-filter",value:h,onChange:ee=>y(ee.target.value),disabled:i.loading||we.length===0,children:[t.jsx("option",{value:"",children:"All types"}),we.map(ee=>t.jsx("option",{value:ee.id,children:ee.name},ee.id))]})]}),t.jsxs("button",{type:"button",className:"notes-action-button",onClick:()=>{d(""),p(""),y("")},disabled:!ie,children:[t.jsx(Ef,{size:16}),t.jsx("span",{children:"Reset filters"})]}),s?.id&&t.jsx("button",{type:"button",className:"notes-action-button",onClick:lt,title:"Show only my notes",children:t.jsx("span",{children:"My notes"})})]}),t.jsxs("div",{className:"notes-meta",children:[t.jsxs("span",{children:["Showing ",t.jsx("strong",{children:Xe})," of ",t.jsx("strong",{children:dt})," ",dt===1?"note":"notes",ie?" (filtered)":""]}),i.loading&&t.jsx("span",{children:"Loading latest notes"})]}),i.error&&t.jsxs("div",{className:"notes-error",role:"alert",children:[t.jsxs("strong",{children:[t.jsx(ta,{size:18})," Unable to load entity notes"]}),t.jsx("span",{children:i.error})]}),!i.loading&&!i.error&&st.length===0&&t.jsxs("div",{className:"notes-empty",children:[t.jsx("strong",{children:"No notes to show"}),t.jsx("span",{children:dt===0?"No entity or location notes have been shared in this campaign yet.":"Adjust your filters to see more notes."})]}),C&&t.jsxs("div",{className:"notes-error",role:"alert",children:[t.jsxs("strong",{children:[t.jsx(ta,{size:18})," Error"]}),t.jsx("span",{children:C})]}),st.length>0&&t.jsx("div",{className:"notes-list",children:st.map(ee=>{const ce=ny(ee),fe=ce?null:Ti(ee),qe=ce?Ol(ee):null,Pe=String(ee?.shareType||ee?.share_type||"private"),Be=ee?.created_at||ee?.createdAt,Te=Be?new Date(Be):null,gt=Rz(Te),jt=Te&&!Number.isNaN(Te.getTime())?Te.toISOString():"",Mt=wN(ee),tt=ee?.character?.name??"",ft=ce?null:NN(ee),Rt=ce?jN(ee):null,Ft=g===ee?.id,Zt=re(ee),Tt=fe||qe||"";return t.jsx("article",{className:"note-card",children:Ft?t.jsxs("div",{className:"entity-notes-strict-edit-panel",style:{padding:"1rem"},children:[t.jsx(Gl,{value:v,onChange:se,markup:"@[__display__](__id__)",placeholder:kz,className:"entity-note-mentions",inputProps:{className:"entity-notes-strict-textarea","aria-label":"Edit note content",rows:5,required:!0},children:t.jsx(li,{trigger:"@",markup:"@[__display__](__id__)",displayTransform:(We,it)=>`@${it}`,data:Ce,appendSpaceOnAdd:!0})}),t.jsx("p",{style:{marginTop:"0.75rem",marginBottom:"0.5rem",fontWeight:600},children:"Share with"}),t.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"0.5rem",marginBottom:"0.75rem"},children:he.map(We=>t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[t.jsx("input",{type:"radio",name:`entity-note-share-edit-${ee.id}`,value:We.value,checked:N===We.value,onChange:()=>j(We.value),disabled:M}),We.value==="private"?"Private":We.value==="party"?"Share with Party":We.label]},We.value))}),de&&z.length>0&&t.jsxs("div",{style:{marginBottom:"0.75rem"},children:[t.jsx("label",{htmlFor:`edit-character-${ee.id}`,style:{display:"block",marginBottom:"0.25rem",fontWeight:600},children:"Character"}),t.jsx("select",{id:`edit-character-${ee.id}`,value:E,onChange:We=>A(We.target.value),disabled:U||z.length===1,style:{width:"100%",padding:"0.5rem",borderRadius:"8px",border:"1px solid #cbd5f5"},children:z.map(We=>t.jsx("option",{value:We.id,children:We.name},We.id))})]}),C?t.jsxs("div",{className:"notes-error",style:{marginTop:"0.75rem",marginBottom:"0.75rem"},children:[t.jsx(ta,{size:16}),t.jsx("span",{children:C})]}):null,t.jsxs("div",{style:{display:"flex",gap:"0.5rem",marginTop:"0.75rem"},children:[t.jsx("button",{type:"button",className:"notes-action-button",onClick:()=>Le(ee),disabled:M||!v.trim(),children:M?t.jsxs(t.Fragment,{children:[t.jsx(mn,{className:"spin",size:16,style:{animation:"spinner-rotate 1s linear infinite"}}),"Saving"]}):"Save"}),t.jsx("button",{type:"button",className:"notes-action-button",onClick:ue,disabled:M,style:{background:"#64748b"},children:"Cancel"})]})]}):t.jsxs(t.Fragment,{children:[t.jsxs("header",{className:"note-card-header",children:[t.jsx("div",{className:"note-entity-meta",children:t.jsx("h2",{children:ce?qe?t.jsxs("span",{className:"entity-link-with-preview",children:[t.jsx(Yt,{to:`/locations/${qe}`,className:"entity-name-link",children:Rt}),t.jsx(fs,{locationId:qe,locationName:Rt})]}):Rt:fe?t.jsxs("span",{className:"entity-link-with-preview",children:[t.jsx(Yt,{to:`/entities/${fe}`,className:"entity-name-link",children:ft}),t.jsx(Na,{entityId:fe,entityName:ft})]}):ft})}),t.jsx("div",{className:"note-tags",children:t.jsx("span",{className:`note-tag share-${Pe}`,children:Az[Pe]??Pe})})]}),t.jsxs("div",{className:"note-details",children:[t.jsxs("span",{children:["Author: ",Mt]}),tt?t.jsxs("span",{children:["Character: ",tt]}):null,gt?t.jsxs("span",{children:["Created:"," ",t.jsx("time",{dateTime:jt||void 0,children:gt})]}):null]}),t.jsx("div",{className:"note-content",children:De(ee)||t.jsx(Qy,{content:ee?.content,mentions:ee?.mentions,noteId:ee?.id||fe||"note",textClassName:"note-text",mentionClassName:"note-mention"})}),Zt&&t.jsxs("div",{style:{display:"flex",gap:"0.5rem",marginTop:"0.5rem",paddingTop:"0.75rem",borderTop:"1px solid rgba(15, 23, 42, 0.1)"},children:[t.jsxs("button",{type:"button",className:"notes-action-button",onClick:()=>Re(ee),style:{background:"#1e40af",color:"#fff"},children:[t.jsx(Nj,{size:14}),t.jsx("span",{children:"Edit"})]}),t.jsxs("button",{type:"button",className:"notes-action-button",onClick:()=>be(ee),disabled:T===ee.id,style:{background:"#dc2626",color:"#fff"},children:[T===ee.id?t.jsx(mn,{size:14,className:"spin",style:{animation:"spinner-rotate 1s linear infinite"}}):t.jsx(zn,{size:14}),t.jsx("span",{children:T===ee.id?"Deleting":"Delete"})]})]})]})},ee.id??`${Tt}-${jt||"unknown"}`)})})]}):t.jsxs("div",{className:"notes-page",children:[t.jsx("div",{className:"notes-header",children:t.jsxs("div",{className:"notes-title",children:[t.jsx("h1",{children:"Entity & Location Notes"}),t.jsx("p",{children:"Select a campaign from the header to view entity and location notes."})]})}),t.jsxs("div",{className:"notes-empty",children:[t.jsx("strong",{children:"No campaign selected"}),t.jsx("span",{children:"Pick a campaign to explore its shared entity notes."})]})]})}const Oz=(e,n)=>kt.post("/access/bulk/apply",e,n),$z=({worldId:e})=>{if(!e)return Promise.reject(new Error("worldId is required"));const n=new URLSearchParams({worldId:e});return kt.get(`/access/bulk/runs?${n.toString()}`)},Fz=e=>e?kt.get(`/access/bulk/runs/${e}`):Promise.reject(new Error("runId is required")),zz=e=>e?kt.post(`/access/bulk/runs/${e}/revert`):Promise.reject(new Error("runId is required")),C_=e=>{if(!e)return Promise.reject(new Error("worldId is required"));const n=new URLSearchParams({worldId:e});return kt.get(`/access/collections?${n.toString()}`)},Bz=e=>kt.post("/access/collections",e),Uz=(e,n)=>e?kt.put(`/access/collections/${e}`,n):Promise.reject(new Error("Collection id is required")),qz=e=>e?kt.delete(`/access/collections/${e}`):Promise.reject(new Error("Collection id is required")),Pz=e=>e?kt.get(`/access/collections/${e}/entities`):Promise.reject(new Error("Collection id is required")),mr=1e3,ya={NAME:"name",NAME_DESCRIPTION:"nameDescription",ALL_DATA:"allData",ALL_DATA_RELATIONSHIPS:"allDataRelationships"},Wd=[{value:ya.NAME,label:"Name only",description:"Matches entity names only."},{value:ya.NAME_DESCRIPTION,label:"Name & description",description:"Matches entity names and their descriptions."},{value:ya.ALL_DATA,label:"All data",description:"Matches names, descriptions, and visible data fields."},{value:ya.ALL_DATA_RELATIONSHIPS,label:"All data & relationships",description:"Matches every field plus reference values, ideal for relationship lookups."}],EN={[ya.NAME]:"Filter entities by name",[ya.NAME_DESCRIPTION]:"Search names or descriptions",[ya.ALL_DATA]:"Search names, descriptions, and data fields",[ya.ALL_DATA_RELATIONSHIPS]:"Search across data and related entities"},_N=140,Ec=(e,n)=>{if(n==null||typeof n=="number"&&!Number.isFinite(n))return;const i=(n instanceof Date?n.toISOString():String(n)).trim().toLowerCase();i&&e.add(i)},tg=(e,n,s)=>{if(e!=null){if(typeof e=="string"||typeof e=="number"||typeof e=="boolean"){Ec(s,e);return}if(e instanceof Date){Ec(s,e);return}if(Array.isArray(e)){e.forEach(i=>tg(i,n,s));return}n&&typeof e=="object"&&Object.values(e).forEach(i=>tg(i,n,s))}},Hz=(e,n)=>{if(!e)return[];const s=n&&Wd.some(l=>l.value===n)?n:ya.NAME,i=new Set;return Ec(i,e.name),s!==ya.NAME&&Ec(i,e.description),(s===ya.ALL_DATA||s===ya.ALL_DATA_RELATIONSHIPS)&&(Ec(i,e.entityType?.name),e.metadata&&typeof e.metadata=="object"&&tg(e.metadata,s===ya.ALL_DATA_RELATIONSHIPS,i)),Array.from(i)},CN=(e,n="start")=>{if(!e)return null;const s=new Date(e);return Number.isNaN(s.getTime())?null:(n==="end"?s.setHours(23,59,59,999):s.setHours(0,0,0,0),s.getTime())},AN=e=>{if(!e)return"";const n=new Date(e);return Number.isNaN(n.getTime())?"":n.toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric"})},Vz=e=>{if(!e)return"";const n=AN(e.updatedAt||e.updated_at);if(n)return`Updated ${n}`;const s=AN(e.createdAt||e.created_at);return s?`Created ${s}`:""},Yz=e=>{if(!e)return"";const n=e.summary||e.summary_text||e.description||e.system_prompt||e.notes||"",s=typeof n=="string"?n.replace(/\s+/g," ").trim():"";return s?s.length<=_N?s:`${s.slice(0,_N-1).trim()}`:""},mc=({label:e,count:n,options:s=[],selectedValues:i=[],onToggle:l,disabled:o})=>{const d=f=>{o||l(String(f))};return t.jsxs("div",{className:"token-selector",children:[t.jsxs("div",{className:"token-selector__label-row",children:[t.jsx("span",{children:e}),t.jsxs("span",{className:"token-selector__count",children:["(",n,")"]})]}),t.jsx("div",{className:"token-selector__chips",role:"listbox","aria-multiselectable":!0,children:s.length===0?t.jsx("p",{className:"token-selector__empty",children:"No options available."}):s.map(f=>{const p=String(f.id),h=i.includes(p);return t.jsx("button",{type:"button",className:`token-selector__chip ${h?"selected":""}`,onClick:()=>d(p),"aria-pressed":h,disabled:o,children:f.label},p)})})]})},Xr=e=>Array.isArray(e?.data)?e.data:Array.isArray(e)?e:[],ay=(e,n="name")=>e.map(s=>({id:String(s.id??s.value??s),label:s[n]||s.name||s.email||s.id})),TN=e=>{const n=e.filter(s=>s.count>0).map(s=>`${s.count} ${s.label}${s.count===1?"":"s"}`);return n.length===0?"":n.length===1?n[0]:n.length===2?`${n[0]} and ${n[1]}`:`${n.slice(0,-1).join(", ")}, and ${n[n.length-1]}`};function MN(){const{worldId:e,campaignId:n}=Ka(),s=_n(),{user:i}=un(),{selectedCampaign:l,selectedCampaignId:o,setSelectedCampaignId:d,loading:f}=wn(),[p,h]=u.useState(null),[y,g]=u.useState(""),[b,v]=u.useState(!0),[S,N]=u.useState([]),[j,E]=u.useState([]),[A,M]=u.useState([]),[_,T]=u.useState([]),[k,C]=u.useState(!1),[L,z]=u.useState(""),[G,U]=u.useState(""),[X,V]=u.useState(ya.NAME),[R,B]=u.useState(""),[D,O]=u.useState(""),[$,F]=u.useState([]),[H,I]=u.useState(!1),[Y,P]=u.useState(""),[W,le]=u.useState(null),[K,de]=u.useState({readCampaignIds:[],readUserIds:[],readCharacterIds:[],writeCampaignIds:[],writeUserIds:[],description:""}),[Q,he]=u.useState("unchanged"),[re,Ce]=u.useState("unchanged"),[Re,ue]=u.useState(!1),[se,Le]=u.useState("manual"),[be,De]=u.useState([]),[Me,mt]=u.useState(!1),[ht,Ct]=u.useState(""),[At,we]=u.useState(""),[st,lt]=u.useState(null),[Fe,Xe]=u.useState(!1),dt=!!n,ie=n?String(n):"",ee=u.useMemo(()=>!dt||!ie||!o?!1:String(o)===ie,[dt,ie,o]),ce=dt&&ee?l:null,fe=e||ce?.world?.id||"";u.useEffect(()=>{!dt||!ie||String(o||"")!==ie&&d(ie)},[dt,ie,o,d]);const qe=u.useMemo(()=>dt||!p||!i?!1:String(p.created_by)===String(i.id),[dt,p,i]),Pe=u.useMemo(()=>!dt||!ce||!i?.id||!Array.isArray(ce.members)?!1:ce.members.some(Ye=>Ye?.user_id===i.id&&Ye?.role==="dm"),[ce,dt,i]),Be=!!(dt&&ce&&Pe),Te=qe||Be;u.useEffect(()=>{if(!fe||!Te){De([]),Ct(""),we(""),lt(null);return}let Ye=!1;return(async()=>{mt(!0),Ct("");try{const Et=await C_(fe),te=Xr(Et);Ye||De(te)}catch(Et){Ye||(console.error("Failed to load collections",Et),De([]),Ct(Et.message||"Failed to load collections"))}finally{Ye||mt(!1)}})(),()=>{Ye=!0}},[fe,Te]),u.useEffect(()=>{if(dt){if(!ie){g("Campaign id is required to use this tool."),v(!1);return}if(!ce){if(f){v(!0);return}g("Campaign not found or unavailable for your account."),v(!1);return}h(ce.world||null),g(""),v(!1);return}if(!e){g("A world id is required to use the bulk access tool."),v(!1);return}(async()=>{v(!0),g("");try{const Je=await eo(),te=Xr(Je).find(ve=>String(ve.id)===String(e));if(!te){g("World not found or unavailable."),h(null);return}h(te)}catch(Je){console.error("Failed to load worlds",Je),g(Je.message||"Failed to load world data"),h(null)}finally{v(!1)}})()},[ce,f,dt,ie,e]);const gt=u.useCallback(async()=>{if(!(!fe||!Te)){C(!0),z("");try{if(dt&&ce){const[Ye,Je]=await Promise.all([Mc(fe),Cs({campaign_id:ce.id})]);N(Xr(Ye)),E([ce]),M(Xr(Je));const Et=Array.isArray(ce.members)?ce.members.map(te=>({id:String(te.user_id),username:te.user?.username||te.user?.email||te.user_id})):[];T(Et)}else{const[Ye,Je,Et,te]=await Promise.all([Mc(fe),Vc({world_id:fe}),Cs({world_id:fe}),Fg()]);N(Xr(Ye)),E(Xr(Je)),M(Xr(Et)),T(Xr(te))}}catch(Ye){console.error("Failed to load bulk access data",Ye),z(Ye.message||"Unable to load world data")}finally{C(!1)}}},[ce,Te,dt,fe]);u.useEffect(()=>{gt()},[gt]);const jt=u.useMemo(()=>dt?new Set((A||[]).map(Ye=>String(Ye.id))):new Set,[A,dt]),Mt=u.useMemo(()=>{if(!dt)return S;if(!ce)return[];const Ye=String(ce.id);return S.filter(Je=>(Je.read_access??"global")==="global"||(Array.isArray(Je.read_campaign_ids)?Je.read_campaign_ids.map(Ie=>String(Ie)):[]).includes(Ye)?!0:(Array.isArray(Je.read_character_ids)?Je.read_character_ids.map(Ie=>String(Ie)):[]).some(Ie=>jt.has(Ie)))},[ce,jt,S,dt]);u.useEffect(()=>{const Ye=new Set(Mt.map(Je=>Je.id));F(Je=>{const Et=Je.filter(te=>Ye.has(te));return Et.length===Je.length?Je:Et})},[Mt]);const tt=u.useMemo(()=>{const Ye=G.trim().toLowerCase(),Je=CN(R,"start"),Et=CN(D,"end");return Mt.filter(te=>{const ve=te.createdAt??te.created_at??null;if(Je!==null||Et!==null){if(!ve)return!1;const rt=new Date(ve).getTime();if(Number.isNaN(rt)||Je!==null&&rt<Je||Et!==null&&rt>Et)return!1}if(!Ye)return!0;const Ie=Hz(te,X);return Ie.length?Ie.some(rt=>rt.includes(Ye)):!1})},[Mt,G,X,R,D]),ft=u.useMemo(()=>Wd.find(Ye=>Ye.value===X),[X]),Rt=EN[X]||EN[ya.NAME],Ft=Ye=>{const Je=Ye.target.value,Et=Wd.some(te=>te.value===Je);V(Et?Je:ya.NAME)},Zt=()=>{B(""),O("")};u.useEffect(()=>{if(!dt||!ce)return;const Ye=String(ce.id),Je=new Set([Ye]),Et=new Set((_||[]).map(ve=>String(ve.id))),te=new Set((A||[]).map(ve=>String(ve.id)));de(ve=>{const Ie=(zt,Ut)=>zt.filter(dn=>Ut.has(String(dn))),rt=Ie(ve.readCampaignIds,Je),_t=Ie(ve.writeCampaignIds,Je),Lt=Ie(ve.readUserIds,Et),nn=Ie(ve.writeUserIds,Et),Pt=Ie(ve.readCharacterIds,te);return rt.length===ve.readCampaignIds.length&&_t.length===ve.writeCampaignIds.length&&Lt.length===ve.readUserIds.length&&nn.length===ve.writeUserIds.length&&Pt.length===ve.readCharacterIds.length?ve:{...ve,readCampaignIds:rt,writeCampaignIds:_t,readUserIds:Lt,writeUserIds:nn,readCharacterIds:Pt}})},[ce,A,dt,_]);const Tt=$.length,We=Tt>=mr,it=Tt>0;u.useEffect(()=>{Tt===0&&ue(!1)},[Tt]);const bt=Ye=>{P(""),F(Je=>Je.includes(Ye)?Je.filter(Et=>Et!==Ye):Je.length>=mr?(P(`You can only select ${mr} entities at a time.`),Je):[...Je,Ye])},oe=()=>{P(""),F(Ye=>{const Je=new Set(Ye);for(const Et of tt){if(Je.size>=mr)break;Je.add(Et.id)}return Je.size>mr&&P(`Selection capped at ${mr} entities.`),Array.from(Je)})},Ee=()=>{F([]),P(""),se==="collection"&&(we(""),lt(null))},Se=Ye=>{const Je=Ye.target.value;Le(Je),P(""),Je==="manual"?(we(""),lt(null)):F([])},Ve=async Ye=>{const Je=Ye.target.value;if(we(Je),lt(null),P(""),!Je){F([]);return}Xe(!0);try{const Et=await Pz(Je),te=Et?.data||Et,ve=Array.isArray(te?.entityIds)?te.entityIds:[];F(ve),lt({entityIds:ve,entityCount:te?.entityCount??ve.length,totalCount:te?.totalCount??ve.length,truncated:!!te?.truncated}),te?.truncated&&P(`Only the first ${mr} entities were loaded from this collection.`)}catch(Et){console.error("Failed to resolve collection entities",Et),P(Et.message||"Failed to load collection entities"),F([]),lt(null)}finally{Xe(!1)}},xe=Ye=>{const{value:Je}=Ye.target;de(Et=>({...Et,description:Je}))},$e=Ye=>Je=>{const Et=Je.target.value;Ye==="read"?(he(Et),Et==="unchanged"&&de(te=>({...te,readCampaignIds:[],readUserIds:[],readCharacterIds:[]}))):(Ce(Et),Et==="unchanged"&&de(te=>({...te,writeCampaignIds:[],writeUserIds:[]})))},He=Ye=>Je=>{const Et=String(Je);de(te=>{const ve=te[Ye]||[],rt=ve.includes(Et)?ve.filter(_t=>_t!==Et):[...ve,Et];return{...te,[Ye]:rt}})},J=Q==="activated",Z=re==="activated",je=u.useMemo(()=>J?K.readCampaignIds.length+K.readUserIds.length+K.readCharacterIds.length>0:!1,[K,J]),Ne=u.useMemo(()=>Z?K.writeCampaignIds.length+K.writeUserIds.length>0:!1,[K,Z]),pe=J||Z,Ue=u.useMemo(()=>{if(!J)return"";const Ye=TN([{label:"campaign",count:K.readCampaignIds.length},{label:"user",count:K.readUserIds.length},{label:"character",count:K.readCharacterIds.length}]);return Ye?`You will add read access for ${Ye}.`:""},[K,J]),ae=u.useMemo(()=>{if(!Z)return"";const Ye=TN([{label:"campaign",count:K.writeCampaignIds.length},{label:"user",count:K.writeUserIds.length}]);return Ye?`You will add write access for ${Ye}.`:""},[K,Z]),Ke=Te&&$.length>0&&pe&&!H,ot=async Ye=>{if(Ye.preventDefault(),!Te){P("You do not have permission to apply bulk access updates.");return}if(!$.length){P("Select at least one entity to continue.");return}if(!pe){P("Select at least one access type to update.");return}if(J&&!je){P("Add at least one read campaign, character, or user.");return}if(Z&&!Ne){P("Add at least one campaign or user to grant write access.");return}const Je={entityIds:$,readAccess:J?"selective":"unchanged",writeAccess:Z?"selective":"unchanged",readCampaignIds:J?K.readCampaignIds:[],readUserIds:J?K.readUserIds:[],readCharacterIds:J?K.readCharacterIds:[],writeCampaignIds:Z?K.writeCampaignIds:[],writeUserIds:Z?K.writeUserIds:[],description:K.description};I(!0),P(""),le(null);try{const Et=await Oz(Je,{includeCampaignContext:!!(dt&&ce)}),te=Et?.data||Et;le({runId:te.runId,count:te.count})}catch(Et){console.error("Failed to apply bulk access",Et),P(Et.message||"Unable to apply bulk access update")}finally{I(!1)}},St=u.useMemo(()=>dt&&ce?[{id:String(ce.id),label:ce.name}]:ay(j),[ce,j,dt]),me=u.useMemo(()=>ay(_,"username"),[_]),nt=u.useMemo(()=>ay(A),[A]),Ge=u.useMemo(()=>{const Ye=new Map;return S.forEach(Je=>{Ye.set(Je.id,Je)}),Ye},[S]),vt=u.useMemo(()=>!st||!Array.isArray(st.entityIds)?[]:st.entityIds.slice(0,10).map(Ye=>Ge.get(Ye)?.name||Ye),[st,Ge]);if(b)return t.jsx("div",{className:"bulk-access-page",children:t.jsxs("p",{className:"bulk-access-helper",children:[t.jsx(mn,{className:"spin",size:16})," Loading world context"]})});if(y)return t.jsxs("div",{className:"bulk-access-page",children:[t.jsxs("div",{className:"bulk-access-alert error",children:[t.jsx(La,{size:16})," ",y]}),t.jsx("button",{type:"button",className:"link-button",onClick:()=>s(-1),children:"Go back"})]});if(!Te){const Ye=dt?"Only a DM for this campaign can access this tool.":"Only the world owner can access this tool.";return t.jsx("div",{className:"bulk-access-page",children:t.jsxs("div",{className:"bulk-access-alert warning",children:[t.jsx(La,{size:16})," ",Ye]})})}const ct=dt?"Campaign Admin  Access":"World Admin  Manual Access",Nt=dt?ce?.name:p?.name;return t.jsxs("div",{className:"bulk-access-page",children:[t.jsxs("div",{className:"bulk-access-header",children:[t.jsxs("div",{children:[t.jsx("p",{className:"bulk-access-eyebrow",children:ct}),t.jsxs("h1",{children:["Bulk Access Editor  ",Nt||""]})]}),qe&&t.jsx("div",{className:"bulk-access-header-actions",children:t.jsx(Yt,{to:`/worlds/${e}/access/audit`,className:"ghost-button",children:"View audit log"})})]}),t.jsx("p",{className:"bulk-access-helper bulk-access-topline",children:"This tool adds access to selected entities. It does not remove current access."}),Be&&ce&&t.jsxs("div",{className:"bulk-access-context-banner",children:["You are updating access in Campaign: ",t.jsx("strong",{children:ce.name})]}),L&&t.jsxs("div",{className:"bulk-access-alert warning",children:[t.jsx(La,{size:16})," ",L]}),W&&t.jsxs("div",{className:"bulk-access-alert success",children:[t.jsx(jf,{size:16})," Applied access updates to ",W.count," entities  Run ",W.runId,qe&&t.jsx(Yt,{to:`/worlds/${e}/access/audit`,className:"inline-link",children:"Review run"})]}),Y&&t.jsxs("div",{className:"bulk-access-alert error",children:[t.jsx(La,{size:16})," ",Y]}),t.jsxs("div",{className:"bulk-access-grid",children:[t.jsxs("section",{className:"bulk-access-card",children:[t.jsxs("header",{children:[t.jsxs("h2",{children:[t.jsx(Bk,{size:18})," Choose entities (",Tt,"/",mr,")"]}),t.jsxs("div",{className:"bulk-access-entity-actions",children:[!Re&&t.jsx("button",{type:"button",className:"ghost-button",onClick:oe,disabled:We||se!=="manual",children:"Select filtered"}),t.jsx("button",{type:"button",className:"ghost-button",onClick:Ee,children:"Clear selection"}),it&&t.jsx("button",{type:"button",className:"ghost-button",onClick:()=>ue(Ye=>!Ye),children:Re?"Expand":"Collapse"})]})]}),Re?t.jsx("div",{className:"bulk-access-entity-collapsed-summary",children:t.jsxs("p",{children:[t.jsx("strong",{children:Tt})," ",Tt===1?"entity":"entities"," selected."]})}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"bulk-access-selection-mode",children:[t.jsxs("label",{children:[t.jsx("input",{type:"radio",value:"manual",checked:se==="manual",onChange:Se}),"Select manually"]}),t.jsxs("label",{children:[t.jsx("input",{type:"radio",value:"collection",checked:se==="collection",onChange:Se}),"Use collection"]})]}),se==="collection"?t.jsxs("div",{className:"bulk-access-collection-panel",children:[Me&&t.jsxs("p",{className:"bulk-access-helper",children:[t.jsx(mn,{className:"spin",size:16})," Loading collections"]}),!Me&&ht&&t.jsx("p",{className:"bulk-access-helper warning",children:ht}),!Me&&!ht&&be.length===0&&t.jsxs("p",{className:"bulk-access-helper",children:["No collections available.",qe&&!dt&&e&&t.jsxs(t.Fragment,{children:[" ",t.jsx(Yt,{to:`/worlds/${e}/collections`,className:"inline-link",children:"Create one in the collections manager"}),"."]})]}),be.length>0&&t.jsxs("select",{value:At,onChange:Ve,children:[t.jsx("option",{value:"",children:"Select a collection"}),be.map(Ye=>t.jsxs("option",{value:Ye.id,children:[Ye.name,"  ",Ye.entityCount??Ye.entity_ids?.length??0," entities"]},Ye.id))]}),Fe&&t.jsxs("p",{className:"bulk-access-helper",children:[t.jsx(mn,{className:"spin",size:16})," Resolving collection"]}),st&&t.jsxs("div",{className:"bulk-access-collection-preview",children:[t.jsxs("p",{children:[t.jsx("strong",{children:st.entityCount})," entities selected from this collection."]}),st.truncated&&t.jsxs("p",{className:"bulk-access-helper warning",children:["Only the first ",mr," entities can be updated at a time."]}),vt.length>0&&t.jsx("ul",{children:vt.map((Ye,Je)=>t.jsx("li",{children:Ye},`${Ye}-${Je}`))})]}),se==="collection"&&qe&&!dt&&e&&t.jsx(Yt,{to:`/worlds/${e}/collections`,className:"inline-link",children:"Manage collections"})]}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"entity-filter",children:[t.jsxs("div",{className:"entity-filter__row entity-filter__row--search",children:[t.jsxs("div",{className:"entity-filter__input",children:[t.jsx("label",{htmlFor:"bulk-access-entity-search",children:"Search"}),t.jsx("input",{id:"bulk-access-entity-search",type:"text",placeholder:Rt,value:G,onChange:Ye=>U(Ye.target.value)})]}),t.jsxs("div",{className:"entity-filter__scope",children:[t.jsx("label",{htmlFor:"bulk-access-entity-scope",children:"Search scope"}),t.jsx("select",{id:"bulk-access-entity-scope",value:X,onChange:Ft,children:Wd.map(Ye=>t.jsx("option",{value:Ye.value,children:Ye.label},Ye.value))})]})]}),t.jsxs("div",{className:"entity-filter__row entity-filter__dates",children:[t.jsxs("div",{className:"entity-filter__date-field",children:[t.jsx("label",{htmlFor:"bulk-access-created-after",children:"Created after"}),t.jsx("input",{id:"bulk-access-created-after",type:"date",value:R,onChange:Ye=>B(Ye.target.value)})]}),t.jsxs("div",{className:"entity-filter__date-field",children:[t.jsx("label",{htmlFor:"bulk-access-created-before",children:"Created before"}),t.jsx("input",{id:"bulk-access-created-before",type:"date",value:D,onChange:Ye=>O(Ye.target.value)})]}),(R||D)&&t.jsx("button",{type:"button",className:"ghost-button entity-filter__clear-dates",onClick:Zt,children:"Clear dates"})]}),ft?.description&&t.jsx("p",{className:"bulk-access-helper",children:ft.description})]}),t.jsxs("div",{className:"entity-selector-list",children:[k&&t.jsxs("p",{className:"bulk-access-helper",children:[t.jsx(mn,{className:"spin",size:16})," Loading entities"]}),!k&&tt.length===0&&t.jsx("p",{className:"bulk-access-helper",children:dt?"No entities are visible within this campaign context.":"No entities match the current filter."}),!k&&tt.map(Ye=>{const Je=Vz(Ye),Et=Yz(Ye);return t.jsxs("label",{className:"entity-row",children:[t.jsx("input",{type:"checkbox",checked:$.includes(Ye.id),onChange:()=>bt(Ye.id),disabled:We&&!$.includes(Ye.id)}),t.jsxs("div",{className:"entity-row__main",children:[t.jsx("span",{className:"entity-name",children:Ye.name}),t.jsxs("div",{className:"entity-row__meta",children:[Ye.entityType?.name&&t.jsx("span",{className:"entity-type",children:Ye.entityType.name}),Je&&t.jsx("span",{className:"entity-row__meta-text",children:Je})]}),Et&&t.jsx("p",{className:"entity-row__summary",children:Et})]}),t.jsx(Na,{entityId:Ye.id,entityName:Ye.name,className:"entity-row__preview"})]},Ye.id)})]})]})]})]}),t.jsxs("section",{className:"bulk-access-card bulk-access-card--form",children:[t.jsx("header",{children:t.jsx("h2",{children:"Access configuration"})}),t.jsxs("form",{className:"bulk-access-form",onSubmit:ot,children:[t.jsxs("div",{className:"access-section",children:[t.jsxs("div",{className:"access-section__header",children:[t.jsxs("div",{children:[t.jsx("p",{className:"access-section__eyebrow",children:"Step 1"}),t.jsx("h3",{children:"Read access"})]}),t.jsxs("label",{className:"access-mode-select",children:[t.jsx("span",{children:"Mode"}),t.jsxs("select",{value:Q,onChange:$e("read"),children:[t.jsx("option",{value:"unchanged",children:"Unchanged"}),t.jsx("option",{value:"activated",children:"Activated"})]})]})]}),t.jsx("p",{className:"bulk-access-helper access-helper-text",children:"This adds new access. It does not remove current access."}),J&&t.jsxs("div",{className:"access-section__content",children:[t.jsxs("div",{className:"access-section__grid",children:[t.jsx(mc,{label:"Read campaigns",count:K.readCampaignIds.length,options:St,selectedValues:K.readCampaignIds,onToggle:He("readCampaignIds")}),t.jsx(mc,{label:"Read users",count:K.readUserIds.length,options:me,selectedValues:K.readUserIds,onToggle:He("readUserIds")})]}),t.jsx(mc,{label:"Read characters",count:K.readCharacterIds.length,options:nt,selectedValues:K.readCharacterIds,onToggle:He("readCharacterIds")})]})]}),t.jsxs("div",{className:"access-section",children:[t.jsxs("div",{className:"access-section__header",children:[t.jsxs("div",{children:[t.jsx("p",{className:"access-section__eyebrow",children:"Step 2"}),t.jsx("h3",{children:"Write access"})]}),t.jsxs("label",{className:"access-mode-select",children:[t.jsx("span",{children:"Mode"}),t.jsxs("select",{value:re,onChange:$e("write"),children:[t.jsx("option",{value:"unchanged",children:"Unchanged"}),t.jsx("option",{value:"activated",children:"Activated"})]})]})]}),t.jsx("p",{className:"bulk-access-helper access-helper-text",children:"This adds new access. It does not remove current access."}),Z&&t.jsx("div",{className:"access-section__content",children:t.jsxs("div",{className:"access-section__grid",children:[t.jsx(mc,{label:"Write campaigns",count:K.writeCampaignIds.length,options:St,selectedValues:K.writeCampaignIds,onToggle:He("writeCampaignIds")}),t.jsx(mc,{label:"Write users",count:K.writeUserIds.length,options:me,selectedValues:K.writeUserIds,onToggle:He("writeUserIds")})]})})]}),t.jsxs("label",{className:"bulk-access-description",children:["Description (optional)",t.jsx("textarea",{name:"description",value:K.description,onChange:xe,rows:1,placeholder:"Explain why this access change was applied"})]}),t.jsxs("div",{className:"bulk-access-summary",children:[Ue&&t.jsx("p",{children:Ue}),ae&&t.jsx("p",{children:ae}),!Ue&&!ae&&t.jsx("p",{className:"bulk-access-helper",children:"No access changes selected yet."}),!pe&&t.jsx("p",{className:"bulk-access-helper warning",children:"Select at least one access type to update."}),J&&!je&&t.jsx("p",{className:"bulk-access-helper warning",children:"Add at least one read audience."}),Z&&!Ne&&t.jsx("p",{className:"bulk-access-helper warning",children:"Add at least one write audience."})]}),t.jsxs("div",{className:"bulk-access-footer",children:[t.jsxs("div",{className:"bulk-access-footer__selection-info",children:[t.jsx("strong",{children:Tt})," ",Tt===1?"entity":"entities"," selected"]}),t.jsx("button",{type:"submit",className:"primary-button",disabled:!Ke||H,children:H?t.jsxs(t.Fragment,{children:[t.jsx(mn,{className:"spin",size:16})," Applying"]}):"Confirm and Apply"})]})]})]})]})]})}const kN=e=>Array.isArray(e?.data)?e.data:Array.isArray(e)?e:[],RN=e=>{if(!e)return"";try{return new Date(e).toLocaleString()}catch{return e}},Os=(e=[])=>!Array.isArray(e)||e.length===0?"":e.join(", ");function Gz(){const{worldId:e}=Ka(),n=_n(),{user:s}=un(),[i,l]=u.useState(null),[o,d]=u.useState(""),[f,p]=u.useState(!0),[h,y]=u.useState([]),[g,b]=u.useState(!1),[v,S]=u.useState(""),[N,j]=u.useState(null),[E,A]=u.useState(!1),[M,_]=u.useState(""),[T,k]=u.useState(!1),[C,L]=u.useState(""),z=u.useMemo(()=>!i||!s?!1:String(i.created_by)===String(s.id),[i,s]);u.useEffect(()=>{if(!e){d("Missing world id"),p(!1);return}(async()=>{p(!0),d("");try{const D=await eo(),$=kN(D).find(F=>String(F.id)===String(e));if(!$){d("World not found or unavailable"),l(null);return}l($)}catch(D){console.error("Failed to load worlds",D),d(D.message||"Unable to load world data"),l(null)}finally{p(!1)}})()},[e]);const G=u.useCallback(async B=>{if(B){S(B),A(!0),_("");try{const D=await Fz(B),O=D?.data||D;j(O)}catch(D){console.error("Failed to load run detail",D),_(D.message||"Unable to load run details"),j(null)}finally{A(!1)}}},[]),U=u.useCallback(async()=>{if(!(!e||!z)){b(!0),_("");try{const B=await $z({worldId:e}),D=kN(B);if(y(D),D.length===0){j(null),S("");return}(!v||!D.some(O=>O.id===v))&&await G(D[0].id)}catch(B){console.error("Failed to load bulk runs",B),_(B.message||"Unable to load audit runs"),y([])}finally{b(!1)}}},[G,z,v,e]);u.useEffect(()=>{U()},[U]);const X=async()=>{if(!(!v||!window.confirm("Revert this entire run? This cannot be undone."))){k(!0),_(""),L("");try{const B=await zz(v),D=B?.data||B;L(`Run ${D.runId} reverted successfully.`),await U(),await G(v)}catch(B){console.error("Failed to revert run",B),_(B.message||"Unable to revert run")}finally{k(!1)}}},V=B=>B?.reverted?"Reverted":"Active",R=(B,D,O)=>t.jsxs("div",{className:"audit-diff-row",children:[t.jsx("span",{className:"audit-diff-label",children:B}),t.jsxs("div",{className:"audit-diff-values",children:[t.jsx("span",{className:"old",children:D}),t.jsx(gj,{size:14}),t.jsx("span",{className:"new",children:O})]})]},B);return f?t.jsx("div",{className:"bulk-audit-page",children:t.jsxs("p",{className:"bulk-access-helper",children:[t.jsx(mn,{className:"spin",size:16})," Loading world context"]})}):o?t.jsxs("div",{className:"bulk-audit-page",children:[t.jsxs("div",{className:"bulk-access-alert error",children:[t.jsx(La,{size:16})," ",o]}),t.jsx("button",{type:"button",className:"link-button",onClick:()=>n(-1),children:"Go back"})]}):z?t.jsxs("div",{className:"bulk-audit-page",children:[t.jsxs("div",{className:"bulk-access-header",children:[t.jsxs("div",{children:[t.jsx("p",{className:"bulk-access-eyebrow",children:"World Admin  Access Audit"}),t.jsxs("h1",{children:["Bulk Access Runs  ",i?.name]})]}),t.jsx("div",{className:"bulk-access-header-actions",children:t.jsx(Yt,{to:`/worlds/${e}/access/bulk`,className:"ghost-button",children:"Back to editor"})})]}),M&&t.jsxs("div",{className:"bulk-access-alert error",children:[t.jsx(La,{size:16})," ",M]}),C&&t.jsxs("div",{className:"bulk-access-alert success",children:[t.jsx(Ej,{size:16})," ",C]}),t.jsxs("div",{className:"bulk-audit-grid",children:[t.jsxs("section",{className:"bulk-access-card",children:[t.jsxs("header",{children:[t.jsxs("h2",{children:[t.jsx(vj,{size:18})," Audit runs (",h.length,")"]}),t.jsx("button",{type:"button",className:"ghost-button",onClick:U,disabled:g,children:g?t.jsxs(t.Fragment,{children:[t.jsx(mn,{className:"spin",size:14})," Refreshing"]}):"Refresh"})]}),t.jsxs("div",{className:"audit-run-list",children:[g&&t.jsxs("p",{className:"bulk-access-helper",children:[t.jsx(mn,{className:"spin",size:16})," Loading runs"]}),!g&&h.length===0&&t.jsx("p",{className:"bulk-access-helper",children:"No bulk access runs have been recorded for this world."}),!g&&h.map(B=>t.jsxs("button",{type:"button",className:`audit-run-row ${v===B.id?"active":""}`,onClick:()=>G(B.id),children:[t.jsxs("div",{children:[t.jsxs("p",{className:"audit-run-title",children:["Run ",B.id]}),t.jsxs("p",{className:"audit-run-meta",children:[RN(B.createdAt||B.created_at),"  ",B.change_count||B.entity_count||0," entities"]}),t.jsxs("p",{className:"audit-run-meta",children:[B.campaignContext?.name?`Campaign  ${B.campaignContext.name}`:"Scope  World"," ",B.role_used==="dm"?" DM run":" Owner run"]})]}),t.jsx("span",{className:`status-pill ${B.reverted?"reverted":"active"}`,children:V(B)})]},B.id))]})]}),t.jsxs("section",{className:"bulk-access-card",children:[t.jsxs("header",{children:[t.jsx("h2",{children:"Run details"}),N&&t.jsx("button",{type:"button",className:"ghost-button",onClick:X,disabled:N.reverted||T,children:T?t.jsxs(t.Fragment,{children:[t.jsx(mn,{className:"spin",size:14})," Reverting"]}):t.jsxs(t.Fragment,{children:[t.jsx(Vi,{size:14})," Revert run"]})})]}),!N&&t.jsx("p",{className:"bulk-access-helper",children:"Select a run to see the access changes."}),E&&t.jsxs("p",{className:"bulk-access-helper",children:[t.jsx(mn,{className:"spin",size:16})," Loading details"]}),N&&!E&&t.jsxs("div",{className:"audit-detail",children:[t.jsxs("div",{className:"audit-detail-meta",children:[t.jsxs("p",{children:[t.jsx("strong",{children:"Status:"})," ",N.reverted?"Reverted":"Active"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"User:"})," ",N.actor?.username||"Unknown user"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"User role:"})," ",N.role_used==="dm"?"Campaign DM":"World owner"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Scope:"})," ",N.campaignContext?.name||"World-wide"]}),t.jsxs("p",{children:[t.jsx("strong",{children:"Created:"})," ",RN(N.createdAt||N.created_at)]}),N.description&&t.jsxs("p",{children:[t.jsx("strong",{children:"Description:"})," ",N.description]})]}),t.jsx("div",{className:"audit-changes",children:N.changes?.map(B=>{const D=B.entity?.name||B.entity_id;return t.jsxs("div",{className:"audit-change-card",children:[t.jsxs("div",{className:"audit-change-header",children:[t.jsx("p",{className:"audit-change-title",children:D}),t.jsxs("span",{className:"audit-change-subtitle",children:["Entity ",B.entity_id]})]}),t.jsxs("div",{className:"audit-change-body",children:[R("Read access",B.old_read_access,B.entity?.read_access||""),R("Write access",B.old_write_access,B.entity?.write_access||""),R("Read campaigns",Os(B.old_read_campaign_names!==void 0?B.old_read_campaign_names:B.old_read_campaign_ids),Os(B.entity?.read_campaign_names!==void 0?B.entity.read_campaign_names:B.entity?.read_campaign_ids)),R("Read users",Os(B.old_read_user_names!==void 0?B.old_read_user_names:B.old_read_user_ids),Os(B.entity?.read_user_names!==void 0?B.entity.read_user_names:B.entity?.read_user_ids)),R("Read characters",Os(B.old_read_character_ids),Os(B.entity?.read_character_ids)),R("Write campaigns",Os(B.old_write_campaign_names!==void 0?B.old_write_campaign_names:B.old_write_campaign_ids),Os(B.entity?.write_campaign_names!==void 0?B.entity.write_campaign_names:B.entity?.write_campaign_ids)),R("Write users",Os(B.old_write_user_names!==void 0?B.old_write_user_names:B.old_write_user_ids),Os(B.entity?.write_user_names!==void 0?B.entity.write_user_names:B.entity?.write_user_ids))]})]},B.id)})})]})]})]})]}):t.jsx("div",{className:"bulk-audit-page",children:t.jsxs("div",{className:"bulk-access-alert warning",children:[t.jsx(La,{size:16})," Only the world owner can view audit runs."]})})}const hc=1e3,sy=e=>Array.isArray(e?.data)?e.data:Array.isArray(e)?e:[],ry={name:"",description:"",shared:!1,entityIds:[]};function Wz(){const{worldId:e}=Ka(),n=_n(),{user:s,sessionReady:i}=un(),[l,o]=u.useState(null),[d,f]=u.useState(!0),[p,h]=u.useState(""),[y,g]=u.useState(!1),[b,v]=u.useState([]),[S,N]=u.useState([]),[j,E]=u.useState(""),[A,M]=u.useState("view"),[_,T]=u.useState(""),[k,C]=u.useState(ry),[L,z]=u.useState(!1),[G,U]=u.useState(""),[X,V]=u.useState(""),[R,B]=u.useState(!1),[D,O]=u.useState(!1),[$,F]=u.useState(!1),[H,I]=u.useState(null),[Y,P]=u.useState(!1),W=u.useMemo(()=>{if(!l||!s)return!1;const Fe=l.created_by||l.creator?.id||l.owner?.id||l.owner_id||null;return Fe&&s.id&&String(Fe)===String(s.id)},[l,s]),le=u.useCallback(async()=>{if(e)try{const Fe=await C_(e),Xe=sy(Fe);v(Xe)}catch(Fe){console.error("Failed to load collections",Fe),h(Fe.message||"Failed to load collections")}},[e]),K=u.useCallback(async()=>{if(e)try{const Fe=await Mc(e),Xe=sy(Fe);N(Xe)}catch(Fe){console.error("Failed to load entities for world",Fe),h(Fe.message||"Failed to load entities for this world")}},[e]);u.useEffect(()=>{if(!i||!e)return;(async()=>{f(!0),h(""),g(!1),o(null);try{const Xe=await eo(),ie=sy(Xe).find(ce=>String(ce.id)===String(e));if(!ie){h("World not found or unavailable");return}o(ie);const ee=ie.created_by||ie.creator?.id||ie.owner?.id||ie.owner_id||null;if(!s||!ee||String(ee)!==String(s.id)){g(!0);return}await Promise.all([le(),K()])}catch(Xe){console.error("Failed to load collections manager",Xe),h(Xe.message||"Failed to load collections manager")}finally{f(!1)}})()},[le,K,i,s,e]);const de=Fe=>Xe=>{const dt=Fe==="shared"?Xe.target.checked:Xe.target.value;C(ie=>({...ie,[Fe]:dt})),z(!0),U(""),V("")},Q=Fe=>{U(""),V(""),C(Xe=>{const dt=new Set(Xe.entityIds||[]);if(dt.has(Fe))dt.delete(Fe);else{if(dt.size>=hc)return U(`Collections can include up to ${hc} entities.`),Xe;dt.add(Fe)}return z(!0),{...Xe,entityIds:Array.from(dt)}})},he=u.useMemo(()=>{if(!j)return S;const Fe=j.toLowerCase();return S.filter(Xe=>(Xe.name||"").toLowerCase().includes(Fe))},[S,j]),re=u.useMemo(()=>[...b].sort((Fe,Xe)=>Fe.shared&&!Xe.shared?-1:Xe.shared&&!Fe.shared?1:(Fe.name||"").localeCompare(Xe.name||"",void 0,{sensitivity:"base"})),[b]),Ce=u.useCallback(()=>{T(""),C(ry),M("view"),z(!1),U(""),V("")},[]),Re=u.useCallback(Fe=>{Fe&&(T(Fe.id),C({name:Fe.name||"",description:Fe.description||"",shared:!!Fe.shared,entityIds:Array.isArray(Fe.entityIds)?Fe.entityIds:[]}),M("edit"),z(!1),U(""),V(""))},[]),ue=Fe=>{if(L){I(Fe),F(!0);return}se(Fe)},se=Fe=>{F(!1),I(null),Fe&&(Fe.type==="select"?Re(Fe.payload):Fe.type==="create"?(M("create"),T(""),C(ry),z(!1),U(""),V("")):Fe.type==="close"&&Ce())},Le=Fe=>{ue({type:"select",payload:Fe,label:Fe.name})},be=()=>{ue({type:"create",label:"start a new collection"})},De=()=>{ue({type:"close",label:"leave this editor"})},Me=()=>{F(!1),I(null)},mt=()=>{se(H)},ht=u.useCallback(async()=>{if(!e)return U("A world id is required to save this collection."),!1;if(!k.name.trim())return U("Name is required."),!1;if(k.entityIds.length>hc)return U(`Collections can include up to ${hc} entities.`),!1;const Fe={worldId:e,name:k.name.trim(),description:k.description,shared:k.shared,entityIds:k.entityIds};B(!0),U(""),V("");try{let Xe;A==="edit"&&_?Xe=await Uz(_,Fe):Xe=await Bz(Fe);const dt=Xe?.data||Xe;return dt?(v(ie=>{const ee=ie.findIndex(ce=>ce.id===dt.id);if(ee>=0){const ce=[...ie];return ce[ee]=dt,ce}return[...ie,dt]}),Re(dt),M("edit"),V("Collection saved successfully."),z(!1)):await le(),!0}catch(Xe){return console.error("Failed to save collection",Xe),U(Xe.message||"Failed to save collection"),!1}finally{B(!1)}},[Re,k,le,A,_,e]),Ct=async Fe=>{Fe.preventDefault(),await ht()},At=async()=>{if(_&&confirm("Delete this collection? This cannot be undone.")){O(!0),U(""),V("");try{await qz(_),v(Fe=>Fe.filter(Xe=>Xe.id!==_)),Ce(),V("Collection deleted.")}catch(Fe){console.error("Failed to delete collection",Fe),U(Fe.message||"Failed to delete collection")}finally{O(!1)}}},we=async()=>{P(!0);const Fe=await ht();P(!1),Fe&&se(H)};if(u.useEffect(()=>{const Fe=Xe=>{L&&(Xe.preventDefault(),Xe.returnValue="")};return window.addEventListener("beforeunload",Fe),()=>window.removeEventListener("beforeunload",Fe)},[L]),!i)return t.jsx("p",{className:"collections-helper",children:"Restoring session"});if(!e)return t.jsx("p",{className:"collections-helper",children:"World id is required."});if(d)return t.jsx("div",{className:"collections-page",children:t.jsxs("p",{className:"collections-helper",children:[t.jsx(mn,{size:16,className:"spin"})," Loading collections"]})});if(p)return t.jsxs("div",{className:"collections-page",children:[t.jsxs("div",{className:"collections-alert error",children:[t.jsx(La,{size:16})," ",p]}),t.jsx("button",{type:"button",className:"link-button",onClick:()=>n(-1),children:"Go back"})]});if(y||!W)return t.jsx("div",{className:"collections-page",children:t.jsxs("div",{className:"collections-alert warning",children:[t.jsx(La,{size:16})," Only the world owner can manage collections."]})});const st=l?.name||"",lt=k.entityIds.length;return t.jsxs("div",{className:"collections-page",children:[t.jsxs("div",{className:"collections-header",children:[t.jsxs("div",{children:[t.jsx("p",{className:"collections-eyebrow",children:"World Admin  Collections"}),t.jsx("h1",{children:st})]}),t.jsx("div",{className:"collections-header-actions",children:t.jsx("button",{type:"button",className:"primary-button",onClick:be,children:"New collection"})})]}),X&&t.jsxs("div",{className:"collections-alert success",children:[t.jsx(jf,{size:16})," ",X]}),G&&t.jsxs("div",{className:"collections-alert error",children:[t.jsx(La,{size:16})," ",G]}),t.jsxs("div",{className:"collections-grid",children:[t.jsxs("section",{className:"collections-card",children:[t.jsxs("header",{children:[t.jsx("h2",{children:"Collections"}),t.jsxs("p",{className:"collections-helper",children:[b.length," saved  Shared sets are available to campaign DMs"]})]}),t.jsx("div",{className:"collections-table-wrapper",children:re.length===0?t.jsx("p",{className:"collections-helper",children:"No collections yet. Create one to get started."}):t.jsxs("table",{className:"collections-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Name"}),t.jsx("th",{children:"Shared"}),t.jsx("th",{children:"Entities"}),t.jsx("th",{children:"Updated"})]})}),t.jsx("tbody",{children:re.map(Fe=>{const Xe=_===Fe.id;return t.jsxs("tr",{className:Xe?"active":"",onClick:()=>Le(Fe),children:[t.jsxs("td",{children:[t.jsx("span",{className:"collection-name",children:Fe.name}),Fe.description&&t.jsx("span",{className:"collection-description",children:Fe.description})]}),t.jsx("td",{children:Fe.shared?t.jsxs("span",{className:"shared-chip",children:[t.jsx(_j,{size:14})," Shared"]}):t.jsx("span",{className:"shared-chip private",children:"Owner only"})}),t.jsx("td",{children:Fe.entityCount??Fe.entity_ids?.length??0}),t.jsx("td",{children:Fe.updatedAt?new Date(Fe.updatedAt).toLocaleString():""})]},Fe.id)})})]})})]}),t.jsx("section",{className:"collections-card",children:A==="view"&&!_?t.jsx("div",{className:"collections-placeholder",children:t.jsx("p",{children:"Select a collection to edit or create a new one."})}):t.jsxs("form",{className:"collections-form",onSubmit:Ct,children:[t.jsxs("header",{children:[t.jsx("h2",{children:A==="edit"?"Edit collection":"New collection"}),t.jsxs("p",{className:"collections-helper",children:[lt,"/",hc," entities selected"]})]}),t.jsxs("label",{children:["Name",t.jsx("input",{type:"text",value:k.name,onChange:de("name"),required:!0})]}),t.jsxs("label",{children:["Description (optional)",t.jsx("textarea",{value:k.description,onChange:de("description"),rows:3})]}),t.jsxs("label",{className:"checkbox-label",children:[t.jsx("input",{type:"checkbox",checked:k.shared,onChange:de("shared")}),"Share with DMs in this world"]}),t.jsxs("div",{className:"collections-entity-picker",children:[t.jsxs("div",{className:"collections-entity-toolbar",children:[t.jsx("span",{children:"Entities"}),t.jsx("input",{type:"text",placeholder:"Filter by name",value:j,onChange:Fe=>E(Fe.target.value)})]}),t.jsx("div",{className:"collections-entity-list",children:he.length===0?t.jsx("p",{className:"collections-helper",children:"No entities match this filter."}):t.jsx("ul",{children:he.map(Fe=>{const Xe=k.entityIds.includes(Fe.id);return t.jsx("li",{children:t.jsxs("label",{children:[t.jsx("input",{type:"checkbox",checked:Xe,onChange:()=>Q(Fe.id)}),t.jsx("span",{className:"entity-name",children:Fe.name}),t.jsx("span",{className:"entity-type",children:Fe.entityType?.name||""})]})},Fe.id)})})})]}),t.jsxs("div",{className:"collections-form-actions",children:[t.jsx("button",{type:"submit",className:"primary-button",disabled:R,children:R?"Saving":"Save collection"}),A==="edit"&&t.jsx("button",{type:"button",className:"ghost-button",onClick:At,disabled:D,children:D?"Deleting":"Delete"}),t.jsx("button",{type:"button",className:"ghost-button",onClick:De,children:"Close"})]})]})})]}),t.jsx(_1,{open:$,destinationLabel:H?.label||"",saving:Y,onSaveAndContinue:we,onContinueWithoutSaving:mt,onStay:Me})]})}function Xz(){const e=Vs();if(!e)throw new Error("Missing or invalid token");return{"Content-Type":"application/json",Authorization:`Bearer ${e}`}}async function Kz(e,n="request"){if(e.status===401)throw new Error("Unauthorized");if(!e.ok){const s=await e.json().catch(()=>({message:"Unknown error"}));throw new Error(s.message||`Failed to ${n}`)}return e.json()}async function Zz(e,n){const s=await fetch(`${sn}/auth/change-password`,{method:"POST",headers:Xz(),body:JSON.stringify({currentPassword:e,newPassword:n})});return Kz(s,"change password")}function Qz(){const[e,n]=u.useState(""),[s,i]=u.useState(""),[l,o]=u.useState(""),[d,f]=u.useState(""),[p,h]=u.useState(""),[y,g]=u.useState(!1),b=async v=>{v.preventDefault(),f(""),h(""),g(!0);try{if(!e||!s||!l){f("All fields are required"),g(!1);return}if(s.length<6){f("New password must be at least 6 characters long"),g(!1);return}if(s!==l){f("New password and confirmation do not match"),g(!1);return}await Zz(e,s),h("Password changed successfully"),n(""),i(""),o("")}catch(S){f(S.message||"Failed to change password. Please try again.")}finally{g(!1)}};return t.jsx("div",{className:"settings-page",children:t.jsxs("div",{className:"settings-container",children:[t.jsxs("div",{className:"settings-header",children:[t.jsx("h1",{className:"settings-title",children:"Security"}),t.jsx("p",{className:"settings-subtitle",children:"Manage your account security"})]}),t.jsxs("div",{className:"settings-section",children:[t.jsx("h2",{className:"settings-section-title",children:"Change Password"}),t.jsx("p",{className:"settings-section-description",children:"Enter your current password and choose a new password to update your account security."}),t.jsxs("form",{onSubmit:b,children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"current-password",children:"Current Password"}),t.jsx("input",{id:"current-password",type:"password",value:e,onChange:v=>n(v.target.value),placeholder:"Enter current password",required:!0,disabled:y})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"new-password",children:"New Password"}),t.jsx("input",{id:"new-password",type:"password",value:s,onChange:v=>i(v.target.value),placeholder:"Enter new password (minimum 6 characters)",required:!0,minLength:6,disabled:y})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"confirm-password",children:"Confirm New Password"}),t.jsx("input",{id:"confirm-password",type:"password",value:l,onChange:v=>o(v.target.value),placeholder:"Confirm new password",required:!0,disabled:y})]}),d&&t.jsx("p",{className:"error-msg",children:d}),p&&t.jsx("p",{className:"success-msg",children:p}),t.jsx("button",{type:"submit",disabled:y,className:"settings-submit-btn",children:y?"Changing password...":"Change Password"})]})]})]})})}const Jz=[{value:"",label:"All types"},{value:"entity_comment",label:"Entity comments"},{value:"entity_mention_entity_note",label:"Entity mentions (notes)"},{value:"entity_mention_session_note",label:"Entity mentions (sessions)"},{value:"session_note_added",label:"Session notes"},{value:"session_note_updated",label:"Session notes"},{value:"request_note_added",label:"Feature/Bug notes"},{value:"request_status_changed",label:"Feature/Bug status"},{value:"request_assigned",label:"Feature/Bug assignments"}],eB=e=>{const{type:n,metadata:s={}}=e;switch(n){case"entity_comment":return`${s.author_name||"Someone"} commented on ${s.entity_name||"an entity"}`;case"entity_mention_entity_note":return`${s.author_name||"Someone"} mentioned ${s.related_entity_name||"an entity"} in a note`;case"entity_mention_session_note":return`${s.author_name||"Someone"} mentioned ${s.related_entity_name||"an entity"} in a session note`;case"session_note_added":return`${s.author_name||"Someone"} created a session note${s.campaign_name?` for ${s.campaign_name}`:""}: ${s.session_title||"Untitled"}`;case"session_note_updated":return`${s.author_name||"Someone"} updated a session note${s.campaign_name?` for ${s.campaign_name}`:""}: ${s.session_title||"Untitled"}`;case"request_note_added":return`${s.author_name||"Someone"} added a note to "${s.request_title||"a feature/bug"}"`;case"request_status_changed":return`Status changed for "${s.request_title||"a feature/bug"}"`;case"request_assigned":return`You were assigned to "${s.request_title||"a feature/bug"}"`;default:return"New notification"}},tB=e=>{if(!e)return"";const n=new Date(e);if(Number.isNaN(n.getTime()))return"";const i=new Date-n,l=Math.floor(i/6e4),o=Math.floor(i/36e5),d=Math.floor(i/864e5);return l<1?"Just now":l<60?`${l}m ago`:o<24?`${o}h ago`:d<7?`${d}d ago`:n.toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric"})};function nB(){const{notifications:e,markRead:n,markAllRead:s,refresh:i}=$j(),{selectedCampaignId:l,campaigns:o,setSelectedCampaignId:d}=wn(),f=_n(),[p,h]=u.useState(!1),[y,g]=u.useState([]),[b,v]=u.useState(1),[S,N]=u.useState(!0),[j,E]=u.useState(""),[A,M]=u.useState(""),[_,T]=u.useState(l||""),[k,C]=u.useState({open:!1,notification:null}),L=async(O=1,$=!1)=>{h(!0);try{const F={page:O,limit:50};j==="unread"?F.read="false":j==="read"&&(F.read="true"),A&&(F.type=A),_&&(F.campaignId=_);const H=await Dj(F),I=Array.isArray(H?.data)?H.data:[],Y=H?.pagination||{};g($?P=>[...P,...I]:I),N(Y.page<Y.pages)}catch(F){console.error("Failed to load notifications",F)}finally{h(!1)}};u.useEffect(()=>{L(1,!1)},[j,A,_]);const z=async O=>{try{await n(O.id),g($=>$.map(F=>F.id===O.id?{...F,read:!0,readAt:new Date().toISOString()}:F))}catch($){console.error("Failed to mark notification read",$)}},G=async()=>{try{const O={};_&&(O.campaignId=_),A&&(O.type=A),await s(O),i(),L(b,!1)}catch(O){console.error("Failed to mark all notifications read",O)}},U=O=>{if(O.actionUrl)f(O.actionUrl);else{const{type:$,metadata:F={}}=O;if($==="entity_comment"||$==="entity_mention_entity_note"){const H=F.entity_id||F.related_entity_id,I=O.campaignId||O.campaign?.id||_;H&&f(`/entities/${H}${I?`?campaignId=${I}`:""}#notes`)}else if($==="session_note_added"||$==="session_note_updated"||$==="entity_mention_session_note"){const H=O.campaignId||O.campaign?.id||F.target_id||_;f(`/notes/session${H?`?campaignId=${H}`:""}`)}else if($==="request_note_added"||$==="request_status_changed"||$==="request_assigned"){const H=F.request_id||F.requestId;f(H?`/requests/${H}`:"/requests")}}},X=async O=>{O.read||await z(O);const $=O.campaignId||O.campaign?.id||"";if($&&$!==(l||"")){C({open:!0,notification:O});return}U(O)},V=()=>{const{notification:O}=k;if(!O)return;const $=O.campaignId||O.campaign?.id||"";$&&d($),C({open:!1,notification:null}),setTimeout(()=>{U(O)},100)},R=()=>{C({open:!1,notification:null})},B=y.filter(O=>!O.read).length,D=u.useMemo(()=>[{value:"",label:"All campaigns"},...(o||[]).map(O=>({value:O.id,label:O.name}))],[o]);return t.jsxs("div",{className:"notification-list-page",children:[t.jsxs("div",{className:"notification-list-header",children:[t.jsx("h1",{children:"Notifications"}),t.jsx("div",{className:"notification-list-actions",children:B>0&&t.jsxs("button",{type:"button",className:"notification-list-mark-all-read",onClick:G,disabled:p,children:[t.jsx(_M,{size:18}),"Mark all read"]})})]}),t.jsxs("div",{className:"notification-list-filters",children:[t.jsxs("select",{className:"notification-list-filter",value:j,onChange:O=>{E(O.target.value),v(1)},children:[t.jsx("option",{value:"",children:"All"}),t.jsx("option",{value:"unread",children:"Unread"}),t.jsx("option",{value:"read",children:"Read"})]}),t.jsx("select",{className:"notification-list-filter",value:A,onChange:O=>{M(O.target.value),v(1)},children:Jz.map(O=>t.jsx("option",{value:O.value,children:O.label},O.value))}),t.jsx("select",{className:"notification-list-filter",value:_,onChange:O=>{T(O.target.value),v(1)},children:D.map(O=>t.jsx("option",{value:O.value,children:O.label},O.value))})]}),t.jsxs("div",{className:"notification-list-content",children:[p&&y.length===0?t.jsx("div",{className:"notification-list-empty",children:"Loading..."}):y.length===0?t.jsxs("div",{className:"notification-list-empty",children:[t.jsx("p",{children:"No notifications found."}),t.jsx("p",{className:"notification-list-empty-hint",children:"You're all caught up!"})]}):t.jsx("div",{className:"notification-list-items",children:y.map(O=>t.jsxs("div",{className:`notification-list-item ${O.read?"read":"unread"}`,onClick:()=>X(O),children:[t.jsxs("div",{className:"notification-list-item-content",children:[t.jsxs("div",{className:"notification-list-item-header",children:[t.jsx("p",{className:"notification-list-item-message",children:eB(O)}),!O.read&&t.jsx("div",{className:"notification-list-item-dot"})]}),t.jsxs("div",{className:"notification-list-item-meta",children:[t.jsx("span",{className:"notification-list-item-time",children:tB(O.createdAt)}),O.campaign&&t.jsx("span",{className:"notification-list-item-campaign",children:O.campaign.name})]})]}),!O.read&&t.jsx("button",{type:"button",className:"notification-list-item-mark-read",onClick:$=>{$.stopPropagation(),z(O)},title:"Mark as read",children:t.jsx(bj,{size:16})})]},O.id))}),S&&t.jsx("div",{className:"notification-list-load-more",children:t.jsx("button",{type:"button",onClick:()=>{const O=b+1;v(O),L(O,!0)},disabled:p,children:p?"Loading...":"Load more"})})]}),t.jsx(Fj,{open:k.open,campaignName:k.notification?.campaign?.name||"",onSwitch:V,onCancel:R})]})}function aB(){const{selectedCampaignId:e,campaigns:n}=wn(),[s,i]=u.useState([]),[l,o]=u.useState(!1),[d,f]=u.useState(e||""),[p,h]=u.useState(null),y=async()=>{o(!0);try{const S=await e4(d||void 0),N=Array.isArray(S?.data)?S.data:[];i(N)}catch(S){console.error("Failed to load followed entities",S)}finally{o(!1)}};u.useEffect(()=>{y()},[d]);const g=async(S,N)=>{if(!(!S||!N||p===S)){h(S);try{await E1(S,N),i(j=>j.filter(E=>!(E.entityId===S&&E.campaignId===N)))}catch(j){console.error("Failed to unfollow entity",j)}finally{h(null)}}},b=u.useMemo(()=>[{value:"",label:"All campaigns"},...(n||[]).map(S=>({value:S.id,label:S.name}))],[n]),v=u.useMemo(()=>{const S={};return s.forEach(N=>{const j=N.campaignId||"no-campaign";S[j]||(S[j]={campaign:N.campaign,entities:[]}),S[j].entities.push(N)}),S},[s]);return t.jsxs("div",{className:"followed-entities-page",children:[t.jsxs("div",{className:"followed-entities-header",children:[t.jsx("h1",{children:"Followed Entities"}),t.jsx("div",{className:"followed-entities-actions",children:t.jsx("select",{className:"followed-entities-filter",value:d,onChange:S=>f(S.target.value),children:b.map(S=>t.jsx("option",{value:S.value,children:S.label},S.value))})})]}),t.jsx("div",{className:"followed-entities-content",children:l?t.jsx("div",{className:"followed-entities-empty",children:"Loading..."}):s.length===0?t.jsxs("div",{className:"followed-entities-empty",children:[t.jsx("p",{children:"No followed entities found."}),t.jsx("p",{className:"followed-entities-empty-hint",children:"Follow entities from their detail pages to receive notifications when they're commented on or mentioned."})]}):t.jsx("div",{className:"followed-entities-list",children:Object.entries(v).map(([S,N])=>t.jsxs("div",{className:"followed-entities-group",children:[t.jsx("h2",{className:"followed-entities-group-title",children:N.campaign?.name||"No campaign context"}),t.jsx("div",{className:"followed-entities-items",children:N.entities.map(j=>t.jsxs("div",{className:"followed-entities-item",children:[t.jsx(Yt,{to:`/entities/${j.entityId}${j.campaignId?`?campaignId=${j.campaignId}`:""}`,className:"followed-entities-item-link",children:t.jsxs("div",{className:"followed-entities-item-content",children:[t.jsx("h3",{className:"followed-entities-item-name",children:j.entity?.name||"Unnamed entity"}),j.entity?.entityType&&t.jsx("span",{className:"followed-entities-item-type",children:j.entity.entityType.name})]})}),t.jsx("button",{type:"button",className:"followed-entities-item-unfollow",onClick:()=>g(j.entityId,j.campaignId),disabled:p===j.entityId,title:"Unfollow",children:p===j.entityId?t.jsx(Pl,{size:18}):t.jsx(Nf,{size:18})})]},`${j.entityId}-${j.campaignId}`))})]},S))})})]})}const sB=(e={})=>{const n=new URLSearchParams;Object.entries(e).forEach(([l,o])=>{o!=null&&o!==""&&n.set(l,o)});const s=n.toString(),i=s?`/requests?${s}`:"/requests";return kt.get(i)},rB=e=>kt.get(`/requests/${e}`),iB=e=>kt.post("/requests",e),lB=(e,n)=>kt.patch(`/requests/${e}`,n),oB=e=>kt.delete(`/requests/${e}`),cB={open:"blue",in_progress:"orange",testing:"yellow",resolved:"green",closed:"gray",backlog:"purple"};function A_({status:e}){const n=cB[e]||"gray",s=e?e.split("_").map(i=>i.charAt(0).toUpperCase()+i.slice(1)).join(" "):"Unknown";return t.jsx("span",{className:`request-status-badge request-status-badge--${n}`,children:s})}function uB({request:e}){const n=s=>{if(!s)return"";const i=new Date(s);if(Number.isNaN(i.getTime()))return"";const o=new Date-i,d=Math.floor(o/6e4),f=Math.floor(o/36e5),p=Math.floor(o/864e5);return d<1?"Just now":d<60?`${d}m ago`:f<24?`${f}h ago`:p<7?`${p}d ago`:i.toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric"})};return t.jsxs(Yt,{to:`/requests/${e.id}`,className:"request-card",children:[t.jsxs("div",{className:"request-card__header",children:[t.jsxs("div",{className:"request-card__type",children:[e.type==="bug"?t.jsx(fg,{size:16,className:"request-card__type-icon"}):t.jsx(Yi,{size:16,className:"request-card__type-icon"}),t.jsx("span",{className:"request-card__type-label",children:e.type==="bug"?"Bug":"Feature"})]}),t.jsx(A_,{status:e.status})]}),t.jsx("h3",{className:"request-card__title",children:e.title}),t.jsx("p",{className:"request-card__description",children:e.description.length>150?`${e.description.substring(0,150)}...`:e.description}),t.jsxs("div",{className:"request-card__footer",children:[t.jsxs("div",{className:"request-card__meta",children:[t.jsxs("span",{className:"request-card__creator",children:["by ",e.creator?.username||"Unknown"]}),e.assignee&&t.jsxs("span",{className:"request-card__assignee",children:[" ",e.assignee.username]})]}),t.jsxs("div",{className:"request-card__time",children:[t.jsx(mg,{size:14}),t.jsx("span",{children:n(e.createdAt)})]})]})]})}function dB(){const{user:e}=un(),n=e?.role==="system_admin",[s,i]=u.useState([]),[l,o]=u.useState(!1),[d,f]=u.useState({type:"",status:"",isInBacklog:""}),[p,h]=u.useState({page:1,limit:20,total:0,pages:0}),y=async(S=1)=>{o(!0);try{const N={page:S,limit:p.limit,...d};Object.keys(N).forEach(E=>{(N[E]===""||N[E]===null||N[E]===void 0)&&delete N[E]});const j=await sB(N);i(Array.isArray(j?.data)?j.data:[]),h(j?.pagination||p)}catch(N){console.error("Failed to load requests",N),alert("Failed to load requests")}finally{o(!1)}};u.useEffect(()=>{y(1)},[d]);const g=(S,N)=>{f(j=>({...j,[S]:N}))},b=()=>{f({type:"",status:"",isInBacklog:""})},v=Object.values(d).some(S=>S!=="");return t.jsxs("div",{className:"request-list-page",children:[t.jsxs("div",{className:"request-list-page__header",children:[t.jsxs("div",{children:[t.jsx("h1",{children:"Feature/Bugs"}),t.jsxs("div",{className:"request-list-page__subtitle-wrapper",children:[t.jsx("p",{className:"request-list-page__subtitle",children:n?"All bug reports and feature requests":"Your bug reports and feature requests"}),n&&t.jsx("span",{className:"request-list-page__admin-badge",children:"Admin View"})]})]}),t.jsxs(Yt,{to:"/requests/new",className:"request-list-page__create-button",children:[t.jsx(Wn,{size:20}),"New Request"]})]}),t.jsxs("div",{className:"request-list-page__filters",children:[t.jsxs("div",{className:"request-list-page__filter-group",children:[t.jsx(Ef,{size:16}),t.jsx("label",{htmlFor:"filter-type",children:"Type:"}),t.jsxs("select",{id:"filter-type",value:d.type,onChange:S=>g("type",S.target.value),className:"request-list-page__filter-select",children:[t.jsx("option",{value:"",children:"All"}),t.jsx("option",{value:"bug",children:"Bug"}),t.jsx("option",{value:"feature",children:"Feature"})]})]}),t.jsxs("div",{className:"request-list-page__filter-group",children:[t.jsx("label",{htmlFor:"filter-status",children:"Status:"}),t.jsxs("select",{id:"filter-status",value:d.status,onChange:S=>g("status",S.target.value),className:"request-list-page__filter-select",children:[t.jsx("option",{value:"",children:"All"}),t.jsx("option",{value:"open",children:"Open"}),t.jsx("option",{value:"in_progress",children:"In Progress"}),t.jsx("option",{value:"testing",children:"Testing"}),t.jsx("option",{value:"resolved",children:"Resolved"}),t.jsx("option",{value:"closed",children:"Closed"}),t.jsx("option",{value:"backlog",children:"Backlog"})]})]}),n&&t.jsxs("div",{className:"request-list-page__filter-group",children:[t.jsx("label",{htmlFor:"filter-backlog",children:"Backlog:"}),t.jsxs("select",{id:"filter-backlog",value:d.isInBacklog,onChange:S=>g("isInBacklog",S.target.value),className:"request-list-page__filter-select",children:[t.jsx("option",{value:"",children:"All"}),t.jsx("option",{value:"true",children:"In Backlog"}),t.jsx("option",{value:"false",children:"Not in Backlog"})]})]}),v&&t.jsx("button",{onClick:b,className:"request-list-page__clear-filters",children:"Clear Filters"})]}),l?t.jsx("div",{className:"request-list-page__loading",children:"Loading requests..."}):s.length===0?t.jsxs("div",{className:"request-list-page__empty",children:[t.jsx("p",{children:"No requests found"}),t.jsx(Yt,{to:"/requests/new",className:"request-list-page__empty-link",children:"Create your first request"})]}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"request-list-page__grid",children:s.map(S=>t.jsx(uB,{request:S},S.id))}),p.pages>1&&t.jsxs("div",{className:"request-list-page__pagination",children:[t.jsx("button",{onClick:()=>y(p.page-1),disabled:p.page<=1,className:"request-list-page__pagination-button",children:"Previous"}),t.jsxs("span",{className:"request-list-page__pagination-info",children:["Page ",p.page," of ",p.pages," (",p.total," total)"]}),t.jsx("button",{onClick:()=>y(p.page+1),disabled:p.page>=p.pages,className:"request-list-page__pagination-button",children:"Next"})]})]})]})}const T_=e=>kt.get(`/requests/${e}/notes`),M_=(e,n)=>kt.post(`/requests/${e}/notes`,n),fB=(e,n,s)=>kt.patch(`/requests/${e}/notes/${n}`,s),k_=(e,n)=>kt.delete(`/requests/${e}/notes/${n}`),mB=Object.freeze(Object.defineProperty({__proto__:null,createRequestNote:M_,deleteRequestNote:k_,fetchRequestNotes:T_,updateRequestNote:fB},Symbol.toStringTag,{value:"Module"}));function hB({onSubmit:e,loading:n=!1}){const[s,i]=u.useState(""),l=o=>{o.preventDefault(),s.trim()&&(e(s.trim()),i(""))};return t.jsxs("form",{onSubmit:l,className:"request-note-form",children:[t.jsx("textarea",{value:s,onChange:o=>i(o.target.value),placeholder:"Add a note...",className:"request-note-form__textarea",rows:3,disabled:n}),t.jsx("div",{className:"request-note-form__actions",children:t.jsxs("button",{type:"submit",disabled:!s.trim()||n,className:"request-note-form__submit",children:[t.jsx(Lk,{size:16}),n?"Adding...":"Add Note"]})})]})}function pB({requestId:e,canAddNote:n}){const{user:s}=un(),[i,l]=u.useState([]),[o,d]=u.useState(!1),[f,p]=u.useState(!1),[h,y]=u.useState(null),[g,b]=u.useState(""),v=async()=>{d(!0);try{const _=await T_(e);l(Array.isArray(_?.data)?_.data:[])}catch(_){console.error("Failed to load notes",_)}finally{d(!1)}};u.useEffect(()=>{e&&v()},[e]);const S=async _=>{p(!0);try{await M_(e,{content:_}),await v()}catch(T){console.error("Failed to add note",T),alert("Failed to add note")}finally{p(!1)}},N=async _=>{if(confirm("Are you sure you want to delete this note?"))try{await k_(e,_),await v()}catch(T){console.error("Failed to delete note",T),alert("Failed to delete note")}},j=_=>{y(_.id),b(_.content)},E=()=>{y(null),b("")},A=async _=>{try{const{updateRequestNote:T}=await ci(async()=>{const{updateRequestNote:k}=await Promise.resolve().then(()=>mB);return{updateRequestNote:k}},void 0);await T(e,_,{content:g}),y(null),b(""),await v()}catch(T){console.error("Failed to update note",T),alert("Failed to update note")}},M=_=>{if(!_)return"";const T=new Date(_);if(Number.isNaN(T.getTime()))return"";const C=new Date-T,L=Math.floor(C/6e4),z=Math.floor(C/36e5),G=Math.floor(C/864e5);return L<1?"Just now":L<60?`${L}m ago`:z<24?`${z}h ago`:G<7?`${G}d ago`:T.toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric"})};return o?t.jsx("div",{className:"request-notes__loading",children:"Loading notes..."}):t.jsxs("div",{className:"request-notes",children:[t.jsxs("div",{className:"request-notes__header",children:[t.jsx(yk,{size:20}),t.jsxs("h3",{children:["Notes (",i.length,")"]})]}),n&&t.jsx(hB,{onSubmit:S,loading:f}),t.jsx("div",{className:"request-notes__list",children:i.length===0?t.jsx("div",{className:"request-notes__empty",children:"No notes yet"}):i.map(_=>t.jsx("div",{className:"request-note",children:h===_.id?t.jsxs("div",{className:"request-note__edit",children:[t.jsx("textarea",{value:g,onChange:T=>b(T.target.value),className:"request-note__edit-textarea",rows:3}),t.jsxs("div",{className:"request-note__edit-actions",children:[t.jsx("button",{onClick:()=>A(_.id),className:"request-note__edit-save",children:"Save"}),t.jsx("button",{onClick:E,className:"request-note__edit-cancel",children:"Cancel"})]})]}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"request-note__content",children:_.content}),t.jsxs("div",{className:"request-note__footer",children:[t.jsxs("div",{className:"request-note__meta",children:[t.jsx("span",{className:"request-note__author",children:_.author?.username||"Unknown"}),t.jsx("span",{className:"request-note__time",children:M(_.createdAt)})]}),s?.id===_.createdBy&&t.jsxs("div",{className:"request-note__actions",children:[t.jsx("button",{onClick:()=>j(_),className:"request-note__action",title:"Edit note",children:t.jsx(Nj,{size:14})}),t.jsx("button",{onClick:()=>N(_.id),className:"request-note__action",title:"Delete note",children:t.jsx(zn,{size:14})})]})]})]})},_.id))})]})}function yB(){const{id:e}=Ka(),n=_n(),{user:s}=un(),i=s?.role==="system_admin",[l,o]=u.useState(null),[d,f]=u.useState(!1),[p,h]=u.useState(!1),[y,g]=u.useState([]),[b,v]=u.useState(!1),[S,N]=u.useState(!1),[j,E]=u.useState({status:"",assignedTo:"",testerId:"",priority:"",isInBacklog:!1}),A=async()=>{f(!0);try{const C=await rB(e);if(C?.success&&C?.data){const L=C.data;o(L),E({status:L.status||"",assignedTo:L.assignedTo||"",testerId:L.testerId||"",priority:L.priority||"",isInBacklog:L.isInBacklog||!1})}else throw new Error("Request not found")}catch(C){console.error("Failed to load request",C),alert(C.message||"Failed to load request"),n("/requests")}finally{f(!1)}};u.useEffect(()=>{e&&A()},[e]),u.useEffect(()=>{i&&S&&M()},[i,S]);const M=async()=>{v(!0);try{const C=await Fg();g(Array.isArray(C?.data)?C.data:[])}catch(C){console.error("Failed to load users",C)}finally{v(!1)}},_=async()=>{h(!0);try{const C={};if(j.status&&j.status!==l.status&&(C.status=j.status),j.assignedTo!==l.assignedTo&&(C.assignedTo=j.assignedTo||null),j.testerId!==l.testerId&&(C.testerId=j.testerId||null),j.priority!==l.priority&&(C.priority=j.priority||null),j.isInBacklog!==l.isInBacklog&&(C.isInBacklog=j.isInBacklog),Object.keys(C).length===0){N(!1);return}await lB(e,C),await A(),N(!1)}catch(C){console.error("Failed to update request",C),alert("Failed to update request")}finally{h(!1)}},T=async()=>{if(confirm("Are you sure you want to delete this request? This action cannot be undone."))try{await oB(e),n("/requests")}catch(C){console.error("Failed to delete request",C),alert("Failed to delete request")}},k=l&&(i||String(l.createdBy)===String(s?.id)||String(l.testerId)===String(s?.id));return d?t.jsx("div",{className:"request-detail-page__loading",children:"Loading request..."}):l?t.jsxs("div",{className:"request-detail-page",children:[t.jsxs("div",{className:"request-detail-page__header",children:[t.jsxs(Yt,{to:"/requests",className:"request-detail-page__back",children:[t.jsx(Tc,{size:20}),"Back to Feature/Bugs"]}),t.jsxs("div",{className:"request-detail-page__title-section",children:[t.jsxs("div",{className:"request-detail-page__type-badge",children:[l.type==="bug"?t.jsx(fg,{size:20,className:"request-detail-page__type-icon"}):t.jsx(Yi,{size:20,className:"request-detail-page__type-icon"}),t.jsx("span",{children:l.type==="bug"?"Bug":"Feature"})]}),t.jsx("h1",{children:l.title}),t.jsxs("div",{className:"request-detail-page__meta",children:[t.jsx(A_,{status:l.status}),l.priority&&t.jsxs("span",{className:"request-detail-page__priority",children:["Priority: ",l.priority]}),l.isInBacklog&&t.jsx("span",{className:"request-detail-page__backlog-badge",children:"In Backlog"})]})]})]}),t.jsx("div",{className:"request-detail-page__content",children:t.jsxs("div",{className:"request-detail-page__main",children:[t.jsxs("div",{className:"request-detail-page__section",children:[t.jsx("h2",{children:"Description"}),t.jsx("div",{className:"request-detail-page__description",children:l.description.split(`
`).map((C,L)=>t.jsx("p",{children:C},L))})]}),t.jsxs("div",{className:"request-detail-page__section",children:[t.jsx("h2",{children:"Details"}),t.jsxs("dl",{className:"request-detail-page__details",children:[t.jsxs("div",{className:"request-detail-page__detail-row",children:[t.jsx("dt",{children:"Created by:"}),t.jsx("dd",{children:l.creator?.username||"Unknown"})]}),t.jsxs("div",{className:"request-detail-page__detail-row",children:[t.jsx("dt",{children:"Created:"}),t.jsx("dd",{children:new Date(l.createdAt).toLocaleString()})]}),l.assignee&&t.jsxs("div",{className:"request-detail-page__detail-row",children:[t.jsx("dt",{children:"Assigned to:"}),t.jsx("dd",{children:l.assignee.username})]}),l.tester&&t.jsxs("div",{className:"request-detail-page__detail-row",children:[t.jsx("dt",{children:"Tester:"}),t.jsx("dd",{children:l.tester.username})]}),l.updatedAt!==l.createdAt&&t.jsxs("div",{className:"request-detail-page__detail-row",children:[t.jsx("dt",{children:"Last updated:"}),t.jsx("dd",{children:new Date(l.updatedAt).toLocaleString()})]})]})]}),i&&t.jsxs("div",{className:"request-detail-page__section",children:[t.jsxs("div",{className:"request-detail-page__admin-header",children:[t.jsx("h2",{children:"Admin Controls"}),t.jsxs("button",{onClick:()=>N(!S),className:`request-detail-page__admin-toggle ${S?"request-detail-page__admin-toggle--active":""}`,type:"button",children:[t.jsx(jj,{size:18}),t.jsx("span",{children:S?"Hide Controls":"Show Controls"}),t.jsx(Ss,{size:16,className:`request-detail-page__admin-toggle-icon ${S?"request-detail-page__admin-toggle-icon--rotated":""}`})]})]}),S&&t.jsxs("div",{className:"request-detail-page__admin-form",children:[t.jsxs("div",{className:"request-detail-page__admin-field",children:[t.jsx("label",{children:"Status:"}),t.jsxs("select",{value:j.status,onChange:C=>E(L=>({...L,status:C.target.value})),className:"request-detail-page__admin-select",children:[t.jsx("option",{value:"open",children:"Open"}),t.jsx("option",{value:"in_progress",children:"In Progress"}),t.jsx("option",{value:"testing",children:"Testing"}),t.jsx("option",{value:"resolved",children:"Resolved"}),t.jsx("option",{value:"closed",children:"Closed"}),t.jsx("option",{value:"backlog",children:"Backlog"})]})]}),t.jsxs("div",{className:"request-detail-page__admin-field",children:[t.jsx("label",{children:"Tester:"}),t.jsxs("select",{value:j.testerId,onChange:C=>E(L=>({...L,testerId:C.target.value})),className:"request-detail-page__admin-select",disabled:b,children:[t.jsx("option",{value:"",children:"None"}),y.map(C=>t.jsxs("option",{value:C.id,children:[C.username," ",C.email?`(${C.email})`:""]},C.id))]})]}),t.jsxs("div",{className:"request-detail-page__admin-field",children:[t.jsx("label",{children:"Priority:"}),t.jsxs("select",{value:j.priority,onChange:C=>E(L=>({...L,priority:C.target.value})),className:"request-detail-page__admin-select",children:[t.jsx("option",{value:"",children:"None"}),t.jsx("option",{value:"low",children:"Low"}),t.jsx("option",{value:"medium",children:"Medium"}),t.jsx("option",{value:"high",children:"High"})]})]}),t.jsx("div",{className:"request-detail-page__admin-field",children:t.jsxs("label",{children:[t.jsx("input",{type:"checkbox",checked:j.isInBacklog,onChange:C=>E(L=>({...L,isInBacklog:C.target.checked}))}),"In Backlog"]})}),t.jsxs("div",{className:"request-detail-page__admin-actions",children:[t.jsx("button",{onClick:_,disabled:p,className:"request-detail-page__admin-save",children:p?"Saving...":"Save Changes"}),t.jsxs("button",{onClick:T,className:"request-detail-page__admin-delete",children:[t.jsx(zn,{size:16}),"Delete Request"]})]})]})]}),t.jsx(pB,{requestId:e,canAddNote:k})]})})]}):null}function gB(){const e=_n(),[n,s]=u.useState(!1),[i,l]=u.useState({type:"bug",title:"",description:"",priority:""}),[o,d]=u.useState({}),f=y=>{const{name:g,value:b}=y.target;l(v=>({...v,[g]:b})),o[g]&&d(v=>({...v,[g]:""}))},p=()=>{const y={};return i.title.trim()||(y.title="Title is required"),i.description.trim()||(y.description="Description is required"),d(y),Object.keys(y).length===0},h=async y=>{if(y.preventDefault(),!!p()){s(!0);try{const g={type:i.type,title:i.title.trim(),description:i.description.trim(),priority:i.priority||null},b=await iB(g);if(b?.success&&b?.data?.id)e(`/requests/${b.data.id}`);else throw new Error("Failed to create request")}catch(g){console.error("Failed to create request",g),alert(g.message||"Failed to create request")}finally{s(!1)}}};return t.jsxs("div",{className:"create-request-page",children:[t.jsxs("div",{className:"create-request-page__header",children:[t.jsxs("button",{onClick:()=>e("/requests"),className:"create-request-page__back",children:[t.jsx(Tc,{size:20}),"Back to Feature/Bugs"]}),t.jsx("h1",{children:"Create Feature/Bug Request"})]}),t.jsxs("form",{onSubmit:h,className:"create-request-form",children:[t.jsxs("div",{className:"create-request-form__section",children:[t.jsx("label",{className:"create-request-form__label",children:"Type"}),t.jsxs("div",{className:"create-request-form__type-options",children:[t.jsxs("label",{className:"create-request-form__type-option",children:[t.jsx("input",{type:"radio",name:"type",value:"bug",checked:i.type==="bug",onChange:f}),t.jsx(fg,{size:20}),t.jsx("span",{children:"Bug"})]}),t.jsxs("label",{className:"create-request-form__type-option",children:[t.jsx("input",{type:"radio",name:"type",value:"feature",checked:i.type==="feature",onChange:f}),t.jsx(Yi,{size:20}),t.jsx("span",{children:"Feature"})]})]})]}),t.jsxs("div",{className:"create-request-form__section",children:[t.jsxs("label",{htmlFor:"title",className:"create-request-form__label",children:["Title ",t.jsx("span",{className:"create-request-form__required",children:"*"})]}),t.jsx("input",{id:"title",name:"title",type:"text",value:i.title,onChange:f,className:`create-request-form__input ${o.title?"create-request-form__input--error":""}`,placeholder:"Brief description of the issue or feature",disabled:n}),o.title&&t.jsx("div",{className:"create-request-form__error",children:o.title})]}),t.jsxs("div",{className:"create-request-form__section",children:[t.jsxs("label",{htmlFor:"description",className:"create-request-form__label",children:["Description ",t.jsx("span",{className:"create-request-form__required",children:"*"})]}),t.jsx("textarea",{id:"description",name:"description",value:i.description,onChange:f,className:`create-request-form__textarea ${o.description?"create-request-form__textarea--error":""}`,placeholder:"Provide detailed information about the bug or feature request...",rows:8,disabled:n}),o.description&&t.jsx("div",{className:"create-request-form__error",children:o.description})]}),t.jsxs("div",{className:"create-request-form__section",children:[t.jsx("label",{htmlFor:"priority",className:"create-request-form__label",children:"Priority (optional)"}),t.jsxs("select",{id:"priority",name:"priority",value:i.priority,onChange:f,className:"create-request-form__select",disabled:n,children:[t.jsx("option",{value:"",children:"None"}),t.jsx("option",{value:"low",children:"Low"}),t.jsx("option",{value:"medium",children:"Medium"}),t.jsx("option",{value:"high",children:"High"})]})]}),t.jsxs("div",{className:"create-request-form__actions",children:[t.jsx("button",{type:"button",onClick:()=>e("/requests"),className:"create-request-form__cancel",disabled:n,children:"Cancel"}),t.jsx("button",{type:"submit",className:"create-request-form__submit",disabled:n,children:n?"Creating...":"Submit Request"})]})]})]})}function R_(e,n,s=!1){if(!e||!Array.isArray(n)||n.length===0)return[];const i=new Map;n.forEach(f=>{const p=f.id||f.type_id||"";p&&(i.set(String(p),f),!f.parent_type_id&&f.parentType?.id&&(f.parent_type_id=f.parentType.id))});const l=new Set;s&&l.add(String(e));let o=String(e);const d=new Set;for(;o&&!d.has(o);){d.add(o);const f=i.get(o);if(!f)break;const p=f.parent_type_id||f.parentTypeId||f.parentType?.id||null;if(p){const h=String(p);l.add(h),o=h}else break}return Array.from(l)}function bB(e,n){if(!e||!Array.isArray(n)||n.length===0)return[];const s=String(e),i=[];return n.forEach(l=>{(l.id||l.type_id)&&!l.parent_type_id&&l.parentType?.id&&(l.parent_type_id=l.parentType.id)}),n.forEach(l=>{const o=l.id||l.type_id||"";if(!o)return;const d=l.parent_type_id||l.parentTypeId||l.parentType?.id||null;(d?String(d):"")===s&&i.push(String(o))}),i}function I_({location:e,parentId:n,locationTypes:s,onClose:i,onSuccess:l}){const{activeWorldId:o}=wn(),[d,f]=u.useState({name:"",description:"",location_type_id:"",parent_id:n||null,metadata:{}}),[p,h]=u.useState(!1),[y,g]=u.useState(null),[b,v]=u.useState([]),[S,N]=u.useState([]),[j,E]=u.useState([]),[A,M]=u.useState(!1),_=u.useCallback(async(L=null)=>{if(o)try{let U=(await ri({worldId:o,all:"true"}))?.data||[];if(e?.id){const V=String(e.id);U=U.filter(R=>String(R.id)!==V);try{const{fetchLocationPath:R}=await ci(async()=>{const{fetchLocationPath:$}=await Promise.resolve().then(()=>o1);return{fetchLocationPath:$}},void 0),D=(await R(e.id))?.data||[],O=new Set(D.map($=>String($.id)));U=U.filter($=>{const F=String($.id);return!O.has(F)})}catch(R){console.error(" [Parent Selection] Failed to load location path for ancestor exclusion:",R)}}const X=L||e?.location_type_id;if(X&&s&&s.length>0){const V=String(X),R=s.find(O=>String(O.id)===V),B=R_(V,s),D=String(V);if(B.length>0){const O=new Set(B.map($=>String($)));U=U.filter($=>{const F=$.location_type_id||$.locationType?.id,H=F?String(F):"",I=O.has(H);return H&&I&&H!==D})}else U=[]}else e&&(U=[]);v(U)}catch(z){console.error(" [Parent Selection] Failed to load available parents:",z),v([])}},[o,e,s]),T=u.useCallback(async()=>{if(!e?.id){N([]);return}M(!0);try{const L=await Sg(e.id);N(L?.data||[])}catch(L){console.error(" Failed to load entities:",L),N([])}finally{M(!1)}},[e?.id]),k=u.useCallback(async()=>{if(!e?.id){E([]);return}M(!0);try{const L=await ri({worldId:o,parentId:e.id});E(L?.data||[])}catch(L){console.error(" Failed to load child locations:",L),E([])}finally{M(!1)}},[e?.id,o]);u.useEffect(()=>{e?(f({name:e.name||"",description:e.description||"",location_type_id:e.location_type_id||"",parent_id:e.parent_id||n||null,metadata:e.metadata||{}}),T(),k()):(f({name:"",description:"",location_type_id:"",parent_id:n||null,metadata:{}}),N([]),E([])),_(e?.location_type_id||null)},[e,n,T,k]),u.useEffect(()=>{d.location_type_id?_(d.location_type_id):e||_(null)},[d.location_type_id,_,e]);const C=async L=>{L.preventDefault(),h(!0),g(null);try{const z={world_id:o,name:d.name,description:d.description,location_type_id:d.location_type_id||null,parent_id:d.parent_id||null,metadata:d.metadata};let G;e?G=await Vl(e.id,z):G=await wg(z);const U=G?.data||G;l.length>0?l(U):l()}catch(z){console.error(" Failed to save location:",z),g(z.message)}finally{h(!1)}};return t.jsxs("form",{onSubmit:C,className:"entity-type-form",children:[y&&t.jsx("div",{className:"alert alert-error",style:{marginBottom:"1rem"},children:y}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"name",children:"Name *"}),t.jsx("input",{type:"text",id:"name",value:d.name,onChange:L=>f({...d,name:L.target.value}),required:!0})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"parent_id",children:"Parent"}),t.jsxs("select",{id:"parent_id",value:d.parent_id||"",onChange:L=>f({...d,parent_id:L.target.value?L.target.value:null}),children:[t.jsx("option",{value:"",children:"None (Root Location)"}),b.map(L=>t.jsx("option",{value:L.id,children:L.name},L.id))]})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"location_type_id",children:"Type *"}),t.jsxs("select",{id:"location_type_id",value:d.location_type_id,onChange:L=>f({...d,location_type_id:L.target.value}),required:!0,children:[t.jsx("option",{value:"",children:"Select a type..."}),s.map(L=>t.jsx("option",{value:L.id,children:L.name},L.id))]})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"description",children:"Description"}),t.jsx("textarea",{id:"description",value:d.description,onChange:L=>f({...d,description:L.target.value}),rows:4})]}),e&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"form-group",style:{borderTop:"1px solid #e2e8f0",paddingTop:"1rem",marginTop:"1rem"},children:[t.jsxs("label",{style:{marginBottom:"0.5rem",display:"block",fontWeight:"600"},children:["Entities Located Here (",S.length,")"]}),A?t.jsx("p",{style:{color:"#64748b",fontSize:"0.9rem"},children:"Loading entities..."}):S.length===0?t.jsx("p",{style:{color:"#64748b",fontSize:"0.9rem"},children:"No entities in this location."}):t.jsx("ul",{style:{listStyle:"none",padding:0,margin:0,maxHeight:"200px",overflowY:"auto"},children:S.map(L=>t.jsx("li",{style:{padding:"0.5rem",marginBottom:"0.25rem",backgroundColor:"#f8fafc",borderRadius:"4px"},children:t.jsxs(Yt,{to:`/entities/${L.id}`,style:{display:"flex",alignItems:"center",gap:"0.5rem",textDecoration:"none",color:"#1e293b"},onClick:z=>z.stopPropagation(),children:[t.jsx(NS,{size:14}),t.jsxs("span",{children:[L.name,L.entityType&&t.jsxs("span",{style:{color:"#64748b",fontSize:"0.85rem",marginLeft:"0.5rem"},children:["(",L.entityType.name,")"]})]})]})},L.id))})]}),t.jsxs("div",{className:"form-group",style:{borderTop:"1px solid #e2e8f0",paddingTop:"1rem",marginTop:"1rem"},children:[t.jsxs("label",{style:{marginBottom:"0.5rem",display:"block",fontWeight:"600"},children:["Child Locations (",j.length,")"]}),A?t.jsx("p",{style:{color:"#64748b",fontSize:"0.9rem"},children:"Loading child locations..."}):j.length===0?t.jsx("p",{style:{color:"#64748b",fontSize:"0.9rem"},children:"No child locations."}):t.jsx("ul",{style:{listStyle:"none",padding:0,margin:0,maxHeight:"200px",overflowY:"auto"},children:j.map(L=>t.jsx("li",{style:{padding:"0.5rem",marginBottom:"0.25rem",backgroundColor:"#f8fafc",borderRadius:"4px"},children:t.jsxs(Yt,{to:`/locations/${L.id}`,style:{display:"flex",alignItems:"center",gap:"0.5rem",textDecoration:"none",color:"#1e293b"},onClick:z=>z.stopPropagation(),children:[t.jsx(NS,{size:14}),t.jsx("span",{children:L.name}),L.locationType&&t.jsxs("span",{style:{color:"#64748b",fontSize:"0.85rem",marginLeft:"0.5rem"},children:["(",L.locationType.name,")"]})]})},L.id))})]})]}),t.jsxs("div",{className:"form-actions",children:[t.jsx("button",{type:"button",className:"btn btn-secondary",onClick:i,children:"Cancel"}),t.jsx("button",{type:"submit",className:"btn btn-primary",disabled:p,children:p?"Saving...":e?"Update":"Create"})]})]})}const xB=new Set(["system_admin"]);function vB(){const{activeWorldId:e,selectedCampaignId:n,contextKey:s,activeWorld:i,selectedCampaign:l,selectedContextType:o}=wn(),{user:d}=un(),[f,p]=mj(),h=_n(),[y,g]=u.useState([]),[b,v]=u.useState([]),[S,N]=u.useState(!1),[j,E]=u.useState(null),[A,M]=u.useState(f.get("parentId")||null),_=f.get("locationType")||null,[T,k]=u.useState(_),[C,L]=u.useState([]),[z,G]=u.useState(!1),[U,X]=u.useState(null),[V,R]=u.useState(""),B=u.useMemo(()=>!l||!d?"":l.members?.find(se=>se.user_id===d.id)?.role||"",[l,d]),D=u.useMemo(()=>{if(!i||!d?.id)return!1;const ue=i.created_by||i.creator?.id||i.owner_id||i.owner?.id||"";return ue?String(ue)===String(d.id):!1},[i,d?.id]),O=u.useMemo(()=>d?xB.has(d.role)?!0:e?o==="world"?D:!!(l&&(B==="dm"||D)):!1:!1,[d,e,o,l,B,D]),$=i?.entity_creation_scope??"",F=u.useMemo(()=>!n||!l||!d||$!==zi.ALL_PLAYERS?!1:B==="player",[n,l,d,$,B]),H=O||F,I=u.useCallback(async()=>{if(e){N(!0),E(null);try{const ue={worldId:e,includeEntities:"true"};A&&(ue.parentId=A),_&&!A&&(ue.locationTypeId=_);const se=await ri(ue);g(se?.data||[])}catch(ue){console.error(" Failed to load locations:",ue),E(ue.message)}finally{N(!1)}}},[e,A,_,n,s]),Y=u.useCallback(async()=>{if(e)try{const ue=await Nr({worldId:e});v(ue?.data||[])}catch(ue){console.error(" Failed to load location types:",ue)}},[e]),P=u.useCallback(async()=>{if(!A){L([]);return}try{const ue=await vg(A);L(ue?.data||[])}catch(ue){console.error(" Failed to load path:",ue),L([])}},[A]);u.useEffect(()=>{I()},[I]),u.useEffect(()=>{Y()},[Y]),u.useEffect(()=>{P()},[P]),u.useEffect(()=>{_&&_!==T?(M(null),k(_)):!_&&T&&k(null)},[_,T]),u.useEffect(()=>{const ue={};A&&(ue.parentId=A),_&&(ue.locationType=_),p(ue)},[A,_,p]);const W=async ue=>{if(!(!O||!ue?.id||!window.confirm(`Delete location "${ue.name}"? This action cannot be undone.`)))try{R(ue.id),await Ng(ue.id),I()}catch(Le){console.error(" Failed to delete location",Le),E(Le.message||"Failed to delete location")}finally{R("")}},le=()=>{if(C.length>1){const ue=C[C.length-2].id;M(ue)}else M(null)},K=ue=>{M(ue)},de=()=>{X(null),G(!0)},Q=ue=>{X(ue),G(!0)},he=()=>{G(!1),X(null)},re=()=>{G(!1),X(null),I()},Ce=_&&b.find(ue=>ue.id===_)?.name||"";if(!e)return t.jsx("section",{className:"entities-page",children:t.jsx("div",{className:"entities-header",children:t.jsx("div",{className:"entities-header-top",children:t.jsxs("div",{className:"entities-header-left",children:[t.jsx("h1",{children:"Locations"}),t.jsx("p",{className:"entities-subtitle",children:"Select a campaign or world you own to choose a world context."})]})})})});const Re=l?`${l.name}${i?.name?`  ${i.name}`:""}`:i?.name?`World  ${i.name}`:"";return t.jsxs("section",{className:"entities-page",children:[t.jsx("div",{className:"entities-header",children:t.jsxs("div",{className:"entities-header-top",children:[t.jsxs("div",{className:"entities-header-left",children:[t.jsx("h1",{children:_&&Ce?Ce:"Locations"}),Re&&t.jsx("p",{className:"entities-subtitle",children:Re}),_&&t.jsx("div",{style:{marginTop:"0.5rem"},children:t.jsxs("button",{className:"btn secondary compact",onClick:()=>{const ue=new URLSearchParams(f);ue.delete("locationType"),p(ue)},title:"Clear location type filter",children:[t.jsx(Bn,{size:14})," Clear Filter"]})})]}),t.jsxs("div",{className:"entities-header-right",children:[t.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:()=>h("/locations/builder"),disabled:!e,title:"Open location builder",children:[t.jsx(Sk,{size:18})," Builder"]}),t.jsx("button",{type:"button",className:"icon-btn",title:"Refresh locations",onClick:I,disabled:S||!e,children:t.jsx(Vi,{size:16})}),H&&t.jsxs("button",{className:"btn submit",onClick:de,disabled:!e||S,children:[t.jsx(Wn,{size:18})," Add Location"]})]})]})}),C.length>0&&t.jsxs("div",{style:{marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",flexWrap:"wrap"},children:[t.jsx("button",{className:"btn btn-sm btn-secondary",onClick:()=>M(null),children:"Root"}),C.map((ue,se)=>t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[t.jsx(xr,{size:16}),se===C.length-1?t.jsx("span",{style:{fontWeight:"bold"},children:ue.name}):t.jsx("button",{className:"btn btn-sm btn-link",onClick:()=>M(ue.id),children:ue.name})]},ue.id)),C.length>1&&t.jsxs("button",{className:"btn btn-sm btn-secondary",onClick:le,style:{marginLeft:"auto"},children:[t.jsx(yy,{size:16})," Up"]})]}),j&&t.jsx("div",{className:"alert error",role:"alert",style:{marginBottom:"1rem"},children:j}),S?t.jsx("p",{children:"Loading locations..."}):y.length===0?t.jsx("p",{children:"No locations found. Create your first location to get started."}):t.jsx("div",{className:"entities-table-wrapper",children:t.jsxs("table",{className:"entities-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Name"}),t.jsx("th",{children:"Type"}),t.jsx("th",{children:"Description"}),t.jsx("th",{children:"Children"}),t.jsx("th",{children:"Entities"}),O&&t.jsx("th",{className:"actions-column",children:"Actions"})]})}),t.jsx("tbody",{children:y.map(ue=>t.jsxs("tr",{children:[t.jsx("td",{children:ue.childCount>0?t.jsxs(t.Fragment,{children:[t.jsx("button",{onClick:()=>K(ue.id),style:{textAlign:"left",padding:0,background:"none",border:"none",cursor:"pointer",fontWeight:600,color:"#1d4ed8",textDecoration:"none",fontFamily:"inherit",fontSize:"inherit"},className:"entity-name-link",onMouseEnter:se=>{se.currentTarget.style.textDecoration="underline"},onMouseLeave:se=>{se.currentTarget.style.textDecoration="none"},children:ue.name}),"",t.jsx(xr,{size:16,style:{marginLeft:"0.25rem",display:"inline-block",verticalAlign:"middle",color:"#6b7280"}}),ue.id?t.jsxs(t.Fragment,{children:["",t.jsx(fs,{locationId:ue.id,locationName:ue.name||"location"})]}):null,"",t.jsx(Cy,{importance:ue.importance})]}):t.jsxs(t.Fragment,{children:[t.jsx(Yt,{to:`/locations/${ue.id}`,className:"entity-name-link",children:ue.name}),ue.id?t.jsxs(t.Fragment,{children:["",t.jsx(fs,{locationId:ue.id,locationName:ue.name||"location"})]}):null,"",t.jsx(Cy,{importance:ue.importance})]})}),t.jsx("td",{children:ue.locationType?.name||""}),t.jsx("td",{children:ue.description||""}),t.jsx("td",{children:ue.childCount||0}),t.jsx("td",{children:ue.entities?.length||0}),O&&t.jsx("td",{className:"actions-column",children:t.jsxs("div",{className:"entity-actions",children:[t.jsx("button",{type:"button",className:"icon-btn",onClick:()=>Q(ue),title:"Edit location",disabled:S,children:t.jsx(Ga,{size:16})}),t.jsx("button",{type:"button",className:"icon-btn danger",onClick:()=>W(ue),title:"Delete location",disabled:V===ue.id,children:t.jsx(zn,{size:16})})]})})]},ue.id))})]})}),z&&t.jsx("div",{className:"side-panel-overlay",role:"dialog","aria-modal":"true",children:t.jsxs("div",{className:"side-panel",children:[t.jsxs("div",{className:"side-panel-header",children:[t.jsx("h2",{children:U?"Edit Location":"New Location"}),t.jsx("button",{type:"button",className:"icon-btn",onClick:he,title:"Close form",children:t.jsx(Bn,{size:18})})]}),t.jsx("div",{className:"side-panel-content",children:t.jsx(I_,{location:U,parentId:A,locationTypes:b,onClose:he,onSuccess:re})})]})})]})}const SB=(e,n)=>{const s=new URLSearchParams;n&&s.set("campaignId",n);const i=s.toString(),l=i?`/locations/${e}/follow?${i}`:`/locations/${e}/follow`;return kt.post(l)},wB=(e,n)=>{const s=new URLSearchParams;n&&s.set("campaignId",n);const i=s.toString(),l=i?`/locations/${e}/follow?${i}`:`/locations/${e}/follow`;return kt.delete(l)},NB=(e,n)=>{const s=new URLSearchParams;n&&s.set("campaignId",n);const i=s.toString(),l=i?`/locations/${e}/follow-status?${i}`:`/locations/${e}/follow-status`;return kt.get(l)};function jB({locationId:e}){const{user:n}=un(),{selectedCampaignId:s}=wn(),[i,l]=u.useState(!1),[o,d]=u.useState(!1),[f,p]=u.useState(!0);u.useEffect(()=>{if(!e||!s||!n?.id){p(!1);return}(async()=>{try{p(!0);const g=await NB(e,s);l(g?.following??!1)}catch(g){console.error("Failed to check location follow status",g),l(!1)}finally{p(!1)}})()},[e,s,n?.id]);const h=async()=>{if(!e||!s||o||f)return;const y=!i;d(!0);try{y?await SB(e,s):await wB(e,s),l(y)}catch(g){console.error("Failed to toggle location follow",g),l(!y)}finally{d(!1)}};return s?f?t.jsx("button",{type:"button",className:"entity-follow-button",disabled:!0,title:"Checking follow status...",children:t.jsx(Pl,{size:18})}):t.jsx("button",{type:"button",className:`entity-follow-button ${i?"following":""}`,onClick:h,disabled:o,title:i?"Unfollow location":"Follow location",children:i?t.jsx(Nf,{size:18}):t.jsx(Pl,{size:18})}):null}function EB({locationId:e,name:n,canEdit:s,isEditing:i,onToggleEdit:l,onSave:o,isSaving:d=!1,isSaveDisabled:f=!1,isMobile:p=!1}){const h=n||"Untitled location",y=()=>{typeof l=="function"&&l()},g=()=>{typeof o=="function"&&o()};return t.jsxs("div",{className:"entity-header flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 sm:gap-2",role:"banner",children:[t.jsx("div",{className:"entity-header-center",children:t.jsx("h1",{className:p?"entity-header-title-mobile":"",children:h})}),t.jsxs("div",{className:"entity-header-right",children:[e&&t.jsx(jB,{locationId:e}),s?t.jsxs("div",{className:"entity-header-actions",children:[i&&typeof o=="function"?t.jsx("button",{type:"button",className:"btn submit",onClick:g,disabled:f||d,children:d?"Saving":"Save"}):null,t.jsxs("button",{type:"button",className:`edit-mode-toggle ${i?"is-active":""}`,role:"switch","aria-checked":i,onClick:y,children:[t.jsx("span",{className:"edit-mode-toggle-track","aria-hidden":"true",children:t.jsx("span",{className:"edit-mode-toggle-thumb"})}),t.jsx("span",{className:"edit-mode-toggle-text",children:"Edit"})]})]}):null]})]})}const _B=[{value:"critical",label:"Critical",icon:ta,color:"#dc2626"},{value:"important",label:"Important",icon:Jl,color:"#ea580c"},{value:"medium",label:"Medium",icon:hg,color:"#6b7280"},{value:null,label:"None",icon:Bn,color:"#9ca3af"}];function CB({locationId:e,importance:n,onUpdate:s}){const{selectedCampaignId:i}=wn(),[l,o]=u.useState(!1);if(!i)return null;const d=async f=>{if(!(l||f===n)){o(!0);try{await a1(e,f),s?.(f)}catch(p){console.error("Failed to update location importance",p)}finally{o(!1)}}};return t.jsxs("div",{className:"entity-importance-selector",children:[t.jsx("span",{className:"entity-importance-label",children:"Importance:"}),t.jsx("div",{className:"entity-importance-buttons",children:_B.map(f=>{const p=f.icon,h=n===f.value;return t.jsxs("button",{type:"button",className:`entity-importance-button ${h?"selected":""}`,onClick:()=>d(f.value),disabled:l,title:f.label,style:h?{"--importance-color":f.color}:{},children:[t.jsx(p,{size:16}),t.jsx("span",{className:"entity-importance-button-label",children:f.label})]},f.value||"none")})})]})}const L_=["global","selective","hidden"],AB=[...L_,"owner_only"],IN=new Set(L_),LN=new Set(AB),iy=(e,n)=>{if(typeof e!="string")return"global";const s=e.toLowerCase();return n.has(s)?s:"global"},pc=e=>e?Array.isArray(e)?e.map(n=>n==null?"":String(n).trim()).filter(Boolean):typeof e=="string"?e.split(",").map(n=>n.trim()).filter(Boolean):[]:[],ly=()=>({campaigns:[],users:[],characters:[]});function TB(e,n,s){const i=e?.id,l=e?.world?.id||e?.world_id||"",o=u.useMemo(()=>e?{readMode:iy(e.read_access||e.readAccess,IN),readCampaigns:pc(e.read_campaign_ids||e.readCampaignIds),readUsers:pc(e.read_user_ids||e.readUserIds),readCharacters:pc(e.read_character_ids||e.readCharacterIds),writeMode:iy(e.write_access||e.writeAccess,LN),writeCampaigns:pc(e.write_campaign_ids||e.writeCampaignIds),writeUsers:pc(e.write_user_ids||e.writeUserIds)}:{readMode:"global",readCampaigns:[],readUsers:[],readCharacters:[],writeMode:"global",writeCampaigns:[],writeUsers:[]},[e]),[d,f]=u.useState(o),[p,h]=u.useState(()=>ly()),[y,g]=u.useState(!1),[b,v]=u.useState(""),[S,N]=u.useState(!1),[j,E]=u.useState(""),[A,M]=u.useState("");u.useEffect(()=>{f(o)},[o]);const _=u.useCallback(async()=>{if(n){if(!l){h(ly()),v(""),g(!1);return}g(!0),v("");try{const z=await Bg(l);h({campaigns:z.campaigns??[],users:z.users??[],characters:z.characters??[]})}catch(z){console.error(" Failed to load access options",z),h(ly()),v(z.message||"Failed to load access options")}finally{g(!1)}}},[n,l]);u.useEffect(()=>{_()},[_]);const T=u.useMemo(()=>{const z=["readMode","readCampaigns","readUsers","readCharacters","writeMode","writeCampaigns","writeUsers"],G=U=>Array.isArray(U)?U.map(X=>String(X).trim()).filter(Boolean).sort():[];return z.some(U=>{const X=d[U],V=o[U];if(Array.isArray(X)||Array.isArray(V)){const R=G(X),B=G(V);return R.length!==B.length?!0:R.some((D,O)=>D!==B[O])}return X!==V})},[d,o]),k=u.useCallback((z,G)=>{E(""),M(""),f(U=>{const X={...U};if(z==="readMode"||z==="writeMode"){const R=iy(G,z==="readMode"?IN:LN);return X[z]=R,z==="readMode"&&R!=="selective"&&(X.readCampaigns=[],X.readUsers=[],X.readCharacters=[]),z==="writeMode"&&R!=="selective"&&(X.writeCampaigns=[],X.writeUsers=[]),X}return["readCampaigns","readUsers","readCharacters","writeCampaigns","writeUsers"].includes(z)?(X[z]=Array.isArray(G)?G.map(V=>String(V).trim()).filter(Boolean):[],X):(X[z]=G,X)})},[]),C=u.useCallback(()=>{f(o),E(""),M("")},[o]),L=u.useCallback(async()=>{if(!s||!i)return!1;if(!T)return!0;E(""),M(""),N(!0);try{const z={read_access:d.readMode,write_access:d.writeMode,read_campaign_ids:d.readMode==="selective"?d.readCampaigns:[],read_user_ids:d.readMode==="selective"?d.readUsers:[],read_character_ids:d.readMode==="selective"?d.readCharacters:[],write_campaign_ids:d.writeMode==="selective"?d.writeCampaigns:[],write_user_ids:d.writeMode==="selective"?d.writeUsers:[]},G=await Vl(i,z);if(!(G?.data||G))throw new Error("Failed to save access settings");return M("Access settings saved."),!0}catch(z){return console.error(" Failed to save access settings",z),E(z.message||"Failed to save access settings"),!1}finally{N(!1)}},[s,i,d,T]);return{accessSettings:d,accessOptions:p,accessOptionsError:b,accessOptionsLoading:y,accessSaving:S,accessSaveError:j,accessSaveSuccess:A,isAccessDirty:T,handleAccessSettingChange:k,resetAccessSettings:C,handleAccessSave:L}}function MB({canEdit:e,worldId:n,accessSettings:s,accessOptions:i,accessOptionsError:l,accessOptionsLoading:o,accessSaving:d,accessSaveError:f,accessSaveSuccess:p,handleAccessSettingChange:h}){return t.jsx("div",{className:"entity-tab-content",children:t.jsxs("section",{className:"entity-card entity-access-card",children:[t.jsx("h2",{className:"entity-card-title",children:"Access controls"}),t.jsx("p",{className:"entity-access-note help-text",children:"Configure who can view and edit this location. Users with write access will automatically receive read access. Changes are saved along with the rest of the record."}),l&&t.jsx("div",{className:"alert error",role:"alert",children:l}),n?t.jsxs(t.Fragment,{children:[t.jsx(zg,{canEdit:e,accessSettings:s,accessOptions:i,accessOptionsLoading:o,accessSaving:d,onSettingChange:h,idPrefix:"location-access"}),t.jsxs("div",{className:"entity-access-actions",children:[f&&t.jsx("div",{className:"alert error",role:"alert",children:f}),p&&t.jsx("div",{className:"alert success",role:"status",children:p})]})]}):t.jsx("p",{className:"entity-empty-state",children:"Assign this location to a world to configure access settings."})]})})}function kB({renderSchemaSections:e,systemSchema:n,viewData:s}){return t.jsx("div",{className:"entity-tab-content",children:e(n,s,"system")})}function RB({entities:e=[],loading:n=!1,error:s="",locationId:i,worldId:l,onEntitiesChange:o}){const{user:d}=un(),{activeWorldId:f}=wn();to();const[p,h]=u.useState(!1),[y,g]=u.useState(""),[b,v]=u.useState([]),[S,N]=u.useState(!1),[j,E]=u.useState(""),[A,M]=u.useState(null),[_,T]=u.useState(null);d?.role;const k=u.useCallback(async z=>{if(!z||!z.trim()||!l){v([]);return}N(!0),E("");try{const G=await zj({worldId:l,query:z.trim(),limit:20}),U=Array.isArray(G?.data)?G.data:[],X=new Set(e.map(R=>R.id)),V=U.filter(R=>!X.has(R.id));v(V)}catch(G){console.error("Failed to search entities:",G),E(G.message||"Failed to search entities"),v([])}finally{N(!1)}},[l,e]),C=u.useCallback(async z=>{if(!(!i||!z)){T(z);try{await Jj(i,z),o&&o(),h(!1),g(""),v([])}catch(G){console.error("Failed to add entity:",G),alert(G.message||"Failed to add entity to location")}finally{T(null)}}},[i,o]),L=u.useCallback(async z=>{if(!(!i||!z)&&confirm("Are you sure you want to remove this entity from this location?")){M(z);try{await e1(i,z),o&&o()}catch(G){console.error("Failed to remove entity:",G),alert(G.message||"Failed to remove entity from location")}finally{M(null)}}},[i,o]);return n?t.jsx("div",{className:"entity-tab-content",children:t.jsxs("section",{className:"entity-card bg-white rounded-lg border p-4 sm:p-6 w-full",children:[t.jsx("h2",{className:"entity-card-title",children:"Entities"}),t.jsx("p",{children:"Loading entities..."})]})}):s?t.jsx("div",{className:"entity-tab-content",children:t.jsxs("section",{className:"entity-card bg-white rounded-lg border p-4 sm:p-6 w-full",children:[t.jsx("h2",{className:"entity-card-title",children:"Entities"}),t.jsx("div",{className:"alert error",children:s})]})}):t.jsxs("div",{className:"entity-tab-content",children:[t.jsxs("section",{className:"entity-card bg-white rounded-lg border p-4 sm:p-6 w-full",children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1rem"},children:[t.jsx("h2",{className:"entity-card-title",style:{margin:0},children:"Entities in this Location"}),t.jsxs("button",{type:"button",className:"btn btn-primary",onClick:()=>h(!0),style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[t.jsx(Wn,{size:16}),t.jsx("span",{children:"Add Entity"})]})]}),e.length===0?t.jsx("p",{className:"entity-empty-state",children:"No entities are located here."}):t.jsx("div",{className:"entity-list",children:e.map(z=>t.jsxs("div",{className:"entity-list-item",style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"0.75rem",marginBottom:"0.5rem",border:"1px solid #e5e7eb",borderRadius:"0.5rem",backgroundColor:"#f9fafb"},children:[t.jsxs("div",{style:{flex:1,minWidth:0},children:[t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",flexWrap:"wrap"},children:[t.jsxs("span",{className:"entity-link-with-preview",style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[t.jsx(Yt,{to:`/entities/${z.id}`,style:{fontWeight:500,textDecoration:"none",color:"inherit"},children:z.name}),t.jsx(Na,{entityId:z.id,entityName:z.name})]}),z.entityType&&t.jsxs("span",{style:{color:"#6b7280",fontSize:"0.875rem"},children:["(",z.entityType.name,")"]})]}),z.description&&t.jsx("p",{style:{marginTop:"0.25rem",color:"#6b7280",fontSize:"0.875rem",margin:0},children:z.description})]}),t.jsx("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>L(z.id),disabled:A===z.id,style:{marginLeft:"1rem",display:"flex",alignItems:"center",gap:"0.25rem"},title:"Remove entity from location",children:A===z.id?t.jsx("span",{children:"Removing..."}):t.jsxs(t.Fragment,{children:[t.jsx(zn,{size:14}),t.jsx("span",{children:"Remove"})]})})]},z.id))})]}),p&&t.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,padding:"1rem"},onClick:z=>{z.target===z.currentTarget&&(h(!1),g(""),v([]))},children:t.jsxs("div",{className:"entity-card bg-white rounded-lg border",style:{width:"100%",maxWidth:"600px",maxHeight:"80vh",overflow:"auto",padding:"1.5rem"},onClick:z=>z.stopPropagation(),children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1rem"},children:[t.jsx("h3",{style:{margin:0},children:"Add Entity to Location"}),t.jsx("button",{type:"button",className:"btn btn-sm btn-secondary",onClick:()=>{h(!1),g(""),v([])},children:t.jsx(Bn,{size:16})})]}),t.jsxs("div",{style:{marginBottom:"1rem"},children:[t.jsx("label",{htmlFor:"entity-search",style:{display:"block",marginBottom:"0.5rem",fontWeight:500},children:"Search for entity"}),t.jsx("input",{id:"entity-search",type:"text",value:y,onChange:z=>{const G=z.target.value;g(G),k(G)},placeholder:"Type to search...",style:{width:"100%",padding:"0.5rem",border:"1px solid #d1d5db",borderRadius:"0.375rem"}})]}),j&&t.jsx("div",{className:"alert error",style:{marginBottom:"1rem"},children:j}),S&&t.jsx("p",{style:{textAlign:"center",color:"#6b7280"},children:"Searching..."}),!S&&y&&b.length===0&&!j&&t.jsx("p",{style:{textAlign:"center",color:"#6b7280"},children:"No entities found"}),!S&&b.length>0&&t.jsx("div",{style:{maxHeight:"400px",overflowY:"auto"},children:b.map(z=>t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"0.75rem",marginBottom:"0.5rem",border:"1px solid #e5e7eb",borderRadius:"0.375rem"},children:[t.jsxs("div",{children:[t.jsx("div",{style:{fontWeight:500},children:z.name}),z.typeName&&t.jsx("div",{style:{fontSize:"0.875rem",color:"#6b7280"},children:z.typeName})]}),t.jsx("button",{type:"button",className:"btn btn-sm btn-primary",onClick:()=>C(z.id),disabled:_===z.id,children:_===z.id?"Adding...":"Add"})]},z.id))})]})})]})}const D_=20,IB=250,DN=Object.freeze([]),gf=e=>{if(!e)return null;if(e.id===void 0){const s=e.data??e.location??e.result;return s?gf(s):null}const n=e.locationType||e.location_type||(e.location_type_id?{id:e.location_type_id,name:e.location_type_name}:null);return{id:e.id,name:e.name||"Untitled location",typeId:n?.id??e.location_type_id??null,typeName:n?.name??e.location_type_name??""}},LB=e=>{if(!e)return{data:[],pagination:{hasMore:!1,total:0,limit:D_,offset:0}};if(Array.isArray(e))return{data:e.map(i=>gf(i)).filter(Boolean),pagination:{hasMore:!1,limit:e.length,offset:0,total:e.length}};const n=Array.isArray(e.data)?e.data:[],s=e.pagination&&typeof e.pagination=="object"?e.pagination:{hasMore:!1,limit:n.length,offset:0,total:n.length};return{data:n.map(i=>gf(i)).filter(Boolean),pagination:s}},DB=(e,n)=>{const[s,i]=u.useState(e);return u.useEffect(()=>{const l=setTimeout(()=>i(e),n);return()=>clearTimeout(l)},[e,n]),s},O_=({worldId:e,allowedTypeIds:n,value:s,onChange:i,placeholder:l="Search for location",disabled:o=!1,onLocationResolved:d,limit:f=D_,excludeIds:p})=>{const h=n!==void 0,y=u.useMemo(()=>n||DN,[n]),g=u.useMemo(()=>p||DN,[p]),[b,v]=u.useState(""),[S,N]=u.useState([]),[j,E]=u.useState(!1),[A,M]=u.useState(""),[_,T]=u.useState(!1),[k,C]=u.useState(!1),[L,z]=u.useState(0),[G,U]=u.useState(null),[X,V]=u.useState(!1),[R,B]=u.useState(""),D=DB(b,IB),O=u.useRef(null),$=u.useRef(null),F=u.useRef(0),H=o||!e,I=u.useCallback(()=>{N([]),C(!1),z(0),M("")},[]),Y=u.useCallback(()=>{T(!1)},[]),P=u.useCallback(Re=>{if(!Re){d?.(null);return}d?.(Re)},[d]);u.useEffect(()=>{if(!s){U(null),v(""),V(!0),P(null);return}const Re=String(s);if(G&&String(G.id)===Re){X||(v(G.name??""),V(!0));return}let ue=!1;const se=++F.current;return E(!0),M(""),ni(Re).then(Le=>{if(ue||se!==F.current)return;const be=gf(Le?.data||Le);be?(U(be),v(be.name),P(be)):(U(null),P(null)),V(!0)}).catch(Le=>{ue||se!==F.current||(U(null),M(Le.message||"Failed to load location"),P(null))}).finally(()=>{ue||se!==F.current||E(!1)}),()=>{ue=!0}},[s,G,X,P]),u.useEffect(()=>{if(!_)return;const Re=ue=>{O.current&&(O.current.contains(ue.target)||Y())};return document.addEventListener("mousedown",Re),()=>{document.removeEventListener("mousedown",Re)}},[_,Y]);const W=u.useCallback(async({append:Re=!1}={})=>{if(!e){I();return}const ue=D.trim();if(ue.length>0&&ue.length<2){Re||(N([]),E(!1));return}const se=Re?L:0,Le=++F.current;E(!0),M("");try{console.log(" [LocationSelect] Fetching locations...",{worldId:e,query:ue,allowedTypeIds:y,excludeIds:g});const De=await ri({worldId:e,includeEntities:"false",all:"true"});if(Le!==F.current)return;const Me=De?.data||[];console.log(" [LocationSelect] Fetched all locations:",{totalCount:Me.length,sampleLocations:Me.slice(0,5).map(ie=>({id:ie.id,name:ie.name,typeId:ie.location_type_id||ie.locationType?.id,typeName:ie.locationType?.name,parentId:ie.parent_id||ie.parent?.id}))});const mt=ue.toLowerCase(),ht=new Set(g.map(ie=>String(ie))),Ct=y.length>0?new Set(y.map(ie=>String(ie))):null;console.log(" [LocationSelect] Filtering locations...",{allowedTypeIds:y,allowedTypeIdSet:Ct?Array.from(Ct):null,excludeIds:Array.from(ht),hasAllowedTypes:!!Ct&&Ct.size>0,hasAllowedTypeIdsRestriction:h,isExplicitlyEmpty:h&&y.length===0});const At=Me.reduce((ie,ee)=>{const ce=String(ee.location_type_id||ee.locationType?.id||"unknown"),fe=ee.locationType?.name||"unknown";return ie[fe]||(ie[fe]={typeId:ce,locations:[]}),ie[fe].locations.push({id:ee.id,name:ee.name}),ie},{});console.log(" [LocationSelect] Locations by type before filter:",At);let we=Me.filter(ie=>{if(ht.has(String(ie.id))||ue&&!ie.name?.toLowerCase().includes(mt))return!1;if(h){if(y.length===0)return console.log(" [LocationSelect]  No allowed types - filtering out all locations"),!1;if(Ct&&Ct.size>0){const ee=ie.location_type_id||ie.locationType?.id,ce=ee?String(ee):"";if(ce&&Ct.has(ce))console.log(" [LocationSelect]  Included location (type matches):",{name:ie.name,typeId:ce,typeName:ie.locationType?.name});else return console.log(" [LocationSelect]  Excluded location (type not in allowed list):",{name:ie.name,typeId:ce,typeName:ie.locationType?.name,allowedTypeIds:Array.from(Ct),allowedTypeNames:Array.from(Ct).map(qe=>qe)}),!1}}return!0});console.log(" [LocationSelect] After filtering:",{before:Me.length,after:we.length,filteredLocations:we.map(ie=>({id:ie.id,name:ie.name,typeId:ie.location_type_id||ie.locationType?.id,typeName:ie.locationType?.name,parentId:ie.parent_id||ie.parent?.id}))});const st=se,lt=st+f,Fe=we.slice(st,lt),{data:Xe,pagination:dt}=LB(Fe);if(B(ue),Re)N(ie=>{const ce=ie.length+Xe.length<we.length;return C(ce),[...ie,...Xe]});else{N(Xe);const ee=Xe.length<we.length;C(ee)}z(lt)}catch(be){if(Le!==F.current)return;M(be.message||"Failed to search locations"),Re||N([])}finally{Le===F.current&&E(!1)}},[e,y,h,D,f,L,I,g]);u.useEffect(()=>{_&&W({append:!1})},[D,y,e,W,_]),u.useEffect(()=>{if(!_)return;const Re=G?String(G.id):"";if(!Re||!$.current)return;const ue=$.current.querySelector(`[data-location-option="${Re}"]`);ue&&ue.scrollIntoView({block:"nearest"})},[S,G,_]),u.useEffect(()=>{_&&R!==D.trim()&&I()},[D,R,_,I]);const le=()=>{H||T(!0)},K=Re=>{v(Re.target.value),_||T(!0)},de=Re=>{U(Re),v(Re.name??""),Y(),i?.(String(Re.id)),P(Re)},Q=()=>{j||!k||W({append:!0})},he=()=>{U(null),v(""),i?.(""),P(null),T(!1)},re=u.useMemo(()=>!H&&!!G?.id,[H,G]),Ce=u.useMemo(()=>H&&!e?"No world selected":l,[H,e,l]);return t.jsxs("div",{className:`entity-select${H?" disabled":""}`,ref:O,children:[t.jsxs("div",{className:"entity-select-input-wrapper",children:[t.jsx("input",{type:"text",className:"entity-select-input",value:b,onChange:K,onFocus:le,placeholder:Ce,disabled:H,"aria-autocomplete":"list","aria-expanded":_,"aria-haspopup":"listbox",role:"combobox"}),re&&t.jsx("button",{type:"button",className:"entity-select-clear",onClick:he,"aria-label":"Clear selection",children:""})]}),_&&t.jsxs("div",{className:"entity-select-dropdown",children:[t.jsx("ul",{className:"entity-select-results",role:"listbox",ref:$,children:S.map(Re=>{const ue=G&&String(G.id)===String(Re.id);return t.jsxs("li",{className:`entity-select-option${ue?" selected":""}`,onMouseDown:se=>{se.preventDefault(),de(Re)},"data-location-option":Re.id,role:"option","aria-selected":ue,children:[t.jsx("span",{className:"entity-select-option-name",children:Re.name}),Re.typeName&&t.jsx("span",{className:"entity-select-option-type",children:Re.typeName})]},Re.id)})}),j&&t.jsx("div",{className:"entity-select-status",role:"status",children:"Loading"}),!j&&S.length===0&&!A&&D.trim().length>=2&&t.jsx("div",{className:"entity-select-status",children:"No matching locations found."}),!j&&S.length===0&&!A&&D.trim().length>0&&D.trim().length<2&&t.jsx("div",{className:"entity-select-status",children:"Type at least 2 characters to search."}),!j&&S.length===0&&!A&&D.trim().length===0&&t.jsx("div",{className:"entity-select-status",children:"Start typing to search for locations."}),A&&t.jsx("div",{className:"entity-select-error",children:A}),k&&!j&&t.jsx("button",{type:"button",className:"entity-select-load-more",onClick:Q,children:"Load more"})]})]})};O_.propTypes={worldId:It.oneOfType([It.string,It.number]),allowedTypeIds:It.arrayOf(It.oneOfType([It.string,It.number])),value:It.oneOfType([It.string,It.number]),onChange:It.func,placeholder:It.string,disabled:It.bool,onLocationResolved:It.func,limit:It.number,excludeIds:It.arrayOf(It.oneOfType([It.string,It.number]))};function OB({location:e,worldId:n,path:s=[],onLocationsChange:i}){const{user:l}=un(),{activeWorldId:o}=wn();to();const[d,f]=u.useState([]),[p,h]=u.useState(!1),[y,g]=u.useState(""),[b,v]=u.useState(!1),[S,N]=u.useState(""),[j,E]=u.useState(!1),[A,M]=u.useState([]),[_,T]=u.useState(null),[k,C]=u.useState(null);u.useRef(`location-form-${Math.random().toString(36).slice(2)}`),l?.role;const L=u.useCallback(async()=>{if(!e?.id||!n){f([]);return}h(!0),g("");try{const I=await ri({worldId:n,parentId:e.id,includeEntities:"false"});f(I?.data||[])}catch(I){console.error(" Failed to load child locations:",I),g(I.message||"Failed to load child locations")}finally{h(!1)}},[e?.id,n]);u.useEffect(()=>{L()},[L]);const z=u.useCallback(async()=>{if(o)try{const I=await Nr({worldId:o});M(I?.data||[])}catch(I){console.error(" Failed to load location types:",I)}},[o]);u.useEffect(()=>{z()},[z]);const G=u.useCallback(async I=>{if(!(!e?.id||!I)){C(I);try{await t1(e.id,I),await L(),i&&i(),v(!1),N(""),E(!1)}catch(Y){console.error("Failed to add child location:",Y);const P=Y.message||"Failed to add child location";P.includes("ancestor")?alert("Cannot add this location as a child because it is an ancestor of the current location. This would create a circular reference."):alert(P)}finally{C(null)}}},[e?.id,L,i]),U=u.useCallback(I=>{I&&G(I)},[G]),X=u.useCallback(()=>{E(!0)},[]),V=u.useCallback(async I=>{I?.id?await G(I.id):(v(!1),E(!1))},[G]),R=u.useCallback(()=>{E(!1)},[]),B=u.useCallback(()=>{v(!1),N(""),E(!1)},[]),[D,O]=u.useState([]);u.useEffect(()=>{if(!e?.id){O([]);return}(async()=>{try{const{fetchLocationPath:Y}=await ci(async()=>{const{fetchLocationPath:K}=await Promise.resolve().then(()=>o1);return{fetchLocationPath:K}},void 0),le=((await Y(e.id))?.data||[]).filter(K=>K.id!==e.id).map(K=>K.id);O(le)}catch(Y){console.error("Failed to load location path:",Y),O([])}})()},[e?.id]);const $=u.useMemo(()=>[e?.id,...d.map(I=>I.id),...D].filter(Boolean),[e?.id,d,D]),F=u.useMemo(()=>{if(!e?.location_type_id||!A||A.length===0)return[];const I=String(e.location_type_id);return A.find(P=>String(P.id)===I),bB(I,A)},[e?.location_type_id,A]),H=u.useCallback(async I=>{if(!(!e?.id||!I)&&confirm("Are you sure you want to remove this location as a child?")){T(I);try{await n1(e.id,I),await L(),i&&i()}catch(Y){console.error("Failed to remove child location:",Y),alert(Y.message||"Failed to remove child location")}finally{T(null)}}},[e?.id,L,i]);return p?t.jsx("div",{className:"entity-tab-content",children:t.jsxs("section",{className:"entity-card bg-white rounded-lg border p-4 sm:p-6 w-full",children:[t.jsx("h2",{className:"entity-card-title",children:"Locations"}),t.jsx("p",{children:"Loading locations..."})]})}):y?t.jsx("div",{className:"entity-tab-content",children:t.jsxs("section",{className:"entity-card bg-white rounded-lg border p-4 sm:p-6 w-full",children:[t.jsx("h2",{className:"entity-card-title",children:"Locations"}),t.jsx("div",{className:"alert error",children:y})]})}):t.jsxs("div",{className:"entity-tab-content",children:[e?.parent&&t.jsxs("section",{className:"entity-card bg-white rounded-lg border p-4 sm:p-6 w-full",style:{marginBottom:"1rem"},children:[t.jsx("h2",{className:"entity-card-title",children:"Parent Location"}),t.jsx("div",{style:{marginTop:"0.5rem"},children:t.jsxs(Yt,{to:`/locations/${e.parent.id}`,style:{display:"flex",alignItems:"center",gap:"0.5rem",textDecoration:"none",color:"inherit"},children:[t.jsx(Jd,{size:16}),t.jsx("span",{style:{fontWeight:500},children:e.parent.name})]})})]}),t.jsxs("section",{className:"entity-card bg-white rounded-lg border p-4 sm:p-6 w-full",children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1rem"},children:[t.jsx("h2",{className:"entity-card-title",style:{margin:0},children:"Child Locations"}),t.jsxs("button",{type:"button",className:"btn btn-primary",onClick:()=>v(!0),style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[t.jsx(Wn,{size:16}),t.jsx("span",{children:"Add Location"})]})]}),d.length===0?t.jsx("p",{className:"entity-empty-state",children:"This location has no child locations."}):t.jsx("div",{className:"entity-list",children:d.map(I=>t.jsxs("div",{className:"entity-list-item",style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"0.75rem",marginBottom:"0.5rem",border:"1px solid #e5e7eb",borderRadius:"0.5rem",backgroundColor:"#f9fafb"},children:[t.jsxs("div",{style:{flex:1,minWidth:0},children:[t.jsxs("span",{className:"location-link-with-preview",style:{display:"flex",alignItems:"center",gap:"0.5rem",flex:1},children:[t.jsxs(Yt,{to:`/locations/${I.id}`,style:{display:"flex",alignItems:"center",gap:"0.5rem",textDecoration:"none",color:"inherit",flex:1},children:[t.jsx(Jd,{size:16}),t.jsx("span",{style:{fontWeight:500},children:I.name})]}),t.jsx(fs,{locationId:I.id,locationName:I.name})]}),I.locationType&&t.jsxs("span",{style:{color:"#6b7280",fontSize:"0.875rem"},children:["(",I.locationType.name,")"]}),I.childCount>0&&t.jsx(xr,{size:16,style:{marginLeft:"auto",color:"#6b7280"}}),I.description&&t.jsx("p",{style:{marginTop:"0.25rem",marginLeft:"1.5rem",color:"#6b7280",fontSize:"0.875rem",margin:"0.25rem 0 0 1.5rem"},children:I.description})]}),t.jsx("button",{type:"button",className:"btn btn-sm btn-danger",onClick:()=>H(I.id),disabled:_===I.id,style:{marginLeft:"1rem",display:"flex",alignItems:"center",gap:"0.25rem"},title:"Remove child location",children:_===I.id?t.jsx("span",{children:"Removing..."}):t.jsxs(t.Fragment,{children:[t.jsx(zn,{size:14}),t.jsx("span",{children:"Remove"})]})})]},I.id))})]}),t.jsx(Ps,{isOpen:b,onClose:B,title:j?"Create Location":"Add Child Location",size:"md",children:j?t.jsx(I_,{location:null,parentId:e?.id,locationTypes:A,onClose:R,onSuccess:V}):t.jsxs("div",{children:[t.jsxs("div",{style:{marginBottom:"1.5rem"},children:[t.jsx("label",{htmlFor:"location-select",style:{display:"block",marginBottom:"0.5rem",fontWeight:500},children:"Search and select a location"}),t.jsx(O_,{worldId:o,value:S,onChange:U,placeholder:"Type to search locations...",excludeIds:$,allowedTypeIds:F,onLocationResolved:I=>{I&&N(I.id)}})]}),t.jsxs("div",{style:{marginTop:"1.5rem",paddingTop:"1.5rem",borderTop:"1px solid #e5e7eb"},children:[t.jsx("p",{style:{marginBottom:"0.75rem",color:"#6b7280",fontSize:"0.875rem"},children:"Can't find the location you're looking for?"}),t.jsxs("button",{type:"button",className:"btn secondary",onClick:X,style:{width:"100%"},children:[t.jsx(Wn,{size:16,style:{marginRight:"0.5rem"}}),"Create New Location"]})]})]})})]})}const $B={private:"Private",companions:"Shared with companions",dm:"Shared with DM",party:"Share with Party"},FB=[{value:"private",label:"Private"},{value:"companions",label:"My Companions"}],zB=[{value:"private",label:"Private"},{value:"party",label:"Share with Party"}],oy=e=>{if(!e)return"";if(e instanceof Date){if(Number.isNaN(e.getTime()))return"";try{return e.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(n){return console.warn("Unable to format Date object",n,e),""}}if(typeof e=="string"||typeof e=="number")try{const n=new Date(e);return Number.isNaN(n.getTime())?(console.warn("Invalid date value:",e),""):n.toLocaleString(void 0,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(n){return console.warn("Unable to parse date value",n,e),""}return console.warn("Unexpected date value type:",typeof e,e),""},cy=e=>e?.author?.username||e?.author?.name||e?.author?.email||e?.author_name||e?.author_email||"Unknown adventurer",ON=e=>{const n=e?.author||{},s=n?.id??n?.authorId??e?.authorId??e?.author_id??e?.authorID;if(s!=null)return`id:${String(s)}`;const i=n?.email??e?.author_email;if(i)return`email:${String(i).toLowerCase()}`;const l=n?.username??n?.name??e?.author_username??e?.author_name;return l?`name:${String(l).toLowerCase()}`:"unknown"},va=Object.freeze([]),$N="What do you want to remember?";function $_({location:e,worldId:n,selectedCampaign:s,selectedCampaignId:i,isCampaignDm:l,isCampaignPlayer:o,canCreateNote:d,notes:f=va,loading:p,error:h,onCreateNote:y,creating:g,campaignMatchesLocationWorld:b,onNoteUpdate:v,onNoteDelete:S}){const{user:N}=un(),[j,E]=u.useState(""),[A,M]=u.useState("private"),[_,T]=u.useState(""),[k,C]=u.useState(va),[L,z]=u.useState(!1),[G,U]=u.useState(""),[X,V]=u.useState(""),[R,B]=u.useState(""),[D,O]=u.useState(!1),[$,F]=u.useState("all"),[H,I]=u.useState("notes"),[Y,P]=u.useState("location"),[W,le]=u.useState(null),[K,de]=u.useState(""),[Q,he]=u.useState("private"),[re,Ce]=u.useState(""),[Re,ue]=u.useState(!1),[se,Le]=u.useState(null),[be,De]=u.useState({items:va,loading:!1,error:"",loaded:!1}),[Me,mt]=u.useState({items:va,loading:!1,error:"",loaded:!1}),[ht,Ct]=u.useState(()=>new Set),At=!!i&&!!d&&!!b,we=u.useMemo(()=>l?zB:FB,[l]),st=u.useMemo(()=>n||e&&typeof e=="object"&&((e.world||{}).id||e.world_id)||"",[e,n]),lt=u.useCallback(Z=>{if(!N||!Z)return!1;const je=Z?.author?.id??Z?.createdBy??Z?.created_by??Z?.authorId??Z?.author_id??null;return je?String(je)===String(N.id):!1},[N]),Fe=u.useCallback((Z,je)=>{const Ne=typeof je=="string"?je:typeof Z?.target?.value=="string"?Z.target.value:"";E(Ne),V("")},[]),Xe=u.useCallback(async(Z,je)=>{const Ne=Z?.trim()??"";if(typeof je!="function")return;if(!st||Ne.length===0){je([]);return}const{searchMentions:pe}=await ci(async()=>{const{searchMentions:Ue}=await import("./mentionSearch-CLdrbUuU.js");return{searchMentions:Ue}},[]);await pe({worldId:st,query:Ne,limit:8,callback:je})},[st]),dt=u.useCallback(()=>{O(!1),V(""),B("")},[]),ie=u.useCallback(()=>{At&&(V(""),B(""),O(!0))},[At]),ee=u.useCallback(async Z=>{if(Z.preventDefault(),!At||!y)return;const je=j.trim();if(!je){V("Please enter a note before saving");return}if(o&&!_){V("Select which character this note is for");return}V(""),B("");try{const Ne={content:je,shareType:A,campaignId:i};o&&(Ne.characterId=_);const pe=await y(Ne);if(!pe||pe.success!==!0){V(pe?.message||"Failed to save note");return}E(""),o||T(""),dt()}catch(Ne){console.error("Failed to submit note",Ne),V(Ne.message||"Failed to save note")}},[At,j,y,A,i,o,_,dt]),ce=u.useCallback(()=>{le(null),de(""),he("private"),Ce(""),V("")},[]),fe=u.useCallback(Z=>{if(!Z||!e?.id)return;const je=Z?.characterId??Z?.character_id??"";le(Z.id),de(Z?.content??""),he(Z?.shareType??Z?.share_type??"private"),Ce(je),V("")},[e?.id]),qe=u.useCallback((Z,je)=>{const Ne=typeof je=="string"?je:typeof Z?.target?.value=="string"?Z.target.value:"";de(Ne),V("")},[]),Pe=u.useCallback(async Z=>{if(!Z||!e?.id||!i)return;const je=K.trim();if(!je){V("Please enter a note before saving");return}const Ne=Z?.characterId??Z?.character_id??"";if(o&&Ne&&!re){V("Select which character this note is for");return}ue(!0),V("");try{const pe={content:je,shareType:Q,campaignId:i};o&&re&&(pe.characterId=re);const Ue=await jg(e.id,Z.id,pe),ae=Ue?.data||Ue;if(!ae)throw new Error("Note could not be updated");v&&await v(ae),ce()}catch(pe){console.error("Failed to update note",pe),V(pe.message||"Failed to update note")}finally{ue(!1)}},[e?.id,i,K,Q,re,o,v,ce]),Be=u.useCallback(async Z=>{if(!(!Z?.id||!e?.id||!i||!window.confirm("Are you sure you want to delete this note? This action cannot be undone."))){Le(Z.id),V("");try{await Eg(e.id,Z.id,{campaignId:i}),S&&await S(Z.id)}catch(Ne){console.error("Failed to delete note",Ne),V(Ne.message||"Failed to delete note")}finally{Le(null)}}},[e?.id,i,S]),Te=u.useMemo(()=>{const Z=Array.isArray(f)?f:va;return Z.length<=1?Z:[...Z].sort((je,Ne)=>{const pe=new Date(je?.createdAt??je?.created_at??0).getTime(),Ue=new Date(Ne?.createdAt??Ne?.created_at??0).getTime();return Number.isNaN(pe)||Number.isNaN(Ue)?0:Ue-pe})},[f]),gt=u.useMemo(()=>{const Z=[{value:"all",label:"All notes"}],je=new Set(["all"]);return Te.forEach(Ne=>{const pe=ON(Ne);!pe||je.has(pe)||(je.add(pe),Z.push({value:pe,label:cy(Ne)}))}),Z},[Te]),jt=u.useMemo(()=>$==="all"?Te:Te.filter(Z=>ON(Z)===$),[$,Te]),Mt=u.useMemo(()=>Array.isArray(be.items)?be.items:va,[be.items]),tt=u.useMemo(()=>Array.isArray(Me.items)?Me.items:va,[Me.items]);u.useEffect(()=>{M("private")},[l,i]),u.useEffect(()=>{gt.some(Z=>Z.value===$)||F("all")},[gt,$]),u.useEffect(()=>{De({items:va,loading:!1,error:"",loaded:!1}),mt({items:va,loading:!1,error:"",loaded:!1}),Ct(new Set),P("location")},[i,e?.id,b]),u.useEffect(()=>{let Z=!1;return!o||!i?(C(va),z(!1),U(""),T(""),()=>{Z=!0}):((async()=>{z(!0),U("");try{const Ne=await Cs({scope:"my",campaign_id:i});if(Z)return;const Ue=(Array.isArray(Ne?.data)?Ne.data:Array.isArray(Ne)?Ne:[]).map(ae=>({id:ae?.id?String(ae.id):"",name:ae?.name||"Unnamed character"})).filter(ae=>ae.id);C(Ue),Ue.length===1?T(Ue[0].id):Ue.some(ae=>ae.id===_)||T("")}catch(Ne){if(Z)return;console.error("Failed to load characters for notes",Ne),C(va),T(""),U(Ne.message||"Failed to load characters")}finally{Z||z(!1)}})(),()=>{Z=!0})},[o,i,_]);const ft=u.useCallback(async()=>{if(!(!e?.id||!i||!b)){De(Z=>({...Z,loading:!0,error:""}));try{const Z=await r1(e.id,{campaignId:i}),je=Array.isArray(Z?.data)?Z.data:Array.isArray(Z)?Z:va;De({items:je,loading:!1,error:"",loaded:!0})}catch(Z){De({items:va,loading:!1,error:Z?.message||"Failed to load mentions",loaded:!0})}}},[b,e?.id,i]),Rt=u.useCallback(async()=>{if(!(!e?.id||!i||!b)){mt(Z=>({...Z,loading:!0,error:""}));try{const Z=await i1(e.id,{campaignId:i}),je=Array.isArray(Z?.data)?Z.data:Array.isArray(Z)?Z:va;mt({items:je,loading:!1,error:"",loaded:!0})}catch(Z){mt({items:va,loading:!1,error:Z?.message||"Failed to load mentions",loaded:!0})}}},[b,e?.id,i]);u.useEffect(()=>{H==="mentions"&&(!be.loading&&!be.loaded&&ft(),!Me.loading&&!Me.loaded&&Rt())},[H,be.loading,be.loaded,Me.loading,Me.loaded,ft,Rt]);const Ft=s?.name||"",Zt=u.useCallback(Z=>{const je=cy(Z),Ne=Z?.character?.name||"";return Ne?`${je} (as ${Ne})`:je},[]),Tt=u.useCallback(Z=>{const je=String(Z?.shareType??Z?.share_type??"private");return $B[je]||"Private"},[]),We=u.useCallback(Z=>{const je=Bi(Z?.content||"",Z?.mentions);return je.length?je.map((Ne,pe)=>{if(Ne.type==="mention"){if(Ne.locationId){const Ke=`${Z?.id||"note"}-mention-${pe}`,ot=Ne.locationName||"location";return t.jsxs("span",{className:"entity-note-mention",children:["@",ot,t.jsx(fs,{locationId:Ne.locationId,locationName:ot})]},Ke)}if(Ne.entityId){const Ke=`${Z?.id||"note"}-mention-${pe}`,ot=Ne.entityName||"entity";return t.jsxs("span",{className:"entity-note-mention",children:["@",ot,t.jsx(Na,{entityId:Ne.entityId,entityName:ot})]},Ke)}const Ue=Ne.locationName||Ne.entityName||"mention",ae=`${Z?.id||"note"}-mention-${pe}`;return t.jsxs("span",{className:"entity-note-mention",children:["@",Ue]},ae)}return t.jsx("span",{className:"entity-note-text",children:Ne.text},`${Z?.id||"note"}-text-${pe}`)}):null},[]),it=u.useCallback(Z=>{const je=Bi(Z?.content,Z?.mentions);if(!je.length)return"";const Ne=je.map(pe=>pe.type==="mention"?`@${pe.locationName||pe.entityName||"mention"}`:pe.text||"").join("").replace(/\s+/g," ").trim();return Ne.length<=180?Ne:`${Ne.slice(0,177)}`},[]),bt=u.useCallback(Z=>{const je=Z?.sessionDate??Z?.session_date;if(!je)return"";try{const Ne=new Date(je);if(!Number.isNaN(Ne.getTime()))return Ne.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}catch(Ne){return console.warn("Unable to format session date",Ne),je}return je},[]),oe=u.useCallback(Z=>{const je=String(Z);Ct(Ne=>{const pe=new Set(Ne);return pe.has(je)?pe.delete(je):pe.add(je),pe})},[]),Ee=u.useCallback(Z=>ht.has(String(Z)),[ht]),Se=u.useCallback(()=>{!e?.id||!i||!b||(Y==="location"?ft():Rt())},[b,e?.id,ft,Rt,Y,i]),Ve=g,xe=g||!j.trim()||o&&!_,$e=Te.length===0||gt.length<=1,He=o&&At,J=He&&k.length===1;return u.useEffect(()=>{(H!=="notes"||!At)&&D&&dt()},[H,At,D,dt]),h==="CAMPAIGN_CONTEXT_ACCESS_DENIED"?t.jsx("div",{className:"entity-notes-container",children:t.jsxs("div",{className:"alert error",style:{padding:"1.5rem",maxWidth:"600px",margin:"2rem auto"},children:[t.jsx("h2",{style:{marginTop:0,marginBottom:"1rem"},children:"Access Restricted by Campaign Context"}),t.jsx("p",{style:{marginBottom:"1rem"},children:"You don't have access to notes for this location with your current campaign context selected."}),t.jsx("p",{children:"To view notes, please change your campaign context using the selector in the header to a campaign that has access to this location."})]})}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"entity-notes-card-strict",children:[t.jsxs("div",{className:"entity-notes-header-row",children:[t.jsx("h2",{className:"entity-notes-title",children:"Notes"}),H==="notes"&&At?t.jsx("button",{type:"button",className:"btn-primary",onClick:ie,disabled:g,children:"+ Create note"}):null]}),s?.name?t.jsxs("p",{className:"entity-notes-campaign-line",children:["Campaign: ",Ft]}):null,t.jsxs("div",{className:"entity-notes-tabs-row",children:[t.jsx("button",{type:"button",className:`entity-notes-strict-tab-button${H==="notes"?" active":""}`,onClick:()=>I("notes"),children:"Notes"}),t.jsx("button",{type:"button",className:`entity-notes-strict-tab-button${H==="mentions"?" active":""}`,onClick:()=>I("mentions"),children:"@Mentions"})]}),H==="notes"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"entity-notes-strict-filter",children:[t.jsx("span",{className:"entity-notes-strict-filter-label",children:"Show notes from"}),t.jsx("select",{className:"entity-notes-strict-filter-select",value:$,onChange:Z=>F(Z.target.value),disabled:$e,children:gt.map(Z=>t.jsx("option",{value:Z.value,children:Z.label},Z.value))})]}),h?t.jsxs("div",{className:"entity-notes-strict-alert error",children:[t.jsx(ta,{size:16}),t.jsx("p",{children:h})]}):null,p?t.jsxs("div",{className:"entity-notes-strict-loading",children:[t.jsx(mn,{className:"spin",size:20}),t.jsx("span",{children:"Loading notes"})]}):null,!p&&jt.length===0?t.jsx("p",{className:"entity-notes-strict-empty",children:"No notes yet."}):null,!p&&jt.length>0?t.jsx("div",{className:"entity-notes-strict-list",children:jt.map(Z=>{const je=Z?.createdAt??Z?.created_at??Z?.timestamp??null,Ne=oy(je);String(Z?.shareType??Z?.share_type??"private");const pe=W===Z?.id,Ue=lt(Z);return Z?.characterId??Z?.character_id,t.jsx("div",{className:"entity-notes-strict-note-item",children:pe?t.jsxs("div",{className:"entity-notes-strict-edit-panel",children:[t.jsx(Gl,{value:K,onChange:qe,markup:"@[__display__](__id__)",placeholder:$N,className:"entity-note-mentions",inputProps:{className:"entity-notes-strict-textarea","aria-label":"Edit note content",rows:5,required:!0},children:t.jsx(li,{trigger:"@",markup:"@[__display__](__id__)",displayTransform:(ae,Ke)=>`@${Ke||(ae.includes(":")?ae.split(":")[1]:ae)}`,data:Xe,appendSpaceOnAdd:!0})}),t.jsx("p",{className:"entity-notes-strict-share-label",children:"Share with"}),t.jsx("div",{className:"entity-notes-strict-share-options",children:we.map(ae=>t.jsxs("label",{className:"entity-notes-strict-share-option",children:[t.jsx("input",{type:"radio",name:`location-note-share-edit-${Z.id}`,value:ae.value,checked:Q===ae.value,onChange:()=>he(ae.value),disabled:Re}),ae.value==="private"?"Private":ae.value==="party"?"Share with Party":ae.label]},ae.value))}),X?t.jsxs("div",{className:"entity-notes-strict-alert error",children:[t.jsx(ta,{size:16}),t.jsx("p",{children:X})]}):null,t.jsxs("div",{className:"entity-notes-strict-edit-actions",children:[t.jsx("button",{type:"button",className:"btn-primary",onClick:()=>Pe(Z),disabled:Re||!K.trim(),children:Re?t.jsxs(t.Fragment,{children:[t.jsx(mn,{className:"spin",size:16})," Saving"]}):"Save"}),t.jsx("button",{type:"button",className:"btn-secondary",onClick:ce,disabled:Re,children:"Cancel"})]})]}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"entity-notes-strict-note-header",children:[t.jsxs("div",{className:"entity-notes-strict-note-title-row",children:[t.jsx("span",{className:"entity-notes-strict-note-title",children:Zt(Z)}),t.jsx("span",{className:"entity-notes-strict-note-visibility",children:Tt(Z)})]}),t.jsx("span",{className:"entity-notes-strict-note-timestamp",children:Ne||""})]}),t.jsx("p",{className:"entity-notes-strict-note-body",children:We(Z)}),Ue?t.jsxs("div",{className:"entity-notes-strict-note-actions",children:[t.jsx("button",{type:"button",className:"entity-notes-strict-edit-button",onClick:()=>fe(Z),children:"Edit"}),t.jsx("button",{type:"button",className:"entity-notes-strict-delete-button",onClick:()=>Be(Z),disabled:se===Z.id,children:se===Z.id?t.jsx(mn,{className:"spin",size:14}):"Delete"})]}):null]})},Z?.id)})}):null]}):t.jsxs("div",{className:"entity-notes-strict-mentions",children:[t.jsxs("div",{className:"entity-notes-strict-mentions-header",children:[t.jsxs("div",{className:"entity-notes-strict-mention-toggle",children:[t.jsxs("button",{type:"button",className:`entity-notes-strict-mention-toggle-button${Y==="location"?" active":""}`,onClick:()=>P("location"),children:["Location Notes",be.loaded?t.jsx("span",{className:"entity-notes-strict-mention-count",children:Mt.length}):null]}),t.jsxs("button",{type:"button",className:`entity-notes-strict-mention-toggle-button${Y==="session"?" active":""}`,onClick:()=>P("session"),children:["Session Notes",Me.loaded?t.jsx("span",{className:"entity-notes-strict-mention-count",children:tt.length}):null]})]}),t.jsx("button",{type:"button",className:"btn-secondary",onClick:Se,disabled:!i||!b||(Y==="location"?be.loading:Me.loading),children:(Y==="location"?be.loading:Me.loading)?t.jsxs(t.Fragment,{children:[t.jsx(mn,{className:"spin",size:16})," Refreshing"]}):"Refresh"})]}),Y==="location"?t.jsxs(t.Fragment,{children:[be.error?t.jsxs("div",{className:"entity-notes-strict-alert error",children:[t.jsx(ta,{size:16}),t.jsx("p",{children:be.error})]}):null,be.loading?t.jsxs("div",{className:"entity-notes-strict-loading",children:[t.jsx(mn,{className:"spin",size:20}),t.jsx("span",{children:"Loading mentions"})]}):null,!be.loading&&be.loaded&&Mt.length===0?t.jsx("p",{className:"entity-notes-strict-empty",children:"This location hasn't been mentioned in location or entity notes yet."}):null,!be.loading&&be.loaded&&Mt.length>0?t.jsx("div",{className:"entity-notes-strict-list",children:Mt.map((Z,je)=>{const Ne=Z?.id??Z?.locationNoteId??Z?.location_note_id??`location-mention-${je}`,pe=String(Ne),Ue=Z?.createdAt??Z?.created_at,ae=Ue?new Date(Ue):null,Ke=oy(ae),ot=Z?.location?.name??Z?.locationName??"Unnamed location",St=Z?.location?.id??Z?.locationId??Z?.location_id??null,me=Z?.entity?.name??Z?.entityName??"Unnamed entity",nt=Z?.entity?.id??Z?.entityId??Z?.entity_id??null;return t.jsxs("div",{className:"entity-notes-strict-note-item",children:[t.jsxs("div",{className:"entity-notes-strict-note-header",children:[t.jsxs("div",{className:"entity-notes-strict-note-title-row",children:[t.jsxs("span",{className:"entity-notes-strict-note-title",children:[Zt(Z),St?t.jsxs(t.Fragment,{children:[" ","on"," ",t.jsx("span",{style:{fontWeight:500},children:ot})," ",t.jsx(fs,{locationId:St,locationName:ot})]}):nt?t.jsxs(t.Fragment,{children:[" ","on"," ",t.jsx("span",{style:{fontWeight:500},children:me})," ",t.jsx(Na,{entityId:nt,entityName:me})]}):null]}),t.jsx("span",{className:"entity-notes-strict-note-visibility",children:Tt(Z)})]}),t.jsx("span",{className:"entity-notes-strict-note-timestamp",children:Ke||""})]}),t.jsx("p",{className:"entity-notes-strict-note-body",children:We(Z)})]},`location-mention-${pe}`)})}):null]}):t.jsxs(t.Fragment,{children:[Me.error?t.jsxs("div",{className:"entity-notes-strict-alert error",children:[t.jsx(ta,{size:16}),t.jsx("p",{children:Me.error})]}):null,Me.loading?t.jsxs("div",{className:"entity-notes-strict-loading",children:[t.jsx(mn,{className:"spin",size:20}),t.jsx("span",{children:"Loading session mentions"})]}):null,!Me.loading&&Me.loaded&&tt.length===0?t.jsx("p",{className:"entity-notes-strict-empty",children:"This location hasn't been mentioned in session notes yet."}):null,!Me.loading&&Me.loaded&&tt.length>0?t.jsx("div",{className:"entity-notes-strict-list",children:tt.map((Z,je)=>{const Ne=Z?.id??Z?.noteId??Z?.note_id??`session-mention-${je}`,pe=String(Ne),Ue=Ee(pe),ae=it(Z),Ke=Z?.sessionTitle??Z?.session_title??"Session note";bt(Z),cy(Z);const ot=Z?.updatedAt??Z?.updated_at??Z?.createdAt??Z?.created_at,St=ot?new Date(ot):null,me=oy(St),nt=ae||"This session note does not include any text.";return t.jsxs("div",{className:"entity-notes-strict-note-item",children:[t.jsxs("div",{className:"entity-notes-strict-note-header",children:[t.jsx("div",{className:"entity-notes-strict-note-title-row",children:t.jsx("span",{className:"entity-notes-strict-note-title",children:Ke})}),t.jsx("span",{className:"entity-notes-strict-note-timestamp",children:me||""})]}),Ue?t.jsx("p",{className:"entity-notes-strict-note-body",children:We(Z)}):t.jsx("p",{className:"entity-notes-strict-note-body",children:nt}),t.jsx("div",{className:"entity-notes-strict-note-actions",children:t.jsx("button",{type:"button",className:"entity-notes-strict-action-button",onClick:()=>oe(pe),children:Ue?"Hide note":"View note"})})]},`session-mention-${pe}`)})}):null]})]})]}),t.jsx(Ps,{isOpen:D&&At,onClose:dt,title:"Create note",children:t.jsx("div",{className:"entity-notes-form",children:t.jsxs("form",{onSubmit:ee,className:"entity-notes-form-body",children:[t.jsx("label",{className:"entity-notes-label",htmlFor:"location-note-content",children:"Note"}),t.jsx("div",{className:"entity-note-editor-field",children:t.jsx(Gl,{value:j,onChange:Fe,markup:"@[__display__](__id__)",placeholder:$N,className:"entity-note-mentions",inputProps:{id:"location-note-content",className:"entity-note-textarea","aria-label":"Location note content",rows:5,required:!0,"data-autofocus":!0},children:t.jsx(li,{trigger:"@",markup:"@[__display__](__id__)",displayTransform:(Z,je)=>`@${je}`,data:Xe,appendSpaceOnAdd:!0})})}),t.jsxs("fieldset",{className:"entity-notes-share",children:[t.jsx("legend",{children:"Share with"}),we.map(Z=>t.jsxs("label",{className:"entity-notes-share-option",children:[t.jsx("input",{type:"radio",name:"location-note-share",value:Z.value,checked:A===Z.value,onChange:()=>M(Z.value),disabled:Ve}),t.jsx("span",{children:Z.label})]},Z.value))]}),He?t.jsxs("div",{className:"entity-notes-character",children:[t.jsx("label",{htmlFor:"location-note-character",children:"Character"}),t.jsxs("select",{id:"location-note-character",value:_,onChange:Z=>T(Z.target.value),disabled:L||J,required:!0,children:[t.jsx("option",{value:"",disabled:!0,children:L?"Loading characters":"Select character"}),k.map(Z=>t.jsx("option",{value:Z.id,children:Z.name},Z.id))]}),J?t.jsxs("p",{className:"entity-notes-hint",children:["Notes will be associated with your character ",k[0]?.name,"."]}):null,G?t.jsxs("div",{className:"entity-notes-alert error",children:[t.jsx(ta,{size:16}),t.jsx("p",{children:G})]}):null,!L&&!G&&k.length===0?t.jsx("p",{className:"entity-notes-hint",children:"You need an active character in this campaign to attach notes."}):null]}):null,X?t.jsxs("div",{className:"entity-notes-alert error",children:[t.jsx(ta,{size:16}),t.jsx("p",{children:X})]}):null,R?t.jsx("div",{className:"entity-notes-alert success",children:t.jsx("p",{children:R})}):null,t.jsx("div",{className:"entity-notes-actions",children:t.jsx("button",{type:"submit",className:"primary",disabled:xe,children:g?t.jsxs(t.Fragment,{children:[t.jsx(mn,{className:"spin",size:16})," Saving"]}):"Save note"})})]})})})]})}$_.propTypes={location:It.object,worldId:It.oneOfType([It.string,It.number]),selectedCampaign:It.object,selectedCampaignId:It.oneOfType([It.string,It.number]),isCampaignDm:It.bool,isCampaignPlayer:It.bool,canCreateNote:It.bool,notes:It.arrayOf(It.object),loading:It.bool,error:It.string,onCreateNote:It.func,creating:It.bool,campaignMatchesLocationWorld:It.bool,onNoteUpdate:It.func,onNoteDelete:It.func};const BB=e=>{const n=e?.options?.choices;return!Array.isArray(n)||n.length===0?[]:n.map((s,i)=>{if(s==null)return null;if(typeof s=="object"){const o=s.value??s.id??s.key??s.slug??`choice-${i}`,d=s.label??s.name??s.title??s.display??o;return o==null?null:{value:o,label:String(d??o)}}const l=String(s);return{value:l,label:l}}).filter(Boolean)},UB=e=>{if(!e?.name)return null;const n=`metadata.${e.name}`,s=e.visibleByDefault!==void 0?!!e.visibleByDefault:e.visible_by_default!==void 0?!!e.visible_by_default:!0,i={key:n,name:n,label:e.label||e.name,metadataField:e.name,dataType:e.dataType||e.data_type,visibleByDefault:s};switch(e.dataType||e.data_type){case"text":return{...i,type:"textarea",rows:3};case"boolean":return{...i,type:"boolean"};case"enum":return{...i,type:"select",options:BB(e)};case"number":return{...i,type:"text",inputType:"number"};case"date":return{...i,type:"text"};case"entity_reference":case"location_reference":case"reference":{const l=e.referenceTypeId??e.reference_type_id??e.referenceType?.id??null,o=e.referenceTypeName??e.reference_type_name??e.referenceType?.name??"",d=e.referenceFilter??e.reference_filter??e.referenceFilterJson??{},f=(()=>{if(e.displayValue)return String(e.displayValue);if(e.display)return String(e.display);if(e.selectedLabel)return String(e.selectedLabel);const p=e.value;if(!p||typeof p!="object")return"";const h=p.label??p.name??p.title??p.display??p.displayName??p.text??p.value;return h!=null?String(h):""})();return{...i,type:"reference",referenceTypeId:l,referenceTypeName:o,referenceFilter:d,displayKey:`metadataDisplay.${e.name}`,selectedLabel:f}}default:return{...i,type:"text"}}};function qB(){const{id:e}=Ka(),n=_n(),{user:s,token:i,sessionReady:l}=un(),{activeWorldId:o,selectedCampaignId:d,selectedCampaign:f}=wn(),p=to(),[h,y]=u.useState(null),[g,b]=u.useState([]),[v,S]=u.useState([]),[N,j]=u.useState([]),[E,A]=u.useState([]),[M,_]=u.useState({}),[T,k]=u.useState(!0),[C,L]=u.useState(""),[z,G]=u.useState(""),[U,X]=u.useState("dossier"),[V,R]=u.useState(!1),[B,D]=u.useState(!1),[O,$]=u.useState({items:[],loading:!1,error:""}),[F,H]=u.useState(!1),I=u.useRef(null),[Y,P]=u.useState({isDirty:!1,isSubmitting:!1}),W=u.useMemo(()=>h?.permissions&&typeof h.permissions.canEdit=="boolean"?h.permissions.canEdit:!h||!s?!1:!!(s.role==="system_admin"||h.world?.created_by&&h.world.created_by===s.id||h.created_by&&h.created_by===s.id),[h,s]),{accessSettings:le,accessOptions:K,accessOptionsError:de,accessOptionsLoading:Q,accessSaving:he,accessSaveError:re,accessSaveSuccess:Ce,isAccessDirty:Re,handleAccessSettingChange:ue,resetAccessSettings:se,handleAccessSave:Le}=TB(h,i,W),be=u.useMemo(()=>h?.world?.id||h?.world_id||o||"",[h,o]),De=u.useCallback(async()=>{if(e){k(!0),L("");try{const xe=await ni(e);y(xe?.data||xe)}catch(xe){console.error(" Failed to load location:",xe);const $e=xe.status===403||xe.status==="403"||xe.message==="Forbidden";L($e&&!!d?"CAMPAIGN_CONTEXT_ACCESS_DENIED":xe.message||"Failed to load location"),y(null)}finally{k(!1)}}},[e,d]),Me=u.useCallback(async()=>{if(e)try{const xe=await Sg(e);b(xe?.data||[])}catch(xe){console.error(" Failed to load entities:",xe)}},[e]),mt=u.useCallback(async()=>{if(e)try{const xe=await vg(e);S(xe?.data||[])}catch(xe){console.error(" Failed to load path:",xe)}},[e]),ht=u.useCallback(async()=>{if(o)try{const xe=await Nr({worldId:o});j(xe?.data||[])}catch(xe){console.error(" Failed to load location types:",xe)}},[o]),Ct=u.useCallback(async()=>{if(!h?.location_type_id){A([]);return}try{const xe=await $f(h.location_type_id),$e=Array.isArray(xe?.data)?xe.data:Array.isArray(xe)?xe:[];A($e)}catch(xe){console.error(" Failed to load location type fields:",xe),A([])}},[h?.location_type_id]);u.useEffect(()=>{l&&i&&(De(),Me(),mt(),ht())},[l,i,De,Me,mt,ht]),u.useEffect(()=>{h?.location_type_id&&Ct()},[h?.location_type_id,Ct]),u.useEffect(()=>{if(!h?.metadata||!E||E.length===0){_({});return}let xe=!1;const $e=E.filter(J=>(J.data_type==="entity_reference"||J.data_type==="location_reference")&&h.metadata?.[J.name]);if($e.length===0){_({});return}return(async()=>{const J={...M};for(const Z of $e){const je=Z.name,Ne=h.metadata[je];let pe=null;if(typeof Ne=="string"&&Ne.trim())pe=Ne.trim();else if(typeof Ne=="object"&&Ne!==null&&(pe=Ne.id||Ne.value||Ne.entity_id||null,Ne.displayValue||Ne.name||Ne.label)){J[je]=Ne.displayValue||Ne.name||Ne.label;continue}if(!(!pe||J[je]))try{if(Z.data_type==="entity_reference"){const Ue=await Hs(pe),ae=Ue?.data||Ue;ae?.name&&(J[je]=ae.name)}else if(Z.data_type==="location_reference"){const Ue=await ni(pe),ae=Ue?.data||Ue;ae?.name&&(J[je]=ae.name)}}catch(Ue){console.warn(`Failed to resolve reference for field ${je}:`,Ue)}}xe||_(J)})(),()=>{xe=!0}},[h?.metadata,E]);const At=async()=>{if(confirm("Are you sure you want to delete this location?"))try{await Ng(e),n("/locations")}catch(xe){console.error(" Failed to delete location:",xe),alert(xe.message)}},we=u.useCallback(()=>{V&&Re&&se(),R(!V),G("")},[V,Re,se]),st=u.useCallback(async xe=>{if(!h?.id||!W)return!1;G(""),P($e=>({...$e,isSubmitting:!0}));try{const $e={name:xe.name||h.name,description:xe.description||h.description,location_type_id:h.location_type_id,parent_id:xe.parent_id!==void 0?xe.parent_id||null:h.parent_id,metadata:xe.metadata||h.metadata||{}},He=await Vl(h.id,$e),J=He?.data||He;return J?(y(Z=>Z?{...Z,...J}:J),!0):!1}catch($e){return console.error(" Failed to update location:",$e),G($e.message||"Failed to update location"),!1}finally{P($e=>({...$e,isSubmitting:!1}))}},[h,W]),lt=u.useCallback(xe=>{P(xe)},[]),Fe=u.useCallback(async()=>{if(!W||!h?.id)return!1;let xe=!0;if(Y.isDirty&&I.current&&(await I.current.submit()||(xe=!1)),xe&&Re)if(!await Le())xe=!1;else try{const He=await ni(h.id);y(He?.data||He)}catch{}return xe&&R(!1),xe},[W,h?.id,Y.isDirty,Re,Le]),Xe=u.useCallback(xe=>{X(xe)},[]),dt=u.useMemo(()=>{if(!f||!h)return!1;const xe=f.world?.id||f.world_id,$e=h.world?.id||h.world_id;return!xe||!$e?!1:String(xe)===String($e)},[f,h]),ee=u.useMemo(()=>!f||!s?.id?null:(Array.isArray(f.members)?f.members:[]).find(He=>{if(!He)return!1;const J=He.user_id??He.userId??He.user?.id??He.id??null;return J?String(J)===String(s.id):!1})||null,[f,s?.id])?.role??null,ce=u.useMemo(()=>s?.role==="system_admin"?!0:ee==="dm",[ee,s?.role]),fe=u.useMemo(()=>ee==="player",[ee]),qe=u.useMemo(()=>!!(ce||fe),[ce,fe]),Pe=u.useCallback(async()=>{const xe=await s1(e,{campaignId:d});return Array.isArray(xe?.data)?xe.data:Array.isArray(xe)?xe:[]},[e,d]);u.useEffect(()=>{let xe=!1;return!e||!d||!dt?($({items:[],loading:!1,error:""}),()=>{xe=!0}):($(He=>({...He,loading:!0,error:""})),(async()=>{try{const He=await Pe();xe||$({items:He,loading:!1,error:""})}catch(He){if(!xe){const je=(He.status===403||He.status==="403"||He.message==="Forbidden")&&!!d?"CAMPAIGN_CONTEXT_ACCESS_DENIED":He.message||"Failed to load notes";$(Ne=>({...Ne,loading:!1,error:je}))}}})(),()=>{xe=!0})},[e,d,dt,Pe]);const Be=u.useCallback(async xe=>{if(!e)return{success:!1,message:"Location not found"};if(!d)return{success:!1,message:"Select a campaign first"};H(!0);try{const $e={...xe,campaignId:xe?.campaignId??d},He=await l1(e,$e),J=He?.data||He;if(!J)throw new Error("Note could not be created");const Z=J?.createdAt??J?.created_at??new Date().toISOString(),je=J?.createdAt&&J?.created_at?J:{...J,...J?.createdAt?{}:{createdAt:Z},...J?.created_at?{}:{created_at:Z}};return $(Ne=>{const pe=Array.isArray(Ne.items)?Ne.items:[];return{...Ne,items:[je,...pe]}}),{success:!0,note:je}}catch($e){return console.error("Failed to create location note",$e),{success:!1,message:$e.message||"Failed to create note"}}finally{H(!1)}},[e,d]),Te=u.useCallback(async xe=>{xe?.id&&$($e=>{const He=Array.isArray($e.items)?$e.items:[],J=He.findIndex(je=>je?.id&&String(je.id)===String(xe.id));if(J<0)return $e;const Z=[...He];return Z[J]=xe,{...$e,items:Z}})},[]),gt=u.useCallback(async xe=>{xe&&$($e=>{const J=(Array.isArray($e.items)?$e.items:[]).filter(Z=>!Z?.id||String(Z.id)!==String(xe));return{...$e,items:J}})},[]),jt=u.useMemo(()=>{const xe=[{id:"dossier",label:"Dossier"}];return xe.push({id:"notes",label:"Notes"}),xe.push({id:"entities",label:"Entities"}),xe.push({id:"locations",label:"Locations"}),W&&V&&xe.push({id:"access",label:"Access"}),xe.push({id:"system",label:"System"}),xe},[W,V]);u.useEffect(()=>{new Set(jt.map($e=>$e.id)).has(U)||X("dossier")},[jt,U]);const Mt=h?.createdAt||h?.created_at,tt=h?.updatedAt||h?.updated_at,ft=u.useMemo(()=>!Array.isArray(E)||E.length===0?[]:E.map($e=>{const He=h?.metadata?.[$e.name],J=M[$e.name];let Z=He,je=J,Ne=J;return($e.data_type==="entity_reference"||$e.data_type==="location_reference")&&He&&(typeof He=="object"&&He!==null?(Z=J?{...He,displayValue:J}:He,je=He.displayValue||He.name||He.label||J||null,Ne=je||J):typeof He=="string"&&J&&(Z={id:He,displayValue:J},je=J,Ne=J)),{...$e,value:Z,displayValue:je,selectedLabel:Ne,dataType:$e.data_type||$e.dataType,visibleByDefault:$e.visible_by_default!==void 0?$e.visible_by_default:$e.visibleByDefault!==void 0?$e.visibleByDefault:!0}}).map($e=>UB($e)).filter(Boolean),[E,h?.metadata,M]),Rt=u.useMemo(()=>{if(!E||E.length===0)return{__placeholder:"No custom fields defined for this location type."};const xe=E.map($e=>({...$e,value:h?.metadata?.[$e.name]}));return kg(xe)},[E,h?.metadata]),Ft=u.useMemo(()=>{if(!E||E.length===0)return{};const xe=E.map(He=>{const J=h?.metadata?.[He.name],Z=M[He.name];return(He.data_type==="entity_reference"||He.data_type==="location_reference")&&J?Z?{...He,value:typeof J=="object"&&J!==null?{...J,displayValue:Z}:{id:J,displayValue:Z}}:typeof J=="object"&&J!==null?{...He,value:J}:{...He,value:{id:J}}:{...He,value:J}}),$e=d1(xe);return Object.keys(M).forEach(He=>{M[He]&&($e[He]=M[He])}),$e},[E,h?.metadata,M]),Zt=u.useMemo(()=>{if(!E||E.length===0)return{};const xe=E.map($e=>({...$e,value:h?.metadata?.[$e.name]}));return u1(xe)},[E,h?.metadata]),Tt="Information",We=u.useMemo(()=>{if(!h)return null;const xe=h.parent?.id||h.parent_id||null,$e=h.parent?.name||null;return{name:h.name||"",description:h.description||"",typeName:h.locationType?.name||"",parent_id:xe,parentName:$e||"",worldName:h.world?.name||"",worldId:be,createdAt:os(Mt),updatedAt:os(tt),metadata:Rt,metadataDisplay:Ft,createdBy:h.creator?.username||h.creator?.email||h.created_by||"",updatedBy:h.updated_by||""}},[h,be,Mt,tt,Rt,Ft]),it=u.useMemo(()=>{if(!h)return null;const xe=h.parent?.id||h.parent_id||null;return{name:h.name||"",description:h.description||"",typeName:h.locationType?.name||"",parent_id:xe||null,worldName:h.world?.name||"",worldId:be,createdAt:os(Mt),updatedAt:os(tt),metadata:Zt}},[h,be,Mt,tt,Zt]),bt=u.useMemo(()=>{const xe=ft.length>0?ft:[{key:"metadata.__placeholder",name:"metadata.__placeholder",label:"Information",type:"readonly"}];let $e=[];if(h?.location_type_id&&N&&N.length>0){const He=String(h.location_type_id);$e=R_(He,N)}return{title:"Edit Location",sections:[{title:"Edit Location",columns:2,fields:[{key:"name",label:"Name",type:"text"},{key:"typeName",label:"Type",type:"readonly"},{key:"parent_id",label:"Parent Location",type:"location_reference",dataType:"location_reference",allowedTypeIds:$e},{key:"description",label:"Description",type:"textarea",rows:4,span:2}]},{title:Tt,columns:ft.length>0?2:1,fields:xe}]}},[ft,Tt,h?.location_type_id,N]),oe=u.useMemo(()=>{const xe=ft.length>0?ft:[{key:"metadata.__placeholder",name:"metadata.__placeholder",label:"Information",type:"readonly"}];return{title:"Location Overview",sections:[{title:"Summary",columns:2,fields:[{key:"name",label:"Name",type:"readonly"},{key:"typeName",label:"Type",type:"readonly"},{key:"parent_id",label:"Parent Location",type:"location_reference",dataType:"location_reference"}]},{title:"Description",columns:1,fields:[{key:"description",label:"Description",type:"textarea",rows:4}]},{title:Tt,columns:ft.length>0?2:1,fields:xe}]}},[ft,Tt]),Ee=u.useMemo(()=>({sections:[{title:"System",columns:2,fields:[{key:"worldName",label:"World",type:"readonly"},{key:"createdAt",label:"Created",type:"readonly"},{key:"updatedAt",label:"Updated",type:"readonly"},{key:"createdBy",label:"Created By",type:"readonly"}]}]}),[]),Se=u.useCallback((xe,$e,He)=>xe?(Array.isArray(xe.sections)?xe.sections:[]).map((Z,je)=>{const Ne=`${He||"section"}-${Z.title||je}`,pe=Number.isFinite(Z.columns)?Math.max(1,Number(Z.columns)):1,Ue=Array.isArray(Z.fields)?Z.fields:[];return t.jsxs("section",{className:"entity-card bg-white rounded-lg border p-4 sm:p-6 w-full",children:[Z.title?t.jsx("h2",{className:"entity-card-title",children:Z.title}):null,t.jsx("div",{className:`entity-field-grid ${pe>1?"grid grid-cols-1 sm:grid-cols-2 gap-4":""}`,style:{"--entity-field-columns":pe},children:Ue.length>0?Ue.map((ae,Ke)=>{const ot=ae?.key||ae?.name||ae?.field||`${Ne}-field-${Ke}`;return t.jsx(Wc,{field:{...ae},data:$e,mode:V?"edit":"view"},ot)}):t.jsx("p",{className:"entity-empty-state",children:"No fields available."})})]},Ne)}):null,[V]);if(T)return t.jsx("div",{className:"page-container",children:t.jsx("p",{children:"Loading location..."})});if(C==="CAMPAIGN_CONTEXT_ACCESS_DENIED")return t.jsxs("div",{className:"alert error",style:{padding:"1.5rem",maxWidth:"600px",margin:"2rem auto"},children:[t.jsx("h2",{style:{marginTop:0,marginBottom:"1rem"},children:"Access Restricted by Campaign Context"}),t.jsx("p",{style:{marginBottom:"1rem"},children:"You don't have access to this location with your current campaign context selected. This location may belong to a different campaign or world, or your current campaign context doesn't have permission to view it."}),t.jsx("p",{style:{marginBottom:"1.5rem"},children:"To view this location, please change your campaign context using the selector in the header to a campaign that has access to this location."}),t.jsx("div",{style:{display:"flex",gap:"1rem",flexWrap:"wrap"},children:t.jsx("button",{type:"button",onClick:()=>n("/locations"),style:{padding:"0.5rem 1rem",backgroundColor:"#6c757d",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Go to Locations"})})]});if(C||!h)return t.jsxs("div",{className:"page-container",children:[t.jsx("div",{className:"alert error",children:C||"Location not found"}),t.jsx(Yt,{to:"/locations",className:"btn btn-secondary",children:" Back to Locations"})]});const Ve=`entity-detail-page${p?" entity-detail-page--mobile":""}${p&&B?" entity-detail-page--header-expanded":""}`;return t.jsx(qg,{maxWidth:1280,className:Ve,children:t.jsxs("div",{className:"w-full max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 overflow-x-hidden",children:[t.jsx("header",{className:`entity-page-header ${p&&!B?"entity-page-header--collapsed":""}`,children:t.jsxs("div",{className:"entity-page-header__inner",children:[p&&t.jsx("button",{type:"button",className:"entity-page-header__drag-handle",onClick:()=>D(!B),"aria-label":B?"Collapse header":"Expand header","aria-expanded":B,children:t.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:B?"rotated":"",children:t.jsx("polyline",{points:"6 9 12 15 18 9"})})}),t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.5rem"},children:[t.jsx(Yt,{to:"/locations",className:"btn btn-secondary",children:""}),W&&t.jsx("button",{className:"btn btn-danger",onClick:At,title:"Delete location",children:t.jsx(zn,{size:16})})]}),t.jsx(EB,{locationId:e,name:h.name,canEdit:W,isEditing:V,onToggleEdit:we,onSave:Fe,isSaving:Y.isSubmitting||he,isSaveDisabled:!Y.isDirty&&!Re,isMobile:p}),t.jsxs("div",{className:`entity-page-header__tabs flex flex-wrap items-center justify-between gap-4 mt-4 ${p&&!B?"entity-page-header__tabs--collapsed":""}`,children:[t.jsx(j1,{tabs:jt,activeTab:U,onChange:Xe}),e&&t.jsx(CB,{locationId:e,importance:h.importance,onUpdate:xe=>{y($e=>$e?{...$e,importance:xe}:null)}})]})]})}),v.length>0&&t.jsxs("div",{style:{marginBottom:"1rem",display:"flex",alignItems:"center",gap:"0.5rem",flexWrap:"wrap"},children:[t.jsx(Yt,{to:"/locations",className:"btn btn-sm btn-secondary",children:"Root"}),v.map((xe,$e)=>t.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[t.jsx(xr,{size:16}),$e===v.length-1?t.jsx("span",{style:{fontWeight:"bold"},children:xe.name}):t.jsx(Yt,{to:`/locations/${xe.id}`,className:"btn btn-sm btn-link",children:xe.name})]},xe.id))]}),t.jsx("div",{className:"entity-detail-shell",children:t.jsxs("div",{className:"entity-detail-body",children:[t.jsx("div",{className:"entity-tab-panel",role:"tabpanel",hidden:U!=="dossier",children:t.jsxs("div",{className:"entity-tab-content",children:[z&&t.jsx("section",{className:"entity-card bg-white rounded-lg border p-4 sm:p-6 w-full",children:t.jsx("div",{className:"alert error",role:"alert",children:z})}),V&&W?t.jsx("section",{className:"entity-card entity-card--form entity-edit-form-wrapper bg-white rounded-lg border p-4 sm:p-6 w-full",children:t.jsx("div",{className:"entity-edit-form-container",children:t.jsx("div",{className:"entity-edit-form-content",children:t.jsx(us,{ref:I,schema:bt,initialData:it||{},onSubmit:st,onStateChange:lt,hideActions:!0,enableUnsavedPrompt:!1})})})}):Se(oe,We,"dossier")]})}),U==="notes"&&t.jsx($_,{location:h,worldId:be,selectedCampaign:f,selectedCampaignId:d,isCampaignDm:ce,isCampaignPlayer:fe,canCreateNote:qe,notes:O.items,loading:O.loading,error:O.error,onCreateNote:Be,onNoteUpdate:Te,onNoteDelete:gt,creating:F,campaignMatchesLocationWorld:dt}),U==="entities"&&t.jsx(RB,{entities:g,loading:T,error:C,locationId:e,worldId:be,onEntitiesChange:Me}),U==="locations"&&t.jsx(OB,{location:h,worldId:be,path:v,onLocationsChange:()=>{mt(),De()}}),U==="access"&&V&&W&&t.jsx(MB,{canEdit:W,worldId:be,accessSettings:le,accessOptions:K,accessOptionsError:de,accessOptionsLoading:Q,accessSaving:he,accessSaveError:re,accessSaveSuccess:Ce,handleAccessSettingChange:ue}),U==="system"&&t.jsx(kB,{renderSchemaSections:Se,systemSchema:Ee,viewData:We})]})})]})})}function PB({data:e}){const n=e?.label||"Location",s=e?.typeName||"Location",i=e?.locationId||e?.id,l=e?.childCount||0,o=!e?.parentId,d=e?.dragHoverState,f=e?.isFocused||!1,p=e?.isCollapsed||!1,h=l>0,y=j=>{j?.preventDefault(),j?.stopPropagation(),!(!e?.onAddChild||!i)&&e.onAddChild(String(i))},g=j=>{j?.preventDefault(),j?.stopPropagation(),!(!e?.onOpenInfo||!i)&&e.onOpenInfo(String(i))},b=j=>{j?.preventDefault(),j?.stopPropagation(),!(!e?.onSetParent||!i)&&e.onSetParent(String(i))},v=j=>{j?.preventDefault(),j?.stopPropagation(),!(!e?.onToggleCollapse||!i||!h)&&e.onToggleCollapse(String(i))},S=d==="valid"?"location-node--drag-valid":d==="invalid"?"location-node--drag-invalid":"",N=f?"location-node--focused":"";return t.jsxs("div",{className:`location-node ${o?"location-node--orphan":"location-node--standard"} ${S} ${N}`,style:e?.style||{},children:[!o&&t.jsxs(t.Fragment,{children:[t.jsx(Es,{id:"top",type:"target",position:Gt.Top,style:{width:14,height:14,background:"linear-gradient(135deg, #cbd5f5 0%, #a5b4fc 100%)",border:"2px solid #ffffff",borderRadius:"999px",boxShadow:"0 2px 4px rgba(15, 23, 42, 0.2), 0 0 0 1px rgba(99, 102, 241, 0.1)"}}),t.jsx(Es,{id:"left",type:"target",position:Gt.Left,style:{width:14,height:14,background:"linear-gradient(135deg, #cbd5f5 0%, #a5b4fc 100%)",border:"2px solid #ffffff",borderRadius:"999px",boxShadow:"0 2px 4px rgba(15, 23, 42, 0.2), 0 0 0 1px rgba(99, 102, 241, 0.1)"}})]}),t.jsxs("div",{className:"location-node__content",children:[t.jsxs("div",{className:"location-node__row location-node__row--title",style:{justifyContent:h&&e?.onToggleCollapse?"space-between":"center"},children:[t.jsx("div",{className:"location-node__label",title:n,children:n}),h&&e?.onToggleCollapse&&t.jsx("button",{type:"button",className:"location-node__collapse-btn",onClick:v,onPointerDown:j=>j.stopPropagation(),"aria-label":p?"Expand node":"Collapse node",title:p?"Expand node":"Collapse node",style:{background:"none",border:"none",cursor:"pointer",padding:"2px",display:"flex",alignItems:"center",justifyContent:"center",color:"#64748b",marginLeft:"auto",transition:"color 0.15s ease"},onMouseEnter:j=>{j.currentTarget.style.color="#475569"},onMouseLeave:j=>{j.currentTarget.style.color="#64748b"},children:p?t.jsx(xr,{size:16,strokeWidth:2.5}):t.jsx(Ss,{size:16,strokeWidth:2.5})})]}),t.jsx("div",{className:"location-node__row location-node__row--type",children:t.jsx("div",{className:"location-node__type-pill",children:s})}),l>0&&t.jsx("div",{className:"location-node__row location-node__row--count",children:t.jsxs("div",{className:"location-node__child-count",children:[l," ",l===1?"child":"children"]})}),t.jsx("div",{className:"location-node__row location-node__row--actions",children:t.jsxs("div",{className:"location-node__actions","aria-hidden":!e?.onAddChild&&!e?.onOpenInfo&&!e?.onSetParent,children:[o&&e?.onSetParent&&t.jsx("button",{type:"button",className:"location-node__action",onClick:b,onPointerDown:j=>j.stopPropagation(),"aria-label":"Set parent location",title:"Set parent location",children:t.jsx(nk,{size:13,strokeWidth:2.5,absoluteStrokeWidth:!0,"aria-hidden":"true"})}),e?.onAddChild&&t.jsx("button",{type:"button",className:"location-node__action",onClick:y,onPointerDown:j=>j.stopPropagation(),"aria-label":"Add child location",title:"Add child location",children:t.jsx(Wn,{size:13,strokeWidth:2.5,absoluteStrokeWidth:!0,"aria-hidden":"true"})}),e?.onOpenInfo&&t.jsx("button",{type:"button",className:"location-node__action",onClick:g,onPointerDown:j=>j.stopPropagation(),"aria-label":"Open location details",title:"Open location details",children:t.jsx(Jl,{size:13,strokeWidth:2.5,absoluteStrokeWidth:!0,"aria-hidden":"true"})})]})})]}),l>0&&t.jsx(Es,{id:"bottom",type:"source",position:Gt.Bottom,style:{width:14,height:14,background:"linear-gradient(135deg, #cbd5f5 0%, #a5b4fc 100%)",border:"2px solid #ffffff",borderRadius:"999px",boxShadow:"0 2px 4px rgba(15, 23, 42, 0.2), 0 0 0 1px rgba(99, 102, 241, 0.1)"}})]})}function HB({parentId:e=null,onClose:n,onSuccess:s,locationTypes:i=[]}){const{activeWorldId:l}=wn(),[o,d]=u.useState({name:"",location_type_id:"",description:""}),[f,p]=u.useState(!1),[h,y]=u.useState(null),[g,b]=u.useState(i);u.useEffect(()=>{i.length>0?b(i):l&&Nr({worldId:l}).then(S=>{b(S?.data||[])}).catch(S=>{console.error("Failed to load location types:",S)})},[l,i]);const v=async S=>{S.preventDefault(),p(!0),y(null);try{const N={world_id:l,name:o.name.trim(),location_type_id:o.location_type_id||null,parent_id:e||null,description:o.description?.trim()||null};if(!N.name)throw new Error("Name is required");if(!N.location_type_id)throw new Error("Location type is required");const j=await wg(N),E=j?.data||j;s&&s(E),d({name:"",location_type_id:"",description:""})}catch(N){console.error("Failed to create location:",N),y(N.message||"Failed to create location")}finally{p(!1)}};return t.jsxs("div",{className:"quick-location-form",children:[t.jsxs("div",{className:"quick-location-form__header",children:[t.jsx("h3",{children:e?"Add Child Location":"Add Location"}),t.jsx("button",{type:"button",className:"icon-btn",onClick:n,"aria-label":"Close form",children:t.jsx(Bn,{size:18})})]}),t.jsxs("form",{onSubmit:v,className:"quick-location-form__body",children:[h&&t.jsx("div",{className:"alert alert-error",style:{marginBottom:"1rem"},children:h}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"quick-name",children:"Name *"}),t.jsx("input",{type:"text",id:"quick-name",value:o.name,onChange:S=>d({...o,name:S.target.value}),required:!0,autoFocus:!0,placeholder:"Enter location name"})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"quick-type",children:"Type *"}),t.jsxs("select",{id:"quick-type",value:o.location_type_id,onChange:S=>d({...o,location_type_id:S.target.value}),required:!0,children:[t.jsx("option",{value:"",children:"Select a type..."}),g.map(S=>t.jsx("option",{value:S.id,children:S.name},S.id))]})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"quick-description",children:"Description"}),t.jsx("textarea",{id:"quick-description",value:o.description,onChange:S=>d({...o,description:S.target.value}),rows:3,placeholder:"Optional description"})]}),t.jsxs("div",{className:"quick-location-form__actions",children:[t.jsx("button",{type:"button",className:"btn btn-secondary",onClick:n,disabled:f,children:"Cancel"}),t.jsx("button",{type:"submit",className:"btn btn-primary",disabled:f,children:f?"Creating...":"Create"})]})]})]})}const js=200,Bs=140,fb=50,F_=120,VB=js+40,YB=40,GB=40;function WB(e,n){return[...e].sort((s,i)=>{const l=n.get(s),o=n.get(i);if(!l&&!o)return 0;if(!l)return 1;if(!o)return-1;const d=l.data?.metadata?.orderIndex??l.metadata?.orderIndex,f=o.data?.metadata?.orderIndex??o.metadata?.orderIndex;if(d!==void 0&&f!==void 0&&d!==f)return d-f;if(d!==void 0&&f===void 0)return-1;if(d===void 0&&f!==void 0)return 1;const p=(l.data?.label||l.name||"").toLowerCase(),h=(o.data?.label||o.name||"").toLowerCase();return p.localeCompare(h)})}function XB(e,n=null){const s=new Map,i=new Map;e.forEach(p=>{if(!p||!p.id)return;const h=String(p.id);s.set(h,p);const y=p.parentId?String(p.parentId):null;y&&(i.has(y)||i.set(y,[]),i.get(y).push(h))});const l=new Map,o=[];s.forEach((p,h)=>{const y=i.get(h)||[],g=WB(y,s);p.children=g;const b=p.parentId?String(p.parentId):null;(!b||!s.has(b))&&(o.push(h),l.set(h,0))});const d=o.map(p=>({id:p,level:0})),f=new Set(o);for(;d.length>0;){const{id:p,level:h}=d.shift();(s.get(p)?.children||[]).forEach(b=>{f.has(b)||(f.add(b),l.set(b,h+1),d.push({id:b,level:h+1}))})}return s.forEach((p,h)=>{l.has(h)||l.set(h,0),p.depth=l.get(h),p.isCollapsed=n?n.get(h)===!0:!1}),{nodeMap:s,rootNodes:o}}function KB(e){const n=new Map;let s=0;e.forEach((i,l)=>{const o=i.depth||0;o>s&&(s=o),n.has(o)||n.set(o,[]),n.get(o).push(l)});for(let i=s;i>=0;i--)(n.get(i)||[]).forEach(o=>{const d=e.get(o);if(!d)return;if(d.isCollapsed){d.subtreeWidth=js;return}const f=d.children||[],p=f.length;if(p===0)d.subtreeWidth=js;else if(p<=5){let h=0;f.forEach(y=>{const g=e.get(y);g&&(h+=g.subtreeWidth||js)}),d.subtreeWidth=h+fb*(p-1)}else d.subtreeWidth=js})}function ng(e,n,s=!1){if(!e||e.isCollapsed)return Bs;const i=e.children||[],l=i.length,o=s||l>=6;if(l===0)return Bs;if(!o&&l<=5){let d=0;return i.forEach(f=>{const p=n.get(f);if(p){const h=ng(p,n,!1);h>d&&(d=h)}}),Bs+d}else{let d=Bs;return i.forEach(f=>{const p=n.get(f);p&&(d+=ng(p,n,!0))}),d}}function bf(e,n,s=!1){if(!e||!e.children||e.children.length===0||e.isCollapsed)return;const i=e.children||[],l=i.length;if(!(s||l>=6)&&l<=5){const d=e.subtreeWidth||js;let f=e.x-d/2;i.forEach(p=>{const h=n.get(p);if(!h)return;const y=h.subtreeWidth||js,g=f+y/2;h.x=g,h.y=h.depth*(Bs+F_),f+=y+fb,bf(h,n,!1)})}else{let d=e.y+Bs+YB;i.forEach((f,p)=>{const h=n.get(f);if(!h)return;h.x=e.x+VB,h.y=d;const y=ng(h,n,!0);d+=y,p<i.length-1&&(d+=GB),bf(h,n,!0)})}}function ZB(e,n){if(n.length===0)return;if(n.length===1){const i=n[0],l=e.get(i);if(!l)return;l.x=(l.subtreeWidth||js)/2,l.y=0,bf(l,e)}else{let i=0;n.forEach(l=>{const o=e.get(l);if(!o)return;const d=o.subtreeWidth||js;o.x=i+d/2,o.y=0,bf(o,e),i+=d+fb})}let s=1/0;if(e.forEach(i=>{i.x!==void 0&&i.x<s&&(s=i.x)}),s<0){const i=-s;e.forEach(l=>{l.x!==void 0&&(l.x+=i)})}}function z_(e,n,s=[]){e&&(s.push(e),!e.isCollapsed&&e.children&&e.children.forEach(i=>{const l=n.get(i);l&&z_(l,n,s)}))}function QB(e){if(!e)return null;const n=String(e.id),s=e.name||`Location ${n}`,i=e.locationType?.name||e.location_type_name||"Location",l=e.parent_id?String(e.parent_id):null;return{id:n,name:s,typeName:i,parentId:l,locationTypeId:e.location_type_id,childCount:e.childCount||0,description:e.description||"",metadata:e.metadata||{}}}function JB(e,n=null,s=null){if(!Array.isArray(e)||e.length===0)return[];const i=e.map(QB).filter(Boolean);if(i.length===0)return[];const l=i.map(h=>{const y=h.parentId||null;return{id:h.id,type:"location",width:js,height:Bs,position:{x:0,y:0},data:{label:h.name,typeName:h.typeName,locationId:h.id,parentId:y,childCount:h.childCount,description:h.description,locationTypeId:h.locationTypeId,metadata:h.metadata||{}},parentId:y,metadata:h.metadata||{}}}),{nodeMap:o,rootNodes:d}=XB(l,s);KB(o),ZB(o,d);const f=[];d.forEach(h=>{const y=o.get(h);y&&z_(y,o,f)});const p=new Set(f.map(h=>String(h.id)));return{nodes:l.map(h=>{if(!h||!h.id)return null;const y=String(h.id),g=o.get(y);if(!g)return null;const b=typeof g.x=="number"&&Number.isFinite(g.x)?g.x:0,v=typeof g.y=="number"&&Number.isFinite(g.y)?g.y:(g.depth||0)*(Bs+F_),S=g.depth||0;return{...h,id:y,type:h.type||"location",width:js,height:Bs,position:{x:b,y:v},data:{...h.data,level:S,visualLevel:S,levelIndex:0}}}).filter(Boolean),visibleNodeIds:p}}function e9(e,n=null){if(!Array.isArray(e))return[];const s=new Map;e.forEach(l=>{if(!l||!l.parent_id)return;const o=String(l.parent_id);s.set(o,(s.get(o)||0)+1)});const i=[];return e.forEach(l=>{if(!l||!l.parent_id)return;const o=String(l.parent_id),d=String(l.id);if(!(n&&(!n.has(o)||!n.has(d)))&&o&&d&&o!==d){const p=(s.get(o)||0)>=6;i.push({id:`edge-${o}-${d}`,source:o,target:d,type:"smoothstep",animated:!1,style:{stroke:"#64748b",strokeWidth:2,opacity:.8},markerEnd:{type:"arrowclosed",color:"#64748b"},data:{parentId:o,childId:d},sourceHandle:"bottom",targetHandle:p?"left":"top"})}}),i}const t9={location:PB},n9=new Set(["system_admin"]);function B_(e,n,s){if(!e||!n||!s||String(e)===String(n))return!1;const i=s.find(d=>String(d.id)===String(e));if(!i)return!1;const l=new Set;let o=i;for(;o&&!l.has(String(o.id));){l.add(String(o.id));const d=o.parent_type_id||o.parentTypeId;if(!d)break;if(String(d)===String(n))return!0;if(o=s.find(f=>String(f.id)===String(d)),!o)break}return!1}function a9(e,n){return!e||!n||n.length===0?n:n.filter(s=>B_(s.id,e,n))}function FN(e,n,s){return!e||!n||!s?!1:B_(e,n,s)}function s9(e,n){const s=[],i=new Set;let l=n.find(o=>o&&String(o.id)===String(e));for(;l&&l.parent_id&&!i.has(String(l.id));){i.add(String(l.id));const o=String(l.parent_id),d=n.find(f=>f&&String(f.id)===o);if(d)s.push(d),l=d;else break}return s}function r9(e,n){const s=[],i=new Set;function l(o){if(i.has(String(o)))return;i.add(String(o));const d=n.filter(f=>f&&f.parent_id&&String(f.parent_id)===String(o));for(const f of d)s.push(f),l(f.id)}return l(e),s}function i9(){const{activeWorldId:e,selectedCampaignId:n,contextKey:s,activeWorld:i,selectedCampaign:l,selectedContextType:o}=wn(),{user:d}=un(),f=_n(),[p,h]=u.useState([]),[y,g]=u.useState([]),[b,v]=u.useState(!1),[S,N]=u.useState(null),[j,E]=u.useState([]),[A,M]=u.useState([]),[_,T]=u.useState(""),[k,C]=u.useState(!1),[L,z]=u.useState(null),[G,U]=u.useState(null),[X,V]=u.useState(null),[R,B]=u.useState(!1),[D,O]=u.useState(null),[$,F]=u.useState(null),[H,I]=u.useState(null),[Y,P]=u.useState(!1),[W,le]=u.useState(""),[K,de]=u.useState([]),[Q,he]=u.useState(null),re=u.useRef(new Map),Ce=u.useRef(null),Re=u.useRef(!1),ue=u.useRef(!1),se=u.useRef(null),[Le,be]=u.useState(null),[De,Me]=u.useState(null),[mt,ht]=u.useState(!1),[Ct,At]=u.useState(new Map),we=u.useMemo(()=>!l||!d?"":l.members?.find(it=>it.user_id===d.id)?.role||"",[l,d]),st=u.useMemo(()=>{if(!i||!d?.id)return!1;const We=i.created_by||i.creator?.id||i.owner_id||i.owner?.id||"";return We?String(We)===String(d.id):!1},[i,d?.id]),lt=u.useMemo(()=>d?n9.has(d.role)?!0:e?o==="world"?st:!!(l&&(we==="dm"||st)):!1:!1,[d,e,o,l,we,st]),Fe=i?.entity_creation_scope??"",Xe=u.useMemo(()=>!n||!l||!d||Fe!==zi.ALL_PLAYERS?!1:we==="player",[n,l,d,Fe,we]),dt=lt||Xe,ie=u.useCallback(async()=>{if(e){v(!0),N(null);try{const We=await ri({worldId:e,all:"true"});h(We?.data||[])}catch(We){console.error("Failed to load locations:",We),N(We.message)}finally{v(!1)}}},[e,s]),ee=u.useCallback(async()=>{if(e)try{const We=await Nr({worldId:e});g(We?.data||[])}catch(We){console.error("Failed to load location types:",We)}},[e]);u.useEffect(()=>{ie()},[ie]),u.useEffect(()=>{ee()},[ee]),u.useEffect(()=>{if(!$){I(null),P(!1),le(""),de([]);return}let We=!1;return(async()=>{P(!0),le("");try{const bt=await ni($).catch(Ee=>(console.error("Failed to load location:",Ee),null));if(We)return;const oe=bt?.data||bt;if(oe){I(oe);const Ee=oe.location_type_id||oe.locationType?.id;if(Ee)try{const Se=await $f(Ee);if(We)return;const Ve=Array.isArray(Se?.data)?Se.data:Array.isArray(Se)?Se:[];de(Ve)}catch(Se){console.error("Failed to load location type fields:",Se),de([])}else de([])}else le("Location not found"),de([])}catch(bt){if(We)return;console.error("Failed to load location data:",bt),le(bt.message||"Failed to load location information"),de([])}finally{We||P(!1)}})(),()=>{We=!0}},[$]);const ce=u.useMemo(()=>{if(!_.trim())return[];const We=_.toLowerCase().trim();return p.filter(it=>it.name?.toLowerCase().includes(We)||it.description?.toLowerCase().includes(We)||it.locationType?.name?.toLowerCase().includes(We)).slice(0,10)},[p,_]),fe=u.useMemo(()=>{let We=p;if(Q&&p.find(bt=>bt&&String(bt.id)===String(Q))){const bt=s9(Q,p),oe=r9(Q,p),Ee=new Set([String(Q),...bt.map(Se=>String(Se.id)),...oe.map(Se=>String(Se.id))]);We=We.filter(Se=>Ee.has(String(Se.id)))}return We},[p,Q]),qe=u.useCallback(We=>{T(""),ht(!1),requestAnimationFrame(()=>{if(Ce.current){const it=Ce.current.getNode(String(We));if(it){const bt=Ce.current.getViewport(),oe=document.querySelector(".react-flow"),Ee=oe?.clientWidth||800,Se=oe?.clientHeight||600,Ve=it.positionAbsolute?.x??it.position?.x??0,xe=it.positionAbsolute?.y??it.position?.y??0,$e=it.width||120,He=it.height||120,J=Ve+$e/2,Z=xe+He/2,je=-J*bt.zoom+Ee/2,Ne=-Z*bt.zoom+Se/2;Ce.current.setViewport({x:je,y:Ne,zoom:bt.zoom},{duration:400})}}})},[]),Pe=u.useCallback((We,it)=>{At(bt=>{const oe=new Map(bt);return it?oe.set(String(We),!0):oe.delete(String(We)),oe})},[]);u.useEffect(()=>{if(Re.current&&Ce.current&&window.__locationBuilderViewport){const We=window.__locationBuilderViewport;requestAnimationFrame(()=>{requestAnimationFrame(()=>{Ce.current&&window.__locationBuilderViewport&&(Ce.current.setViewport(We,{duration:0}),Re.current=!1,window.__locationBuilderViewport=null)})})}else if(se.current&&Ce.current&&j.length>0){const We=se.current;se.current=null,requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(Ce.current){const it=Ce.current.getNode(We);if(it){const bt=Ce.current.getViewport(),oe=document.querySelector(".react-flow"),Ee=oe?.clientWidth||800,Se=oe?.clientHeight||600,Ve=it.positionAbsolute?.x??it.position?.x??0,xe=it.positionAbsolute?.y??it.position?.y??0,$e=it.width||120,He=it.height||120,J=Ve+$e/2,Z=xe+He/2,je=-J*bt.zoom+Ee/2,Ne=-Z*bt.zoom+Se/2;Ce.current.setViewport({x:je,y:Ne,zoom:bt.zoom},{duration:400})}}})})}else!ue.current&&Ce.current&&j.length>0&&requestAnimationFrame(()=>{Ce.current&&!ue.current&&(Ce.current.fitView({padding:.2}),ue.current=!0)})},[j,A]),u.useEffect(()=>{if(!fe.length){E([]),M([]);return}try{const We=Q?fe.find(J=>J&&String(J.id)===String(Q)):X?fe.find(J=>J&&String(J.id)===String(X)):fe.find(J=>J&&!J.parent_id),it=We?String(We.id):null,bt=JB(fe,it,Ct),oe=bt?.nodes||[],Ee=bt?.visibleNodeIds||new Set;if(!Array.isArray(oe)||oe.length===0){E([]),M([]);return}const Se=new Map;j.forEach(J=>{J&&J.id&&Se.set(String(J.id),J)});const Ve=oe.filter(J=>!J||!J.id?!1:Ee.has(String(J.id))),xe=new Map;fe.forEach(J=>{const Z=String(J.id),je=fe.filter(Ne=>Ne&&Ne.parent_id&&String(Ne.parent_id)===Z);xe.set(Z,je.length)});const $e=Ve.map(J=>{const Z=String(J.id),je=De===Z,Ne=Se.get(Z);let pe;if(je&&Ne&&Ne.position)pe=Ne.position;else{const ae=J.position||{x:0,y:0};pe={x:typeof ae.x=="number"&&Number.isFinite(ae.x)?ae.x:0,y:typeof ae.y=="number"&&Number.isFinite(ae.y)?ae.y:0}}const Ue=xe.get(Z)||0;return{id:Z,type:J.type||"location",width:120,height:120,position:pe,draggable:!0,data:{label:J.data?.label||String(J.id),typeName:J.data?.typeName||"Location",locationId:String(J.id),parentId:J.data?.parentId||J.parentId||null,childCount:Ue,description:J.data?.description||"",locationTypeId:J.data?.locationTypeId||null,dragHoverState:De&&Le?.nodeId===String(J.id)?Le.isValid?"valid":"invalid":null,isFocused:Q===String(J.id),onAddChild:dt?ae=>{z(ae);const Ke=fe.find(ot=>ot&&String(ot.id)===String(ae));if(Ke&&Ke.location_type_id){const ot=a9(Ke.location_type_id,y);U(ot.length>0?ot:y)}else U(null);C(!0)}:void 0,onSetParent:dt?ae=>{O(ae),B(!0)}:void 0,onOpenInfo:ae=>{F(ae)},onToggleCollapse:ae=>{const Ke=String(ae),ot=Ct.get(Ke)===!0;Pe(Ke,!ot)},isCollapsed:Ct.get(String(J.id))===!0}}}),He=e9(fe,Ee);$e.length>0?(E($e),M(He||[])):(E([]),M([]))}catch(We){console.error("Error building location graph:",We),N(We.message||"Failed to build location graph"),E([]),M([])}},[fe,X,Q,dt,f,De,Le,Ct,Pe]);const Be=u.useCallback(We=>{E(it=>ob(We,it))},[]),Te=u.useCallback(We=>{M(it=>QE(We,it))},[]),gt=u.useCallback((We,it)=>{if(!it)return;const bt=it.data?.locationId||it.id;bt&&(he(String(bt)),requestAnimationFrame(()=>{Ce.current&&Ce.current.fitView({nodes:[{id:String(bt)}],padding:.6,duration:400})}))},[]),jt=u.useCallback(()=>{he(null)},[]),Mt=u.useCallback((We,it)=>{it&&it.id&&(re.current.set(String(it.id),{x:it.position.x,y:it.position.y}),Me(String(it.id)))},[]),tt=u.useCallback((We,it)=>{if(!it||!dt||!De){be(null);return}const bt=it.data?.locationId||it.id;if(!bt){be(null);return}const oe=p.find(ae=>ae&&String(ae.id)===String(bt));if(!oe){be(null);return}const Ee=it.position.x+(it.width||120)/2,Se=it.position.y+(it.height||120)/2,Ve=250;let xe=null,$e=1/0;for(const ae of j){if(String(ae.id)===String(it.id))continue;const Ke=ae.position.x,ot=ae.position.x+(ae.width||120),St=ae.position.y,me=ae.position.y+(ae.height||120),nt=Ke+(ae.width||120)/2,Ge=St+(ae.height||120)/2,vt=Ee>Ke&&Ee<ot&&Se>St&&Se<me,ct=Math.sqrt(Math.pow(Ee-nt,2)+Math.pow(Se-Ge,2));(vt||ct<Ve)&&ct<$e&&(xe=ae,$e=ct)}if(!xe){be(null);return}const He=xe.data?.locationId||xe.id;if(!He||String(He)===String(bt)){be(null);return}const J=p.find(ae=>ae&&String(ae.id)===String(He));if(!J){be(null);return}if(String(oe.parent_id)===String(He)){be(null);return}const Z=oe.location_type_id,je=J.location_type_id,Ne=FN(Z,je,y),pe=(()=>{const ae=(Ke,ot,St=new Set)=>{if(St.has(String(Ke)))return!1;if(St.add(String(Ke)),String(Ke)===String(ot))return!0;const me=p.filter(nt=>nt&&nt.parent_id&&String(nt.parent_id)===String(Ke));for(const nt of me)if(String(nt.id)===String(ot)||ae(nt.id,ot,St))return!0;return!1};return ae(bt,He)})(),Ue=Ne&&!pe;be({nodeId:String(xe.id),isValid:Ue})},[j,p,y,dt,De]),ft=u.useCallback(async(We,it)=>{if(!it||!dt){re.current.delete(String(it?.id));return}const bt=it.data?.locationId||it.id;if(!bt){re.current.delete(String(it?.id));return}const oe=re.current.get(String(it.id)),Ee=oe?Math.sqrt(Math.pow(it.position.x-oe.x,2)+Math.pow(it.position.y-oe.y,2)):0;if(re.current.delete(String(it.id)),Me(null),be(null),Ee<10)return;const Se=p.find(Ge=>Ge&&String(Ge.id)===String(bt));if(!Se)return;const Ve=j,xe=it.position.x,$e=it.position.x+(it.width||120),He=it.position.y,J=it.position.y+(it.height||120),Z=xe+(it.width||120)/2,je=He+(it.height||120)/2,Ne=250;let pe=null,Ue=1/0;for(const Ge of Ve){if(String(Ge.id)===String(it.id))continue;const vt=Ge.position.x,ct=Ge.position.x+(Ge.width||120),Nt=Ge.position.y,Ye=Ge.position.y+(Ge.height||120),Je=vt+(Ge.width||120)/2,Et=Nt+(Ge.height||120)/2,te=xe<ct&&$e>vt&&He<Ye&&J>Nt,ve=Math.sqrt(Math.pow(Z-Je,2)+Math.pow(je-Et,2));(te||ve<Ne)&&ve<Ue&&(pe=Ge,Ue=ve)}if(!pe)return;const ae=pe.data?.locationId||pe.id;if(!ae||String(ae)===String(bt))return;const Ke=p.find(Ge=>Ge&&String(Ge.id)===String(ae));if(!Ke||String(Se.parent_id)===String(ae))return;const ot=Se.location_type_id,St=Ke.location_type_id;if(!FN(ot,St,y)){N(`Cannot assign parent: The location type "${Se.locationType?.name||"Unknown"}" cannot be a child of "${Ke.locationType?.name||"Unknown"}"`),ie();return}if((()=>{const Ge=(vt,ct,Nt=new Set)=>{if(Nt.has(String(vt)))return!1;if(Nt.add(String(vt)),String(vt)===String(ct))return!0;const Ye=p.filter(Je=>Je&&Je.parent_id&&String(Je.parent_id)===String(vt));for(const Je of Ye)if(String(Je.id)===String(ct)||Ge(Je.id,ct,Nt))return!0;return!1};return Ge(bt,ae)})()){N("Cannot assign parent: This would create a circular reference (cannot make a location a child of its own descendant)"),ie();return}let nt=null;Ce.current&&(nt=Ce.current.getViewport(),Re.current=!0,window.__locationBuilderViewport=nt);try{v(!0),N(null),await Vl(bt,{parent_id:ae}),await ie(),Ce.current&&nt&&setTimeout(()=>{Ce.current&&Ce.current.setViewport(nt,{duration:0})},50)}catch(Ge){console.error("Failed to update location parent:",Ge),N(Ge.message||"Failed to update location parent"),await ie(),Ce.current&&nt&&setTimeout(()=>{Ce.current&&Ce.current.setViewport(nt,{duration:0})},50)}finally{v(!1)}},[j,p,y,dt,ie]),Rt=u.useCallback(We=>{const it=L;C(!1),z(null),U(null),it&&(se.current=String(it)),ie()},[ie,L]),Ft=()=>{z(null),U(null),C(!0)},Zt=u.useCallback(async We=>{if(!(!D||!We))try{v(!0),await Vl(D,{parent_id:We}),B(!1),O(null),ie()}catch(it){console.error("Failed to connect location to parent:",it),N(it.message||"Failed to connect location to parent")}finally{v(!1)}},[D,ie]);if(!e)return t.jsx("section",{className:"entities-page",children:t.jsx("div",{className:"entities-header",children:t.jsx("div",{className:"entities-header-top",children:t.jsxs("div",{className:"entities-header-left",children:[t.jsx("h1",{children:"Location Builder"}),t.jsx("p",{className:"entities-subtitle",children:"Select a campaign or world you own to choose a world context."})]})})})});const Tt=l?`${l.name}${i?.name?`  ${i.name}`:""}`:i?.name?`World  ${i.name}`:"";return t.jsxs("section",{className:"entities-page",children:[t.jsx("div",{className:"entities-header",children:t.jsxs("div",{className:"entities-header-top",children:[t.jsxs("div",{className:"entities-header-left",children:[t.jsx("h1",{children:"Location Builder"}),Tt&&t.jsx("p",{className:"entities-subtitle",children:Tt})]}),t.jsxs("div",{className:"entities-header-right",children:[Q&&t.jsx("button",{className:"btn btn-secondary",onClick:jt,disabled:b,children:"Show All"}),dt&&t.jsxs("button",{className:"btn submit",onClick:Ft,disabled:b,children:[t.jsx(Wn,{size:18})," Add Location"]})]})]})}),t.jsx("div",{style:{display:"flex",gap:"1rem",marginBottom:"1rem",alignItems:"center",flexWrap:"wrap"},children:t.jsxs("div",{style:{position:"relative",width:"280px",maxWidth:"280px"},children:[t.jsx(Hl,{size:16,style:{position:"absolute",left:"10px",top:"50%",transform:"translateY(-50%)",color:"#64748b",pointerEvents:"none"}}),t.jsx("input",{type:"text",placeholder:"Search locations...",value:_,onChange:We=>{T(We.target.value),ht(We.target.value.trim().length>0)},onFocus:()=>{_.trim().length>0&&ht(!0)},onBlur:()=>{setTimeout(()=>ht(!1),200)},style:{width:"100%",padding:"0.4rem 0.6rem 0.4rem 2.25rem",border:"1px solid #e2e8f0",borderRadius:"6px",fontSize:"0.875rem"}}),_&&t.jsx("button",{type:"button",onClick:()=>{T(""),ht(!1)},style:{position:"absolute",right:"6px",top:"50%",transform:"translateY(-50%)",background:"none",border:"none",cursor:"pointer",padding:"4px",display:"flex",alignItems:"center",color:"#64748b"},"aria-label":"Clear search",children:t.jsx(Bn,{size:14})}),mt&&ce.length>0&&t.jsx("div",{style:{position:"absolute",top:"100%",left:0,right:0,marginTop:"4px",backgroundColor:"#ffffff",border:"1px solid #e2e8f0",borderRadius:"6px",boxShadow:"0 4px 12px rgba(15, 23, 42, 0.15)",maxHeight:"300px",overflowY:"auto",zIndex:1e3},children:ce.map(We=>t.jsxs("button",{type:"button",onClick:()=>qe(We.id),style:{width:"100%",padding:"0.75rem 1rem",textAlign:"left",background:"none",border:"none",borderBottom:"1px solid #f1f5f9",cursor:"pointer",fontSize:"0.875rem",color:"#1e293b",transition:"background-color 0.15s ease"},onMouseEnter:it=>{it.currentTarget.style.backgroundColor="#f8fafc"},onMouseLeave:it=>{it.currentTarget.style.backgroundColor="transparent"},children:[t.jsx("div",{style:{fontWeight:600,marginBottom:"0.25rem"},children:We.name}),We.locationType?.name&&t.jsx("div",{style:{fontSize:"0.75rem",color:"#64748b"},children:We.locationType.name})]},We.id))})]})}),S&&t.jsx("div",{className:"alert error",role:"alert",style:{marginBottom:"1rem"},children:S}),t.jsx("div",{style:{width:"100%",height:"calc(100vh - 300px)",minHeight:"500px"},children:b?t.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%"},children:t.jsx("p",{children:"Loading locations..."})}):j.length===0?t.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",flexDirection:"column",gap:"1rem"},children:[t.jsx("p",{children:"No locations found."}),dt&&t.jsxs("button",{className:"btn submit",onClick:Ft,children:[t.jsx(Wn,{size:18})," Create First Location"]})]}):t.jsxs(cb,{nodes:j,edges:A,onNodesChange:Be,onEdgesChange:Te,onNodeDragStart:Mt,onNodeDrag:tt,onNodeDragStop:ft,onNodeDoubleClick:gt,onInit:We=>{Ce.current=We},nodeTypes:t9,nodesDraggable:!0,nodesConnectable:!1,elementsSelectable:!0,panOnDrag:!0,zoomOnScroll:!0,zoomOnPinch:!0,fitView:!1,fitViewOptions:{padding:.2},defaultEdgeOptions:{style:{stroke:"#64748b",strokeWidth:2},type:"smoothstep"},children:[t.jsx(b_,{}),t.jsx(y_,{}),t.jsx(h_,{style:{position:"absolute",top:10,right:10,bottom:"auto",left:"auto"}}),t.jsx("style",{children:`
              .react-flow__minimap {
                position: absolute !important;
                top: 10px !important;
                right: 10px !important;
                bottom: auto !important;
                left: auto !important;
              }
            `})]})}),k&&t.jsx("div",{className:"side-panel-overlay",role:"dialog","aria-modal":"true",children:t.jsx("div",{className:"side-panel",children:t.jsx(HB,{parentId:L,locationTypes:G||y,onClose:()=>{C(!1),z(null),U(null)},onSuccess:Rt})})}),R&&t.jsx("div",{className:"side-panel-overlay",role:"dialog","aria-modal":"true",children:t.jsxs("div",{className:"side-panel",children:[t.jsxs("div",{className:"side-panel-header",children:[t.jsx("h2",{children:"Set Parent Location"}),t.jsx("button",{type:"button",className:"icon-btn",onClick:()=>{B(!1),O(null)},title:"Close",children:t.jsx(Bn,{size:18})})]}),t.jsxs("div",{className:"side-panel-content",children:[t.jsx("p",{style:{marginBottom:"1rem"},children:"Select a parent location for this orphan location:"}),t.jsxs("div",{style:{maxHeight:"400px",overflowY:"auto",display:"flex",flexDirection:"column",gap:"0.5rem"},children:[fe.filter(We=>{const it=String(We.id),bt=String(D);return it!==bt}).map(We=>t.jsxs("button",{type:"button",className:"btn btn-secondary",style:{textAlign:"left",justifyContent:"flex-start"},onClick:()=>Zt(We.id),disabled:b,children:[We.name,We.locationType?.name&&t.jsxs("span",{style:{marginLeft:"0.5rem",opacity:.7},children:["(",We.locationType.name,")"]})]},We.id)),t.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>Zt(null),disabled:b,style:{marginTop:"1rem"},children:"Remove Parent (Make Root)"})]})]})]})}),$&&t.jsx(Dg,{locationId:$,location:H,isLoading:Y,error:W,fallbackName:H?.name||p.find(We=>String(We.id)===String($))?.name||"Location",locationFields:K,onClose:()=>F(null)})]})}function l9({initialData:e={},onSubmit:n,onCancel:s,submitting:i=!1,errorMessage:l,worlds:o=[],locationTypes:d=[]}){const[f,p]=u.useState({name:"",description:"",worldId:"",parent_type_id:"",sort_order:0,focus:!1}),[h,y]=u.useState("");u.useEffect(()=>{const E=e?.world_id||e?.worldId||e?.world?.id||"";p({name:e?.name||"",description:e?.description||"",worldId:E?String(E):"",parent_type_id:e?.parent_type_id||e?.parentType?.id||"",sort_order:e?.sort_order||0,focus:e?.focus||!1}),y("")},[e]);const g=u.useMemo(()=>f.name!==(e?.name||"")||f.description!==(e?.description||"")||f.worldId!==(e?.world_id||e?.worldId||e?.world?.id||"")||f.parent_type_id!==(e?.parent_type_id||e?.parentType?.id||"")||f.sort_order!==(e?.sort_order||0)||f.focus!==(e?.focus||!1),[e,f.description,f.name,f.worldId,f.parent_type_id,f.sort_order,f.focus]);u.useEffect(()=>{y(l||"")},[l]);const b=E=>A=>{const{value:M}=A.target;p(_=>({..._,[E]:M}))},v=E=>A=>{const{value:M}=A.target,_=M===""?0:parseInt(M,10);Number.isNaN(_)||p(T=>({...T,[E]:_}))},S=E=>A=>{const{checked:M}=A.target;p(_=>({..._,[E]:M}))},N=u.useMemo(()=>{if(!e?.id)return d;const E=new Set([e.id]);return d.filter(A=>!E.has(A.id))},[d,e?.id]),j=async E=>{E.preventDefault();const A=f.name.trim();if(!A){y("Name is required.");return}const M=f.worldId.trim();if(!M){y("Select a world for this location type.");return}y("");const _={name:A,description:f.description?.trim()||"",world_id:M,parent_type_id:f.parent_type_id||null,sort_order:f.sort_order||0,focus:f.focus||!1};try{if(await n?.(_)===!1)return}catch(T){y(T.message||"Failed to save location type")}};return t.jsxs("form",{className:"entity-type-form",onSubmit:j,children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"location-type-name",children:"Name *"}),t.jsx("input",{id:"location-type-name",type:"text",value:f.name,onChange:b("name"),placeholder:"e.g. City, Region, Building",disabled:i,autoFocus:!0})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"location-type-world",children:"World *"}),t.jsxs("select",{id:"location-type-world",value:f.worldId,onChange:b("worldId"),disabled:i,required:!0,children:[t.jsx("option",{value:"",children:"Select world..."}),o.map(E=>t.jsx("option",{value:E.id,children:E.name},E.id))]})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"location-type-parent",children:"Parent Type"}),t.jsxs("select",{id:"location-type-parent",value:f.parent_type_id,onChange:b("parent_type_id"),disabled:i,children:[t.jsx("option",{value:"",children:"None (top-level)"}),N.map(E=>t.jsx("option",{value:E.id,children:E.name},E.id))]})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"location-type-sort-order",children:"Sort Order"}),t.jsx("input",{id:"location-type-sort-order",type:"number",value:f.sort_order,onChange:v("sort_order"),placeholder:"0",disabled:i,min:"0"})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"location-type-description",children:"Description"}),t.jsx("textarea",{id:"location-type-description",value:f.description,onChange:b("description"),placeholder:"Optional description for this location type",rows:5,disabled:i,className:"textarea-field"})]}),t.jsxs("div",{className:"form-group",children:[t.jsxs("label",{className:"checkbox-label",children:[t.jsx("input",{type:"checkbox",checked:f.focus,onChange:S("focus"),disabled:i}),t.jsx("span",{children:"Focus (show in sidebar navigation)"})]}),t.jsx("p",{className:"help-text",children:"When enabled, this location type will appear as a menu item in the Locations section of the sidebar with a count of locations."})]}),h&&t.jsx("div",{className:"form-error",role:"alert",children:h}),t.jsxs("div",{className:"form-actions",children:[t.jsx("button",{type:"button",className:"btn cancel",onClick:s,disabled:i,children:"Cancel"}),t.jsx("button",{type:"submit",className:"btn submit",disabled:i||!g,children:i?"Saving...":"Save"})]})]})}const o9=new Set(["system_admin"]);function c9(){const e=_n(),{user:n,token:s,sessionReady:i}=un(),{selectedCampaign:l,activeWorld:o,activeWorldId:d,contextKey:f}=wn(),[p,h]=u.useState([]),[y,g]=u.useState(!1),[b,v]=u.useState(""),[S,N]=u.useState(!1),[j,E]=u.useState(null),[A,M]=u.useState(!1),[_,T]=u.useState(""),[k,C]=u.useState(""),[L,z]=u.useState(null),[G,U]=u.useState("name"),[X,V]=u.useState("asc"),R=d||l?.world?.id||"",B=u.useRef(`${R}:${f}`),D=!!R,O=u.useMemo(()=>R?[{id:R,name:o?.name||l?.world?.name||"Untitled world"}]:[],[R,o?.name,l?.world?.name]),$=u.useMemo(()=>{const se=l?.world||o;return se&&(se.created_by||se.creator?.id||se.owner_id||se.owner?.id)||""},[l,o]),F=!!(n?.id&&$===n.id),H=u.useMemo(()=>n?n.role&&o9.has(n.role)?!0:F:!1,[n,F]),I=u.useMemo(()=>{if(l){const se=l.name||"Selected campaign",Le=l.world?.name||o?.name;return Le?`${se}  ${Le}`:se}return o?o.name||"Selected world":""},[l,o]),Y=u.useCallback((se,Le="info")=>{z({message:se,tone:Le})},[]);u.useEffect(()=>{if(!L)return;const se=setTimeout(()=>z(null),3500);return()=>clearTimeout(se)},[L]);const P=u.useCallback(async()=>{if(!s||!R)return g(!1),h([]),[];g(!0),v("");try{const se=await Nr({worldId:R}),Le=Array.isArray(se)?se:Array.isArray(se?.data)?se.data:[];return h(Le),Le}catch(se){return console.error(" Failed to load location types",se),v(se.message||"Failed to load location types"),h([]),[]}finally{g(!1)}},[s,R]);u.useEffect(()=>{if(!(!i||!s)){if(!R){h([]),v(""),g(!1);return}P()}},[i,s,R,P,f]),u.useEffect(()=>{const se=`${R}:${f}`;B.current!==se&&(N(!1),E(null),C(""),z(null),h([]),v(""),M(!1),T(""),B.current=se)},[R,f]);const W=()=>{!H||!D||(E(null),C(""),N(!0))},le=se=>{H&&(E(se),C(""),N(!0))},K=se=>{se?.id&&e(`/location-types/${se.id}/fields`)},de=()=>{N(!1),E(null),C("")},Q=async se=>{if(j?.id)try{M(!0),C(""),await DI(j.id,se),Y("Location type updated","success"),de(),await P()}catch(Le){console.error(" Failed to save location type",Le);const be=Le.message||"Failed to save location type";return C(be),Y(be,"error"),!1}finally{M(!1)}else try{M(!0),C(""),await LI(se),Y("Location type created","success"),de(),await P()}catch(Le){console.error(" Failed to create location type",Le);const be=Le.message||"Failed to create location type";return C(be),Y(be,"error"),!1}finally{M(!1)}return!0},he=async se=>{if(!(!H||!se?.id||!window.confirm(`Delete location type "${se.name}"? This action cannot be undone.`)))try{T(se.id),await OI(se.id),Y("Location type deleted","success"),j?.id===se.id&&de(),await P()}catch(be){console.error(" Failed to delete location type",be),Y(be.message||"Failed to delete location type","error")}finally{T("")}},re=se=>{if(!se)return"";const Le=new Date(se);return Number.isNaN(Le.getTime())?"":Le.toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})},Ce=se=>{G===se?V(X==="asc"?"desc":"asc"):(U(se),V("asc"))},Re=u.useMemo(()=>G?[...p].sort((se,Le)=>{let be,De;switch(G){case"name":be=(se.name||"").toLowerCase(),De=(Le.name||"").toLowerCase();break;case"description":be=(se.description||"").toLowerCase(),De=(Le.description||"").toLowerCase();break;case"parentType":be=(se.parentType?.name||"").toLowerCase(),De=(Le.parentType?.name||"").toLowerCase();break;case"childTypeCount":be=se.childTypeCount||0,De=Le.childTypeCount||0;break;case"world":be=(se?.world?.name||se?.world_name||se?.worldName||"").toLowerCase(),De=(Le?.world?.name||Le?.world_name||Le?.worldName||"").toLowerCase();break;case"created":be=new Date(se.createdAt||se.created_at||0).getTime(),De=new Date(Le.createdAt||Le.created_at||0).getTime();break;default:return 0}return be<De?X==="asc"?-1:1:be>De?X==="asc"?1:-1:0}):p,[p,G,X]),ue=p.length;return i?s?t.jsxs("section",{className:"entity-types-page",children:[t.jsxs("div",{className:"entity-types-header",children:[t.jsxs("div",{children:[t.jsx("h1",{children:"Location Types"}),l?t.jsxs(t.Fragment,{children:[t.jsx("p",{className:"entity-types-subtitle",children:I}),t.jsxs("p",{className:"entity-types-subtitle",children:[ue," types defined"]})]}):t.jsx("p",{className:"entity-types-subtitle",children:"Select a campaign or world you own to choose a world context."})]}),t.jsxs("button",{type:"button",className:"btn submit",onClick:W,disabled:!H||A||_||!D,children:[t.jsx(Wn,{size:18})," Add Location Type"]})]}),!H&&t.jsx("div",{className:"alert info",role:"status",children:"You can view the existing location types, but only system administrators or the world owner can make changes."}),L&&t.jsx("div",{className:`toast-banner ${L.tone}`,role:"status",children:L.message}),b&&t.jsx("div",{className:"alert error",role:"alert",children:b}),t.jsx("div",{className:"entity-types-table-wrapper",children:D?y?t.jsx("div",{className:"empty-state",children:"Loading location types..."}):p.length===0?t.jsx("div",{className:"empty-state",children:"No location types defined yet."}):t.jsxs("table",{className:"entity-types-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{className:"sortable-header",onClick:()=>Ce("name"),role:"button",tabIndex:0,onKeyDown:se=>{(se.key==="Enter"||se.key===" ")&&(se.preventDefault(),Ce("name"))},children:t.jsxs("span",{className:"header-label",children:["Name",G==="name"&&t.jsx("span",{className:"sort-indicator",children:X==="asc"?"":""})]})}),t.jsx("th",{className:"sortable-header",onClick:()=>Ce("description"),role:"button",tabIndex:0,onKeyDown:se=>{(se.key==="Enter"||se.key===" ")&&(se.preventDefault(),Ce("description"))},children:t.jsxs("span",{className:"header-label",children:["Description",G==="description"&&t.jsx("span",{className:"sort-indicator",children:X==="asc"?"":""})]})}),t.jsx("th",{className:"sortable-header",onClick:()=>Ce("parentType"),role:"button",tabIndex:0,onKeyDown:se=>{(se.key==="Enter"||se.key===" ")&&(se.preventDefault(),Ce("parentType"))},children:t.jsxs("span",{className:"header-label",children:["Parent Type",G==="parentType"&&t.jsx("span",{className:"sort-indicator",children:X==="asc"?"":""})]})}),t.jsx("th",{className:"sortable-header",onClick:()=>Ce("childTypeCount"),role:"button",tabIndex:0,onKeyDown:se=>{(se.key==="Enter"||se.key===" ")&&(se.preventDefault(),Ce("childTypeCount"))},children:t.jsxs("span",{className:"header-label",children:["Child Types",G==="childTypeCount"&&t.jsx("span",{className:"sort-indicator",children:X==="asc"?"":""})]})}),t.jsx("th",{className:"sortable-header",onClick:()=>Ce("world"),role:"button",tabIndex:0,onKeyDown:se=>{(se.key==="Enter"||se.key===" ")&&(se.preventDefault(),Ce("world"))},children:t.jsxs("span",{className:"header-label",children:["World",G==="world"&&t.jsx("span",{className:"sort-indicator",children:X==="asc"?"":""})]})}),t.jsx("th",{className:"sortable-header",onClick:()=>Ce("created"),role:"button",tabIndex:0,onKeyDown:se=>{(se.key==="Enter"||se.key===" ")&&(se.preventDefault(),Ce("created"))},children:t.jsxs("span",{className:"header-label",children:["Created",G==="created"&&t.jsx("span",{className:"sort-indicator",children:X==="asc"?"":""})]})}),t.jsx("th",{className:"actions-column",children:"Actions"})]})}),t.jsx("tbody",{children:Re.map(se=>{const Le=se.createdAt||se.created_at,be=se?.world?.name||se?.world_name||se?.worldName||"";return t.jsxs("tr",{children:[t.jsx("td",{children:se.name}),t.jsx("td",{className:"description-cell",children:se.description?se.description:""}),t.jsx("td",{children:se.parentType?.name||""}),t.jsx("td",{children:se.childTypeCount||0}),t.jsx("td",{children:be}),t.jsx("td",{children:re(Le)}),t.jsx("td",{className:"actions-column",children:t.jsxs("div",{className:"entity-type-actions",children:[t.jsx("button",{type:"button",className:"icon-btn",title:"Manage fields",onClick:()=>K(se),children:t.jsx(Qd,{size:16})}),H&&t.jsxs(t.Fragment,{children:[t.jsx("button",{type:"button",className:"icon-btn",title:"Edit location type",onClick:()=>le(se),disabled:A||_===se.id,children:t.jsx(Ga,{size:16})}),t.jsx("button",{type:"button",className:"icon-btn danger",title:"Delete location type",onClick:()=>he(se),disabled:_===se.id||A,children:t.jsx(zn,{size:16})})]})]})})]},se.id)})})]}):t.jsx("div",{className:"empty-state",children:"Select a campaign or world you own to view location types."})}),t.jsx("div",{className:"entity-type-cards",children:D?y?t.jsx("div",{className:"card-placeholder",children:"Loading location types..."}):p.length===0?t.jsx("div",{className:"card-placeholder",children:"No location types defined yet."}):Re.map(se=>{const Le=se.createdAt||se.created_at;return t.jsxs("div",{className:"entity-type-card",children:[t.jsxs("div",{className:"card-header",children:[t.jsx("h3",{children:se.name}),t.jsxs("div",{className:"entity-type-actions",children:[t.jsx("button",{type:"button",className:"icon-btn",title:"Manage fields",onClick:()=>K(se),children:t.jsx(Qd,{size:16})}),H&&t.jsxs(t.Fragment,{children:[t.jsx("button",{type:"button",className:"icon-btn",title:"Edit location type",onClick:()=>le(se),disabled:A||_===se.id,children:t.jsx(Ga,{size:16})}),t.jsx("button",{type:"button",className:"icon-btn danger",title:"Delete location type",onClick:()=>he(se),disabled:_===se.id||A,children:t.jsx(zn,{size:16})})]})]})]}),t.jsx("p",{className:"card-description",children:se.description?se.description:"No description"}),t.jsxs("p",{className:"card-meta",children:["Parent: ",se.parentType?.name||"None"]}),t.jsxs("p",{className:"card-meta",children:["Child Types: ",se.childTypeCount||0]}),t.jsxs("p",{className:"card-meta",children:["World: ",se?.world?.name||se?.world_name||""]}),t.jsxs("p",{className:"card-meta",children:["Created ",re(Le)]})]},`card-${se.id}`)}):t.jsx("div",{className:"card-placeholder",children:"Select a campaign or world you own to view location types."})}),S&&t.jsx("div",{className:"side-panel-overlay",role:"dialog","aria-modal":"true",children:t.jsxs("div",{className:"side-panel",children:[t.jsxs("div",{className:"side-panel-header",children:[t.jsx("h2",{children:j?"Edit Location Type":"Add Location Type"}),t.jsx("button",{type:"button",className:"icon-btn",onClick:de,title:"Close form",disabled:A,children:t.jsx(Bn,{size:18})})]}),t.jsx("div",{className:"side-panel-content",children:t.jsx(l9,{initialData:j,onSubmit:Q,onCancel:de,submitting:A,errorMessage:k,worlds:O,locationTypes:p})})]})})]}):t.jsx("p",{children:"Authenticating..."}):t.jsx("p",{children:"Restoring session..."})}const u9=[{value:"text",label:"Text"},{value:"number",label:"Number"},{value:"boolean",label:"Boolean"},{value:"date",label:"Date"},{value:"enum",label:"Enum"},{value:"entity_reference",label:"Entity Reference"},{value:"location_reference",label:"Location Reference"}];function d9({initialData:e={},entityReferenceTypes:n=[],locationReferenceTypes:s=[],onSubmit:i,onCancel:l,submitting:o=!1,errorMessage:d}){const[f,p]=u.useState({name:"",label:"",data_type:"text",required:!1,visibleByDefault:!0,enumChoices:"",reference_type_id:"",reference_filter:""}),[h,y]=u.useState("");u.useEffect(()=>{if(!e){p({name:"",label:"",data_type:"text",required:!1,visibleByDefault:!0,enumChoices:"",reference_type_id:"",reference_filter:""}),y("");return}const M=Array.isArray(e.options?.choices)?e.options.choices.join(", "):typeof e.options=="string"?e.options:"",_=e.reference_filter?typeof e.reference_filter=="string"?e.reference_filter:JSON.stringify(e.reference_filter,null,2):"";let T=e.data_type||"text";T==="reference"&&(T="location_reference"),p({name:e.name||"",label:e.label||"",data_type:T,required:!!e.required,visibleByDefault:e.visibleByDefault!==void 0?!!e.visibleByDefault:e.visible_by_default!==void 0?!!e.visible_by_default:!0,enumChoices:M,reference_type_id:e.reference_type_id||"",reference_filter:_}),y("")},[e]),u.useEffect(()=>{y(d||"")},[d]);const g=f.data_type==="enum",b=f.data_type==="entity_reference",v=f.data_type==="location_reference",S=b||v,N=u.useMemo(()=>n.map(M=>({value:M.id,label:M.name})),[n]),j=u.useMemo(()=>s.map(M=>({value:M.id,label:M.name})),[s]),E=M=>_=>{const{value:T,type:k,checked:C}=_.target;p(L=>({...L,[M]:k==="checkbox"?C:T}))},A=async M=>{M.preventDefault();const _=f.name.trim(),T=f.label.trim();if(!_){y("Field name is required.");return}if(!T){y("Field label is required.");return}if(!f.data_type){y("Data type is required.");return}let k={};if(S){if(!f.reference_type_id){y("Reference type is required for reference fields.");return}const L=f.reference_filter.trim();if(L)try{if(k=JSON.parse(L),typeof k!="object"||Array.isArray(k))throw new Error("Reference filter must be a JSON object.")}catch(z){y(z.message||"Reference filter must be valid JSON.");return}}const C={name:_,label:T,data_type:f.data_type,required:!!f.required,visible_by_default:!!f.visibleByDefault};if(g){const L=f.enumChoices.split(",").map(z=>z.trim()).filter(Boolean);if(!L.length){y("Enum options are required for enum fields.");return}C.options={choices:L}}else C.options={};S?(C.reference_type_id=f.reference_type_id,C.reference_filter=k):(C.reference_type_id=null,C.reference_filter={});try{if(await i?.(C)===!1)return;y("")}catch(L){y(L.message||"Failed to save field")}};return t.jsxs("form",{className:"entity-type-field-form",onSubmit:A,children:[t.jsxs("div",{className:"form-grid",children:[t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"location-field-name",children:"Field Name *"}),t.jsx("input",{id:"location-field-name",type:"text",value:f.name,onChange:E("name"),placeholder:"e.g. population",disabled:o})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"location-field-label",children:"Label *"}),t.jsx("input",{id:"location-field-label",type:"text",value:f.label,onChange:E("label"),placeholder:"e.g. Population",disabled:o})]}),t.jsxs("div",{className:"form-group",children:[t.jsx("label",{htmlFor:"location-field-data-type",children:"Data Type *"}),t.jsx("select",{id:"location-field-data-type",value:f.data_type,onChange:E("data_type"),disabled:o,children:u9.map(M=>t.jsx("option",{value:M.value,children:M.label},M.value))}),t.jsx("p",{className:"field-hint",children:"Determines how the value is stored and rendered in location forms."})]}),t.jsxs("div",{className:"form-group checkbox-group",children:[t.jsxs("div",{className:"checkbox-control",children:[t.jsx("input",{id:"location-field-required",type:"checkbox",checked:f.required,onChange:E("required"),disabled:o}),t.jsx("label",{htmlFor:"location-field-required",children:"Required"})]}),t.jsx("span",{className:"field-hint",children:"Mark as required on location forms."})]}),t.jsxs("div",{className:"form-group checkbox-group",children:[t.jsxs("div",{className:"checkbox-control",children:[t.jsx("input",{id:"location-field-visible-default",type:"checkbox",checked:f.visibleByDefault,onChange:E("visibleByDefault"),disabled:o}),t.jsx("label",{htmlFor:"location-field-visible-default",children:"Visible by default"})]}),t.jsx("span",{className:"field-hint",children:"Uncheck to hide this field unless a rule explicitly shows it."})]}),g&&t.jsxs("div",{className:"form-group form-group-full",children:[t.jsx("label",{htmlFor:"location-field-options",children:"Enum Options *"}),t.jsx("textarea",{id:"location-field-options",value:f.enumChoices,onChange:E("enumChoices"),placeholder:"Comma separated values, e.g. Small, Medium, Large",rows:3,disabled:o}),t.jsx("p",{className:"field-hint",children:"Comma-separated list of allowed values."})]}),S&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"form-group form-group-full",children:[t.jsxs("label",{htmlFor:"location-field-reference-type",children:[b?"Entity":"Location"," Reference Type *"]}),t.jsxs("select",{id:"location-field-reference-type",value:f.reference_type_id,onChange:E("reference_type_id"),disabled:o,children:[t.jsxs("option",{value:"",children:["Select ",b?"entity":"location"," type"]}),(b?N:j).map(M=>t.jsx("option",{value:M.value,children:M.label},M.value))]}),t.jsxs("p",{className:"field-hint",children:["Choose which ",b?"entity":"location"," type this field should reference."]})]}),t.jsxs("div",{className:"form-group form-group-full",children:[t.jsx("label",{htmlFor:"location-field-reference-filter",children:"Reference Filter"}),t.jsx("textarea",{id:"location-field-reference-filter",value:f.reference_filter,onChange:E("reference_filter"),placeholder:'Optional JSON filter, e.g. {"metadata.size": "Large"}',rows:4,disabled:o}),t.jsxs("p",{className:"field-hint",children:["Limit selectable ",b?"entities":"locations"," by filter criteria."]})]})]})]}),h&&t.jsx("div",{className:"form-error",role:"alert",children:h}),t.jsxs("div",{className:"form-actions",children:[t.jsx("button",{type:"button",className:"btn cancel",onClick:l,disabled:o,children:"Cancel"}),t.jsx("button",{type:"submit",className:"btn submit",disabled:o,children:o?"Saving...":"Save Field"})]})]})}const f9=new Set(["system_admin"]),m9={text:"Text",number:"Number",boolean:"Boolean",date:"Date",enum:"Enum",entity_reference:"Entity Reference",location_reference:"Location Reference"};function h9(){const{id:e}=Ka(),n=_n(),{user:s,token:i,sessionReady:l}=un(),[o,d]=u.useState(null),[f,p]=u.useState([]),[h,y]=u.useState([]),[g,b]=u.useState([]),[v,S]=u.useState(!1),[N,j]=u.useState(!1),[E,A]=u.useState(""),[M,_]=u.useState(""),[T,k]=u.useState(!1),[C,L]=u.useState(null),[z,G]=u.useState(!1),[U,X]=u.useState(""),[V,R]=u.useState(""),[B,D]=u.useState(null),O=o?.name||"Location Type",$=u.useMemo(()=>{if(!o||!s)return!1;if(f9.has(s.role))return!0;const re=o.world_owner_id||o.world?.created_by||"";return re&&String(re)===String(s.id)},[o,s]),F=u.useCallback((re,Ce="info")=>{D({message:re,tone:Ce})},[]);u.useEffect(()=>{if(!B)return;const re=setTimeout(()=>D(null),3500);return()=>clearTimeout(re)},[B]);const H=re=>re?Array.isArray(re)?re:re?.data?re.data:re:null,I=u.useCallback(async()=>{if(e){S(!0),A("");try{const re=await II(e),Ce=H(re);d(Ce)}catch(re){console.error(" Failed to load location type details",re),A(re.message||"Failed to load location type")}finally{S(!1)}}},[e]),Y=u.useCallback(async re=>{const Ce=typeof re=="string"?re.trim():re||"";if(!Ce){p([]),y([]);return}try{const[Re,ue]=await Promise.all([wr({worldId:Ce}).catch(be=>(console.error(" Failed to load entity types",be),null)),Nr({worldId:Ce}).catch(be=>(console.error(" Failed to load location types",be),null))]),se=Re?H(Re):[],Le=ue?H(ue):[];p(Array.isArray(se)?se:[]),y(Array.isArray(Le)?Le:[])}catch(Re){console.error(" Failed to load reference types",Re),p([]),y([])}},[]),P=u.useCallback(async()=>{if(e){j(!0),_("");try{const re=await $f(e),Ce=H(re);b(Array.isArray(Ce)?Ce:[])}catch(re){console.error(" Failed to load fields",re),_(re.message||"Failed to load fields"),b([])}finally{j(!1)}}},[e]);u.useEffect(()=>{!l||!i||(I(),P())},[l,i,I,P]),u.useEffect(()=>{if(!o){p([]),y([]);return}const re=o?.world_id||o?.worldId||o?.world?.id||"";Y(re)},[o,o?.world_id,o?.worldId,o?.world?.id,Y]);const W=()=>{$&&(L(null),R(""),k(!0))},le=re=>{$&&(L(re),R(""),k(!0))},K=()=>{k(!1),L(null),R("")},de=async re=>{if(!$)return!1;try{G(!0),R(""),C?.id?(await AL(C.id,re),F("Field updated","success")):(await CL(e,re),F("Field created","success")),K(),await P()}catch(Ce){console.error(" Failed to save field",Ce);const Re=Ce.message||"Failed to save field";return R(Re),F(Re,"error"),!1}finally{G(!1)}return!0},Q=async re=>{if(!(!$||!re?.id||!window.confirm(`Delete field "${re.label||re.name}"? This action cannot be undone.`)))try{X(re.id),await TL(re.id),F("Field deleted","success"),await P()}catch(Re){console.error(" Failed to delete field",Re),F(Re.message||"Failed to delete field","error")}finally{X("")}},he=re=>{if(!re)return"";const{options:Ce}=re;return Ce&&Array.isArray(Ce.choices)&&Ce.choices.length>0?Ce.choices.join(", "):""};return l?i?v?t.jsx("p",{children:"Loading location type..."}):E||!o?t.jsxs("div",{className:"page-container",children:[t.jsx("div",{className:"alert error",children:E||"Location type not found"}),t.jsxs("button",{className:"btn btn-secondary",onClick:()=>n("/location-types"),children:[t.jsx(Tc,{size:16})," Back to Location Types"]})]}):t.jsxs("section",{className:"entity-types-page",children:[t.jsxs("div",{className:"entity-types-header",children:[t.jsxs("div",{children:[t.jsxs("button",{type:"button",className:"btn btn-secondary",onClick:()=>n("/location-types"),style:{marginBottom:"1rem"},children:[t.jsx(Tc,{size:16})," Back to Location Types"]}),t.jsxs("h1",{children:["Fields: ",O]}),t.jsx("p",{className:"entity-types-subtitle",children:"Define custom metadata fields for locations of this type"})]}),t.jsxs("button",{type:"button",className:"btn submit",onClick:W,disabled:!$||z||U,children:[t.jsx(Wn,{size:18})," Add Field"]})]}),!$&&t.jsx("div",{className:"alert info",role:"status",children:"You can view the existing fields, but only system administrators or the world owner can make changes."}),B&&t.jsx("div",{className:`toast-banner ${B.tone}`,role:"status",children:B.message}),M&&t.jsx("div",{className:"alert error",role:"alert",children:M}),t.jsx("div",{className:"entity-types-table-wrapper",children:N?t.jsx("div",{className:"empty-state",children:"Loading fields..."}):g.length===0?t.jsx("div",{className:"empty-state",children:"No fields defined yet. Add your first field to get started."}):t.jsxs("table",{className:"entity-types-table",children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:"Name"}),t.jsx("th",{children:"Label"}),t.jsx("th",{children:"Data Type"}),t.jsx("th",{children:"Required"}),t.jsx("th",{children:"Visible by Default"}),t.jsx("th",{children:"Options"}),t.jsx("th",{children:"Reference Type"}),t.jsx("th",{className:"actions-column",children:"Actions"})]})}),t.jsx("tbody",{children:g.map(re=>t.jsxs("tr",{children:[t.jsx("td",{children:re.name}),t.jsx("td",{children:re.label||re.name}),t.jsx("td",{children:m9[re.data_type]||re.data_type}),t.jsx("td",{children:re.required?"Yes":"No"}),t.jsx("td",{children:re.visible_by_default!==!1?"Yes":"No"}),t.jsx("td",{children:he(re)}),t.jsx("td",{children:re.referenceType?.name||""}),t.jsx("td",{className:"actions-column",children:t.jsx("div",{className:"entity-type-actions",children:$&&t.jsxs(t.Fragment,{children:[t.jsx("button",{type:"button",className:"icon-btn",title:"Edit field",onClick:()=>le(re),disabled:z||U===re.id,children:t.jsx(Ga,{size:16})}),t.jsx("button",{type:"button",className:"icon-btn danger",title:"Delete field",onClick:()=>Q(re),disabled:U===re.id||z,children:t.jsx(zn,{size:16})})]})})})]},re.id))})]})}),T&&t.jsx("div",{className:"side-panel-overlay",role:"dialog","aria-modal":"true",children:t.jsxs("div",{className:"side-panel",children:[t.jsxs("div",{className:"side-panel-header",children:[t.jsx("h2",{children:C?"Edit Field":"Add Field"}),t.jsx("button",{type:"button",className:"icon-btn",onClick:K,title:"Close form",disabled:z,children:t.jsx(Bn,{size:18})})]}),t.jsx("div",{className:"side-panel-content",children:t.jsx(d9,{initialData:C,onSubmit:de,onCancel:K,submitting:z,errorMessage:V,entityReferenceTypes:f,locationReferenceTypes:h})})]})})]}):t.jsx("p",{children:"Authenticating..."}):t.jsx("p",{children:"Restoring session..."})}const p9=QT(AT(t.jsxs(t.Fragment,{children:[t.jsx(Wt,{path:"/login",element:t.jsx(jD,{})}),t.jsxs(Wt,{path:"/",element:t.jsx($5,{children:t.jsx(zI,{})}),children:[t.jsx(Wt,{index:!0,element:t.jsx(UI,{})}),t.jsx(Wt,{path:"worlds",element:t.jsx($L,{})}),t.jsx(Wt,{path:"worlds/:id",element:t.jsx(HL,{})}),t.jsx(Wt,{path:"worlds/:worldId/access/bulk",element:t.jsx(MN,{})}),t.jsx(Wt,{path:"worlds/:worldId/access/audit",element:t.jsx(Gz,{})}),t.jsx(Wt,{path:"worlds/:worldId/collections",element:t.jsx(Wz,{})}),t.jsx(Wt,{path:"campaigns/:campaignId/access/bulk",element:t.jsx(MN,{})}),t.jsxs(Wt,{path:"campaigns",children:[t.jsx(Wt,{index:!0,element:t.jsx(gc,{to:"/campaigns/my",replace:!0})}),t.jsx(Wt,{path:"my",element:t.jsx(ud,{scope:"my"})}),t.jsx(Wt,{path:"my/:id",element:t.jsx(ud,{scope:"my"})}),t.jsx(Wt,{path:"all",element:t.jsx(ud,{scope:"all"})}),t.jsx(Wt,{path:"all/:id",element:t.jsx(ud,{scope:"all"})})]}),t.jsx(Wt,{path:"entities",element:t.jsx(QD,{})}),t.jsx(Wt,{path:"entities/bulk-upload",element:t.jsx(Nz,{})}),t.jsx(Wt,{path:"entities/followed",element:t.jsx(aB,{})}),t.jsx(Wt,{path:"entities/:entityId/relationship-viewer",element:t.jsx(xz,{})}),t.jsx(Wt,{path:"entities/:id",element:t.jsx(V3,{})}),t.jsxs(Wt,{path:"entity-types",children:[t.jsx(Wt,{index:!0,element:t.jsx(W3,{})}),t.jsx(Wt,{path:"new",element:t.jsx(f5,{})}),t.jsx(Wt,{path:":id/fields",element:t.jsx(o5,{})})]}),t.jsxs(Wt,{path:"relationship-types",children:[t.jsx(Wt,{index:!0,element:t.jsx(I5,{})}),t.jsx(Wt,{path:"new",element:t.jsx(L5,{})}),t.jsx(Wt,{path:":id/edit",element:t.jsx(D5,{})})]}),t.jsx(Wt,{path:"entity-relationships",element:t.jsx(T5,{})}),t.jsx(Wt,{path:"entity-secrets",element:t.jsx(O5,{})}),t.jsxs(Wt,{path:"locations",children:[t.jsx(Wt,{index:!0,element:t.jsx(vB,{})}),t.jsx(Wt,{path:"builder",element:t.jsx(i9,{})}),t.jsx(Wt,{path:":id",element:t.jsx(qB,{})})]}),t.jsxs(Wt,{path:"location-types",children:[t.jsx(Wt,{index:!0,element:t.jsx(c9,{})}),t.jsx(Wt,{path:":id/fields",element:t.jsx(h9,{})})]}),t.jsxs(Wt,{path:"notes",children:[t.jsx(Wt,{index:!0,element:t.jsx(gc,{to:"/notes/session",replace:!0})}),t.jsx(Wt,{path:"session",element:t.jsx(Cz,{})}),t.jsx(Wt,{path:"entities",element:t.jsx(Dz,{})})]}),t.jsxs(Wt,{path:"characters",children:[t.jsx(Wt,{index:!0,element:t.jsx(gc,{to:"/characters/my",replace:!0})}),t.jsx(Wt,{path:"my",element:t.jsx(Gr,{scope:"my"})}),t.jsx(Wt,{path:"my/:id",element:t.jsx(Gr,{scope:"my"})}),t.jsx(Wt,{path:"others",element:t.jsx(Gr,{scope:"others"})}),t.jsx(Wt,{path:"others/:id",element:t.jsx(Gr,{scope:"others"})}),t.jsx(Wt,{path:"companions",element:t.jsx(Gr,{scope:"companions"})}),t.jsx(Wt,{path:"companions/:id",element:t.jsx(Gr,{scope:"companions"})}),t.jsx(Wt,{path:"all",element:t.jsx(Gr,{scope:"all"})}),t.jsx(Wt,{path:"all/:id",element:t.jsx(Gr,{scope:"all"})})]}),t.jsx(Wt,{path:"users",element:t.jsx(ND,{})}),t.jsx(Wt,{path:"security",element:t.jsx(Qz,{})}),t.jsx(Wt,{path:"notifications",element:t.jsx(nB,{})}),t.jsxs(Wt,{path:"requests",children:[t.jsx(Wt,{index:!0,element:t.jsx(dB,{})}),t.jsx(Wt,{path:"new",element:t.jsx(gB,{})}),t.jsx(Wt,{path:":id",element:t.jsx(yB,{})})]})]}),t.jsx(Wt,{path:"*",element:t.jsx(gc,{to:"/",replace:!0})})]})));function y9(){return t.jsx(dM,{router:p9})}ZA.createRoot(document.getElementById("root")).render(t.jsx(u.StrictMode,{children:t.jsx(_R,{children:t.jsx(p5,{children:t.jsx(iR,{children:t.jsx(jR,{children:t.jsx(nI,{children:t.jsx(y9,{})})})})})})}));export{tL as a,ky as c,zj as s};
